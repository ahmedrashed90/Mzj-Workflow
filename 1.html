





<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<link rel="stylesheet" href="mzj-mobile.css">
  <link rel="icon" type="image/x-icon" href="assets/favicon.png">
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>لوحة الإدارة — MZJ Cars</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<style>
  :root{
    --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280;
    --line:#e5e7eb; --line-strong:#d1d5db; --table-head:#fafafa;
    --card:#fff; --radius:14px; --ok:#16a34a; --danger:#ef4444; --info:#0ea5e9;
    --shadow:0 10px 24px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,Arial}

  /* Topbar + tabs + auth badge */
  .topbar{position:sticky;top:0;z-index:1000;background:#fff;border-bottom:1px solid var(--line)}
  .topbar-inner{max-width:1240px;margin:auto;display:flex;align-items:center;justify-content:space-between;padding:10px 16px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brown),#2a1613);
    display:grid;place-items:center;color:#fff;font-weight:800}
  .brand h1{margin:0;font-size:18px;color:var(--brown)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;text-decoration:none;color:inherit;font-weight:800;font-size:13px}
  .tab.active{background:var(--brown);border-color:var(--brown);color:#fff}
  .status-badge{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#fff;border-radius:12px;padding:6px 10px;font-size:12px}
  .dot{width:10px;height:10px;border-radius:999px;background:#f59e0b}
  .dot.ok{background:var(--ok)} .dot.err{background:var(--danger)} .dot.warn{background:#f59e0b}

  /* Buttons */
  .btn{position:relative;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:700;display:inline-flex;gap:8px;align-items:center;transition:.15s;font-size:13px}
  .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
  .btn-primary{background:var(--brown);border-color:var(--brown);color:#fff}
  .btn-beige{background:var(--beige);border-color:var(--beige);color:#fff}
  .btn-ghost{background:#fff}
  .btn-danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .btn-outline{background:#fff;border:1px solid var(--brown);color:var(--brown)}

  /* Layout */
  .container{max-width:1240px;margin:18px auto;padding:0 16px 48px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
  .section-title{display:flex;align-items:center;gap:8px;margin:0}
  .section-title svg{width:20px;height:20px;color:var(--brown)}
  .hint{color:var(--muted);font-size:12px}

  /* Inputs */
  label{font-weight:800;margin-bottom:6px;display:block;color:var(--brown);font-size:13px}
  .input-wrap{position:relative}
  .input-wrap .i{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:#9ca3af}
  .input-wrap input{padding-right:36px}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;outline:none;transition:.15s;font-family:"Tajawal",system-ui,Arial;font-size:13px}
  input:focus,select:focus,textarea:focus{border-color:var(--beige);box-shadow:0 0 0 3px rgba(188,143,116,.15)}
  #vin{height:44px} #notes{height:44px;resize:none}
  textarea{min-height:44px;resize:vertical}

  /* Grid */
  .grid{display:grid;gap:12px}
  .grid-4{grid-template-columns:repeat(4,1fr)}
  .grid-3{grid-template-columns:repeat(3,1fr)}
  .grid-2{grid-template-columns:repeat(2,1fr)}
  @media (max-width:1080px){ .grid-4{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:860px){ .grid-4,.grid-3{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:620px){ .grid-4,.grid-3,.grid-2{grid-template-columns:1fr} }
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  /* Tables */
  .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:14px;background:#fff}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:var(--table-head);z-index:2;border-bottom:1px solid var(--line-strong);
    text-align:right;color:#111827;font-size:13.5px;padding:12px 10px}
  tbody td{border-top:1px solid var(--line);padding:10px;vertical-align:top;font-size:13px}
  tbody tr:nth-child(odd){background:#fff}
  tbody tr:nth-child(even){background:#fcfcfc}
  tbody tr:hover{background:#f8fafc}
  td,th{border-left:1px solid var(--line)}
  td:last-child,th:last-child{border-left:0}
  .cell-actions{display:flex;gap:6px;flex-wrap:wrap}
  .nowrap{white-space:nowrap}
  .w-120{min-width:120px}
  .w-160{min-width:160px}

  /* Import dropdown */
  .import-menu{position:relative;display:inline-block}
  .import-dropdown{position:absolute;top:110%;left:0;background:#fff;border:1px solid var(--line);border-radius:12px;
    box-shadow:0 14px 28px rgba(0,0,0,.12);min-width:260px;z-index:20;display:none;overflow:hidden}
  .import-dropdown button{display:flex;gap:8px;align-items:center;width:100%;text-align:right;background:#fff;border:0;padding:12px 14px;cursor:pointer;font-weight:700;font-size:13px}
  .import-dropdown button:hover{background:#f9fafb}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.38);display:none;align-items:center;justify-content:center;z-index:99999;padding:12px}
  .modal{background:#fff;border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.35);width:min(520px,92vw);padding:16px;border:1px solid var(--line)}
  .modal header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .modal h3{margin:0;font-size:18px;color:var(--brown)}
  .modal .actions{display:flex;gap:8px;justify-content:flex-start;margin-top:12px}

  /* Toast */
  .toast{position:fixed;bottom:16px;right:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.25);display:none;z-index:60;font-size:13px}
  .toast.ok{background:var(--ok)} .toast.info{background:var(--info)} .toast.err{background:var(--danger)}

  /* Auth */
  .auth-wrap{min-height:60vh;display:grid;place-items:center;padding:24px}
  .auth-card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:18px;max-width:420px;width:96%}
  .auth-card h2{margin:0 0 10px;color:var(--brown)}
  .auth-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

  /* Checklist box */
  .checklist{border:1px dashed var(--beige);border-radius:12px;padding:12px;background:#fff8ef}
  .checklist h4{margin:0 0 8px 0;color:var(--brown);font-size:14px}
  .check-row{display:grid;grid-template-columns:18px 1fr;gap:8px;align-items:start}
  .check-row label{margin:0;display:flex;align-items:center;gap:8px;font-weight:600;font-size:13px}

  /* حركة النقل: صفوف متعددة */
  .move-row{border:1px dashed #e5e7eb;border-radius:10px;padding:8px 10px;background:#fffbf7}
  .move-row-title{font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:600}

  /* إشعار حركة النقل */
  .move-alert{
    margin-top:10px;
    padding:10px 12px;
    border-radius:12px;
    display:none;
    align-items:flex-start;
    gap:10px;
    font-size:13px;
  }
  .move-alert .icon{
    margin-top:3px;
    font-size:16px;
  }
  .move-alert .title{
    font-weight:800;
    margin-bottom:4px;
    font-size:13.5px;
  }
  .move-alert ul{
    margin:0;
    padding-right:18px;
    list-style:disc;
  }
  .move-alert.success{
    background:#ecfdf3;
    border:1px solid #bbf7d0;
    color:#14532d;
  }
  .move-alert.error{
    background:#fef2f2;
    border:1px solid #fecaca;
    color:#991b1b;
  }
  .move-alert.info{
    background:#eff6ff;
    border:1px solid #bfdbfe;
    color:#1d4ed8;
  }

  .copyable{cursor:pointer;text-decoration:underline;text-decoration-style:dotted}

  .inner-tabs{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-bottom:16px;
  }
  .inner-tab{
    border:1px solid var(--line);
    background:#fff;
    padding:6px 14px;
    border-radius:999px;
    font-size:14px;
    cursor:pointer;
    color:var(--text);
  }
  .inner-tab.active{
    background:var(--brown);
    color:#fff;
    border-color:var(--brown);
  }
  .inner-tab-panel{display:none;}
  .inner-tab-panel.active{display:block;}

  .move-row-title{
    font-weight:600;
    margin-bottom:4px;
    color:var(--brown);
  }
  .move-notes{
    width:100%;
    min-height:48px;
    resize:vertical;
  }


  .notes-col{
    display:none;
  }


/* === MZJ Mobile Hotfix v2 (Full width + Compact Downbar + No tooltips) === */

/* use more width (remove right/left margins) */
.mzj-main, .main, main, .container, .page, .content{
  padding-left: 8px !important;
  padding-right: 8px !important;
}
@media (max-width: 430px){
  .mzj-main, .main, main, .container, .page, .content{
    padding-left: 6px !important;
    padding-right: 6px !important;
  }
}

/* cards/sections should stretch full width */
.card, .section, .panel, .box{
  max-width: none !important;
}

/* Inner tabs: keep 3+2 but slightly more compact */
.inner-tabs{
  gap:10px !important;
  margin: 14px 0 14px !important;
}
.inner-tabs .inner-tab{
  min-height:44px !important;
  border-radius:16px !important;
  font-size:13px !important;
  padding:10px 10px !important;
}

/* Downbar: make it smaller + 2 rows */
.mzj-main{padding-bottom: calc(96px + var(--safe-bottom)) !important;}

.mzj-downbar{
  height: calc(84px + var(--safe-bottom)) !important;
  border-top-left-radius: 20px !important;
  border-top-right-radius: 20px !important;
}
.mzj-downbar .inner{
  height:84px !important;
  display:grid !important;
  grid-template-columns: repeat(2, 1fr) !important;
  grid-template-rows: repeat(2, 1fr) !important;
  gap:8px !important;
  padding: 8px 10px !important;
  align-items:stretch !important;
}
.mzj-downbar a{
  border-radius:16px !important;
  padding:8px 8px !important;
  gap:6px !important;
}
.mzj-downbar a i{
  font-size:15px !important;
}
.mzj-downbar a span{
  font-size:11px !important;
  font-weight:900 !important;
  line-height:1 !important;
}

/* prevent long-press tooltip/selection popups as much as possible */
.inner-tab, .mzj-downbar a{
  -webkit-touch-callout: none !important;
  -webkit-user-select: none !important;
  user-select: none !important;
}



/* === Hotfix v3: Tabs text wrap prevention === */
.inner-tabs{
  display:grid !important;
  grid-template-columns: repeat(3, minmax(0,1fr)) !important;
}
.inner-tabs .inner-tab{
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  height: 44px !important;
  max-height: 44px !important;
  font-size: 12px !important;
  padding: 8px 8px !important;
  line-height: 1.05 !important;
}
.inner-tabs .inner-tab:nth-child(4){ grid-column: 1 / 3; }
.inner-tabs .inner-tab:nth-child(5){ grid-column: 3 / 4; }


/* === Hotfix v3: Downbar 5 + باقي في الصف الثاني === */
.mzj-main{padding-bottom: calc(92px + var(--safe-bottom)) !important;}

.mzj-downbar{
  height: calc(80px + var(--safe-bottom)) !important;
}
.mzj-downbar .inner{
  height:80px !important;
  display:grid !important;
  grid-template-columns: repeat(5, minmax(0,1fr)) !important;
  grid-auto-rows: 1fr !important;
  gap:6px !important;
  padding: 8px 10px !important;
}
.mzj-downbar a{
  display:flex !important;
  flex-direction:column !important;
  align-items:center !important;
  justify-content:center !important;
  gap:4px !important;
  padding:6px 4px !important;
  border-radius:14px !important;
}
.mzj-downbar a{
  font-size:15px !important; /* emoji size */
}
.mzj-downbar a span{
  font-size:10px !important;
  font-weight:900 !important;
  line-height:1.05 !important;
  white-space:nowrap !important;
  overflow:hidden !important;
  text-overflow:ellipsis !important;
  max-width:100%;
}

/* no weird long-press highlight */
.mzj-downbar a, .inner-tab{
  -webkit-tap-highlight-color: transparent !important;
}


/* === FINAL FIX v4 === */

/* ===== Tabs (small chips, no overflow) ===== */
.inner-tabs{
  display:grid !important;
  grid-template-columns: repeat(3, 1fr) !important;
  gap:8px !important;
  margin: 10px 0 14px !important;
}
.inner-tabs .inner-tab{
  height:36px !important;
  min-height:36px !important;
  border-radius:14px !important;
  font-size:11px !important;
  font-weight:800 !important;
  padding:6px 6px !important;
  white-space:nowrap !important;
  overflow:hidden !important;
  text-overflow:ellipsis !important;
}
.inner-tabs .inner-tab:nth-child(4){ grid-column:1/3; }
.inner-tabs .inner-tab:nth-child(5){ grid-column:3/4; }

/* ===== Downbar (VERY COMPACT) ===== */
.mzj-main{ padding-bottom: calc(86px + var(--safe-bottom)) !important; }

.mzj-downbar{
  height: calc(72px + var(--safe-bottom)) !important;
}

.mzj-downbar .inner{
  height:72px !important;
  display:grid !important;
  grid-template-columns: repeat(5, 1fr) !important;
  grid-auto-rows: 1fr !important;
  gap:4px !important;
  padding:6px 6px !important;
}

.mzj-downbar a{
  border-radius:12px !important;
  padding:4px 2px !important;
  gap:2px !important;
  font-size:14px !important; /* emoji size */
}

.mzj-downbar a span{
  font-size:9px !important;
  font-weight:800 !important;
  line-height:1 !important;
  white-space:nowrap !important;
  overflow:hidden !important;
  text-overflow:ellipsis !important;
}

/* remove any weird popups */
.inner-tab, .mzj-downbar a{
  -webkit-touch-callout:none !important;
  user-select:none !important;
}


/* === MZJ Action Selector (Mobile) === */
.mzj-action-bar{
  display:grid;
  gap:8px;
  margin: 10px 0 14px;
}
.mzj-action-label{
  font-weight:900;
  color: rgb(62,36,32);
  font-size:12px;
  padding: 0 2px;
}
.mzj-action-select{
  width:100%;
  height:44px;
  border-radius:16px;
  border:1.5px solid rgba(62,36,32,.22);
  background:#fff;
  color: rgb(62,36,32);
  font-weight:900;
  font-size:13px;
  padding: 0 12px;
  outline: none;
  box-shadow: 0 10px 20px rgba(0,0,0,.06);
  -webkit-appearance: none;
  appearance: none;
  background-image:
    linear-gradient(45deg, transparent 50%, rgb(62,36,32) 50%),
    linear-gradient(135deg, rgb(62,36,32) 50%, transparent 50%);
  background-position:
    calc(16px) 19px,
    calc(10px) 19px;
  background-size: 6px 6px, 6px 6px;
  background-repeat:no-repeat;
}
.mzj-hidden-tabs{ display:none !important; }


/* === Arrange (تصدير قالب + استيراد) side-by-side on mobile === */
.mzj-export-template-import-row{
  display:grid !important;
  grid-template-columns: 1fr 1fr !important;
  gap:10px !important;
  align-items:stretch !important;
}
.mzj-export-template-import-row .btn{
  width:100% !important;
  justify-content:center !important;
}
.mzj-export-template-import-row .import-menu{
  width:100% !important;
}
.mzj-export-template-import-row #btnImportMenu{
  width:100% !important;
  justify-content:center !important;
}
@media (max-width:360px){
  .mzj-export-template-import-row{ grid-template-columns: 1fr !important; }
}


/* === Export + Template + Import in one row === */
.mzj-export-template-import-row{
  display:grid !important;
  grid-template-columns: 1fr 1fr 1fr !important;
  gap:10px !important;
  align-items:stretch !important;
}
.mzj-export-template-import-row .btn{
  width:100% !important;
  justify-content:center !important;
}
.mzj-export-template-import-row .import-menu,
.mzj-export-template-import-row #btnImportMenu{
  width:100% !important;
}

/* Downbar labels slightly smaller + ellipsis */
.mzj-downbar a span{
  font-size:9px !important;
}

</style>
<style id="noFlash">
  html{background:#fff8ef;}
  body{opacity:0;}
</style>
  <link rel="stylesheet" href="./mzj-ui.css" />

<style>
  .legacy-admin .dashboard-topbar,
  .legacy-admin .topbar,
  .legacy-admin .tabs,
  .legacy-admin .nav-tabs,
  .legacy-admin .nav-pills,
  .legacy-admin header:not(.mzj-topbar){
    display:none !important;
  }
</style>


<style>

/* === MZJ Mobile Overrides === */
:root{
  --mzj-brown: rgb(62,36,32);
  --mzj-beige: rgb(188,143,116);
  --mzj-cream: #fff8ef;
  --mzj-stroke: rgba(62,36,32,.12);
  --mzj-shadow: 0 10px 24px rgba(0,0,0,.08);
  --mzj-radius: 16px;
  --safe-top: env(safe-area-inset-top);
  --safe-bottom: env(safe-area-inset-bottom);
}
html,body{max-width:100%; overflow-x:hidden;}
body{
  font-family: "Tajawal", system-ui, -apple-system, Segoe UI, Roboto, Arial !important;
  background: linear-gradient(180deg, var(--mzj-cream) 0%, #fff 42%) !important;
}

/* Hide legacy PC chrome if present */
header, .topbar, .navbar, .header, .sidebar, aside.sidebar, nav.sidebar, .side-bar, .sidenav, .drawer, .app-sidebar, .layout-sidebar{
  display:none !important;
}
.mzj-mobile-shell{min-height:100vh; width:100%;}
.mzj-main{
  padding: 14px;
  padding-top: calc(14px + var(--safe-top));
  padding-bottom: calc(92px + var(--safe-bottom));
}

/* Tabs grid: 3 on first row, 2 on second row */
.admin-tabs{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin: 14px 0 18px;
}
.admin-tabs .tab-btn{
  height: 48px;
  border-radius: 18px;
  border: 1.5px solid rgba(62,36,32,.25);
  background: #fff;
  font-weight: 800;
  color: var(--mzj-brown);
  cursor:pointer;
  box-shadow: 0 6px 14px rgba(0,0,0,.06);
}
.admin-tabs .tab-btn.active{
  background: var(--mzj-brown);
  color:#fff;
  border-color: var(--mzj-brown);
  box-shadow: 0 10px 22px rgba(62,36,32,.22);
}
.admin-tabs .tab-btn:active{transform: scale(.98);}
.admin-tabs .tab-btn:nth-child(4){grid-column: 1 / 3;}
.admin-tabs .tab-btn:nth-child(5){grid-column: 3 / 4;}

/* Responsive table -> cards */
.mzj-table-stack table{width:100% !important;}
@media (max-width: 768px){
  .mzj-table-stack table thead{display:none !important;}
  .mzj-table-stack table, .mzj-table-stack tbody, .mzj-table-stack tr, .mzj-table-stack td{
    display:block !important;
    width:100% !important;
  }
  .mzj-table-stack tr{
    background:#fff;
    border:1px solid var(--mzj-stroke);
    border-radius: var(--mzj-radius);
    box-shadow: var(--mzj-shadow);
    padding: 10px 10px 6px;
    margin-bottom: 12px;
  }
  .mzj-table-stack td{
    border:0 !important;
    padding: 10px 8px !important;
    background: transparent !important;
  }
  .mzj-table-stack td::before{
    content: attr(data-label);
    display:block;
    font-size: 12px;
    color: rgba(62,36,32,.65);
    font-weight: 800;
    margin-bottom: 6px;
  }
  /* 6 cols => 3 per row inside card when cells are inline blocks */
  .mzj-table-stack tr{
    display:grid !important;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 10px;
  }
  .mzj-table-stack td{
    border:1px solid rgba(62,36,32,.08) !important;
    border-radius: 14px;
    background: var(--mzj-cream) !important;
    padding: 10px !important;
    min-height: 48px;
  }
}
@media (max-width: 420px){
  .mzj-table-stack tr{grid-template-columns: repeat(2, minmax(0,1fr));}
}
@media (max-width: 340px){
  .mzj-table-stack tr{grid-template-columns: 1fr;}
}


/* Downbar small */
.mzj-main{padding-bottom: calc(86px + var(--safe-bottom));}
.mzj-downbar{
  position:fixed; left:0; right:0; bottom:0;
  height: calc(66px + var(--safe-bottom));
  padding-bottom: var(--safe-bottom);
  background:#fff;
  border-top:1px solid var(--mzj-stroke);
  box-shadow: 0 -10px 28px rgba(0,0,0,.08);
  z-index:50;
}
.mzj-downbar .inner{
  height:66px;
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap:8px;
  padding: 10px 12px;
  align-items:center;
}
.mzj-downbar a{
  text-decoration:none;
  border-radius:18px;
  padding:10px 8px;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:4px;
  color: rgba(62,36,32,.70);
  font-weight:900;
  font-size:11px;
  border:1px solid rgba(62,36,32,.10);
  background: #fff;
}
.mzj-downbar a.active{
  background: rgba(188,143,116,.16);
  border-color: rgba(188,143,116,.35);
  color: var(--mzj-brown);
}



/* === MZJ Mobile Fixes (Tabs + Downbar) === */

/* Tabs: 3 فوق + 2 تحت */
.inner-tabs{
  display:grid !important;
  grid-template-columns: repeat(3, minmax(0,1fr)) !important;
  gap:12px !important;
  margin: 16px 0 18px !important;
}
.inner-tabs .inner-tab{
  width:100% !important;
  min-height:48px !important;
  border-radius:18px !important;
  font-weight:900 !important;
  line-height:1.2 !important;
  padding:10px 10px !important;
}
.inner-tabs .inner-tab:nth-child(4){
  grid-column: 1 / 3;
}
.inner-tabs .inner-tab:nth-child(5){
  grid-column: 3 / 4;
}

/* Downbar: أيقونات أصغر + صفين */
.mzj-main{padding-bottom: calc(118px + var(--safe-bottom)) !important;}

.mzj-downbar{
  height: calc(104px + var(--safe-bottom)) !important;
  border-top-left-radius: 22px !important;
  border-top-right-radius: 22px !important;
}
.mzj-downbar .inner{
  height:104px !important;
  display:grid !important;
  grid-template-columns: repeat(2, 1fr) !important;
  grid-template-rows: repeat(2, 1fr) !important;
  gap:10px !important;
  padding: 10px 12px !important;
  align-items:stretch !important;
}
.mzj-downbar a{
  border-radius:18px !important;
  padding:10px 10px !important;
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  gap:8px !important;
}
.mzj-downbar a i{
  font-size:16px !important;
}
.mzj-downbar a span{
  font-size:12px !important;
  font-weight:900 !important;
}

</style></head>
<body>

<div class="mzj-mobile-shell">
  <main class="mzj-main">
    

<header class="mzj-topbar">
  <div class="topbar-left">
    <button class="icon-btn" id="mzjSidebarBtn" aria-label="القائمة"><i class="fa-solid fa-bars"></i></button>
    <div class="brand">
      <div class="brand-mark">MZJ</div>
      <div class="brand-text">
        <div class="brand-title">محمد بن ذعار العجمي للسيارات</div>
        <div class="brand-sub">Workspace</div>
      </div>
    </div>
  </div>
  <div class="topbar-center">
    <div class="mzj-breadcrumb">
      <span class="crumb">الرئيسية</span>
      <i class="fa-solid fa-chevron-left"></i>
      <span class="crumb current">الإدارة</span>
    </div>
  </div>
  <div class="topbar-right">
    <div class="mzj-chip"><i class="fa-regular fa-clock"></i><span id="mzjNow">—</span></div>
    <button id="btnSignOut" class="btn btn-ghost" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> تسجيل الخروج</button>
  </div>
</header>

<main class="mzj-content mzj-mobile-only">

    <div class="legacy legacy-admin">

<!-- Topbar -->
<div class="topbar">
<div class="topbar-inner">
<div class="brand">
<div class="logo">MZJ</div>
<div>
<h1>لوحة إدارة السيارات</h1>
<small class="hint">مجموعة محمد بن ذعار العجمي للسيارات</small>
</div>
</div>
<div class="tabs">
<a class="tab active" href="m.admin.html">الإدارة</a>
<a class="tab" href="m.inventory.html">المخزون</a>
<a class="tab" href="m.dashboard.html">الداش بورد</a>
<a class="tab" href="m.vt.html">نقل السيارات</a>
<a class="tab" href="m.photoshoot-user.html">إدارة الطلبات</a>
<a class="tab" href="m.cars.html">كل السيارات</a>
<a class="tab" href="m.Activity.html">سجل النشاط</a>
</div>
<div class="row">
<div class="status-badge"><span class="dot warn" id="connDot"></span><span id="connText">جارِ الاتصال…</span></div>
<button id="btnSignOut" class="btn btn-ghost" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> تسجيل الخروج</button></div>
</div>
</div>
<!-- Auth Gate -->
<div class="auth-wrap" id="authGate">
<div class="auth-card">
<h2>تسجيل الدخول</h2>
<label for="email">البريد الإلكتروني</label>
<input id="email" placeholder="you@example.com" type="email"/>
<label for="password" style="margin-top:8px">كلمة المرور</label>
<input id="password" placeholder="••••••••" type="password"/>
<div class="auth-actions">
<button class="btn btn-primary" id="btnLogin">تسجيل الدخول</button>
<button class="btn btn-outline" id="btnSignup">إنشاء حساب</button>
</div>
<p class="hint" id="authHint" style="margin-top:10px"></p>
</div>
</div>
<!-- App -->
<div id="app" style="display:none">
<div class="container">
<div class="mzj-action-bar">
  <label class="mzj-action-label" for="mzjActionSelect">اختر الإجراء</label>
  <select id="mzjActionSelect" class="mzj-action-select">
    <option value="tab-add" selected>إضافة سيارة</option>
    <option value="tab-move">نقل السيارات</option>
    <option value="tab-edit">تعديل السيارات</option>
    <option value="tab-track">تتبع حركة رقم هيكل</option>
    <option value="tab-log">سجل الحركات</option>
  </select>

  <!-- kept for logic, hidden -->
  <div class="inner-tabs mzj-hidden-tabs" aria-hidden="true">
    <button class="inner-tab active" data-target="tab-add" tabindex="-1">إضافة سيارة</button>
    <button class="inner-tab" data-target="tab-move" tabindex="-1">نقل السيارات</button>
    <button class="inner-tab" data-target="tab-edit" tabindex="-1">تعديل السيارات</button>
    <button class="inner-tab" data-target="tab-track" tabindex="-1">تتبع حركة رقم هيكل</button>
    <button class="inner-tab" data-target="tab-log" tabindex="-1">سجل الحركات</button>
  </div>
</div>
<div class="inner-tab-panel active" id="tab-add">
<div class="card">
<div class="card-header">
<div class="section-title">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><rect height="7" width="7" x="3" y="3"></rect><rect height="7" width="7" x="14" y="3"></rect><rect height="7" width="7" x="14" y="14"></rect><rect height="7" width="7" x="3" y="14"></rect></svg>
<h2 style="margin:0">إضافة سيارة</h2>
</div>


<div class="row mzj-export-template-import-row">
<button class="btn btn-ghost" id="btnExport">
<i class="fa-regular fa-file-excel"></i> تصدير
          </button>
<!-- زر تصدير قالب -->
<button class="btn btn-ghost" id="btnExportBlank">
<i class="fa-regular fa-file"></i> تصدير قالب
          </button>

<div class="import-menu">
<button class="btn btn-ghost" id="btnImportMenu">
<i class="fa-solid fa-file-import"></i> استيراد ▾
            </button>
<div class="import-dropdown" id="importDropdown">
<button data-mode="replace"><i class="fa-solid fa-arrow-rotate-left"></i> استبدال كامل (مسح القديم + إضافة الجديد)</button>
<button data-mode="append"><i class="fa-solid fa-plus"></i> إضافة فوق الحالي (بدون مسح)</button>
<button data-mode="update"><i class="fa-solid fa-wrench"></i> تحديث من الشيت (تعديل الموجود فقط)</button>
</div>
</div>
<input accept=".xlsx,.xls,.csv" id="fileImport" style="display:none" type="file"/>
</div>
</div>
<div class="grid grid-4">
<div>
<label for="carSelect">سيارة</label>
<div class="row" style="gap:8px;align-items:stretch">
<select id="carSelect"></select>
<button class="btn btn-outline" id="btnAddModel">
<i class="fa-solid fa-plus"></i> موديل
            </button>
</div>
</div>
<div>
<label for="variantSelect">البيان</label>
<div class="row" style="gap:8px;align-items:stretch">
<select id="variantSelect"></select>
<button class="btn btn-outline" id="btnAddVariant">
<i class="fa-solid fa-plus"></i> بيان
            </button>
</div>
<div class="hint">يمكنك إضافة بيان جديد وربطه بأي سيارة</div>
</div>
<div><label for="dealer">الوكيل</label>
<div class="input-wrap">
<span class="i"><i class="fa-regular fa-building"></i></span>
<input id="dealer" placeholder="اسم الوكيل"/>
</div>
</div>
<div><label for="extColor">اللون الخارجي</label>
<div class="input-wrap">
<span class="i"><i class="fa-regular fa-circle"></i></span>
<input id="extColor" placeholder="أبيض / أسود ..."/>
</div>
</div>
<div><label for="intColor">اللون الداخلي</label>
<div class="input-wrap">
<span class="i"><i class="fa-regular fa-square"></i></span>
<input id="intColor" placeholder="جملي / أسود ..."/>
</div>
</div>
<div><label for="modelYear">موديل</label>
<div class="input-wrap">
<span class="i"><i class="fa-regular fa-calendar"></i></span>
<input id="modelYear" max="2100" min="2000" placeholder="2026" type="number"/>
</div>
</div>
<div><label for="plate">اللوحة</label>
<div class="input-wrap">
<span class="i"><i class="fa-regular fa-id-card"></i></span>
<input id="plate" placeholder="اختياري"/>
</div>
</div>
<!-- المكان: قائمة منسدلة ثابتة -->
<div>
<label for="location">المكان</label>
<select id="location">
<option value="المستودع : المخزون المتاح">المستودع : المخزون المتاح</option>
<option value="المستودع : سيارات بها ملاحظات">المستودع : سيارات بها ملاحظات</option>
<option value="المستودع : مباع تحت التسليم">المستودع : مباع تحت التسليم</option>
<option value="المستودع : مباع تم التسليم">المستودع : مباع تم التسليم</option>
<option value="الوكالة : المخزون المتاح">الوكالة : المخزون المتاح</option>
<option value="الوكالة : سيارات بها ملاحظات">الوكالة : سيارات بها ملاحظات</option>
<option value="الوكالة : مباع تحت التسليم">الوكالة : مباع تحت التسليم</option>
<option value="الوكالة : مباع تم التسليم">الوكالة : مباع تم التسليم</option>
<option value="فرع 1 الصالة : المخزون المتاح">فرع 1 الصالة : المخزون المتاح</option>
<option value="فرع 1 الصالة : سيارات بها ملاحظات">فرع 1 الصالة : سيارات بها ملاحظات</option>
<option value="فرع 1 الصالة : مباع تحت التسليم">فرع 1 الصالة : مباع تحت التسليم</option>
<option value="فرع 1 الصالة : مباع تم التسليم">فرع 1 الصالة : مباع تم التسليم</option>
<option value="فرع 2 الملتقى : المخزون المتاح">فرع 2 الملتقى : المخزون المتاح</option>
<option value="فرع 2 الملتقى : سيارات بها ملاحظات">فرع 2 الملتقى : سيارات بها ملاحظات</option>
<option value="فرع 2 الملتقى : مباع تحت التسليم">فرع 2 الملتقى : مباع تحت التسليم</option>
<option value="فرع 2 الملتقى : مباع تم التسليم">فرع 2 الملتقى : مباع تم التسليم</option>
<option value="فرع 3 القادسية : المخزون المتاح">فرع 3 القادسية : المخزون المتاح</option>
<option value="فرع 3 القادسية : سيارات بها ملاحظات">فرع 3 القادسية : سيارات بها ملاحظات</option>
<option value="فرع 3 القادسية : مباع تحت التسليم">فرع 3 القادسية : مباع تحت التسليم</option>
<option value="فرع 3 القادسية : مباع تم التسليم">فرع 3 القادسية : مباع تم التسليم</option>
</select>
</div>
<div><label for="batchName">اسم الدفعة</label>
<div class="input-wrap">
<span class="i"><i class="fa-solid fa-layer-group"></i></span>
<input id="batchName" placeholder="دفعة رمضان / نوفمبر 2025…"/>
</div>
</div>
<div><label for="vin">رقم الهيكل</label>
<div class="input-wrap">
<span class="i"><i class="fa-solid fa-barcode"></i></span>
<input id="vin" placeholder="LVR.../KMH.../رقم"/>
</div>
</div>
<div class="grid" style="grid-template-columns:1fr">
<label for="notes">الملاحظات</label>
<textarea id="notes" placeholder="ملاحظات إضافية — نفس ارتفاع رقم الهيكل"></textarea>
</div>
</div>
<div class="row" style="margin-top:12px">
<button class="btn btn-primary" id="btnSave">
<i class="fa-regular fa-floppy-disk"></i> حفظ
        </button>
<button class="btn btn-ghost" id="btnReset">
<i class="fa-solid fa-rotate"></i> تفريغ
        </button>
<div class="hint"></div>
</div>
</div>
</div>
<div class="inner-tab-panel" id="tab-move">
<div class="card">
<div class="card-header">
<div class="section-title">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M7 10l5-5 5 5"></path><path d="M7 14l5 5 5-5"></path></svg>
<h2 style="margin:0">حركة نقل السيارات (برقم الهيكل)</h2>
</div>
<span class="hint"> <b></b> </span>
<div class="row" style="gap:8px;align-items:center;flex-wrap:wrap"><label>إلى</label><select id="moveToGlobal"></select></div></div>
<!-- 8 صفوف نقل -->
<div class="row" style="margin:8px 0 12px;gap:8px;align-items:center;flex-wrap:wrap"><button class="btn btn-ghost" id="btnAddMoveRow" type="button"><i class="fa-solid fa-plus"></i> إضافة حركة أخرى</button></div><div class="grid" id="moveRowsContainer" style="gap:10px"></div>
<!-- datalist للاقتراحات -->
<datalist id="vinHints"></datalist>
<!-- Checklist يظهر فقط مع 'مباع تحت التسليم' -->
<div class="checklist" id="underDeliveryBox" style="display:none; margin-top:10px">
<h4>المتطلبات عند النقل إلى <b>مباع تحت التسليم</b></h4>
<div class="grid grid-2">
<div>
<div class="check-row">
<input id="chkAdminApproved" type="checkbox"/>
<label for="chkAdminApproved">موافقة إدارية</label>
</div>
<label for="adminNotes" style="margin-top:6px">ملاحظات الموافقة الإدارية</label>
<textarea id="adminNotes" placeholder="اكتب أي ملاحظات إدارية…"></textarea>
</div>
<div>
<div class="check-row">
<input id="chkFinanceApproved" type="checkbox"/>
<label for="chkFinanceApproved">موافقة مالية</label>
</div>
<label for="financeNotes" style="margin-top:6px">ملاحظات الموافقة المالية</label>
<textarea id="financeNotes" placeholder="اكتب أي ملاحظات مالية…"></textarea>
</div>
</div>
</div>
<!-- ملاحظات سيارات بها ملاحظات -->
<div class="row" style="margin-top:12px">
<button class="btn btn-ghost" id="btnFindByVin">
<i class="fa-solid fa-magnifying-glass"></i> عرض البيانات
        </button>
<button class="btn btn-primary" id="btnMove">
<i class="fa-solid fa-right-left"></i> نقل
        </button>
</div>
<p class="hint" id="moveStatus" style="margin-top:8px"></p>
<!-- إشعار حركة النقل الكبير -->
<div class="move-alert" id="moveAlert">
<div class="icon">
<i class="fa-solid fa-circle-check"></i>
</div>
<div>
<div class="title" id="moveAlertTitle">نتيجة حركة النقل</div>
<ul id="moveAlertList"></ul>
</div>
</div>
<!-- بطاقة عرض بيانات السيارة -->
<div class="card" id="carDetailsBox" style="display:none;margin-top:12px">
<div class="section-title">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><rect height="16" rx="2" width="18" x="3" y="4"></rect><path d="M7 8h10"></path></svg>
<h2 style="margin:0">عرض بيانات السيارة</h2>
</div>
<div class="grid grid-2" id="carDetails" style="margin-top:8px"></div>
<p class="hint" id="carDetailsHint" style="margin-top:8px"></p>
</div>
</div>
</div>
<div class="inner-tab-panel" id="tab-edit">
<div class="card">
<div class="card-header">
<div class="section-title">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><rect height="16" rx="2" width="18" x="3" y="4"></rect><path d="M7 8h10"></path></svg>
<h2 style="margin:0">تعديل السيارات</h2>
</div>
<span class="hint"></span>
</div>
<div class="row" style="gap:8px;margin-bottom:8px">
<input id="search" placeholder="بحث سريع (سيارة / البيان / الوكيل / الألوان / الموديل / اللوحة / المكان / اسم الدفعة / رقم الهيكل)" style="flex:1; padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff"/>
<button class="btn btn-ghost" id="btnClearSearch">
<i class="fa-solid fa-minus"></i> مسح
        </button>
</div>
<div class="table-wrap">
<table id="carsTable">
<thead>
<tr>
<th>سيارة</th>
<th>البيان</th>
<th>الوكيل</th>
<th>اللون الخارجي</th>
<th>اللون الداخلي</th>
<th>موديل</th>
<th>اللوحة</th>
<th>المكان</th>
<th>اسم الدفعة</th>
<th>رقم الهيكل</th>
<th>الملاحظات</th>
<th class="w-160">تحكم</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<p class="hint">الحفظ يتم مباشرة على Firestore.</p>
</div>
</div>
<div class="inner-tab-panel" id="tab-track">
<div class="card">
<div class="card-header">
<div class="section-title">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M12 8v8M8 12h8"></path></svg>
<h2 style="margin:0">تتبّع حركة رقم هيكل</h2>
</div>
<div class="row" style="gap:8px">
<input id="trackVin" list="vinHints" placeholder="اكتب رقم الهيكل لعرض جميع حركاته"/>
<button class="btn btn-ghost" id="btnClearTrack">مسح</button>
</div>
</div>
<div class="table-wrap">
<table id="trackTable">
<thead>
<tr>
<th class="w-120">#</th>
<th class="w-120">التاريخ</th>
<th>من</th>
<th>إلى</th>
<th>سيارة</th>
<th class="w-160">ملاحظات النقل</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<p class="hint"></p>
</div>
</div>
<div class="inner-tab-panel" id="tab-log">
<div class="card">
<div class="card-header">
<div class="section-title" style="margin-bottom:0">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M3 5h18M3 12h18M3 19h18"></path></svg>
<h2 style="margin:0">سجل الحركات</h2>
</div>
<div class="row">
<div class="row">
<label style="margin:0 6px 0 0">تاريخ من</label>
<input id="movesFromDate" type="date"/>
</div>
<div class="row">
<label style="margin:0 6px 0 0">إلى</label>
<input id="movesToDate" type="date"/>
</div>
<button class="btn btn-ghost" id="btnClearDate">مسح التاريخ</button>
</div>
</div>
<div class="table-wrap">
<table id="movesTable">
<thead>
<tr>
<th class="w-120">#</th>
<th class="w-120">التاريخ</th>
<th>رقم الهيكل</th>
<th>سيارة</th>
<th>من</th>
<th>إلى</th>
<th class="w-120">ID</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="row" style="margin-top:8px">
<button class="btn btn-ghost" id="btnClearMoves">
<i class="fa-regular ف-trash-can"></i> تفريغ
        </button>
</div>
</div>
</div>
</div>
<!-- Modals -->
<!-- إضافة موديل -->
<div class="modal-backdrop" id="modelModal">
<div aria-modal="true" class="modal" role="dialog">
<header>
<h3>إضافة موديل جديد</h3>
<button class="btn btn-ghost" data-close="modelModal"><i class="fa-solid fa-xmark"></i></button>
</header>
<label for="modelName">اسم الموديل</label>
<input id="modelName" placeholder="هيونداي توسان 2026 / سنتافي…"/>
<div class="actions">
<button class="btn btn-primary" id="confirmAddModel"><i class="fa-solid fa-check"></i> إضافة</button>
<button class="btn" data-close="modelModal">إلغاء</button>
</div>
</div>
</div>
<!-- إضافة بيان -->
<div class="modal-backdrop" id="variantModal">
<div aria-modal="true" class="modal" role="dialog">
<header>
<h3>إضافة بيان وربطه بموديل</h3>
<button class="btn btn-ghost" data-close="variantModal"><i class="fa-solid fa-xmark"></i></button>
</header>
<label for="variantModelFor">الموديل</label>
<select id="variantModelFor"></select>
<label for="variantName" style="margin-top:8px">اسم البيان</label>
<input id="variantName" placeholder="كومفورت / سمارت / رويال…"/>
<div class="actions">
<button class="btn btn-primary" id="confirmAddVariant"><i class="fa-solid fa-check"></i> إضافة</button>
<button class="btn" data-close="variantModal">إلغاء</button>
</div>
</div>
</div>

<!-- تحديث من الشيت (اختيار أعمدة التحديث) -->
<div class="modal-backdrop" id="updateModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <header>
      <h3>تحديث من الشيت</h3>
      <button class="btn btn-ghost" data-close="updateModal"><i class="fa-solid fa-xmark"></i></button>
    </header>

    <div style="margin-bottom:10px;color:#555;font-size:13px;line-height:1.7">
      اختر الأعمدة اللي تحب تحدّثها. (الخلايا الفاضية في الشيت ما تمسحش القيم القديمة)
    </div>

    <div id="updateFieldsBox" class="grid grid-2" style="gap:10px;margin:10px 0 14px 0"></div>

    <div class="actions" style="justify-content:flex-end;flex-wrap:wrap">
      <button class="btn btn-ghost" id="btnUpdateSelectAll" type="button"><i class="fa-solid fa-check-double"></i> تحديد الكل</button>
      <button class="btn btn-primary" id="confirmUpdateFields" type="button"><i class="fa-solid fa-check"></i> تنفيذ</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js">
  function showUpdateReportButton(){
    let btn = document.getElementById('btnUpdateReport');
    if(!btn){
      btn = document.createElement('button');
      btn.id = 'btnUpdateReport';
      btn.className = 'btn btn-soft';
      btn.style.marginTop = '8px';
      btn.innerHTML = '<i class="fa-solid fa-file-lines"></i> عرض تقرير التحديث';
      btn.onclick = openUpdateReport;
      document.querySelector('.toast-wrap')?.appendChild(btn);
    }
  }

  function openUpdateReport(){
    if(!__lastUpdateReport){ showToast('لا يوجد تقرير متاح','info'); return; }
    const rows = [];
    __lastUpdateReport.updated.forEach(v=> rows.push({VIN:v, Status:'Updated'}));
    __lastUpdateReport.notFound.forEach(v=> rows.push({VIN:v, Status:'Not Found'}));
    __lastUpdateReport.skipped.forEach(v=> rows.push({VIN:v, Status:'Skipped'}));

    // build CSV
    let csv = 'VIN,Status\n';
    rows.forEach(r=>{ csv += `"${r.VIN}","${r.Status}"\n`; });

    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'update_report.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import {getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, updateDoc} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  /* ===== Firebase ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const STATE_REF = doc(db, "mzj_admin_state", "v1");
  
  // ===== Firestore helpers (fix missing wrappers) =====
  const mzjSetDoc = (...args) => setDoc(...args);
  const mzjUpdateDoc = (...args) => updateDoc(...args);
  const clean = (v)=> String(v ?? '')
    .replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069]/g,'')
    .replace(/\s+/g,' ')
    .trim();

/* ===== Roles & Permissions (Firestore) ===== */
  const ROLE_ADMIN   = 'الادارة';
  const ROLE_IDARI   = 'اداري';
  const ROLE_BRANCH  = 'مدراء فروع';

  // هذه الصفحة m.admin.html مسموحة فقط لتصنيف "الادارة"
  const PAGE_ALLOWED_ROLES = [ROLE_ADMIN];

  async function fetchUserRole(user){
    try{
      // ملاحظة: الكولكشن اسمه "user" (مفرد) حسب إعدادك في Firestore
      const userDocRef = doc(db, 'user', user.uid);
      const snap = await getDoc(userDocRef);
      if(snap.exists()){
        const data = snap.data() || {};
        return data.role || null;
      }
      return null;
    }catch(err){
      console.error('Error fetching user role:', err);
      return null;
    }
  }


  /* ===== Helpers / State ===== */
  const $ = s => document.querySelector(s);
  const toast = $('#toast');
  function showToast(msg,type='ok'){toast.textContent=msg;toast.className='toast '+type;toast.style.display='block';setTimeout(()=>toast.style.display='none',1800)}
  function pad(n){return n<10?'0'+n:n}
  function now(){const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;}
  function onlyDate(str){return (str||'').toString().slice(0,10)}
  function normalizeVin(v){if(!v)return'';const ar={'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};return v.toString().replace(/[٠-٩]/g,d=>ar[d]).toUpperCase().replace(/[\s\-\._]/g,'').trim()}
  function nextId(){return stock.length?Math.max(...stock.map(r=>Number(r.id)||0))+1:1}
  function debounce(fn,wait=250){let t;return (...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),wait)};}

  let stock=[], moves=[], models=[], variantsMap={};

  function liftNoFlash(){
  const nf = document.getElementById('noFlash');
  if(nf) nf.remove();
  document.body.style.opacity = '1';
}
/* ===== DOM refs ===== */
  const connDot=$('#connDot'), connText=$('#connText');
  const authGate=$('#authGate'), appRoot=$('#app'), btnSignOut=$('#btnSignOut');
  const emailEl=$('#email'), passEl=$('#password'), btnLogin=$('#btnLogin'), btnSignup=$('#btnSignup'), authHint=$('#authHint');

  const carSelect=$('#carSelect'), variantSelect=$('#variantSelect');
  const dealerInput=$('#dealer'), extColorInput=$('#extColor'), intColorInput=$('#intColor');
  const modelYearInput=$('#modelYear'), plateInput=$('#plate'), locationSelect=$('#location'), batchNameInput=$('#batchName');
  const vinInput=$('#vin'), notesInput=$('#notes');
  const btnSave=$('#btnSave'), btnReset=$('#btnReset');

  const btnImportMenu=$('#btnImportMenu'), importDropdown=$('#importDropdown'), fileImport=$('#fileImport'), btnExport=$('#btnExport'), btnExportBlank=$('#btnExportBlank');

  const searchInput=$('#search'), btnClearSearch=$('#btnClearSearch'), tableBody=document.querySelector('#carsTable tbody');
  const movesTableBody=document.querySelector('#movesTable tbody'), btnClearMoves=$('#btnClearMoves');

  // سجل الحركات — فلاتر التاريخ
  const movesFromDate=$('#movesFromDate'), movesToDate=$('#movesToDate'), btnClearDate=$('#btnClearDate');

  // تتبع VIN
  const trackVin=$('#trackVin'), trackTableBody=document.querySelector('#trackTable tbody'), btnClearTrack=$('#btnClearTrack');

  // Modals
  const modelModal = $('#modelModal');
  const variantModal = $('#variantModal');
  const btnAddModel=$('#btnAddModel'), btnAddVariant=$('#btnAddVariant');
  const modelNameEl = $('#modelName');
  const confirmAddModel = $('#confirmAddModel');

  const variantModelForEl = $('#variantModelFor');
  const variantNameEl = $('#variantName');
  const confirmAddVariant = $('#confirmAddVariant');

  // حركة النقل (متعددة الصفوف)
  const moveRowsContainer = document.querySelector('#moveRowsContainer');
  const btnAddMoveRow = document.querySelector('#btnAddMoveRow');
  const moveToGlobal = document.querySelector('#moveToGlobal');
  const btnFindByVin=$('#btnFindByVin'), btnMove=$('#btnMove');
  const moveStatus=$('#moveStatus'), carDetailsBox=$('#carDetailsBox'), carDetails=$('#carDetails'), carDetailsHint=$('#carDetailsHint');

  const underDeliveryBox=$('#underDeliveryBox');
  const chkAdminApproved=$('#chkAdminApproved'), adminNotes=$('#adminNotes');
  const chkFinanceApproved=$('#chkFinanceApproved'), financeNotes=$('#financeNotes');

  // datalist للاقتراحات
  const vinHints = $('#vinHints');

  // إشعار حركة النقل الكبير
  const moveAlert = $('#moveAlert');
  const moveAlertTitle = $('#moveAlertTitle');
  const moveAlertList  = $('#moveAlertList');

  /* ===== Connection status ===== */
  function setStatus(mode, txt){
    connDot.className='dot '+(mode==='ok'?'ok':mode==='err'?'err':'warn');
    connText.textContent = txt;
  }

  /* ===== Auth Gate ===== */
  
  onAuthStateChanged(auth, async (user)=>{
  if(user){
    try{
      const role = await fetchUserRole(user);
    window.__mzjUserRole = role || null;
      if(!role || !PAGE_ALLOWED_ROLES.includes(role)){
        window.location.href = 'unauthorized.html';
        return;
      }
      authGate.style.display = 'none';
      appRoot.style.display  = 'block';
      btnSignOut.style.display = 'inline-flex';
      setStatus('ok', `متصل: ${user.email} — الدور: ${role}`);
      liftNoFlash();
      await initData();
      subscribeLive();
    }catch(err){
      console.error(err);
      setStatus('err','خطأ في تحميل البيانات');
      liftNoFlash();
    }
  }else{
    appRoot.style.display   = 'none';
    authGate.style.display  = 'grid';
    btnSignOut.style.display = 'none';
    setStatus('warn','لم يتم تسجيل الدخول');
    liftNoFlash();
  }
});
btnLogin.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{ await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
    catch(e){ authHint.textContent='فشل تسجيل الدخول: '+(e?.message||e); }
  });
  btnSignup.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{ await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
    catch(e){ authHint.textContent='تعذّر إنشاء الحساب: '+(e?.message||e); }
  });
  btnSignOut.addEventListener('click', ()=> signOut(auth));

  /* ===== Data init / subscribe ===== */
  async function initData(){
    try{
      const s=await getDoc(STATE_REF);
      if(s.exists()){
        const d=s.data()||{};
        stock = Array.isArray(d.stock)? d.stock: [];
        moves = Array.isArray(d.moves)? d.moves: [];
        models = Array.isArray(d.models)? d.models: [];
        variantsMap = d.variantsMap || {};
      }else{
        stock=[]; moves=[]; models=[]; variantsMap={};
      }
      loadModelsIntoSelects();
      if(carSelect.value) populateVariants(carSelect.value);
      renderTable(); renderMoves(); renderTrack();
      fillMoveLists();
      updateRequirementBoxes();
      setStatus('ok','تم تحميل البيانات');
    }catch(e){ setStatus('warn','تعذّر تحميل البيانات'); }
  }
  function subscribeLive(){
    try{
      onSnapshot(STATE_REF,(snap)=>{
        if(!snap.exists()) return;
        const d=snap.data()||{};
        stock = Array.isArray(d.stock)? d.stock: stock;
        moves = Array.isArray(d.moves)? d.moves: moves;
        models= Array.isArray(d.models)? d.models: models;
        variantsMap = d.variantsMap || variantsMap;
        loadModelsIntoSelects();
        if(carSelect.value) populateVariants(carSelect.value);
        renderTable(); renderMoves(); renderTrack();
        fillMoveLists();
        updateRequirementBoxes();
        setStatus('ok','مزامنة حيّة');
      },()=> setStatus('warn','انقطاع المزامنة مؤقتًا'));
    }catch(e){}
  }
  async function persistAll(){
    try{
      await mzjSetDoc(STATE_REF, { stock, moves, models, variantsMap, updatedAt: now() }, { merge:true });
      setStatus('ok','تم الحفظ');
    }catch(e){
      setStatus('err','تعذّر الحفظ'); showToast('تعذّر الحفظ إلى السحابة','err');
    }
  }

  /* ===== Models / Variants ===== */
  function loadModelsIntoSelects(){
    carSelect.innerHTML='';
    models.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; carSelect.appendChild(o); });
    variantModelForEl.innerHTML='';
    models.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; variantModelForEl.appendChild(o); });
  }
  function populateVariants(modelName){
    const arr=(variantsMap[modelName]||[]);
    variantSelect.innerHTML='';
    if(!arr.length){ const opt=document.createElement('option'); opt.value=''; opt.textContent='— لا توجد بيانات محددة —'; variantSelect.appendChild(opt); }
    else arr.forEach(v=>{ const opt=document.createElement('option'); opt.value=v; opt.textContent=v; variantSelect.appendChild(opt); });
  }
  carSelect.addEventListener('change',e=>{ populateVariants(e.target.value); });

  // فتح المودالات
  btnAddModel.addEventListener('click',()=>{ modelNameEl.value=''; openModal(modelModal); });
  btnAddVariant.addEventListener('click',()=>{ if(models.length && carSelect.value){ variantModelForEl.value = carSelect.value; } variantNameEl.value=''; openModal(variantModal); });

  // تأكيد إضافة موديل
  confirmAddModel.addEventListener('click', async ()=>{
    const name=(modelNameEl.value||'').trim();
    window.__mzjUserName = name || null;
    if(!name) return showToast('اكتب اسم الموديل','info');
    if(!models.includes(name)){ models.push(name); if(!variantsMap[name]) variantsMap[name]=[]; loadModelsIntoSelects(); carSelect.value=name; populateVariants(name); await persistAll(); showToast('تمت إضافة الموديل','ok');}
    else showToast('الموديل موجود بالفعل','info');
    modelModal.style.display='none';
  });

  // تأكيد إضافة بيان
  confirmAddVariant.addEventListener('click', async ()=>{
    const modelFor=(variantModelForEl.value||'').trim();
    const vName=(variantNameEl.value||'').trim();
    if(!modelFor) return showToast('اختر الموديل','info');
    if(!vName) return showToast('اكتب اسم البيان','info');
    variantsMap[modelFor]=variantsMap[modelFor]||[];
    if(!variantsMap[modelFor].includes(vName)){ variantsMap[modelFor].push(vName); if(carSelect.value===modelFor){ populateVariants(modelFor); variantSelect.value=vName; } await persistAll(); showToast('تم حفظ البيان','ok');}
    else showToast('البيان مسجّل مسبقًا','info');
    variantModal.style.display='none';
  });

  /* ===== Table render / search ===== */
  function renderTable(){
    const q=(searchInput.value||'').trim().toLowerCase();
    tableBody.innerHTML='';
    let rows=stock.slice().sort((a,b)=>a.id-b.id);
    if(q){
      rows=rows.filter(r=>{
        const hay=[r.car,r.variant,r.dealer,r.extColor,r.intColor,r.modelYear,r.plate,r.location,r.batchName,r.notes,r.vin].join(' ').toLowerCase();
        return hay.includes(q);
      });
    }
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><strong>${r.car||''}</strong></td>
        <td>${r.variant||''}</td>
        <td>${r.dealer||''}</td>
        <td>${r.extColor||''}</td>
        <td>${r.intColor||''}</td>
        <td class="nowrap">${r.modelYear||''}</td>
        <td class="nowrap"><span class="copyable" data-copy="${r.plate||''}">${r.plate||''}</span></td>
        <td>${r.location||''}</td>
        <td>${r.batchName||''}</td>
        <td class="nowrap"><span class="copyable" data-copy="${r.vin||''}">${r.vin||''}</span></td>
        <td>${r.notes||''}</td>
        <td>
          <div class="cell-actions">
            <button class="btn btn-ghost" data-edit="${r.id}">تعديل ✎</button>
            <button class="btn btn-danger" data-del="${r.id}">حذف 🗑</button>
          </div>
        </td>`;
      tableBody.appendChild(tr);
    });
  }

  const INLINE_EDIT_FIELDS = ['car','variant','dealer','extColor','intColor','modelYear','plate','location','batchName','vin','notes'];

  function makeRowEditable(tr, rec){
    if(!tr || !rec) return;
    tr.dataset.editing = '1';
    const tds = tr.querySelectorAll('td');
    const fields = INLINE_EDIT_FIELDS;
    fields.forEach((field, idx)=>{
      const td = tds[idx];
      if(!td) return;
      const current = rec[field] || '';
      if(field === 'location'){
        const sel = document.createElement('select');
        sel.className = 'edit-location';
        if(Array.isArray(FIXED_LOCATIONS)){
          FIXED_LOCATIONS.forEach(loc=>{
            const opt = document.createElement('option');
            opt.value = loc;
            opt.textContent = loc;
            if(loc === current) opt.selected = true;
            sel.appendChild(opt);
          });
        }
        td.innerHTML = '';
        td.appendChild(sel);
      }else if(field === 'notes'){
        const ta = document.createElement('textarea');
        ta.className = 'edit-notes';
        ta.value = current;
        ta.style.width = '100%';
        ta.style.minHeight = '40px';
        td.innerHTML = '';
        td.appendChild(ta);
      }else{
        const inp = document.createElement('input');
        inp.className = 'edit-'+field;
        inp.value = current;
        inp.style.width = '100%';
        td.innerHTML = '';
        td.appendChild(inp);
      }
    });
    const actionsTd = tds[11];
    if(actionsTd){
      actionsTd.innerHTML = '';
      const wrap = document.createElement('div');
      wrap.className = 'cell-actions';
      const btnSave = document.createElement('button');
      btnSave.className = 'btn btn-primary';
      btnSave.setAttribute('data-save-inline', rec.id);
      btnSave.textContent = 'حفظ';
      const btnCancel = document.createElement('button');
      btnCancel.className = 'btn btn-ghost';
      btnCancel.setAttribute('data-cancel-inline', rec.id);
      btnCancel.textContent = 'إلغاء';
      wrap.appendChild(btnSave);
      wrap.appendChild(btnCancel);
      actionsTd.appendChild(wrap);
    }
  }
  searchInput.addEventListener('input',renderTable);
  btnClearSearch.addEventListener('click',()=>{searchInput.value=''; renderTable();});

  /* نسخ سريع + أزرار تعديل/حذف */
  document.addEventListener('click',(e)=>{
    const pill=e.target.closest('.copyable');
    const btn=e.target.closest('button');
    if(pill){
      const txt=(pill.getAttribute('data-copy')||'').trim();
      if(txt){ navigator.clipboard.writeText(txt).then(()=>showToast('تم النسخ ✅','ok')); }
    }
    if(btn){
      const del=btn.getAttribute('data-del');
      const edit=btn.getAttribute('data-edit');
      const saveInline=btn.getAttribute('data-save-inline');
      const cancelInline=btn.getAttribute('data-cancel-inline');

      if(edit){
        const id=Number(edit);
        const rec=stock.find(r=>r.id===id);
        if(!rec) return;
        const tr=btn.closest('tr');
        makeRowEditable(tr, rec);
      }

      if(saveInline){
        const id=Number(saveInline);
        const idx=stock.findIndex(r=>r.id===id);
        if(idx<0) return;
        const tr=btn.closest('tr');
        const tds=tr.querySelectorAll('td');
        const fields=['car','variant','dealer','extColor','intColor','modelYear','plate','location','batchName','vin','notes'];
        const rec=stock[idx];
        fields.forEach((field,idxField)=>{
          const td=tds[idxField];
          if(!td) return;
          let val=rec[field]||'';
          if(field==='location'){
            const sel=td.querySelector('select');
            if(sel) val=sel.value.trim();
          }else if(field==='notes'){
            const ta=td.querySelector('textarea');
            if(ta) val=ta.value.trim();
          }else{
            const inp=td.querySelector('input');
            if(inp) val=inp.value.trim();
          }
          rec[field]=val;
        });
        stock[idx]=rec;
        persistAll();
        renderTable();
        showToast('تم التعديل بنجاح','ok');
      }

      if(cancelInline){
        renderTable();
      }

      if(del){
        const id=Number(del);
        if(confirm('تأكيد الحذف؟')){
          stock=stock.filter(r=>r.id!==id);
          persistAll();
          renderTable();
          showToast('تم الحذف','ok');
        }
      }
    }
  });


/* حفظ / تعديل */
  let editId=null;
  btnSave.addEventListener('click',async ()=>{
    const record={
      id:editId||nextId(),
      car:carSelect.value,
      variant:variantSelect.value||'',
      dealer:dealerInput.value.trim(),
      extColor:extColorInput.value.trim(),
      intColor:intColorInput.value.trim(),
      vin:normalizeVin(vinInput.value),
      modelYear:modelYearInput.value.trim(),
      plate:plateInput.value.trim(),
      location:locationSelect.value,
      batchName:batchNameInput.value.trim(),
      notes:notesInput.value.trim()
    };
    if(!record.car) return showToast('اختر السيارة أولًا','err');

    if(editId){const idx=stock.findIndex(r=>r.id===editId); if(idx>-1) stock[idx]=record; editId=null; showToast('تم التعديل','ok');}
    else {stock.push(record); showToast('تم الحفظ','ok');}
    await persistAll(); renderTable(); clearForm();
  });
  function clearForm(){
    if(models.length){carSelect.value=models[0]; populateVariants(carSelect.value); variantSelect.value=variantSelect.options[0]?.value||'';}
    dealerInput.value=''; extColorInput.value=''; intColorInput.value='';
    modelYearInput.value=''; plateInput.value='';
    locationSelect.selectedIndex=0;
    batchNameInput.value=''; vinInput.value=''; notesInput.value=''; editId=null;
  }
  btnReset.addEventListener('click',clearForm);

  /* تصدير Excel (كامل) */
  btnExport.addEventListener('click',()=>{
    const rows=stock.slice().sort((a,b)=>a.id-b.id);
    const header=["م","سيارة","البيان","الوكيل","اللون الخارجي","اللون الداخلي","موديل","اللوحة","المكان","اسم الدفعة","رقم الهيكل","الملاحظات"];
    const data=[header];
    rows.forEach(r=>data.push([r.id,r.car,r.variant,r.dealer,r.extColor,r.intColor,r.modelYear,r.plate,r.location,r.batchName||'',r.vin,r.notes]));
    const ws=XLSX.utils.aoa_to_sheet(data);
    ws['!cols']=[{wch:6},{wch:22},{wch:16},{wch:16},{wch:14},{wch:14},{wch:8},{wch:12},{wch:22},{wch:18},{wch:22},{wch:26}];
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Cars");
    XLSX.writeFile(wb,"mzj-cars-inventory.xlsx"); showToast('تم تصدير الملف','ok');
  });

  /* الجديد: تصدير قالب فاضي (عناوين فقط) */
  btnExportBlank.addEventListener('click',()=>{
    const header=["م","سيارة","البيان","الوكيل","اللون الخارجي","اللون الداخلي","موديل","اللوحة","المكان","اسم الدفعة","رقم الهيكل","الملاحظات"];
    const ws=XLSX.utils.aoa_to_sheet([header]);
    ws['!cols']=[{wch:6},{wch:22},{wch:16},{wch:16},{wch:14},{wch:14},{wch:8},{wch:12},{wch:22},{wch:18},{wch:22},{wch:26}];
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Template");
    XLSX.writeFile(wb,"mzj-cars-template-blank.xlsx");
    showToast('تم تصدير القالب الفاضي','ok');
  });

  /* استيراد Excel */
  let importMode=null; const VIN_HEADERS=["رقم الهيكل","VIN","الشاص","رقم الشاص","Chassis","Chassis No","Chassis Number","الهيكل","نوع الهيكل"];

  // ===== Update-from-sheet helpers =====

  // ===== Update report state =====
  let __lastUpdateReport = null;

  function openModal(el){
    if(!el) return;
    el.classList.add('show');
    el.setAttribute('aria-hidden','false');
    el.style.display='flex';
    // force center
    el.style.alignItems='center';
    el.style.justifyContent='center';
    setTimeout(()=>{ const first = el.querySelector('input,select,textarea,button'); first?.focus(); }, 50);
  }
  function closeModalById(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.remove('show');
    el.setAttribute('aria-hidden','true');
    el.style.display='none';
  }

  function normalizeHeader(h){ return clean(h).toLowerCase(); }

  async function chooseUpdateFieldsFromHeader(header){
    const modal = document.getElementById('updateModal');
    const box   = document.getElementById('updateFieldsBox');
    const btn   = document.getElementById('confirmUpdateFields');
    const btnAll= document.getElementById('btnUpdateSelectAll');

    // Map Arabic column labels to record keys (match your export)
    const FIELDS = [
      {key:'car',       label:'سيارة'},
      {key:'variant',   label:'البيان'},
      {key:'dealer',    label:'الوكيل'},
      {key:'extColor',  label:'اللون الخارجي'},
      {key:'intColor',  label:'اللون الداخلي'},
      {key:'modelYear', label:'موديل'},
      {key:'plate',     label:'اللوحة'},
      {key:'location',  label:'المكان'},
      {key:'batchName', label:'اسم الدفعة'},
      {key:'notes',     label:'الملاحظات'}
    ];

    const present = FIELDS.filter(f => header.includes(f.label));
    box.innerHTML = present.map(f => `
      <label style="display:flex;gap:10px;align-items:center;border:1px solid var(--line);padding:10px 12px;border-radius:12px;background:#fff8ef">
        <input type="checkbox" checked data-key="${f.key}" style="width:18px;height:18px;accent-color: rgb(62,36,32);" />
        <span style="font-weight:800">${f.label}</span>
      </label>
    `).join('');

    btnAll.onclick = ()=> box.querySelectorAll('input[type="checkbox"]').forEach(c=> c.checked=true);

    return await new Promise((resolve, reject)=>{
      let done=false;

      const onClick=(e)=>{
        const isBackdrop = e.target === modal;
        const isCloseBtn = e.target.closest('[data-close="updateModal"]');
        if(isBackdrop || isCloseBtn){
          if(!done){ done=true; closeModalById('updateModal'); reject(new Error('تم إلغاء التحديث')); }
        }
      };

      modal.addEventListener('click', onClick, true);

      btn.onclick = ()=>{
        const selected=[...box.querySelectorAll('input[type="checkbox"]:checked')].map(x=>x.dataset.key);
        if(!selected.length){ showToast('اختر عمود واحد على الأقل للتحديث','info'); return; }
        done=true;
        modal.removeEventListener('click', onClick, true);
        closeModalById('updateModal');
        resolve(selected);
      };

      showToast('اختر أعمدة التحديث','info');
      openModal(modal);
    });
  }

  
  function applyUpdateFromSheet(rows, idxMap, idxVin, selectedKeys){
    const updated = [];
    const notFound = [];
    const skipped = [];

    // Build quick vin -> index map
    const map = new Map();
    stock.forEach((r, i)=>{
      const v = normalizeVin(r.vin||'');
      if(v) map.set(v, i);
    });

    for(let i=1;i<rows.length;i++){
      const row = rows[i];
      if(!row || row.length===0) continue;

      const rawVin = (idxVin!==-1 ? row[idxVin] : '') || '';
      const vin = normalizeVin(rawVin);
      if(!vin){ skipped.push(`#${i+1} VIN فارغ`); continue; }

      const recIdx = map.get(vin);
      if(recIdx === undefined){ notFound.push(vin); continue; }

      const rec = stock[recIdx];
      let changed = false;

      // update selected fields only if sheet cell not empty AND value is different
      selectedKeys.forEach(k=>{
        const col = idxMap[k];
        if(col === undefined || col === -1) return;
        const val = (row[col] ?? '').toString().trim();
        if(val === '') return; // don't overwrite with empty
        if(rec[k] !== val){
          rec[k] = val;
          changed = true;
        }
      });

      if(changed){
        stock[recIdx] = rec;
        updated.push(vin);
      }
    }

    return {updated, notFound, skipped};
  }

  btnImportMenu.addEventListener('click',()=>{importDropdown.style.display=importDropdown.style.display==='block'?'none':'block';});
  importDropdown.addEventListener('click',(e)=>{const btn=e.target.closest('button'); if(!btn) return; importMode=btn.getAttribute('data-mode'); importDropdown.style.display='none'; fileImport.click();});
  document.addEventListener('click',(e)=>{if(!e.target.closest('.import-menu')) importDropdown.style.display='none';});
  fileImport.addEventListener('change',(e)=>{
    const file=e.target.files[0]; if(!file) return; if(!importMode){showToast('اختر وضع الاستيراد أولًا','info'); fileImport.value=''; return;}
    const reader=new FileReader();
    reader.onload=async (evt)=>{
      try{
        const data=new Uint8Array(evt.target.result);
        const workbook=XLSX.read(data,{type:'array'}); const first=workbook.SheetNames[0]; const sheet=workbook.Sheets[first];
        const json=XLSX.utils.sheet_to_json(sheet,{header:1,defval:''});
        const header=json[0]||[]; const colIndex=name=>header.indexOf(name);

        const idxMap={
          id:colIndex("م"),car:colIndex("سيارة"),variant:colIndex("البيان"),dealer:colIndex("الوكيل"),
          extColor:colIndex("اللون الخارجي"),intColor:colIndex("اللون الداخلي"),
          modelYear:colIndex("موديل"), plate:colIndex("اللوحة"), location:colIndex("المكان"),
          batchName:colIndex("اسم الدفعة"), notes:colIndex("الملاحظات")
        };
        // Detect VIN column index
        let idxVin=-1;
        for(const h of VIN_HEADERS){
          const i=header.indexOf(h);
          if(i!==-1){ idxVin=i; break; }
        }


        
        // ===== Update mode: update existing cars only (by VIN) =====
        if(importMode==='update'){
          if(idxVin===-1) throw new Error('ملف التحديث لازم يحتوي عمود رقم الهيكل (VIN).');
if(idxVin===-1) throw new Error('ملف التحديث لازم يحتوي عمود رقم الهيكل (VIN).');
          const selectedKeys = await chooseUpdateFieldsFromHeader(header);
          // Map keys to column indexes in sheet
          const keyToCol = {
            car: idxMap.car,
            variant: idxMap.variant,
            dealer: idxMap.dealer,
            extColor: idxMap.extColor,
            intColor: idxMap.intColor,
            modelYear: idxMap.modelYear,
            plate: idxMap.plate,
            location: idxMap.location,
            batchName: idxMap.batchName,
            notes: idxMap.notes
          };
          const res = applyUpdateFromSheet(json, keyToCol, idxVin, selectedKeys);
          await persistAll();
          renderTable(); fillMoveLists(); updateRequirementBoxes();
          __lastUpdateReport = res;
          showToast(`✅ تم التحديث بنجاح — عدد الهياكل المُحدَّثة: ${res.updated.length}`,'ok');
          showUpdateReportButton();

          return;
        }

        const mustHave=["سيارة","البيان","الوكيل","اللون الخارجي","اللون الداخلي","موديل","اللوحة","المكان","اسم الدفعة","الملاحظات"];
        const missing = mustHave.filter(n=> colIndex(n)===-1);
        if(missing.length){ throw new Error('فشل الاستيراد — أعمدة ناقصة: '+missing.join(', ')); }

        const imported=[];
        for(let i=1;i<json.length;i++){
          const row=json[i]; if(!row || row.length===0) continue;
          const rawVin=(idxVin!==-1?row[idxVin]:'');
          imported.push({
            id:Number(row[idxMap.id])||null,
            car:row[idxMap.car]||'',
            variant:row[idxMap.variant]||'',
            dealer:row[idxMap.dealer]||'',
            extColor:row[idxMap.extColor]||'',
            intColor:row[idxMap.intColor]||'',
            modelYear:row[idxMap.modelYear]||'',
            plate:row[idxMap.plate]||'',
            location:row[idxMap.location]||'',
            batchName:row[idxMap.batchName]||'',
            notes:row[idxMap.notes]||'',
            vin:normalizeVin(rawVin)
          });
          const name=row[idxMap.car];
          if(name && !models.includes(name)){models.push(name); if(!variantsMap[name]) variantsMap[name]=[];}
        }
        if(importMode==='replace'){stock=[]; imported.forEach(r=>{r.id=nextId(); stock.push(r);});}
        else {imported.forEach(r=>{r.id=nextId(); stock.push(r);});}
        await persistAll(); loadModelsIntoSelects(); if(carSelect.value) populateVariants(carSelect.value);
        renderTable(); fillMoveLists(); updateRequirementBoxes();
        showToast(importMode==='replace'?'تم الاستبدال الكامل بالبيانات الجديدة':'تمت الإضافة إلى البيانات الحالية','ok');
      }catch(err){ showToast((err?.message)||'فشل الاستيراد — راجع تنسيق الملف','err'); }
      finally{ fileImport.value=''; importMode=null; }
    };
    reader.readAsArrayBuffer(file);
  });

  /* ===== حركة النقل — قوائم ثابتة ===== */
  const FIXED_LOCATIONS = [
    "المستودع : المخزون المتاح","المستودع : سيارات بها ملاحظات","المستودع : مباع تحت التسليم","المستودع : مباع تم التسليم",
    "الوكالة : المخزون المتاح","الوكالة : سيارات بها ملاحظات","الوكالة : مباع تحت التسليم","الوكالة : مباع تم التسليم",
    "فرع 1 الصالة : المخزون المتاح","فرع 1 الصالة : سيارات بها ملاحظات","فرع 1 الصالة : مباع تحت التسليم","فرع 1 الصالة : مباع تم التسليم",
    "فرع 2 الملتقى : المخزون المتاح","فرع 2 الملتقى : سيارات بها ملاحظات","فرع 2 الملتقى : مباع تحت التسليم","فرع 2 الملتقى : مباع تم التسليم",
    "فرع 3 القادسية : المخزون المتاح","فرع 3 القادسية : سيارات بها ملاحظات","فرع 3 القادسية : مباع تحت التسليم","فرع 3 القادسية : مباع تم التسليم"
  ];
  function fillMoveLists(){
    const opts = FIXED_LOCATIONS.map(l=> `<option value="${l}">${l}</option>`).join('');
    const fromSelects = moveRowsContainer ? moveRowsContainer.querySelectorAll('.move-from') : [];
    fromSelects.forEach(sel=> sel.innerHTML=opts);
    if(moveToGlobal) moveToGlobal.innerHTML = opts;
  }

  function fillMoveListsForRow(row){
    const opts = FIXED_LOCATIONS.map(l=> `<option value="${l}">${l}</option>`).join('');
    const fromSel = row.querySelector('.move-from');
    if(fromSel) fromSel.innerHTML = opts;
  }

  function renderCarDetails(rec){
    carDetails.innerHTML=`
      <div style="grid-column:1/-1"><b>سيارة:</b> ${rec.car??""}</div>
      <div><b>البيان:</b> ${rec.variant??""}</div>
      <div><b>الوكيل:</b> ${rec.dealer??""}</div>
      <div><b>اللون الخارجي:</b> ${rec.extColor??""}</div>
      <div><b>اللون الداخلي:</b> ${rec.intColor??""}</div>
      <div><b>موديل:</b> ${rec.modelYear??""}</div>
      <div><b>اللوحة:</b> ${rec.plate??""}</div>
      <div><b>المكان:</b> ${rec.location??""}</div>
      <div><b>اسم الدفعة:</b> ${rec.batchName??""}</div>
      <div style="grid-column:1/-1"><b>رقم الهيكل:</b> ${rec.vin??""}</div>
      <div style="grid-column:1/-1"><b>الملاحظات:</b> ${rec.notes??""}</div>`;
    carDetailsHint.textContent=rec.vin?`رقم الهيكل: ${rec.vin}`:'لا يوجد رقم هيكل محفوظ لهذه السيارة.';
    carDetailsBox.style.display='block';
  }

  function hideMoveAlert(){
    if(moveAlert){
      moveAlert.style.display='none';
      moveAlertList.innerHTML='';
    }
  }

  function showMoveAlert(type, title, lines){
    if(!moveAlert) return;
    moveAlert.className = 'move-alert ' + (type || 'info');
    moveAlertTitle.textContent = title || 'نتيجة حركة النقل';
    moveAlertList.innerHTML = '';
    (lines || []).forEach(txt=>{
      const li = document.createElement('li');
      li.textContent = txt;
      moveAlertList.appendChild(li);
    });
    moveAlert.style.display = 'flex';
  }

  /* اقتراح VIN حسب البادئة/الأرقام المكتوبة */
  function updateVinSuggestionsForPrefix(rawPrefix){
  if(!vinHints) return;
  const prefix = normalizeVin(rawPrefix||'');
  if(prefix.length < 1){
    vinHints.innerHTML = '';
    return;
  }
  const set = new Set();
  stock.forEach(r=>{
    const v = normalizeVin(r.vin||'');
    // 👇 عدّل السطر ده:
    // if(v && v.includes(prefix)) set.add(v); // يحتوي على الأرقام المكتوبة

    // ✅ خليه يبدأ بنفس اللي انت كاتبه (Prefix)
    if(v && v.startsWith(prefix)) set.add(v);
  });
  const list = Array.from(set).sort().slice(0,30);
  vinHints.innerHTML = list.map(v=>`<option value="${v}"></option>`).join('');
}



  /* اقتراح المكان "من" لكل سطر عند كتابة VIN */
  function autoFindByVinForRow(row, strictMessage=false){
    const inp = row.querySelector('.move-vin');
    const fromSel = row.querySelector('.move-from');
    const vinRaw = (inp.value||'').trim();
    if(!vinRaw){
      if(fromSel){
        fromSel.disabled=false;
        fromSel.value='';
      }
      const anyVin = moveRowsContainer.querySelectorAll('.move-vin');
      const hasAnyVin = Array.from(anyVin).some(i=> normalizeVin(i.value));
      if(!hasAnyVin){
        carDetailsBox.style.display='none';
        moveStatus.textContent='';
      }
      return;
    }
    const norm = normalizeVin(vinRaw);
    let match = stock.find(r => normalizeVin(r.vin) === norm);
    if(!match && norm.length >= 8){
      const candidates = stock.filter(r => normalizeVin(r.vin).startsWith(norm));
      if(candidates.length === 1) match = candidates[0];
    }
    if(match){
      renderCarDetails(match);
      const currentLoc = match.location || '';
      if(currentLoc && fromSel){
        fromSel.value = currentLoc;
        fromSel.disabled = true;
        moveStatus.textContent = `تم العثور: ${match.car} — المكان الحالي: ${currentLoc}`;
      }else if(fromSel){
        fromSel.disabled = false;
        moveStatus.textContent = `تم العثور: ${match.car} — لا يوجد مكان مسجل. اختر المكان يدويًا.`;
      }
    }else{
      if(strictMessage){
        const msg = 'لم يتم العثور على سيارة بهذا الرقم.';
        moveStatus.textContent = msg;
        carDetailsBox.style.display='none';
        showMoveAlert('error','لم يتم العثور على السيارة',[msg]);
      }else{
        moveStatus.textContent = '— لم يتم التعرف على السيارة بعد (أكمل رقم الهيكل).';
      }
    }
  }

  function attachMoveRowEvents(row){
    const inp = row.querySelector('.move-vin');
    if(!inp) return;
    inp.addEventListener('input', debounce(()=>{
      updateVinSuggestionsForPrefix(inp.value);
      autoFindByVinForRow(row,false);
    },150));
  }

  function createMoveRow(index){
    const row = document.createElement('div');
    row.className = 'move-row';
    row.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
        <div class="move-row-title">السيارة ${index}</div>
        <button type="button" class="btn btn-ghost" data-remove-move-row="1">مسح الحركة</button>
      </div>
      <div class="grid grid-3">
        <div>
          <label>رقم الهيكل</label>
          <input class="move-vin" list="vinHints" placeholder="اكتب رقم الهيكل"/>
        </div>
        <div>
          <label>من (محدّد تلقائيًا)</label>
          <select class="move-from"></select>
        </div>
        <div class="notes-col">
          <label>ملاحظات هذه السيارة</label>
          <textarea class="move-notes" placeholder="ملاحظات خاصة بهذا الهيكل (اختياري)"></textarea>
        </div>
      </div>`;
    fillMoveListsForRow(row);
    attachMoveRowEvents(row);
    return row;
  }

  function renumberMoveRows(){
    const rows = moveRowsContainer.querySelectorAll('.move-row');
    rows.forEach((row,idx)=>{
      const title = row.querySelector('.move-row-title');
      if(title) title.textContent = 'السيارة ' + (idx+1);
    });
  }

  function ensureAtLeastOneMoveRow(){
    if(!moveRowsContainer) return;
    const existing = moveRowsContainer.querySelectorAll('.move-row').length;
    if(existing === 0){
      const row = createMoveRow(1);
      moveRowsContainer.appendChild(row);
    }
    renumberMoveRows();
  }

  if(btnAddMoveRow){
    btnAddMoveRow.addEventListener('click', ()=>{
      const count = moveRowsContainer.querySelectorAll('.move-row').length;
      const row = createMoveRow(count+1);
      moveRowsContainer.appendChild(row);
      renumberMoveRows();
    });
  }

  
  // مسح صف حركة نقل واحد
  document.addEventListener('click',(e)=>{
    const btn = e.target.closest('[data-remove-move-row]');
    if(!btn) return;
    const row = btn.closest('.move-row');
    if(row){
      row.remove();
      renumberMoveRows();
    }
  });

// عرض البيانات لأول VIN غير فارغ
  btnFindByVin.addEventListener('click',()=>{
    const rows = Array.from(moveRowsContainer.querySelectorAll('.move-row'));
    const firstRow = rows.find(r=> normalizeVin((r.querySelector('.move-vin')?.value||'').trim()));
    if(!firstRow){
      const msg = 'اكتب رقم الهيكل في أي سطر أولًا.';
      moveStatus.textContent = msg;
      showMoveAlert('info','لا يوجد رقم هيكل',[msg]);
      return;
    }
    autoFindByVinForRow(firstRow,true);
  });

  function updateRequirementBoxes(){
    const val = (moveToGlobal?.value || '').trim();
    const anyIssues        = /سيارات بها ملاحظات/.test(val);
    if(underDeliveryBox){
      underDeliveryBox.style.display = 'none';
    }
  }

  if(moveToGlobal){
    moveToGlobal.addEventListener('change', updateRequirementBoxes);
  }

  // تنفيذ النقل المتعدد
  btnMove.addEventListener('click', async ()=>{
    hideMoveAlert();

    const dest = (moveToGlobal?.value || '').trim();
    if(!dest){
      const msg = 'اختر مكان "إلى" أولًا قبل تنفيذ النقل.';
      moveStatus.textContent = msg;
      showMoveAlert('info','مكان الوصول مطلوب',[msg]);
      showToast(msg,'info');
      return;
    }

    const rows = Array.from(moveRowsContainer.querySelectorAll('.move-row')).map(row=>({
      row,
      vinRaw:(row.querySelector('.move-vin')?.value||'').trim(),
      fromSel:row.querySelector('.move-from'),
      notesInput:row.querySelector('.move-notes')
    }));
    const rowsWithVin = rows.filter(r=> normalizeVin(r.vinRaw));

    if(!rowsWithVin.length){
      const msg = 'لم يتم إدخال أي رقم هيكل للنقل.';
      moveStatus.textContent = msg;
      showMoveAlert('info','لا توجد حركات نقل', [msg]);
      showToast(msg,'info');
      return;
    }

    const goingUnderDeliveryRow = /مباع تحت التسليم/.test(dest);
    const goingIssuesRow        = /سيارات بها ملاحظات/.test(dest);
    const goingDeliveredRow     = /مباع تم التسليم/.test(dest);

    let movedCount = 0;
    const errors = [];
    const successLines = [];

    
for (const rowData of rowsWithVin){
      const norm = normalizeVin(rowData.vinRaw);
      const recIdx = stock.findIndex(r => normalizeVin(r.vin) === norm);
      if(recIdx < 0){
        errors.push(`لم يتم العثور على سيارة بهذا VIN: ${rowData.vinRaw}`);
        continue;
      }
      const rec = stock[recIdx];
      const toVal = dest;
      const fromSel = rowData.fromSel;
      const from = (fromSel?.value || rec.location || '').trim();
      if(!from){
        errors.push(`السيارة ${rec.car||''} (${rec.vin||rowData.vinRaw}) لا يوجد لها مكان حالي؛ حدّد المكان يدويًا في "من".`);
        continue;
      }
      if(from === toVal){
        errors.push(`السيارة ${rec.car||''} (${rec.vin||rowData.vinRaw}) موجودة بالفعل في نفس المكان.`);
        continue;
      }

      const noteText = (rowData.notesInput?.value || '').trim();

      if(goingIssuesRow && !noteText){
        errors.push(`يجب كتابة ملاحظة للسيارة ${rec.car||''} (${rec.vin||rowData.vinRaw}) عند النقل إلى مكان "سيارات بها ملاحظات".`);
        continue;
      }

            // ميتاداتا أساسية للحركة / الطلب
      const moveMeta = {
        adminApproved: null,
        adminNotes: '',
        financeApproved: null,
        financeNotes: '',
        issuesNotes: noteText
      };

      const oldLoc = rec.location || from;

      // 🚚 منطق خاص بـ "مباع تحت التسليم"
      if (goingUnderDeliveryRow) {
        const stamp = now();

        // 1) ننقل السيارة فعليًا إلى مباع تحت التسليم
        rec.location = toVal;
        if ('place' in rec) {
          rec.place = toVal;
        }

        stock[recIdx] = rec;
        movedCount++;
        successLines.push(`تم نقل ${rec.car||''} (${rec.vin||rowData.vinRaw}) من "${oldLoc}" إلى "${toVal}".`);

        // نسجل حركة النقل إلى "مباع تحت التسليم"
        moves.push({
          when: stamp,
          date: onlyDate(stamp),
          vin: rec.vin || '',
          car: rec.car || '',
          from: oldLoc,
          to: toVal,
          id: rec.id,
          ...moveMeta,
          status: (moveMeta.status || 'under_delivery'),
          message: moveMeta.message || 'تم نقل السيارة إلى مباع تحت التسليم بانتظار الموافقات لنقلها إلى مباع تم التسليم'
        });

        // 2) ننشئ طلب نقل إلى "مباع تم التسليم" في نفس الفرع لصفحة الداش بورد
        const targetDelivered = toVal.replace('مباع تحت التسليم', 'مباع تم التسليم');

        moves.push({
          when: stamp,
          date: onlyDate(stamp),
          vin: rec.vin || '',
          car: rec.car || '',
          from: toVal,
          to: targetDelivered,
          id: rec.id,
          adminApproved: false,
          adminApproval: false,
          financeApproved: false,
          financeApproval: false,
          requiresAdminApproval: true,
          needsAdminApproval: true,
          requiresFinanceApproval: true,
          needsFinanceApproval: true,
          status: 'pending',
          message: 'طلب نقل إلى مباع تم التسليم من نفس الفرع (بانتظار موافقة الإدارة والمالية)'
        });

        // ننتقل مباشرة للعنصر التالي بدون تنفيذ منطق "مباع تم التسليم" أو الحركة العادية
        continue;
      }



      // 🚗 منطق خاص بـ "مباع تم التسليم"
      if (goingDeliveredRow) {
        const stamp = now();

        // يجب أن تكون السيارة أولًا في "مباع تحت التسليم" لنفس الفرع
        if (!/مباع تحت التسليم/.test(oldLoc)) {
          const errMsg = `لايمكن نقل السيارة ${rec.car || ''} (${rec.vin || rowData.vinRaw}) مباشرة إلى "مباع تم التسليم". يجب أن تمر أولًا على "مباع تحت التسليم" لنفس الفرع.`;
          errors.push(errMsg);
          continue;
        }

        // نبحث عن آخر طلب نقل إلى "مباع تم التسليم" لنفس الـ VIN
        const deliveredTarget = toVal;
        const relatedMoves = moves.filter(m =>
          normalizeVin(m.vin || '') === norm && (m.to || '') === deliveredTarget
        );
        const lastMove = relatedMoves.length ? relatedMoves[relatedMoves.length - 1] : null;

        if (!lastMove) {
          const errMsg = 'لايمكن نقل السيارة إلى "مباع تم التسليم" قبل إنشاء طلب موافقة من "مباع تحت التسليم".';
          errors.push(errMsg);
          continue;
        }

        const adminOk = !!(lastMove.adminApproved === true || lastMove.adminApproval === true);
        const financeOk = !!(lastMove.financeApproved === true || lastMove.financeApproval === true);

        if (!adminOk || !financeOk) {
          const errMsg = 'لايمكن نقل السيارة لعدم وجود موافقة مالية و موافقة ادارية';
          errors.push(errMsg);
          continue;
        }

        // ✅ موافقات مكتملة: نفّذ النقل فعليًا من هنا مباشرة
        rec.location = toVal;
        if ('place' in rec) {
          rec.place = toVal;
        }
        // نعلّم السيارة إنها تم تسليمها فعلاً
        rec.delivered   = true;
        rec.deliveredAt = stamp;

        moves.push({
          when: stamp,
          date: onlyDate(stamp),
          vin: rec.vin || '',
          car: rec.car || '',
          from: oldLoc,
          to: toVal,
          id: rec.id,
          adminApproved: true,
          adminApproval: true,
          financeApproved: true,
          financeApproval: true,
          requiresAdminApproval: false,
          requiresFinanceApproval: false,
          status: 'delivered',
          message: 'تم تنفيذ نقل السيارة إلى مباع تم التسليم بعد اكتمال الموافقات'
        });

        stock[recIdx] = rec;
        movedCount++;
        successLines.push(
          `تم نقل ${rec.car || ''} (${rowData.vinRaw}) إلى "${toVal}" بعد استكمال الموافقات المالية والإدارية.`
        );
        continue;
      }


      // الحركات العادية (نقل فعلي)
      rec.location = toVal;
      if (goingIssuesRow && noteText) {
        const existingNotes = rec.notes || '';
        rec.notes = existingNotes ? (existingNotes + " | " + noteText) : noteText;
      }
const stamp = now();
      moves.push({
        when: stamp,
        date: onlyDate(stamp),
        vin: rec.vin || '',
        car: rec.car || '',
        from: oldLoc,
        to: toVal,
        id: rec.id,
        ...moveMeta
      });
      movedCount++;
      successLines.push(`تم نقل ${rec.car||''} (${rec.vin||rowData.vinRaw}) من "${oldLoc}" إلى "${toVal}".`);
    }

if(!movedCount){
      const title = 'لم يتم تنفيذ أي حركة نقل';
      const lines = errors.length ? errors : ['لم يتم تنفيذ أي حركة نقل.'];
      moveStatus.textContent = title;
      showMoveAlert('error', title, lines);
      showToast(title,'info');
      return;
    }

    await persistAll();
    renderTable();
    renderMoves();
    renderTrack();

    const summary = `تم نقل ${movedCount} سيارة بنجاح.`;    
    moveStatus.textContent = summary;
    const allLines = [...successLines];
    if(errors.length){
      allLines.push('— ملاحظات على الحركات التي لم تُنفذ:');
      errors.forEach(e=> allLines.push(e));
    }
    showMoveAlert(errors.length ? 'info' : 'success', 'نتيجة حركة النقل', allLines);
    showToast(summary,'ok');

    carDetailsBox.style.display='none';

    // تفريغ الحقول
    const allRows = Array.from(moveRowsContainer.querySelectorAll('.move-row'));
    allRows.forEach(row=>{
      const vin = row.querySelector('.move-vin');
      const fromSel = row.querySelector('.move-from');
      const notes = row.querySelector('.move-notes');
      if(vin) vin.value='';
      if(fromSel){ fromSel.disabled=false; fromSel.value=''; }
      if(notes) notes.value='';
    });

    chkAdminApproved.checked=false; adminNotes.value='';
    chkFinanceApproved.checked=false; financeNotes.value='';
    if(vinHints) vinHints.innerHTML='';
  });

  /* ===== سجل الحركات (عرض + فلاتر التاريخ) ===== */
  /* ===== سجل الحركات (عرض + فلاتر التاريخ) ===== */
  function filterMovesByDate(list){
    const f = movesFromDate.value || null;
    const t = movesToDate.value || null;
    if(!f && !t) return list;
    return list.filter(m=>{
      const d = m.date || onlyDate(m.when||'');
      if(f && d < f) return false;
      if(t && d > t) return false;
      return true;
    });
  }

  function renderMoves(){
    movesTableBody.innerHTML='';
    let rows = moves.slice();
    rows = filterMovesByDate(rows);
    rows.forEach((m,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i+1}</td>
        <td class="nowrap">${m.date || onlyDate(m.when||'')}</td>
        <td class="nowrap"><span class="copyable" data-copy="${m.vin||''}">${m.vin||''}</span></td>
        <td>${m.car||''}</td>
        <td>${m.from||''}</td>
        <td>${m.to||''}</td>
        <td class="nowrap">${m.id||''}</td>`;
      movesTableBody.appendChild(tr);
    });
  }
  movesFromDate.addEventListener('change', renderMoves);
  movesToDate.addEventListener('change', renderMoves);
  btnClearDate.addEventListener('click', ()=>{movesFromDate.value=''; movesToDate.value=''; renderMoves();});

  /* ===== تتبّع VIN ===== */
  function renderTrack(){
    trackTableBody.innerHTML='';
    const v = normalizeVin((trackVin.value||'').trim());
    if(!v){ return; }
    const list = moves
      .filter(m=> normalizeVin(m.vin||'').startsWith(v) )
      .sort((a,b)=> (a.when||'').localeCompare(b.when||''));
    list.forEach((m,i)=>{
      const notesParts = [];
      if(m.adminApproved===true) notesParts.push('✔ موافقة إدارية');
      if(m.adminApproved===false) notesParts.push('✖ موافقة إدارية');
      if(m.adminNotes) notesParts.push('إداري: '+m.adminNotes);
      if(m.financeApproved===true) notesParts.push('✔ موافقة مالية');
      if(m.financeApproved===false) notesParts.push('✖ موافقة مالية');
      if(m.financeNotes) notesParts.push('مالي: '+m.financeNotes);
      if(m.issuesNotes) notesParts.push('ملاحظات: '+m.issuesNotes);

      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i+1}</td>
        <td class="nowrap">${m.date || onlyDate(m.when||'')}</td>
        <td>${m.from||''}</td>
        <td>${m.to||''}</td>
        <td>${m.car||''}</td>
        <td>${notesParts.join(' — ')||''}</td>`;
      trackTableBody.appendChild(tr);
    });
  }
  trackVin.addEventListener('input', debounce(()=>{ updateVinSuggestionsForPrefix(trackVin.value); renderTrack(); }, 200));
  btnClearTrack.addEventListener('click', ()=>{ trackVin.value=''; renderTrack(); });

  /* Modals helpers */
  function openModalLegacy(el){ el.style.display='flex'; setTimeout(()=>{ const first = el.querySelector('input,select,textarea,button'); first?.focus(); }, 50); }
  function closeModalByIdLegacy(id){ const el = document.getElementById(id); if(el) el.style.display='none'; }
  document.addEventListener('click',(e)=>{
    const closeBtn = e.target.closest('[data-close]');
    if(closeBtn){ closeModalById(closeBtn.getAttribute('data-close')); }
    if(e.target.classList.contains('modal-backdrop')){ e.target.style.display='none'; }
  });
  document.addEventListener('keydown',(e)=>{
    if(e.key==='/'){e.preventDefault(); searchInput.focus();}
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){e.preventDefault(); btnSave.click();}
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){e.preventDefault(); btnAddVariant.click();}
    if(e.key==='Escape'){modelModal.style.display='none'; variantModal.style.display='none'; btnReset.click();}
  });

  /* أول تحميل */
  setStatus('warn','جارِ الاتصال…');

  /* إغلاق قائمة الاستيراد عند النقر خارجها */
  document.addEventListener('click',(e)=>{
    if(!e.target.closest('.import-menu')) importDropdown.style.display='none';
  });

  // تبويبات داخلية للصفحة
  const innerTabs = Array.from(document.querySelectorAll('.inner-tab'));
  const innerPanels = Array.from(document.querySelectorAll('.inner-tab-panel'));
  innerTabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      innerTabs.forEach(b=> b.classList.remove('active'));
      innerPanels.forEach(p=> p.classList.remove('active'));
      btn.classList.add('active');
      const targetId = btn.getAttribute('data-target');
      const panel = document.getElementById(targetId);
      if(panel) panel.classList.add('active');
    });
  });

  // تهيئة نموذج حركة النقل
  fillMoveLists();
  ensureAtLeastOneMoveRow();
  updateRequirementBoxes();

  // إظهار/إخفاء ملاحظات كل سيارة حسب مكان (إلى)
  function toggleNotesVisibility(){
    const dest = (moveToGlobal?.value || '').trim();
    const show = /سيارات بها ملاحظات/.test(dest);
    const notesCols = document.querySelectorAll('.notes-col');
    notesCols.forEach(col=>{
      col.style.display = show ? 'block' : 'none';
    });
  }
  if(moveToGlobal){
    moveToGlobal.addEventListener('change', toggleNotesVisibility);
    toggleNotesVisibility();
  }

  
  function showUpdateReportButton(){
    let btn = document.getElementById('btnUpdateReport');
    if(!btn){
      btn = document.createElement('button');
      btn.id = 'btnUpdateReport';
      btn.className = 'btn btn-soft';
      btn.style.marginTop = '8px';
      btn.innerHTML = '<i class="fa-solid fa-file-lines"></i> عرض تقرير التحديث';
      btn.onclick = openUpdateReport;
      document.querySelector('.toast-wrap')?.appendChild(btn);
    }
  }

  function openUpdateReport(){
    if(!__lastUpdateReport){ showToast('لا يوجد تقرير متاح','info'); return; }
    const rows = [];
    __lastUpdateReport.updated.forEach(v=> rows.push({VIN:v, Status:'Updated'}));
    __lastUpdateReport.notFound.forEach(v=> rows.push({VIN:v, Status:'Not Found'}));
    __lastUpdateReport.skipped.forEach(v=> rows.push({VIN:v, Status:'Skipped'}));

    // build CSV
    let csv = 'VIN,Status\n';
    rows.forEach(r=>{ csv += `"${r.VIN}","${r.Status}"\n`; });

    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'update_report.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

</script>
</div>  <script src="./mzj-ui.js">
  function showUpdateReportButton(){
    let btn = document.getElementById('btnUpdateReport');
    if(!btn){
      btn = document.createElement('button');
      btn.id = 'btnUpdateReport';
      btn.className = 'btn btn-soft';
      btn.style.marginTop = '8px';
      btn.innerHTML = '<i class="fa-solid fa-file-lines"></i> عرض تقرير التحديث';
      btn.onclick = openUpdateReport;
      document.querySelector('.toast-wrap')?.appendChild(btn);
    }
  }

  function openUpdateReport(){
    if(!__lastUpdateReport){ showToast('لا يوجد تقرير متاح','info'); return; }
    const rows = [];
    __lastUpdateReport.updated.forEach(v=> rows.push({VIN:v, Status:'Updated'}));
    __lastUpdateReport.notFound.forEach(v=> rows.push({VIN:v, Status:'Not Found'}));
    __lastUpdateReport.skipped.forEach(v=> rows.push({VIN:v, Status:'Skipped'}));

    // build CSV
    let csv = 'VIN,Status\n';
    rows.forEach(r=>{ csv += `"${r.VIN}","${r.Status}"\n`; });

    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'update_report.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

</script>

    </div>
  
</main>
<nav class="mzj-downbar" aria-label="التنقل">
    <div class="inner">
<a href="m.sales.html">💼<span>تتبع المبيعات</span></a>
<a href="m.dashboard.html">📊<span>الداش بورد</span></a>
<a href="m.inventory.html">📦<span>المخزون</span></a>
<a href="m.vt.html">↔️<span>نقل السيارات</span></a>
<a href="m.photoshoot-user.html">📷<span>إدارة الطلبات</span></a>

<a href="m.cars.html">🚗<span>كل السيارات</span></a>
<a class="active" href="m.admin.html">🏠<span>الإدارة</span></a>
<a href="m.Activity.html">🕘<span>سجل النشاط</span></a>
<a href="m.act.html">🧾<span>سجل الحركات</span></a>
</div>
  </nav>
</div>

<script>

(function(){
  function normalizeText(t){ return (t||"").replace(/\s+/g,' ').trim(); }

  // Build the tabs grid from existing buttons/links by label text
  const wanted = [
    "إضافة سيارة",
    "نقل السيارات",
    "تعديل السيارات",
    "تتبع حركة رقم هيكل",
    "سجل الحركات"
  ];

  function findClickable(label){
    const els = Array.from(document.querySelectorAll('button, a, div[role="button"], span[role="button"]'));
    return els.find(el => normalizeText(el.textContent) === label) || null;
  }

  const found = wanted.map(findClickable).filter(Boolean);
  if(found.length >= 3){
    const first = found[0];
    const wrap = document.createElement('div');
    wrap.className = 'admin-tabs';
    first.parentNode.insertBefore(wrap, first);

    found.forEach((el, idx) => {
      // ensure button
      let btn = el;
      if(btn.tagName.toLowerCase() !== 'button'){
        const b = document.createElement('button');
        b.type = 'button';
        b.innerHTML = btn.innerHTML || btn.textContent;
        // preserve click behavior by triggering original
        b.addEventListener('click', (e)=>{ e.preventDefault(); btn.click(); });
        btn = b;
      }
      btn.classList.add('tab-btn');
      // active detection
      if(el.classList.contains('active') || el.getAttribute('aria-selected')==='true'){ btn.classList.add('active'); }
      wrap.appendChild(btn);

      btn.addEventListener('click', ()=>{
        wrap.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
        btn.classList.add('active');
      });
    });

    // remove originals if they were not buttons we moved
    found.forEach(el=>{
      if(el !== null && el.parentNode && el.parentNode !== wrap){
        // if we created a proxy button, keep original hidden
        if(el.tagName.toLowerCase() !== 'button'){
          el.style.display='none';
        }else{
          // moved already
        }
      }
    });

    // default active if none
    if(!wrap.querySelector('.tab-btn.active')) wrap.querySelector('.tab-btn')?.classList.add('active');
  }

  // Make tables stackable by adding data-label from thead
  const tables = Array.from(document.querySelectorAll('table'));
  tables.forEach(tbl=>{
    try{
      const ths = Array.from(tbl.querySelectorAll('thead th')).map(th=>normalizeText(th.textContent));
      if(!ths.length) return;
      tbl.classList.add('mzj-enhanced-table');
      const rows = Array.from(tbl.querySelectorAll('tbody tr'));
      rows.forEach(tr=>{
        const tds = Array.from(tr.children).filter(x=>x.tagName && x.tagName.toLowerCase()==='td');
        tds.forEach((td,i)=>{
          if(!td.getAttribute('data-label')) td.setAttribute('data-label', ths[i] || `عمود ${i+1}`);
        });
      });
      // wrap table once
      if(!tbl.closest('.mzj-table-stack')){
        const w = document.createElement('div');
        w.className = 'mzj-table-stack';
        tbl.parentNode.insertBefore(w, tbl);
        w.appendChild(tbl);
      }
    }catch(e){}
  });
})();


</script>

<style id="mzj-mobile-final-override">
/* === MZJ FINAL OVERRIDE (wins last) === */

/* Tabs: compact 3 + 2 */
.inner-tabs{
  display:grid !important;
  grid-template-columns: repeat(3, minmax(0,1fr)) !important;
  gap:8px !important;
  margin: 10px 0 14px !important;
  width:100% !important;
}
.inner-tabs .inner-tab{
  width:100% !important;
  height:36px !important;
  min-height:36px !important;
  max-height:36px !important;
  padding:6px 6px !important;
  border-radius:14px !important;
  font-size:11px !important;
  font-weight:800 !important;
  line-height:1 !important;
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  white-space:nowrap !important;
  overflow:hidden !important;
  text-overflow:ellipsis !important;
}
.inner-tabs .inner-tab:nth-child(4){ grid-column:1 / 3 !important; }
.inner-tabs .inner-tab:nth-child(5){ grid-column:3 / 4 !important; }

/* Downbar: 5 in first row + rest second row (very compact) */
.mzj-main{ padding-bottom: calc(86px + var(--safe-bottom)) !important; }
.mzj-downbar{
  height: calc(72px + var(--safe-bottom)) !important;
}
.mzj-downbar .inner{
  height:72px !important;
  display:grid !important;
  grid-template-columns: repeat(5, minmax(0,1fr)) !important;
  grid-auto-rows: 1fr !important;
  gap:4px !important;
  padding:6px 6px !important;
}
.mzj-downbar a{
  border-radius:12px !important;
  padding:4px 2px !important;
  gap:2px !important;
  display:flex !important;
  flex-direction:column !important;
  align-items:center !important;
  justify-content:center !important;
  font-size:14px !important; /* emoji */
}
.mzj-downbar a span{
  font-size:9px !important;
  font-weight:800 !important;
  line-height:1 !important;
  white-space:nowrap !important;
  overflow:hidden !important;
  text-overflow:ellipsis !important;
  max-width:100% !important;
}

/* remove callouts */
.inner-tab, .mzj-downbar a{
  -webkit-touch-callout:none !important;
  -webkit-user-select:none !important;
  user-select:none !important;
  -webkit-tap-highlight-color: transparent !important;
}
</style>


<script>
(function(){
  const sel = document.getElementById('mzjActionSelect');
  if(!sel) return;

  function clickTab(target){
    const btn = document.querySelector('.inner-tab[data-target="'+target+'"]');
    if(btn) btn.click();
  }

  // On change
  sel.addEventListener('change', (e)=>{ clickTab(sel.value); });

  // If page script sets active tab later, keep select synced
  const obs = new MutationObserver(()=>{
    const active = document.querySelector('.inner-tab.active');
    if(active){
      const t = active.getAttribute('data-target');
      if(t && sel.value !== t) sel.value = t;
    }
  });
  obs.observe(document.documentElement, {subtree:true, attributes:true, attributeFilter:['class']});

  // Initial sync
  const active = document.querySelector('.inner-tab.active');
  if(active){
    const t = active.getAttribute('data-target');
    if(t) sel.value = t;
  }
})();
</script>


<script>
(function(){
  const sel = document.getElementById('mzjActionSelect');
  if(!sel) return;
  function clickTab(target){
    const btn = document.querySelector('.mzj-hidden-tabs .inner-tab[data-target="'+target+'"]');
    if(btn) btn.click();
  }
  sel.addEventListener('change', ()=> clickTab(sel.value));
  // initial
  clickTab(sel.value);
})();
</script>

<style>

/* === Hide legacy tabs (dropdown only) === */
.inner-tabs, .admin-tabs, .tab-row, .tabs, .tabs-row, .quick-tabs, .top-tabs, .action-tabs,
button.inner-tab, .inner-tab { 
  display:none !important; 
}


/* === Downbar: 2 rows visible (5 top + rest bottom) === */
:root{
  --mzj-downbar-h: 104px; /* enough for 2 rows */
}
.mzj-main{ padding-bottom: calc(var(--mzj-downbar-h) + env(safe-area-inset-bottom, 0px) + 12px) !important; }

.mzj-downbar{
  position:fixed !important;
  left:0 !important;
  right:0 !important;
  bottom: env(safe-area-inset-bottom, 0px) !important;
  height: var(--mzj-downbar-h) !important;
}
.mzj-downbar .inner{
  height: var(--mzj-downbar-h) !important;
  display:grid !important;
  grid-template-columns: repeat(5, minmax(0, 1fr)) !important;
  grid-auto-rows: 1fr !important;
  gap:6px !important;
  padding:10px 10px !important;
}
.mzj-downbar a{
  display:flex !important;
  flex-direction:column !important;
  align-items:center !important;
  justify-content:center !important;
  gap:4px !important;
  padding:8px 4px !important;
  border-radius:14px !important;
}
.mzj-downbar a span{
  font-size:10px !important;
  font-weight:900 !important;
  line-height:1.05 !important;
  white-space:nowrap !important;
  overflow:hidden !important;
  text-overflow:ellipsis !important;
  max-width:100%;
}
/* shrink icon sizes (emojis already small), and ensure consistent */
.mzj-downbar a{ font-size:16px !important; }

/* support dynamic viewport */
html, body{ min-height: 100dvh; }


/* === Downbar Lift فوق شوية لتفادي Address Bar (iOS/Android) === */
:root{ --mzj-downbar-lift: 18px; } /* ارفع/انزل بسهولة */

.mzj-downbar{
  bottom: calc(env(safe-area-inset-bottom, 0px) + var(--mzj-downbar-lift)) !important;
}

.mzj-main{
  padding-bottom: calc(var(--mzj-downbar-h) + env(safe-area-inset-bottom, 0px) + var(--mzj-downbar-lift) + 16px) !important;
}

</style>
<style>
/* ===== FINAL MOBILE DOWNBAR FIX (2 ROWS VISIBLE) ===== */
:root{
  --mzj-downbar-h: 138px;      /* أعلى عشان الصف التاني يبان */
  --mzj-downbar-lift: 14px;    /* تعويض شريط العنوان */
}

.mzj-main, main.mzj-content, .mzj-content, .container, .wrap{
  padding-bottom: calc(var(--mzj-downbar-h) + env(safe-area-inset-bottom, 0px) + var(--mzj-downbar-lift) + 18px) !important;
}

.mzj-downbar{
  position: fixed !important;
  left: 0 !important;
  right: 0 !important;
  bottom: calc(env(safe-area-inset-bottom, 0px) + var(--mzj-downbar-lift)) !important;
  height: var(--mzj-downbar-h) !important;
  z-index: 9999 !important;
  overflow: visible !important;
}

.mzj-downbar .inner{
  height: var(--mzj-downbar-h) !important;
  display: grid !important;              /* يغلب أي flex */
  grid-template-columns: repeat(5, minmax(0, 1fr)) !important;
  grid-auto-flow: row !important;
  grid-auto-rows: 1fr !important;
  align-content: stretch !important;
  gap: 6px !important;
  padding: 10px 10px 12px !important;
}

.mzj-downbar a{
  display:flex !important;
  flex-direction:column !important;
  align-items:center !important;
  justify-content:center !important;
  gap: 4px !important;
  padding: 8px 4px !important;
  border-radius: 14px !important;
  text-decoration:none !important;
  font-size: 17px !important;            /* حجم الايموجي */
}

.mzj-downbar a span{
  font-size: 9px !important;
  font-weight: 900 !important;
  line-height: 1.15 !important;
  text-align:center !important;
  white-space: normal !important;
  overflow: hidden !important;
  display: -webkit-box !important;
  -webkit-line-clamp: 2 !important;
  -webkit-box-orient: vertical !important;
  max-width: 100% !important;
}
</style>
</body>
</html>


