
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MZJ | سجل النشاط</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <link rel="stylesheet" href="./mzj-ui.css"/>

  <style>
    html.auth-pending body{opacity:0; pointer-events:none;}
    .mzj-table td{vertical-align:top;}
    .subtle{font-size:12px; color:var(--muted);}
    .inline-actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .warnbox{border:1px solid rgba(245,158,11,.25); background: rgba(245,158,11,.08); padding:12px; border-radius:14px; margin-top:10px;}
    .hide{display:none!important;}
    .file-warn{max-width:820px;margin:40px auto;padding:18px;border-radius:16px;border:1px solid rgba(239,68,68,.25);background:rgba(239,68,68,.06);font-family:Tajawal;text-align:center}
    .file-warn code{direction:ltr;unicode-bidi:bidi-override;background:rgba(0,0,0,.06);padding:2px 6px;border-radius:8px}
    .file-warn .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;margin-top:12px;padding:10px 14px;border-radius:12px;border:1px solid rgba(0,0,0,.12);background:#fff;cursor:pointer}
  </style>
</head>

<body class="mzj auth-pending">
  <!-- Topbar -->
  <div class="mzj-topbar">
    <div class="topbar-left">
      <button id="mzjSidebarBtn" class="icon-btn" title="القائمة"><i class="fa-solid fa-bars"></i></button>
      <div class="brand">
        <div class="brand-mark">MZJ</div>
        <div>
          <div class="brand-title">Workspace</div>
          <div class="brand-sub">سجل النشاط</div>
        </div>
      </div>
    </div>

    <div class="topbar-center">
      <div id="mzjNow" class="mzj-chip"><i class="fa-regular fa-clock"></i><span>—</span></div>
    </div>

    <div class="topbar-right">
      <button id="mzjThemeBtn" class="icon-btn" title="الوضع الليلي"><i class="fa-solid fa-moon"></i></button>
      <div class="mzj-user">
        <div class="avatar" id="userAvatar">—</div>
        <div>
          <div class="user-name" id="userName">—</div>
          <div class="user-role" id="userRole">—</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Shell -->
  <div id="mzjShell" class="mzj-shell">
    <aside id="mzjSidebar" class="mzj-sidebar">
      <div class="side-section">
        <div class="side-title">التنقل</div>
        <nav class="side-nav">
          <a class="side-link active" href="./Activity.html"><i class="fa-solid fa-clock-rotate-left"></i>سجل النشاط</a>
          <a class="side-link" href="./dashboard.html"><i class="fa-solid fa-gauge"></i>الداش بورد</a>
          <a class="side-link" href="./orders.html"><i class="fa-solid fa-list-check"></i>الطلبات</a>
          <a class="side-link" href="./inventory.html"><i class="fa-solid fa-warehouse"></i>المخزون</a>
        </nav>
      </div>
    </aside>

    <div id="mzjBackdrop" class="mzj-backdrop"></div>

    <main class="mzj-content">
      <div class="mzj-pagehead">
        <div>
          <h1 class="page-title">سجل النشاط</h1>
          <p class="page-desc">عرض مباشر من <b>mzj_activity_log</b> + تسجيل تلقائي لأي تغييرات جديدة في <b>requests</b> (نقل/تصوير) و <b>cars</b> أثناء فتح الصفحة.</p>
        </div>
        <div class="pagehead-right inline-actions">
          <button id="btnBackfill" class="mzj-btn mzj-btn-soft" type="button">
            <i class="fa-solid fa-rotate"></i> بناء سجل الطلبات الحالية
          </button>
          <button id="btnClearLocal" class="mzj-btn mzj-btn-ghost" type="button">
            <i class="fa-solid fa-broom"></i> مسح كاش الجلسة
          </button>
        </div>
      </div>

      <section class="mzj-card">
        <div class="card-head">
          <div class="card-title">آخر الحركات</div>
          <div class="card-sub">التسلسل 1, 2, 3 … حسب الأحدث</div>
        </div>
        <div class="card-body">
          <div id="permWarn" class="warnbox hide">
            <div style="display:flex;gap:10px;align-items:center">
              <i class="fa-solid fa-triangle-exclamation"></i>
              <b>ملاحظة صلاحيات:</b>
            </div>
            <div class="subtle" style="margin-top:6px">
              لا يوجد إذن للكتابة داخل <b>mzj_activity_log</b>. السجل سيعرض الموجود فقط ولن يسجل Mirroring.
            </div>
          </div>

          <div class="mzj-table-wrap" style="margin-top:12px">
            <table class="mzj-table" id="tblActivity">
              <thead>
                <tr>
                  <th style="width:64px">#</th>
                  <th style="width:170px">التاريخ</th>
                  <th style="width:240px">العضو</th>
                  <th style="width:170px">الدور</th>
                  <th style="width:200px">نوع الحركة</th>
                  <th>التفاصيل</th>
                </tr>
              </thead>
              <tbody id="activityRows">
                <tr><td colspan="6" class="subtle">جارِ التحميل…</td></tr>
              </tbody>
            </table>
          </div>

          <div class="mzj-footer">
            <span id="rowsCount">0</span> <span>سجل</span>
            <span class="sep">•</span>
            <span class="subtle">المصدر: mzj_activity_log</span>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="./mzj-ui.js"></script>

  <script type="module">
    // ⚠️ Firebase Auth غالبًا لا يعمل من file://
    if (location.protocol === "file:") {
      document.documentElement.classList.remove("auth-pending");
      document.body.innerHTML = `
        <div class="file-warn">
          <div style="font-size:18px;font-weight:800;margin-bottom:6px">لا تشغّل الصفحة من Downloads (file://)</div>
          <div class="subtle">
            لازم تفتحها من <b>HTTP</b> (localhost أو على نفس دومين النظام) عشان Firebase Auth يشتغل.
          </div>
          <div class="subtle" style="margin-top:10px;line-height:1.9">
            شغّل سيرفر محلي:
            <div style="margin-top:6px"><code>python -m http.server 5500</code></div>
            وبعدها افتح:
            <div style="margin-top:6px"><code>http://localhost:5500/Activity.html</code></div>
            ولازم تضيف <b>localhost</b> في Authorized domains داخل Firebase Auth.
          </div>
          <button class="btn" onclick="navigator.clipboard.writeText('python -m http.server 5500')">
            <i class="fa-regular fa-copy"></i> نسخ أمر السيرفر
          </button>
        </div>
      `;
      throw new Error("Opened via file://");
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy, limit, onSnapshot,
      addDoc, serverTimestamp, getDocs, doc, getDoc, setDoc, where
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=> document.getElementById(id);
    const safe = (v)=> (v===null || v===undefined) ? "" : String(v);

    function normalizeRole(r){
      r = (r||"").toString().trim().toLowerCase();
      if (["admin","administrator","مدير","المدير","أدمن","ادمن","الإدارة","الادارة","إدارة","اداره"].includes(r)) return "الإدارة";
      if (["sales","مبيعات","مندوب"].includes(r)) return "المبيعات";
      return r || "";
    }

    async function fetchUserRole(user){
      try{
        const snap = await getDoc(doc(db,"user", user.uid));
        if (snap.exists()) return normalizeRole(snap.data()?.role);
      }catch(_){}

      try{
        const q = query(collection(db,"user"), where("email","==",(user.email||"").toLowerCase()));
        const res = await getDocs(q);
        if (!res.empty) return normalizeRole(res.docs[0].data()?.role);
      }catch(_){}

      return "";
    }

    function setUserUI(user, role){
      const nm = user?.displayName || user?.email || "—";
      $("userName").textContent = nm;
      $("userRole").textContent = role || "—";
      $("userAvatar").textContent = (nm||"").trim().slice(0,1).toUpperCase() || "—";
    }

    function deny(msg){
      document.documentElement.classList.remove("auth-pending");
      document.body.innerHTML = `<div style="padding:24px;font-family:Tajawal;text-align:center">${msg||"لا تملك صلاحية الوصول لهذه الصفحة"}</div>`;
    }

    let myRole = "";
    onAuthStateChanged(auth, async (user)=>{
      try{
        if (!user) return deny("غير مسجّل دخول.");
        myRole = await fetchUserRole(user);
        setUserUI(user, myRole);

        const email = (user.email||"").toLowerCase();
        const ok = (myRole === "الإدارة") || email.includes("admin");
        if (!ok) return deny("لا تملك صلاحية الوصول لهذه الصفحة");

        document.documentElement.classList.remove("auth-pending");

        startActivityStream();
        startMirroring();

      }catch(e){
        console.error(e);
        deny("حدث خطأ في التحقق من الصلاحيات.");
      }
    });

    // ===== عرض mzj_activity_log =====
    function startActivityStream(){
      const rowsEl = $("activityRows");
      const countEl = $("rowsCount");
      const q = query(collection(db,"mzj_activity_log"), orderBy("ts","desc"), limit(250));

      onSnapshot(q, (snap)=>{
        rowsEl.innerHTML = "";
        let i = 0;
        snap.forEach((docSnap)=>{
          const d = docSnap.data() || {};
          const member = (safe(d.userName) || "—") + (d.userEmail ? `<div class="subtle">${safe(d.userEmail)}</div>` : "");
          rowsEl.insertAdjacentHTML("beforeend", `
            <tr>
              <td>${++i}</td>
              <td>${safe(d.createdAt)||"—"}</td>
              <td>${member}</td>
              <td>${safe(d.role)||"—"}</td>
              <td>${safe(d.action)||"—"}</td>
              <td>${safe(d.details)||"—"}</td>
            </tr>
          `);
        });
        if (!i) rowsEl.innerHTML = `<tr><td colspan="6" class="subtle">لا يوجد سجلات بعد.</td></tr>`;
        countEl.textContent = String(i);
      }, (err)=>{
        console.error(err);
        rowsEl.innerHTML = `<tr><td colspan="6" class="subtle">تعذّر تحميل سجل النشاط.</td></tr>`;
      });
    }

    // ===== Mirroring (requests + cars) =====
    const handled = new Set(JSON.parse(sessionStorage.getItem("mzj_activity_handled")||"[]"));
    function persistHandled(){
      try{ sessionStorage.setItem("mzj_activity_handled", JSON.stringify([...handled].slice(-4000))); }catch(_){}
    }

    $("btnClearLocal").addEventListener("click", ()=>{
      handled.clear();
      sessionStorage.removeItem("mzj_activity_handled");
      alert("تم مسح كاش الجلسة.");
    });

    async function canWriteLog(){
      try{
        const testRef = doc(collection(db,"mzj_activity_log"));
        await setDoc(testRef, { action:"_perm_test", ts: Date.now(), createdAt: new Date().toISOString().slice(0,19).replace("T"," ") });
        return true;
      }catch(e){
        console.warn("No write access to mzj_activity_log", e);
        $("permWarn").classList.remove("hide");
        return false;
      }
    }

    function sigOf(kind, id, ts){ return `${kind}:${id}:${ts||0}`; }

    async function writeLogFromRequest(changeType, id, d){
      const ts = (d.updatedAt?.seconds || d.createdAt?.seconds || d.updatedAtTs || d.createdAtTs || Date.now());
      const sig = sigOf("req", id, ts);
      if (handled.has(sig)) return;
      handled.add(sig); persistHandled();

      const kind = (d.kind || "").toLowerCase();
      const entityType = (kind === "move") ? "move_request" : (kind === "shoot" ? "photoshoot_request" : "request");
      const action = (changeType === "added") ? "إنشاء طلب" : "تعديل طلب";
      const details = [
        d.status ? `الحالة: ${d.status}` : "",
        (d.total!=null) ? `عدد: ${d.total}` : ""
      ].filter(Boolean).join(" | ") || "—";

      await addDoc(collection(db,"mzj_activity_log"), {
        action,
        entityType,
        entityId: id,
        details,
        userEmail: d.createdByEmail || d.updatedByEmail || "",
        userName: d.createdByName || d.updatedByName || "",
        role: normalizeRole(d.createdByRole || d.updatedByRole || myRole || ""),
        uid: d.createdByUid || d.updatedByUid || "",
        page: "requests",
        createdAt: new Date().toISOString().replace("T"," ").slice(0,19),
        ts: Date.now(),
        serverTs: serverTimestamp()
      });
    }

    async function writeLogFromCar(changeType, id, d){
      const ts = (d.updatedAt?.seconds || d.updatedAtTs || Date.now());
      const sig = sigOf("car", id, ts);
      if (handled.has(sig)) return;
      handled.add(sig); persistHandled();

      const action = (changeType === "added") ? "إضافة سيارة" : (changeType === "removed" ? "حذف سيارة" : "تعديل سيارة");

      await addDoc(collection(db,"mzj_activity_log"), {
        action,
        entityType: "car",
        entityId: id,
        details: "تم تعديل بيانات السيارة",
        userEmail: d.updatedByEmail || d.createdByEmail || "",
        userName: d.updatedByName || d.createdByName || "",
        role: normalizeRole(d.updatedByRole || d.createdByRole || myRole || ""),
        uid: d.updatedByUid || d.createdByUid || "",
        page: "cars",
        createdAt: new Date().toISOString().replace("T"," ").slice(0,19),
        ts: Date.now(),
        serverTs: serverTimestamp()
      });
    }

    let mirroringStarted = false;
    async function startMirroring(){
      if (mirroringStarted) return;
      mirroringStarted = true;

      const okWrite = await canWriteLog();
      if (!okWrite) return;

      // يسجل الجديد فقط بعد أول snapshot
      let skipInitialRequests = true;
      onSnapshot(collection(db,"requests"), async (snap)=>{
        if (skipInitialRequests){ skipInitialRequests=false; return; }
        for (const ch of snap.docChanges()) {
          if (ch.type !== "added" && ch.type !== "modified") continue;
          await writeLogFromRequest(ch.type, ch.doc.id, ch.doc.data()||{});
        }
      });

      let skipInitialCars = true;
      onSnapshot(collection(db,"cars"), async (snap)=>{
        if (skipInitialCars){ skipInitialCars=false; return; }
        for (const ch of snap.docChanges()) {
          if (!["added","modified","removed"].includes(ch.type)) continue;
          await writeLogFromCar(ch.type, ch.doc.id, ch.doc.data()||{});
        }
      });
    }

    // Backfill: يبني log من الطلبات الحالية (move/shoot)
    $("btnBackfill").addEventListener("click", async ()=>{
      const okWrite = await canWriteLog();
      if (!okWrite) return;

      const sure = confirm("هيتم إنشاء سجلات في mzj_activity_log لكل طلبات النقل/التصوير الحالية داخل requests (بدون تكرار). نكمل؟");
      if (!sure) return;

      $("btnBackfill").disabled = true;
      $("btnBackfill").innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> جاري البناء…";

      try{
        const snap = await getDocs(collection(db,"requests"));
        let n = 0;
        for (const docSnap of snap.docs){
          const d = docSnap.data() || {};
          const kind = (d.kind||"").toLowerCase();
          if (kind !== "move" && kind !== "shoot") continue;
          await writeLogFromRequest("added", docSnap.id, d);
          n++;
        }
        alert(`تم بناء السجل لعدد ${n} طلب.`);
      }catch(e){
        console.error(e);
        alert("حصل خطأ أثناء البناء. راجع Console.");
      }finally{
        $("btnBackfill").disabled = false;
        $("btnBackfill").innerHTML = "<i class='fa-solid fa-rotate'></i> بناء سجل الطلبات الحالية";
      }
    });

  </script>
</body>
</html>
