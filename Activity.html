
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MZJ | سجل النشاط</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- قالب الواجهة المعتمد -->
  <link rel="stylesheet" href="./mzj-ui.css"/>

  <style>
    html.auth-pending body{opacity:0; pointer-events:none;}
    .mzj-table td{vertical-align:top;}
    .subtle{font-size:12px; color:var(--muted);}
    .file-warn{max-width:820px;margin:40px auto;padding:18px;border-radius:16px;border:1px solid rgba(239,68,68,.25);background:rgba(239,68,68,.06);font-family:Tajawal;text-align:center}
    .file-warn code{direction:ltr;unicode-bidi:bidi-override;background:rgba(0,0,0,.06);padding:2px 6px;border-radius:8px}
    .file-warn .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;margin-top:12px;padding:10px 14px;border-radius:12px;border:1px solid rgba(0,0,0,.12);background:#fff;cursor:pointer}
  </style>
</head>

<body class="mzj auth-pending">
  <!-- ===== Topbar ===== -->
  <div class="mzj-topbar">
    <div class="topbar-left">
      <button id="mzjSidebarBtn" class="icon-btn" title="القائمة"><i class="fa-solid fa-bars"></i></button>
      <div class="brand">
        <div class="brand-mark">MZJ</div>
        <div>
          <div class="brand-title">Workspace</div>
          <div class="brand-sub">سجل النشاط</div>
        </div>
      </div>
    </div>

    <div class="topbar-center">
      <div id="mzjNow" class="mzj-chip"><i class="fa-regular fa-clock"></i><span>—</span></div>
    </div>

    <div class="topbar-right">
      <button id="mzjThemeBtn" class="icon-btn" title="الوضع الليلي"><i class="fa-solid fa-moon"></i></button>
      <div class="mzj-user">
        <div class="avatar" id="userAvatar">—</div>
        <div>
          <div class="user-name" id="userName">—</div>
          <div class="user-role" id="userRole">—</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Shell ===== -->
  <div id="mzjShell" class="mzj-shell">
    <aside id="mzjSidebar" class="mzj-sidebar">
      <div class="side-section">
        <div class="side-title">التنقل</div>
        <nav class="side-nav">
          <a class="side-link active" href="./Activity.html"><i class="fa-solid fa-clock-rotate-left"></i>سجل النشاط</a>
          <a class="side-link" href="./dashboard.html"><i class="fa-solid fa-gauge"></i>الداش بورد</a>
          <a class="side-link" href="./orders.html"><i class="fa-solid fa-list-check"></i>الطلبات</a>
          <a class="side-link" href="./inventory.html"><i class="fa-solid fa-warehouse"></i>المخزون</a>
        </nav>
      </div>
    </aside>

    <div id="mzjBackdrop" class="mzj-backdrop"></div>

    <main class="mzj-content">
      <div class="mzj-pagehead">
        <div>
          <h1 class="page-title">سجل النشاط</h1>
          <p class="page-desc">قراءة فقط من <b>mzj_activity_log</b>.</p>
        </div>
      </div>

      <section class="mzj-card">
        <div class="card-head">
          <div class="card-title">آخر الحركات</div>
          <div class="card-sub">التسلسل 1, 2, 3 … حسب الأحدث</div>
        </div>
        <div class="card-body">
          <div class="mzj-table-wrap">
            <table class="mzj-table">
              <thead>
                <tr>
                  <th style="width:64px">#</th>
                  <th style="width:170px">التاريخ</th>
                  <th style="width:240px">العضو</th>
                  <th style="width:170px">الدور</th>
                  <th style="width:200px">نوع الحركة</th>
                  <th>التفاصيل</th>
                </tr>
              </thead>
              <tbody id="activityRows">
                <tr><td colspan="6" class="subtle">جارِ التحميل…</td></tr>
              </tbody>
            </table>
          </div>

          <div class="mzj-footer">
            <span id="rowsCount">0</span> <span>سجل</span>
            <span class="sep">•</span>
            <span class="subtle">المصدر: mzj_activity_log</span>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="./mzj-ui.js"></script>

  <script type="module">
    // تنبيه: Auth لا يعمل بشكل موثوق من file://
    if (location.protocol === "file:") {
      document.documentElement.classList.remove("auth-pending");
      document.body.innerHTML = `
        <div class="file-warn">
          <div style="font-size:18px;font-weight:800;margin-bottom:6px">افتح الصفحة عبر HTTP مش Downloads</div>
          <div class="subtle">
            شغّل سيرفر محلي ثم افتح: <code>http://localhost:5500/Activity.html</code>
          </div>
          <div class="subtle" style="margin-top:10px;line-height:1.9">
            <div><code>python -m http.server 5500</code></div>
            <div style="margin-top:8px">ولا تنسى تضيف <b>localhost</b> في Authorized domains داخل Firebase Auth.</div>
          </div>
          <button class="btn" onclick="navigator.clipboard.writeText('python -m http.server 5500')">
            <i class="fa-regular fa-copy"></i> نسخ أمر السيرفر
          </button>
        </div>
      `;
      throw new Error("Opened via file://");
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy, limit, onSnapshot,
      doc, getDoc, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
  "apiKey": "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
  "authDomain": "mzj-agenda.firebaseapp.com",
  "projectId": "mzj-agenda",
  "storageBucket": "mzj-agenda.firebasestorage.app",
  "messagingSenderId": "834700407721",
  "appId": "1:834700407721:web:75c17665d4f032fd65cab8"
};
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=> document.getElementById(id);
    const safe = (v)=> (v===null || v===undefined) ? "" : String(v);

    function normalizeRole(r){
      r = (r||"").toString().trim().toLowerCase();
      if (["admin","administrator","مدير","المدير","أدمن","ادمن","الإدارة","الادارة","إدارة","اداره","management","manager"].includes(r)) return "الإدارة";
      if (["sales","مبيعات","مندوب"].includes(r)) return "المبيعات";
      return r || "";
    }

    async function fetchUserRole(user){
      try{
        const snap = await getDoc(doc(db,"user", user.uid));
        if (snap.exists()) return normalizeRole(snap.data()?.role);
      }catch(_){}

      try{
        const q = query(collection(db,"user"), where("email","==",(user.email||"").toLowerCase()));
        const res = await getDocs(q);
        if (!res.empty) return normalizeRole(res.docs[0].data()?.role);
      }catch(_){}

      return "";
    }

    function setUserUI(user, role){
      const nm = user?.displayName || user?.email || "—";
      $("userName").textContent = nm;
      $("userRole").textContent = role || "—";
      $("userAvatar").textContent = (nm||"").trim().slice(0,1).toUpperCase() || "—";
    }

    function deny(msg){
      document.documentElement.classList.remove("auth-pending");
      document.body.innerHTML = `<div style="padding:24px;font-family:Tajawal;text-align:center">${msg||"لا تملك صلاحية الوصول لهذه الصفحة"}</div>`;
    }

    // Read-only + نفس صلاحياتك: الإدارة/أدمن
    onAuthStateChanged(auth, async (user)=>{
      try{
        if (!user) return deny("غير مسجّل دخول.");
        const role = await fetchUserRole(user);
        setUserUI(user, role);

        const email = (user.email||"").toLowerCase();
        const ok = (role === "الإدارة") || email.includes("admin");
        if (!ok) return deny("لا تملك صلاحية الوصول لهذه الصفحة");

        document.documentElement.classList.remove("auth-pending");
        startActivityStream();
      }catch(e){
        console.error(e);
        deny("حدث خطأ في التحقق من الصلاحيات.");
      }
    });

    function startActivityStream(){
      const rowsEl = $("activityRows");
      const countEl = $("rowsCount");

      const q = query(collection(db,"mzj_activity_log"), orderBy("ts","desc"), limit(300));
      onSnapshot(q, (snap)=>{
        rowsEl.innerHTML = "";
        let i = 0;

        snap.forEach((docSnap)=>{
          const d = docSnap.data() || {};
          const member = (safe(d.userName) || "—") + (d.userEmail ? `<div class="subtle">${safe(d.userEmail)}</div>` : "");
          rowsEl.insertAdjacentHTML("beforeend", `
            <tr>
              <td>${++i}</td>
              <td>${safe(d.createdAt)||"—"}</td>
              <td>${member}</td>
              <td>${safe(d.role)||"—"}</td>
              <td>${safe(d.action)||"—"}</td>
              <td>${safe(d.details)||"—"}</td>
            </tr>
          `);
        });

        if (!i) rowsEl.innerHTML = `<tr><td colspan="6" class="subtle">لا يوجد سجلات بعد.</td></tr>`;
        countEl.textContent = String(i);
      }, (err)=>{
        console.error(err);
        rowsEl.innerHTML = `<tr><td colspan="6" class="subtle">تعذّر تحميل سجل النشاط.</td></tr>`;
      });
    }
  </script>
</body>
</html>
