

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <link rel="icon" type="image/x-icon" href="assets/favicon.png">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MZJ | سجل النشاط</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- قالب الواجهة المعتمد -->
  <link rel="stylesheet" href="./mzj-ui.css"/>

  <style>
    html.auth-pending body{opacity:0; pointer-events:none;}
    .mzj-table td{vertical-align:top;}
    .subtle{font-size:12px; color:var(--muted);}
    .file-warn{max-width:820px;margin:40px auto;padding:18px;border-radius:16px;border:1px solid rgba(239,68,68,.25);background:rgba(239,68,68,.06);font-family:Tajawal;text-align:center}
    .file-warn code{direction:ltr;unicode-bidi:bidi-override;background:rgba(0,0,0,.06);padding:2px 6px;border-radius:8px}
    .file-warn .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;margin-top:12px;padding:10px 14px;border-radius:12px;border:1px solid rgba(0,0,0,.12);background:#fff;cursor:pointer}
  </style>
</head>

<body class="mzj auth-pending">
  <!-- ===== Topbar ===== -->
  <div class="mzj-topbar">
    <div class="topbar-left">
      <button id="mzjSidebarBtn" class="icon-btn" title="القائمة"><i class="fa-solid fa-bars"></i></button>
      <div class="brand">
        <div class="brand-mark">MZJ</div>
        <div>
          <div class="brand-title">Workspace</div>
          <div class="brand-sub">سجل النشاط</div>
        </div>
      </div>
    </div>

    <div class="topbar-center">
      <div id="mzjNow" class="mzj-chip"><i class="fa-regular fa-clock"></i><span>—</span></div>
    </div>

    <div class="topbar-right">
      <button id="mzjThemeBtn" class="icon-btn" title="الوضع الليلي"><i class="fa-solid fa-moon"></i></button>
      <div class="mzj-user">
        <div class="avatar" id="userAvatar">—</div>
        <div>
          <div class="user-name" id="userName">—</div>
          <div class="user-role" id="userRole">—</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Shell ===== -->
  <div id="mzjShell" class="mzj-shell">
    <aside id="mzjSidebar" class="mzj-sidebar">
      <div class="side-section">
        <div class="side-title">التنقل</div>
        <nav class="side-nav">
           <a class="side-link tab" href="./sales.html"><i class="fa-solid fa-handshake"></i><span>تتبع المبيعات</span></a>
          <a class="side-link tab" href="./dashboard.html"><i class="fa-solid fa-gauge"></i><span>الداش بورد</span></a>
          <a class="side-link tab" href="./inventory.html"><i class="fa-solid fa-boxes-stacked"></i><span>المخزون</span></a>
          <a class="side-link tab" href="./vt.html"><i class="fa-solid fa-right-left"></i><span>نقل السيارات</span></a>
          <a class="side-link tab" href="./photoshoot-user.html"><i class="fa-solid fa-camera"></i><span>إدارة الطلبات</span></a>
          <a class="side-link tab" href="./cars.html"><i class="fa-solid fa-car"></i><span>كل السيارات</span></a>
          <a class="side-link tab" href="./admin.html"><i class="fa-solid fa-shield-halved"></i><span>الإدارة</span></a>
          <a class="side-link tab active" href="./Activity.html"><i class="fa-solid fa-clipboard-list"></i><span>سجل النشاط</span></a>

        </nav>
      </div>
    </aside>

    <div id="mzjBackdrop" class="mzj-backdrop"></div>

    <main class="mzj-content">
      <div class="mzj-pagehead">
        <div>
          <h1 class="page-title">سجل النشاط</h1>
          <p class="page-desc">قراءة فقط من <b>mzj_activity_log</b>.</p>
        </div>
      </div>

      <section class="mzj-card">
        <div class="card-head">
          <div class="card-title">آخر الحركات</div>
          <div class="card-sub">التسلسل 1, 2, 3 … حسب الأحدث</div>
        </div>
        <div class="card-body">
          <div class="mzj-table-wrap">
            <table class="mzj-table">
              <thead>
                <tr>
                  <th style="width:64px">#</th>
                  <th style="width:170px">التاريخ</th>
                  <th style="width:240px">العضو</th>
                  <th style="width:170px">الدور</th>
                  <th style="width:200px">نوع الحركة</th>
                  <th>التفاصيل</th>
                </tr>
              </thead>
              <tbody id="activityRows">
                <tr><td colspan="6" class="subtle">جارِ التحميل…</td></tr>
              </tbody>
            </table>
          </div>

          <div class="mzj-footer">
            <span id="rowsCount">0</span> <span>سجل</span>
            <span class="sep">•</span>
            <span class="subtle">المصدر: mzj_activity_log</span>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="./mzj-ui.js"></script>

  <script type="module">
    // تنبيه: Auth لا يعمل بشكل موثوق من file://
    if (location.protocol === "file:") {
      document.documentElement.classList.remove("auth-pending");
      document.body.innerHTML = `
        <div class="file-warn">
          <div style="font-size:18px;font-weight:800;margin-bottom:6px">افتح الصفحة عبر HTTP مش Downloads</div>
          <div class="subtle">
            شغّل سيرفر محلي ثم افتح: <code>http://localhost:5500/Activity.html</code>
          </div>
          <div class="subtle" style="margin-top:10px;line-height:1.9">
            <div><code>python -m http.server 5500</code></div>
            <div style="margin-top:8px">ولا تنسى تضيف <b>localhost</b> في Authorized domains داخل Firebase Auth.</div>
          </div>
          <button class="btn" onclick="navigator.clipboard.writeText('python -m http.server 5500')">
            <i class="fa-regular fa-copy"></i> نسخ أمر السيرفر
          </button>
        </div>
      `;
      throw new Error("Opened via file://");
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import {getFirestore, collection, query, orderBy, limit, onSnapshot, doc, getDoc, where, getDocs, addDoc, serverTimestamp} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
  "apiKey": "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
  "authDomain": "mzj-agenda.firebaseapp.com",
  "projectId": "mzj-agenda",
  "storageBucket": "mzj-agenda.firebasestorage.app",
  "messagingSenderId": "834700407721",
  "appId": "1:834700407721:web:75c17665d4f032fd65cab8"
};
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
  window.mzjActivity?.initModular({ db, collection, addDoc, serverTimestamp, getDoc });

  // Activity Logger wrappers (Modular)
  async function mzjSetDoc(ref, data, options, meta){
    return window.mzjActivity?.modularSetDoc({ setDoc, ref, data, options, meta }) ?? setDoc(ref, data, options);
  }
  async function mzjUpdateDoc(ref, data, meta){
    return window.mzjActivity?.modularUpdateDoc({ updateDoc, ref, data, meta }) ?? updateDoc(ref, data);
  }


    const $ = (id)=> document.getElementById(id);
    const safe = (v)=> (v===null || v===undefined) ? "" : String(v);

    const roleCache = new Map(); // emailLower -> roleLabel

    function fmtDate(dt){
      try{
        const fmt = new Intl.DateTimeFormat('ar-SA', {
          year:'numeric', month:'2-digit', day:'2-digit',
          hour:'2-digit', minute:'2-digit', hour12:true,
          timeZone:'Asia/Riyadh'
        });
        return fmt.format(dt);
      }catch(_){
        return dt.toLocaleString('ar-SA');
      }
    }

    function tsToDate(v){
      if(!v) return null;
      // Firestore Timestamp (modular) has toDate()
      if (typeof v.toDate === 'function') return v.toDate();
      // Timestamp-like {seconds, nanoseconds}
      if (typeof v.seconds === 'number') return new Date(v.seconds*1000);
      // ISO string
      if (typeof v === 'string'){
        const d = new Date(v);
        return isNaN(d.getTime()) ? null : d;
      }
      // millis number
      if (typeof v === 'number') return new Date(v);
      return null;
    }

    function getCreatedAtDisplay(d){
      // Prefer explicit formatted string
      if (d.createdAt && typeof d.createdAt === 'string' && d.createdAt.trim()) return d.createdAt.trim();
      // createdAtTs / ts / updatedAt etc.
      const dt = tsToDate(d.createdAtTs) || tsToDate(d.ts) || tsToDate(d.createdAt);
      if (dt) return fmtDate(dt);
      // fallback date field like '2025-12-20'
      if (d.date) return String(d.date);
      return "";
    }

    async function resolveRoleByEmail(email){
      const em = (email||"").toLowerCase().trim();
      if(!em) return "";
      if(roleCache.has(em)) return roleCache.get(em) || "";
      // 1) try doc id as email (some setups)
      try{
        const s1 = await getDoc(doc(db,"user", em));
        if(s1.exists()){
          const r = normalizeRole(s1.data()?.role);
          roleCache.set(em, r||"");
          return r||"";
        }
      }catch(_){}
      // 2) query by email field
      try{
        const q1 = query(collection(db,"user"), where("email","==", em));
        const res = await getDocs(q1);
        if(!res.empty){
          const r = normalizeRole(res.docs[0].data()?.role);
          roleCache.set(em, r||"");
          return r||"";
        }
      }catch(_){}
      roleCache.set(em, "");
      return "";
    }

    function normalizeRole(r){
      r = (r||"").toString().trim().toLowerCase();
      if (["admin","administrator","مدير","المدير","أدمن","ادمن","الإدارة","الادارة","إدارة","اداره","management","manager"].includes(r)) return "الإدارة";
      if (["sales","مبيعات","مندوب"].includes(r)) return "المبيعات";
      return r || "";
    }

    async function fetchUserRole(user){
      try{
        const snap = await getDoc(doc(db,"user", user.uid));
        if (snap.exists()) return normalizeRole(snap.data()?.role);
      }catch(_){}

      try{
        const q = query(collection(db,"user"), where("email","==",(user.email||"").toLowerCase()));
        const res = await getDocs(q);
        if (!res.empty) return normalizeRole(res.docs[0].data()?.role);
      }catch(_){}

      try{
        const snap2 = await getDoc(doc(db,"members", user.uid));
        if (snap2.exists()) return normalizeRole(snap2.data()?.role);
      }catch(_){ }

      try{
        const q2 = query(collection(db,"members"), where("email","==",(user.email||"").toLowerCase()));
        const res2 = await getDocs(q2);
        if (!res2.empty) return normalizeRole(res2.docs[0].data()?.role);
      }catch(_){ }

      return "";
    }

    function setUserUI(user, role){
      const nm = user?.displayName || user?.email || "—";
      $("userName").textContent = nm;
      $("userRole").textContent = role || "—";
      $("userAvatar").textContent = (nm||"").trim().slice(0,1).toUpperCase() || "—";
    }

    function deny(msg){
      document.documentElement.classList.remove("auth-pending");
      document.body.innerHTML = `<div style="padding:24px;font-family:Tajawal;text-align:center">${msg||"لا تملك صلاحية الوصول لهذه الصفحة"}</div>`;
    }

    // Read-only + نفس صلاحياتك: الإدارة/أدمن
    onAuthStateChanged(auth, async (user)=>{
      try{
        if (!user) return deny("غير مسجّل دخول.");
        const role = await fetchUserRole(user);
    window.__mzjUserRole = role || null;
        setUserUI(user, role);

        const email = (user.email||"").toLowerCase();
        const ok = (role === "الإدارة") || email.includes("admin");
        if (!ok) return deny("لا تملك صلاحية الوصول لهذه الصفحة");

        document.documentElement.classList.remove("auth-pending");
        startActivityStream();
      }catch(e){
        console.error(e);
        deny("حدث خطأ في التحقق من الصلاحيات.");
      }
    });

    function startActivityStream(){
      const rowsEl = $("activityRows");
      const countEl = $("rowsCount");

      const q = query(collection(db,"mzj_activity_log"), orderBy("ts","desc"), limit(300));
      onSnapshot(q, (snap)=>{
        rowsEl.innerHTML = "";
        let i = 0;

        snap.forEach((docSnap)=>{
          const d = docSnap.data() || {};
          const member = (safe(d.userName) || "—") + (d.userEmail ? `<div class="subtle">${safe(d.userEmail)}</div>` : "");
          rowsEl.insertAdjacentHTML("beforeend", `
            <tr>
              <td>${++i}</td>
              <td>${safe(getCreatedAtDisplay(d))||"—"}</td>
              <td>${member}</td>
              <td class="role-cell" data-email="${safe(d.userEmail||'')}" data-doc="${docSnap.id}">${safe(d.role)||"—"}</td>
              <td>${safe(d.action)||"—"}</td>
              <td>${safe(d.details)||"—"}</td>
            </tr>
          `);
        });


        // Fill missing roles lazily (from user collection)
        const roleCells = rowsEl.querySelectorAll('.role-cell');
        roleCells.forEach(async (cell)=>{
          try{
            if(cell.textContent && cell.textContent.trim() && cell.textContent.trim() !== '—') return;
            const em = cell.getAttribute('data-email') || '';
            const r = await resolveRoleByEmail(em);
            if(r) cell.textContent = r;
          }catch(_){}
        });

        if (!i) rowsEl.innerHTML = `<tr><td colspan="6" class="subtle">لا يوجد سجلات بعد.</td></tr>`;
        countEl.textContent = String(i);
      }, (err)=>{
        console.error(err);
        rowsEl.innerHTML = `<tr><td colspan="6" class="subtle">تعذّر تحميل سجل النشاط.</td></tr>`;
      });
    }
  </script>
</body>
</html>
