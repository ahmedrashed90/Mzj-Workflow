



<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>mzj-workflow | الإدارة + المخزون</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root{--brown:#3e2420;--beige:#bc8f74;--cream:#fff8ef;--bg:#f6f2ed;--card:#fff;--text:#1f1f1f;--muted:#6b6b6b;--line:#e9dfd5;--shadow:0 10px 24px rgba(0,0,0,.08);--r:12px}
    *{box-sizing:border-box}
    body{margin:0;font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1400px;margin:0 auto;padding:16px}
    .topbar{background:#fff;border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .dot{width:12px;height:12px;border-radius:50%;background:var(--beige);box-shadow:0 0 0 6px rgba(188,143,116,.18)}
    .title{font-weight:800;color:var(--brown);font-size:18px}
    .subtitle{color:var(--muted);font-size:13px;margin-top:2px}
    .right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:var(--cream);padding:8px 10px;border-radius:999px;font-size:13px;color:var(--brown)}
    .btn{appearance:none;border:none;cursor:pointer;border-radius:10px;padding:10px 12px;font-weight:800;font-family:inherit;display:inline-flex;align-items:center;gap:8px}
    .btn.primary{background:var(--brown);color:#fff}
    .btn.secondary{background:#fff;border:1px solid var(--line);color:var(--brown)}
    .btn.danger{background:#b42318;color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow)}
    .card h3{margin:0;padding:14px;border-bottom:1px solid var(--line);color:var(--brown);font-size:16px}
    .card .body{padding:14px}

    .tabs{margin-top:14px}
    .tabbar{display:flex;gap:8px;flex-wrap:wrap;background:#fff;border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:8px}
    .tab{padding:10px 12px;border-radius:10px;border:1px solid transparent;font-weight:900;color:var(--brown);cursor:pointer}
    .tab.active{background:var(--cream);border-color:var(--line)}
    .view{display:none;margin-top:14px}
    .view.active{display:block}

    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px;font-family:inherit;background:#fff;outline:none}
    textarea{min-height:90px;resize:vertical}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
    @media(max-width:680px){.row{grid-template-columns:1fr}}
    .span2{grid-column:1 / -1}

    .checks{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    @media(max-width:980px){.checks{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:520px){.checks{grid-template-columns:repeat(2,1fr)}}
    .checkItem{border:1px solid var(--line);border-radius:10px;padding:10px;display:flex;align-items:center;justify-content:space-between;gap:10px;background:var(--cream)}
    .checkItem span{font-weight:900;color:var(--brown);font-size:13px}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:flex-end}
    .toolbar .field{min-width:220px}

    .tableWrap{max-height:560px;overflow:auto;border:1px solid var(--line);border-radius:12px;background:#fff}
    table{width:100%;border-collapse:collapse}
    thead th{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);color:var(--brown);font-size:12px;text-align:right;padding:6px 8px;white-space:nowrap}
    tbody td{border-bottom:1px solid var(--line);padding:6px 8px;font-size:12.5px;vertical-align:top}

    .linkBtn{display:inline-flex;align-items:center;justify-content:center;padding:7px 10px;border-radius:10px;border:1px solid var(--line);background:var(--cream);color:var(--brown);font-weight:900;cursor:pointer;white-space:nowrap}
    .linkBtn:hover{filter:brightness(.98)}

    .tag{display:inline-flex;align-items:center;border-radius:999px;padding:5px 10px;font-weight:900;font-size:12px;white-space:nowrap}
    .tag.ok{background:#e7f7ed;color:#087443;border:1px solid #bfe7cc}
    .tag.no{background:#feeceb;color:#a1130b;border:1px solid #f5c2be}

    .authBox{max-width:520px;margin:22px auto}
    .hidden{display:none !important}

    .toast{position:fixed;left:16px;bottom:16px;background:#111;color:#fff;padding:12px 14px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.25);opacity:0;transform:translateY(10px);transition:.25s;max-width:92vw;z-index:9999}
    .toast.show{opacity:1;transform:translateY(0)}

    .modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:14px;z-index:9998}
    .modalBackdrop.show{display:flex}
    .modal{width:min(720px,96vw);background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.2);overflow:hidden}
    .modalHead{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid var(--line);background:var(--cream)}
    .modalHead h4{margin:0;color:var(--brown)}
    .modalBody{padding:14px}
    .modalFoot{padding:14px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-start;flex-wrap:wrap}

    .small{font-size:12px;color:var(--muted);line-height:1.7}
  
/* توسيع جدول المخزون فقط */
#view-inventory .body{
  padding: 0;
}


/* سطر واحد لكل خلايا جدول المخزون */
#inv_table th,
#inv_table td{
  white-space: nowrap;
  vertical-align: middle;
}


/* جعل جدول المخزون بعرض الصفحة بالكامل */
#view-inventory{
  margin-left: calc(-50vw + 50%);
  margin-right: calc(-50vw + 50%);
}

#view-inventory .card{
  border-radius: 0;
}

#view-inventory .tableWrap{
  width: 100vw;
}


/* جدول النقل في تاب نقل السيارات بعرض الصفحة */
#view-transfer .tableWrap{
  width: 100vw;
  margin-left: calc(-50vw + 50%);
  margin-right: calc(-50vw + 50%);
  border-radius: 0;
}
#view-transfer .tableWrap table{
  width: 100%;
}



/* نقل السيارات: خليه نفس شكل تاب الطلبات (كارت بعرض الصفحة + جدول داخل الكارت) */
#view-transfer .grid{
  grid-template-columns: 1fr !important;
}

#view-transfer .card{
  width: 100%;
}

#tr_tableWrap{
  width: 100%;
  margin: 0;
}

#tr_tableWrap table{
  width: 100%;
}


/* FIX FINAL: خلي تاب نقل السيارات نفس Layout تاب الطلبات */
#view-transfer{
  max-width: 100%;
}
#view-transfer > .card{
  max-width: 100%;
  margin: 0 auto;
}
#view-transfer .body{
  padding: 16px;
}
#view-transfer .tableWrap{
  width: 100%;
  margin: 0;
}
#view-transfer table{
  width: 100%;
}


    /* ===== Dashboard ===== */
    .dashGrid{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:14px;margin-top:14px}
    .dashCard .body{display:grid;gap:10px}
    .dashKpis{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:10px}
    .dashKpi{background:#fff;border:1px solid #f0e6dc;border-radius:12px;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .dashKpi span{color:var(--muted);font-size:13px;font-weight:700}
    .dashKpi b{font-size:18px;color:var(--brown)}
    .dashBtns{display:flex;gap:8px;flex-wrap:wrap}
    .dashFilters{display:grid;grid-template-columns:220px 1fr 220px;gap:12px;align-items:end}
    .dashStatusBox{border:1px solid #f0e6dc;border-radius:12px;background:#fff;padding:10px 12px}
    .dashChecks{display:flex;gap:10px;flex-wrap:wrap}
    .dashChk{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--brown);font-weight:700}
    .dashFilterActions{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}

    @media (max-width:1100px){
      .dashGrid{grid-template-columns:repeat(2, minmax(0,1fr))}
      .dashFilters{grid-template-columns:1fr}
      .dashFilterActions{justify-content:flex-start}
    }
    @media (max-width:720px){
      .dashGrid{grid-template-columns:1fr}
    }


/* داش بورد: تمييز الإجمالي الفعلي وإجمالي المفاتيح */
#stk_totalActual, #stk_keysTotal,
#ag_totalActual,  #ag_keysTotal,
#b1_totalActual,  #b1_keysTotal,
#b2_totalActual,  #b2_keysTotal,
#b3_totalActual,  #b3_keysTotal{
  color: #d97706; /* برتقالي مناسب */
}


/* داش بورد: إبراز الإجمالي الفعلي وإجمالي المفاتيح */
#view-dashboard .dashKpi:has(#stk_totalActual),
#view-dashboard .dashKpi:has(#stk_keysTotal),
#view-dashboard .dashKpi:has(#ag_totalActual),
#view-dashboard .dashKpi:has(#ag_keysTotal),
#view-dashboard .dashKpi:has(#b1_totalActual),
#view-dashboard .dashKpi:has(#b1_keysTotal),
#view-dashboard .dashKpi:has(#b2_totalActual),
#view-dashboard .dashKpi:has(#b2_keysTotal),
#view-dashboard .dashKpi:has(#b3_totalActual),
#view-dashboard .dashKpi:has(#b3_keysTotal){
  border: 2px solid #d97706;
  border-radius: 12px;
  padding: 10px 12px;
}
#view-dashboard #stk_totalActual, #view-dashboard #stk_keysTotal,
#view-dashboard #ag_totalActual,  #view-dashboard #ag_keysTotal,
#view-dashboard #b1_totalActual,  #view-dashboard #b1_keysTotal,
#view-dashboard #b2_totalActual,  #view-dashboard #b2_keysTotal,
#view-dashboard #b3_totalActual,  #view-dashboard #b3_keysTotal{
  color:#d97706;
}


/* Dashboard: saved cards container should flow inside grid */
#dash_saved_cards{display:contents}

/* Dashboard: highlight totals (اجمالي فعلي/مفاتيح) */
#view-dashboard .kpiHighlight{
  border:2px solid #d97706;
  border-radius:12px;
  padding:10px 12px;
}
#view-dashboard .kpiHighlight b{
  color:#d97706;
}


/* Dashboard enhancements */
.dashKpi.clickable{cursor:pointer;}
#dashDataModal .modalBox, #reqModal .modalBox, #detailsModal .modalBox{width:min(96vw, 1400px);}
#dashDataModal .tableWrap, #reqModal .tableWrap, #detailsModal .tableWrap{max-height:60vh;}


/* DASH MODAL TWEAK */
#dashDataModal .modal{max-width: 96vw; width: 96vw; max-height: 86vh; height: auto;}
#dashDataModal .modalBody{max-height: 70vh; overflow:auto;}
#dashDataModal table{min-width: 1100px;}


/* DASH DATA MODAL */
#dashDataModal .modal-card{max-width:95vw;width:95vw;max-height:85vh;height:85vh;display:flex;flex-direction:column;}
#dashDataModal .modal-body{flex:1;overflow:auto;}
#dashDataModal table{min-width:1100px;}

/* SHEET IMPORT MODAL */
#sheetImportModal .modal-card{max-width:900px;width:95vw;}


/* Tracking modal table */
.table.stickyHead thead th{position:sticky; top:0; background:#fff8ef; z-index:2;}
#detailsModal .modal{max-height:88vh;}
#detailsModal .modalBody{max-height:calc(88vh - 56px); overflow:auto;}
</style>

  <style>
    /* Dashboard modals wider */
    #dashDataModal .modal, #detailsModal .modal{width:96vw;max-width:96vw}
    #dashDataModal table.table{min-width:1200px}
  </style>

<style>
/* FIX: Tracking tab layout without mzj-ui */
#tracking-tab,
.tracking-tab,
.tracking-container {
  width: 100% !important;
  max-width: 100% !important;
  margin: 0 !important;
}

.tracking-content,
.sales-wrapper,
.sales-container {
  width: 100% !important;
  max-width: 100% !important;
  margin: 0 auto !important;
  float: none !important;
}

.sales-side,
.sales-right,
.sales-panel {
  float: none !important;
}

body {
  overflow-x: hidden;
}
</style>


<style>
html, body {
  direction: rtl;
  text-align: right;
}
</style>

</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">mzj-workflow — الإدارة + المخزون</div>
          <div class="subtitle">المسار الموحد لبيانات السيارة: <b>cars/{VIN}</b></div>
        </div>
      </div>
      <div class="right">
        <span class="pill" id="authPill">غير مسجل</span>
        <button class="btn secondary hidden" id="btnLogout">تسجيل خروج</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div class="authBox" id="authBox">
      <div class="card">
        <h3>تسجيل الدخول</h3>
        <div class="body">
          <div class="row">
            <div>
              <label>البريد الإلكتروني</label>
              <input id="loginEmail" type="email" placeholder="example@company.com" />
            </div>
            <div>
              <label>كلمة المرور</label>
              <input id="loginPass" type="password" placeholder="••••••••" />
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn primary" id="btnLogin">تسجيل الدخول</button>
            <button class="btn secondary" id="btnReset">نسيت كلمة المرور</button>
          </div>
          <div class="small" style="margin-top:10px">يجب أن تكون مسجل داخل مشروع <b>mzj-workflow</b>.</div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
      <div class="tabs">
        <div class="tabbar" role="tablist" aria-label="Tabs">
          <div class="tab" role="tab" data-view="view-dashboard">الداش بورد</div>
          <div class="tab active" role="tab" data-view="view-admin">الإدارة</div>
          <div class="tab" role="tab" data-view="view-inventory">المخزون</div>
          <div class="tab" role="tab" data-view="view-transfer">نقل السيارات</div>
          <div class="tab" role="tab" data-view="view-requests">الطلبات</div>
                  <div class="tab" role="tab" data-view="view-allcars">كل السيارات</div>
          <div class="tab" role="tab" data-view="view-logs">سجل الحركات</div>
          <div class="tab" role="tab" data-view="view-tracking">التراكينج</div>
          <div class="tab" role="tab" data-view="view-archive">الأرشيف</div>
          <div class="tab" role="tab" data-view="view-users">إدارة المستخدمين</div>
</div>

        <!-- الداش بورد -->
        <div class="view" id="view-dashboard" role="tabpanel">

          <!-- Saved View Filters -->
          <div class="card">
            <h3>الداش بورد</h3>
            <div class="body">
              <div class="dashFilters">
                <div>
                  <label>المكان</label>
                  <select id="dash_filter_location" class="selWithAdd">
                    <option value="">— اختر —</option>
                  </select>
                </div>
                <div class="dashStatusBox">
                  <div class="small" style="margin-bottom:6px">الحالات (يمكن اختيار أكثر من حالة)</div>
                  <div class="dashChecks" id="dash_filter_statuses">
                    <label class="dashChk"><input type="checkbox" value="متاح للبيع"> متاح للبيع</label>
                    <label class="dashChk"><input type="checkbox" value="حجز"> حجز</label>
                    <label class="dashChk"><input type="checkbox" value="بها ملاحظات"> بها ملاحظات</label>
                    <label class="dashChk"><input type="checkbox" value="مباع تحت التسليم"> مباع تحت التسليم</label>
                    <label class="dashChk"><input type="checkbox" value="مباع تم التسليم"> مباع تم التسليم</label>
                  </div>
                </div>
                <div class="dashFilterActions">
                  <button class="btn secondary" id="dash_filter_show">عرض</button>
                  <button class="btn primary" id="dash_filter_save">حفظ</button>
                  <button class="btn danger" id="dash_filter_clear">تفريغ</button>
                </div>
              </div>
              <div class="small" id="dash_filter_meta" style="margin-top:10px">—</div>
            </div>
          </div>

          <!-- Cards -->
          <div class="dashGrid">
      <div id="dash_saved_cards"></div>

            <div class="card dashCard">
              <h3>كارت النواقص</h3>
              <div class="body">
                <div class="dashKpis">
                  <div class="dashKpi"><span>إجمالي النواقص (كل الفروع)</span><b id="miss_total">—</b></div>
                </div>
                <div class="dashBtns">
<button type="button" class="btn secondary" data-miss-branch="الصالة">فرع 1: الصالة</button>
                  <button type="button" class="btn secondary" data-miss-branch="الملتقى">فرع 2: الملتقى</button>
                  <button type="button" class="btn secondary" data-miss-branch="القادسية">فرع 3: القادسية</button>
                </div>
                <div class="small" id="miss_meta" style="margin-top:10px">يُحسب من الإجمالي الفعلي (متاح للبيع + محجوز + بها ملاحظات) بالاعتماد على catalog.</div>
              </div>
            </div>

            <div class="card dashCard">
              <h3>كارت المخزون (عام)</h3>
              <div class="body">
                <div class="dashKpis">
                  <div class="dashKpi"><span>الإجمالي الفعلي</span><b id="stk_totalActual">—</b></div>
                  <div class="dashKpi"><span>إجمالي المفاتيح</span><b id="stk_keysTotal">—</b></div>
                </div>
                <div class="dashKpis">
                  <div class="dashKpi"><span>متاح</span><b id="stk_avail">—</b></div>
                  <div class="dashKpi"><span>محجوز</span><b id="stk_reserved">—</b></div>
                  <div class="dashKpi"><span>بها ملاحظات</span><b id="stk_notes">—</b></div>
                  <div class="dashKpi"><span>مباع تحت التسليم</span><b id="stk_under">—</b></div>
                  <div class="dashKpi"><span>مباع تم التسليم</span><b id="stk_delivered">—</b></div>
                </div>
                <div class="dashBtns">
                  <button type="button" class="btn secondary" id="btn_go_agency">الوكالة</button>
                  <button type="button" class="btn secondary" data-go-status="متاح للبيع">المتاح للبيع</button>
                  <button type="button" class="btn secondary" data-go-status="بها ملاحظات">سيارات بها ملاحظات</button>
                  <button type="button" class="btn secondary" data-go-status="مباع تحت التسليم">مباع تحت التسليم</button>
                </div>
              </div>
            </div>

            <div class="card dashCard">
              <h3>كارت الوكالة</h3>
              <div class="body">
                <div class="dashKpis">
                  <div class="dashKpi"><span>الإجمالي الفعلي</span><b id="ag_totalActual">—</b></div>
                  <div class="dashKpi"><span>إجمالي المفاتيح</span><b id="ag_keysTotal">—</b></div>
                </div>
                <div class="dashKpis">
                  <div class="dashKpi"><span>متاح</span><b id="ag_avail">—</b></div>
                  <div class="dashKpi"><span>محجوز</span><b id="ag_reserved">—</b></div>
                  <div class="dashKpi"><span>بها ملاحظات</span><b id="ag_notes">—</b></div>
                  <div class="dashKpi"><span>مباع تحت التسليم</span><b id="ag_under">—</b></div>
                  <div class="dashKpi"><span>مباع تم التسليم</span><b id="ag_delivered">—</b></div>
                </div>
                <div class="dashBtns">
          <button type="button" class="btn btn-sm kpiBtn show-branch-btn" data-go-location="الوكالة">عرض سيارات الوكالة</button>
        </div>
              </div>
            </div>

            <div class="card dashCard">
              <h3>كارت فرع 1 : الصالة</h3>
              <div class="body">
                <div class="dashKpis">
                  <div class="dashKpi"><span>الإجمالي الفعلي</span><b id="b1_totalActual">—</b></div>
                  <div class="dashKpi"><span>إجمالي المفاتيح</span><b id="b1_keysTotal">—</b></div>
                </div>
                <div class="dashKpis">
                  <div class="dashKpi"><span>متاح</span><b id="b1_avail">—</b></div>
                  <div class="dashKpi"><span>محجوز</span><b id="b1_reserved">—</b></div>
                  <div class="dashKpi"><span>بها ملاحظات</span><b id="b1_notes">—</b></div>
                  <div class="dashKpi"><span>مباع تحت التسليم</span><b id="b1_under">—</b></div>
                  <div class="dashKpi"><span>مباع تم التسليم</span><b id="b1_delivered">—</b></div>
                </div>
                <div class="dashBtns"><button type="button" class="btn secondary" data-go-location="الصالة">عرض سيارات الصالة</button></div>
              </div>
            </div>

            <div class="card dashCard">
              <h3>كارت فرع 2 : الملتقى</h3>
              <div class="body">
                <div class="dashKpis">
                  <div class="dashKpi"><span>الإجمالي الفعلي</span><b id="b2_totalActual">—</b></div>
                  <div class="dashKpi"><span>إجمالي المفاتيح</span><b id="b2_keysTotal">—</b></div>
                </div>
                <div class="dashKpis">
                  <div class="dashKpi"><span>متاح</span><b id="b2_avail">—</b></div>
                  <div class="dashKpi"><span>محجوز</span><b id="b2_reserved">—</b></div>
                  <div class="dashKpi"><span>بها ملاحظات</span><b id="b2_notes">—</b></div>
                  <div class="dashKpi"><span>مباع تحت التسليم</span><b id="b2_under">—</b></div>
                  <div class="dashKpi"><span>مباع تم التسليم</span><b id="b2_delivered">—</b></div>
                </div>
                <div class="dashBtns"><button type="button" class="btn secondary" data-go-location="الملتقى">عرض سيارات الملتقى</button></div>
              </div>
            </div>

            <div class="card dashCard">
              <h3>كارت فرع 3 : القادسية</h3>
              <div class="body">
                <div class="dashKpis">
                  <div class="dashKpi"><span>الإجمالي الفعلي</span><b id="b3_totalActual">—</b></div>
                  <div class="dashKpi"><span>إجمالي المفاتيح</span><b id="b3_keysTotal">—</b></div>
                </div>
                <div class="dashKpis">
                  <div class="dashKpi"><span>متاح</span><b id="b3_avail">—</b></div>
                  <div class="dashKpi"><span>محجوز</span><b id="b3_reserved">—</b></div>
                  <div class="dashKpi"><span>بها ملاحظات</span><b id="b3_notes">—</b></div>
                  <div class="dashKpi"><span>مباع تحت التسليم</span><b id="b3_under">—</b></div>
                  <div class="dashKpi"><span>مباع تم التسليم</span><b id="b3_delivered">—</b></div>
                </div>
                <div class="dashBtns"><button type="button" class="btn secondary" data-go-location="القادسية">عرض سيارات القادسية</button></div>
              </div>
            </div>

            <div class="card dashCard">
              <h3>كارت الموافقة المالية والإدارية</h3>
              <div class="body">
                <div class="dashKpis">
                  <div class="dashKpi"><span>ناقص موافقة مالية</span><b id="ap_need_fin">—</b></div>
                  <div class="dashKpi"><span>ناقص موافقة إدارية</span><b id="ap_need_adm">—</b></div>
                </div>
                <div class="dashBtns">
                  <button class="btn secondary" id="ap_show_fin">عرض الناقص المالي</button>
                  <button class="btn secondary" id="ap_show_adm">عرض الناقص الإداري</button>
                </div>
                <div class="small" style="margin-top:10px">مربوط بالحالة: مباع تحت التسليم</div>
              </div>
            </div>

            <div class="card dashCard">
              <h3>كارت الطلبات</h3>
              <div class="body">
                <div class="dashKpis">
                  <div class="dashKpi"><span>تم استلام الطلب</span><b id="rq_s1">—</b></div>
                  <div class="dashKpi"><span>تم ارسال السيارة</span><b id="rq_s2">—</b></div>
                  <div class="dashKpi"><span>تم استلام السيارة</span><b id="rq_s3">—</b></div>
                  <div class="dashKpi"><span>تم الانتهاء</span><b id="rq_s4">—</b></div>
                </div>
<div class="small" style="margin-top:10px">الأرشفة تتم من تاب المخزون بعد اكتمال الطلب.</div>
              </div>
            </div>

            <div class="card dashCard">
              <h3>كارت تتبع طلبات البيع (Tracking)</h3>
              <div class="body">
                <div class="dashKpis">
                  <div class="dashKpi"><span>طلبات جديدة</span><b id="trk_new">—</b></div>
                  <div class="dashKpi"><span>تحت الإجراء</span><b id="trk_inprog">—</b></div>
                </div>
                <div class="dashBtns" style="margin-top:10px">
                  <button class="btn secondary" id="dash_trk_new">عرض الجديدة</button>
                  <button class="btn secondary" id="dash_trk_inprog">عرض تحت الإجراء</button>
                </div>
                <div class="small" style="margin-top:10px">يعرض الطلبات غير المؤرشفة فقط من erp_orders.</div>
              </div>
            </div>

          </div>
        </div>


        <!-- الإدارة -->
        <div class="view active" id="view-admin" role="tabpanel">
          <div class="card">
              <h3>إضافة / تعديل سيارة</h3>
              <div class="body">
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
                  <button class="btn primary" id="btnSave">حفظ</button>
                  <button class="btn secondary" id="btnClear">تفريغ</button>
                  <button class="btn secondary" id="btnFind">بحث بالهيكل</button>
                </div>

                <div class="row">
                  <div><label>الهيكل (VIN)</label><input id="f_vin" placeholder="VIN" /></div>
                  <div><label>السيارة</label><input id="f_car" placeholder="مثال: سوناتا" /></div>
                </div>

                <div class="row">
                  <div><label>البيان</label><input id="f_statement" /></div>
                  <div><label>الوكيل</label><input id="f_agent" /></div>
                </div>

                <div class="row">
                  <div><label>اللون الداخلي</label><input id="f_int" /></div>
                  <div><label>اللون الخارجي</label><input id="f_ext" /></div>
                </div>

                <div class="row">
                  <div><label>موديل</label><input id="f_model" placeholder="2025 / 2026" /></div>
                  <div><label>اللوحة</label><input id="f_plate" /></div>
                </div>

                <div class="row">
                  <div><label>اسم الدفعة بالتاريخ</label><input id="f_batch" /></div>
                  <div>
                    <label>المكان (الفرع)</label>
                    <select id="f_location" class="selWithAdd">
                      <option value="">— اختر —</option>
                    </select>
                  </div>
                </div>

                <div class="row">
                  <div>
                    <label>الحالة</label>
                    <select id="f_status" class="selWithAdd">
                      <option value="">— اختر —</option>
                    </select>
                  </div>
                  <div><label>ملاحظات (تحديد المكان)</label><input id="f_notesLoc" /></div>
                </div>

                <div class="row">
                  <div><label>ملاحظات (تخص النواقص)</label><input id="f_notesMissing" /></div>
                  <div id="f_carNotes_box" class="hidden"><label>ملاحظات السيارات</label><input id="f_carNotes" placeholder="تُفتح عند الحالة: بها ملاحظات" /></div>
                </div>
                <div class="row">
                  <div class="span2">
                    <div style="margin:10px 0 8px;color:var(--brown);font-weight:900">التشيك</div>
                    <div class="checks">
                      <div class="checkItem"><span>فرشات</span><input id="c_farshat" type="checkbox"></div>
                      <div class="checkItem"><span>طفاية</span><input id="c_tafaia" type="checkbox"></div>
                      <div class="checkItem"><span>شنطة</span><input id="c_shanta" type="checkbox"></div>
                      <div class="checkItem"><span>اسبير</span><input id="c_spare" type="checkbox"></div>
                      <div class="checkItem"><span>ريموت</span><input id="c_remote" type="checkbox"></div>
                      <div class="checkItem"><span>شاشة</span><input id="c_screen" type="checkbox"></div>
                      <div class="checkItem"><span>مسجل</span><input id="c_recorder" type="checkbox"></div>
                      <div class="checkItem"><span>مكيف</span><input id="c_ac" type="checkbox"></div>
                      <div class="checkItem"><span>كاميرا</span><input id="c_camera" type="checkbox"></div>
                      <div class="checkItem"><span>حساس</span><input id="c_sensors" type="checkbox"></div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div>
                    <label>الموافقة المالية</label>
                    <select id="a_financial">
                      <option value="">—</option>
                      <option value="true">نعم</option>
                      <option value="false">لا</option>
                    </select>
                  </div>
                  <div>
                    <label>الموافقة الإدارية</label>
                    <select id="a_admin">
                      <option value="">—</option>
                      <option value="true">نعم</option>
                      <option value="false">لا</option>
                    </select>
                  </div>
                </div>

                <div class="row">
                  <div class="span2">
                    <label>Tracking (اختياري)</label>
                    <input id="f_tracking" placeholder="رابط/كود تتبع (اختياري)" />
                  </div>
                </div>

                <div class="small">المسار الموحد: <b>cars</b> فقط. تابات النقل والطلبات لاحقًا هتشتغل Reference على VIN.</div>
              </div>
            </div>

            <div class="card">
              <h3>استيراد / تصدير</h3>
              <div class="body">
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
                  <button class="btn secondary" id="btnTemplate">تصدير قالب فاضي</button>
                  <button class="btn secondary" id="btnExportAll">تصدير البيانات</button>
                  <button class="btn primary" id="btnImport">استيراد من شيت</button>
                </div>
                <div class="small">
                  الاستيراد يدعم 3 اختيارات: <b>استبدال كامل</b> / <b>إضافة فوق الحالي</b> / <b>تحديث من الشيت</b>.
                  <br>الهيكل (VIN) هو المفتاح.
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- المخزون -->
        <div class="view" id="view-inventory" role="tabpanel">
          <div class="card">
            <h3>المخزون (قراءة فقط)</h3>
            <div class="body">
              <div class="toolbar">
                <div class="field" style="flex:1">
                  <label>بحث عام</label>
                  <input id="inv_search" placeholder="ابحث بالهيكل/السيارة/الوكيل/اللوحة/المكان..." />
                </div>
                <div class="field">
                  <label>الفرع (المكان)</label>
                  <select id="inv_location">
                    <option value="">الكل</option>
                  </select>
                </div>
                <div class="field">
                  <label>الحالة</label>
                  <select id="inv_status">
                    <option value="">الكل</option>
                  </select>
                </div>
                <div class="field">
                  <label>الموديل</label>
                  <select id="inv_model">
                    <option value="">الكل</option>
                  </select>
                </div>
                <div>
                  <button class="btn secondary" id="inv_export">تصدير النتائج</button>
                </div>
              </div>

              <div class="small" style="margin-bottom:10px">
                يعرض: VIN, السيارة, البيان, الوكيل, الألوان, الموديل, اللوحة, الدفعة, المكان, الملاحظات, الحالة, ملاحظات السيارات, Tracking + زر عرض المزيد.
              </div>

              <div class="tableWrap">
                <table id="inv_table">
                  <thead>
                    <tr>
                      <th>الهيكل (VIN)</th>
                      <th>السيارة</th>
                      <th>البيان</th>
                      <th>الوكيل</th>
                      <th>اللون الداخلي</th>
                      <th>اللون الخارجي</th>
                      <th>موديل</th>
                      <th>اللوحة</th>
                      <th>اسم الدفعة بالتاريخ</th>
                      <th>المكان</th>
                      <th>ملاحظات (تحديد المكان)</th>
                      <th>ملاحظات (تخص النواقص)</th>
                      <th>الحالة</th>
                      <th>Tracking</th>
                      <th>الموافقات</th>
                      <th>التشيك</th>
                      <th>طلبات النقل</th>
                      <th>الأرشيف</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

              <div class="small" id="inv_meta" style="margin-top:10px">—</div>
            </div>
          </div>
        </div>

        <!-- نقل السيارات -->
        <div class="view" id="view-transfer" role="tabpanel">
          <div class="grid">

            <div class="card">
              <h3>إنشاء طلب نقل (أكثر من سيارة إلى مكان واحد)</h3>
              <div class="body">

                <div class="toolbar" style="margin-bottom:8px">
                  <div class="field" style="min-width:unset">
                    <button class="btn secondary" id="tr_addRow">➕ إضافة سيارة</button>
                    <button class="btn danger" id="tr_clearRows">تفريغ القائمة</button>
                  </div>
                </div>

                <div class="tableWrap" id="tr_tableWrap" style="max-height:260px;margin-bottom:10px">
                  <table id="tr_vinTable">
                    <thead>
                      <tr>
                        <th style="min-width:220px">الهيكل (VIN)</th>
                        <th>السيارة</th>
                        <th>المكان الحالي</th>
                        <th>الحالة</th>
                        <th>الموافقات</th>
                        <th>حذف</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>

                <div class="row">
                  <div>
                    <label>المكان المستهدف</label>
                    <select id="tr_to" class="selWithAdd">
                      <option value="">— اختر —</option>
                    </select>
                  </div>

                  <div>
                    <label>الحالة</label>
                    <select id="tr_status" class="selWithAdd">
                      <option value="">— اختر —</option>
                    </select>
                  </div>

                  <div id="tr_note_box" class="hidden">
                    <label>ملاحظة (مطلوبة عند اختيار: سيارات بها ملاحظات)</label>
                    <input id="tr_note" placeholder="اكتب الملاحظة هنا..." />
                  </div>
                </div>

                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
<button class="btn primary" id="tr_submit">تنفيذ طلب النقل</button>
                </div>

                <div class="small" id="tr_hint" style="margin-top:10px">
                  المسموح بالنقل: <b>الادارة / اداري</b>. سيتم تسجيل آخر الحركات مع البريد المنفذ.
                
            <div class="card" style="margin-top:14px">
              <h3>سجل آخر الحركات</h3>
              <div class="body">
                <div class="tableWrap" style="max-height:360px">
                  <table id="log_table">
                    <thead>
                      <tr>
                        <th>نوع الطلب</th>
                        <th>رقم الهيكل</th>
                        <th>من</th>
                        <th>إلى</th>
                        <th>ملاحظات</th>
                        <th>المستخدم</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
                <div class="small" id="log_meta" style="margin-top:8px">آخر الحركات: 0</div>
              </div>
            </div>
</div>

              </div>
            </div>
<div class="small" id="tr_meta" style="margin-top:10px">—</div>
              </div>
            </div>

          </div>
</div>
        </div>

</div>
        </div>

      </div>
    </div>

  </div>

        <!-- الطلبات -->
        <div class="view" id="view-requests" role="tabpanel">
          <div class="card">
            <h3>الطلبات</h3>
            <div class="body">
              <div class="row">
                <div>
                  <label>اختر القسم</label>
                  <select id="req_mode">
                    <option value="create">إنشاء طلب</option>
                    <option value="track">متابعة الطلبات</option>
                    <option value="done">الطلبات المكتملة</option>
                  </select>
                </div>
                <div>
                  <label>—</label>
                  <div class="small">اختر من القائمة لإنشاء طلب جديد أو متابعة الطلبات.</div>
                </div>
              </div>

              <!-- إنشاء طلب -->
              <div id="req_create_box">
                <div class="row">
                  <div>
                    <label>نوع الطلب</label>
                    <select id="req_type">
                      <option value="transfer">نقل</option>
                      <option value="photo">تصوير</option>
                    </select>
                  </div>
                  <div id="req_photo_date_box" class="hidden">
                    <label>تاريخ التصوير</label>
                    <input id="req_photo_date" type="date" />
                  </div>
                </div>

                <div class="toolbar" style="margin-bottom:8px">
                  <div class="field" style="min-width:unset">
                    <button class="btn secondary" id="req_addRow">➕ إضافة رقم هيكل</button>
                    <button class="btn danger" id="req_clearRows">تفريغ القائمة</button>
                  </div>
                </div>

                <div class="tableWrap" style="max-height:320px;margin-bottom:10px">
                  <table id="req_vinTable">
                    <thead>
                      <tr>
                        <th style="min-width:220px">رقم الهيكل (VIN)</th>
                        <th>السيارة</th>
                        <th>الفئة</th>
                        <th>الخارجي</th>
                        <th>الداخلي</th>
                        <th>الموديل</th>
                        <th>المكان الحالي</th>
                        <th style="min-width:220px">ملاحظة</th>
                        <th>حذف</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>

                <div class="row">
                  <div>
                    <label id="req_loc_label">مكان النقل</label>
                    <select id="req_to" class="selWithAdd">
                      <option value="">— اختر —</option>
                    </select>
                  </div>
</div>

                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
                  <button class="btn primary" id="req_submit">إرسال الطلب</button>
                </div>

                <div class="small" id="req_create_hint" style="margin-top:10px">—</div>
              </div>

              <!-- متابعة الطلبات -->
              <div id="req_track_box" class="hidden">
                <div class="small" style="margin-bottom:10px">يعرض الطلبات غير المكتملة فقط.</div>
                <div class="tableWrap" style="max-height:520px">
                  <table id="req_table_open">
                    <thead>
                      <tr>
                        <th>التاريخ</th>
                        <th>النوع</th>
                        <th>عدد الهياكل</th>
                        <th>المكان المستهدف</th>
<th>فتح</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
                <div class="small" id="req_open_meta" style="margin-top:10px">—</div>
              </div>

              <!-- الطلبات المكتملة -->
              <div id="req_done_box" class="hidden">
                <div class="small" style="margin-bottom:10px">يعرض الطلبات المكتملة فقط.</div>
                <div class="tableWrap" style="max-height:520px">
                  <table id="req_table_done">
                    <thead>
                      <tr>
                        <th>التاريخ</th>
                        <th>النوع</th>
                        <th>عدد الهياكل</th>
                        <th>المكان المستهدف</th>
                        <th>اكتمل</th>
                        <th>فتح</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
                <div class="small" id="req_done_meta" style="margin-top:10px">—</div>
              </div>

            </div>
          </div>
        </div>

  
        <!-- كل السيارات -->
        <div class="view" id="view-allcars" role="tabpanel">
          <div class="card">
            <h3>كل السيارات</h3>
            <div class="body">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px">
                <div class="small">التجميع حسب (السيارة + البيان + الموديل) مع إجمالي العدد.</div>
                <button class="btn secondary" id="btnExportAllCars">تصدير Excel</button>
              </div>

              <div class="tableWrap" style="padding:0">
                <table id="allCarsTable">
                  <thead>
                    <tr>
                      <th style="width:60px">#</th>
                      <th>السيارة</th>
                      <th>البيان</th>
                      <th>الموديل</th>
                      <th style="width:140px">إجمالي العدد</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

              <div class="small" id="allCarsMeta" style="margin-top:8px">—</div>
            </div>
          </div>
        </div>


        <!-- سجل الحركات -->
        <div class="view" id="view-logs" role="tabpanel">
          <div class="card">
            <h3>سجل الحركات</h3>
            <div class="body">
              <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:end">
                <div style="min-width:160px">
                  <div class="small">من تاريخ</div>
                  <input id="lg_from" type="date" class="input" />
                </div>
                <div style="min-width:160px">
                  <div class="small">إلى تاريخ</div>
                  <input id="lg_to" type="date" class="input" />
                </div>
                <div style="min-width:160px">
                  <div class="small">فلترة</div>
                  <select id="lg_filter" class="input">
                    <option value="all">الكل</option>
                    <option value="vin">رقم الهيكل</option>
                    <option value="car">السيارة</option>
                    <option value="from">من</option>
                    <option value="to">إلى</option>
                  </select>
                </div>
                <div id="lg_search_box" style="min-width:220px">
                  <div class="small">بحث</div>
                  <input id="lg_search" class="input" placeholder="اكتب رقم الهيكل أو اسم السيارة" />
                </div>
                <div id="lg_from_box" class="hidden" style="min-width:260px">
                  <div class="small">اختار المكان (من)</div>
                  <select id="lg_from_loc" class="input"></select>
                </div>
                <div id="lg_to_box" class="hidden" style="min-width:260px">
                  <div class="small">اختار المكان (إلى)</div>
                  <select id="lg_to_loc" class="input"></select>
                </div>

                <button class="btn primary" id="lg_apply">عرض</button>
                <button class="btn secondary" id="lg_export">تصدير Excel</button>
              </div>

              <div style="margin-top:12px;overflow:auto">
                <table class="table" id="lg_table">
                  <thead>
                    <tr>
                      <th>التاريخ</th>
                      <th>رقم الهيكل</th>
                      <th>السيارة</th>
                      <th>من</th>
                      <th>إلى</th>
                      <th>المكان الحالي (المخزون)</th>
                      <th>اللون الداخلي</th>
                      <th>حساس</th>
                      <th>كاميرا</th>
                      <th>مكيف</th>
                      <th>مسجل</th>
                      <th>شاشة</th>
                      <th>ريموت</th>
                      <th>فرشات</th>
                      <th>طفاية</th>
                      <th>شنطة سلامة</th>
                      <th>اسبير</th>
                      <th>الموافقة المالية</th>
                      <th>الموافقة الادارية</th>
                      <th>منفذ الحركة</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

              <div class="small" id="lg_meta" style="margin-top:10px">—</div>
            </div>
          </div>
        </div>

<!-- Import Modal -->
  <div class="modalBackdrop" id="importModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <h4>استيراد من شيت</h4>
        <button class="btn secondary" id="closeImport">إغلاق</button>
      </div>
      <div class="modalBody">
        <label>اختر ملف Excel</label>
        <input id="importFile" type="file" accept=".xlsx,.xls" />

        <div style="margin-top:10px">
          <label>نوع الاستيراد</label>
          <select id="importMode">
            <option value="replace">استبدال كامل (مسح القديم + إضافة الجديد)</option>
            <option value="append">إضافة فوق الحالي (بدون مسح)</option>
            <option value="update">تحديث من الشيت (تعديل الموجود فقط)</option>
          </select>
        </div>

        <div class="small" id="importPreview" style="margin-top:10px">—</div>
      </div>
      <div class="modalFoot">
        <button class="btn primary" id="runImport" disabled>تنفيذ الاستيراد</button>
        <button class="btn danger" id="clearImport">تفريغ</button>
      </div>
    </div>
  </div>

  <!-- DETAILS MODAL (Checklist + Approvals) -->
  <div class="modalBackdrop" id="detailsModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <h4>عرض المزيد</h4>
        <button class="btn secondary" id="detailsClose">إغلاق</button>
      </div>
      <div class="modalBody" id="detailsBody"></div>
    </div>
  </div>


  <!-- REQUEST DETAILS MODAL -->
  <div class="modalBackdrop" id="reqModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <h4 id="reqModalTitle">تفاصيل الطلب</h4>
        <button class="btn secondary" id="reqClose">إغلاق</button>
      </div>
      <div class="modalBody" id="reqModalBody"></div>
      <div class="modalFoot" id="reqModalFoot"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  
        
  <!-- Dashboard Data Modal -->
  <div class="modalBackdrop" id="dashDataModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <h4 id="dashDataTitle">عرض البيانات</h4>
        <button class="btn secondary" id="dashDataClose">إغلاق</button>
      </div>
      <div class="modalBody">
        <div class="toolbar" style="gap:10px;align-items:flex-end;margin-bottom:10px">
          <div class="field" style="flex:1;min-width:220px">
            <label>بحث</label>
            <input id="dashDataSearch" placeholder="ابحث بـ VIN / السيارة / البيان / المكان / الحالة" autocomplete="off" />
          </div>
          <div class="field" style="min-width:200px">
            <label>&nbsp;</label>
            <button class="btn" id="dashDataExport">تصدير Excel</button>
          </div>
        </div>
        <div id="dashDataMeta" class="muted" style="margin-bottom:10px"></div>
        <div style="overflow:auto;max-height:70vh;border:1px solid var(--line);border-radius:12px;background:#fff">
          <table class="table" style="min-width:1100px">
            <thead>
              <tr>
                <th>(VIN) الهيكل</th>
                <th>السيارة</th>
                <th>البيان</th>
                <th>موديل</th>
                <th>الوكيل</th>
                <th>الداخلي</th>
                <th>الخارجي</th>
                <th>المكان</th>
                <th>الحالة</th>
                <th>الموافقات</th>
              </tr>
            </thead>
            <tbody id="dashDataBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


        <!-- التراكينج -->
        <div class="view" id="view-tracking" role="tabpanel">
          <div class="card" style="padding:16px;">
            <iframe id="trackingFrame" title="Tracking"
              style="width:100%; height:calc(100vh - 260px); border:0; border-radius:12px; background:transparent;"
              loading="lazy"></iframe>

            <!-- محتوى التراكينج (يُحقن داخل الـ iframe لتجنب مشاكل GitHub مع srcdoc الطويل) -->
            <template id="trackingSrc">

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <link rel="icon" type="image/x-icon" href="assets/favicon.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MZJ – تتبع المبيعات</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --text:#111827;
      --muted:#6b7280;
      --radius:16px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#fffdf8 0,#fff3e6 40%,#fbe9da 70%,#f5e3d3 100%);
      color:var(--text);
    }
    .topbar{
      background:var(--brown);
      color:#fff;
      padding:10px 20px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:0 6px 14px rgba(0,0,0,.2);
    }
    .topbar-title{
      font-weight:800;
      letter-spacing:.6px;
      font-size:17px;
    }
    .topbar-right{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
    }
    .logout{
      border:0;
      padding:6px 12px;
      border-radius:999px;
      background:#fff;
      color:var(--brown);
      cursor:pointer;
      font-family:inherit;
      font-size:12px;
    }
    .wrap{
      max-width:1150px;
      margin:22px auto 36px;
      padding:0 14px;
    }
    .card{
      background:#fff;
      border-radius:var(--radius);
      box-shadow:0 16px 40px rgba(62,36,32,.13);
      padding:18px 18px 20px;
      margin-bottom:18px;
    }
    .title{
      margin:0 0 12px 0;
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--brown);
      font-size:18px;
    }
    .title .icon{
      width:26px;
      height:26px;
      border-radius:999px;
      background:rgba(188,143,116,.16);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
    }
    .row{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:10px;
    }
    .col-3{grid-column:span 3;}
    .col-4{grid-column:span 4;}
    .col-6{grid-column:span 6;}
    .col-12{grid-column:span 12;}
    label{
      display:block;
      font-size:13px;
      margin-bottom:4px;
      color:var(--muted);
    }
    input{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-family:inherit;
      font-size:14px;
      outline:none;
    }
    input:focus{
      background:#fff;
      border-color:var(--beige);
      box-shadow:0 0 0 1px rgba(188,143,116,.45);
    }
    select{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-family:inherit;
      font-size:14px;
      outline:none;
      appearance:none;
    }
    select:focus{
      background:#fff;
      border-color:var(--beige);
      box-shadow:0 0 0 1px rgba(188,143,116,.45);
    }
    .btn{
      border:0;
      border-radius:999px;
      padding:8px 16px;
      font-family:inherit;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:14px;
      background:var(--brown);
      color:#fff;
    }
    .btn-outline{
      border-radius:999px;
      border:1px solid var(--brown);
      padding:8px 14px;
      font-family:inherit;
      cursor:pointer;
      background:transparent;
      color:var(--brown);
      font-size:13px;
    }
    .btn:disabled,.btn-outline:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .muted{color:var(--muted);font-size:13px;}
    .hint{color:var(--muted);font-size:12px;margin-top:4px;}
    .ok{color:#047857;font-weight:700;}
    .err{color:#b91c1c;font-weight:700;}
    .badge{
      display:inline-block;
      padding:3px 9px;
      border-radius:999px;
      background:rgba(188,143,116,.16);
      color:var(--brown);
      font-size:11px;
      margin-left:4px;
    }
    .erp-table-wrap{
      margin-top:8px;
      overflow-x:auto;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead{
      background:#f3f4f6;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid #e5e7eb;
      white-space:nowrap;
    }
    th{font-weight:600;color:#374151;text-align:right;}
    td{color:#111827;}
    .grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .stage{
      background:#fffaf3;
      border-radius:12px;
      padding:10px 12px;
      border:1px dashed rgba(188,143,116,.55);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .stage.done{
      background:#ecfdf5;
      border-style:solid;
      border-color:#22c55e;
    }
    .stage-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .stage strong{color:var(--brown);font-size:13px;}
    .stage small{font-size:11px;color:var(--muted);}

    .tabs{
      display:none;
      margin:-8px 0 10px;
      gap:8px;
    }
    .tab-btn{
      padding:6px 14px;
      border-radius:999px;
      border:1px solid transparent;
      background:#f3f4f6;
      color:#374151;
      font-size:13px;
      cursor:pointer;
      font-family:inherit;
    }
    .tab-btn.tab-active{
      background:var(--brown);
      color:#fff;
      border-color:var(--brown);
    }
    .link-btn{
      border:0;
      background:none;
      color:#1d4ed8;
      text-decoration:underline;
      cursor:pointer;
      font-size:13px;
      font-family:inherit;
      padding:0;
    }

    /* Orders list: unread (not opened yet) rows */
    .unread-row td{font-weight:800;}
    .unread-row td .link-btn{font-weight:900;}

    .totals-box{
      margin:6px 0 10px;
      padding:8px 10px;
      border-radius:10px;
      background:#fffaf3;
      border:1px solid rgba(188,143,116,.4);
      font-size:13px;
      color:var(--brown);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .totals-box span{
      white-space:nowrap;
    }

    /* VIN picker box احترافي */
    .vin-box{
      display:none;
      margin:10px 0 14px;
      padding:10px 12px;
      border-radius:12px;
      background:#fffaf3;
      border:1px solid rgba(188,143,116,.6);
    }
    .vin-box-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .vin-box-title{
      font-size:13px;
      font-weight:600;
      color:var(--brown);
    }
    .vin-chip{
      padding:3px 10px;
      border-radius:999px;
      background:rgba(62,36,32,.06);
      font-size:11px;
      color:var(--muted);
    }

    @media(max-width:900px){
      .row{grid-template-columns:1fr;}
      .col-3,.col-4,.col-6,.col-12{grid-column:span 1;}
      .grid-2{grid-template-columns:1fr;}
      .topbar{flex-direction:column;align-items:flex-start;gap:6px;}
      .tabs{flex-wrap:wrap;}
    }
  
/* ===== Admin-like Topbar overrides for Sales ===== */
.topbar{
  position:sticky;
  top:0;
  z-index:1000;
  background:#fff;
  border-bottom:1px solid var(--line, #e5e7eb);
  color:var(--text);
  padding:0; /* override sales padding */
  box-shadow:none; /* override sales shadow */
}
.topbar-inner{
  max-width:1240px;
  margin:auto;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 16px;
  gap:12px;
}
.brand{display:flex;align-items:center;gap:10px}
.brand .logo{
  width:36px;height:36px;border-radius:10px;
  background:linear-gradient(135deg,var(--brown),#2a1613);
  display:grid;place-items:center;color:#fff;font-weight:800;
}
.brand-text h1{margin:0;font-size:18px;color:var(--brown);font-weight:800;line-height:1.1}
.brand-text .hint{color:var(--muted);font-size:12px}

/* Tabs (keep original sales .tabs for page content untouched, target only in topbar) */
.topbar .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start}
.topbar .tab{
  padding:8px 12px;
  border:1px solid var(--line, #e5e7eb);
  border-radius:999px;
  background:#fff;
  text-decoration:none;
  color:var(--text);
  font-weight:800;
  font-size:13px;
}
.topbar .tab.active{background:var(--brown);border-color:var(--brown);color:#fff}

/* Right side actions (avoid .row conflict in sales page) */
.topbar-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
.status-badge{
  display:inline-flex;gap:8px;align-items:center;
  border:1px solid var(--line, #e5e7eb);
  background:#fff;border-radius:12px;padding:6px 10px;font-size:12px
}
.dot{width:10px;height:10px;border-radius:999px;background:#f59e0b}
.dot.ok{background:var(--ok, #16a34a)} .dot.err{background:var(--danger, #ef4444)} .dot.warn{background:#f59e0b}
.whoami{color:var(--muted);font-size:12px;font-weight:700}

/* Button style like admin */
.tb-btn{
  border:1px solid var(--line, #e5e7eb);
  background:#fff;
  border-radius:12px;
  padding:8px 12px;
  cursor:pointer;
  font-weight:800;
  font-size:13px;
}
.tb-btn:hover{transform:translateY(-1px)}
.tb-btn:active{transform:translateY(0)}

@media (max-width:900px){
  .topbar-inner{align-items:flex-start;flex-direction:column}
  .topbar-actions{justify-content:flex-start}
}

</style>
  <link rel="stylesheet" href="./mzj-ui.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

<style>
  /* ===== Sales Safe Refactor: hide legacy topbar ONLY (keep #tabsBar visible) ===== */
  .legacy-sales .topbar,
  .legacy-sales .topbar .tabs,
  .legacy-sales .nav-tabs,
  .legacy-sales .header,
  .legacy-sales header:not(.mzj-topbar){display:none !important;}

  /* Keep content spacing nice */
  .legacy-sales{padding-top: 6px;}
</style>


<style>
  /* Ensure the functional tabs bar (بحث عن طلب / كل الطلبات) is visible when JS enables it */
  .legacy-sales #tabsBar{ display:flex !important; }
  .legacy-sales #tabsBar[style*="display: none"]{ display:none !important; } /* respect JS when it hides */
</style>

<style>
/* Embedded in Workflow Dashboard (Tracking Tab) */
html,body{height:100%;}
body{background:transparent !important;}
/* FIX: remove embedded sales chrome + prevent max-width causing empty space */
.topbar, header, .pagehead, .breadcrumb, .mzj-topbar{display:none !important;}
.wrap{max-width:none !important; margin:0 !important; padding:16px !important;}
/* ensure content uses full width inside iframe */
.legacy-sales, .legacy, .mzj-content{width:100% !important; max-width:none !important;}
/* avoid weird horizontal blank space */
body{overflow-x:hidden !important;}

/* safety: hide any leftover global chrome */
.mzj-topbar,.mzj-sidebar,.mzj-pagehead,#mzjSidebar,#mzjSidebarBtn,.mzj-breadcrumb{display:none !important;}
.mzj-content{padding:0 !important; margin:0 !important;}
.legacy{padding:0 !important; margin:0 !important;}
</style>

<style>
html, body {
  direction: rtl;
  text-align: right;
}
</style>

</head>
<body class="mzj">

  <!-- MZJ Unified Topbar -->
  <div class="mzj-shell" id="mzjShell">
    <main class="mzj-content">
      <div class="legacy legacy-sales">

  
  <!-- Topbar (Matched with Admin) -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" title="MZJ">MZJ</div>
        <div class="brand-text">
          <h1>لوحة تتبع المبيعات</h1>
          <small class="hint">مجموعة محمد بن ذعار العجمي للسيارات</small>
        </div>
      </div>

      <div class="tabs">
        <a class="tab" href="admin.html">الإدارة</a>
        <a class="tab active" href="sales.html">المبيعات</a>
        <a class="tab" href="inventory.html">المخزون</a>
        <a class="tab" href="dashboard.html">الداش بورد</a>
        <a class="tab" href="vt.html">نقل السيارات</a>
        <a class="tab" href="photoshoot-user.html">إدارة الطلبات</a>
        <a class="tab" href="cars.html">كل السيارات</a>
        <a class="tab" href="Activity.html">سجل النشاط</a>
      </div>

      <div class="topbar-actions">
        <div class="status-badge">
          <span class="dot warn" id="connDot"></span>
          <span id="connText">—</span>
        </div>
        <span id="whoami" class="whoami"></span>
        <button id="logoutBtn" class="tb-btn" style="display:none;">تسجيل الخروج</button>
      </div>
    </div>
  </div>
<div class="wrap">

    <!-- Auth -->
    <div class="card" id="authCard">
      <h3 class="title"><span class="icon">🔐</span>تسجيل الدخول</h3>
      <div class="row">
        <div class="col-4">
          <label>البريد الإلكتروني</label>
          <input id="email" type="email" placeholder="user@mzjcars.com" />
        </div>
        <div class="col-4">
          <label>كلمة السر</label>
          <input id="password" type="password" placeholder="••••••••" />
        </div>
        <div class="col-4" style="display:flex;align-items:flex-end;gap:8px;">
          <button class="btn" id="loginBtn">دخول</button>
        </div>
      </div>
      <div id="authMsg" class="muted" style="margin-top:6px;"></div>
      <div class="hint">الدخول مطلوب لإدارة الطلبات وتحديث مراحلها.</div>
    </div>

    <!-- Search -->
    <div class="card" id="orderCard" style="display:none;">
      <h3 class="title"><span class="icon">📄</span>البحث عن طلب</h3>
      <div class="row">
        <div class="col-4">
          <label>رقم الطلب</label>
          <input id="orderId" placeholder="SAL-ORD-2025-01109 أو SAL-ORD-2025-01109_1" />
        </div>
        <div class="col-4" style="display:none;">
          <label>رقم الهيكل (VIN)</label>
          <input id="vinInput" placeholder="اكتب رقم الهيكل (VIN)" />
        </div>
        <div class="col-4" style="display:flex;align-items:flex-end;gap:8px;">
          <button class="btn" id="loadBtn">فتح الطلب</button>
          <button class="btn-outline" id="clearBtn">تفريغ</button>
        </div>
      </div>
      <div id="orderMsg" class="muted" style="margin-top:6px;"></div>
      <div class="hint">اكتب رقم الطلب ثم اضغط فتح الطلب.</div>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="tabsBar">
      <button class="tab-btn tab-active" id="tabSearchBtn">بحث عن طلب</button>
      <button class="tab-btn" id="tabListBtn">كل الطلبات</button>
      <button class="tab-btn" id="tabArchiveBtn">الأرشيف</button>
    </div>

    <!-- ERP details -->
    <div class="card" id="erpCard" style="display:none;">
      <h3 class="title">
        <span class="icon">📊</span>
        تفاصيل الطلب من نظام المبيعات (ERP)
      </h3>
      <div id="erpMeta" class="muted" style="margin-bottom:6px;"></div>
      <!-- اختيار رقم الهيكل لو الطلب فيه أكثر من VIN -->
      <div id="vinPickerBox" class="vin-box">
        <div class="vin-box-header">
          <div class="vin-box-title">اختر رقم الهيكل للعمل عليه</div>
          <div class="vin-chip" id="vinCountChip"></div>
        </div>
        <select id="vinPicker"></select>
        <div class="hint">أي تحديث في مراحل تتبع الطلب سيكون لهذا رقم الهيكل فقط.</div>
        <button id="trackLinkBtn" class="btn" type="button" style="margin-top:8px;width:100%;">رابط التتبع</button>
        <button id="trackQrBtn" class="btn-outline" type="button" style="margin-top:8px;width:100%;">QR التتبع (اضغط لفتح)</button>
      </div>

      <div id="erpTotals" class="totals-box" style="display:none;"></div>
      <div class="erp-table-wrap">
        <table>
          <thead>
          <tr>
            <th>اسم العميل</th>
            <th>الرقم الضريبي للعميل</th>
            <th>رقم جوال العميل</th>
            <th>الفرع</th>
            <th>تاريخ الطلب</th>
            <th>تاريخ التسليم</th>
            <th>مسؤول المبيعات</th>
            <th>رقم الصنف</th>
            <th>نوع الصنف</th>
            <th>فئة الصنف</th>
            <th>الموديل</th>
            <th>رقم الهيكل VIN</th>
            <th>اللون الداخلي</th>
            <th>اللون الخارجي</th>
            <th>الوكيل</th>
            <th>الكمية</th>
            <th>سعر الوحدة</th>
            <th>قيمة الصنف</th>
            <th>كود الضريبة</th>
            <th>نوع الضريبة</th>
            <th>نسبة الضريبة</th>
            <th>قيمة الضريبة</th>
            <th>الإجمالي قبل الضريبة</th>
            <th>الإجمالي شامل الضريبة</th>
          </tr>
          </thead>
          <tbody id="erpBody">
          </tbody>
        </table>
      </div>
    </div>

    <!-- Orders list tab -->
    <div class="card" id="ordersListCard" style="display:none;">
      <h3 class="title"><span class="icon">📋</span>كل الطلبات</h3>
      <div class="hint">اضغط على رقم الطلب لفتحه، واختيار رقم الهيكل من الأعلى لو كان أكثر من سيارة.</div>
      <div class="row" style="margin-top:10px;">
        <div class="col-6">
          <label>بحث سريع</label>
          <input id="ordersSearch" placeholder="اكتب اسم العميل / رقم الجوال / رقم الهيكل (VIN) / رقم الطلب" />
          <div class="hint">تقدر تبحث بأي جزء من البيانات.</div>
        </div>
      </div>
      <div class="erp-table-wrap">
        <table>
          <thead>
          <tr>
            <th>رقم الطلب</th>
            <th>اسم العميل</th>
            <th>رقم الجوال</th>
            <th>الفرع</th>
            <th>رقم الهيكل VIN</th>
          </tr>
          </thead>
          <tbody id="ordersListBody"></tbody>
        </table>
      </div>
    </div>

    
    <!-- Archive list tab -->
    <div class="card" id="archivesListCard" style="display:none;">
      <h3 class="title"><span class="icon">🗄️</span>الأرشيف</h3>
      <div class="hint">هنا تظهر الطلبات المؤرشفة. اضغط على رقم الطلب لعرض تفاصيله (قراءة فقط).</div>
      <div class="row" style="margin-top:10px;">
        <div class="col-6">
          <label>بحث سريع</label>
          <input id="archivesSearch" placeholder="اكتب رقم الطلب / اسم العميل / رقم الجوال" />
          <div class="hint">البحث داخل الأرشيف فقط.</div>
        </div>
      </div>
      <div class="erp-table-wrap">
        <table>
          <thead>
          <tr>
            <th>رقم الطلب</th>
            <th>اسم العميل</th>
            <th>رقم الجوال</th>
            <th>الفرع</th>
            <th>تاريخ الأرشفة</th>
          </tr>
          </thead>
          <tbody id="archivesListBody"></tbody>
        </table>
      </div>
    </div>

<!-- Stages -->
    <div class="card" id="stagesCard" style="display:none;">
      <h3 class="title"><span class="icon">🚦</span>مراحل تتبع الطلب</h3>
      <div class="grid-2" id="stagesList"></div>
      <div class="hint" style="margin-top:8px;">
        اضغط على <strong>تم الانتهاء</strong> أمام أي مرحلة ليتم ختمها وتحديث صفحة تتبع العميل تلقائياً.  
        بعد ختم جميع المراحل لهذا الهيكل لا يمكن تعديلها مرة أخرى.
      </div>
      <!-- Archive actions -->
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-start;width:100%;margin:10px 0 0;">
        <button id="archiveOrderBtn" class="btn-outline" type="button" style="font-size:12px;">
          <i class="fa-solid fa-box-archive"></i> أرشفة الطلب
        </button>
        <button id="unarchiveOrderBtn" class="btn-outline" type="button" style="font-size:12px;display:none;">
          <i class="fa-solid fa-rotate-left"></i> إلغاء الأرشفة
        </button>
        <span id="archiveHint" class="muted" style="font-size:12px;"></span>
      </div>

      
      <div class="muted" id="stageMsg" style="margin-top:6px;"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      deleteField,
      deleteDoc,
      serverTimestamp,
      collection,
      query,
      where,
      getDocs,
      orderBy,
      limit,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.firebasestorage.app",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66"
    };

    const ERP_COLLECTION      = "erp_orders";
    const ERP_VINS_COLLECTION = "erp_vins";
    const TRACK_COLLECTION    = "orders";
    const ARCHIVE_COLLECTION  = "sales_archives";

    // ✅ API base (separate project) for WhatsApp/Mersal serverless routes
    const MZJ_TRACKING_API_BASE = window.location.origin; // نفس الدومين (mzj-workflow)

    const ERP_FIELDS = [
      "CustomerName","CustomerVAT","CustomerPhone","Branch","OrderDate","DeliveryDate","SalesPerson",
      "ItemNo","ItemType","ItemCategory","ItemModel","VIN","InteriorColor","ExteriorColor","Dealer",
      "Qty","UnitPrice","ItemValue","TaxCode","TaxName","TaxRate","TaxValue","SubtotalExclVAT","TotalInclVAT"
    ];

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    window.auth = auth;
    const db = getFirestore(app);

    // UI refs
    const authCard   = document.getElementById("authCard");
    const orderCard  = document.getElementById("orderCard");
    const erpCard    = document.getElementById("erpCard");
    const stagesCard = document.getElementById("stagesCard");
    const whoami     = document.getElementById("whoami");
    const logoutBtn  = document.getElementById("logoutBtn");

    const tabsBar      = document.getElementById("tabsBar");
    const tabSearchBtn = document.getElementById("tabSearchBtn");
    const tabListBtn   = document.getElementById("tabListBtn");
    const ordersListCard  = document.getElementById("ordersListCard");
    const ordersListBody  = document.getElementById("ordersListBody");
    const tabArchiveBtn = document.getElementById("tabArchiveBtn");
    const archivesListCard = document.getElementById("archivesListCard");
    const archivesListBody = document.getElementById("archivesListBody");
    const archivesSearchInput = document.getElementById("archivesSearch");
    let archivesListCache = [];
    let currentIsArchiveView = false;


    const ordersSearchInput = document.getElementById("ordersSearch");
    let ordersListCache = [];
    let ordersReadSet = new Set();

    let archiveSet = new Set();
    let archiveLoaded = false;


    const email      = document.getElementById("email");
    const password   = document.getElementById("password");
    const loginBtn   = document.getElementById("loginBtn");
    const signupBtn  = document.getElementById("signupBtn");
    const authMsg    = document.getElementById("authMsg");

    const orderIdInput = document.getElementById("orderId");
    const vinInput     = document.getElementById("vinInput");
    const loadBtn      = document.getElementById("loadBtn");
    const clearBtn     = document.getElementById("clearBtn");
    const orderMsg     = document.getElementById("orderMsg");

    const erpMetaEl    = document.getElementById("erpMeta");
    const erpBody      = document.getElementById("erpBody");
    const erpTotals    = document.getElementById("erpTotals");
    const archiveOrderBtn = document.getElementById("archiveOrderBtn");
    const unarchiveOrderBtn = document.getElementById("unarchiveOrderBtn");
    const archiveHint = document.getElementById("archiveHint");


    const vinPickerBox = document.getElementById("vinPickerBox");
    const vinPicker    = document.getElementById("vinPicker");
    const vinCountChip = document.getElementById("vinCountChip");
    const trackLinkBtn = document.getElementById("trackLinkBtn");

    const stagesList   = document.getElementById("stagesList");
    const stageMsg     = document.getElementById("stageMsg");

    let currentOrderId      = null;
    let currentVin          = null;
    let currentItemNo       = null;
    let currentOrderRecords = [];
    let currentCustomerPhone = ""; // رقم جوال العميل
    // بيانات نحتاجها لقالب واتساب (tracking_message)
    let currentCustomerName = "";
    let currentOrderCarsCount = 0;
    let currentCarsSubtotal = "";
    let currentCarsTax = "";
    let currentRegFee = "";
    let currentGrandTotalIncl = "";
    let currentTrackingLink = "";

    let currentTrackData = null;
    let currentStagesObjCache = {};

    const STAGES = [
      "1) طلب الشراء (خاص بالعميل)",
      "2) إيصال الدفع (خاص بالعميل)",
      "3) التواصل من قِبل ممثلي خدمة العملاء بإرسال البطاقة الجركية (خاص بالمعرض)",
      "4) سداد رسوم التسجيل (خاص بالعميل)",
      "5) التأمين – شرط الربط على السيستم (خاص بالعميل)",
      "6) استيفاء المبالغ المتبقية (خاص بالعميل)",
      "7) استيفاء الأوراق المتبقية (خاص بالعميل)",
      "8) إصدار اللوحات أو نقل الملكية (خاص بالمعرض)",
      "9) جاهزية السيارة للاستلام (خاص بالمعرض)",
      "10) إتمام عملية التسليم بنجاح"
    ];

    const FIELD_SYNONYMS = {
      CustomerName: ["CustomerName","customerName"],
      CustomerVAT:  ["CustomerVAT","customerVat","customerVAT"],
      CustomerPhone:["CustomerPhone","customerPhone","customer_phone","contact_mobile"],
      Branch:       ["Branch","branch"],
      OrderDate:    ["OrderDate","orderDate"],
      DeliveryDate: ["DeliveryDate","deliveryDate"],
      SalesPerson:  ["SalesPerson","salesPerson"],

      ItemNo:       ["ItemNo","itemNo","no"],
      ItemType:     ["ItemType","itemType","type"],
      ItemCategory: ["ItemCategory","itemCategory","category"],
      ItemModel:    ["ItemModel","itemModel","model"],

      VIN:          ["VIN","vin"],

      InteriorColor:["InteriorColor","interiorColor"],
      ExteriorColor:["ExteriorColor","exteriorColor"],
      Dealer:       ["Dealer","dealer"],

      Qty:          ["Qty","qty"],
      UnitPrice:    ["UnitPrice","unitPrice"],
      ItemValue:    ["ItemValue","itemValue","value"],

      TaxCode:         ["taxCode","TaxCode"],
      TaxName:         ["taxName","TaxName"],
      TaxRate:         ["taxRate","TaxRate","vatRate","VATRate","tax_rate","vat_rate","rate","VAT"],
      TaxValue:        ["taxValue", "TaxValue", "vatAmount", "VATAmount", "vat_amount", "vatAmount", "vatValue", "VATValue", "tax_amount", "taxAmount", "taxValueAmount", "vat", "carTaxValue", "car_tax_value"],
      SubtotalExclVAT: ["subtotalExclVAT", "SubtotalExclVAT", "subtotalExclVat", "subtotal_excl_vat", "subtotalBeforeVat", "SubtotalBeforeVat", "netTotal", "net_total", "amountBeforeTax", "amount_before_tax", "subtotal", "net", "carSubtotalExclVAT", "car_subtotal_excl_vat"],
      TotalInclVAT:    ["totalInclVAT", "TotalInclVAT", "totalInclVat", "total_incl_vat", "grandTotal", "GrandTotal", "grand_total", "total", "Total", "amountAfterTax", "amount_after_tax", "carTotalInclVAT", "car_total_incl_vat"],

      // ✅ على مستوى الطلب (رسوم التسجيل/إجمالي الطلب)
      RegistrationFee: ["registrationFee","RegistrationFee"],
      SubtotalBeforeTax:["subtotalBeforeTax","SubtotalBeforeTax"],
      GrandTotal:      ["grandTotal","GrandTotal"]
    };

    function buildCandidates(name) {
      const syns = FIELD_SYNONYMS[name] || [name];
      const arr = [];
      syns.forEach(s => {
        if (!s) return;
        arr.push(s);
        arr.push(s.toLowerCase());
        arr.push(s.toUpperCase());
      });
      return Array.from(new Set(arr));
    }

    function lookupIn(obj, candidates) {
      if (!obj) return undefined;
      for (const key of candidates) {
        if (Object.prototype.hasOwnProperty.call(obj, key) && obj[key] !== undefined) {
          return obj[key];
        }
      }
      return undefined;
    }

    function getFieldFlex(fieldName, data) {
      if (!data) return "-";
      const candidates = buildCandidates(fieldName);

      let v = lookupIn(data, candidates);
      if (v !== undefined) return v;

      v = lookupIn(data.item, candidates);
      if (v !== undefined) return v;

      v = lookupIn(data.totals, candidates);
      if (v !== undefined) return v;

      // ✅ دعم مخططات أقدم: بعض الداتا بتكون تحت taxes أو summary
      v = lookupIn(data.taxes, candidates);
      if (v !== undefined) return v;

      v = lookupIn(data.summary, candidates);
      if (v !== undefined) return v;

      return "-";
    }

    function parseAmountFront(value) {
      if (value === null || value === undefined || value === "-") return null;
      if (typeof value === "number") return value;
      const s = String(value)
        .replace(/[^\d.,\-]/g, "")
        .replace(/,/g, "");
      const n = parseFloat(s);
      return isNaN(n) ? null : n;
    }

    
    // تنسيق رقم الجوال لصيغة سعودية 966
        function normalizeSaudiPhone(raw) {
      if (!raw) return "";

      let digits = String(raw).trim();

      // شيل أي حاجة غير أرقام
      digits = digits.replace(/[^\d]/g, "");

      // 009665xxxxxxxx → 9665xxxxxxxx
      if (digits.startsWith("00")) {
        digits = digits.slice(2);
      }

      // 05xxxxxxxx → 9665xxxxxxxx
      if (digits.startsWith("05")) {
        digits = "966" + digits.slice(1);
      }

      // 5xxxxxxxx → 9665xxxxxxxx
      if (digits.length === 9 && digits.startsWith("5")) {
        digits = "966" + digits;
      }

      // تأكيد نهائي
      if (!digits.startsWith("9665") || digits.length !== 12) {
        return "";
      }

      return digits;
    }
// ===== PLUS CHANNELS (WhatsApp+ & SMS+) =====

// فتح واتساب ويب/ديسكتوب بنفس نص الرسالة
function openWhatsAppPlus(stageNum, stageLabel){
  stageMsg.textContent = "";

  if (!currentCustomerPhone) {
    stageMsg.innerHTML = "<span class='err'>لا يوجد رقم جوال محفوظ لهذا الطلب.</span>";
    return;
  }

  const phone = normalizeSaudiPhone(currentCustomerPhone);
  if (!phone) {
    stageMsg.innerHTML = "<span class='err'>رقم الجوال غير صالح.</span>";
    return;
  }

  const text = getDefaultStageMessage(stageNum, stageLabel) || "";
  const waUrl = `https://web.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(text)}`;

  // نسخ احتياطي للنص
  if (navigator.clipboard) navigator.clipboard.writeText(text).catch(()=>{});

  window.open(waUrl, "_blank", "noopener,noreferrer");
}

// ====== SMS+ API ======
const API_BASE = "https://mzj-workflow.vercel.app";

// SMS+ (يرسل المهمة إلى Vercel/Firestore عشان الموبايل الأندرويد يبعتها SMS من شريحتك)
async function openSmsPlus(stageNum, stageLabel){
  try {
    // ✅ حماية من كسر الصفحة لو stageMsg مش موجود
    const msgEl = (typeof stageMsg !== "undefined" && stageMsg) ? stageMsg : null;
    const setMsg = (html) => { if (msgEl) msgEl.innerHTML = html; };

    if (msgEl) msgEl.textContent = "";

    if (!window.currentCustomerPhone) {
      setMsg("<span class='err'>لا يوجد رقم جوال محفوظ لهذا الطلب.</span>");
      return;
    }

    // ✅ حماية لو normalizeSaudiPhone مش موجودة
    const phone = (typeof normalizeSaudiPhone === "function")
      ? normalizeSaudiPhone(window.currentCustomerPhone)
      : String(window.currentCustomerPhone || "").trim();

    if (!phone) {
      setMsg("<span class='err'>رقم الجوال غير صالح.</span>");
      return;
    }

    const text = (typeof getDefaultStageMessage === "function")
      ? (getDefaultStageMessage(stageNum, stageLabel) || "")
      : "";

    // لازم المستخدم يكون مسجل دخول (عشان نرسل ID Token للـ API)
    if (!auth || !auth.currentUser) {
      setMsg("<span class='err'>لازم تسجل دخول الأول.</span>");
      return;
    }

    const idToken = await auth.currentUser.getIdToken();

    // ✅ استخدم API_BASE بدل /api... عشان يشتغل حتى لو الصفحة على دومين مختلف
    const res = await fetch(`${API_BASE}/api/sms/enqueue`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + idToken
      },
      body: JSON.stringify({
        phone,
        message: text,
        source: "sales.html",
        meta: {
          stageNum: Number(stageNum)||null,
          stageLabel: String(stageLabel||""),
          orderId: String(window.currentOrderId||""),
          vin: String(window.currentVin||"")
        }
      })
    });

    const dataText = await res.text();
    if(!res.ok){
      throw new Error(dataText || ("HTTP " + res.status));
    }

    let data;
    try{ data = JSON.parse(dataText); }catch{ data = { ok:true, raw:dataText }; }

    if(data && data.ok){
      setMsg("<span class='ok'>تم إرسال الطلب للطابور ✅ (SMS+)</span>");
    }else{
      setMsg("<span class='err'>تعذر إضافة الرسالة للطابور.</span>");
    }

  } catch(e){
    console.error(e);
    if (typeof stageMsg !== "undefined" && stageMsg) {
      stageMsg.innerHTML =
        "<span class='err'>تعذر إرسال SMS+ للطابور: " +
        String(e && (e.message||e)).slice(0,240) +
        "</span>";
    }
  }
}


    
    // ===== Message Templates (shared for SMS + WhatsApp) =====
    function getDefaultStageMessage(stageNum, stageLabel){
      const orderNo = currentOrderId || "";
      const vin = currentVin || "";
      const trackingLink = vin ? `https://mzj-tracking.vercel.app/Test-Track.html?vin=${vin}` : "";

      switch(stageNum){
        case 1: {
          // ✅ رسالة ملخص الطلب (ديناميكية حسب الطلب) — بدون بيانات سيارة فردية
          const rec0 = (currentOrderRecords && currentOrderRecords.length) ? currentOrderRecords[0] : {};
          const customerName = getFieldFlex("CustomerName", rec0) || "";

          // VIN المختار فقط للرابط (نقطة دخول للتتبع)
          const vinForLink = vin || "";
          const trackingLink2 = vinForLink ? `https://mzj-tracking.vercel.app/Test-Track.html?vin=${vinForLink}` : "";

          // رسوم التسجيل (إجمالي الطلب)
          const regFeeNum = (() => {
            const v = getFieldFlex("RegistrationFee", rec0);
            const n = parseAmountFront(v);
            return (n !== null && n > 0) ? n : 0;
          })();

          const rows = (currentOrderRecords && currentOrderRecords.length) ? currentOrderRecords : [];
          const totalCars = rows.length || 0;

          let carsSubtotal = 0;
          let carsTax = 0;

          rows.forEach(r => {
            const subVal = parseAmountFront(getFieldFlex("SubtotalExclVAT", r));
            const taxVal = parseAmountFront(getFieldFlex("TaxValue", r));
            if (subVal !== null) carsSubtotal += subVal;
            if (taxVal !== null) carsTax += taxVal;
          });

          // fallback لو السطور مش كاملة
          if (carsSubtotal === 0 && carsTax === 0) {
            const headerSubBT = parseAmountFront(getFieldFlex("SubtotalBeforeTax", rec0));
            const headerTax   = parseAmountFront(getFieldFlex("TaxValue", rec0));
            if (headerSubBT !== null) carsSubtotal = Math.max(0, (headerSubBT || 0) - (regFeeNum || 0));
            if (headerTax !== null)   carsTax = headerTax || 0;
          }

          const grandTotalIncl = (carsSubtotal + carsTax) + (regFeeNum || 0);

          const fmt = (n) => (n || 0).toLocaleString("ar-SA", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

          // ✅ تخزين القيم للقالب (tracking_message)
          currentCustomerName = customerName || "";
          window.currentCustomerName = currentCustomerName;
          currentOrderCarsCount = totalCars || 0;
          currentCarsSubtotal = fmt(carsSubtotal);
          currentCarsTax = fmt(carsTax);
          currentRegFee = fmt(regFeeNum || 0);
          currentGrandTotalIncl = fmt(grandTotalIncl);
          currentTrackingLink = trackingLink2 || "";

          return (
`عميلنا العزيز / ${customerName}\n` +
`مرحباً بكم في مجموعة محمد ذعار العجمي للسيارات\n\n` +
`تم تسجيل طلب شرائكم بنجاح ✅\n\n` +
`عدد السيارات: ${totalCars}\n` +
`الإجمالي قبل الضريبة: ${fmt(carsSubtotal)} ر.س\n` +
`قيمة الضريبة: ${fmt(carsTax)} ر.س\n` +
(regFeeNum > 0 ? (`رسوم التسجيل: ${fmt(regFeeNum)} ر.س\n`) : ``) +
`الإجمالي شامل الضريبة: ${fmt(grandTotalIncl)} ر.س\n\n` +
`يمكنكم متابعة حالة الطلب عبر الرابط التالي:\n` +
`${trackingLink2}\n\n` +
`مع مجموعة محمد ذعار العجمي للسيارات\n` +
`أنت نجم الطريق ⭐\n` +
`📞 920014635\n` +
`رابط التواصل واتساب\n` +
`https://api.whatsapp.com/send?phone=966920014635`



          );
        }
     case 9:
  return (
    `عميلنا العزيز يسعدنا إبلاغك بجاهزية سيارتك،\n` +
    `الآن يمكنك التوجه للاستلام أو طلب خدمة الشحن.\n\n` +
    `مواعيد العمل:\n` +
    `*الفترة الصباحية*\n` +
    `من الساعة 9 صباحاً إلى 11 صباحاً\n` +
    `عدا يوم الجمعة\n\n` +
    `*الفترة المسائية*\n` +
    `من الساعة 4 مساءً إلى 9 مساءً\n` +
    `جميع أيام الأسبوع\n\n` +
    `مع مجموعة محمد ذعار العجمي للسيارات\n` +
    `أنت نجم الطريق ⭐\n\n` +
    `📞 920014635\n` +
    `رابط التواصل واتساب\n` +
    `https://api.whatsapp.com/send?phone=966920014635`
  );

        case 10:
  return (
    `عميلنا العزيز\n` +
    `نبارك لكم إتمام عملية التسليم بنجاح\n\n` +
    `*شكراً لثقتكم ونتمنى لكم قيادة آمنة وتجربة ممتعة*\n\n` +
    `مع مجموعة محمد ذعار العجمي للسيارات\n` +
    `أنت نجم الطريق ⭐\n\n` +
    `📞 920014635\n` +
    `رابط التواصل واتساب\n` +
    `https://api.whatsapp.com/send?phone=966920014635`
  );



        default:
          return `عميلنا العزيز، بخصوص طلبكم رقم ${orderNo}.\nمعرض محمد بن ذعار العجمي للسيارات.`;
      }
    }

    // ===== Modal: Edit before send =====
    const msgModal        = document.getElementById("msgModal");
    const msgModalBackdrop= document.getElementById("msgModalBackdrop");
    const msgModalClose   = document.getElementById("msgModalClose");
    const msgModalTitle   = document.getElementById("msgModalTitle");
    const msgModalSub     = document.getElementById("msgModalSub");
    const msgModalText    = document.getElementById("msgModalText");
    const msgModalSend    = document.getElementById("msgModalSend");
    const msgModalReset   = document.getElementById("msgModalReset");
    const msgModalCopy    = document.getElementById("msgModalCopy");
    const msgModalMsg     = document.getElementById("msgModalMsg");
    const msgModalChannel = document.getElementById("msgModalChannel");
    const msgModalPhone   = document.getElementById("msgModalPhone");
    const msgModalVin     = document.getElementById("msgModalVin");

    let modalCtx = { channel:"sms", stageNum:0, stageLabel:"", defaultText:"" };

    function closeMessageModal(){
      if(!msgModal) return;
      msgModal.style.display = "none";
      msgModalMsg.textContent = "";
      msgModalSend.disabled = false;
    }
    function openMessageModal(channel, stageNum, stageLabel){
      stageMsg.textContent = "";
      if (!currentCustomerPhone) {
        stageMsg.innerHTML = "<span class='err'>لا يوجد رقم جوال محفوظ لهذا الطلب.</span>";
        return;
      }
      const phone = normalizeSaudiPhone(currentCustomerPhone);
      if (!phone) {
        stageMsg.innerHTML = "<span class='err'>رقم الجوال غير صالح.</span>";
        return;
      }

      const defText = getDefaultStageMessage(stageNum, stageLabel);

      modalCtx = { channel, stageNum, stageLabel, defaultText: defText };

      msgModalTitle.textContent = (channel === "whatsapp") ? "إرسال واتساب للعميل" : "إرسال SMS للعميل";
      msgModalSub.textContent = `المرحلة ${stageNum}: ${stageLabel || ""}`;
      msgModalText.value = defText;

      msgModalChannel.textContent = (channel === "whatsapp") ? "WhatsApp" : "SMS";
      msgModalPhone.textContent = phone ? ("966…" + phone.slice(-3)) : "—";
      msgModalVin.textContent = (currentVin ? ("VIN: " + currentVin) : "VIN: —");

      msgModal.style.display = "block";
      setTimeout(() => msgModalText.focus(), 50);
    }

    if (msgModalBackdrop) msgModalBackdrop.addEventListener("click", closeMessageModal);
    if (msgModalClose) msgModalClose.addEventListener("click", closeMessageModal);

    if (msgModalReset) msgModalReset.addEventListener("click", () => {
      msgModalText.value = modalCtx.defaultText || "";
      msgModalMsg.innerHTML = "<span class='muted'>تم الرجوع للنص الأصلي.</span>";
      setTimeout(()=> msgModalMsg.textContent="", 1200);
    });

    if (msgModalCopy) msgModalCopy.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(msgModalText.value || "");
        msgModalMsg.innerHTML = "<span class='ok'>تم نسخ النص.</span>";
      }catch(e){
        msgModalMsg.innerHTML = "<span class='err'>تعذر نسخ النص.</span>";
      }
      setTimeout(()=> msgModalMsg.textContent="", 1200);
    });

    async function sendWhatsAppFreeText(phone, text, stageNum){
      // ✅ Send via Mersal WhatsApp API (server-side in mzj-tracking project)
      return fetch(`${MZJ_TRACKING_API_BASE}/api/mersal-wa`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          phone: String(phone || "").trim(),     // must be like 9665xxxxxxxx
          message: String(text || ""),
          stageNum: stageNum ?? null,
          orderId: window.__mzj_current_order_id || ""
        })
      }).then(async (res)=>{
        const bodyText = await res.text();
        if(!res.ok) throw new Error(bodyText || ("HTTP " + res.status));
        try { return JSON.parse(bodyText); } catch { return { ok:true, raw: bodyText }; }
      });
    }

    async function sendWhatsAppTemplate(phone, templateName, templateLanguage, bodyParams, stageNum){
      // ✅ Template-based WhatsApp message via mzj-tracking project
      // Expects a serverless route: /api/mersal-wa-template
      return fetch(`${MZJ_TRACKING_API_BASE}/api/mersal-wa-template`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          phone: String(phone || "").trim(),
          template_name: String(templateName || "").trim(),
          template_language: String(templateLanguage || "ar").trim(),
          body_params: Array.isArray(bodyParams) ? bodyParams : [],
          stageNum: stageNum ?? null,
          orderId: window.__mzj_current_order_id || ""
        })
      }).then(async (res)=>{
        const bodyText = await res.text();
        if(!res.ok) throw new Error(bodyText || ("HTTP " + res.status));
        try { return JSON.parse(bodyText); } catch { return { ok:true, raw: bodyText }; }
      });
    }

    

    // Direct send for Step 1 ONLY (same logic as send temp bay ajax.html)
    // NOTE: Token is embedded client-side by request.
    const MERSAL_DIRECT_TOKEN_STEP1 = "N47Nm9eP20Ppctd3RmM6EBiM5b7dAaoljMHVJyns16b42721";

    async function sendWhatsAppTemplateDirectStep1(phone, bodyParams){
      return fetch("https://w-mersal.com/api/wpbox/sendtemplatemessage", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          token: MERSAL_DIRECT_TOKEN_STEP1,
          phone: String(phone || "").trim(),
          template_name: "tracking_message",
          template_language: "ar",
          components: [
            {
              type: "body",
              parameters: (Array.isArray(bodyParams) ? bodyParams : []).map(v => ({
                type: "text",
                text: String(v ?? "")
              }))
            }
          ]
        })
      }).then(async (res)=>{
        const bodyText = await res.text();
        if(!res.ok) throw new Error(bodyText || ("HTTP " + res.status));
        try { return JSON.parse(bodyText); } catch { return ({ ok:true, raw: bodyText }); }
      });
    }
function toEnglishDigits(str) {
      return String(str)
        .replace(/[٠-٩]/g, d => "0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(d)])
        .replace(/[٬]/g, ",")
        .replace(/[٫]/g, ".")
        .replace(/\u00A0/g, " ");
    }
    function safeParam(v, fallback = "0"){
      const s = (v === null || v === undefined) ? "" : String(v);
      const cleaned = toEnglishDigits(s).trim();
      return cleaned ? cleaned : fallback;
    }

    function buildTrackingTemplateParams(){
      // mapping for template tracking_message: {{1}}..{{7}}
      const customerName = safeParam((currentCustomerName || "").trim(), "عميلنا العزيز");
      const totalCars    = safeParam(currentOrderCarsCount, "0");
      const subtotal     = safeParam(currentCarsSubtotal, "0");
      const tax          = safeParam(currentCarsTax, "0");
      const regFee       = safeParam(currentRegFee, "0"); // ✅ ممنوع يبقى فاضي
      const totalIncl    = safeParam(currentGrandTotalIncl, "0");
      const trackingLink = safeParam(currentTrackingLink, "https://mzj-tracking.vercel.app/");

      return [customerName, totalCars, subtotal, tax, regFee, totalIncl, trackingLink];
    }

    async function sendWhatsAppMessage(phone, text, stageNum){
      // ✅ Stage 1/9/10 = قوالب واتساب (Templates) — باقي المراحل نص حر
      const st = Number(stageNum);

      if (st === 1){
        const params = buildTrackingTemplateParams();
        // Step 1 uses direct Mersal send (to fix delivery)
        return sendWhatsAppTemplateDirectStep1(phone, params);
      }

      if (st === 9){
        // قالب: السيارة جاهزة للتسليم
        return sendWhatsAppTemplate(phone, "mzj_car_ready_delivery", "ar", [], st);
      }

      if (st === 10){
        // قالب: تم التسليم
        return sendWhatsAppTemplate(phone, "mzj_delivery_completed", "ar", [], st);
      }

      return sendWhatsAppFreeText(phone, text, st);
    }


    if (msgModalSend) msgModalSend.addEventListener("click", async () => {
      msgModalMsg.textContent = "";
      msgModalSend.disabled = true;

      const phone = normalizeSaudiPhone(currentCustomerPhone);
      const msg = (msgModalText.value || "").trim();

      try{
        if (modalCtx.channel === "whatsapp") {
          await sendWhatsAppMessage(phone, msg, modalCtx.stageNum);
          msgModalMsg.innerHTML = "<span class='ok'>تم إرسال الرسالة من الرقم الموحد عبر واتساب API.</span>";
        } else {
          await sendStcSmsForStage(modalCtx.stageNum, modalCtx.stageLabel, msg);
          // sendStcSmsForStage writes to stageMsg; mirror here too:
          msgModalMsg.innerHTML = "<span class='ok'>تم إرسال SMS (أو تم تنفيذ محاولة الإرسال).</span>";
        }
      }catch(e){
        console.error(e);
        msgModalMsg.innerHTML = "<span class='err'>حصل خطأ أثناء الإرسال: " + String(e && (e.message||e)).slice(0,180) + "</span>";
      }finally{
        msgModalSend.disabled = false;
      }
    });

    // ===== Dynamic QR (click to open tracking) =====
    const trackQrBtn = document.getElementById("trackQrBtn");
    const trackQrModal = document.getElementById("trackQrModal");
    const trackQrBackdrop = document.getElementById("trackQrBackdrop");
    const trackQrClose = document.getElementById("trackQrClose");
    const trackQrImg = document.getElementById("trackQrImg");
    const trackQrLink = document.getElementById("trackQrLink");
    const trackQrCopy = document.getElementById("trackQrCopy");

    function getTrackingUrl(){
      return currentVin ? `https://mzj-tracking.vercel.app/Test-Track.html?vin=${encodeURIComponent(currentVin)}` : "";
    }

    function refreshTrackingQr(){
      const url = getTrackingUrl();
      if(!trackQrImg || !trackQrLink) return;

      if(!url){
        trackQrImg.src = "";
        trackQrLink.href = "#";
        trackQrImg.style.opacity = .4;
        return;
      }

      // Use a reliable QR image endpoint (no library needed)
      const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=" + encodeURIComponent(url);
      trackQrImg.src = qrUrl;
      trackQrLink.href = url;
      trackQrImg.style.opacity = 1;
    }

    function openTrackQr(){
      if(!currentVin){
        alert("اختر رقم الهيكل أولاً.");
        return;
      }
      refreshTrackingQr();
      if(trackQrModal) trackQrModal.style.display = "block";
    }
    function closeTrackQr(){
      if(trackQrModal) trackQrModal.style.display = "none";
    }

    if (trackQrBtn) trackQrBtn.addEventListener("click", openTrackQr);
    if (trackQrBackdrop) trackQrBackdrop.addEventListener("click", closeTrackQr);
    if (trackQrClose) trackQrClose.addEventListener("click", closeTrackQr);

    if (trackQrCopy) trackQrCopy.addEventListener("click", async () => {
      const url = getTrackingUrl();
      if(!url) return;
      try{
        await navigator.clipboard.writeText(url);
        alert("تم نسخ رابط التتبع");
      }catch(e){
        alert("تعذر نسخ الرابط");
      }
    });


    // إرسال SMS عبر endpoint /api/stc-sms
   async function sendStcSmsForStage(stageNum, stageLabel, messageOverride=null) {
  stageMsg.textContent = "";

  if (!currentCustomerPhone) {
    stageMsg.innerHTML = "<span class='err'>لا يوجد رقم جوال محفوظ لهذا الطلب.</span>";
    return;
  }

  const phone = normalizeSaudiPhone(currentCustomerPhone);
  if (!phone) {
    stageMsg.innerHTML = "<span class='err'>رقم الجوال غير صالح.</span>";
    return;
  }

  const orderNo = currentOrderId || "";
  const vin = currentVin || "";
  const trackingLink = vin ? `https://mzj-tracking.vercel.app/Test-Track.html?vin=${vin}` : "";

  let text = "";

  switch (stageNum) {

    // -------------------------
    // 1️⃣ الخطوة رقم 1 — تهنئة + رابط التتبع
    // -------------------------
    case 1: {
      // ✅ قيمة السيارة = للهيكل المختار فقط (مش إجمالي الطلب)
      const rec = (currentOrderRecords && currentOrderRecords.length)
        ? (currentOrderRecords.find(r => String(getFieldFlex("VIN", r) || "").trim() === String(vin || "").trim()) || currentOrderRecords[0])
        : {};

      const customerName = getFieldFlex("CustomerName", rec) || "";
      const carName = getFieldFlex("ItemType", rec) || "";
      const carType = getFieldFlex("ItemCategory", rec) || "";

      const sub = parseAmountFront(getFieldFlex("SubtotalExclVAT", rec));
      const itemVal = parseAmountFront(getFieldFlex("ItemValue", rec));
      const tax = parseAmountFront(getFieldFlex("TaxValue", rec));

      const base = (sub !== null ? sub : (itemVal !== null ? itemVal : null));
      const lineTotalNum = (base !== null ? (base + (tax || 0)) : null);

      const amountStr = (lineTotalNum !== null)
        ? lineTotalNum.toLocaleString("ar-SA", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " ر.س"
        : "";

      text =
        `عميلنا العزيز / ${customerName}\n` +
        `مرحباً بكم في معرض محمد ذعار العجمي للسيارات\n\n` +
        `تم تسجيل طلب شرائك بنجاح \n\n` +
        `*للسيارة* ${carName}\n` +
        `نوع السيارة : ${carType}\n` +
        `رقم الهيكل : ${vin}\n` +
        `قيمة السيارة : ${amountStr}\n\n` +
        `يمكنك متابعة حالة طلبك عبر الرابط التالي: \n${trackingLink}\n\n` +
        `#مع_#معرض #محمد #ذعار #العجمي #للسيارات … #أنت #نجم الطريق`;
      break;
    }
    case 9:
      text =
        `عميلنا العزيز يسعدنا ابلاغك بجاهزية سيارتك الأن يمكنك الحضور للاستلام او طلب خدمة الشحن. 

` +
        `مواعيد العمل: 
` +
        `*الفترة الصباحية*
` +
        `من الساعة 9 صباحاً الى 11 مساء 
` +
        `عدا يوم الجمعة

` +
        `*الفترة المسائية* 
` +
        `من الساعة 4 مساء الى 9 مساء 
` +
        `جميع أيام الأسبوع 

` +
        `#مع_#معرض #محمد #ذعار #العجمي #للسيارات … #أنت #نجم الطريق`;
      break;
// -------------------------
    // 🔟 الخطوة رقم 10 — إتمام التسليم
    // -------------------------
    case 10:
      text =
        `عميلنا العزيز 
` +
        `نبارك لكم إتمام عملية التسليم بنجاح 

` +
        `*شكراً لثقتكم و نتمنى لكم قيادة آمنة وتجربة ممتعة*

` +
        `#مع_#معرض #محمد #ذعار #العجمي #للسيارات … #أنت #نجم الطريق`;
      break;


    // -------------------------
    // في حال تم الضغط على زر الرسالة من خطوة غير مفعّلة
    // -------------------------
    default:
      text =
        `عميلنا العزيز، بخصوص طلبكم رقم ${orderNo}.\n` +
        `معرض محمد ذعار العجمي للسيارات.`;
  }

  if (messageOverride && String(messageOverride).trim()) {
    text = String(messageOverride);
  }

  try {
    const res = await fetch("/api/stc-sms", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ phone, message: text, orderNo, stageNum })
    });

    if (!res.ok) {
      const errText = await res.text();
      console.error("SMS API error:", errText);
      throw new Error(errText || "SMS API failed");
    }

    stageMsg.innerHTML = "<span class='ok'>تم إرسال رسالة SMS للعميل بنجاح.</span>";
  } catch (err) {
    console.error(err);
    stageMsg.innerHTML =
      "<span class='err'>تعذر إرسال رسالة SMS، تأكد من إعدادات STC أو تواصل مع المسؤول التقني.</span>";
  }
}


function clearErpTable() {
      erpMetaEl.textContent = "";
      erpBody.innerHTML = "";
      erpTotals.style.display = "none";
      erpTotals.innerHTML = "";
      vinPickerBox.style.display = "none";
      vinPicker.innerHTML = "";
      vinCountChip.textContent = "";
    }

    function resolveItemNoForVin(vin, records){
      if (!records || !records.length) return 1;
      let itemNo = null;

      if (vin) {
        const matched = records.find(r => {
          const v = (getFieldFlex("VIN", r) || "").toString().trim();
          return v && v === vin.toString().trim();
        });
        if (matched) {
          itemNo = getFieldFlex("ItemNo", matched);
        }
      }

      if (itemNo === null || itemNo === "-" || itemNo === "") {
        const first = records[0] || null;
        if (first) itemNo = getFieldFlex("ItemNo", first);
      }

      const parsed = parseInt(itemNo, 10);
      return (!isNaN(parsed) && parsed > 0) ? parsed : 1;
    }

    function fillErpTable(records, preferredVin = ""){
      if (!records || !records.length) {
        erpCard.style.display = "none";
        clearErpTable();
        return;
      }
      erpCard.style.display = "";
      clearErpTable();

      // نحتفظ بنسخة من سجلات السيارات فقط
      currentOrderRecords = records.slice();

      const first = records[0] || {};
      const orderNo = first.orderNo || first.OrderNo || currentOrderId || "";
      currentCustomerPhone = getFieldFlex("CustomerPhone", first) || getFieldFlex("CustomerMobile", first) || getFieldFlex("Mobile", first) || getFieldFlex("Phone", first) || getFieldFlex("UserMobile", first) || getFieldFlex("UserPhone", first) || "";
      window.currentCustomerPhone = currentCustomerPhone;
      let vinBadgeLabel = "";

      // ✅ VINs (نهمل '-' و القيم الفارغة)
      const vins = Array.from(new Set(
        records
          .map(r => (getFieldFlex("VIN", r) || "").toString().trim())
          .filter(v => v && v !== "-" && v !== "—")
      ));

      if (vins.length === 1) {
        vinBadgeLabel = "VIN: " + vins[0];
      } else if (vins.length > 1) {
        vinBadgeLabel = "أكثر من هيكل (" + vins.length + ")";
      } else {
        vinBadgeLabel = "لا يوجد VIN في البيانات";
      }

      erpMetaEl.innerHTML =
        '<span class="badge">رقم الطلب: ' + (orderNo || "غير متوفر") + '</span>' +
        '<span class="badge">' + vinBadgeLabel + '</span>';

      // ===== رسوم التسجيل (قد تكون في الطلب حتى لو فيه هيكل واحد) =====
      const regFeeNum = (() => {
        const v = getFieldFlex("RegistrationFee", first);
        const n = parseAmountFront(v);
        return (n !== null && n > 0) ? n : 0;
      })();

      // ✅ نعرض في الجدول سيارات فقط (رسوم التسجيل تظهر أعلى في صندوق الإجماليات)
      const totalCars = records.length;
      const displayRecords = records.slice();

      // تعبئة جدول ERP
      displayRecords.forEach(rec => {
        const tr = document.createElement("tr");
        ERP_FIELDS.forEach(field => {
          const td = document.createElement("td");
          let val = getFieldFlex(field, rec);

          // ✅ فallback + تصحيح: بعض الطلبات ترجع TotalInclVAT على مستوى الطلب وتكرره بكل سطر
          // هنا نُجبره يكون "لكل هيكل" = (قبل الضريبة + الضريبة) + (رسوم التسجيل ÷ عدد الهياكل)
          if (field === "TotalInclVAT") {
            const _sub = parseAmountFront(getFieldFlex("SubtotalExclVAT", rec));
            const _tax = parseAmountFront(getFieldFlex("TaxValue", rec));
            const computed = (_sub || 0) + (_tax || 0);

            const perReg = (regFeeNum > 0 && totalCars > 0) ? (regFeeNum / totalCars) : 0;
            const computedPerLine = computed + perReg;

            // لو عندنا subtotal/tax — اعتمد الحسبة دي دائمًا (خصوصًا لو الطلب متعدد الهياكل)
            if (computed > 0) {
              val = computedPerLine;
            } else {
              // fallback لو مفيش subtotal/tax
              const numRaw = parseAmountFront(val);
              if (numRaw === null || numRaw === 0) {
                val = null;
              }
            }
          }

          if (field === "TaxRate") {
            const num = parseAmountFront(val);
            let pc = num !== null ? (num <= 1 ? num * 100 : num) : 15;
            const pcStr = pc.toString().replace(/\.0+$/, "");
            val = pcStr + " %";
          } else if (field === "TotalInclVAT" || field === "TaxValue" || field === "SubtotalExclVAT") {
            const num = parseAmountFront(val);
            if (num !== null) {
              val = num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " ر.س";
            }
          }

          td.textContent = val;
          tr.appendChild(td);
        });
        erpBody.appendChild(tr);
      });

      // إدارة VIN للدروب داون
      let selectedVin = preferredVin && vins.includes(preferredVin) ? preferredVin : null;
      if (!selectedVin && vins.length === 1) {
        selectedVin = vins[0];
      }

      if (vins.length > 1) {
        vinPickerBox.style.display = "block";
        vinPicker.innerHTML = vins.map(v => `<option value="${v}">${v}</option>`).join("");
        vinCountChip.textContent = vins.length + " أرقام هياكل في هذا الطلب";
        if (selectedVin && vins.includes(selectedVin)) {
          vinPicker.value = selectedVin;
        } else {
          vinPicker.value = vins[0];
          selectedVin = vins[0];
        }
      } else if (vins.length === 1) {
        vinPickerBox.style.display = "block";
        vinPicker.innerHTML = `<option value="${vins[0]}">${vins[0]}</option>`;
        vinPicker.disabled = false;
        vinCountChip.textContent = "هيكل واحد في هذا الطلب";
        selectedVin = vins[0];
      } else {
        vinPickerBox.style.display = "none";
      }

      currentVin    = selectedVin || (vins[0] || preferredVin || "");
      try{ refreshTrackingQr(); }catch(e){}
      currentItemNo = resolveItemNoForVin(currentVin, records);

      // حساب إجمالي الطلب (السيارات فقط) + رسوم التسجيل (بدون ضريبة)
      // const totalCars = records.length; // مُعرّف بالأعلى


      // ✅ نحسب إجماليات السيارات من السطور (أفضل مصدر ثابت)
      let carsSubtotal = 0; // قبل الضريبة
      let carsTax      = 0; // قيمة الضريبة
      let carsTotal    = 0; // شامل الضريبة (سيارات فقط بدون رسوم التسجيل)

      // ملاحظة مهمة:
      // بعض ملفات الـ ERP تكرر TotalInclVAT (إجمالي الطلب) داخل كل سطر عند وجود أكثر من هيكل.
      // لذلك لا نجمع TotalInclVAT بشكل أعمى. نستخدم Subtotal+Tax كمصدر أساسي،
      // ونتعامل مع TotalInclVAT بحذر (تجميعي فقط لو كان مختلفًا لكل سطر).
      const totVals = [];

      records.forEach(rec => {
        const subVal = parseAmountFront(getFieldFlex("SubtotalExclVAT", rec));
        const taxVal = parseAmountFront(getFieldFlex("TaxValue", rec));
        const totVal = parseAmountFront(getFieldFlex("TotalInclVAT", rec));

        if (subVal !== null) carsSubtotal += subVal;
        if (taxVal !== null) carsTax      += taxVal;

        if (totVal !== null && totVal > 0) totVals.push(totVal);
      });

      // لو TotalInclVAT موجود:
      // - لو قيمة واحدة مكررة مع تعدد السطور => اعتبرها إجمالي الطلب (لا تجمعها)
      // - لو قيم متعددة مختلفة => اجمعها (يعني TotalInclVAT لكل سطر فعلاً)
      if (totVals.length) {
        const uniq = Array.from(new Set(totVals.map(v => Number(v).toFixed(2))));
        if (uniq.length === 1 && totVals.length > 1) {
          carsTotal = parseFloat(uniq[0]); // إجمالي الطلب (سيارات فقط) مكرر داخل السطور
        } else {
          carsTotal = totVals.reduce((a, b) => a + b, 0); // إجمالي لكل سطر
        }
      }

      // ✅ لو السطور ما فيها إجماليات (طلبات قديمة/بدون أعمدة Y/Z) خُدها مرة واحدة من الهيدر
      if (carsSubtotal === 0 && carsTax === 0 && carsTotal === 0) {
        const headerGrand = parseAmountFront(getFieldFlex("GrandTotal", first));
        const headerSubBT = parseAmountFront(getFieldFlex("SubtotalBeforeTax", first));
        const headerSub   = parseAmountFront(getFieldFlex("SubtotalExclVAT", first));
        const headerTax   = parseAmountFront(getFieldFlex("TaxValue", first));

        // الأفضل: (SubtotalBeforeTax + Tax) أو GrandTotal مباشرة
        if (headerSubBT !== null) {
          carsSubtotal = Math.max(0, (headerSubBT || 0) - (regFeeNum || 0));
        } else if (headerSub !== null) {
          carsSubtotal = headerSub || 0;
        }

        if (headerGrand !== null) {
          carsTotal = Math.max(0, (headerGrand || 0) - (regFeeNum || 0));
        } else if (headerSubBT !== null && headerTax !== null) {
          carsTotal = Math.max(0, ((headerSubBT || 0) + (headerTax || 0)) - (regFeeNum || 0));
        }

        if (headerTax !== null) {
          carsTax = headerTax || 0;
        } else if (carsTotal > 0 || carsSubtotal > 0) {
          const inferred = (carsTotal || 0) - (carsSubtotal || 0);
          carsTax = inferred > 0 ? inferred : 0;
        }
      }

      // ✅ الإجمالي للسيارات = (الإجمالي قبل الضريبة + قيمة الضريبة)
// نتجاهل TotalInclVAT لتفادي تكرار إجمالي الطلب داخل كل سطر عند تعدد الهياكل
      carsTotal = (carsSubtotal || 0) + (carsTax || 0);

      // ✅ رسوم التسجيل (بدون ضريبة) — تُضاف فقط على الإجمالي شامل الضريبة
      const grandTotalIncl = (carsTotal || 0) + (regFeeNum || 0);

      // عرض صندوق الإجماليات (بالمسميات المطلوبة)
      const hasTotals = (carsSubtotal > 0 || carsTax > 0 || carsTotal > 0 || regFeeNum > 0);
      if (hasTotals) {
        const parts = [];
        parts.push(`<span>عدد السيارات في الطلب: <strong>${totalCars}</strong></span>`);
        parts.push(`<span>قيمة الضريبة: <strong>${(carsTax||0).toLocaleString('ar-SA',{minimumFractionDigits:2, maximumFractionDigits:2})} ر.س</strong></span>`);
        parts.push(`<span>الإجمالي قبل الضريبة: <strong>${(carsSubtotal||0).toLocaleString('ar-SA',{minimumFractionDigits:2, maximumFractionDigits:2})} ر.س</strong></span>`);
        if (regFeeNum > 0) {
          parts.push(`<span>رسوم التسجيل: <strong>${regFeeNum.toLocaleString('ar-SA',{minimumFractionDigits:2, maximumFractionDigits:2})} ر.س</strong></span>`);
        }
        parts.push(`<span>الإجمالي شامل الضريبة: <strong>${(grandTotalIncl||0).toLocaleString('ar-SA',{minimumFractionDigits:2, maximumFractionDigits:2})} ر.س</strong></span>`);

        erpTotals.innerHTML = parts.join("");
        erpTotals.style.display = "flex";
      } else {
        erpTotals.style.display = "none";
        erpTotals.innerHTML = "";
      }

// تحميل مراحل التتبع للحالة الحالية (غير الأرشيف فقط)
      if (!currentIsArchiveView){
        loadTrackingForCurrentSelection();
        try{ refreshTrackingQr(); }catch(e){}
      }
    }

    // STAGES UI

    function buildStagesUI(orderData = {}) {
      stagesList.innerHTML = "";

      const currentUserEmail = (auth.currentUser?.email || "").toLowerCase();
      function isStageVisible(stageNum){
        const email = (currentUserEmail || "").trim().toLowerCase();

        // ✅ CFO / COO: all stages (1-10)
        if (email === "cfo@mzjcars.com" || email === "coo@mzjcars.com"){
          return true;
        }

        // ✅ محددين: فقط 1 و 2 و 9 و 10
        if (
          email === "aldynmtwlys@gmail.com" ||
          email === "alaasamak100@gmail.com" ||
          email === "kamelashraf948@gmail.com"
        ){
          return (stageNum === 1 || stageNum === 2 || stageNum === 9 || stageNum === 10);
        }

        // ✅ Samir: اخفاء 1 و 2 و 6 و 7 و 9 و 10
        if (email === "samirali19918@gmail.com"){
          return !(stageNum === 1 || stageNum === 2 || stageNum === 6 || stageNum === 7 || stageNum === 9 || stageNum === 10);
        }

        // default
        return true;
      }
      const stagesObj = orderData.stages || {};

      const doneKeys = Object.keys(stagesObj).filter(k => stagesObj[k]);
      const doneCount = doneKeys.length;
      const allDone = STAGES.every((_, idx) => {
        const key = "s" + (idx + 1);
        return !!stagesObj[key];
      });

      STAGES.forEach((label, idx) => {
        const num = idx + 1;

        if (!isStageVisible(num)) return;
        const key = "s" + num;
        const ts  = stagesObj[key];

        const tsStr = ts
          ? new Date(ts.toDate ? ts.toDate() : ts).toLocaleString("ar-SA")
          : null;

        const wrap = document.createElement("div");
        wrap.className = "stage";
        if (tsStr) wrap.classList.add("done");

        const header = document.createElement("div");
        header.className = "stage-header";

        const tEl = document.createElement("div");
        tEl.innerHTML = "<strong>" + label + "</strong>";

        const meta = document.createElement("div");
        meta.innerHTML = tsStr
          ? "<small>تم الانتهاء: " + tsStr + "</small>"
          : "<small>لم تُنفّذ بعد</small>";

        header.appendChild(tEl);
        header.appendChild(meta);

        const actions = document.createElement("div");

        // زر تم الانتهاء
        const btnDone = document.createElement("button");
        btnDone.className = "btn-outline";
        btnDone.style.fontSize = "12px";
        btnDone.textContent = "تم الانتهاء";
        btnDone.disabled = !!tsStr || allDone;
        btnDone.onclick = () => completeStage(num);
        actions.appendChild(btnDone);

        
                    // ===== SMS+ (فقط في الخطوة 1 و 9 و 10) =====
        if (num === 1 || num === 9 || num === 10) {
          const btnSmsPlus = document.createElement("button");
          btnSmsPlus.className = "btn-outline";
          btnSmsPlus.style.fontSize = "12px";
          btnSmsPlus.style.marginRight = "6px";
          btnSmsPlus.textContent = "SMS+";
          btnSmsPlus.disabled = !currentCustomerPhone;
          btnSmsPlus.onclick = () => openSmsPlus(num, label);
          actions.appendChild(btnSmsPlus);
        }

// زر التراجع
        const btnUndo = document.createElement("button");
        btnUndo.className = "btn-outline";
        btnUndo.style.fontSize = "12px";
        btnUndo.style.marginRight = "6px";
        btnUndo.textContent = "تراجع";
        btnUndo.disabled = !tsStr;
        btnUndo.onclick = () => revertStage(num);
        actions.appendChild(btnUndo);

        wrap.appendChild(header);
        wrap.appendChild(actions);

        stagesList.appendChild(wrap);
      });

      if (allDone) {
        const info = document.createElement("div");
        info.className = "hint";
        info.style.marginTop = "8px";
        info.textContent = "تم إكمال جميع المراحل لهذا رقم الهيكل، ولا يمكن إضافة مراحل جديدة.";
        stagesList.appendChild(info);
      }
    }


    async function completeStage(num) {
      stageMsg.textContent = "";
      if (!currentOrderId || !currentItemNo) {
        stageMsg.innerHTML = "<span class='err'>اختر طلب ورقم هيكل أولاً قبل تحديث المراحل.</span>";
        return;
      }

      const baseId = currentOrderId;
      const docId = baseId + "_" + currentItemNo;
      const key = "s" + num;

      // ✅ استخدم كاش المراحل (بدون قراءة getDoc كل مرة)
      const stagesObj = Object.assign({}, currentStagesObjCache || {});
      if (stagesObj[key]) {
        stageMsg.innerHTML = "<span class='muted'>هذه المرحلة تم ختمها مسبقاً.</span>";
        return;
      }

      // ✅ تحديث واجهة بشكل فوري (Optimistic UI) لتحسّن السرعة
      const optimisticStages = Object.assign({}, stagesObj, { [key]: new Date() });
      currentStagesObjCache = optimisticStages;
      currentTrackData = currentTrackData || {
        orderId: baseId,
        vin: currentVin || "",
        itemNo: currentItemNo || 1,
        currentStage: 0,
        stages: {}
      };
      currentTrackData.orderId = baseId;
      currentTrackData.vin = currentVin || "";
      currentTrackData.itemNo = currentItemNo || 1;
      currentTrackData.stages = optimisticStages;

      const doneCount = Object.keys(optimisticStages).filter(k => optimisticStages[k]).length;
      currentTrackData.currentStage = doneCount;

      buildStagesUI(currentTrackData);
      stageMsg.innerHTML = "<span class='muted'>جاري حفظ المرحلة...</span>";

      try {
        const orderRef  = doc(db, TRACK_COLLECTION, docId);
        const publicRef = doc(db, TRACK_COLLECTION, docId, "public", "status");

        // ✅ كتابة واحدة (Batch) بدل 2 setDoc متتابعين
        const batch = writeBatch(db);

        batch.set(orderRef, {
          orderId: baseId,
          vin: currentVin || "",
          itemNo: currentItemNo || 1,
          currentStage: doneCount,
          stages: { [key]: serverTimestamp() }
        }, { merge: true });

        batch.set(publicRef, {
          orderId: baseId,
          vin: currentVin || "",
          itemNo: currentItemNo || 1,
          currentStage: doneCount,
          stages: { [key]: serverTimestamp() },
          updatedAt: serverTimestamp()
        }, { merge: true });

        await batch.commit();

        stageMsg.innerHTML = "<span class='ok'>تم ختم المرحلة رقم " + num + " وتحديث صفحة التتبع.</span>";
      } catch (e) {
        console.error(e);
        stageMsg.innerHTML = "<span class='err'>حدث خطأ أثناء حفظ المرحلة. حاول مرة أخرى.</span>";
        // رجّع الداتا من السيرفر لضمان التطابق (قراءة واحدة فقط عند الفشل)
        try { await loadTrackingForCurrentSelection(); } catch(e2) {}
      }
    }



    async function revertStage(num) {
      stageMsg.textContent = "";
      if (!currentOrderId || !currentItemNo) {
        stageMsg.innerHTML = "<span class='err'>اختر طلب ورقم هيكل أولاً قبل التراجع عن المرحلة.</span>";
        return;
      }

      const baseId = currentOrderId;
      const docId = baseId + "_" + currentItemNo;
      const key = "s" + num;

      const stagesObj = Object.assign({}, currentStagesObjCache || {});
      if (!stagesObj[key]) {
        stageMsg.innerHTML = "<span class='muted'>هذه المرحلة غير مكتملة أصلاً.</span>";
        return;
      }

      // ✅ Optimistic UI
      delete stagesObj[key];
      currentStagesObjCache = stagesObj;

      currentTrackData = currentTrackData || {
        orderId: baseId,
        vin: currentVin || "",
        itemNo: currentItemNo || 1,
        currentStage: 0,
        stages: {}
      };
      currentTrackData.orderId = baseId;
      currentTrackData.vin = currentVin || "";
      currentTrackData.itemNo = currentItemNo || 1;
      currentTrackData.stages = stagesObj;

      const doneCount = Object.keys(stagesObj).filter(k => stagesObj[k]).length;
      currentTrackData.currentStage = doneCount;

      buildStagesUI(currentTrackData);
      stageMsg.innerHTML = "<span class='muted'>جاري حفظ التراجع...</span>";

      try {
        const orderRef  = doc(db, TRACK_COLLECTION, docId);
        const publicRef = doc(db, TRACK_COLLECTION, docId, "public", "status");

        const batch = writeBatch(db);

        batch.update(orderRef, {
          [`stages.${key}`]: deleteField(),
          currentStage: doneCount
        });

        batch.update(publicRef, {
          [`stages.${key}`]: deleteField(),
          currentStage: doneCount,
          updatedAt: serverTimestamp()
        });

        await batch.commit();

        stageMsg.innerHTML = "<span class='ok'>تم التراجع عن المرحلة رقم " + num + " لهذا رقم الهيكل.</span>";
      } catch (e) {
        console.error(e);
        stageMsg.innerHTML = "<span class='err'>حدث خطأ أثناء حفظ التراجع. حاول مرة أخرى.</span>";
        try { await loadTrackingForCurrentSelection(); } catch(e2) {}
      }
    }

    async function loadTrackingForCurrentSelection(){
      if (!currentOrderId || !currentItemNo) {
        buildStagesUI({ });
        return;
      }
      try{
        const baseId = currentOrderId;
        const docId  = baseId + "_" + currentItemNo;

        const orderRef = doc(db, TRACK_COLLECTION, docId);
        const trackSnap = await getDoc(orderRef);
        let trackData;
        if (trackSnap.exists()) {
          trackData = trackSnap.data();
        } else {
          trackData = {
            orderId: baseId,
            vin: currentVin || "",
            itemNo: currentItemNo || 1,
            currentStage: 0,
            stages:{}
          };
          await setDoc(orderRef, trackData, {merge:true});
          const publicRef = doc(db, TRACK_COLLECTION, docId, "public", "status");
          await setDoc(publicRef, {
            orderId: baseId,
            vin: currentVin || "",
            itemNo: currentItemNo || 1,
            currentStage: 0,
            stages:{},
            updatedAt: serverTimestamp()
          }, {merge:true});
        }

        const stagesObj = trackData.stages || {};
        const doneKeys = Object.keys(stagesObj).filter(k => stagesObj[k]);
        const doneCount = doneKeys.length;
        trackData.currentStage = doneCount;

        currentTrackData = trackData;
        currentStagesObjCache = trackData.stages || {};

        buildStagesUI(trackData);
      }catch(e){
        console.error(e);
        buildStagesUI({ });
      }
    }

    async function findByVin(vinRaw) {
      const val = vinRaw.trim();
      if (!val) return null;

      const colRef = collection(db, ERP_COLLECTION);

      let q1 = query(colRef, where("vin","==",val));
      let snap = await getDocs(q1);
      if (!snap.empty) return snap.docs[0];

      const asNum = Number(val);
      if (!Number.isNaN(asNum)) {
        q1 = query(colRef, where("vin","==",asNum));
        snap = await getDocs(q1);
        if (!snap.empty) return snap.docs[0];
      }

      try {
        const vinRef = doc(db, ERP_VINS_COLLECTION, val);
        const vinSnap = await getDoc(vinRef);
        if (vinSnap.exists()) {
          const vData = vinSnap.data();
          const ordNo = vData.lastOrderNo || vData.orderNo || vData.OrderNo || null;
          if (ordNo) {
            const ordRef = doc(db, ERP_COLLECTION, ordNo);
            const ordSnap = await getDoc(ordRef);
            if (ordSnap.exists()) return ordSnap;

            const q2 = query(colRef, where("orderNo","==",ordNo));
            const s2 = await getDocs(q2);
            if (!s2.empty) return s2.docs[0];
          }
        }
      } catch (e) {
        console.error("VIN lookup via erp_vins failed", e);
      }

      return null;
    }

    async function loadOrder(){
      orderMsg.textContent = "";
      stageMsg.textContent = "";
      clearErpTable();
      currentOrderId      = null;
      currentVin          = null;
      currentItemNo       = null;
      currentOrderRecords = [];

      const idRaw  = orderIdInput.value.trim();
      const vinRaw = vinInput.value.trim();

      if(!idRaw && !vinRaw){
        orderMsg.innerHTML = "<span class='err'>أدخل رقم الطلب أو رقم الهيكل.</span>";
        erpCard.style.display = "none";
        buildStagesUI({ });
        return;
      }

      try{
        let erpRecords = [];
        let erpDocId = null;

        if(idRaw){
          const ref = doc(db, ERP_COLLECTION, idRaw);
          const snap = await getDoc(ref);
          if(snap.exists()){
            erpRecords.push(snap.data());
            erpDocId = snap.id;
          }
        }

        let baseOrder = idRaw;
        if(!erpRecords.length && baseOrder){
          if(baseOrder.includes("_")) baseOrder = baseOrder.split("_")[0];
          const q = query(collection(db, ERP_COLLECTION), where("orderNo","==",baseOrder));
          const qsnap = await getDocs(q);
          if(!qsnap.empty){
            erpRecords = qsnap.docs.map(d => d.data());
            erpDocId = qsnap.docs[0].id;
          }
        }

        if(!erpRecords.length && vinRaw){
          const d = await findByVin(vinRaw);
          if(d){
            const data = d.data();
            erpDocId = d.id;
            const ordNo = data.orderNo || data.OrderNo || null;
            if (ordNo) {
              const q2 = query(collection(db, ERP_COLLECTION), where("orderNo","==",ordNo));
              const s2 = await getDocs(q2);
              if (!s2.empty) {
                erpRecords = s2.docs.map(docSnap => docSnap.data());
              } else {
                erpRecords = [data];
              }
            } else {
              erpRecords = [data];
            }
          }
        }

        if(!erpRecords.length){
          orderMsg.innerHTML = "<span class='err'>لا يوجد طلب مطابق في بيانات ERP.</span>";
          erpCard.style.display = "none";
          buildStagesUI({ });
          return;
        }

        const firstRec = erpRecords[0] || {};
        const detectedOrderNo = firstRec.orderNo || firstRec.OrderNo || (erpDocId || idRaw);

        currentOrderId = detectedOrderNo;

        orderIdInput.value = detectedOrderNo || "";
        const preferredVin =
          vinRaw ||
          (erpRecords.length === 1 ? (getFieldFlex("VIN", firstRec) || "") : "");

        fillErpTable(erpRecords, preferredVin);
        await refreshArchiveUI();

        stagesCard.style.display = "";
        ordersListCard.style.display = ordersListCard.style.display;

        orderMsg.innerHTML = "<span class='ok'>تم تحميل الطلب وربطه بالتتبع.</span>";
      }catch(e){
        console.error(e);
        orderMsg.innerHTML = "<span class='err'>حدث خطأ أثناء تحميل الطلب.</span>";
        erpCard.style.display = "none";
        buildStagesUI({ });
      }
    }

    loadBtn.onclick = loadOrder;

    clearBtn.onclick = () => {
      orderIdInput.value = "";
      vinInput.value = "";
      orderMsg.textContent = "";
      stageMsg.textContent = "";
      currentOrderId      = null;
      currentVin          = null;
      currentItemNo       = null;
      currentOrderRecords = [];
      clearErpTable();
      erpCard.style.display = "none";
      buildStagesUI({ });
      refreshArchiveUI();
    };

    vinPicker.addEventListener("change", () => {
      if (!currentOrderId || !currentOrderRecords.length) return;
      const selected = vinPicker.value;
      currentVin    = selected;
      currentItemNo = resolveItemNoForVin(selected, currentOrderRecords);
      loadTrackingForCurrentSelection();
    });

    // ---- تبويب كل الطلبات ----

    
    function loadReadOrders(){
      try{
        const arr = JSON.parse(localStorage.getItem("mzj_read_orders") || "[]");
        if (Array.isArray(arr)) ordersReadSet = new Set(arr.map(String));
      }catch(e){ ordersReadSet = new Set(); }
    }
    function saveReadOrders(){
      try{
        localStorage.setItem("mzj_read_orders", JSON.stringify(Array.from(ordersReadSet)));
      }catch(e){}
    }

    // ---- أرشفة الطلبات (لتخفيف قائمة "كل الطلبات") ----
    async function loadArchiveSet(force=false){
      try{
        if (archiveLoaded && !force) return archiveSet;
        archiveSet = new Set();
        // ✅ قراءة واحدة فقط (محدودة) لكل الأرشيف
        const snap = await getDocs(query(collection(db, ARCHIVE_COLLECTION), limit(1000)));
        snap.forEach(ds => {
          const id = ds.id;
          if (id) archiveSet.add(String(id));
        });
        archiveLoaded = true;
        return archiveSet;
      }catch(e){
        console.warn("archive load failed", e);
        archiveLoaded = true;
        return archiveSet;
      }
    }

    async function refreshArchiveUI(){
      if (!archiveOrderBtn || !unarchiveOrderBtn || !archiveHint) return;
      archiveHint.textContent = "";
      if (!currentOrderId){
        archiveOrderBtn.style.display = "none";
        unarchiveOrderBtn.style.display = "none";
        return;
      }
      archiveOrderBtn.style.display = "inline-flex";
      unarchiveOrderBtn.style.display = "none";

      try{
        // نستخدم الكاش لو متاح
        if (!archiveLoaded) await loadArchiveSet();
        const isArchived = archiveSet.has(String(currentOrderId));
        if (isArchived){
          archiveOrderBtn.style.display = "none";
          unarchiveOrderBtn.style.display = "inline-flex";
          archiveHint.textContent = "هذا الطلب مؤرشف ولن يظهر في (كل الطلبات).";
        } else {
          archiveOrderBtn.style.display = "inline-flex";
          unarchiveOrderBtn.style.display = "none";
          archiveHint.textContent = "";
        }
      }catch(e){}
    }

    async function fmtTs(ts){
      try{
        if (!ts) return "";
        // Firestore Timestamp
        if (typeof ts.toDate === "function") return ts.toDate().toLocaleString("ar-SA");
        // ISO/string/date
        const d = new Date(ts);
        return isNaN(d.getTime()) ? "" : d.toLocaleString("ar-SA");
      }catch(_){ return ""; }
    }

    // HTML escape helper (prevents render errors + XSS)
    function escapeHtml(text){
      if (text === undefined || text === null) return "";
      return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }


    async function commitWritesInChunks(writeOps, maxOps=450){
      // writeOps: [{ref, data, options}]
      let i = 0;
      while (i < writeOps.length){
        const batch = writeBatch(db);
        let used = 0;
        while (i < writeOps.length && used < maxOps){
          const op = writeOps[i++];
          batch.set(op.ref, op.data, op.options || { merge:true });
          used++;
        }
        await batch.commit();
      }
    }

    async function commitDeletesInChunks(deleteRefs, maxOps=450){
      let i = 0;
      while (i < deleteRefs.length){
        const batch = writeBatch(db);
        let used = 0;
        while (i < deleteRefs.length && used < maxOps){
          const ref = deleteRefs[i++];
          batch.delete(ref);
          used++;
        }
        await batch.commit();
      }
    }

    async function moveOrderToArchive(orderNo){
      const ord = String(orderNo||"").trim();
      if (!ord) throw new Error("Missing orderNo");

      // 1) Fetch ERP lines for this order
      let erpSnap = await getDocs(query(collection(db, ERP_COLLECTION), where("orderNo","==",ord), limit(500)));
      let erpDocs = erpSnap.docs || [];

      // fallback (rare): use already loaded records
      if (!erpDocs.length && Array.isArray(currentOrderRecords) && String(currentOrderId||"") === ord){
        // We don't have doc IDs here, so we will rebuild doc IDs from itemNo.
        // We'll write to archive but cannot safely delete unknown ERP doc IDs.
        console.warn("No ERP docs returned for order. Using currentOrderRecords as fallback (archive copy only).");
      }

      // Determine itemNos from ERP docs (preferred)
      const itemNos = [];
      const erpWriteOps = [];
      const erpDeleteRefs = [];

      if (erpDocs.length){
        erpDocs.forEach(d=>{
          const data = d.data() || {};
          // itemNo priority: explicit field -> data.item.no -> d.id suffix
          let itemNo = data.itemNo;
          if (!itemNo && data.item && data.item.no != null) itemNo = String(data.item.no);
          if (!itemNo){
            const parts = String(d.id||"").split("_");
            itemNo = parts.length>1 ? parts[parts.length-1] : "1";
          }
          itemNos.push(String(itemNo));
          const archRef = doc(db, ARCHIVE_COLLECTION, ord, "erp_lines", d.id);
          erpWriteOps.push({ ref: archRef, data: { ...data, __fromDocId: d.id }, options: { merge:true } });
          erpDeleteRefs.push(doc(db, ERP_COLLECTION, d.id));
        });
      } else if (Array.isArray(currentOrderRecords) && String(currentOrderId||"") === ord){
        currentOrderRecords.forEach((rec, idx)=>{
          const data = rec || {};
          let itemNo = data.itemNo;
          if (!itemNo && data.item && data.item.no != null) itemNo = String(data.item.no);
          if (!itemNo) itemNo = String(idx+1);
          itemNos.push(String(itemNo));
          const dId = `${ord}_${itemNo}`;
          const archRef = doc(db, ARCHIVE_COLLECTION, ord, "erp_lines", dId);
          erpWriteOps.push({ ref: archRef, data: { ...data, __fromDocId: dId }, options: { merge:true } });
          // NOTE: deleteRefs unknown here; we will try by reconstructed ID
          erpDeleteRefs.push(doc(db, ERP_COLLECTION, dId));
        });
      }

      // De-dup itemNos
      const uniqItemNos = Array.from(new Set(itemNos.length ? itemNos : ["1"]));

      // 2) Read orders docs (tracking) for each itemNo
      const orderWriteOps = [];
      const statusWriteOps = [];
      const orderDeleteRefs = [];

      for (const itNo of uniqItemNos){
        const docId = `${ord}_${itNo}`;
        const orderRef = doc(db, TRACK_COLLECTION, docId);
        const orderSnap = await getDoc(orderRef);
        if (orderSnap.exists()){
          const orderData = orderSnap.data() || {};
          orderWriteOps.push({
            ref: doc(db, ARCHIVE_COLLECTION, ord, "orders", docId),
            data: { ...orderData, __fromDocId: docId },
            options: { merge:true }
          });
          orderDeleteRefs.push(orderRef);
        } else {
          // still delete (noop if missing) not possible via batch; skip
        }

        // copy public/status if exists (optional but useful for archive view)
        const pubRef = doc(db, TRACK_COLLECTION, docId, "public", "status");
        const pubSnap = await getDoc(pubRef);
        if (pubSnap.exists()){
          statusWriteOps.push({
            ref: doc(db, ARCHIVE_COLLECTION, ord, "public_status", docId),
            data: { ...pubSnap.data(), __fromDocId: docId },
            options: { merge:true }
          });
        }
      }

      // 3) Write archive summary
      const firstErpData = erpDocs.length ? (erpDocs[0].data() || {}) : (Array.isArray(currentOrderRecords) ? (currentOrderRecords[0]||{}) : {});
      const summaryRef = doc(db, ARCHIVE_COLLECTION, ord);
      const summaryData = {
        orderNo: ord,
        branch: firstErpData.branch || firstErpData?.summary?.branch || firstErpData?.branchName || "",
        customerName: firstErpData.customerName || firstErpData?.summary?.customerName || firstErpData?.customerName || firstErpData?.customer || "",
        customerPhone: firstErpData.customerPhone || firstErpData?.summary?.customerPhone || "",
        salesPerson: firstErpData.salesPerson || firstErpData?.summary?.salesPerson || "",
        totals: firstErpData.totals || firstErpData?.summary?.totals || {},
        itemsCount: uniqItemNos.length,
        archivedAt: serverTimestamp(),
        archivedBy: (auth.currentUser?.email || "")
      };

      const summaryWriteOps = [{ ref: summaryRef, data: summaryData, options: { merge:true } }];

      // 4) Commit archive writes (summary + lines + orders + public_status)
      const allWrites = summaryWriteOps.concat(erpWriteOps, orderWriteOps, statusWriteOps);
      await commitWritesInChunks(allWrites, 450);

      // 5) Mark customer tracking status as archived (keep subdoc so customer sees "منتهي")
      // Note: deleting main track doc does NOT delete subcollections; we keep public/status.
      const markWrites = [];
      for (const itNo of uniqItemNos){
        const docId = `${ord}_${itNo}`;
        const publicRef2 = doc(db, TRACK_COLLECTION, docId, "public", "status");
        markWrites.push({
          ref: publicRef2,
          data: { archived: true, archivedAt: serverTimestamp(), updatedAt: serverTimestamp() },
          options: { merge:true }
        });
      }
      await commitWritesInChunks(markWrites, 450);

      // 6) Delete originals from erp_orders + orders (tracking)
      // Deleting orders docs will not delete public/status docs.
      await commitDeletesInChunks(erpDeleteRefs.concat(orderDeleteRefs), 450);

      // Update local archive set
      archiveSet.add(ord);
      archiveLoaded = true;
    }

    async function archiveCurrentOrder(){
      if (!currentOrderId) return;
      const ord = String(currentOrderId);
      const ok = confirm("تأكيد: أرشفة الطلب " + ord + " ؟\nسيتم نقله بالكامل إلى (الأرشيف) وحذفه من (كل الطلبات).");
      if (!ok) return;

      try{
        await moveOrderToArchive(ord);
        await refreshArchiveUI();

        // تحديث القوائم
        if (ordersListCard && ordersListCard.style.display !== "none"){
          await loadOrdersList();
        }
        if (archivesListCard && archivesListCard.style.display !== "none"){
          await loadArchivesList();
        }

        alert("تمت أرشفة الطلب ونقله إلى الأرشيف.");
      }catch(e){
        console.error(e);
        alert("تعذر أرشفة الطلب. حاول مرة أخرى.");
      }
    }

    // 🚫 إلغاء الأرشفة غير مفعّل لأننا ننقل الطلبات فعليًا (Move)
    async function unarchiveCurrentOrder(){
      alert("إلغاء الأرشفة غير متاح حالياً.");
    }

    if (archiveOrderBtn) archiveOrderBtn.addEventListener("click", archiveCurrentOrder);
    if (unarchiveOrderBtn) {
      unarchiveOrderBtn.style.display = "none";
      unarchiveOrderBtn.addEventListener("click", unarchiveCurrentOrder);
    }

if (archiveOrderBtn) archiveOrderBtn.addEventListener("click", archiveCurrentOrder);
    if (unarchiveOrderBtn) unarchiveOrderBtn.addEventListener("click", unarchiveCurrentOrder);

    function renderOrdersList(filterText=""){
      const q = String(filterText||"").trim().toLowerCase();
      const rows = Array.isArray(ordersListCache) ? ordersListCache : [];
      const baseRows = rows.filter(r => !archiveSet.has(String(r.orderNo||"")));
      const filtered = !q ? baseRows : baseRows.filter(r => {
        const hay = [
          r.orderNo, r.customerName, r.customerPhone, r.branch, r.vinVal, r.vinRaw
        ].filter(Boolean).join(" ").toLowerCase();
        return hay.includes(q);
      });

      ordersListBody.innerHTML = "";
      if (!filtered.length){
        ordersListBody.innerHTML = "<tr><td class='muted' colspan='5'>لا توجد نتائج مطابقة.</td></tr>";
        return;
      }

      filtered.forEach(r => {
        const tr = document.createElement("tr");
        const isUnread = !ordersReadSet.has(String(r.orderNo||""));
        if (isUnread) tr.classList.add("unread-row");

        tr.innerHTML = `
          <td><button class="link-btn" data-order="${r.orderNo}">${r.orderNo}</button></td>
          <td>${r.customerName || "—"}</td>
          <td>${r.customerPhone || "—"}</td>
          <td>${r.branch || "—"}</td>
          <td>${r.vinVal || "—"}</td>
        `;
        ordersListBody.appendChild(tr);
      });
    }


    async function loadOrdersList() {
      ordersListBody.innerHTML = "<tr><td class='muted' colspan='5'>جاري تحميل الطلبات...</td></tr>";
      try {
        await loadArchiveSet();
        // ✅ نقرأ آخر 200 سجل من erp_orders (قد يكون في تكرار لأن كل سيارة سجل)
        const q = query(collection(db, ERP_COLLECTION), limit(200));
        const snap = await getDocs(q);
        if (snap.empty) {
          ordersListBody.innerHTML = "<tr><td class='muted' colspan='5'>لا توجد طلبات مسجلة حالياً.</td></tr>";
          return;
        }
        // ✅ نجمع حسب orderNo لتجنب تكرار الطلبات في القائمة
        const byOrder = new Map();
        for (const docSnap of snap.docs) {
          const d = docSnap.data();
          const orderNo = d.orderNo || d.OrderNo || docSnap.id;
          if (!orderNo) continue;

          if (!byOrder.has(orderNo)) {
            byOrder.set(orderNo, { orderNo, docs: [] });
          }
          byOrder.get(orderNo).docs.push(d);
        }

        const rows = [];
        for (const group of byOrder.values()) {
          const docsArr = group.docs || [];
          const first = docsArr[0] || {};

          const vins = Array.from(new Set(
            docsArr
              .map(x => (getFieldFlex("VIN", x) || "").toString().trim())
              .filter(v => v && v !== "-" && v !== "—")
          ));

          const vinVal = (vins.length <= 1)
            ? (vins[0] || "—")
            : ("(" + vins.length + ") هياكل");

          const customerName = getFieldFlex("CustomerName", first) || "";
          const customerPhone = getFieldFlex("CustomerPhone", first) || "";
          const branch = getFieldFlex("Branch", first) || "";
          const orderDateRaw = getFieldFlex("OrderDate", first) || "";

          // حالة التتبع
          // 🚀 تحسين أداء: لا نقرأ مراحل التتبع لكل طلب داخل القائمة (يسبب بطء شديد).
          // التتبع والإجراءات تظهر بعد فتح الطلب من تبويب "بحث عن طلب".
          

          rows.push({ orderNo: group.orderNo, vinVal, vinRaw: vins.join(" "), customerName, customerPhone, branch, orderDateRaw });
        }
        
        // ترتيب الصفوف بالأحدث أولاً (بدون الاعتماد على orderBy لتفادي مشاكل الفهارس/اختلاف أسماء الحقول)
        function toMillis(v){
          if (!v) return 0;
          // Firestore Timestamp
          if (v.toDate) return v.toDate().getTime();
          // JS Date
          if (v instanceof Date) return v.getTime();
          // number
          if (typeof v === "number") return v;
          // string
          const s = String(v).trim();
          // try parse ISO / normal date
          const t = Date.parse(s);
          if (!Number.isNaN(t)) return t;
          // fallback: if looks like dd/mm/yyyy or dd-mm-yyyy
          const m = s.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
          if (m){
            const dd = parseInt(m[1],10), mm = parseInt(m[2],10)-1, yy = parseInt(m[3],10);
            const yyyy = yy < 100 ? (2000 + yy) : yy;
            const d = new Date(yyyy, mm, dd);
            return d.getTime() || 0;
          }
          return 0;
        }

        rows.sort((a,b) => {
          const aMs = toMillis(a.orderDateRaw || a.deliveryDate || "");
          const bMs = toMillis(b.orderDateRaw || b.deliveryDate || "");
          // desc
          return bMs - aMs;
        });

ordersListCache = rows;
        loadReadOrders();
        renderOrdersList(ordersSearchInput ? ordersSearchInput.value : "");
} catch (err) {
        console.error(err);
        ordersListBody.innerHTML = "<tr><td class='err' colspan='5'>تعذر تحميل قائمة الطلبات.</td></tr>";
      }
    }

    
    async function loadArchivesList(){
      try{
        if (!archivesListBody) return;
        archivesListBody.innerHTML = "<tr><td class='muted' colspan='5'>جاري التحميل...</td></tr>";

        // Load latest archives (client-side filter for restored)
        const snap = await getDocs(query(collection(db, ARCHIVE_COLLECTION), orderBy("archivedAt","desc"), limit(300)));
        let rows = [];
        snap.forEach(d=>{
          const data = d.data() || {};
          if (data.restored === true) return; // skip restored (if any)
          rows.push({
            id: d.id,
            orderNo: data.orderNo || d.id,
            customerName: data.customerName || "",
            customerPhone: data.customerPhone || "",
            branch: data.branch || "",
            archivedAt: data.archivedAt || ""
          });
        });

        archivesListCache = rows;

        renderArchivesList(archivesSearchInput ? archivesSearchInput.value : "");
      }catch(e){
        console.error(e);
        if (archivesListBody) archivesListBody.innerHTML = "<tr><td class='err' colspan='5'>تعذر تحميل الأرشيف.</td></tr>";
      }
    }

    function renderArchivesList(filterText=""){
      const qtxt = String(filterText||"").trim().toLowerCase();
      const rows = !qtxt ? archivesListCache : archivesListCache.filter(r=>{
        return String(r.orderNo||"").toLowerCase().includes(qtxt) ||
               String(r.customerName||"").toLowerCase().includes(qtxt) ||
               String(r.customerPhone||"").toLowerCase().includes(qtxt);
      });

      if (!archivesListBody) return;

      if (!rows.length){
        archivesListBody.innerHTML = "<tr><td class='muted' colspan='5'>لا توجد طلبات مطابقة.</td></tr>";
        return;
      }

      archivesListBody.innerHTML = rows.map(r=>{
        const ord = escapeHtml(String(r.orderNo||""));
        const name = escapeHtml(String(r.customerName||""));
        const phone = escapeHtml(String(r.customerPhone||""));
        const branch = escapeHtml(String(r.branch||""));
        const at = escapeHtml(fmtTs(r.archivedAt));
        return `<tr>
          <td><a href="#" class="open-arch" data-order="${ord}">${ord}</a></td>
          <td>${name}</td>
          <td>${phone}</td>
          <td>${branch}</td>
          <td>${at}</td>
        </tr>`;
      }).join("");

      // bind open
      Array.from(archivesListBody.querySelectorAll("a.open-arch")).forEach(a=>{
        a.addEventListener("click", async (ev)=>{
          ev.preventDefault();
          const ord = a.getAttribute("data-order");
          if (!ord) return;
          await openArchivedOrder(ord);
        });
      });
    }

    async function openArchivedOrder(orderNo){
      const ord = String(orderNo||"").trim();
      if (!ord) return;

      try{
        // Load ERP lines from archive
        const linesSnap = await getDocs(query(collection(db, ARCHIVE_COLLECTION, ord, "erp_lines"), limit(500)));
        const records = [];
        linesSnap.forEach(d=>{
          const data = d.data() || {};
          records.push(data);
        });

        if (!records.length){
          alert("لا توجد بيانات ERP داخل الأرشيف لهذا الطلب.");
          return;
        }

        // set current context
        currentOrderId = ord;
        currentOrderRecords = records;
        currentIsArchiveView = true;

        // show details (read-only)
        activateTab("search");
        erpCard.style.display = "";
        stagesCard.style.display = "none"; // قراءة فقط للأرشيف
        archiveOrderBtn.style.display = "none"; // already archived

        // render ERP as normal
        fillErpTable(records);

        // small note
        if (orderMsg) orderMsg.textContent = "عرض من الأرشيف (قراءة فقط).";
      }catch(e){
        console.error(e);
        alert("تعذر فتح الطلب من الأرشيف.");
      }
    }

    if (archivesSearchInput){
      archivesSearchInput.addEventListener("input", ()=> renderArchivesList(archivesSearchInput.value));
    }

function activateTab(which) {
      currentIsArchiveView = (which === "archive");

      if (which === "list") {
        orderCard.style.display = "none";
        erpCard.style.display   = "none";
        stagesCard.style.display= "none";
        ordersListCard.style.display = "";
        archivesListCard.style.display = "none";

        tabSearchBtn.classList.remove("tab-active");
        tabListBtn.classList.add("tab-active");
        if (tabArchiveBtn) tabArchiveBtn.classList.remove("tab-active");

        loadOrdersList();
        return;
      }

      if (which === "archive") {
        orderCard.style.display = "none";
        erpCard.style.display   = "none";
        stagesCard.style.display= "none";
        ordersListCard.style.display = "none";
        archivesListCard.style.display = "";

        tabSearchBtn.classList.remove("tab-active");
        tabListBtn.classList.remove("tab-active");
        if (tabArchiveBtn) tabArchiveBtn.classList.add("tab-active");

        loadArchivesList();
        return;
      }

      // search (default)
      orderCard.style.display = "";
      erpCard.style.display   = currentOrderId ? "" : "none";
      stagesCard.style.display= "";
      ordersListCard.style.display = "none";
      archivesListCard.style.display = "none";

      tabSearchBtn.classList.add("tab-active");
      tabListBtn.classList.remove("tab-active");
      if (tabArchiveBtn) tabArchiveBtn.classList.remove("tab-active");
    }

    tabSearchBtn.addEventListener("click", () => activateTab("search"));
    tabListBtn.addEventListener("click", () => activateTab("list"));
    if (tabArchiveBtn) tabArchiveBtn.addEventListener("click", () => activateTab("archive"));

if (ordersSearchInput) {
      ordersSearchInput.addEventListener("input", () => {
        renderOrdersList(ordersSearchInput.value);
      });
    }

    ordersListBody.addEventListener("click", async (e) => {
      const btn = e.target.closest("button.link-btn");
      if (!btn) return;
      const ord = btn.dataset.order;
      // mark as read (opened once) like mail behavior
      ordersReadSet.add(String(ord || ""));
      saveReadOrders();

      try { await navigator.clipboard.writeText(ord); } catch(e) { console.warn(e); }
      orderIdInput.value = ord;
      vinInput.value = "";
      activateTab("search");
      loadOrder();
    });

    // زر توليد رابط التتبع
    if (trackLinkBtn) {
      trackLinkBtn.addEventListener("click", async () => {
        if (!currentVin) {
          alert("لم يتم اختيار رقم الهيكل.");
          return;
        }

        const url = `https://mzj-tracking.vercel.app/Test-Track.html?vin=${encodeURIComponent(currentVin)}`;

        // فتح الرابط في تبويب جديد
        window.open(url, "_blank");

        // نسخ الرابط إلى الحافظة
        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(url);
            alert("تم نسخ رابط التتبع:\n" + url);
          } catch (err) {
            console.warn("لم يتم النسخ إلى الحافظة", err);
          }
        }
      });
    }


    // إدارة حالة تسجيل الدخول وتوزيع الواجهات
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // مستخدم مسجل دخول
        whoami.textContent = user.email || "";
        logoutBtn.style.display = "inline-flex";

        authCard.style.display = "none";
        tabsBar.style.display  = "flex";

        orderCard.style.display  = "";
        if (currentOrderId) {
          erpCard.style.display    = "";
          stagesCard.style.display = "";
        } else {
          erpCard.style.display    = "none";
          stagesCard.style.display = "none";
        }
        ordersListCard.style.display = "none";
        refreshArchiveUI();
      } else {
        // لا يوجد مستخدم
        whoami.textContent = "";
        logoutBtn.style.display = "none";

        authCard.style.display     = "";
        tabsBar.style.display      = "none";
        orderCard.style.display    = "none";
        erpCard.style.display      = "none";
        stagesCard.style.display   = "none";
        ordersListCard.style.display = "none";
        refreshArchiveUI();
      }
    });

    // زر تسجيل الدخول
    loginBtn.addEventListener("click", async () => {
      authMsg.textContent = "";
      const emailVal = (email.value || "").trim();
      const passVal  = (password.value || "").trim();

      if (!emailVal || !passVal) {
        authMsg.innerHTML = "<span class='err'>أدخل البريد الإلكتروني وكلمة السر.</span>";
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, emailVal, passVal);
        authMsg.innerHTML = "<span class='ok'>تم تسجيل الدخول بنجاح.</span>";
      } catch (e) {
        console.error(e);
        authMsg.innerHTML = "<span class='err'>تعذر تسجيل الدخول. تأكد من البيانات أو تواصل مع المسؤول.</span>";
      }
    });

    // زر إنشاء حساب جديد (للمشرف فقط)
    if (signupBtn) signupBtn.addEventListener("click", async () => {
      authMsg.textContent = "";
      const emailVal = (email.value || "").trim();
      const passVal  = (password.value || "").trim();

      if (!emailVal || !passVal) {
        authMsg.innerHTML = "<span class='err'>أدخل البريد الإلكتروني وكلمة السر.</span>";
        return;
      }

      try {
        await createUserWithEmailAndPassword(auth, emailVal, passVal);
        authMsg.innerHTML = "<span class='ok'>تم إنشاء الحساب وتسجيل الدخول.</span>";
      } catch (e) {
        console.error(e);
        authMsg.innerHTML = "<span class='err'>تعذر إنشاء الحساب. ربما يكون البريد مستخدم من قبل.</span>";
      }
    });

    // زر تسجيل الخروج
    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (e) {
        console.error(e);
      }
    });

    // تهيئة أولية للصفحة
    tabsBar.style.display      = "none";
    orderCard.style.display    = "none";
    erpCard.style.display      = "none";
    stagesCard.style.display   = "none";
    ordersListCard.style.display = "none";

    clearErpTable();
    buildStagesUI({ });

  </script>

<script>
  // Topbar connection badge helper (non-invasive)
  (function(){
    const who = document.getElementById('whoami');
    const dot = document.getElementById('connDot');
    const txt = document.getElementById('connText');
    function tick(){
      const hasUser = who && (who.textContent||'').trim().length>0;
      if(dot) dot.className = 'dot ' + (hasUser ? 'ok' : 'warn');
      if(txt) txt.textContent = hasUser ? 'متصل' : 'غير مسجل';
    }
    setInterval(tick, 700);
    setTimeout(tick, 50);
  })();
</script>

  <script src="./mzj-ui.js"></script>

      </div>
    </main>
  </div>


  <!-- Message Modal (Edit before send) -->
  <div id="msgModal" style="display:none;position:fixed;inset:0;z-index:9999;">
    <div id="msgModalBackdrop" style="position:absolute;inset:0;background:rgba(0,0,0,.45);"></div>
    <div style="position:relative;max-width:680px;margin:7vh auto;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid #e5e7eb;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:rgba(188,143,116,.16);color:var(--brown);font-weight:900;">
            <i class="fa-solid fa-paper-plane"></i>
          </div>
          <div>
            <div id="msgModalTitle" style="font-weight:900;color:var(--brown);">إرسال رسالة</div>
            <div id="msgModalSub" style="font-size:12px;color:var(--muted);margin-top:2px;">—</div>
          </div>
        </div>
        <button id="msgModalClose" class="btn-outline" type="button" style="font-size:12px;">إغلاق</button>
      </div>

      <div style="padding:12px 14px;">
        <label style="margin:0 0 6px 0;">نص الرسالة (تقدر تعدّل قبل الإرسال)</label>
        <textarea id="msgModalText" rows="9" style="width:100%;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#f9fafb;font-family:inherit;font-size:14px;outline:none;resize:vertical;"></textarea>
        <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-top:10px;">
          <div class="muted" style="font-size:12px;">
            <span class="badge" id="msgModalChannel">—</span>
            <span class="badge" id="msgModalPhone">—</span>
            <span class="badge" id="msgModalVin">—</span>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="msgModalCopy" class="btn-outline" type="button" style="font-size:12px;"><i class="fa-regular fa-copy"></i> نسخ النص</button>
            <button id="msgModalReset" class="btn-outline" type="button" style="font-size:12px;"><i class="fa-solid fa-rotate-left"></i> رجوع للنص الأصلي</button>
            <button id="msgModalSend" class="btn" type="button" style="font-size:12px;"><i class="fa-solid fa-paper-plane"></i> إرسال</button>
          </div>
        </div>
        <div id="msgModalMsg" class="muted" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <!-- Dynamic QR (Clickable) -->
  <div id="trackQrModal" style="display:none;position:fixed;inset:0;z-index:9998;">
    <div id="trackQrBackdrop" style="position:absolute;inset:0;background:rgba(0,0,0,.45);"></div>
    <div style="position:relative;max-width:420px;margin:10vh auto;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid #e5e7eb;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:rgba(188,143,116,.16);color:var(--brown);font-weight:900;">
            <i class="fa-solid fa-qrcode"></i>
          </div>
          <div>
            <div style="font-weight:900;color:var(--brown);">QR تتبع العميل</div>
            <div id="trackQrSub" style="font-size:12px;color:var(--muted);margin-top:2px;">اضغط على الـ QR لفتح التتبع مباشرة</div>
          </div>
        </div>
        <button id="trackQrClose" class="btn-outline" type="button" style="font-size:12px;">إغلاق</button>
      </div>
      <div style="padding:14px;text-align:center;">
        <a id="trackQrLink" href="#" target="_blank" style="display:inline-block;text-decoration:none;">
          <img id="trackQrImg" alt="QR Tracking" style="width:240px;height:240px;border-radius:14px;border:1px solid #e5e7eb;background:#fff;"/>
        </a>
        <div class="hint" style="margin-top:10px;">رابط التتبع: <button id="trackQrCopy" class="link-btn" type="button">نسخ الرابط</button></div>
      </div>
    </div>
  </div>

</body>
</html>

            </template>
          </div>
        </div>

</div>
        </div>

        <!-- الأرشيف (فارغ مؤقتًا) -->
        <div class="view" id="view-archive" role="tabpanel">
          <div class="card">
            <h3>الأرشيف</h3>
            <div class="small muted">التاب جاهز (فارغ مؤقتًا).</div>
          </div>
        </div>

                <!-- إدارة المستخدمين -->
        <div class="view" id="view-users" role="tabpanel">
          <div class="grid">
            <div class="card">
              <h3>إدارة المستخدمين</h3>
              <div class="body">
                <div class="toolbar">
                  <div class="field" style="flex:1;min-width:240px">
                    <label>بحث</label>
                    <input id="ua_search" placeholder="ابحث بالبريد أو الاسم أو UID" autocomplete="off" />
                  </div>
                  <div class="field" style="min-width:220px">
                    <label>فلتر الحالة</label>
                    <select id="ua_active_filter">
                      <option value="all">الكل</option>
                      <option value="active">نشط فقط</option>
                      <option value="inactive">غير نشط فقط</option>
                    </select>
                  </div>
                  <button id="ua_refresh" class="btn secondary">تحديث</button>
                </div>

                <div class="row" style="margin-top:8px">
                  <div>
                    <label>اسم المستخدم (لإنشاء سجل جديد)</label>
                    <input id="ua_new_name" placeholder="اسم المستخدم" autocomplete="off" />
                  </div>
                  <div>
                    <label>البريد الإلكتروني</label>
                    <input id="ua_new_email" placeholder="email@example.com" autocomplete="off" />
                  </div>
                  <div>
                    <label>UID (اختياري)</label>
                    <input id="ua_new_uid" placeholder="UID" autocomplete="off" />
                  </div>
                  <div style="display:flex;align-items:flex-end;gap:8px">
                    <button id="ua_create" class="btn primary">إنشاء سجل مستخدم</button>
                  </div>
                </div>
                <div class="small" style="margin-top:8px;color:var(--muted)">
                  ملاحظة: هذا التاب لإدارة صلاحيات المستخدمين في Firestore فقط (collection: <b>users</b>) حسب قالب الصلاحيات الذي اعتمدته.
                </div>

                <div class="hr" style="margin:12px 0"></div>

                <div class="tableWrap" style="max-height:520px">
                  <table>
                    <thead>
                      <tr>
                        <th>الاسم</th>
                        <th>البريد</th>
                        <th>UID</th>
                        <th>الحالة</th>
                        <th>آخر تحديث</th>
                        <th>إجراء</th>
                      </tr>
                    </thead>
                    <tbody id="ua_tbody">
                      <tr><td colspan="6" class="small muted">—</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="card" id="ua_editor" style="display:none">
              <h3>صلاحيات المستخدم</h3>
              <div class="body">
                <div class="small muted" id="ua_editor_user">—</div>
                <div class="hr" style="margin:12px 0"></div>

                <div class="row">
                  <div>
                    <label>الاسم</label>
                    <input id="ua_name" />
                  </div>
                  <div>
                    <label>البريد</label>
                    <input id="ua_email" />
                  </div>
                  <div>
                    <label>الحالة</label>
                    <select id="ua_active">
                      <option value="true">نشط</option>
                      <option value="false">غير نشط</option>
                    </select>
                  </div>
                  <div style="display:flex;align-items:flex-end;gap:8px">
                    <button id="ua_save" class="btn primary">حفظ</button>
                    <button id="ua_close" class="btn secondary">إغلاق</button>
                  </div>
                </div>

                <div class="hr" style="margin:12px 0"></div>

                <div class="small" style="margin-bottom:8px"><b>التابات</b></div>
                <div id="ua_tabs_box" class="checks"></div>

                <div class="hr" style="margin:12px 0"></div>

                <div class="small" style="margin-bottom:8px"><b>الصلاحيات التفصيلية</b></div>
                <div id="ua_perms_box"></div>

                <div class="hr" style="margin:12px 0"></div>
                <div class="small muted">تُحفظ الصلاحيات بنفس شكل القالب: tabs + permissions (buttons/fields/sections...)
                </div>
              </div>
            </div>
          </div>
        </div>
<script>
    // Helper: short selector by id
    const $ = (id)=>document.getElementById(id);

    // ===== Firebase Config (mzj-workflow) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBaor-9gU1XYmTD-3YCP14Kstf7HvMEC_M",
      authDomain: "mzj-workflow.firebaseapp.com",
      projectId: "mzj-workflow",
      storageBucket: "mzj-workflow.firebasestorage.app",
      messagingSenderId: "71098850303",
      appId: "1:71098850303:web:ac5d165282c197f8fa65ca",
      measurementId: "G-N5Q63YGLWF"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ===== Access Control (tabs + permissions) =====
    // UI visibility is controlled here (Firestore Rules control data access only).
    const ADMIN_EMAILS = [
      'mr.ahmed_rashed@outlook.sa',
      'ceo@mzjcars.com',
      'hossamzayan10@gmail.com'
    ];

    let CURRENT_USER_DOC = null;

    function isAdminClient(user, userDocData){
      const em = (user?.email || '').toLowerCase();
      if(ADMIN_EMAILS.includes(em)) return true;
      const role = (userDocData?.role || '').toString().toLowerCase();
      return role === 'admin' || role === 'administrator' || role === 'administration' || role.includes('ادار');
    }

    function canShowTabKey(tabKey, user, userDocData){
      if(isAdminClient(user, userDocData)) return true;
      if(userDocData?.active === false) return false;

      // Prefer tabs.* if present, otherwise fallback to permissions.*.view
      const tabs = userDocData?.tabs;
      if(tabs && Object.prototype.hasOwnProperty.call(tabs, tabKey)) {
        return tabs[tabKey] === true;
      }
      const perms = userDocData?.permissions;
      if(perms && perms[tabKey] && typeof perms[tabKey] === 'object' && 'view' in perms[tabKey]){
        return perms[tabKey].view === true;
      }
      // default: hidden
      return false;
    }

    const VIEW_TO_TABKEY = {
      'view-dashboard': 'dashboard',
      'view-admin': 'admin',
      'view-inventory': 'inventory',
      'view-transfer': 'car_transfer',
      'view-requests': 'requests',
      'view-allcars': 'all_cars',
      'view-logs': 'movement_log',
      'view-tracking': 'tracking',
      'view-archive': 'archive',
      'view-users': 'users_admin'
    };

    function applyAccessControl(user, userDocData){
      // Tabs in top bar
      document.querySelectorAll('.tabbar .tab').forEach(tabEl=>{
        const viewId = tabEl.dataset.view;
        const key = VIEW_TO_TABKEY[viewId];
        if(!key) return;
        const ok = canShowTabKey(key, user, userDocData);
        tabEl.style.display = ok ? '' : 'none';
        tabEl.setAttribute('aria-hidden', ok ? 'false' : 'true');
      });

      // If current active view is not allowed, open first allowed view
      const activeTab = document.querySelector('.tabbar .tab.active');
      const currentView = activeTab?.dataset?.view || 'view-admin';
      const currentKey = VIEW_TO_TABKEY[currentView];
      if(currentKey && !canShowTabKey(currentKey, user, userDocData)) {
        const first = Array.from(document.querySelectorAll('.tabbar .tab'))
          .find(t=>t.style.display !== 'none');
        if(first) {
          openView(first.dataset.view);
        } else {
          // nothing allowed -> force dashboard hidden app
          toast('لا توجد صلاحيات عرض لأي تبويب.');
        }
      }

      // Also disable some buttons/fields quickly based on detailed permissions if present
      // (We keep current behavior unless permission nodes exist).
      try{
        const perms = userDocData?.permissions || {};
        // Dashboard buttons
        if(perms.dashboard?.buttons){
          const b = perms.dashboard.buttons;
          if($('dash_filter_save')) $('dash_filter_save').style.display = (b.save===true || isAdminClient(user,userDocData)) ? '' : 'none';
          if($('dash_filter_clear')) $('dash_filter_clear').style.display = (b.clear===true || isAdminClient(user,userDocData)) ? '' : 'none';
        }
      }catch(e){ /* ignore */ }
    }

    async function loadCurrentUserDoc(user){
      try{
        const snap = await db.collection('users').doc(user.uid).get();
        if(!snap.exists) return null;
        return snap.data() || null;
      }catch(e){
        console.warn('loadCurrentUserDoc', e);
        return null;
      }
    }

    // ===== Inventory Live (Fix: startInventoryLive/stopInventoryLive) =====
    let invUnsub = null;
    let invAll = [];

    function norm(v){ return (v ?? '').toString().trim(); }
    function toKey(v){ return norm(v).toLowerCase(); }

    function getInvFilters(){
      const q = toKey($('inv_search')?.value || '');
      const branch = norm($('inv_location')?.value || '').trim();
      const status = norm($('inv_status')?.value || '').trim();
      const model  = norm($('inv_model')?.value || '').trim();
      return { q, branch, status, model };
    }

    function matchesSearch(car, q){
      if(!q) return true;
      const bag = [
        car.vin, car.carName, car.statement, car.agent,
        car.interiorColor, car.exteriorColor, car.model,
        car.plate, car.batchName, car.location, car.status,
        car.noteLocation, car.noteMissing, car.trackingLink
      ].map(toKey).join(' | ');
      return bag.includes(q);
    }

    function renderInventory(){
      const table = $('inv_table');
      if(!table) return;
      let tbody = table.querySelector('tbody');
      if(!tbody){ tbody = document.createElement('tbody'); table.appendChild(tbody); }

      const { q, branch, status, model } = getInvFilters();
      const filtered = invAll.filter(car=>{
        if(car && car.isArchived && (!status || status==='الكل')) return false;
        if(branch && branch!=='الكل' && norm(car.location)!==branch) return false;
        if(status && status!=='الكل' && norm(car.status)!==status) return false;
        if(model  && model!=='الكل'  && norm(car.model)!==model) return false;
        return matchesSearch(car, q);
      });

      tbody.innerHTML = '';
      if(filtered.length===0){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 18;
        td.style.textAlign = 'center';
        td.style.padding = '14px';
        td.textContent = 'لا توجد بيانات مطابقة.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        $('inv_meta').textContent = 'إجمالي: 0';
        return;
      }

      filtered.forEach(car=>{
        const tr = document.createElement('tr');

        function tdText(v){
          const td=document.createElement('td');
          td.textContent = norm(v);
          return td;
        }

        tr.appendChild(tdText(car.vin));
        tr.appendChild(tdText(car.carName));
        tr.appendChild(tdText(car.statement));
        tr.appendChild(tdText(car.agent));
        tr.appendChild(tdText(car.interiorColor));
        tr.appendChild(tdText(car.exteriorColor));
        tr.appendChild(tdText(car.model));
        tr.appendChild(tdText(car.plate));
        tr.appendChild(tdText(car.batchName));
        tr.appendChild(tdText(car.location));
        tr.appendChild(tdText(car.noteLocation));
        tr.appendChild(tdText(car.noteMissing));
        tr.appendChild(tdText(car.status));

        // Tracking
        {
          const td=document.createElement('td');
          const link = (car.trackingLink || car.tracking || '').toString().trim();
          if(link){
            const b=document.createElement('button');
            b.className='btn btn-sm';
            b.textContent='عرض';
            b.addEventListener('click', ()=>{
              const safe = escapeHtml(link);
              openDetailsModal(`
                <div style="display:grid;gap:10px">
                  <div class="small"><b>رابط التتبع:</b></div>
                  <div class="pill" style="display:flex;gap:8px;align-items:center;justify-content:space-between">
                    <span style="word-break:break-all">${safe}</span>
                    <button class="btn secondary" id="trk_copy_btn">نسخ</button>
                  </div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <a class="btn" href="${safe}" target="_blank" rel="noopener">فتح الرابط</a>
                  </div>
                </div>
              `, 'Tracking');
              // bind copy
              setTimeout(()=>{
                const cb = document.getElementById('trk_copy_btn');
                if(cb){
                  cb.addEventListener('click', async ()=>{
                    try{
                      await navigator.clipboard.writeText(link);
                      toast('تم نسخ رابط التتبع');
                    }catch(e){
                      console.error(e);
                      toast('تعذر النسخ');
                    }
                  });
                }
              }, 0);
            });
            td.appendChild(b);
          }else{
            td.textContent='—';
          }
          tr.appendChild(td);
        }

        // Approvals
        {
          const td=document.createElement('td');
          const b=document.createElement('button');
          b.className='btn btn-sm';
          b.textContent='عرض';
          b.addEventListener('click', ()=>{
            const fin = !!(car.approvals && car.approvals.financial);
            const adm = !!(car.approvals && car.approvals.admin);
            openDetailsModal(`
              <div style="display:grid;gap:10px">
                <div class="pill" style="display:flex;justify-content:space-between;align-items:center">
                  <span>الموافقة المالية</span><strong>${fin?'✅':'❌'}</strong>
                </div>
                <div class="pill" style="display:flex;justify-content:space-between;align-items:center">
                  <span>الموافقة الادارية</span><strong>${adm?'✅':'❌'}</strong>
                </div>
              </div>
            `, 'الموافقات');
          });
          td.appendChild(b);
          tr.appendChild(td);
        }

        // Checklist
        {
          const td=document.createElement('td');
          const b=document.createElement('button');
          b.className='btn btn-sm';
          b.textContent='عرض';
          b.addEventListener('click', ()=>{
            const c = car.checklist || {};
            const rows = [
              ['حساس', c.sensors],
              ['كاميرا', c.camera],
              ['مكيف', c.ac],
              ['مسجل', c.musajjal ?? c.recorder],
              ['شاشة', c.screen],
              ['ريموت', c.remote],
              ['فرشات', c.farshat],
              ['طفاية', c.tafaia],
              ['شنطة سلامة', c.shanta],
              ['اسبير', c.spare],
            ].map(([k,v])=>`
              <div class="pill" style="display:flex;justify-content:space-between;align-items:center">
                <span>${k}</span><strong>${v ? '✅' : '❌'}</strong>
              </div>
            `).join('');
            openDetailsModal(`<div style="display:grid;gap:10px">${rows}</div>`, 'التشيك');
          });
          td.appendChild(b);
          tr.appendChild(td);
        }
        // Transfers logs
        {
          const td=document.createElement('td');
          const b=document.createElement('button');
          b.className='btn btn-sm';
          b.textContent='عرض';
          b.addEventListener('click', async ()=>{
            b.disabled = true;
            b.textContent = '...';
            try{
              // ملاحظة: نتجنب orderBy هنا لتفادي متطلبات الـ index
              const snap = await db.collection('logs')
                .where('vin','==',car.vin)
                .limit(200)
                .get();

              if(snap.empty){
                openDetailsModal('<div class="small">لا توجد حركات مسجلة لهذه السيارة.</div>', 'طلبات النقل');
              }else{
                const items = [];
                snap.forEach(doc=>{
                  const d = doc.data()||{};
                  const act = (d.action||'').toString();
                  if(!act.includes('transfer')) return;

                  const dt = d.at && d.at.toDate ? d.at.toDate() : null;
                  const at = dt ? dt.toLocaleString('ar-SA') : (d.at||'');

                  const fromLoc = d.fromLocation ?? d.fromLoc ?? d.from ?? '—';
                  const toLoc   = d.toLocation   ?? d.toLoc   ?? d.to   ?? '—';
                  const fromSt  = d.fromStatus ?? '—';
                  const toSt    = d.toStatus   ?? '—';
                  const by      = d.by || '';
                  const note    = (d.note||'').toString();

                  items.push({
                    atMs: dt ? dt.getTime() : 0,
                    html: `
                      <div class="pill" style="display:grid;gap:6px">
                        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
                          <strong>${escapeHtml(at)}</strong>
                          <span class="small">${escapeHtml(by)}</span>
                        </div>
                        <div class="small">من: ${escapeHtml(fromLoc)} → إلى: ${escapeHtml(toLoc)}</div>
                        <div class="small">الحالة: ${escapeHtml(fromSt)} → ${escapeHtml(toSt)}</div>
                        ${note ? `<div class="small"><b>ملاحظة:</b> ${escapeHtml(note)}</div>` : ``}
                      </div>
                    `
                  });
                });

                items.sort((a,b)=> (b.atMs||0) - (a.atMs||0));
                const html = items.length
                  ? `<div style="display:grid;gap:10px">${items.map(x=>x.html).join('')}</div>`
                  : '<div class="small">لا توجد حركات نقل.</div>';

                openDetailsModal(html, 'طلبات النقل');
              }
            }catch(e){
              console.error(e);
              openDetailsModal('<div class="small">تعذر تحميل سجل النقل.</div>', 'طلبات النقل');
            }finally{
              b.disabled = false;
              b.textContent = 'عرض';
            }
          });
          td.appendChild(b);
          tr.appendChild(td);
        }

        // Archive
        {
          const td=document.createElement('td');
          const b=document.createElement('button');
          b.className='btn btn-sm';
          b.textContent='أرشيف';
          const canShow = norm(car.status)==='مباع تم التسليم';
          if(!canShow){
            b.style.display='none';
          }else{
            const fin = !!(car.approvals && car.approvals.financial);
            const adm = !!(car.approvals && car.approvals.admin);
            const hasTrack = !!car.trackingLink;
            // We require at least one transfer log (best-effort check: will be verified on click)
            b.disabled = !(fin && adm && hasTrack);
            b.title = b.disabled ? 'يجب اكتمال الموافقات + Tracking' : '';
            b.addEventListener('click', async ()=>{
              b.disabled = true;
              b.textContent='...';
              try{
                // verify transfer exists
                const trSnap = await db.collection('logs').where('vin','==',car.vin).limit(1).get();
                if(trSnap.empty) { toast('لا يمكن الأرشفة بدون طلبات نقل'); b.disabled=false; b.textContent='أرشيف'; return; }

                const archivedBy = (auth.currentUser && auth.currentUser.email) || '';
                const archivedAt = firebase.firestore.FieldValue.serverTimestamp();

                // 1) write to archives (اختياري — قد يكون ممنوع بالقواعد)
                try{
                  await db.collection('archives').doc(car.vin).set({
                    ...((car && car._raw)?car._raw:car),
                    archivedAt,
                    archivedBy
                  }, { merge:true });
                }catch(archErr){
                  console.warn('archive write blocked', archErr);
                }

                // 2) Mark archived داخل نفس مستند السيارة (بدون Delete لتفادي صلاحيات الحذف)
                await db.collection('cars').doc(car.vin).set({
                  isArchived: true,
                  archivedAt,
                  archivedBy,
                  status: 'مؤرشف',
                  location: 'archives'
                }, { merge:true });

                toast('تم أرشفة السيارة');
}catch(e){
                console.error(e);
                const msg = (e && (e.message || e.code)) ? (e.message || e.code) : '';
                toast('تعذر أرشفة السيارة' + (msg?(' — '+msg):''));
              }finally{
                b.textContent='أرشيف';
              }
            });
          }
          td.appendChild(b);
          tr.appendChild(td);
        }

        tbody.appendChild(tr);
      });

      $('inv_meta').textContent = `إجمالي: ${filtered.length}`;
    }

    function startInventoryLive(){
      if(invUnsub) return;
      const metaEl = $('inv_meta');
      if(metaEl) metaEl.textContent = 'جاري التحميل...';
      invUnsub = db.collection('cars').onSnapshot((snap)=>{
        invAll = [];
        snap.forEach(doc=>{
          const d = doc.data() || {};
          const car = {
            vin: doc.id,
            isArchived: !!(d.isArchived || d.archivedAt),
            carName: d.carName || d.car || d.name || d.vehicle || '',
            statement: d.statement || d.trim || d.desc || d.variant || '',
            agent: (d.agent || d.dealer || d.vendor || d.agency || d['الوكيل'] || ''),
            interiorColor: d.interiorColor || '',
            exteriorColor: d.exteriorColor || '',
            model: d.model || '',
            plate: d.plate || '',
            batchName: d.batchName || '',
            location: d.location || '',
            notesLocation: d.notesLocation || d.noteLocation || '',
            noteLocation: d.notesLocation || d.noteLocation || '',
            notesMissing: d.notesMissing || d.noteMissing || '',
            noteMissing: d.notesMissing || d.noteMissing || '',
            status: (d.status || d.state || d.statuses || d['الحالة'] || ''),
            trackingLink: d.trackingLink || '',
            approvals: d.approvals || {financial:false, admin:false},
            checklist: d.checklist || {},
            _raw: d
          };
          invAll.push(car);
        });
        renderInventory();
      }, (err)=>{
        console.error(err);
        if($('inv_meta')) $('inv_meta').textContent = 'تعذر تحميل المخزون';
        toast(err?.message || 'تعذر تحميل المخزون');
      });
    }

    function stopInventoryLive(){
      if(invUnsub){ invUnsub(); invUnsub=null; }
    }


    /****************************************************
     * Dashboard
     ****************************************************/
    let dashCarsUnsub = null;
    let dashCatalogUnsub = null;
    let dashCars = [];
    let dashCatalog = [];

    function normStatus(s){
      s = (s||'').toString().trim();
      // توحيد مسميات تحت/تم التسليم
      if(s === 'تحت التسليم') return 'مباع تحت التسليم';
      if(s === 'تم التسليم') return 'مباع تم التسليم';
      if(s === 'مباع تحت التسلم') return 'مباع تحت التسليم';
      if(s === 'مباع تحت التسليم') return 'مباع تحت التسليم';
      if(s === 'مباع تم التسليم') return 'مباع تم التسليم';
      if(s === 'محجوز') return 'حجز';
      return s;
    }

    function isActualStatus(st){
      const s = normStatus(st);
      return (s==='متاح للبيع' || s==='محجوز' || s==='حجز' || s==='بها ملاحظات');
    }

    function statusBucket(st){
      const s = normStatus(st);
      if(s==='متاح للبيع') return 'avail';
      if(s==='محجوز' || s==='حجز') return 'reserved';
      if(s==='بها ملاحظات') return 'notes';
      if(s==='مباع تحت التسليم') return 'under';
      if(s==='مباع تم التسليم') return 'delivered';
      return 'other';
    }

    function countAgg(cars){
      const out = {avail:0,reserved:0,notes:0,under:0,delivered:0,other:0};
      cars.forEach(c=>{ out[statusBucket(c.status)] += 1; });
      out.totalActual = out.avail + out.reserved + out.notes;
      out.keysTotal = out.totalActual + out.under;
      return out;
    }

    function setText(id, val){
      const el = document.getElementById(id);
      if(el) el.textContent = (val===null||val===undefined) ? '—' : String(val);
    }

    function applyAgg(prefix, agg){
      setText(prefix+'_totalActual', agg.totalActual);
      setText(prefix+'_keysTotal', agg.keysTotal);
      setText(prefix+'_avail', agg.avail);
      setText(prefix+'_reserved', agg.reserved);
      setText(prefix+'_notes', agg.notes);
      setText(prefix+'_under', agg.under);
      setText(prefix+'_delivered', agg.delivered);
    }

    
    
    async function loadDashLocationsIntoSelect(){
      const sel = document.getElementById('dash_filter_location');
      const statusesWrap = document.getElementById('dash_filter_statuses');
      if(!sel) return;

      const curLoc = (sel.value||'').toString();
      const checkedStatuses = new Set((statusesWrap ? Array.from(statusesWrap.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value) : []));

      let branches = [];
      let statuses = [];

      // Read from meta/lists (fields: branches, statuses)
      try{
        const mDoc = await db.collection('meta').doc('lists').get();
        if(mDoc.exists){
          const d = mDoc.data() || {};
          branches = Array.isArray(d.branches) ? d.branches : [];
          statuses = Array.isArray(d.statuses) ? d.statuses : [];
        }
      }catch(e){
        console.warn('meta/lists read failed', e);
      }

      // Fallback branches from cars snapshot
      if(!branches.length){
        branches = Array.from(new Set(dashCars.map(c=>(c.location||'').toString().trim()).filter(Boolean)))
          .sort((a,b)=>a.localeCompare(b,'ar'));
      }

      // Final fallback safe
      if(!branches.length){
        branches = ['الملتقى','القادسية','الصالة','الوكالة','المستودع'];
      }

      sel.innerHTML = '<option value="">— اختر —</option>' + branches.map(b=>`<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`).join('');
      if(curLoc && branches.includes(curLoc)) sel.value = curLoc;

      // Rebuild statuses checkboxes from meta (if container exists)
      if(statusesWrap){
        if(!statuses.length){
          statuses = ['متاح للبيع','محجوز','بها ملاحظات','مباع تحت التسليم','مباع تم التسليم'];
        }
        statusesWrap.innerHTML = statuses.map((st)=>{
          const checked = checkedStatuses.has(st) ? 'checked' : '';
          return `<label class="dashChk"><input type="checkbox" value="${escapeHtml(st)}" ${checked}> ${escapeHtml(st)}</label>`;
        }).join('');
      }
    }

    function readSavedDashFilter(){
      try{
        const raw = localStorage.getItem('mzj_dash_filter');
        return raw ? JSON.parse(raw) : null;
      }catch(e){ return null; }
    }

    function writeSavedDashFilter(obj){
      try{ localStorage.setItem('mzj_dash_filter', JSON.stringify(obj||{})); }catch(e){}
    }

    function getDashFilterFromUI(){
      const loc = (document.getElementById('dash_filter_location')?.value || '').trim();
      const checks = Array.from(document.querySelectorAll('#dash_filter_statuses input[type="checkbox"]'));
      const statuses = checks.filter(c=>c.checked).map(c=>c.value);
      return {location: loc, statuses};
    }

    function applyDashFilterToUI(obj){
      obj = obj || {};
      const sel = document.getElementById('dash_filter_location');
      if(sel) sel.value = obj.location || '';
      const checks = Array.from(document.querySelectorAll('#dash_filter_statuses input[type="checkbox"]'));
      const set = new Set(obj.statuses || []);
      checks.forEach(c=> c.checked = set.has(c.value));
    }

    
    function markDashboardTotalsHighlight(){
      const ids = ['stk_totalActual','stk_keysTotal','ag_totalActual','ag_keysTotal','b1_totalActual','b1_keysTotal','b2_totalActual','b2_keysTotal','b3_totalActual','b3_keysTotal'];
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        const kpi = el.closest('.dashKpi');
        if(kpi) kpi.classList.add('kpiHighlight');
      });
    }

    function renderDashboard(){

      // global
      const allAgg = countAgg(dashCars);
      applyAgg('stk', allAgg);

      // agency + branches
      const byLoc = (loc)=> dashCars.filter(c=>(c.location||'').toString().trim()===loc);
      applyAgg('ag', countAgg(byLoc('الوكالة')));
      applyAgg('b1', countAgg(byLoc('الصالة')));
      applyAgg('b2', countAgg(byLoc('الملتقى')));
      applyAgg('b3', countAgg(byLoc('القادسية')));

      // approvals (status under delivery)
      const under = dashCars.filter(c=>normStatus(c.status)==='مباع تحت التسليم');
      const needFin = under.filter(c=>!(c.approvals && c.approvals.financial===true));
      const needAdm = under.filter(c=>!(c.approvals && c.approvals.admin===true));
      const ready   = under.filter(c=>(c.approvals && c.approvals.financial===true && c.approvals.admin===true));
      setText('ap_need_fin', needFin.length);
      setText('ap_need_adm', needAdm.length);
      setText('ap_ready', ready.length);
      // Missing (catalog)
      const missMeta = document.getElementById('miss_meta');
      if(!dashCatalog.length){
        setText('miss_total', '—');
        if(missMeta) missMeta.textContent = 'لم يتم العثور على catalog. أنشئ catalog لتفعيل كارت النواقص.';
      }else{
        if(missMeta) missMeta.textContent = 'يُحسب من الإجمالي الفعلي (متاح للبيع + محجوز + بها ملاحظات) بالاعتماد على catalog.';
        let total=0;
        ['الوكالة','الصالة','الملتقى','القادسية'].forEach(loc=>{
          total += computeMissingForBranch(loc).length;
        });
        setText('miss_total', total);
      }

      // Render saved cards + highlight totals
      if(typeof renderSavedDashCards==='function') renderSavedDashCards();
      if(typeof markDashboardTotalsHighlight==='function') markDashboardTotalsHighlight();

      // Saved filter meta
      const fmeta = document.getElementById('dash_filter_meta');
      const saved = readSavedDashFilter();
      if(fmeta){
        if(saved && (saved.location || (saved.statuses||[]).length)){
          fmeta.textContent = `محفوظ: ${saved.location||'—'} | حالات: ${(saved.statuses||[]).join('، ')||'—'}`;
        }else{
          fmeta.textContent = '—';
        }
      }
    }


    function catKey(obj){
      const carName = (obj.carName||obj['السيارة']||'').toString().trim();
      const statement = (obj.statement||obj['البيان']||'').toString().trim();
      const interiorColor = (obj.interiorColor||obj.colorInside||obj['اللون الداخلي']||'').toString().trim();
      const exteriorColor = (obj.exteriorColor||obj.colorOutside||obj['اللون الخارجي']||'').toString().trim();
      const model = (obj.model||obj['موديل']||'').toString().trim();
      return '|' + [carName, statement, interiorColor, exteriorColor, model].join('|') + '|';
    }

    function carToCatKey(c){
      return '|' + [
        (c.carName||'').toString().trim(),
        (c.statement||'').toString().trim(),
        (c.interiorColor||'').toString().trim(),
        (c.exteriorColor||'').toString().trim(),
        (c.model||'').toString().trim()
      ].join('|') + '|';
    }

    function computeMissingForBranch(branch){
      if(!dashCatalog.length) return [];
      const actualCars = dashCars.filter(c=>(c.location||'').toString().trim()===branch && isActualStatus(c.status));
      const set = new Set(actualCars.map(carToCatKey));
      const missing = [];
      dashCatalog.forEach(item=>{
        const key = catKey(item);
        if(!set.has(key)) missing.push(item);
      });
      return missing;
    }

    
    function openMissingModal(branch){
      const arr = computeMissingForBranch(branch);
      const uid = 'miss_' + Date.now();
      const searchId = uid + '_q';
      const expId = uid + '_x';
      const tableId = uid + '_t';

      const rows = arr.map((it)=>{
        const d = it._raw || it;
        const carName = (d.carName||d['السيارة']||'—');
        const statement = (d.statement||d['البيان']||'—');
        const interiorColor = (d.interiorColor||d.colorInside||d['اللون الداخلي']||'—');
        const exteriorColor = (d.exteriorColor||d.colorOutside||d['اللون الخارجي']||'—');
        const model = (d.model||d['موديل']||'—');
        return `<tr><td>${escapeHtml(carName)}</td><td>${escapeHtml(statement)}</td><td>${escapeHtml(interiorColor)}</td><td>${escapeHtml(exteriorColor)}</td><td>${escapeHtml(model)}</td></tr>`;
      }).join('');

      const html = `
        <div class="toolbar" style="gap:10px;align-items:flex-end;margin-bottom:10px">
          <div class="field" style="flex:1;min-width:220px">
            <label>بحث</label>
            <input id="${searchId}" placeholder="ابحث في النواقص" autocomplete="off" />
          </div>
          <div class="field" style="min-width:180px">
            <label>&nbsp;</label>
            <button class="btn" id="${expId}">تصدير Excel</button>
          </div>
        </div>
        <div class="tableWrap" style="max-height:520px">
          <table id="${tableId}">
            <thead><tr><th>السيارة</th><th>البيان</th><th>اللون الداخلي</th><th>اللون الخارجي</th><th>موديل</th></tr></thead>
            <tbody>${rows || '<tr><td colspan="5" class="small">لا توجد نواقص</td></tr>'}</tbody>
          </table>
        </div>`;

      openDetailsModal(html, `نواقص: ${branch}`);

      const qEl = document.getElementById(searchId);
      if(qEl){
        qEl.addEventListener('input', ()=>{
          const q = (qEl.value||'').trim().toLowerCase();
          document.querySelectorAll(`#${tableId} tbody tr`).forEach(tr=>{
            const t = (tr.textContent||'').toLowerCase();
            tr.style.display = (!q || t.includes(q)) ? '' : 'none';
          });
        });
      }
      const expBtn = document.getElementById(expId);
      if(expBtn){
        expBtn.addEventListener('click', ()=>{
          const tbl = document.getElementById(tableId);
          if(!tbl) return;
          const wb = XLSX.utils.table_to_book(tbl, {sheet:'missing'});
          downloadWorkbook(wb, `missing_${branch}_${Date.now()}.xlsx`);
        });
      }
    }

    function goInventoryFilter(location, status){
      openView('view-inventory');
      const locSel = document.getElementById('inv_location');
      const stSel  = document.getElementById('inv_status');
      if(locSel && location){ locSel.value = location; }
      if(stSel && status){ stSel.value = status; }
      renderInventory();
    }

    
    function openApprovalsModal(mode){
      const under = dashCars.filter(c=>normStatus(c.status)==='مباع تحت التسليم');
      let arr = under;
      let title = 'الموافقات';
      if(mode==='fin') { arr = under.filter(c=>!(c.approvals && c.approvals.financial===true)); title='ناقص موافقة مالية'; }
      if(mode==='adm') { arr = under.filter(c=>!(c.approvals && c.approvals.admin===true)); title='ناقص موافقة إدارية'; }
      if(mode==='ready'){ arr = under.filter(c=>(c.approvals && c.approvals.financial===true && c.approvals.admin===true)); title='جاهزة للأرشيف'; }

      const uid = 'ap_' + Date.now();
      const searchId = uid + '_q';
      const btnExpId = uid + '_x';
      const tbodyId  = uid + '_b';

      const renderRows = (list)=> (list||[]).map(c=>`
        <tr>
          <td>${escapeHtml(c.vin)}</td>
          <td>${escapeHtml(c.carName||'')}</td>
          <td>${escapeHtml(c.statement||'')}</td>
          <td>${escapeHtml(c.location||'')}</td>
          <td>${escapeHtml(normStatus(c.status)||'')}</td>
          <td>${(c.approvals && c.approvals.admin===true) ? '<span class="tag ok">✓</span>' : '<span class="tag no">✗</span>'}</td>
          <td>${(c.approvals && c.approvals.financial===true) ? '<span class="tag ok">✓</span>' : '<span class="tag no">✗</span>'}</td>
          <td><button class="btn secondary" data-ap-vin="${escapeHtml(c.vin)}">الموافقات</button></td>
        </tr>`).join('');

      const html = `
        <div class="toolbar" style="gap:10px;align-items:flex-end;margin-bottom:10px">
          <div class="field" style="flex:1;min-width:220px">
            <label>بحث</label>
            <input id="${searchId}" placeholder="ابحث بـ VIN / اسم السيارة / البيان / المكان" autocomplete="off" />
          </div>
          <div class="field" style="min-width:180px">
            <label>&nbsp;</label>
            <button class="btn" id="${btnExpId}">تصدير Excel</button>
          </div>
        </div>

        <div class="tableWrap" style="max-height:520px">
          <table>
            <thead><tr><th>VIN</th><th>السيارة</th><th>البيان</th><th>المكان</th><th>الحالة</th><th>إداري</th><th>مالي</th><th>إجراء</th></tr></thead>
            <tbody id="${tbodyId}">${renderRows(arr) || '<tr><td colspan="8" class="small">لا توجد بيانات</td></tr>'}</tbody>
          </table>
        </div>`;

      openDetailsModal(html, title);

      const apply = ()=>{
        const q = (document.getElementById(searchId)?.value||'').trim().toLowerCase();
        const filtered = !q ? arr : arr.filter(c=>{
          const hay = [c.vin,c.carName,c.statement,c.location,normStatus(c.status)].map(x=>(x||'').toString().toLowerCase()).join(' | ');
          return hay.includes(q);
        });
        const tb = document.getElementById(tbodyId);
        if(tb) tb.innerHTML = renderRows(filtered) || '<tr><td colspan="8" class="small">لا توجد بيانات</td></tr>';
        document.querySelectorAll('[data-ap-vin]').forEach(b=>{
          b.addEventListener('click', ()=>{ const vin=b.getAttribute('data-ap-vin'); if(vin) openCarApprovalsModal(vin); });
        });
      };

      const qEl = document.getElementById(searchId);
      if(qEl){ qEl.addEventListener('input', apply); }
      document.querySelectorAll('[data-ap-vin]').forEach(b=>{
        b.addEventListener('click', ()=>{ const vin=b.getAttribute('data-ap-vin'); if(vin) openCarApprovalsModal(vin); });
      });

      const expBtn = document.getElementById(btnExpId);
      if(expBtn){
        expBtn.addEventListener('click', ()=>{
          const q = (document.getElementById(searchId)?.value||'').trim().toLowerCase();
          const filtered = !q ? arr : arr.filter(c=>{
            const hay = [c.vin,c.carName,c.statement,c.location,normStatus(c.status)].map(x=>(x||'').toString().toLowerCase()).join(' | ');
            return hay.includes(q);
          });
          const headers = ['VIN','السيارة','البيان','المكان','الحالة','موافقة إدارية','موافقة مالية'];
          const rows = filtered.map(c=>[
            (c.vin||''),
            (c.carName||''),
            (c.statement||''),
            (c.location||''),
            (normStatus(c.status)||''),
            (c.approvals && c.approvals.admin===true) ? 'نعم' : 'لا',
            (c.approvals && c.approvals.financial===true) ? 'نعم' : 'لا',
          ]);
          exportRowsToExcel(headers, rows, `approvals_${mode||'all'}_${Date.now()}.xlsx`, 'approvals');
        });
      }
    }


    // ===== Approvals per car (Financial/Admin) =====
    async function openCarApprovalsModal(vin){
      const v = (vin||'').toString().trim();
      if(!v) return toast('VIN غير صحيح');
      try{
        const snap = await db.collection('cars').doc(v).get();
        if(!snap.exists) return toast('السيارة غير موجودة');
        const d = snap.data() || {};

        const carName = escapeHtml(d.carName||d.car||'');
        const statement = escapeHtml(d.statement||d.trim||'');
        const location = escapeHtml(d.location||'');
        const status = escapeHtml(normStatus(d.status||''));

        const a = d.approvals || {};
        const finOk = (a.financial===true);
        const admOk = (a.admin===true);

        const notes = d.approvalsNotes || {};
        const finNote = (notes.financial||'').toString();
        const admNote = (notes.admin||'').toString();

        const html = `
          <div class="muted" style="margin-bottom:10px">
            <b>VIN:</b> ${escapeHtml(v)} &nbsp; | &nbsp; <b>السيارة:</b> ${carName} &nbsp; | &nbsp; <b>البيان:</b> ${statement}<br/>
            <b>المكان:</b> ${location} &nbsp; | &nbsp; <b>الحالة:</b> ${status}
          </div>

          <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
            <div class="card" style="margin:0">
              <h3 style="margin:0 0 8px">الموافقة المالية</h3>
              <div class="body" style="padding:0">
                <div class="row" style="gap:8px; flex-wrap:wrap; margin-bottom:8px">
                  <button class="btn" id="ap_fin_yes">موافقة مالية</button>
                  <button class="btn secondary" id="ap_fin_no">تراجع</button>
                  <span class="tag ${finOk?'ok':'no'}" id="ap_fin_state">${finOk?'✓ تم':'✗ لم يتم'}</span>
                </div>
                <div class="field">
                  <label>ملاحظة مالية</label>
                  <textarea id="ap_fin_note" rows="3" placeholder="اكتب ملاحظة...">${escapeHtml(finNote)}</textarea>
                </div>
                <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:8px">
                  <button class="btn secondary" id="ap_fin_save">حفظ الملاحظة</button>
                </div>
              </div>
            </div>

            <div class="card" style="margin:0">
              <h3 style="margin:0 0 8px">الموافقة الإدارية</h3>
              <div class="body" style="padding:0">
                <div class="row" style="gap:8px; flex-wrap:wrap; margin-bottom:8px">
                  <button class="btn" id="ap_adm_yes">موافقة إدارية</button>
                  <button class="btn secondary" id="ap_adm_no">تراجع</button>
                  <span class="tag ${admOk?'ok':'no'}" id="ap_adm_state">${admOk?'✓ تم':'✗ لم يتم'}</span>
                </div>
                <div class="field">
                  <label>ملاحظة إدارية</label>
                  <textarea id="ap_adm_note" rows="3" placeholder="اكتب ملاحظة...">${escapeHtml(admNote)}</textarea>
                </div>
                <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:8px">
                  <button class="btn secondary" id="ap_adm_save">حفظ الملاحظة</button>
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="justify-content:flex-end; gap:8px; margin-top:12px">
            <button class="btn danger" id="ap_cancel_all">إلغاء الطلب (مسح الموافقات)</button>
          </div>
        `;

        openDetailsModal(html, 'موافقات السيارة');

        // Bind actions
        const finYes = document.getElementById('ap_fin_yes');
        const finNo  = document.getElementById('ap_fin_no');
        const finSave= document.getElementById('ap_fin_save');
        const admYes = document.getElementById('ap_adm_yes');
        const admNo  = document.getElementById('ap_adm_no');
        const admSave= document.getElementById('ap_adm_save');
        const cancel = document.getElementById('ap_cancel_all');

        const getFinNote = ()=> (document.getElementById('ap_fin_note')?.value||'').toString();
        const getAdmNote = ()=> (document.getElementById('ap_adm_note')?.value||'').toString();

        const who = (auth.currentUser && (auth.currentUser.email||auth.currentUser.uid)) ? (auth.currentUser.email||auth.currentUser.uid) : '';

        async function applyPatch(patch, actionName){
          try{
            await db.collection('cars').doc(v).set(patch, {merge:true});
            if(typeof logAction==='function'){
              logAction('approvals', actionName, {vin:v, by: who});
            }
            // refresh dashCars view in memory
            if(Array.isArray(dashCars)){
              const i = dashCars.findIndex(x=>(x.vin||x.VIN||'')===v);
              if(i>=0){ dashCars[i] = Object.assign({}, dashCars[i], patch); }
            }
            if(typeof renderDashboard==='function') renderDashboard();
            if(typeof renderInventory==='function') renderInventory();
            toast('تم الحفظ');
          }catch(e){
            toast(e.message || 'فشل الحفظ');
          }
        }

        if(finYes) finYes.addEventListener('click', ()=>{
          applyPatch({
            approvals: Object.assign({}, (d.approvals||{}), {financial:true}),
            approvalsNotes: Object.assign({}, (d.approvalsNotes||{}), {financial:getFinNote()}),
            approvalsAt: Object.assign({}, (d.approvalsAt||{}), {financial: firebase.firestore.FieldValue.serverTimestamp()}),
            approvalsBy: Object.assign({}, (d.approvalsBy||{}), {financial: who})
          }, 'financial_approve');
        });

        if(finNo) finNo.addEventListener('click', ()=>{
          applyPatch({
            approvals: Object.assign({}, (d.approvals||{}), {financial:false}),
            approvalsNotes: Object.assign({}, (d.approvalsNotes||{}), {financial:getFinNote()}),
            approvalsAt: Object.assign({}, (d.approvalsAt||{}), {financial: firebase.firestore.FieldValue.serverTimestamp()}),
            approvalsBy: Object.assign({}, (d.approvalsBy||{}), {financial: who})
          }, 'financial_revert');
        });

        if(finSave) finSave.addEventListener('click', ()=>{
          applyPatch({
            approvalsNotes: Object.assign({}, (d.approvalsNotes||{}), {financial:getFinNote()}),
            approvalsAt: Object.assign({}, (d.approvalsAt||{}), {financial: firebase.firestore.FieldValue.serverTimestamp()}),
            approvalsBy: Object.assign({}, (d.approvalsBy||{}), {financial: who})
          }, 'financial_note');
        });

        if(admYes) admYes.addEventListener('click', ()=>{
          applyPatch({
            approvals: Object.assign({}, (d.approvals||{}), {admin:true}),
            approvalsNotes: Object.assign({}, (d.approvalsNotes||{}), {admin:getAdmNote()}),
            approvalsAt: Object.assign({}, (d.approvalsAt||{}), {admin: firebase.firestore.FieldValue.serverTimestamp()}),
            approvalsBy: Object.assign({}, (d.approvalsBy||{}), {admin: who})
          }, 'admin_approve');
        });

        if(admNo) admNo.addEventListener('click', ()=>{
          applyPatch({
            approvals: Object.assign({}, (d.approvals||{}), {admin:false}),
            approvalsNotes: Object.assign({}, (d.approvalsNotes||{}), {admin:getAdmNote()}),
            approvalsAt: Object.assign({}, (d.approvalsAt||{}), {admin: firebase.firestore.FieldValue.serverTimestamp()}),
            approvalsBy: Object.assign({}, (d.approvalsBy||{}), {admin: who})
          }, 'admin_revert');
        });

        if(admSave) admSave.addEventListener('click', ()=>{
          applyPatch({
            approvalsNotes: Object.assign({}, (d.approvalsNotes||{}), {admin:getAdmNote()}),
            approvalsAt: Object.assign({}, (d.approvalsAt||{}), {admin: firebase.firestore.FieldValue.serverTimestamp()}),
            approvalsBy: Object.assign({}, (d.approvalsBy||{}), {admin: who})
          }, 'admin_note');
        });

        if(cancel) cancel.addEventListener('click', async ()=>{
          if(!confirm('متأكد؟ سيتم مسح الموافقات المالية والإدارية')) return;
          try{
            await db.collection('cars').doc(v).set({
              approvals: {financial:false, admin:false},
              approvalsNotes: {financial:'', admin:''}
            }, {merge:true});
            // Attempt to delete optional fields if exist (best effort)
            try{
              await db.collection('cars').doc(v).update({
                'approvalsAt.financial': firebase.firestore.FieldValue.delete(),
                'approvalsAt.admin': firebase.firestore.FieldValue.delete(),
                'approvalsBy.financial': firebase.firestore.FieldValue.delete(),
                'approvalsBy.admin': firebase.firestore.FieldValue.delete(),
                'approvalsNotes.financial': firebase.firestore.FieldValue.delete(),
                'approvalsNotes.admin': firebase.firestore.FieldValue.delete()
              });
            }catch(_e){}
            if(typeof logAction==='function') logAction('approvals','cancel_all',{vin:v, by: who});
            if(typeof renderDashboard==='function') renderDashboard();
            if(typeof renderInventory==='function') renderInventory();
            toast('تم إلغاء الموافقات');
            hideModal('detailsModal');
          }catch(e){
            toast(e.message || 'فشل الإلغاء');
          }
        });

      }catch(e){
        toast(e.message || 'فشل فتح الموافقات');
      }
    }

    // Requests (light summary)
    let dashReqUnsub = null;
    let dashReq = [];

    function reqStage(r){
      const s1 = !!r.step1At;
      const s2 = !!r.step2At;
      const s3 = !!r.step3At;
      const s4 = !!r.step4At;
      if(s4) return 4;
      if(s3) return 3;
      if(s2) return 2;
      if(s1) return 1;
      return 0;
    }

    function renderRequestsCounts(){
      const s1 = dashReq.filter(r=>reqStage(r)==1).length;
      const s2 = dashReq.filter(r=>reqStage(r)==2).length;
      const s3 = dashReq.filter(r=>reqStage(r)==3).length;
      const s4 = dashReq.filter(r=>reqStage(r)==4).length;
      setText('rq_s1', s1);
      setText('rq_s2', s2);
      setText('rq_s3', s3);
      setText('rq_s4', s4);
    }

    
    function openRequestDetails(id){
      const r = dashReq.find(x=>(x.id||x._id||'')===id) || null;
      if(!r){ toast('الطلب غير موجود'); return; }
      const type = (r.type==='transfer') ? 'نقل' : (r.type==='photo' ? 'تصوير' : (r.type||''));
      const target = (r.targetLocation||r.toLocation||r.to||'');
      const status = (reqStage(r)===1?'تم استلام الطلب':reqStage(r)===2?'تم ارسال السيارة':reqStage(r)===3?'تم استلام السيارة':reqStage(r)===4?'تم الانتهاء':'-');
      const createdAt = fmtDate(r.createdAt)||'';
      const createdBy = (r.createdBy||r.userEmail||r.user||'')||'';

      const items = Array.isArray(r.items)? r.items : [];
      const rows = items.map(it=>{
        const vin = escapeHtml(it.vin||it.VIN||'');
        const car = escapeHtml(it.car||it.name||'');
        const trim = escapeHtml(it.trim||it.desc||'');
        return `<tr><td>${vin}</td><td>${car}</td><td>${trim}</td></tr>`;
      }).join('');

      const html = `
        <div class="muted" style="margin-bottom:10px">
          <b>نوع الطلب:</b> ${escapeHtml(type)} &nbsp; | &nbsp;
          <b>المكان المستهدف:</b> ${escapeHtml(target)} &nbsp; | &nbsp;
          <b>الحالة:</b> ${escapeHtml(status)} <br/>
          <b>تاريخ الطلب:</b> ${escapeHtml(createdAt)} &nbsp; | &nbsp;
          <b>المنشئ:</b> ${escapeHtml(createdBy)}
        </div>

        <div class="tableWrap" style="max-height:520px">
          <table>
            <thead><tr><th>رقم الهيكل</th><th>السيارة</th><th>البيان</th></tr></thead>
            <tbody>${rows || '<tr><td colspan="3" class="small">لا توجد سيارات داخل الطلب</td></tr>'}</tbody>
          </table>
        </div>
      `;
      openDetailsModal(html, 'تفاصيل الطلب');
    }


    
    function openReqStageModal(stage){
      const arr0 = dashReq.filter(r=>reqStage(r)==stage);
      const titles = {1:'تم استلام الطلب',2:'تم ارسال السيارة',3:'تم استلام السيارة',4:'تم الانتهاء'};
      const title = (titles[stage] || 'طلبات');

      const uid = 'req_' + Date.now();
      const searchId = uid + '_q';
      const expId = uid + '_x';
      const tbodyId = uid + '_b';

      const render = (list)=> (list||[]).map(r=>{
        const type = (r.type==='transfer') ? 'نقل' : (r.type==='photo' ? 'تصوير' : (r.type||''));
        const itemsCount = (r.items||[]).length;
        return `<tr><td>${escapeHtml(type)}</td><td>${escapeHtml(r.targetLocation||r.toLocation||r.to||'')}</td><td>${escapeHtml(itemsCount.toString())}</td><td>${escapeHtml((r.createdBy||r.userEmail||r.user||'')||'')}</td><td>${escapeHtml(fmtDate(r.createdAt)||'')}</td><td><button class="btn secondary" data-req-details="${escapeHtml(r.id||r._id||'')}">تفاصيل</button></td></tr>`;
      }).join('');

      const html = `
        <div class="toolbar" style="gap:10px;align-items:flex-end;margin-bottom:10px">
          <div class="field" style="flex:1;min-width:220px">
            <label>بحث</label>
            <input id="${searchId}" placeholder="ابحث بالنوع / المكان / المنشئ / التاريخ" autocomplete="off" />
          </div>
          <div class="field" style="min-width:180px">
            <label>&nbsp;</label>
            <button class="btn" id="${expId}">تصدير Excel</button>
          </div>
        </div>

        <div class="tableWrap" style="max-height:520px">
          <table>
            <thead><tr><th>نوع الطلب</th><th>المكان المستهدف</th><th>عدد السيارات</th><th>المنشئ</th><th>تاريخ الطلب</th><th>الإجراء</th></tr></thead>
            <tbody id="${tbodyId}">${render(arr0) || '<tr><td colspan="6" class="small">لا توجد طلبات</td></tr>'}</tbody>
          </table>
        </div>`;

      openDetailsModal(html, title);

      const bindDetails = ()=>{
        document.querySelectorAll('[data-req-details]').forEach(b=>{
          b.addEventListener('click', ()=>{ const id=b.getAttribute('data-req-details'); if(id) openRequestDetails(id); });
        });
      };

      const apply = ()=>{
        const q = (document.getElementById(searchId)?.value||'').trim().toLowerCase();
        const filtered = !q ? arr0 : arr0.filter(r=>{
          const type = (r.type==='transfer') ? 'نقل' : (r.type==='photo' ? 'تصوير' : (r.type||''));
          const hay = [type, r.targetLocation||r.toLocation||r.to||'', r.createdBy||r.userEmail||r.user||'', fmtDate(r.createdAt)||'', String((r.items||[]).length)].map(x=>(x||'').toString().toLowerCase()).join(' | ');
          return hay.includes(q);
        });
        const tb = document.getElementById(tbodyId);
        if(tb) tb.innerHTML = render(filtered) || '<tr><td colspan="6" class="small">لا توجد طلبات</td></tr>';
        bindDetails();
      };

      const qEl = document.getElementById(searchId);
      if(qEl) qEl.addEventListener('input', apply);
      bindDetails();

      const expBtn = document.getElementById(expId);
      if(expBtn){
        expBtn.addEventListener('click', ()=>{
          const q = (document.getElementById(searchId)?.value||'').trim().toLowerCase();
          const filtered = !q ? arr0 : arr0.filter(r=>{
            const type = (r.type==='transfer') ? 'نقل' : (r.type==='photo' ? 'تصوير' : (r.type||''));
            const hay = [type, r.targetLocation||r.toLocation||r.to||'', r.createdBy||r.userEmail||r.user||'', fmtDate(r.createdAt)||'', String((r.items||[]).length)].map(x=>(x||'').toString().toLowerCase()).join(' | ');
            return hay.includes(q);
          });
          const headers = ['نوع الطلب','المكان المستهدف','عدد السيارات','المنشئ','تاريخ الطلب'];
          const rows = filtered.map(r=>{
            const type = (r.type==='transfer') ? 'نقل' : (r.type==='photo' ? 'تصوير' : (r.type||''));
            return [
              type,
              (r.targetLocation||r.toLocation||r.to||''),
              String((r.items||[]).length),
              (r.createdBy||r.userEmail||r.user||''),
              (fmtDate(r.createdAt)||'')
            ];
          });
          exportRowsToExcel(headers, rows, `requests_stage${stage}_${Date.now()}.xlsx`, 'requests');
        });
      }
    }

    
    // ===== Dashboard Cards: Saved cards + Data modal =====
    const DASH_SAVED_CARDS_KEY = 'mzj_dash_cards';

    function readSavedDashCards(){
      try{
        const raw = localStorage.getItem(DASH_SAVED_CARDS_KEY);
        return raw ? (JSON.parse(raw) || []) : [];
      }catch(e){ return []; }
    }
    function writeSavedDashCards(arr){
      try{ localStorage.setItem(DASH_SAVED_CARDS_KEY, JSON.stringify(arr||[])); }catch(e){}
    }
        function makeCardTitle(loc){
      return (loc && loc.trim()) ? loc.trim() : 'كل الأماكن';
    }
    function normalizeStatuses(arr){
      return Array.from(new Set((arr||[]).map(s=>(s||'').toString().trim()).filter(Boolean)));
    }

    function showModal(id){
      const b = document.getElementById(id);
      if(b) b.classList.add('show');
    }
    function hideModal(id){
      const b = document.getElementById(id);
      if(b) b.classList.remove('show');
    }

    
    // ===== Dashboard Data Modal (Search + Excel + Approvals per car) =====
    let dashDataLast = [];

    function dashDataRowMatches(c, q){
      const s = (q||'').toString().trim().toLowerCase();
      if(!s) return true;
      const blob = [
        c.vin, c.carName, c.statement, c.model, c.agent,
        c.interiorColor, c.exteriorColor, c.location, c.status
      ].map(x=>(x||'').toString().toLowerCase()).join(' | ');
      return blob.includes(s);
    }

    function dashDataFiltered(){
      const q = (document.getElementById('dashDataSearch')?.value||'').trim();
      return dashDataLast.filter(c=>dashDataRowMatches(c,q));
    }

    function exportRowsToExcel(headers, rows, filename, sheetName){
      try{
        if(typeof XLSX==='undefined' || !XLSX?.utils) throw new Error('XLSX not found');
        const aoa = [headers].concat(rows);
        const ws = XLSX.utils.aoa_to_sheet(aoa);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, sheetName || 'data');
        if(typeof downloadWorkbook==='function'){
          downloadWorkbook(wb, filename);
        }else{
          const out = XLSX.write(wb, {bookType:'xlsx', type:'array'});
          const blob = new Blob([out], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = filename;
          a.click();
          setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
        }
      }catch(e){
        console.error(e);
        toast('تعذر تصدير Excel');
      }
    }

    function openDashDataModal(title, cars){
      dashDataLast = Array.isArray(cars)? cars.slice() : [];
      const t = document.getElementById('dashDataTitle');
      const meta = document.getElementById('dashDataMeta');
      const body = document.getElementById('dashDataBody');
      const search = document.getElementById('dashDataSearch');
      const exportBtn = document.getElementById('dashDataExport');

      if(t) t.textContent = title || 'عرض البيانات';
      if(search){ search.value=''; }

      function renderRows(list){
        if(meta) meta.textContent = `عدد النتائج: ${list.length}`;
        if(!body) return;
        body.innerHTML = list.map(c=>{
          const vin = escapeHtml(c.vin||c.VIN||'');
          const car = escapeHtml(c.carName||c.car||c.makeModel||c.name||'');
          const trim = escapeHtml(c.statement||c.trim||c.variant||c.desc||'');
          const year = escapeHtml((c.model||c.year||'').toString());
          const agent = escapeHtml(c.agent||c.dealer||c.agency||c.agentName||c.vendor||c.salesAgent||c['الوكيل']||c['وكيل']||'');
          const inC = escapeHtml(c.interiorColor||c.interior||'');
          const outC = escapeHtml(c.exteriorColor||c.exterior||'');
          const loc = escapeHtml(c.location||'');
          const stN = normStatus(c.status||'');
          const st = escapeHtml(stN||c.status||'');

          const canApprove = (stN==='مباع تحت التسليم');
          const btn = canApprove ? `<button class="btn primary" data-approve-vin="${vin}">الموافقات</button>` : `<span class="muted">—</span>`;

          return `<tr>
            <td>${vin}</td>
            <td>${car}</td>
            <td>${trim}</td>
            <td>${year}</td>
            <td>${agent}</td>
            <td>${inC}</td>
            <td>${outC}</td>
            <td>${loc}</td>
            <td>${st}</td>
            <td>${btn}</td>
          </tr>`;
        }).join('');

        // bind approvals buttons
        body.querySelectorAll('[data-approve-vin]').forEach(b=>{
          b.addEventListener('click', ()=>{
            const vin = b.getAttribute('data-approve-vin');
            if(vin) openCarApprovalsModal(vin);
          });
        });
      }

      // initial
      renderRows(dashDataLast);

      // wire search
      if(search){
        const onSearch = ()=> renderRows(dashDataFiltered());
        search.oninput = onSearch;
      }

      // wire export
      if(exportBtn){
        exportBtn.onclick = ()=>{
          const list = dashDataFiltered();
          const headers = ['VIN','السيارة','البيان','موديل','الوكيل','الداخلي','الخارجي','المكان','الحالة'];
          const rows = list.map(c=>[
            c.vin||'', c.carName||'', c.statement||'', c.model||'', c.agent||'',
            c.interiorColor||'', c.exteriorColor||'', c.location||'', (normStatus(c.status)||c.status||'')
          ]);
          exportRowsToExcel(headers, rows, 'dashboard_cars.xlsx', 'cars');
        };
      }

      showModal('dashDataModal');
    }


    
    function filterCars(location, statuses){
      const locWanted = norm(location||'');
      const setWanted = new Set((statuses||[]).map(s=>normStatus(s)));
      return dashCars.filter(c=>{
        const locOk = !locWanted || norm(c.location||'')===locWanted;
        if(!locOk) return false;
        if(!setWanted.size) return true;
        const st = normStatus(c.status||'');
        return setWanted.has(st);
      });
    }


    function openCarsModalByFilter(location, statuses){
      const cars = filterCars(location, statuses);
      openDashDataModal(makeCardTitle(location, normalizeStatuses(statuses)), cars);
    }

    function renderSavedDashCards(){
      const host = document.getElementById('dash_saved_cards');
      if(!host) return;
      const cards = (typeof getDashCardsFromCache === 'function') ? getDashCardsFromCache() : (readSavedDashCards ? readSavedDashCards() : []);

      host.innerHTML = (cards||[]).map(card=>{
        const loc = (card.location||'').toString().trim();
        const title = escapeHtml(makeCardTitle(loc)); // اسم المكان فقط
        const statuses = (card.statuses||[]);
        const all = filterCars(loc, statuses);
        const countBy = (st)=> filterCars(loc, [st]).length;

        const totalActual = all.filter(x=>['متاح للبيع','حجز','بها ملاحظات'].includes(normStatus((x.status||'').toString().trim()))).length;
        const keysTotal = all.filter(x=>['متاح للبيع','حجز','بها ملاحظات','مباع تحت التسليم'].includes(normStatus((x.status||'').toString().trim()))).length;

        const list = statuses.length ? statuses : ['متاح للبيع','محجوز','بها ملاحظات','مباع تحت التسليم','مباع تم التسليم'];

        const kpis = [];
        kpis.push(`<div class="dashKpi kpiHighlight" data-card="${escapeHtml(card.id)}" data-kpi="totalActual"><div>الإجمالي الفعلي</div><b>${totalActual}</b></div>`);
        kpis.push(`<div class="dashKpi kpiHighlight" data-card="${escapeHtml(card.id)}" data-kpi="keysTotal"><div>إجمالي المفاتيح</div><b>${keysTotal}</b></div>`);
        list.forEach(st=>{
          kpis.push(`<div class="dashKpi" data-card="${escapeHtml(card.id)}" data-status="${escapeHtml(st)}"><div>${escapeHtml(st)}</div><b>${countBy(st)}</b></div>`);
        });

        return `
          <div class="card dashCard">
            <h3>${title}</h3>
            <div class="body">
              <div class="dashKpis">${kpis.join('')}</div>
              <div class="dashBtns">
                <button class="btn secondary" data-saved-open="${escapeHtml(card.id)}">عرض</button>
                <button class="btn danger" data-saved-del="${escapeHtml(card.id)}">حذف</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // bind open
      host.querySelectorAll('[data-saved-open]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-saved-open');
          const cards2 = (typeof getDashCardsFromCache === 'function') ? getDashCardsFromCache() : (readSavedDashCards ? readSavedDashCards() : []);
          const c = (cards2||[]).find(x=>x.id===id);
          if(!c) return;
          openCarsModalByFilter((c.location||''), (c.statuses||[]));
        });
      });

      // bind delete
      host.querySelectorAll('[data-saved-del]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-saved-del');
          if(!id) return;
          if(!confirm('حذف هذا الكارت؟')) return;
          if(typeof deleteDashCard === 'function'){
            await deleteDashCard(id);
          }else{
            const cards3 = (readSavedDashCards ? readSavedDashCards() : []).filter(c=>c.id!==id);
            if(typeof writeSavedDashCards === 'function') writeSavedDashCards(cards3);
          }
          renderSavedDashCards();
          toast('تم الحذف');
        });
      });

      // KPI clicks
      host.querySelectorAll('.dashKpi[data-status]').forEach(k=>{
        k.style.cursor='pointer';
        k.addEventListener('click', ()=>{
          const id = k.getAttribute('data-card');
          const st = k.getAttribute('data-status');
          const cards4 = (typeof getDashCardsFromCache === 'function') ? getDashCardsFromCache() : (readSavedDashCards ? readSavedDashCards() : []);
          const c = (cards4||[]).find(x=>x.id===id);
          if(!c) return;
          openCarsModalByFilter((c.location||''), [st]);
        });
      });
    }


    function bindDashboardActions(){
      // Dashboard data modal close (no refresh needed)
      const dashDataModal = document.getElementById('dashDataModal');
      const dashDataClose = document.getElementById('dashDataClose');
      if(dashDataClose) dashDataClose.addEventListener('click', ()=>{ if(dashDataModal) dashDataModal.classList.remove('show'); });
      if(dashDataModal) dashDataModal.addEventListener('click', (e)=>{ if(e.target===dashDataModal) dashDataModal.classList.remove('show'); });

      // Missing (نواقص) buttons
      document.querySelectorAll('[data-miss-branch]').forEach(btn=>{
        btn.addEventListener('click', ()=> openMissingModal(btn.getAttribute('data-miss-branch')));
      });

      // Inventory quick buttons -> OPEN MODAL (not navigate)
      const openBy = (loc, statuses)=> openCarsModalByFilter((loc||'').toString(), Array.isArray(statuses)? statuses: []);
      const btnAgency = document.getElementById('btn_go_agency');
      if(btnAgency) btnAgency.addEventListener('click', ()=> openBy('الوكالة', []));
      document.querySelectorAll('[data-go-status]').forEach(btn=>{
        btn.addEventListener('click', ()=> openBy('', [btn.getAttribute('data-go-status')]));
      });
      document.querySelectorAll('[data-go-location]').forEach(btn=>{
        btn.addEventListener('click', ()=> openBy(btn.getAttribute('data-go-location')||'', []));
      });

      // Requests stages buttons
      document.querySelectorAll('[data-req-stage]').forEach(btn=>{
        btn.addEventListener('click', ()=> openReqStageModal(parseInt(btn.getAttribute('data-req-stage')||'0',10)));
      });

      // KPI clicks (totals + statuses) -> OPEN MODAL
      const kpiMap = {
        // Stock (all)
        'stk_totalActual': {loc:'', statuses:['متاح للبيع','محجوز','بها ملاحظات']},
        'stk_keysTotal' : {loc:'', statuses:['متاح للبيع','محجوز','بها ملاحظات','مباع تحت التسليم']},
        'stk_avail'     : {loc:'', statuses:['متاح للبيع']},
        'stk_reserved'  : {loc:'', statuses:['حجز']},
        'stk_notes'     : {loc:'', statuses:['بها ملاحظات']},
        'stk_under'     : {loc:'', statuses:['مباع تحت التسليم']},
        'stk_delivered' : {loc:'', statuses:['مباع تم التسليم']},

        // Agency
        'ag_totalActual': {loc:'الوكالة', statuses:['متاح للبيع','محجوز','بها ملاحظات']},
        'ag_keysTotal' : {loc:'الوكالة', statuses:['متاح للبيع','محجوز','بها ملاحظات','مباع تحت التسليم']},
        'ag_avail'     : {loc:'الوكالة', statuses:['متاح للبيع']},
        'ag_reserved'  : {loc:'الوكالة', statuses:['حجز']},
        'ag_notes'     : {loc:'الوكالة', statuses:['بها ملاحظات']},
        'ag_under'     : {loc:'الوكالة', statuses:['مباع تحت التسليم']},
        'ag_delivered' : {loc:'الوكالة', statuses:['مباع تم التسليم']},

        // Branch 1: الصالة
        'b1_totalActual': {loc:'الصالة', statuses:['متاح للبيع','محجوز','بها ملاحظات']},
        'b1_keysTotal' : {loc:'الصالة', statuses:['متاح للبيع','محجوز','بها ملاحظات','مباع تحت التسليم']},
        'b1_avail'     : {loc:'الصالة', statuses:['متاح للبيع']},
        'b1_reserved'  : {loc:'الصالة', statuses:['حجز']},
        'b1_notes'     : {loc:'الصالة', statuses:['بها ملاحظات']},
        'b1_under'     : {loc:'الصالة', statuses:['مباع تحت التسليم']},
        'b1_delivered' : {loc:'الصالة', statuses:['مباع تم التسليم']},

        // Branch 2: الملتقى
        'b2_totalActual': {loc:'الملتقى', statuses:['متاح للبيع','محجوز','بها ملاحظات']},
        'b2_keysTotal' : {loc:'الملتقى', statuses:['متاح للبيع','محجوز','بها ملاحظات','مباع تحت التسليم']},
        'b2_avail'     : {loc:'الملتقى', statuses:['متاح للبيع']},
        'b2_reserved'  : {loc:'الملتقى', statuses:['حجز']},
        'b2_notes'     : {loc:'الملتقى', statuses:['بها ملاحظات']},
        'b2_under'     : {loc:'الملتقى', statuses:['مباع تحت التسليم']},
        'b2_delivered' : {loc:'الملتقى', statuses:['مباع تم التسليم']},

        // Branch 3: القادسية
        'b3_totalActual': {loc:'القادسية', statuses:['متاح للبيع','محجوز','بها ملاحظات']},
        'b3_keysTotal' : {loc:'القادسية', statuses:['متاح للبيع','محجوز','بها ملاحظات','مباع تحت التسليم']},
        'b3_avail'     : {loc:'القادسية', statuses:['متاح للبيع']},
        'b3_reserved'  : {loc:'القادسية', statuses:['حجز']},
        'b3_notes'     : {loc:'القادسية', statuses:['بها ملاحظات']},
        'b3_under'     : {loc:'القادسية', statuses:['مباع تحت التسليم']},
        'b3_delivered' : {loc:'القادسية', statuses:['مباع تم التسليم']},
      };

      Object.keys(kpiMap).forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        const kpi = el.closest('.dashKpi') || el;
        kpi.style.cursor = 'pointer';
        kpi.addEventListener('click', ()=>{
          const cfg = kpiMap[id];
          openBy(cfg.loc, cfg.statuses);
        });
      });

      // Requests KPI numbers clickable too
      const rqIds = { 'rq_s1':1, 'rq_s2':2, 'rq_s3':3, 'rq_s4':4 };
      Object.keys(rqIds).forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        const kpi = el.closest('.dashKpi') || el;
        kpi.style.cursor = 'pointer';
        kpi.addEventListener('click', ()=> openReqStageModal(rqIds[id]));
      });

      // go inventory by status/location
      document.querySelectorAll('[data-go-status]').forEach(btn=>{
        btn.addEventListener('click', ()=> openCarsModalByFilter('', [btn.getAttribute('data-go-status')]));
      });
      document.querySelectorAll('[data-go-location]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const loc = btn.getAttribute('data-go-location')||'';
          openCarsModalByFilter(loc, []);
        });
      });
      const goAgency = document.getElementById('btn_go_agency');
      if(goAgency) goAgency.addEventListener('click', ()=> openCarsModalByFilter('الوكالة', []));

      // approvals
      document.getElementById('ap_show_fin')?.addEventListener('click', ()=>openApprovalsModal('fin'));
      document.getElementById('ap_show_adm')?.addEventListener('click', ()=>openApprovalsModal('adm'));
      document.getElementById('ap_show_ready')?.addEventListener('click', ()=>openApprovalsModal('ready'));

      // tracking card (placeholder)
      // ===== Tracking (mzj-tracking) =====
      const trackingBaseUrl = 'https://mzj-tracking.vercel.app/Test-Track.html?vin=';

      const trackingFirebaseConfig = {
        apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
        authDomain: "mzj-tracking.firebaseapp.com",
        projectId: "mzj-tracking",
        storageBucket: "mzj-tracking.firebasestorage.app",
        messagingSenderId: "655452217491",
        appId: "1:655452217491:web:9348d172c47bdd411fad66"
      };

      let trackingDb = null;
      function getTrackingDb(){
        if(trackingDb) return trackingDb;
        try{
          const app = firebase.app('mzj-tracking');
          trackingDb = app.firestore();
        }catch(e){
          const app = firebase.initializeApp(trackingFirebaseConfig, 'mzj-tracking');
          trackingDb = app.firestore();
        }
        return trackingDb;
      }

      function guessField(d, keys){
        for(const k of keys){
          if(d && d[k] !== undefined && d[k] !== null && (d[k]+'').toString().trim() !== '') return d[k];
        }
        return '';
      }

      function normalizePhone(p){
        const s = (p||'').toString().trim();
        return s;
      }

      function pickFirstNonEmpty(arr){
        if(!Array.isArray(arr)) return '';
        for(const x of arr){
          const v = (x||'').toString().trim();
          if(v) return v;
        }
        return '';
      }

      function extractVinFromOrder(d){
        try{
          // direct common fields
          let v = (guessField(d, ['VIN','vin','vehicleVin','vehicle_vin','carVin','car_vin','chassis','chassisNo','chassis_no','رقم_الهيكل','رقم الهيكل','الهيكل','هيكل']) || '').toString().trim();
          if(v) return v;

          // common arrays
          v = pickFirstNonEmpty(d.vins);
          if(v) return v;

          // items arrays (requests-like)
          if(Array.isArray(d.items)){
            for(const it of d.items){
              const vv = it && (it.VIN ?? it.vin ?? it.vehicleVin ?? it.chassis ?? it.chassisNo ?? it['رقم الهيكل'] ?? it['الهيكل']);
              const s = (vv??'').toString().trim();
              if(s) return s;
            }
          }

          // cars/vehicles arrays
          const fromArr = (arr)=> pickFirstNonEmpty((arr||[]).map(x=> x && (x.VIN ?? x.vin ?? x.vehicleVin ?? x.chassis ?? x.chassisNo) ? (x.VIN ?? x.vin ?? x.vehicleVin ?? x.chassis ?? x.chassisNo) : ''));
          v = fromArr(d.cars);
          if(v) return v;
          v = fromArr(d.vehicles);
          if(v) return v;

          // nested objects with common names
          const nested = ['vehicle','car','order','data','payload','meta'];
          for(const key of nested){
            if(d && d[key] && typeof d[key]==='object'){
              v = (d[key].VIN ?? d[key].vin ?? d[key].vehicleVin ?? d[key].chassis ?? d[key].chassisNo ?? '')+'';
              v = v.toString().trim();
              if(v) return v;
            }
          }

          // deep search for any key named VIN/vin (up to a safe depth to avoid cycles)
          const seen = new Set();
          function deepFind(obj, depth){
            if(!obj || typeof obj!=='object') return '';
            if(seen.has(obj)) return '';
            seen.add(obj);
            if(depth<=0) return '';
            if(obj.VIN!==undefined && obj.VIN!==null && (obj.VIN+'').toString().trim()!=='') return (obj.VIN+'').toString().trim();
            if(obj.vin!==undefined && obj.vin!==null && (obj.vin+'').toString().trim()!=='') return (obj.vin+'').toString().trim();
            // arrays
            if(Array.isArray(obj)){
              for(const it of obj){
                const r = deepFind(it, depth-1);
                if(r) return r;
              }
              return '';
            }
            // objects
            for(const k in obj){
              if(!Object.prototype.hasOwnProperty.call(obj,k)) continue;
              const r = deepFind(obj[k], depth-1);
              if(r) return r;
            }
            return '';
          }
          v = deepFind(d, 4);
          if(v) return v;

          return '';
        }catch(_){ return ''; }
      }

      function deriveOrderStatus(d){
        try{
          // direct fields first
          const direct = (guessField(d, ['status','state','orderStatus','order_status','trackingStatus','tracking_status','الحالة','حالة','stage','مرحلة']) || '').toString().trim();
          if(direct) return direct;

          // step timestamps style
          const s1 = !!d.step1At || !!d.step1_at;
          const s2 = !!d.step2At || !!d.step2_at;
          const s3 = !!d.step3At || !!d.step3_at;
          const s4 = !!d.step4At || !!d.step4_at;

          if(s4) return 'مكتمل';
          if(s3) return 'تحت الإجراء';
          if(s2) return 'تحت الإجراء';
          if(s1) return 'جديد';

          // archived flag
          if(d.isArchived || d.archived === true || d.archivedAt || d.archived_at) return 'مؤرشف';

          return 'جديد';
        }catch(_){ return '—'; }
      }

      function getCarTrackingLinkByVin(vin){
        const v = (vin||'').toString().trim();
        if(!v) return '';
        const car = (invAll||[]).find(x=> (x.vin||'').toString().trim()===v);
        const link = (car && (car.trackingLink||car.tracking||car.f_tracking)) ? (car.trackingLink||car.tracking||car.f_tracking) : '';
        return (link||'').toString().trim() || (trackingBaseUrl + encodeURIComponent(v));
      }

      async function fetchTrackingOrders(limit=400){
        const tdb = getTrackingDb();
        let snap = null;

        // try best ordering (may require index/field)
        try{
          snap = await tdb.collection('erp_orders').orderBy('createdAt','desc').limit(limit).get();
        }catch(e1){
          try{
            snap = await tdb.collection('erp_orders').orderBy('created_at','desc').limit(limit).get();
          }catch(e2){
            try{
              snap = await tdb.collection('erp_orders').orderBy('date','desc').limit(limit).get();
            }catch(e3){
              snap = await tdb.collection('erp_orders').limit(limit).get();
            }
          }
        }

        const rows = [];
        snap.forEach(doc=>{
          const d = doc.data() || {};
          const vin = extractVinFromOrder(d);
          const status = deriveOrderStatus(d);
          const isArchived = !!(
            d.isArchived ||
            d.archivedAt || d.archived_at ||
            d.archived === true ||
            (status && /مؤرشف|مكتمل|منتهي|تم الانتهاء|closed|done|completed|archiv/i.test(status))
          );

          rows.push({
            id: doc.id,
            orderNo: (guessField(d, ['orderNo','order_number','orderId','رقم الطلب']) || '').toString().trim() || doc.id,
            customer: guessField(d, ['customerName','customer_name','name','clientName','client_name','الاسم']),
            phone: normalizePhone(guessField(d, ['phone','mobile','whatsapp','الجوال','رقم الجوال'])),
            branch: guessField(d, ['branch','branchName','branch_name','الفرع','المعرض']),
            vin,
            status: status || '—',
            isArchived,
          });
        });

        // غير المؤرشف فقط
        return rows.filter(r=>!r.isArchived);
      }

      function classifyTrackingRow(r){
        const s = (r.status||'').toString();
        // جديد
        if(!s || /جديد|new/i.test(s)) return 'new';
        // تحت الإجراء
        if(/تحت|إجراء|قيد|in\s*progress|processing|under/i.test(s)) return 'inprog';
        // افتراضي نخليه تحت الإجراء
        return 'inprog';
      }

      function buildTrackLink(vin){
        const v = (vin||'').toString().trim();
        if(!v) return '';
        // لو موجود في المخزون Tracking يدوي نستخدمه
        return getCarTrackingLinkByVin(v) || (trackingBaseUrl + encodeURIComponent(v));
      }

      async function refreshTrackingKpis(){
        try{
          const rows = await fetchTrackingOrders(600);
          let nNew=0, nIn=0;
          rows.forEach(r=>{
            const c = classifyTrackingRow(r);
            if(c==='new') nNew++;
            else nIn++;
          });
          const elN = document.getElementById('trk_new'); if(elN) elN.textContent = nNew;
          const elI = document.getElementById('trk_inprog'); if(elI) elI.textContent = nIn;
        }catch(e){
          console.warn('tracking kpi error', e);
          const elN = document.getElementById('trk_new'); if(elN) elN.textContent = '—';
          const elI = document.getElementById('trk_inprog'); if(elI) elI.textContent = '—';
        }
      }

      async function openTrackingModal(type){
        try{
          const rowsAll = await fetchTrackingOrders(600);
          const rows = rowsAll.filter(r=> classifyTrackingRow(r)===type);

          const title = (type==='new') ? 'طلبات جديدة' : 'طلبات تحت الإجراء';

          const html = `
            <div class="small" style="margin-bottom:10px">المصدر: <b>erp_orders</b> — ${escapeHtml(title)}</div>
            <div style="overflow:auto">
              <table class="table stickyHead">
                <thead>
                  <tr>
                    <th>رقم الطلب</th>
                    <th>اسم العميل</th>
                    <th>الجوال</th>
                    <th>الفرع</th>
                    <th>VIN</th>
                    <th>الحالة</th>
                    <th>تتبع</th>
                    <th>نسخ</th>
                  </tr>
                </thead>
                <tbody>
                  ${
                    rows.length ? rows.map(r=>{
                      const trackLink = r.vin ? buildTrackLink(r.vin) : '';
                      const safeLink = escapeHtml(trackLink||'');
                      return `
                        <tr>
                          <td>${escapeHtml(r.orderNo||'')}</td>
                          <td>${escapeHtml(r.customer||'')}</td>
                          <td>${escapeHtml(r.phone||'')}</td>
                          <td>${escapeHtml(r.branch||'')}</td>
                          <td>${escapeHtml(r.vin||'')}</td>
                          <td>${escapeHtml((r.status||'').toString())}</td>
                          <td>${trackLink ? `<a href="${safeLink}" target="_blank">فتح</a>` : '—'}</td>
                          <td>${trackLink ? `<button class="btn secondary" data-copy="${safeLink}" data-link="${(trackLink||'').replace(/"/g,'&quot;')}" data-vin="${escapeHtml(r.vin||'')}">نسخ</button>` : '—'}</td>
                        </tr>
                      `;
                    }).join('') : `<tr><td colspan="8" class="small">لا توجد بيانات.</td></tr>`
                  }
                </tbody>
              </table>
            </div>
          `;
          openDetailsModal(html, title);

          document.querySelectorAll('#detailsBody [data-copy]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              const link = btn.getAttribute('data-link') || btn.getAttribute('data-copy') || '';
              const vin  = (btn.getAttribute('data-vin') || '').trim();
              // 1) Copy to clipboard
              try{ await navigator.clipboard.writeText(link); toast('تم نسخ الرابط'); }
              catch(e){ /* ignore clipboard errors */ }

              // 2) Save into Inventory car data by VIN
              if(!vin || !link) return;
              try{
                await db.collection('cars').doc(vin).set({ tracking: link, trackingLink: link }, { merge: true });

                // update in-memory cache (best effort)
                try{
                  const i = (invAll||[]).findIndex(x=>String(x.vin||'').trim()===vin);
                  if(i>=0){
                    invAll[i].tracking = link;
                    invAll[i].trackingLink = link;
                  }
                }catch(_){}

                if(typeof renderInventory==='function') renderInventory();
                toast('تم حفظ رابط التتبع في المخزون ✅');
              }catch(e){
                console.error(e);
                toast('تعذر حفظ رابط التتبع في المخزون');
              }
            });
          });
        }catch(e){
          console.error(e);
          const msg = (e && (e.message || e.code)) ? (e.message || e.code) : '';
          openDetailsModal('<div class="small">تعذر تحميل طلبات التتبع'+(msg?(' — '+escapeHtml(msg)):'')+'</div>', 'Tracking');
        }
      }

      document.getElementById('dash_trk_new')?.addEventListener('click', ()=> openTrackingModal('new'));
      document.getElementById('dash_trk_inprog')?.addEventListener('click', ()=> openTrackingModal('inprog'));

      // refresh KPIs after inventory loaded
      setTimeout(()=>{ refreshTrackingKpis(); }, 1200);
      // requests stages
      document.querySelectorAll('[data-req-stage]').forEach(btn=>{
        btn.addEventListener('click', ()=> openReqStageModal(parseInt(btn.getAttribute('data-req-stage')||'0',10)));
      });

      // saved filter buttons
      document.getElementById('dash_filter_save')?.addEventListener('click', ()=>{
        const obj = getDashFilterFromUI();
        // keep old behavior (remember last filter)
        writeSavedDashFilter(obj);

        // create a new saved card
        const cards = readSavedDashCards();
        const location = (obj.location||'').trim();
        const statuses = normalizeStatuses(obj.statuses||[]);
        const title = makeCardTitle(location);

        // avoid duplicates by same location+statuses
        const key = JSON.stringify({location, statuses});
        const exists = cards.some(c=> (c.key===key));
        if(!exists){
          cards.unshift({id: 'c_'+Date.now().toString(36), key, title, location, statuses, createdAt: Date.now()});
          writeSavedDashCards(cards);
        }

        renderDashboard();
        renderSavedDashCards();
      markDashboardTotalsHighlight();
        toast(exists ? 'الكارت موجود بالفعل' : 'تم إنشاء كارت جديد');
      });
      document.getElementById('dash_filter_show')?.addEventListener('click', ()=>{
        const obj = getDashFilterFromUI();
        const cars = dashCars.filter(c=>{
          if(obj.location && (c.location||'').toString().trim() != obj.location) return false;
          if(obj.statuses && obj.statuses.length){
            return obj.statuses.map(normStatus).includes(normStatus(c.status));
          }
          return true;
        });
        const agg = countAgg(cars);
        const rows = `
          <div class="dashKpis" style="margin-bottom:10px">
            <div class="dashKpi"><span>الإجمالي الفعلي</span><b>${agg.totalActual}</b></div>
            <div class="dashKpi"><span>إجمالي المفاتيح</span><b>${agg.keysTotal}</b></div>
          </div>
          <div class="dashKpis">
            <div class="dashKpi"><span>متاح</span><b>${agg.avail}</b></div>
            <div class="dashKpi"><span>محجوز</span><b>${agg.reserved}</b></div>
            <div class="dashKpi"><span>بها ملاحظات</span><b>${agg.notes}</b></div>
            <div class="dashKpi"><span>مباع تحت التسليم</span><b>${agg.under}</b></div>
            <div class="dashKpi"><span>مباع تم التسليم</span><b>${agg.delivered}</b></div>
          </div>`;
        openDetailsModal(rows, 'عرض مخصص');
      });
      document.getElementById('dash_filter_clear')?.addEventListener('click', ()=>{
        applyDashFilterToUI({location:'', statuses:[]});
        writeSavedDashFilter({});
        renderDashboard();
        toast('تم التفريغ');
      });

      // KPI clicks (الكروت نفسها)
      document.querySelectorAll('#view-dashboard .dashKpi').forEach(kpi=>{
        kpi.style.cursor = 'pointer';
        kpi.addEventListener('click', ()=>{
          const b = kpi.querySelector('b[id]');
          if(!b) return;
          const id = b.id || '';

          // Stock / branches KPIs
          const map = {
            'stk_avail': {location:'', status:'متاح للبيع'},
            'stk_reserved': {location:'', status:'محجوز'},
            'stk_notes': {location:'', status:'بها ملاحظات'},
            'stk_under': {location:'', status:'مباع تحت التسليم'},
            'stk_delivered': {location:'', status:'مباع تم التسليم'},

            'ag_avail': {location:'الوكالة', status:'متاح للبيع'},
            'ag_reserved': {location:'الوكالة', status:'محجوز'},
            'ag_notes': {location:'الوكالة', status:'بها ملاحظات'},
            'ag_under': {location:'الوكالة', status:'مباع تحت التسليم'},
            'ag_delivered': {location:'الوكالة', status:'مباع تم التسليم'},

            'b1_avail': {location:'الصالة', status:'متاح للبيع'},
            'b1_reserved': {location:'الصالة', status:'محجوز'},
            'b1_notes': {location:'الصالة', status:'بها ملاحظات'},
            'b1_under': {location:'الصالة', status:'مباع تحت التسليم'},
            'b1_delivered': {location:'الصالة', status:'مباع تم التسليم'},

            'b2_avail': {location:'الملتقى', status:'متاح للبيع'},
            'b2_reserved': {location:'الملتقى', status:'محجوز'},
            'b2_notes': {location:'الملتقى', status:'بها ملاحظات'},
            'b2_under': {location:'الملتقى', status:'مباع تحت التسليم'},
            'b2_delivered': {location:'الملتقى', status:'مباع تم التسليم'},

            'b3_avail': {location:'القادسية', status:'متاح للبيع'},
            'b3_reserved': {location:'القادسية', status:'محجوز'},
            'b3_notes': {location:'القادسية', status:'بها ملاحظات'},
            'b3_under': {location:'القادسية', status:'مباع تحت التسليم'},
            'b3_delivered': {location:'القادسية', status:'مباع تم التسليم'},
          };

          if(map[id]){
            openCarsModalByFilter(map[id].location, [map[id].status]);
            return;
          }

          // Approvals KPIs
          if(id === 'ap_need_fin') return openApprovalsModal('fin');
          if(id === 'ap_need_adm') return openApprovalsModal('adm');
          if(id === 'ap_ready') return openApprovalsModal('ready');

          // Requests KPIs
          if(id === 'rq_s1') return openReqStageModal(1);
          if(id === 'rq_s2') return openReqStageModal(2);
          if(id === 'rq_s3') return openReqStageModal(3);
          if(id === 'rq_s4') return openReqStageModal(4);
        });

      // Requests stage buttons
      document.querySelectorAll('[data-req-stage]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const st = parseInt(btn.getAttribute('data-req-stage')||'0',10);
          if(st>=1 && st<=4) openReqStageModal(st);
        });
      });

      });

    }

    function startDashboardLive(){
      if(dashCarsUnsub) return;
      bindDashboardActions();

      // load saved filter into UI
      const saved = readSavedDashFilter();
      if(saved) applyDashFilterToUI(saved);
      loadDashLocationsIntoSelect();

      dashCarsUnsub = db.collection('cars').onSnapshot((snap)=>{
        dashCars = [];
        snap.forEach(doc=>{
          const d = doc.data() || {};
          dashCars.push({
            vin: doc.id,
            carName: d.carName || d.car || d.name || d.vehicle || '',
            statement: d.statement || d.trim || d.desc || d.variant || '',
            interiorColor: d.interiorColor || '',
            exteriorColor: d.exteriorColor || '',
            model: d.model || '',
            agent: (d.agent || d.dealer || d.vendor || d.agency || d['الوكيل'] || ''),
            location: d.location || '',
            status: (d.status || d.state || d.statuses || d['الحالة'] || ''),
            approvals: d.approvals || {financial:false, admin:false}
          });
        });
        loadDashLocationsIntoSelect();
        renderDashboard();
      });

      // catalog
      dashCatalogUnsub = db.collection('catalog').where('active','==',true).onSnapshot((snap)=>{
        dashCatalog = [];
        snap.forEach(doc=>{
          const d = doc.data() || {};
          dashCatalog.push({...d, _raw:d, id:doc.id});
        });
        renderDashboard();
      }, (err)=>{
        console.error(err);
      });

      // requests summary
      dashReqUnsub = db.collection('requests').limit(300).onSnapshot((snap)=>{
        dashReq = [];
        snap.forEach(doc=>{
          const d = doc.data() || {};
          dashReq.push({id:doc.id, ...d});
        });
        renderRequestsCounts();
      }, (err)=>{ console.error(err); });
    }

    function stopDashboardLive(){
      if(dashCarsUnsub){ dashCarsUnsub(); dashCarsUnsub=null; }
      if(dashCatalogUnsub){ dashCatalogUnsub(); dashCatalogUnsub=null; }
      if(dashReqUnsub){ dashReqUnsub(); dashReqUnsub=null; }
    }

    // Inventory filters
    ['inv_search','inv_location','inv_status','inv_model'].forEach(id=>{
      const el=$(id);
      if(el){
        el.addEventListener('input', renderInventory);
        el.addEventListener('change', renderInventory);
      }
    });

    // Export (CSV opens in Excel)
    const invExport = $('inv_export');
    if(invExport){
      invExport.addEventListener('click', ()=>{
        const { q, branch, status, model } = getInvFilters();
        const rows = invAll.filter(car=>{
          if(branch && branch!=='الكل' && norm(car.location)!==branch) return false;
          if(status && status!=='الكل' && norm(car.status)!==status) return false;
          if(model  && model!=='الكل'  && norm(car.model)!==model) return false;
          return matchesSearch(car, q);
        });

        const headers = ['VIN','السيارة','البيان','الوكيل','اللون الداخلي','اللون الخارجي','الموديل','اللوحة','الدفعة','المكان','ملاحظة المكان','ملاحظة النواقص','الحالة','Tracking'];
        const csv = [headers.join(',')].concat(rows.map(c=>[
          c.vin, c.carName, c.statement, c.agent, c.interiorColor, c.exteriorColor, c.model, c.plate, c.batchName, c.location, c.noteLocation, c.noteMissing, c.status, c.trackingLink
        ].map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(','))).join('\n');

        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download='inventory.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });
    }

    function openDetailsModal(htmlContent, title){
      // reuse existing details modal
      const modal = $('detailsModal');
      const body = $('detailsBody');
      if(!modal || !body) return;
      const h = modal.querySelector('.modal-title');
      if(h && title) h.textContent = title;
      body.innerHTML = htmlContent;
      modal.classList.add('show');
    }


    
    const toastEl = $('toast');
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 2400);
    }


    function escapeHtml(s){
      s = (s===null || s===undefined) ? '' : String(s);
      return s.replace(/[&<>"']/g, (c)=>({
        '&':'&amp;',
        '<':'&lt;',
        '>':'&gt;',
        '"':'&quot;',
        "'":'&#39;'
      }[c]));
    }

    // ===== UI: Tabs =====
    const tabs = Array.from(document.querySelectorAll('.tab'));

    // ===== Tracking iframe (inject srcdoc safely) =====
    let __trackingLoaded = false;
    function ensureTrackingLoaded(){
      if(__trackingLoaded) return;
      const frame = document.getElementById('trackingFrame');
      const tpl = document.getElementById('trackingSrc');
      if(!frame || !tpl) return;
      // Inject once to avoid GitHub/HTML attribute parsing issues with long srcdoc
      frame.srcdoc = tpl.innerHTML;
      __trackingLoaded = true;
    }

    function openView(viewId){
      tabs.forEach(t=>t.classList.toggle('active', t.dataset.view===viewId));
      document.querySelectorAll('.view').forEach(v=>v.classList.toggle('active', v.id===viewId));
      if(viewId==='view-inventory') startInventoryLive();
      else stopInventoryLive();
      if(viewId==='view-dashboard'){ startDashboardLive(); startDashCardsLive(); } else stopDashboardLive();
      if(viewId==='view-tracking') ensureTrackingLoaded();
    }
    tabs.forEach(t=>t.addEventListener('click', ()=>openView(t.dataset.view)));

    // ===== Auth =====
    const authBox = $('authBox');
    const app = $('app');
    const authPill = $('authPill');
    const btnLogout = $('btnLogout');

    $('btnLogin').addEventListener('click', async ()=>{
      const email = $('loginEmail').value.trim();
      const pass = $('loginPass').value;
      if(!email || !pass) return toast('اكتب البريد وكلمة المرور');
      try{
        await auth.signInWithEmailAndPassword(email, pass);
      }catch(e){
        toast(e.message || 'فشل تسجيل الدخول');
      }
    });

    $('btnReset').addEventListener('click', async ()=>{
      const email = $('loginEmail').value.trim();
      if(!email) return toast('اكتب البريد أولاً');
      try{
        await auth.sendPasswordResetEmail(email);
        toast('تم إرسال رابط إعادة تعيين كلمة المرور');
      }catch(e){
        toast(e.message || 'فشل الإرسال');
      }
    });

    btnLogout.addEventListener('click', ()=>auth.signOut());

    auth.onAuthStateChanged((user)=>{
      if(user){
        authPill.textContent = user.email;
        btnLogout.classList.remove('hidden');
        authBox.classList.add('hidden');
        app.classList.remove('hidden');
        // تحميل صلاحيات المستخدم (tabs + permissions) من users/{uid}
        loadCurrentUserDoc(user).then((ud)=>{
          CURRENT_USER_DOC = ud;
          applyAccessControl(user, ud || {});

          // تحميل صلاحية النقل (مبنية على role داخل userDoc أو الأدمن الثابت)
          const role = (ud && (ud.role || ud.type || ud.permission)) ? (ud.role || ud.type || ud.permission) : '';
          canTransfer = roleAllows(role) || isAdminClient(user, ud || {});
          const hint = document.getElementById('tr_hint');
          if(hint){
            hint.innerHTML = canTransfer
              ? 'المسموح بالنقل: <b>الادارة / اداري</b>. سيتم تسجيل آخر الحركات مع البريد المنفذ.'
              : 'غير مصرح لك بالنقل — اطلب من الإدارة إضافتك في <b>users</b> وتحديد role.';
          }
        });
        toast('تم تسجيل الدخول');
        loadMetaLists().catch(e=>console.warn('lists',e));
        bindListsEvents();
        const fs=document.getElementById('f_status');
        if(fs) fs.addEventListener('change', uiStatusNotesToggle);
        const ts=document.getElementById('tr_status');
        if(ts) ts.addEventListener('change', uiTransferNoteToggle);
        uiStatusNotesToggle();
        uiTransferNoteToggle();
      }else{
        authPill.textContent = 'غير مسجل';
        btnLogout.classList.add('hidden');
        authBox.classList.remove('hidden');
        app.classList.add('hidden');
        canTransfer = false;
        stopInventoryLive();
      }
    });

    // ===== Data Helpers =====
    const HEADERS = [
      'الهيكل (VIN)','السيارة','البيان','الوكيل','اللون الداخلي','اللون الخارجي','موديل','اللوحة','اسم الدفعة بالتاريخ','المكان',
      'ملاحظات (تحديد المكان)','ملاحظات (تخص النواقص)','الحالة','ملاحظات السيارات (تُفتح عند الحالة: بها ملاحظات)',
      'فرشات','طفاية','شنطة','اسبير','ريموت','شاشة','مسجل','مكيف','كاميرا','حساس','الموافقة المالية','الموافقة الادارية','التتبع Tracking'
    ];

    function normBool(v){
      if(v===true) return true;
      if(v===false) return false;
      const s = (v??'').toString().trim().toLowerCase();
      if(!s) return false;
      return ['1','true','yes','y','نعم','صح','√','✅','ok','تم'].includes(s);
    }

    function carFromForm(){
      const vin = $('f_vin').value.trim();
      return {
        vin,
        carName: $('f_car').value.trim(),
        statement: $('f_statement').value.trim(),
        agent: $('f_agent').value.trim(),
        interiorColor: $('f_int').value.trim(),
        exteriorColor: $('f_ext').value.trim(),
        model: $('f_model').value.trim(),
        plate: $('f_plate').value.trim(),
        batchName: $('f_batch').value.trim(),
        location: $('f_location').value.trim(),
        status: $('f_status').value.trim(),
        notesLocation: $('f_notesLoc').value.trim(),
        noteLocation: $('f_notesLoc').value.trim(),
        notesMissing: $('f_notesMissing').value.trim(),
        noteMissing: $('f_notesMissing').value.trim(),
        carNotes: $('f_carNotes').value.trim(),
        trackingLink: $('f_tracking').value.trim(),
        tracking: $('f_tracking').value.trim(),
        checklist: {
          farshat: $('c_farshat').checked,
          tafaia: $('c_tafaia').checked,
          shanta: $('c_shanta').checked,
          spare: $('c_spare').checked,
          remote: $('c_remote').checked,
          screen: $('c_screen').checked,
          recorder: $('c_recorder').checked,
          ac: $('c_ac').checked,
          camera: $('c_camera').checked,
          sensors: $('c_sensors').checked,
        },
        approvals: {
          financial: $('a_financial').value===''? null : $('a_financial').value==='true',
          admin: $('a_admin').value===''? null : $('a_admin').value==='true'
        },
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      };
    }

    function fillForm(d){
      $('f_vin').value = d.vin || '';
      $('f_car').value = d.carName || '';
      $('f_statement').value = d.statement || '';
      $('f_agent').value = d.agent || '';
      $('f_int').value = d.interiorColor || '';
      $('f_ext').value = d.exteriorColor || '';
      $('f_model').value = d.model || '';
      $('f_plate').value = d.plate || '';
      $('f_batch').value = d.batchName || '';
      $('f_location').value = d.location || '';
      $('f_status').value = d.status || '';
      $('f_notesLoc').value = (d.notesLocation || d.noteLocation || '');
      $('f_notesMissing').value = (d.notesMissing || d.noteMissing || '');
      $('f_carNotes').value = d.carNotes || '';
            $('f_tracking').value = d.tracking || '';

      const c = d.checklist || {};
      $('c_farshat').checked = !!c.farshat;
      $('c_tafaia').checked = !!c.tafaia;
      $('c_shanta').checked = !!c.shanta;
      $('c_spare').checked = !!c.spare;
      $('c_remote').checked = !!c.remote;
      $('c_screen').checked = !!c.screen;
      $('c_recorder').checked = !!c.recorder;
      $('c_ac').checked = !!c.ac;
      $('c_camera').checked = !!c.camera;
      $('c_sensors').checked = !!c.sensors;

      const a = d.approvals || {};
      $('a_financial').value = (a.financial===true)?'true':(a.financial===false?'false':'');
      $('a_admin').value = (a.admin===true)?'true':(a.admin===false?'false':'');
    }

    function clearForm(){
      ['f_vin','f_car','f_statement','f_agent','f_int','f_ext','f_model','f_plate','f_batch','f_location','f_status','f_notesLoc','f_notesMissing','f_carNotes','f_tracking'].forEach(id=>$(id).value='');
      ['c_farshat','c_tafaia','c_shanta','c_spare','c_remote','c_screen','c_recorder','c_ac','c_camera','c_sensors'].forEach(id=>$(id).checked=false);
      $('a_financial').value='';
      $('a_admin').value='';
    }

    // ===== Admin actions =====
    $('btnClear').addEventListener('click', clearForm);

    $('btnSave').addEventListener('click', async ()=>{
      const data = carFromForm();
      if(!data.vin) return toast('رقم الهيكل (VIN) مطلوب');
      try{
        const ref = db.collection('cars').doc(data.vin);
        const snap = await ref.get();
        if(!snap.exists) data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        await ref.set(data, {merge:true});
        toast('تم الحفظ');
        logAction('admin','car_save',{vin:data.vin, carName:data.carName||data.car||'', model:data.model||'', location:data.location||'', status:data.status||''});
        }catch(e){
        toast(e.message || 'فشل الحفظ');
      }
    });

    $('btnFind').addEventListener('click', async ()=>{
      const vin = $('f_vin').value.trim();
      if(!vin) return toast('اكتب VIN');
      try{
        const snap = await db.collection('cars').doc(vin).get();
        if(!snap.exists) return toast('غير موجود');
        fillForm(snap.data());
        toast('تم جلب البيانات');
      }catch(e){
        toast(e.message || 'فشل البحث');
      }
    });

    // ===== Excel Export Helpers =====
    function downloadWorkbook(wb, filename){
      const out = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      const blob = new Blob([out], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    function exportTemplate(){
      const ws = XLSX.utils.aoa_to_sheet([HEADERS]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'template');
      downloadWorkbook(wb, 'cars_template.xlsx');
    }

    $('btnTemplate').addEventListener('click', exportTemplate);

    async function exportAllCars(){
      try{
        const qs = await db.collection('cars').get();
        const rows = [HEADERS];
        qs.forEach(doc=>rows.push(rowFromCar(doc.data())));
        const ws = XLSX.utils.aoa_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'cars');
        downloadWorkbook(wb, 'cars_export.xlsx');
      }catch(e){
        toast(e.message || 'فشل التصدير');
      }
    }
    $('btnExportAll').addEventListener('click', exportAllCars);

    // ===== Import =====
    const importModal = $('importModal');
    const importFile = $('importFile');
    const importMode = $('importMode');
    const importPreview = $('importPreview');
    const runImportBtn = $('runImport');

    $('btnImport').addEventListener('click', ()=>{importModal.classList.add('show')});
    $('closeImport').addEventListener('click', ()=>{importModal.classList.remove('show')});
    $('clearImport').addEventListener('click', ()=>{
      importFile.value='';
      importPreview.textContent='—';
      runImportBtn.disabled=true;
    });

    let parsedRows = [];

    function readExcel(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = (e)=>{
          try{
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type:'array'});
            const sheetName = wb.SheetNames[0];
            const ws = wb.Sheets[sheetName];
            const aoa = XLSX.utils.sheet_to_json(ws, {header:1, blankrows:false});
            resolve(aoa);
          }catch(err){reject(err)}
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    function mapHeaderIndexes(headerRow){
      const map = {};
      headerRow.forEach((h, idx)=>{
        const key = (h||'').toString().trim();
        if(!key) return;
        if(map[key]===undefined) map[key]=idx;
        else {
          // duplicate header
          map[key+'__dup'+idx]=idx;
        }
      });
      return map;
    }

    function getCell(row, headerMap, name, fallbackDupContains=null){
      if(headerMap[name]!==undefined) return row[headerMap[name]];
      if(fallbackDupContains){
        const k = Object.keys(headerMap).find(x=>x.startsWith(fallbackDupContains));
        if(k) return row[headerMap[k]];
      }
      return '';
    }

    // === Excel Import: Stage3 fix (wire Execute Import) ===
    let __importCarsBuffer = [];

    function normalizeStatus(s){
      s = (s||'').toString().trim();
      // accept common variants
      if(s==='مباع تحت التسلم') s='مباع تحت التسليم';
      return s;
    }

    function excelRowToCar(row, headerMap){
      const vin = (getCell(row, headerMap, 'الهيكل') || getCell(row, headerMap, 'الهيكل (VIN)') || getCell(row, headerMap, '(VIN)') || '').toString().trim();
      if(!vin) return null;

      const carName = (getCell(row, headerMap, 'السيارة') || getCell(row, headerMap, 'اسم السيارة') || '').toString().trim();
      const statement = (getCell(row, headerMap, 'البيان') || '').toString().trim();
      const agent = (getCell(row, headerMap, 'الوكيل') || getCell(row, headerMap, 'وكيل') || getCell(row, headerMap, 'Agency') || '').toString().trim();
      const interiorColor = (getCell(row, headerMap, 'اللون الداخلي') || getCell(row, headerMap, 'داخلي') || '').toString().trim();
      const exteriorColor = (getCell(row, headerMap, 'اللون الخارجي') || getCell(row, headerMap, 'خارجي') || '').toString().trim();
      const model = (getCell(row, headerMap, 'الموديل') || getCell(row, headerMap, 'موديل') || '').toString().trim();
      const plate = (getCell(row, headerMap, 'اللوحة') || '').toString().trim();
      const location = (getCell(row, headerMap, 'المكان الحالي') || getCell(row, headerMap, 'المكان') || '').toString().trim();
      const status = normalizeStatus(getCell(row, headerMap, 'الحالة') || getCell(row, headerMap, 'Status') || '');
      const notesLocation = (getCell(row, headerMap, 'ملاحظات المكان') || '').toString().trim();
      const notesMissing = (getCell(row, headerMap, 'نواقص') || getCell(row, headerMap, 'النواقص') || '').toString().trim();
      const tracking = (getCell(row, headerMap, 'Tracking') || getCell(row, headerMap, 'التتبع') || '').toString().trim();

      return {
        vin,
        carName,
        statement,
        agent,
        interiorColor,
        exteriorColor,
        model,
        plate,
        location,
        status,
        notesLocation,
        notesMissing,
        tracking,
        updatedAt: new Date(),
        updatedBy: (auth?.currentUser?.email || '')
      };
    }

    async function deleteAllCars(dbi){
      const snap = await dbi.collection('cars').get();
      let batch = dbi.batch();
      let n=0;
      for(const doc of snap.docs){
        batch.delete(doc.ref);
        n+=1;
        if(n % 400 == 0){
          await batch.commit();
          batch = dbi.batch();
        }
      }
      if(n % 400 != 0) await batch.commit();
      return n;
    }

    async function upsertCars(dbi, cars, merge=true){
      let batch = dbi.batch();
      let n=0;
      for(const c of cars){
        const ref = dbi.collection('cars').doc(String(c.vin));
        batch.set(ref, c, { merge });
        n+=1;
        if(n % 400 == 0){
          await batch.commit();
          batch = dbi.batch();
        }
      }
      if(n % 400 != 0) await batch.commit();
      return n;
    }

    // Wire file input + execute button
    (function bindExcelImportUI(){
      if(!importFile) return;

      importFile.addEventListener('change', async (e)=>{
        try{
          const file = e.target.files?.[0];
          __importCarsBuffer = [];
          if(!file){
            importPreview.textContent = '';
            runImportBtn.disabled = true;
            return;
          }
          const data = await file.arrayBuffer();
          const wb = XLSX.read(data, { type:'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, defval: '' });
          if(!aoa || aoa.length < 2){
            importPreview.textContent = 'ملف غير صالح أو فارغ.';
            runImportBtn.disabled = true;
            return;
          }
          const headers = aoa[0];
          const headerMap = mapHeaderIndexes(headers);
          for(const row of aoa.slice(1)) {
            const c = excelRowToCar(row, headerMap);
            if(c) __importCarsBuffer.append ? __importCarsBuffer.append(c) : __importCarsBuffer.push(c);
          }
          importPreview.textContent = `تم قراءة ${__importCarsBuffer.length} سيارة من الملف.`;
          runImportBtn.disabled = (__importCarsBuffer.length===0);
        }catch(err){
          console.error(err);
          importPreview.textContent = 'فشل قراءة ملف Excel.';
          runImportBtn.disabled = true;
        }
      });

      runImportBtn.addEventListener('click', async ()=>{
        try{
          if(runImportBtn.disabled) return;
          if(!__importCarsBuffer || __importCarsBuffer.length===0){
            alert('لا توجد بيانات للاستيراد. اختر ملف Excel أولاً.');
            return;
          }
          runImportBtn.disabled = true;
          runImportBtn.textContent = 'جاري الاستيراد...';

          const dbi = firebase.firestore();
          const mode = importMode.value;
          if(mode === 'replace'){
            await deleteAllCars(dbi);
            await upsertCars(dbi, __importCarsBuffer, false);
          } else {
            await upsertCars(dbi, __importCarsBuffer, true);
          }

          importPreview.textContent = `تم الاستيراد بنجاح: ${__importCarsBuffer.length} سيارة.`;
          runImportBtn.textContent = 'تم';
          setTimeout(()=>{ runImportBtn.textContent = 'تنفيذ الاستيراد'; runImportBtn.disabled = false; }, 900);
          // refresh inventory/dashboard counts if helpers exist
          if(typeof loadCarsToMemory === 'function') { try{ await loadCarsToMemory(); }catch(_){} }
          if(typeof refreshDashboardCards === 'function') { try{ refreshDashboardCards(); }catch(_){} }
        }catch(err){
          console.error(err);
          alert('فشل تنفيذ الاستيراد. راجع الكونسول.');
          runImportBtn.textContent = 'تنفيذ الاستيراد';
          runImportBtn.disabled = false;
        }
      });
    })();

    // === End Excel Import fix ===


    function carFromExcelRow(row, headerMap){
      const vin = (getCell(row, headerMap, 'الهيكل') || getCell(row, headerMap, 'الهيكل (VIN)') || '').toString().trim();
      const cells = [
          d.vin||'', d.carName||'', d.statement||'', d.agent||'',
          d.interiorColor||'', d.exteriorColor||'', d.model||'', d.plate||'',
          d.batchName||'', d.location||'', d.notesLocation||'', d.notesMissing||'', d.status||'',
          (d.tracking||''),
          '__APPROVALS__',
          '__CHECK__',
          '__TRANSFERS__',
          '__ARCHIVE__'
        ];
        cells.forEach(txt=>{
          const td = document.createElement('td');
          if(txt === '__APPROVALS__'){
            const b = document.createElement('button');
            b.className = 'linkBtn';
            b.type = 'button';
            b.textContent = 'الموافقات';
            b.addEventListener('click', ()=> openInvModal('approvals', d));
            td.appendChild(b);
          } else if(txt === '__CHECK__'){
            const b = document.createElement('button');
            b.className = 'linkBtn';
            b.type = 'button';
            b.textContent = 'التشيك';
            b.addEventListener('click', ()=> openInvModal('checklist', d));
            td.appendChild(b);
          } else if(txt === '__TRANSFERS__'){
            const b = document.createElement('button');
            b.className = 'linkBtn';
            b.type = 'button';
            b.textContent = 'طلبات النقل';
            b.addEventListener('click', ()=> openInvModal('transfers', d));
            td.appendChild(b);
          } else if(txt === '__ARCHIVE__'){
            const b = document.createElement('button');
            b.className = 'linkBtn danger';
            b.type = 'button';
            b.textContent = 'أرشيف';
            const ok = canArchiveCar(d);
            if(!ok){
              b.disabled = true;
              b.title = 'لا يمكن الأرشفة إلا عند اكتمال: مباع تم التسليم + موافقات مالية/إدارية + Tracking + طلبات نقل مكتملة';
            }
            b.addEventListener('click', ()=> archiveCar(d));
            td.appendChild(b);
          } else {
            td.textContent = txt;
          }
          tr.appendChild(td);
        });
        tb.appendChild(tr);
      $('inv_meta').textContent = `الإجمالي: ${invFiltered.length} من ${invAll.length}`;
    }

    // ===== مخزون: (الموافقات / التشيك / طلبات النقل / الأرشيف) =====
    const detailsModal = document.getElementById('detailsModal');
    const detailsBody = document.getElementById('detailsBody');
    const detailsClose = document.getElementById('detailsClose');

    function closeInvModal(){
      detailsModal.classList.remove('show');
      detailsBody.innerHTML = '';
    }
    if(detailsClose){
      detailsClose.addEventListener('click', closeInvModal);
    }
    if(detailsModal){
      detailsModal.addEventListener('click', (e)=>{
        if(e.target === detailsModal) closeInvModal();
      });
    }

    function yn(v){ return v ? '✅' : '❌'; }

    async function openInvModal(type, d){
      detailsBody.innerHTML = '';
      let title = '';
      if(type === 'approvals'){
        title = 'الموافقات';
        const a = (d && d.approvals) ? d.approvals : {};
        detailsBody.innerHTML = `
          <div class="modalHead"><h3>${title}</h3></div>
          <div class="grid2" style="gap:10px">
            <div class="miniCard"><div class="miniTitle">الموافقة المالية</div><div class="miniVal">${yn(!!a.financial)}</div></div>
            <div class="miniCard"><div class="miniTitle">الموافقة الإدارية</div><div class="miniVal">${yn(!!a.admin)}</div></div>
          </div>
        `;
      } else if(type === 'checklist'){
        title = 'التشيك';
        const c = (d && d.checklist) ? d.checklist : {};
        const items = [
          ['حساس', !!c.sensor || !!c.sensors],
          ['كاميرا', !!c.camera],
          ['مكيف', !!c.ac],
          ['مسجل', !!c.recorder || !!c.musajjal],
          ['شاشة', !!c.screen],
          ['ريموت', !!c.remote],
          ['فرشات', !!c.farshat],
          ['طفاية', !!c.tafaia],
          ['شنطة سلامة', !!c.shanta],
          ['اسبير', !!c.spare]
        ];
        detailsBody.innerHTML = `
          <div class="modalHead"><h3>${title}</h3></div>
          <div class="grid2" style="gap:10px">
            ${items.map(i=>`<div class="miniCard"><div class="miniTitle">${i[0]}</div><div class="miniVal">${yn(i[1])}</div></div>`).join('')}
          </div>
        `;
      } else if(type === 'transfers'){
        title = 'حركات النقل';
        detailsBody.innerHTML = `<div class="modalHead"><h3>${title}</h3></div><div class="small">جاري التحميل...</div>`;
        const logs = await fetchTransferLogs(d && d.vin);
        if(!logs.length){
          detailsBody.innerHTML = `<div class="modalHead"><h3>${title}</h3></div><div class="small">لا توجد حركات نقل مسجلة لهذه السيارة.</div>`;
        } else {
          const rows = logs.map((x,idx)=>{
            const dt = x.at ? formatTs(x.at) : '';
            const from = x.fromLocation || x.from || '';
            const to = x.toLocation || x.to || '';
            const by = x.by || '';
            const act = x.action || '';
            return `<tr>
              <td>${idx+1}</td>
              <td>${escapeHtml(dt)}</td>
              <td>${escapeHtml(from)}</td>
              <td>${escapeHtml(to)}</td>
              <td>${escapeHtml(by)}</td>
              <td>${escapeHtml(act)}</td>
            </tr>`;
          }).join('');
          detailsBody.innerHTML = `
            <div class="modalHead"><h3>${title}</h3></div>
            <div class="tableWrap" style="padding:0">
              <table>
                <thead><tr>
                  <th>#</th><th>التاريخ</th><th>من</th><th>إلى</th><th>المنفذ</th><th>النوع</th>
                </tr></thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          `;
        }
      }
      detailsModal.classList.add('show');
    }

    async function fetchTransferLogs(vin){
      try{
        if(!vin) return [];
        const q = query(collection(db,'logs'), where('vin','==',vin), orderBy('at','desc'), limit(50));
        const snap = await getDocs(q);
        return snap.docs.map(d=>d.data());
      }catch(e){
        console.warn('fetchTransferLogs', e);
        return [];
      }
    }

    function canArchiveCar(d){
      try{
        if(!d) return false;
        if((d.status||'') !== 'مباع تم التسليم') return false;
        const a = d.approvals || {};
        if(!a.financial || !a.admin) return false;
        if(!(d.tracking||'').toString().trim()) return false;
        return true;
      }catch(_){ return false; }
    }

    async function archiveCar(d){
      try{
        if(!d || !d.vin) return;
        if(!canArchiveCar(d)) return;
        const logs = await fetchTransferLogs(d.vin);
        if(!logs.length){
          alert('لا يمكن الأرشفة: لا توجد حركات نقل مسجلة لهذه السيارة.');
          return;
        }

        const user = auth.currentUser;
        if(!user){ alert('يجب تسجيل الدخول'); return; }

        const vin = d.vin;
        const carRef = doc(db,'cars',vin);
        const archRef = doc(db,'archives',vin);

        const payload = Object.assign({}, d, {
          archivedAt: serverTimestamp(),
          archivedBy: user.email || ''
        });

        await setDoc(archRef, payload, {merge:false});
        await deleteDoc(carRef);

        logAction('inventory','car_archive',{vin: vin, carName: d.carName||'', fromLocation: d.location||'', toLocation: 'archives'});
        invAll = invAll.filter(x=>x.vin!==vin);
        applyInvFilters();
        alert('تمت الأرشفة بنجاح ✅');
      } catch(e){
        console.error(e);
        alert('تعذر أرشفة السيارة.');
      }
    }

  
    // ===== Transfer Tab =====
    let canTransfer = false;

    async function loadUserRole(email){
      try{
        const doc = await db.collection('users').doc(email).get();
        if(!doc.exists) return null;
        const d = doc.data() || {};
        return (d.role || d.type || d.permission || '').toString().trim();
      }catch(e){ return null; }
    }

    function roleAllows(role){
      if(!role) return false;
      const r = role.toString().toLowerCase();
      return ['admin','administrator','administration','ادارة','الإدارة','اداري','إداري'].some(x=>r.includes(x.toLowerCase()));
    }

    function parseVins(text){
      return Array.from(new Set(
        (text||'').split(/\r?\n/).map(x=>x.trim()).filter(Boolean)
      ));
    }

    // ===== Transfer VIN Table (multiple cars) =====
    function getTransferVinsFromTable(){
      const tb = document.querySelector('#tr_vinTable tbody');
      if(!tb) return [];
      const vins = [];
      tb.querySelectorAll('input[data-vin-input]').forEach(inp=>{
        const v = (inp.value||'').trim();
        if(v) vins.push(v);
      });
      // unique
      return Array.from(new Set(vins));
    }

    function clearTransferRows(){
      const tb = document.querySelector('#tr_vinTable tbody');
      if(!tb) return;
      tb.innerHTML = '';
      // add 3 empty rows by default
      addTransferRow();
    }

    function approvalsTextLocal(a){
      a = a || {};
      const f = a.financial===true ? '✓ مالية' : '✗ مالية';
      const ad = a.admin===true ? '✓ إدارية' : '✗ إدارية';
      return `${f} | ${ad}`;
    }

    function setRowLoading(tr, on){
      tr.dataset.loading = on ? '1' : '0';
      tr.style.opacity = on ? '.65' : '1';
    }

    async function fillRowFromVin(tr, vin){
      const cells = {
        car: tr.querySelector('[data-cell=car]'),
        loc: tr.querySelector('[data-cell=loc]'),
        st:  tr.querySelector('[data-cell=st]'),
        ap:  tr.querySelector('[data-cell=ap]')
      };

      if(!vin){
        cells.car.textContent = '';
        cells.loc.textContent = '';
        cells.st.textContent  = '';
        cells.ap.textContent  = '';
        tr.dataset.vin = '';
        return;
      }

      setRowLoading(tr, true);
      try{
        const snap = await db.collection('cars').doc(vin).get();
        if(!snap.exists){
          cells.car.textContent = 'غير موجود';
          cells.loc.textContent = '—';
          cells.st.textContent  = '—';
          cells.ap.textContent  = '—';
          tr.dataset.vin = vin;
          tr.dataset.missing = '1';
        }else{
          const d = snap.data()||{};
          cells.car.textContent = d.carName || '';
          cells.loc.textContent = d.location || '';
          cells.st.textContent  = d.status || '';
          cells.ap.textContent  = approvalsTextLocal(d.approvals);
          tr.dataset.vin = d.vin || vin;
          tr.dataset.missing = '0';
        }
      }finally{
        setRowLoading(tr, false);
      }
    }

    function addTransferRow(vin=''){
      const tb = document.querySelector('#tr_vinTable tbody');
      if(!tb) return;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input data-vin-input placeholder="اكتب VIN" value="${(vin||'').replace(/"/g,'&quot;')}" style="min-width:210px" /></td>
        <td data-cell="car"></td>
        <td data-cell="loc"></td>
        <td data-cell="st"></td>
        <td data-cell="ap"></td>
        <td><button class="btn danger" type="button" data-del-row style="padding:7px 10px;border-radius:10px">حذف</button></td>
      `;
      tb.appendChild(tr);

      const inp = tr.querySelector('input[data-vin-input]');
      let t=null;
      inp.addEventListener('input', ()=>{
        const v = inp.value.trim();
        if(t) clearTimeout(t);
        t = setTimeout(()=>fillRowFromVin(tr, v), 250);
      });
      inp.addEventListener('blur', ()=>fillRowFromVin(tr, inp.value.trim()));

      tr.querySelector('[data-del-row]').addEventListener('click', ()=>{
        tr.remove();
      });

      // initial fill if vin provided
      if(vin) fillRowFromVin(tr, vin);
    }

    function isNotesLocation(loc){
      return (loc||'').includes('سيارات بها ملاحظات');
    }

    function isUnderDelivery(loc){
      return (loc||'').includes('مباع تحت التسليم');
    }

    function isDelivered(loc){
      return (loc||'').includes('مباع تم التسليم');
    }

    async function fetchCarsByVins(vins){
      const res = [];
      for(const vin of vins){
        const snap = await db.collection('cars').doc(vin).get();
        if(snap.exists) res.push(snap.data());
        else res.push({ vin, _missing:true });
      }
      return res;
    }
    async function submitTransfer(){
      if(!canTransfer) return toast('غير مصرح لك بالنقل');
      const user = auth.currentUser;
      if(!user) return toast('سجّل دخول أولاً');

      const toLoc = $('tr_to').value;
      if(!toLoc) return toast('اختر المكان المستهدف');

      const selectedStatus = ($('tr_status')?.value || '').trim();
      if(!selectedStatus) return toast('اختر الحالة');

      // الحالة الفعلية: لو المكان المستهدف "مباع تحت التسليم" أو "مباع تم التسليم" نثبتها حتى لا يحصل تعارض
      let toStatus = selectedStatus;
      if(isUnderDelivery(toLoc)) toStatus = 'مباع تحت التسليم';
      if(isDelivered(toLoc))     toStatus = 'مباع تم التسليم';

      const noteRequired = (toStatus === 'بها ملاحظات') || isNotesLocation(toLoc);
      const note = $('tr_note').value.trim();
      if(noteRequired && !note) return toast('اكتب الملاحظة (مطلوبة)');

      const vins = getTransferVinsFromTable();
      if(vins.length===0) return toast('اكتب VIN واحد على الأقل');

      const cars = await fetchCarsByVins(vins);
      const missing = cars.filter(x=>x._missing);
      if(missing.length){
        toast('في هياكل غير موجودة — راجع المعاينة');
        renderTransferPreview(cars);
        return;
      }

      // ممنوع "مباع تم التسليم" بدون موافقات (مالية + إدارية)
      const blocked = [];
      cars.forEach(d=>{
        if(isDelivered(toStatus)){
          const a = d.approvals || {};
          if(!(a.financial===true && a.admin===true)) blocked.push(d.vin);
        }
      });
      if(blocked.length){
        return toast('ممنوع نقل تم التسليم بدون موافقات: ' + blocked.slice(0,5).join(', ') + (blocked.length>5?'...':''));
      }

      // إنشاء طلب
      const req = {
        type: 'transfer',
        vins,
        toLocation: toLoc,
        toStatus: toStatus,
        selectedStatus: selectedStatus,
        note: noteRequired ? note : '',
        createdBy: user.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        status: 'created'
      };

      // لو الحالة: مباع تحت التسليم
      if(isUnderDelivery(toStatus)){
        req.requiresApprovals = true;
        req.approvalsStatus = { financial:false, admin:false };
      }

      const ref = await db.collection('transfers').add(req);

      // تحديث السيارات + تسجيل لوج لكل سيارة
      const batch = db.batch();
      cars.forEach(d=>{
        const carRef = db.collection('cars').doc(d.vin);
        const fromLoc = d.location || '';

        const update = {
          location: toLoc,
          status: toStatus,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        };

        // لو الحالة: مباع تحت التسليم => جهّز الموافقات (وتظهر في كارت الموافقة المالية والإدارية)
        if(isUnderDelivery(toStatus)){
          const cur = d.approvals || {};
          update.approvals = {
            financial: (cur.financial===true),
            admin: (cur.admin===true)
          };
        }

        // في حالة الحالة: بها ملاحظات (أو مكان سيارات بها ملاحظات): خزّن الملاحظة
        if(noteRequired){ update.notesLocation = note; update.noteLocation = note; }

        batch.set(carRef, update, {merge:true});

        const logRef = db.collection('logs').doc();
        batch.set(logRef, {
          action: 'transfer',
          vin: d.vin,
          carName: d.carName || '',
          fromLocation: fromLoc,
          toLocation: toLoc,
          fromStatus: d.status || '',
          toStatus: toStatus,
          note: noteRequired ? note : '',
          by: user.email,
          requestId: ref.id,
          at: firebase.firestore.FieldValue.serverTimestamp()
        });
      });

      await batch.commit();

      clearTransferRows();
      $('tr_to').value = '';
      $('tr_status').value = '';
      $('tr_note').value = '';
      $('tr_note_box').classList.add('hidden');
      toast('تم إنشاء طلب النقل وتحديث السيارات');

      // تحديث السجل فوراً
      startLogsLive();
    }

    // UI bindings transfer
    const trAddRow = $('tr_addRow');
    if(trAddRow) trAddRow.addEventListener('click', ()=>addTransferRow());

    const trClearRows = $('tr_clearRows');
    if(trClearRows) trClearRows.addEventListener('click', ()=>clearTransferRows());

    // init rows once
    if(document.querySelector('#tr_vinTable tbody') && document.querySelector('#tr_vinTable tbody').children.length===0){
      clearTransferRows();
    }

    const trTo = $('tr_to');
    if(trTo){
      trTo.addEventListener('change', ()=>{
        // صندوق الملاحظة يظهر لو الحالة = بها ملاحظات أو المكان = سيارات بها ملاحظات
        const st = document.getElementById('tr_status')?.value || '';
        if(isNotesLocation(trTo.value) || st==='بها ملاحظات') $('tr_note_box').classList.remove('hidden');
        else { $('tr_note_box').classList.add('hidden'); $('tr_note').value=''; }
      });
    }
    const trPreviewBtn = $('tr_preview');
    if(trPreviewBtn) trPreviewBtn.addEventListener('click', ()=>doPreview().catch(()=>toast('فشل المعاينة')));

    const trSubmitBtn = $('tr_submit');
    if(trSubmitBtn) trSubmitBtn.addEventListener('click', ()=>submitTransfer().catch(e=>toast(e.message||'فشل التنفيذ')));

    // Logs live (last movements)
    let logUnsub = null;
    function stopLogsLive(){ if(logUnsub){logUnsub(); logUnsub=null;} }
    function startLogsLive(tableId='log_table', metaId='log_meta'){
      if(logUnsub) return;
      logUnsub = db.collection('logs').orderBy('at','desc').limit(50).onSnapshot((snap)=>{
        const tb = document.querySelector('#'+tableId+' tbody');
        if(!tb) return;
        tb.innerHTML = '';
        let count = 0;
        snap.forEach(doc=>{
          const d = doc.data()||{};
          const tr = document.createElement('tr');
          const type = (d.action||'').includes('request_') ? 'طلبات' : ((d.action||'')==='transfer' ? 'نقل' : (d.action||''));
          const cells = [type, d.vin||'', d.fromLocation||d.from||'', d.toLocation||d.to||'', d.note||'', d.by||''];
          cells.forEach(t=>{
            const td = document.createElement('td');
            td.textContent = t;
            tr.appendChild(td);
          });
          tb.appendChild(tr);
          count++;
        });
        const meta = document.getElementById(metaId);
        if(meta) meta.textContent = `آخر الحركات: ${count}`;
      }, (err)=>toast(err.message||'فشل تحميل السجل'));
    }

    // تعديل openView لتفعيل السجل داخل تبويب النقل
    const _openView = openView;
    openView = function(viewId){
      _openView(viewId);
      if(viewId==='view-transfer'){
        stopLogsLive();
        startLogsLive('log_table','log_meta');
      }else if(viewId==='view-requests'){
        stopLogsLive();
        startLogsLive('log_table_req','log_meta_req');
      }else{
        stopLogsLive();
      }
      if(viewId==='view-logs') loadLogs().catch(e=>toast(e.message||'فشل تحميل السجل'));
    }


    
    // ===== Logs (Global) =====
    async function logAction(tab, action, extra){
      try{
        const user = auth.currentUser;
        if(!user) return;
        const payload = Object.assign({}, extra||{});
        // حاول التقاط اسم السيارة/الموديل لو موجود
        const doc = {
          tab: tab || '',
          action: action || '',
          vin: payload.vin || '',
          carName: payload.carName || payload.car || '',
          model: payload.model || '',
          fromLocation: payload.fromLocation || payload.from || '',
          toLocation: payload.toLocation || payload.to || '',
          by: user.email || '',
          at: firebase.firestore.FieldValue.serverTimestamp(),
          payload
        };
        await db.collection('logs').add(doc);
      }catch(e){
        // لا نوقف العملية الأساسية بسبب اللوج
        console.warn('logAction failed', e);
      }
    }

    function boolTag(v){ return v===true ? '✓' : (v===false ? '✗' : ''); }

    // --- قوائم النظام (الفروع + الحالات) من Firestore: meta/lists ---
    const META_LISTS_PATH = {col:'meta', doc:'lists'};
    const DEFAULT_BRANCHES = ['الملتقى','القادسية','الصالة','الوكالة','المستودع'];
    const DEFAULT_STATUSES = ['مباع تحت التسليم','متاح للبيع','حجز','مباع تم التسليم','بها ملاحظات'];

    let APP_LISTS = { branches:[...DEFAULT_BRANCHES], statuses:[...DEFAULT_STATUSES] };

    async function ensureMetaLists(){
      const ref = db.collection(META_LISTS_PATH.col).doc(META_LISTS_PATH.doc);
      const snap = await ref.get();
      if(!snap.exists){
        await ref.set({
          branches: DEFAULT_BRANCHES,
          statuses: DEFAULT_STATUSES,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: auth.currentUser?.email || ''
        });
      }
    }

    async function loadMetaLists(){
      await ensureMetaLists();
      const ref = db.collection(META_LISTS_PATH.col).doc(META_LISTS_PATH.doc);
      const snap = await ref.get();
      const d = snap.data() || {};
      const b = Array.isArray(d.branches) ? d.branches.filter(Boolean) : DEFAULT_BRANCHES;
      const s = Array.isArray(d.statuses) ? d.statuses.filter(Boolean) : DEFAULT_STATUSES;
      APP_LISTS = { branches: b.length?b:DEFAULT_BRANCHES, statuses: s.length?s:DEFAULT_STATUSES };
      fillAllLists();
    }

    function makeOption(val, text){
      const o=document.createElement('option');
      o.value=val; o.textContent=text;
      return o;
    }

    function fillSelect(sel, items, addLabel){
      if(!sel) return;
      const cur = sel.value;
      sel.innerHTML='';
      sel.appendChild(makeOption('', '— اختر —'));
      items.forEach(x=> sel.appendChild(makeOption(x, x)));
      sel.appendChild(makeOption('__add__', addLabel));
      // restore if exists
      if(items.includes(cur)) sel.value=cur;
      else sel.value = '';
    }

    function fillAllLists(){
      fillSelect(document.getElementById('f_location'), APP_LISTS.branches, '➕ إضافة مكان جديد');
      fillSelect(document.getElementById('tr_to'), APP_LISTS.branches, '➕ إضافة مكان جديد');
      fillSelect(document.getElementById('req_to'), APP_LISTS.branches, '➕ إضافة مكان جديد');

      fillSelect(document.getElementById('f_status'), APP_LISTS.statuses, '➕ إضافة حالة جديدة');
      fillSelect(document.getElementById('tr_status'), APP_LISTS.statuses, '➕ إضافة حالة جديدة');
      // سجل الحركات: فلتر (من)
      fillLogsLocations();
    }

    async function addItemToList(kind, value){
      value = (value||'').trim();
      if(!value) return;
      const ref = db.collection(META_LISTS_PATH.col).doc(META_LISTS_PATH.doc);
      const snap = await ref.get();
      const d = snap.data() || {};
      const arr = (kind==='branches') ? (d.branches||[]) : (d.statuses||[]);
      if(arr.includes(value)) return;
      arr.push(value);
      const payload = { updatedAt: firebase.firestore.FieldValue.serverTimestamp(), updatedBy: auth.currentUser?.email || '' };
      payload[kind] = arr;
      await ref.set(payload, {merge:true});
      await logAction('admin','list_add',{kind, value});
      await loadMetaLists();
    }

    async function handleSelectAdd(e){
      const sel = e.target;
      if(!sel || sel.value!=='__add__') return;
      sel.value='';
      const isBranch = (sel.id==='f_location' || sel.id==='tr_to' || sel.id==='req_to');
      const kind = isBranch ? 'branches' : 'statuses';
      const label = isBranch ? 'اكتب اسم المكان الجديد' : 'اكتب اسم الحالة الجديدة';
      const v = prompt(label);
      if(v) await addItemToList(kind, v);
    }

    function bindListsEvents(){
      ['f_location','tr_to','req_to','f_status','tr_status'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.addEventListener('change', handleSelectAdd);
      });
    }

    function uiStatusNotesToggle(){
      const st = document.getElementById('f_status')?.value || '';
      const box = document.getElementById('f_carNotes_box');
      if(!box) return;
      if(st==='بها ملاحظات') box.classList.remove('hidden');
      else { box.classList.add('hidden'); document.getElementById('f_carNotes').value=''; }
    }

    function uiTransferNoteToggle(){
      const st = document.getElementById('tr_status')?.value || '';
      const box = document.getElementById('tr_note_box');
      if(!box) return;
      if(st==='بها ملاحظات') box.classList.remove('hidden');
      else { box.classList.add('hidden'); document.getElementById('tr_note').value=''; }
    }

    function uiReqTypeChanged(){
      const t = document.getElementById('req_type')?.value || 'transfer';
      const label = document.getElementById('req_loc_label');
      if(label) label.textContent = (t==='photo') ? 'مكان التصوير' : 'مكان النقل';
      const box = document.getElementById('req_photo_date_box');
      if(box){
        if(t==='photo') box.classList.remove('hidden');
        else box.classList.add('hidden');
      }
    }

    function uiReqNoteToggle(){
      const st = document.getElementById('req_status')?.value || '';
      // ملاحظة الطلب لكل VIN موجودة في الجدول؛ لا نضيف صندوق هنا.
    }

    // --- أماكن سجل الحركات (تعتمد على الفروع) ---
    function fillLogsLocations(){
      const selFrom = document.getElementById('lg_from_loc');
      const selTo = document.getElementById('lg_to_loc');
      if(!selFrom && !selTo) return;
      if(selFrom) selFrom.innerHTML='';
      if(selTo) selTo.innerHTML='';
      (APP_LISTS.branches||[]).forEach(l=>{
        if(selFrom) selFrom.appendChild(makeOption(l,l));
        if(selTo) selTo.appendChild(makeOption(l,l));
      });
    }
    function uiLogsFilterChanged(){
      const mode = document.getElementById('lg_filter')?.value || 'all';
      const searchBox = document.getElementById('lg_search_box');
      const fromBox = document.getElementById('lg_from_box');
      const toBox = document.getElementById('lg_to_box');
      if(!searchBox || !fromBox || !toBox) return;

      if(mode==='from'){
        // عند اختيار (من): نعرض اختيار (من) + اختيار (إلى) معًا
        fromBox.classList.remove('hidden');
        toBox.classList.remove('hidden');
        searchBox.classList.add('hidden');
      }else if(mode==='to'){
        toBox.classList.remove('hidden');
        fromBox.classList.add('hidden');
        searchBox.classList.add('hidden');
      }else if(mode==='all'){
        fromBox.classList.add('hidden');
        toBox.classList.add('hidden');
        searchBox.classList.add('hidden');
      }else{
        fromBox.classList.add('hidden');
        toBox.classList.add('hidden');
        searchBox.classList.remove('hidden');
        document.getElementById('lg_search').placeholder = (mode==='vin') ? 'اكتب رقم الهيكل' : 'اكتب اسم السيارة';
      }
    }

    async function loadLogs(){
      const user = auth.currentUser;
      if(!user) return toast('سجّل دخول أولاً');

      const fromStr = document.getElementById('lg_from')?.value || '';
      const toStr = document.getElementById('lg_to')?.value || '';
      const mode = document.getElementById('lg_filter')?.value || 'all';
      const qSearch = (document.getElementById('lg_search')?.value || '').trim();

      const fromLoc = document.getElementById('lg_from_loc')?.value || '';
      const toLoc = document.getElementById('lg_to_loc')?.value || '';

      // افتراضي: آخر 7 أيام لو ما اختار تاريخ
      const now = new Date();
      const fromDate = fromStr ? new Date(fromStr+'T00:00:00') : new Date(now.getTime()-7*24*60*60*1000);
      const toDate = toStr ? new Date(toStr+'T23:59:59') : now;

      let q = db.collection('logs')
        .where('at','>=', firebase.firestore.Timestamp.fromDate(fromDate))
        .where('at','<=', firebase.firestore.Timestamp.fromDate(toDate))
        .orderBy('at','desc')
        .limit(500);

      // ⚠️ لتفادي طلب Index مركب: نجلب آخر الحركات حسب التاريخ فقط، ثم نفلتر محليًا.
      const snap = await q.get();
      let logs = [];
      snap.forEach(d=>logs.push({id:d.id, ...(d.data()||{})}));

      // فلترة محلية حسب وضع الفلتر
      if(mode==='vin' && qSearch){
        logs = logs.filter(l=> (l.vin||'').toString().trim() === qSearch);
      }
      if(mode==='from'){
        // عند اختيار (من): ممكن تختار من + إلى معًا
        if(fromLoc) logs = logs.filter(l=> (l.fromLocation||'') === fromLoc);
        if(toLoc)   logs = logs.filter(l=> (l.toLocation||'') === toLoc);
      }
      if(mode==='to'){
        if(toLoc) logs = logs.filter(l=> (l.toLocation||'') === toLoc);
      }
      if(mode==='car' && qSearch){
        const ss = qSearch.toLowerCase();
        logs = logs.filter(l=> (l.carName||'').toLowerCase().includes(ss));
      }

      // اجلب بيانات السيارات (Join) لإظهار التشيك + الموافقات + المكان الحالي + اللون الداخلي
      const vins = Array.from(new Set(logs.map(l=>l.vin).filter(Boolean))).slice(0,300);
      const carMap = {};
      await Promise.all(vins.map(async (vin)=>{
        try{
          const cs = await db.collection('cars').doc(vin).get();
          if(cs.exists) carMap[vin] = cs.data()||{};
        }catch(e){}
      }));

      const tb = document.querySelector('#lg_table tbody');
      tb.innerHTML = '';
      let shown=0;

      logs.forEach(l=>{
        const car = carMap[l.vin] || {};
        const c = car.checklist || {};
        const a = car.approvals || {};
        const dt = l.at && l.at.toDate ? l.at.toDate() : null;
        const time = dt ? dt.toLocaleString('ar-SA') : '';

        const row = [
          time,
          l.vin||'',
          l.carName || car.carName || '',
          l.fromLocation||'',
          l.toLocation||'',
          car.location || '',
          car.interiorColor || '',
          boolTag( (c.sensors===true) || (c.sensor===true) ),
          boolTag( c.camera===true ),
          boolTag( c.ac===true ),
          boolTag( (c.musajjal===true) || (c.recorder===true) ),
          boolTag( c.screen===true ),
          boolTag( c.remote===true ),
          boolTag( c.farshat===true ),
          boolTag( c.tafaia===true ),
          boolTag( c.shanta===true ),
          boolTag( c.spare===true ),
          boolTag( a.financial===true ),
          boolTag( a.admin===true ),
          l.by||''
        ];

        const tr = document.createElement('tr');
        row.forEach(val=>{
          const td = document.createElement('td');
          td.textContent = val;
          tr.appendChild(td);
        });
        tb.appendChild(tr);
        shown++;
      });

      const meta = document.getElementById('lg_meta');
      if(meta) meta.textContent = `المعروض: ${shown} (الحد الأقصى 300)`;
      window.__lastLogsExport = logs.map(l=>{
        const car = carMap[l.vin] || {};
        const c = car.checklist || {};
        const a = car.approvals || {};
        const dt = l.at && l.at.toDate ? l.at.toDate() : null;
        return {
          التاريخ: dt ? dt.toLocaleString('ar-SA') : '',
          'رقم الهيكل': l.vin||'',
          السيارة: l.carName || car.carName || '',
          من: l.fromLocation||'',
          إلى: l.toLocation||'',
          'المكان الحالي (المخزون)': car.location || '',
          'اللون الداخلي': car.interiorColor || '',
          حساس: (c.sensors===true)||(c.sensor===true) ? '✓' : '✗',
          كاميرا: c.camera===true ? '✓':'✗',
          مكيف: c.ac===true ? '✓':'✗',
          مسجل: (c.musajjal===true)||(c.recorder===true) ? '✓':'✗',
          شاشة: c.screen===true ? '✓':'✗',
          ريموت: c.remote===true ? '✓':'✗',
          فرشات: c.farshat===true ? '✓':'✗',
          طفاية: c.tafaia===true ? '✓':'✗',
          'شنطة سلامة': c.shanta===true ? '✓':'✗',
          اسبير: c.spare===true ? '✓':'✗',
          'الموافقة المالية': a.financial===true ? '✓':'✗',
          'الموافقة الادارية': a.admin===true ? '✓':'✗',
          'منفذ الحركة': l.by||''
        };
      });
    }

    function exportLogsExcel(){
      const rows = window.__lastLogsExport || [];
      if(!rows.length) return toast('لا يوجد بيانات للتصدير');
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'logs');
      downloadWorkbook(wb, 'logs_export.xlsx');
    }

    
    // ===== Requests Tab =====
    let reqUnsub = null;

    function stopRequestsLive(){
      if(reqUnsub){ reqUnsub(); reqUnsub=null; }
    }

    function fmtDate(ts){
      try{
        const d = ts && ts.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
        return d ? d.toLocaleString('ar-SA') : '';
      }catch(_){ return ''; }
    }

    function reqTypeLabel(t){
      return t==='photo' ? 'تصوير' : 'نقل';
    }

    

    function buildReqBody(r, carMap){
      const items = r.items || [];
      const statusTxt = reqStatusLabel(r);
      const meta = `
        <div class="small">
          <div><b>نوع الطلب:</b> ${reqTypeLabel(r.type)}</div>
          <div><b>المكان المستهدف:</b> ${r.toLocation||''}</div>
          <div><b>الحالة:</b> ${statusTxt}</div>
          ${r.type==='photo' ? `<div><b>تاريخ التصوير:</b> ${r.photoDate||''}</div>` : ``}
          <div><b>تاريخ الطلب:</b> ${fmtDate(r.createdAt)}</div>
          <div><b>المنشئ:</b> ${r.createdBy||''}</div>
        </div>`;

      const rows = items.map(it=>{
        const c = (carMap && carMap[it.vin]) ? carMap[it.vin] : {};
        return `
          <tr>
            <td>${escapeHtml(it.vin||'')}</td>
            <td>${escapeHtml(c.carName||'')}</td>
            <td>${escapeHtml(c.statement||'')}</td>
            <td>${escapeHtml(c.exteriorColor||'')}</td>
            <td>${escapeHtml(c.interiorColor||'')}</td>
            <td>${escapeHtml(c.model||'')}</td>
            <td>${escapeHtml(c.location||'')}</td>
            <td>${escapeHtml(it.note||'')}</td>
          </tr>`;
      }).join('');

      const carsTable = `
        <div style="margin-top:12px">
          <div style="font-weight:900;color:var(--brown);margin-bottom:8px">تفاصيل الطلب</div>
          <div class="tableWrap" style="max-height:320px">
            <table>
              <thead>
                <tr>
                  <th>رقم الهيكل</th>
                  <th>السيارة</th>
                  <th>الفئة</th>
                  <th>الخارجي</th>
                  <th>الداخلي</th>
                  <th>الموديل</th>
                  <th>المكان الحالي</th>
                  <th>ملاحظات</th>
                </tr>
              </thead>
              <tbody>${rows || ''}</tbody>
            </table>
          </div>
        </div>`;

      const steps = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
          <div class="checkItem" style="background:#fff"><span>تم استلام الطلب</span><div>${r.step1At ? '<span class="tag ok">✓</span>' : '<span class="tag no">✗</span>'}</div></div>
          <div class="checkItem" style="background:#fff"><span>تم ارسال السيارة</span><div>${r.step2At ? '<span class="tag ok">✓</span>' : '<span class="tag no">✗</span>'}</div></div>
          <div class="checkItem" style="background:#fff"><span>تم استلام السيارة</span><div>${r.step3At ? '<span class="tag ok">✓</span>' : '<span class="tag no">✗</span>'}</div></div>
          <div class="checkItem" style="background:#fff"><span>تم الانتهاء</span><div>${r.step4At ? '<span class="tag ok">✓</span>' : '<span class="tag no">✗</span>'}</div></div>
        </div>`;

      return meta + carsTable + steps;
    }

function reqStatusLabel(r){
      const s1 = !!r.step1At;
      const s2 = !!r.step2At;
      const s3 = !!r.step3At;
      const s4 = !!r.step4At;
      if(s4) return 'تم الانتهاء';
      if(s3) return 'تم استلام السيارة';
      if(s2) return 'تم ارسال السيارة';
      if(s1) return 'تم استلام الطلب';
      return 'جديد';
    }

    function canDeleteReq(r){
      // مسموح بالحذف إذا: لا توجد خطوات (أو فقط step1At)
      return !r.step2At && !r.step3At && !r.step4At;
    }

    // ----- Create Request VIN table -----
    function clearReqRows(){
      const tb = document.querySelector('#req_vinTable tbody');
      if(!tb) return;
      tb.innerHTML = '';
      addReqRow();
    }

    async function fillReqRowFromVin(tr, vin){
      const c = {
        car: tr.querySelector('[data-cell=car]'),
        cat: tr.querySelector('[data-cell=cat]'),
        ext: tr.querySelector('[data-cell=ext]'),
        int: tr.querySelector('[data-cell=int]'),
        model: tr.querySelector('[data-cell=model]'),
        loc: tr.querySelector('[data-cell=loc]'),
      };
      if(!vin){
        Object.values(c).forEach(el=>el.textContent='');
        tr.dataset.vin='';
        tr.dataset.missing='0';
        return;
      }
      tr.style.opacity = '.65';
      try{
        const snap = await db.collection('cars').doc(vin).get();
        if(!snap.exists){
          c.car.textContent = 'غير موجود';
          c.cat.textContent = '—';
          c.ext.textContent = '—';
          c.int.textContent = '—';
          c.model.textContent = '—';
          c.loc.textContent = '—';
          tr.dataset.vin = vin;
          tr.dataset.missing = '1';
        }else{
          const d = snap.data()||{};
          c.car.textContent = d.carName || '';
          c.cat.textContent = d.statement || '';
          c.ext.textContent = d.exteriorColor || '';
          c.int.textContent = d.interiorColor || '';
          c.model.textContent = d.model || '';
          c.loc.textContent = d.location || '';
          tr.dataset.vin = d.vin || vin;
          tr.dataset.missing = '0';
        }
      }finally{
        tr.style.opacity = '1';
      }
    }

    function addReqRow(vin=''){
      const tb = document.querySelector('#req_vinTable tbody');
      if(!tb) return;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input data-req-vin placeholder="اكتب VIN" value="${(vin||'').replace(/"/g,'&quot;')}" style="min-width:210px" /></td>
        <td data-cell="car"></td>
        <td data-cell="cat"></td>
        <td data-cell="ext"></td>
        <td data-cell="int"></td>
        <td data-cell="model"></td>
        <td data-cell="loc"></td>
        <td><input data-req-note placeholder="ملاحظة (اختياري)" /></td>
        <td><button class="btn danger" type="button" data-del-req style="padding:7px 10px;border-radius:10px">حذف</button></td>
      `;
      tb.appendChild(tr);

      const inp = tr.querySelector('input[data-req-vin]');
      let t=null;
      inp.addEventListener('input', ()=>{
        const v = inp.value.trim();
        if(t) clearTimeout(t);
        t = setTimeout(()=>fillReqRowFromVin(tr, v), 250);
      });
      inp.addEventListener('blur', ()=>fillReqRowFromVin(tr, inp.value.trim()));

      tr.querySelector('[data-del-req]').addEventListener('click', ()=>tr.remove());

      if(vin) fillReqRowFromVin(tr, vin);
    }

    function getReqItems(){
      const tb = document.querySelector('#req_vinTable tbody');
      if(!tb) return [];
      const items = [];
      tb.querySelectorAll('tr').forEach(tr=>{
        const vin = (tr.querySelector('input[data-req-vin]')?.value || '').trim();
        const note = (tr.querySelector('input[data-req-note]')?.value || '').trim();
        if(vin) items.push({ vin, note });
      });
      // remove duplicates by VIN (keep first)
      const seen = new Set();
      return items.filter(it=>{
        if(seen.has(it.vin)) return false;
        seen.add(it.vin);
        return true;
      });
    }

    function statusFromLocation(loc){
      if(!loc) return '';
      if(loc.includes('المخزون المتاح')) return 'المخزون المتاح';
      if(loc.includes('سيارات بها ملاحظات')) return 'بها ملاحظات';
      if(loc.includes('مباع تحت التسليم')) return 'مباع تحت التسليم';
      if(loc.includes('مباع تم التسليم')) return 'مباع تم التسليم';
      return '';
    }

    async function submitRequest(){
      const user = auth.currentUser;
      if(!user) return toast('سجّل دخول أولاً');

      const mode = $('req_mode')?.value || 'create';
      if(mode!=='create') return;

      const type = $('req_type').value;
      const toLocation = $('req_to').value;
      if(!toLocation) return toast('اختر المكان');

      const photoDate = $('req_photo_date').value;
      if(type==='photo' && !photoDate) return toast('اختر تاريخ التصوير');

      const items = getReqItems();
      if(items.length===0) return toast('اكتب VIN واحد على الأقل');

      // تحقق وجود السيارات
      const missing = [];
      for(const it of items){
        const snap = await db.collection('cars').doc(it.vin).get();
        if(!snap.exists) missing.push(it.vin);
      }
      if(missing.length){
        return toast('في هياكل غير موجودة: ' + missing.slice(0,5).join(', ') + (missing.length>5?'...':''));
      }

      const req = {
        type, // transfer | photo
        items,
        vins: items.map(x=>x.vin),
        toLocation,
        photoDate: type==='photo' ? photoDate : null,

        createdBy: user.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        step1At: null, step2At: null, step3At: null, step4At: null,
        step1By: null, step2By: null, step3By: null, step4By: null,
      };

      const ref = await db.collection('requests').add(req);

      // حفظ ملاحظة كل VIN داخل المخزون في (ملاحظات تحديد المكان)
      try{
        const batch = db.batch();
        let has = false;
        (items||[]).forEach(it=>{
          const note = (it.note||'').trim();
          if(!note) return;
          const carRef = db.collection('cars').doc(it.vin);
          batch.set(carRef, {
            noteLocation: note,
            notesLocation: note,
            noteLocationUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            noteLocationUpdatedBy: user.email
          }, { merge:true });
          has = true;
        });
        if(has) await batch.commit();
      }catch(e){
        console.warn('req->cars noteLocation update failed', e);
      }

      toast('تم إرسال الطلب');
      logAction('requests','request_create',{requestId: ref.id, type:type, toLocation:toLocation, vins: (items||[]).map(x=>x.vin)});
      // reset
      clearReqRows();
      $('req_to').value = '';
if(type==='photo'){ $('req_photo_date').value=''; }
      // انتقل لمتابعة الطلبات
      $('req_mode').value='track';
      switchReqMode();
      // افتح مباشرة
      openReqModal({ id: ref.id, ...req });
    }

    // ----- Requests lists -----
    function renderReqList(rows, tableSel, metaEl, onlyDone){
      const tb = document.querySelector(tableSel+' tbody');
      tb.innerHTML = '';
      let c=0;
      rows.forEach(r=>{
        const done = !!r.step4At;
        if(onlyDone && !done) return;
        if(!onlyDone && done) return;

        const tr = document.createElement('tr');
        const created = fmtDate(r.createdAt);
        const status = reqStatusLabel(r);
        const cells = onlyDone
          ? [
              created,
              reqTypeLabel(r.type),
              (r.vins||[]).length,
              r.toLocation || '',
              fmtDate(r.step4At),
              '__OPEN__'
            ]
          : [
              created,
              reqTypeLabel(r.type),
              (r.vins||[]).length,
              r.toLocation || '',
              '__OPEN__'
            ];
        cells.forEach((t,idx)=>{
          const td = document.createElement('td');
          if(t==='__OPEN__'){
            const b = document.createElement('button');
            b.className='linkBtn';
            b.textContent='فتح';
            b.type='button';
            b.addEventListener('click', ()=>openReqModal(r));
            td.appendChild(b);
          }else{
            td.textContent = t;
          }
          tr.appendChild(td);
        });
        tb.appendChild(tr);
        c++;
      });
      metaEl.textContent = `الطلبات: ${c}`;
    }

    function startRequestsLive(){
      stopRequestsLive();
      reqUnsub = db.collection('requests').orderBy('createdAt','desc').limit(200).onSnapshot((snap)=>{
        const all = [];
        snap.forEach(d=>all.push({ id:d.id, ...(d.data()||{}) }));
        renderReqList(all, '#req_table_open', $('req_open_meta'), false);
        renderReqList(all, '#req_table_done', $('req_done_meta'), true);
      }, (err)=>toast(err.message||'فشل تحميل الطلبات'));
    }

    // ----- Request modal actions -----
    const reqModal = document.getElementById('reqModal');
    const reqModalBody = document.getElementById('reqModalBody');
    const reqModalFoot = document.getElementById('reqModalFoot');
    const reqModalTitle = document.getElementById('reqModalTitle');

    function closeReqModal(){
      reqModal.classList.remove('show');
      reqModalBody.innerHTML='';
      reqModalFoot.innerHTML='';
      reqModal.dataset.id='';
    }

    document.getElementById('reqClose')?.addEventListener('click', closeReqModal);
    reqModal?.addEventListener('click', (e)=>{ if(e.target===reqModal) closeReqModal(); });

    async function markStep(reqId, step){
      const user = auth.currentUser;
      if(!user) return toast('سجّل دخول أولاً');
      const ref = db.collection('requests').doc(reqId);
      const snap = await ref.get();
      if(!snap.exists) return toast('الطلب غير موجود');
      const r = snap.data()||{};

      const updates = {};
      const now = firebase.firestore.FieldValue.serverTimestamp();

      if(step===1){ updates.step1At = now; updates.step1By = user.email; }
      if(step===2){ updates.step2At = now; updates.step2By = user.email; }
      if(step===3){ updates.step3At = now; updates.step3By = user.email; }
      if(step===4){ updates.step4At = now; updates.step4By = user.email; }

      // منع ترتيب خاطئ بسيط
      if(step>1 && !r.step1At) return toast('لازم تم استلام الطلب أولاً');
      if(step>2 && !r.step2At) return toast('لازم تم ارسال السيارة أولاً');
      if(step>3 && !r.step3At) return toast('لازم تم استلام السيارة أولاً');

      await ref.set(updates, {merge:true});
      logAction('requests','request_step',{requestId:reqId, step:step, type:r.type||'', toLocation:r.toLocation||'', vins:(r.vins||[])});

      // لو خطوة (تم استلام السيارة) و نوع نقل: حدّث مكان السيارات
      if(step===3 && r.type==='transfer'){
        const batch = db.batch();
        const toLoc = r.toLocation || '';
        const st = statusFromLocation(toLoc);
        const items = r.items || [];
        items.forEach(it=>{
          const carRef = db.collection('cars').doc(it.vin);
          const upd = { location: toLoc, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
          if(st) upd.status = st;
          batch.set(carRef, upd, {merge:true});

          const logRef = db.collection('logs').doc();
          batch.set(logRef, {
            action: 'request_transfer_receive_car',
            requestId: reqId,
            vin: it.vin,
            toLocation: toLoc,
            by: user.email,
            at: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        await batch.commit();
      }

      toast('تم تحديث الطلب');
      // refresh modal
      const snap2 = await ref.get();
      openReqModal({ id:reqId, ...(snap2.data()||{}) }, true);
    }

    async function deleteRequest(reqId){
      const user = auth.currentUser;
      if(!user) return toast('سجّل دخول أولاً');
      const ref = db.collection('requests').doc(reqId);
      const snap = await ref.get();
      if(!snap.exists) return toast('الطلب غير موجود');
      const r = snap.data()||{};
      if(!canDeleteReq(r)) return toast('ممنوع حذف الطلب بعد تنفيذ إجراءات');
      await ref.delete();
      toast('تم حذف الطلب');
      logAction('requests','request_delete',{requestId:reqId, type:r.type||'', toLocation:r.toLocation||'', vins:(r.vins||[])});
      closeReqModal();
    }
    async function openReqModal(r, keepOpen=false){
      if(!r || !r.id){
        toast('لا يمكن فتح الطلب');
        return;
      }
      reqModal.dataset.id = r.id;
      reqModalTitle.textContent = `تفاصيل الطلب — ${reqTypeLabel(r.type)} (${(r.vins||[]).length})`;
      
      const carMap = {};
      const its = r.items || [];
      await Promise.all(its.map(async (it)=>{
        try{
          const cs = await db.collection('cars').doc(it.vin).get();
          if(cs.exists) carMap[it.vin] = cs.data() || {};
        }catch(e){}
      }));
      reqModalBody.innerHTML = buildReqBody(r, carMap);
    

      const id = r.id;
      reqModalFoot.innerHTML = '';

      const mkBtn = (label, cls, fn, disabled=false)=>{
        const b = document.createElement('button');
        b.className = 'btn ' + cls;
        b.type = 'button';
        b.textContent = label;
        b.disabled = !!disabled;
        b.addEventListener('click', fn);
        return b;
      };

      // أزرار الخطوات
      reqModalFoot.appendChild(mkBtn('تم استلام الطلب', 'secondary', ()=>markStep(id,1), !!r.step1At));
      reqModalFoot.appendChild(mkBtn('تم ارسال السيارة', 'secondary', ()=>markStep(id,2), !r.step1At || !!r.step2At));
      reqModalFoot.appendChild(mkBtn('تم استلام السيارة', 'secondary', ()=>markStep(id,3), !r.step2At || !!r.step3At));
      reqModalFoot.appendChild(mkBtn('تم الانتهاء', 'primary', ()=>markStep(id,4), !r.step3At || !!r.step4At));

      // حذف
      reqModalFoot.appendChild(mkBtn('حذف الطلب', 'danger', ()=>deleteRequest(id), !canDeleteReq(r)));

      reqModal.classList.add('show');
    }

    // ----- Requests UI mode switch -----
    function switchReqMode(){
      const v = $('req_mode').value;
      $('req_create_box').classList.toggle('hidden', v!=='create');
      $('req_track_box').classList.toggle('hidden', v!=='track');
      $('req_done_box').classList.toggle('hidden', v!=='done');

      if(v==='track' || v==='done') startRequestsLive();
      else stopRequestsLive();
    }

    if($('req_mode')) $('req_mode').addEventListener('change', switchReqMode);

    if($('req_type')){
      $('req_type').addEventListener('change', ()=>{
        const t = $('req_type').value;
        $('req_photo_date_box').classList.toggle('hidden', t!=='photo');
        $('req_loc_label').textContent = (t==='photo') ? 'مكان التصوير' : 'مكان النقل';
        if(t!=='photo') $('req_photo_date').value='';
      });
    }

    if($('req_addRow')) $('req_addRow').addEventListener('click', ()=>addReqRow());
    if($('req_clearRows')) $('req_clearRows').addEventListener('click', clearReqRows);
    if($('req_submit')) $('req_submit').addEventListener('click', ()=>submitRequest().catch(e=>toast(e.message||'فشل إرسال الطلب')));

    // init request rows
    if(document.querySelector('#req_vinTable tbody') && document.querySelector('#req_vinTable tbody').children.length===0){
      clearReqRows();
    }
    if($('req_create_hint')){
      $('req_create_hint').innerHTML = 'تنبيه: <b>النقل</b> يغيّر مكان السيارة في المخزون عند زر <b>تم استلام السيارة</b>.';
    }

    
    /****************************************************
     * كل السيارات (تجميع + تصدير)
     ****************************************************/
    let _allCarsUnsub = null;
    let _allCarsRows = [];

    function startAllCarsLive(){
      stopAllCarsLive();
      const tbody = document.querySelector('#allCarsTable tbody');
      const meta  = document.getElementById('allCarsMeta');
      if(!tbody) return;

      meta.textContent = 'جاري التحميل...';
      _allCarsUnsub = db.collection('cars').onSnapshot((snap)=>{
        const map = new Map();
        snap.forEach(doc=>{
          const d = doc.data() || {};
          const carName = (d.carName || d['سيارة'] || '').toString().trim();
          const statement = (d.statement || d['البيان'] || '').toString().trim();
          const model = (d.model || d['موديل'] || '').toString().trim();

          const key = [carName, statement, model].join('||');
          if(!map.has(key)){
            map.set(key, {carName, statement, model, count:0});
          }
          map.get(key).count += 1;
        });

        _allCarsRows = Array.from(map.values())
          .sort((a,b)=>{
            // sort by car then model then statement
            return (a.carName||'').localeCompare(b.carName||'') ||
                   (a.model||'').localeCompare(b.model||'') ||
                   (a.statement||'').localeCompare(b.statement||'');
          });

        // render
        tbody.innerHTML = '';
        _allCarsRows.forEach((r,i)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${escapeHtml(r.carName||'—')}</td>
            <td>${escapeHtml(r.statement||'—')}</td>
            <td>${escapeHtml(r.model||'—')}</td>
            <td style="font-weight:700">${r.count}</td>
          `;
          tbody.appendChild(tr);
        });

        meta.textContent = `إجمالي السجلات في المخزون: ${snap.size} | إجمالي الصفوف بعد التجميع: ${_allCarsRows.length}`;
      }, (err)=>{
        meta.textContent = 'تعذر تحميل البيانات. راجع الصلاحيات.';
        console.error(err);
      });
    }

    function stopAllCarsLive(){
      if(_allCarsUnsub){ _allCarsUnsub(); _allCarsUnsub = null; }
    }

    function exportAllCars(){
      const data = _allCarsRows.map((r,i)=>({
        '#': i+1,
        'السيارة': r.carName || '',
        'البيان': r.statement || '',
        'الموديل': r.model || '',
        'إجمالي العدد': r.count || 0
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'كل السيارات');
      XLSX.writeFile(wb, 'كل_السيارات.xlsx');
    }

    const btnExportAllCars = document.getElementById('btnExportAllCars');
    if(btnExportAllCars){
      btnExportAllCars.addEventListener('click', exportAllCars);
    }


    // Hook into main tabs: when opening requests tab ensure mode is applied
    const __openViewBase = openView;
    openView = function(viewId){
      __openViewBase(viewId);
      if(viewId==='view-requests'){
        switchReqMode();
      }else{
        stopRequestsLive();
      }

      if(viewId==='view-allcars'){
        startAllCarsLive();
      }else{
        stopAllCarsLive();
      }
    };

    // ===== Logs Tab bindings =====
    fillLogsLocations();
    document.getElementById('lg_filter')?.addEventListener('change', uiLogsFilterChanged);
    document.getElementById('lg_apply')?.addEventListener('click', ()=>loadLogs().catch(e=>toast(e.message||'فشل تحميل السجل')));
    document.getElementById('lg_export')?.addEventListener('click', exportLogsExcel);
    uiLogsFilterChanged();


    // ===== Users Admin (Firestore users collection) =====
    let usersUnsub = null;
    let uaCache = [];
    let uaSelected = null;

    const UA_TABS = [
      { key: 'dashboard', label: 'الداش بورد' },
      { key: 'admin', label: 'الإدارة' },
      { key: 'inventory', label: 'المخزون' },
      { key: 'car_transfer', label: 'نقل السيارات' },
      { key: 'requests', label: 'الطلبات' },
      { key: 'all_cars', label: 'كل السيارات' },
      { key: 'movement_log', label: 'سجل الحركات' },
      { key: 'tracking', label: 'التراكينج' },
      { key: 'archive', label: 'الأرشيف' },
      { key: 'users_admin', label: 'إدارة المستخدمين' },
    ];

    // قالب الصلاحيات المعتمد (بنفس هيكل الرسالة)
    const UA_TEMPLATE = {
      name: '',
      email: '',
      active: true,
      tabs: {
        dashboard: true,
        admin: false,
        inventory: false,
        car_transfer: false,
        requests: false,
        all_cars: false,
        movement_log: false,
        tracking: false,
        archive: false,
        users_admin: false
      },
      permissions: {
        dashboard: { buttons: { save: false, clear: false } },
        inventory: { buttons: { add_car: false, clear_list: false, delete: false, execute_transfer_request: false } },
        car_transfer: {
          fields: { vin_input: false, target_location_select: false, status_select: false },
          buttons: { send_transfer: false, clear_list: false, delete: false }
        },
        requests: {
          dropdowns: { choose_section: false },
          sections: { create_request: false, follow_requests: false, completed_requests: false },
          fields: { request_type_select: false, vin_input: false, transfer_location_select: false },
          buttons: { add_vin: false, clear_list: false, delete: false, send_request: false },
          workflow_actions: { receive_order: false, send_car: false, receive_car: false, finish_order: false }
        },
        all_cars: { view: true },
        movement_log: { view: true },
        tracking: { view: true },
        archive: { view: true },
        users_admin: { view_users: false, edit_permissions: false, create_user_record: false, disable_user: false }
      }
    };

    // JS doesn't have true/false literals in object above when written as string.

    function uaCloneTemplate(){
      // deep clone
      return JSON.parse(JSON.stringify(UA_TEMPLATE));
    }

    function uaTs(v){
      try{
        if(!v) return '';
        if(typeof v.toDate === 'function') return v.toDate().toLocaleString('ar-SA');
        if(typeof v === 'number') return new Date(v).toLocaleString('ar-SA');
        return '';
      }catch(e){ return ''; }
    }

    function uaNormalizeUser(docId, d){
      const base = uaCloneTemplate();
      // merge shallow
      base.name = (d && d.name) ? d.name : '';
      base.email = (d && d.email) ? d.email : '';
      base.active = (d && typeof d.active === 'boolean') ? d.active : true;
      base.tabs = Object.assign({}, base.tabs, (d && d.tabs) ? d.tabs : {});
      base.permissions = Object.assign({}, base.permissions, (d && d.permissions) ? d.permissions : {});
      return {
        id: docId,
        uid: d && (d.uid || d.UID) ? (d.uid || d.UID) : docId,
        createdAt: d && d.createdAt ? d.createdAt : null,
        updatedAt: d && d.updatedAt ? d.updatedAt : null,
        updatedBy: d && d.updatedBy ? d.updatedBy : '',
        data: base
      };
    }

    function uaMatch(u, q){
      if(!q) return true;
      const bag = [u.data?.name, u.data?.email, u.uid, u.id].map(v=>String(v||'').toLowerCase()).join(' | ');
      return bag.includes(q);
    }

    function uaFilterList(){
      const q = (document.getElementById('ua_search')?.value || '').trim().toLowerCase();
      const af = document.getElementById('ua_active_filter')?.value || 'all';
      return uaCache.filter(u=>{
        if(af==='active' && !u.data.active) return false;
        if(af==='inactive' && u.data.active) return false;
        return uaMatch(u, q);
      });
    }

    function uaRenderList(){
      const tb = document.getElementById('ua_tbody');
      if(!tb) return;
      const list = uaFilterList();
      if(!list.length){
        tb.innerHTML = '<tr><td colspan="6" class="small muted">لا يوجد مستخدمون</td></tr>';
        return;
      }
      tb.innerHTML = list.map(u=>{
        const name = escapeHtml(u.data.name||'—');
        const email = escapeHtml(u.data.email||'—');
        const uid = escapeHtml(u.uid||u.id||'—');
        const st = u.data.active ? '<span class="tag ok">نشط</span>' : '<span class="tag no">غير نشط</span>';
        const upd = escapeHtml(uaTs(u.updatedAt||u.createdAt));
        return `<tr>
          <td>${name}</td>
          <td>${email}</td>
          <td dir="ltr">${uid}</td>
          <td>${st}</td>
          <td>${upd}</td>
          <td><button class="btn secondary" data-ua-edit="${escapeHtml(u.id)}">تعديل</button></td>
        </tr>`;
      }).join('');

      tb.querySelectorAll('[data-ua-edit]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-ua-edit');
          const u = uaCache.find(x=>x.id===id);
          if(u) uaOpenEditor(u);
        });
      });
    }

    function uaTabItem(key, label, checked){
      return `<label class="checkItem">
        <span>${escapeHtml(label)}</span>
        <input type="checkbox" data-ua-tab="${escapeHtml(key)}" ${checked?'checked':''} />
      </label>`;
    }

    function uaPermBlock(title, html){
      return `<div class="card" style="box-shadow:none;border:1px solid var(--line);margin-bottom:10px">
        <h3 style="border:none;padding:12px 12px 0 12px;font-size:14px">${escapeHtml(title)}</h3>
        <div class="body" style="padding:12px">${html}</div>
      </div>`;
    }

    function uaRenderPerms(perms){
      // perms is UA_TEMPLATE.permissions-like
      const blocks = [];

      // dashboard buttons
      blocks.push(uaPermBlock('Dashboard', [
        uaBoolField('dashboard.buttons.save','حفظ (save)', !!perms.dashboard?.buttons?.save),
        uaBoolField('dashboard.buttons.clear','مسح (clear)', !!perms.dashboard?.buttons?.clear)
      ].join('')));

      // inventory buttons
      blocks.push(uaPermBlock('Inventory', [
        uaBoolField('inventory.buttons.add_car','إضافة سيارة', !!perms.inventory?.buttons?.add_car),
        uaBoolField('inventory.buttons.clear_list','مسح القائمة', !!perms.inventory?.buttons?.clear_list),
        uaBoolField('inventory.buttons.delete','حذف', !!perms.inventory?.buttons?.delete),
        uaBoolField('inventory.buttons.execute_transfer_request','تنفيذ طلب نقل', !!perms.inventory?.buttons?.execute_transfer_request)
      ].join('')));

      // car_transfer fields + buttons
      blocks.push(uaPermBlock('Car Transfer', [
        '<div class="small" style="margin-bottom:6px"><b>الحقول</b></div>',
        uaBoolField('car_transfer.fields.vin_input','إدخال رقم الهيكل', !!perms.car_transfer?.fields?.vin_input),
        uaBoolField('car_transfer.fields.target_location_select','اختيار المكان المستهدف', !!perms.car_transfer?.fields?.target_location_select),
        uaBoolField('car_transfer.fields.status_select','اختيار الحالة', !!perms.car_transfer?.fields?.status_select),
        '<div class="hr" style="margin:10px 0"></div>',
        '<div class="small" style="margin-bottom:6px"><b>الأزرار</b></div>',
        uaBoolField('car_transfer.buttons.send_transfer','إرسال النقل', !!perms.car_transfer?.buttons?.send_transfer),
        uaBoolField('car_transfer.buttons.clear_list','مسح القائمة', !!perms.car_transfer?.buttons?.clear_list),
        uaBoolField('car_transfer.buttons.delete','حذف', !!perms.car_transfer?.buttons?.delete)
      ].join('')));

      // requests (dropdowns, sections, fields, buttons, workflow_actions)
      blocks.push(uaPermBlock('Requests', [
        '<div class="small" style="margin-bottom:6px"><b>Dropdowns</b></div>',
        uaBoolField('requests.dropdowns.choose_section','اختر القسم', !!perms.requests?.dropdowns?.choose_section),
        '<div class="hr" style="margin:10px 0"></div>',
        '<div class="small" style="margin-bottom:6px"><b>Sections</b></div>',
        uaBoolField('requests.sections.create_request','إنشاء طلب', !!perms.requests?.sections?.create_request),
        uaBoolField('requests.sections.follow_requests','متابعة الطلبات', !!perms.requests?.sections?.follow_requests),
        uaBoolField('requests.sections.completed_requests','الطلبات المكتملة', !!perms.requests?.sections?.completed_requests),
        '<div class="hr" style="margin:10px 0"></div>',
        '<div class="small" style="margin-bottom:6px"><b>Fields</b></div>',
        uaBoolField('requests.fields.request_type_select','تحديد نوع الطلب', !!perms.requests?.fields?.request_type_select),
        uaBoolField('requests.fields.vin_input','كتابة رقم الهيكل', !!perms.requests?.fields?.vin_input),
        uaBoolField('requests.fields.transfer_location_select','اختيار مكان النقل', !!perms.requests?.fields?.transfer_location_select),
        '<div class="hr" style="margin:10px 0"></div>',
        '<div class="small" style="margin-bottom:6px"><b>Buttons</b></div>',
        uaBoolField('requests.buttons.add_vin','إضافة هيكل', !!perms.requests?.buttons?.add_vin),
        uaBoolField('requests.buttons.clear_list','مسح القائمة', !!perms.requests?.buttons?.clear_list),
        uaBoolField('requests.buttons.delete','حذف', !!perms.requests?.buttons?.delete),
        uaBoolField('requests.buttons.send_request','إرسال الطلب', !!perms.requests?.buttons?.send_request),
        '<div class="hr" style="margin:10px 0"></div>',
        '<div class="small" style="margin-bottom:6px"><b>Workflow Actions</b></div>',
        uaBoolField('requests.workflow_actions.receive_order','تم استلام الطلب', !!perms.requests?.workflow_actions?.receive_order),
        uaBoolField('requests.workflow_actions.send_car','تم ارسال السيارة', !!perms.requests?.workflow_actions?.send_car),
        uaBoolField('requests.workflow_actions.receive_car','تم استلام السيارة', !!perms.requests?.workflow_actions?.receive_car),
        uaBoolField('requests.workflow_actions.finish_order','تم الانتهاء', !!perms.requests?.workflow_actions?.finish_order)
      ].join('')));

      // view permissions
      blocks.push(uaPermBlock('Views', [
        uaBoolField('all_cars.view','عرض كل السيارات', !!perms.all_cars?.view),
        uaBoolField('movement_log.view','عرض سجل الحركات', !!perms.movement_log?.view),
        uaBoolField('tracking.view','عرض التراكينج', !!perms.tracking?.view),
        uaBoolField('archive.view','عرض الأرشيف', !!perms.archive?.view)
      ].join('')));

      // users_admin
      blocks.push(uaPermBlock('Users Admin', [
        uaBoolField('users_admin.view_users','عرض المستخدمين', !!perms.users_admin?.view_users),
        uaBoolField('users_admin.edit_permissions','تعديل الصلاحيات', !!perms.users_admin?.edit_permissions),
        uaBoolField('users_admin.create_user_record','إنشاء سجل مستخدم', !!perms.users_admin?.create_user_record),
        uaBoolField('users_admin.disable_user','تعطيل مستخدم', !!perms.users_admin?.disable_user)
      ].join('')));

      return blocks.join('');
    }

    function uaBoolField(pathKey, label, checked){
      return `<label class="checkItem" style="background:#fff">
        <span>${escapeHtml(label)}</span>
        <input type="checkbox" data-ua-perm="${escapeHtml(pathKey)}" ${checked?'checked':''} />
      </label>`;
    }

    function uaOpenEditor(u){
      uaSelected = u;
      const ed = document.getElementById('ua_editor');
      if(!ed) return;
      ed.style.display = 'block';
      document.getElementById('ua_editor_user').innerHTML = `المستخدم: <b>${escapeHtml(u.data.email||'')}</b> <span class="small muted">(uid: ${escapeHtml(u.uid||u.id||'')})</span>`;
      document.getElementById('ua_name').value = u.data.name || '';
      document.getElementById('ua_email').value = u.data.email || '';
      document.getElementById('ua_active').value = (u.data.active ? 'true' : 'false');

      const tabsBox = document.getElementById('ua_tabs_box');
      tabsBox.innerHTML = UA_TABS.map(t=>uaTabItem(t.key, t.label, !!u.data.tabs?.[t.key])).join('');

      const permsBox = document.getElementById('ua_perms_box');
      permsBox.innerHTML = uaRenderPerms(u.data.permissions || uaCloneTemplate().permissions);
    }

    function uaSetDeep(obj, pathKey, val){
      const parts = pathKey.split('.');
      let cur = obj;
      for(let i=0;i<parts.length-1;i++){
        const k = parts[i];
        if(!cur[k] || typeof cur[k] !== 'object') cur[k] = {};
        cur = cur[k];
      }
      cur[parts[parts.length-1]] = val;
    }

    async function uaSave(){
      if(!uaSelected) return;
      const name = (document.getElementById('ua_name')?.value || '').trim();
      const email = (document.getElementById('ua_email')?.value || '').trim();
      const active = (document.getElementById('ua_active')?.value || 'true') === 'true';

      const payload = uaCloneTemplate();
      payload.name = name;
      payload.email = email;
      payload.active = active;

      // tabs
      document.querySelectorAll('[data-ua-tab]').forEach(ch=>{
        const k = ch.getAttribute('data-ua-tab');
        if(k) payload.tabs[k] = !!ch.checked;
      });

      // detailed perms
      document.querySelectorAll('[data-ua-perm]').forEach(ch=>{
        const p = ch.getAttribute('data-ua-perm');
        if(p) uaSetDeep(payload.permissions, p, !!ch.checked);
      });

      // enforce: if user is inactive -> hide all tabs except dashboard/users_admin? (keep as is, only save active)
      try{
        await db.collection('users').doc(uaSelected.id).set({
          uid: uaSelected.uid || uaSelected.id,
          name: payload.name,
          email: payload.email,
          active: payload.active,
          tabs: payload.tabs,
          permissions: payload.permissions,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: auth.currentUser?.email || ''
        }, { merge: true });
        toast('تم حفظ المستخدم');
      }catch(e){
        toast(e?.message || 'فشل حفظ المستخدم');
      }
    }

    async function uaCreateRecord(){
      const name = (document.getElementById('ua_new_name')?.value || '').trim();
      const email = (document.getElementById('ua_new_email')?.value || '').trim();
      const uid = (document.getElementById('ua_new_uid')?.value || '').trim();
      if(!email){ toast('اكتب البريد الإلكتروني'); return; }
      const docId = uid || email; // لو مفيش UID نخزن بالميل
      const tpl = uaCloneTemplate();
      tpl.name = name || 'اسم المستخدم';
      tpl.email = email;

      try{
        await db.collection('users').doc(docId).set({
          uid: uid || docId,
          name: tpl.name,
          email: tpl.email,
          active: true,
          tabs: tpl.tabs,
          permissions: tpl.permissions,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: auth.currentUser?.email || '',
          updatedBy: auth.currentUser?.email || ''
        }, { merge: true });
        toast('تم إنشاء سجل المستخدم');
        document.getElementById('ua_new_name').value = '';
        document.getElementById('ua_new_email').value = '';
        document.getElementById('ua_new_uid').value = '';
      }catch(e){
        toast(e?.message || 'فشل إنشاء سجل المستخدم');
      }
    }

    function uaStartLive(){
      if(usersUnsub) return;
      // try orderBy email if field exists
      let q = db.collection('users');
      try{ q = q.orderBy('email'); }catch(_){ /* ignore */ }

      usersUnsub = q.onSnapshot((snap)=>{
        const arr = [];
        snap.forEach(doc=>{
          const d = doc.data() || {};
          arr.push(uaNormalizeUser(doc.id, d));
        });
        uaCache = arr;
        uaRenderList();
      }, (err)=>{
        console.warn('users live error', err);
      });
    }

    function uaStopLive(){
      if(usersUnsub){ usersUnsub(); usersUnsub = null; }
    }

    // Bind UI
    document.getElementById('ua_refresh')?.addEventListener('click', ()=>uaRenderList());
    document.getElementById('ua_search')?.addEventListener('input', ()=>uaRenderList());
    document.getElementById('ua_active_filter')?.addEventListener('change', ()=>uaRenderList());
    document.getElementById('ua_create')?.addEventListener('click', uaCreateRecord);
    document.getElementById('ua_save')?.addEventListener('click', uaSave);
    document.getElementById('ua_close')?.addEventListener('click', ()=>{
      const ed = document.getElementById('ua_editor');
      if(ed) ed.style.display = 'none';
      uaSelected = null;
    });

    // Hook into openView to start/stop live
    const __openView_users_admin = openView;
    openView = function(viewId){
      __openView_users_admin(viewId);
      if(viewId === 'view-users'){
        uaStartLive();
      }else{
        uaStopLive();
      }
    };

</script>
</body>
</html>
