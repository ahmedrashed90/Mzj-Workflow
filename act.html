

<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <link rel="icon" type="image/x-icon" href="assets/favicon.png">

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>سجل الحركات — MZJ Workspace</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="./mzj-ui.css"/>

  <style>
    :root{
      --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280;
      --line:#e5e7eb; --line-strong:#d1d5db; --table-head:#fafafa;
      --card:#fff; --radius:14px; --ok:#16a34a; --danger:#ef4444; --info:#0ea5e9;
      --shadow:0 10px 24px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,Arial}

    /* Card */
    .container{max-width:1240px;margin:18px auto;padding:0 16px 48px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
    .title{display:flex;align-items:center;gap:10px;margin:0;color:var(--brown)}
    .hint{color:var(--muted);font-size:12px}

    /* Inputs / buttons */
    label{font-weight:800;display:block;color:var(--brown);font-size:13px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;outline:none;transition:.15s;font-family:"Tajawal",system-ui,Arial;font-size:13px}
    input:focus,select:focus,textarea:focus{border-color:var(--beige);box-shadow:0 0 0 3px rgba(188,143,116,.15)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{position:relative;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:800;display:inline-flex;gap:8px;align-items:center;transition:.15s;font-size:13px}
    .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
    .btn-ghost{background:#fff}
    .btn-primary{background:var(--brown);border-color:var(--brown);color:#fff}

    /* Tables */
    .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:14px;background:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:var(--table-head);z-index:2;border-bottom:1px solid var(--line-strong);
      text-align:right;color:#111827;font-size:13.5px;padding:12px 10px}
    tbody td{border-top:1px solid var(--line);padding:10px;vertical-align:top;font-size:13px}
    tbody tr:nth-child(odd){background:#fff}
    tbody tr:nth-child(even){background:#fcfcfc}
    tbody tr:hover{background:#f8fafc}
    tbody tr.row-latest{background:rgba(188,143,116,.10)}
    tbody tr.row-latest td{font-weight:800}
    td,th{border-left:1px solid var(--line)}
    td:last-child,th:last-child{border-left:0}
    .nowrap{white-space:nowrap}
    .w-120{min-width:120px}
    .w-160{min-width:160px}
    .copyable{cursor:pointer;text-decoration:underline;text-decoration-style:dotted}

    /* Status badge */
    .status-badge{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#fff;border-radius:12px;padding:6px 10px;font-size:12px}
    .dot{width:10px;height:10px;border-radius:999px;background:#f59e0b}
    .dot.ok{background:var(--ok)} .dot.err{background:var(--danger)} .dot.warn{background:#f59e0b}

    /* Auth */
    .auth-wrap{min-height:60vh;display:grid;place-items:center;padding:24px}
    .auth-card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:18px;max-width:420px;width:96%}
    .auth-card h2{margin:0 0 10px;color:var(--brown)}
    .auth-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .toast{position:fixed;bottom:16px;right:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.25);display:none;z-index:60;font-size:13px}
    .toast.ok{background:var(--ok)} .toast.info{background:var(--info)} .toast.err{background:var(--danger)}

    /* No flash */
    #noFlash{position:fixed;inset:0;background:var(--cream);z-index:999999}
  
    .stock-bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px;border:1px solid #f0e6dd;border-radius:12px;background:#fff}
    .stock-bar .hint{color:var(--muted);font-size:12px}
</style>
</head>

<body class="mzj">
<div id="noFlash"></div>

<header class="mzj-topbar">
  <div class="topbar-left">
    <button class="icon-btn" id="mzjSidebarBtn" aria-label="القائمة"><i class="fa-solid fa-bars"></i></button>
    <div class="brand">
      <div class="brand-mark">MZJ</div>
      <div class="brand-text">
        <div class="brand-title">محمد بن ذعار العجمي للسيارات</div>
        <div class="brand-sub">Workspace</div>
      </div>
    </div>
  </div>
  <div class="topbar-center">
    <div class="mzj-breadcrumb">
      <span class="crumb">الرئيسية</span>
      <i class="fa-solid fa-chevron-left"></i>
      <span class="crumb current">سجل الحركات</span>
    </div>
  </div>
  <div class="topbar-right">
    <div class="mzj-chip"><i class="fa-regular fa-clock"></i><span id="mzjNow">—</span></div>
    <button id="btnSignOut" class="btn btn-ghost" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> تسجيل الخروج</button>
  </div>
</header>

<div class="mzj-shell" id="mzjShell">
  <aside class="mzj-sidebar" id="mzjSidebar">
    <div class="side-section">
      <div class="side-title">القائمة</div>
      <nav class="side-nav">
        <a class="side-link tab" href="./sales.html"><i class="fa-solid fa-handshake"></i><span>تتبع المبيعات</span></a>
        <a class="side-link tab" href="./dashboard.html"><i class="fa-solid fa-gauge"></i><span>الداش بورد</span></a>
        <a class="side-link tab" href="./inventory.html"><i class="fa-solid fa-boxes-stacked"></i><span>المخزون</span></a>
        <a class="side-link tab" href="./vt.html"><i class="fa-solid fa-right-left"></i><span>نقل السيارات</span></a>
        <a class="side-link tab" href="./photoshoot-user.html"><i class="fa-solid fa-camera"></i><span>إدارة الطلبات</span></a>
        <a class="side-link tab" href="./cars.html"><i class="fa-solid fa-car"></i><span>كل السيارات</span></a>
        <a class="side-link tab" href="./admin.html"><i class="fa-solid fa-shield-halved"></i><span>الإدارة</span></a>
        <a class="side-link tab" href="./Activity.html"><i class="fa-solid fa-clipboard-list"></i><span>سجل النشاط</span></a>
        <a class="side-link tab active" href="./act.html"><i class="fa-solid fa-clipboard-list"></i><span>سجل الحركات</span></a>

      </nav>
    </div>
  </aside>

  <div class="mzj-backdrop" id="mzjBackdrop"></div>

  <main class="mzj-content">

    <!-- Auth Gate -->
    <div class="auth-wrap" id="authGate" style="display:none">
      <div class="auth-card">
        <h2>تسجيل الدخول</h2>
        <label for="email">البريد الإلكتروني</label>
        <input id="email" placeholder="you@example.com" type="email"/>
        <label for="password" style="margin-top:8px">كلمة المرور</label>
        <input id="password" placeholder="••••••••" type="password"/>
        <div class="auth-actions">
          <button class="btn btn-primary" id="btnLogin">تسجيل الدخول</button>
          <button class="btn btn-ghost" id="btnSignup">إنشاء حساب</button>
        </div>
        <p class="hint" id="authHint" style="margin-top:10px"></p>
      </div>
    </div>

    <!-- App -->
    <div id="app" style="display:none">
      <div class="container">
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="title"><i class="fa-solid fa-clipboard-list"></i> سجل الحركات</h2>
              <div class="hint">نفس بيانات تبويب "سجل الحركات" داخل صفحة الإدارة.</div>
            </div>
            <div class="row" style="justify-content:flex-start">
              <div class="status-badge"><span class="dot warn" id="connDot"></span><span id="connText">جارِ الاتصال…</span></div>
            </div>
          </div>

          <div class="row" style="margin-bottom:10px">
            <div class="row" style="gap:8px">
              <label style="margin:0 6px 0 0">تاريخ من</label>
              <input id="movesFromDate" type="date" style="width:auto;min-width:170px"/>
            </div>
            <div class="row" style="gap:8px">
              <label style="margin:0 6px 0 0">إلى</label>
              <input id="movesToDate" type="date" style="width:auto;min-width:170px"/>
            </div>
            <button class="btn btn-ghost" id="btnClearDate"><i class="fa-solid fa-eraser"></i> مسح التاريخ</button>

            <div style="flex:1"></div>

            <div class="row" style="gap:8px">
              <input id="quickSearch" placeholder="بحث سريع (VIN / سيارة / من / إلى)" style="min-width:320px"/>
              <button class="btn btn-ghost" id="btnClearSearch"><i class="fa-solid fa-minus"></i> مسح</button>
              <button class="btn btn-ghost" id="btnExportExcel"><i class="fa-solid fa-file-excel"></i> تصدير Excel</button>
            </div>
          </div>
            <div class="stock-bar" id="stockPlaceBar" style="display:none;margin-top:10px">
              <div class="status-badge"><span class="dot warn" id="stockDot"></span><span id="stockText">—</span></div>
              <div class="hint" id="stockHint">—</div>
            </div>


          <div class="table-wrap">
            <table id="movesTable">
              <thead>
                <tr>
                  <th class="w-120">#</th>
                  <th class="w-120">التاريخ</th>
                  <th>رقم الهيكل</th>
                  <th>السيارة</th>
                  <th>من</th>
                  <th>إلى</th>
                  <th>المكان الحالي (المخزون)</th>
                  <th class="w-120">ID</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="hint" id="rowsHint" style="margin-top:10px">—</div>
        </div>
      </div>
    </div>

  </main>
</div>

<div class="toast" id="toast"></div>

<script src="./mzj-ui.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  /* ===== Firebase ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const STATE_REF = doc(db, "mzj_admin_state", "v1");

  /* ===== Roles ===== */
  const ROLE_ADMIN   = 'الادارة';
  const ROLE_IDARI   = 'اداري';
  const ROLE_BRANCH  = 'مدراء فروع';
  const PAGE_ALLOWED_ROLES = [ROLE_ADMIN, ROLE_IDARI, ROLE_BRANCH];

  async function fetchUserRole(user){
    try{
      const userDocRef = doc(db, 'user', user.uid);
      const snap = await getDoc(userDocRef);
      if(snap.exists()){
        const data = snap.data() || {};
        return data.role || null;
      }
      return null;
    }catch(err){
      console.error('Error fetching user role:', err);
      return null;
    }
  }

  /* ===== Helpers ===== */
  const $ = s => document.querySelector(s);
  const toast = $('#toast');
  function showToast(msg,type='ok'){toast.textContent=msg;toast.className='toast '+type;toast.style.display='block';setTimeout(()=>toast.style.display='none',1800)}
  function pad(n){return n<10?'0'+n:n}
  function onlyDate(str){return (str||'').toString().slice(0,10)}
  function normalizeVin(v){
    if(!v) return '';
    const ar={'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
    return v.toString().replace(/[٠-٩]/g,d=>ar[d]).toUpperCase().replace(/[\s\-\._]/g,'').trim();
  }

  // تحويل أي شكل تاريخ/وقت لقيمة رقمية للمقارنة (الأحدث أكبر)
  function toMillis(x){
    try{
      if(x == null) return 0;
      // Firestore Timestamp {seconds, nanoseconds}
      if(typeof x === 'object' && typeof x.seconds === 'number'){
        return (x.seconds * 1000) + Math.floor((x.nanoseconds||0)/1e6);
      }
      if(typeof x === 'number') return x;
      const s = String(x).trim();
      if(!s) return 0;
      // إذا كان YYYY-MM-DD
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return Date.parse(s + 'T00:00:00Z') || 0;
      const t = Date.parse(s);
      return isNaN(t) ? 0 : t;
    }catch(_){ return 0; }
  }

  function moveTs(m){
    // الأفضلية: when ثم date ثم id
    return toMillis(m?.when) || toMillis(m?.date) || toMillis(m?.id) || 0;
  }

  function liftNoFlash(){
    const nf = document.getElementById('noFlash');
    if(nf) nf.remove();
  }

  /* ===== DOM ===== */
  const authGate=$('#authGate'), appRoot=$('#app');
  const btnSignOut=$('#btnSignOut');
  const emailEl=$('#email'), passEl=$('#password'), btnLogin=$('#btnLogin'), btnSignup=$('#btnSignup'), authHint=$('#authHint');
  const connDot=$('#connDot'), connText=$('#connText');

  const movesFromDate=$('#movesFromDate'), movesToDate=$('#movesToDate'), btnClearDate=$('#btnClearDate');
  const quickSearch=$('#quickSearch'), btnClearSearch=$('#btnClearSearch'), btnExportExcel=$('#btnExportExcel');
  const movesTableBody = document.querySelector('#movesTable tbody');
  const stockPlaceBar = $('#stockPlaceBar');
  const stockDot = $('#stockDot');
  const stockText = $('#stockText');
  const stockHint = $('#stockHint');
  const rowsHint = $('#rowsHint');

  let moves = [];
  let stockItems = [];
  let stockPlaceMap = new Map();

  // بناء خريطة (VIN -> المكان الحالي) من stock داخل mzj_admin_state/v1
  function buildStockMap(list){
    stockPlaceMap = new Map();
    (Array.isArray(list)?list:[]).forEach((s)=>{
      const vin = (s && (s.vin || s.VIN || s.chassis || s.chassisNo || s.vinNumber || s['رقم_الهيكل'] || s['رقم الهيكل'] || s['رقمهيكل'] || s.vehicleVin)) ?? '';
      const vNorm = normalizeVin(String(vin||''));
      if(!vNorm) return;

      const place = (s.place || s.location || s.branch || s.currentPlace || s.placeText || s['مكان'] || s['المكان'] || s['المكان الحالي'] || s['مكان السيارة'] || s['مكان_السيارة'] || '') ?? '';
      const p = String(place||'').trim();
      if(p) stockPlaceMap.set(vNorm, p);
    });
  }

  function getStockPlace(vinRaw){
    const vNorm = normalizeVin(String(vinRaw||''));
    return stockPlaceMap.get(vNorm) || '';
  }

  function setStockBar(mode, text, hint=''){
    if(!stockPlaceBar) return;
    stockPlaceBar.style.display = 'flex';
    stockDot.className = 'dot ' + (mode==='ok'?'ok':mode==='err'?'err':'warn');
    stockText.textContent = text || '—';
    stockHint.textContent = hint || '';
  }

  let unsub = null;

  function setStatus(mode, txt){
    connDot.className='dot '+(mode==='ok'?'ok':mode==='err'?'err':'warn');
    connText.textContent = txt;
  }

  /* ===== Filtering + render ===== */
  function filterMovesByDate(list){
    const f = movesFromDate.value || null;
    const t = movesToDate.value || null;
    if(!f && !t) return list;
    return list.filter(m=>{
      const d = m.date || onlyDate(m.when||'');
      if(f && d < f) return false;
      if(t && d > t) return false;
      return true;
    });
  }

  function filterBySearch(list){
    const raw = (quickSearch.value||'').trim();
    const q = raw.toLowerCase();
    if(!q) return list;

    // لو المستخدم كتب رقم هيكل (VIN) بشكل واضح: اعرض كل حركات هذا الهيكل + ترتيبها بالأحدث
    const qVin = normalizeVin(raw);
    const looksLikeVin = qVin.length >= 11 && /^[A-Z0-9]+$/.test(qVin);
    if(looksLikeVin){
      const vinMoves = list.filter(m => normalizeVin(m.vin||'') === qVin);
      vinMoves.sort((a,b)=> (moveTs(b) - moveTs(a)) || ((b.__idx||0) - (a.__idx||0)));
      return vinMoves;
    }

    // غير ذلك: بحث عام
    return list.filter(m=>{
      const hay = [
        m.vin||'', m.car||'', m.from||'', m.to||'', m.id||'',
        (m.date||onlyDate(m.when||''))||''
      ].join(' ').toLowerCase();
      return hay.includes(q);
    });
  }

  function renderMoves(){
    movesTableBody.innerHTML='';
    let rows = moves.slice();

    rows = filterMovesByDate(rows);
    rows = filterBySearch(rows);

    // الأحدث أولاً (اختياري) — نفس تبويب الإدارة كان حسب الترتيب الحالي، لكن ده أنسب لسجل
    rows.sort((a,b)=> (moveTs(b) - moveTs(a)) || ((b.__idx||0) - (a.__idx||0)));

    rows.forEach((m,i)=>{
      const vin = m.vin || '';
      const tr=document.createElement('tr');
      // تمييز أحدث حركة عند البحث بـ VIN
      const qRaw = (quickSearch.value||'').trim();
      const qVin = normalizeVin(qRaw);
      const looksLikeVin = qVin.length >= 11 && /^[A-Z0-9]+$/.test(qVin);
      if(looksLikeVin && i===0){ tr.classList.add('row-latest'); }
      tr.innerHTML=`
        <td>${i+1}</td>
        <td class="nowrap">${m.date || onlyDate(m.when||'')}</td>
        <td class="nowrap"><span class="copyable" data-copy="${vin}" title="انسخ رقم الهيكل">${vin}</span></td>
        <td>${m.car||''}</td>
        <td>${m.from||''}</td>
        <td>${m.to||''}</td>
        <td>${getStockPlace(vin) || ''}</td>
        <td class="nowrap">${m.id||''}</td>`;
      movesTableBody.appendChild(tr);
    });

    
    // تحديث شريط المكان الحالي عند البحث برقم الهيكل
    const raw = (quickSearch.value||'').trim();
    if(looksLikeVinInput(raw)){
      const vNorm = normalizeVin(raw);
      const p = stockPlaceMap.get(vNorm) || '';
      if(!p){
        setStockBar('err','لم يتم العثور على هذا الهيكل في المخزون', vNorm);
      }else{
        // قارن مع أحدث حركة في السجل (إلى)
        const latest = rows.find(r => normalizeVin(r.vin||'')===vNorm);
        const latestTo = latest ? String(latest.to||'').trim() : '';
        const mismatch = latestTo && latestTo !== String(p).trim();
        if(mismatch){
          setStockBar('warn', `المكان الحالي (المخزون): ${p}`, `⚠️ آخر حركة في السجل تقول: ${latestTo} — واضح إن طلب النقل (إرسال/استلام) ما اتسجلش في moves`);
        }else{
          setStockBar('ok', `المكان الحالي (المخزون): ${p}`, '');
        }
      }
    }else{
      if(stockPlaceBar) stockPlaceBar.style.display='none';
    }

    rowsHint.textContent = `عدد السجلات المعروضة: ${rows.length}`;
  }

  movesFromDate.addEventListener('change', renderMoves);
  movesToDate.addEventListener('change', renderMoves);
  btnClearDate.addEventListener('click', ()=>{movesFromDate.value=''; movesToDate.value=''; renderMoves();});
  quickSearch.addEventListener('input', ()=> renderMoves());
  btnClearSearch.addEventListener('click', ()=>{ quickSearch.value=''; renderMoves(); });

  /* ===== Export CSV (Excel) ===== */
  btnExportExcel?.addEventListener('click', ()=>{
    try{
      let rows = moves.slice();
      rows = filterMovesByDate(rows);
      rows = filterBySearch(rows);
      rows.sort((a,b)=> (moveTs(b) - moveTs(a)) || ((b.__idx||0) - (a.__idx||0)));

      if(!rows.length){
        showToast('لا توجد بيانات للتصدير','info');
        return;
      }

      let csv='\uFEFF'; // BOM لدعم العربية
      csv += ['#','التاريخ','رقم الهيكل','السيارة','من','إلى','المكان الحالي (المخزون)','ID'].join(',')+'\n';

      rows.forEach((m,i)=>{
        const line = [
          i+1,
          (m.date || onlyDate(m.when||'')) || '',
          m.vin || '',
          m.car || '',
          m.from || '',
          m.to || '',
          getStockPlace(m.vin) || '',
          m.id || ''
        ].map(v => '"'+String(v).replace(/"/g,'""')+'"').join(',');
        csv += line + '\n';
      });

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `moves_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('تم تصدير الملف ✅','ok');
    }catch(err){
      console.error(err);
      showToast('تعذّر التصدير','err');
    }
  });


  document.addEventListener('click',(e)=>{
    const pill = e.target.closest('.copyable');
    if(pill){
      const txt=(pill.getAttribute('data-copy')||'').trim();
      if(txt){ navigator.clipboard.writeText(txt).then(()=>showToast('تم النسخ ✅','ok')); }
    }
  });

  /* ===== Auth ===== */
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      try{
        const role = await fetchUserRole(user);
        window.__mzjUserRole = role || null;

        if(!role || !PAGE_ALLOWED_ROLES.includes(role)){
          window.location.href = 'unauthorized.html';
          return;
        }

        authGate.style.display = 'none';
        appRoot.style.display  = 'block';
        btnSignOut.style.display = 'inline-flex';
        setStatus('ok', `متصل: ${user.email} — الدور: ${role}`);

        liftNoFlash();
        subscribeLive();
      }catch(err){
        console.error(err);
        setStatus('err','خطأ في تحميل البيانات');
        liftNoFlash();
      }
    }else{
      // not logged in
      if(unsub){ try{unsub();}catch(e){} unsub=null; }
      appRoot.style.display = 'none';
      authGate.style.display = 'grid';
      authGate.style.display = 'grid';
      btnSignOut.style.display = 'none';
      setStatus('warn','لم يتم تسجيل الدخول');
      liftNoFlash();
    }
  });

  btnLogin?.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{ await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
    catch(e){ authHint.textContent='فشل تسجيل الدخول: '+(e?.message||e); }
  });
  btnSignup?.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{ await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
    catch(e){ authHint.textContent='تعذّر إنشاء الحساب: '+(e?.message||e); }
  });
  btnSignOut?.addEventListener('click', ()=> signOut(auth));

  function subscribeLive(){
    try{
      if(unsub){ try{unsub();}catch(e){} unsub=null; }
      unsub = onSnapshot(STATE_REF,(snap)=>{
        if(!snap.exists()) return;
        const d = snap.data() || {};
        stockItems = Array.isArray(d.stock) ? d.stock.slice() : [];
        buildStockMap(stockItems);
        moves = Array.isArray(d.moves) ? d.moves : [];
        // فهرسة داخلية لضمان ترتيب صحيح عند تساوي/غياب التوقيت
        moves.forEach((m,i)=>{ try{ m.__idx = i; }catch(_){ } });
        renderMoves();
        setStatus('ok','مزامنة حيّة');
      }, ()=>{
        setStatus('warn','انقطاع المزامنة مؤقتًا');
      });
    }catch(e){
      console.error(e);
      setStatus('err','تعذّر الاشتراك في المزامنة');
    }
  }
</script>

</body>
</html>
