
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>سجل نشاط الأعضاء — MZJ Cars</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- ✅ استخدم ملفاتك الأساسية -->
  <link rel="stylesheet" href="./mzj-ui.css"/>

  <style>
    /* ✅ بدون Topbar نهائي */
    body.mzj{ --topbar-h: 0px; }
    .mzj-shell{ min-height: 100vh; }
    .mzj-sidebar{ top: 0; height: 100vh; }
    .mzj-backdrop{ inset: 0; }

    /* زر فتح السايدبار (FAB) */
    .mzj-fab{
      position: fixed;
      bottom: 16px;
      left: 16px;
      z-index: 80;
      background: var(--brown);
      color: #fff;
      border-color: rgba(0,0,0,.04);
    }
    body.mzj.dark .mzj-fab{
      background: rgba(188,143,116,.22);
      color: var(--beige);
      border-color: rgba(255,255,255,.10);
    }

    /* Activity page layout */
    .page-head-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .status-badge{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line);
      background: var(--card);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--muted);
    }
    .dot{ width:10px; height:10px; border-radius:999px; background: var(--warn); }
    .dot.ok{ background: var(--ok); }
    .dot.err{ background: var(--danger); }
    .dot.warn{ background: var(--warn); }

    .hint{ color: var(--muted); font-size: 12px; margin: 6px 0 0; }

    /* Filters */
    .filters{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
      align-items:end;
    }
    .field{ grid-column: span 3; display:flex; flex-direction:column; gap:6px; }
    .field.wide{ grid-column: span 6; }
    @media (max-width: 980px){
      .field{ grid-column: span 6; }
      .field.wide{ grid-column: span 12; }
    }
    @media (max-width: 620px){
      .filters{ grid-template-columns: 1fr; }
      .field,.field.wide{ grid-column: auto; }
    }
    label{ font-weight: 800; color: var(--brown); font-size: 12px; }
    body.mzj.dark label{ color: var(--beige); }

    .input,.select{
      height: 44px;
      padding: 0 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: var(--card);
      color: var(--text);
      font-family: var(--font);
      font-size: 13px;
      outline: none;
    }
    .select{ cursor:pointer; }
    .input:focus,.select:focus{
      border-color: rgba(188,143,116,.55);
      box-shadow: 0 0 0 3px rgba(188,143,116,.14);
    }

    /* KPI grid */
    .mzj-kpis{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    @media (max-width: 900px){ .mzj-kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 640px){ .mzj-kpis{ grid-template-columns: 1fr; } }

    /* Table */
    .mzj-table{ min-width: 920px; }
    .ua{ max-width: 260px; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; }
  </style>
</head>

<body class="mzj" data-page="activity">

  <!-- زر السايدبار (يشتغل مع mzj-ui.js) -->
  <button class="icon-btn mzj-fab" id="mzjSidebarBtn" aria-label="القائمة">
    <i class="fa-solid fa-bars"></i>
  </button>

  <div class="mzj-shell" id="mzjShell">

    <!-- Sidebar -->
    <aside class="mzj-sidebar" id="mzjSidebar">
      <div class="side-section">
        <div class="side-title">القائمة</div>
        <nav class="side-nav">
          <a class="side-link" data-page="dashboard" href="dashboard.html"><i class="fa-solid fa-gauge"></i><span>الداش بورد</span></a>
          <a class="side-link" data-page="inventory" href="inventory.html"><i class="fa-solid fa-boxes-stacked"></i><span>المخزون</span></a>
          <a class="side-link active" data-page="activity" href="activity.html"><i class="fa-solid fa-clipboard-list"></i><span>سجل النشاط</span></a>
          <a class="side-link" data-page="admin" href="admin.html"><i class="fa-solid fa-shield-halved"></i><span>الإدارة</span></a>
        </nav>
      </div>
    </aside>

    <div class="mzj-backdrop" id="mzjBackdrop"></div>

    <!-- Content -->
    <main class="mzj-content">
      <div class="mzj-pagehead">
        <div>
          <h1 class="page-title">سجل نشاط الأعضاء</h1>
          <p class="page-desc">تتبع كل حركة يقوم بها الأعضاء داخل النظام</p>
        </div>
        <div class="pagehead-right page-head-row">
          <div class="status-badge">
            <span id="connDot" class="dot warn"></span>
            <span id="connText">جارِ الاتصال…</span>
          </div>
          <button id="btnSignOut" class="mzj-btn mzj-btn-ghost" style="display:none">
            <i class="fa-solid fa-right-from-bracket"></i><span>تسجيل الخروج</span>
          </button>
        </div>
      </div>

      <!-- Auth Gate -->
      <div id="authGate" style="min-height:60vh;display:grid;place-items:center;padding:10px">
        <div class="mzj-card" style="max-width:460px;width:100%">
          <div class="card-head">
            <div class="card-title">تسجيل الدخول</div>
            <div class="card-sub">ادخل بياناتك للوصول لسجل النشاط</div>
          </div>
          <div class="card-body">
            <div style="display:grid;gap:10px">
              <div>
                <label>البريد الإلكتروني</label>
                <input id="email" class="input" type="email" placeholder="you@example.com"/>
              </div>
              <div>
                <label>كلمة المرور</label>
                <input id="password" class="input" type="password" placeholder="••••••••"/>
              </div>
              <div class="mzj-actions">
                <button class="mzj-btn" id="btnLogin"><i class="fa-solid fa-right-to-bracket"></i><span>تسجيل الدخول</span></button>
                <button class="mzj-btn mzj-btn-ghost" id="btnSignup"><i class="fa-solid fa-user-plus"></i><span>إنشاء حساب</span></button>
              </div>
              <p class="hint" id="authHint"></p>
            </div>
          </div>
        </div>
      </div>

      <!-- App -->
      <div id="app" style="display:none">
        <div class="mzj-grid">

          <!-- KPIs -->
          <section class="mzj-card" style="grid-column: span 12;">
            <div class="card-head">
              <div class="card-title">ملخص سريع</div>
              <div class="card-sub">إحصائيات من آخر 1000 حركة</div>
            </div>
            <div class="card-body">
              <div class="mzj-kpis">
                <div class="kpi">
                  <div class="kpi-label">إجمالي الحركات</div>
                  <div class="kpi-value" id="sumTotal">0</div>
                </div>
                <div class="kpi">
                  <div class="kpi-label">عدد الأعضاء النشطين</div>
                  <div class="kpi-value" id="sumMembers">0</div>
                </div>
                <div class="kpi">
                  <div class="kpi-label">حركات اليوم</div>
                  <div class="kpi-value" id="sumToday">0</div>
                </div>
              </div>
              <p class="hint">يتم تحميل آخر 1000 حركة من كولكشن <b>mzj_activity_log</b> وترتيبها من الأحدث إلى الأقدم.</p>
            </div>
          </section>

          <!-- Filters -->
          <section class="mzj-card" style="grid-column: span 12;">
            <div class="card-head">
              <div class="card-title">الفلاتر والبحث</div>
              <div class="card-sub">صفّي حسب التاريخ/العضو/نوع الحركة أو ابحث بحرّية</div>
            </div>
            <div class="card-body">
              <div class="filters">
                <div class="field">
                  <label for="dateFrom">من تاريخ</label>
                  <input id="dateFrom" class="input" type="date">
                </div>
                <div class="field">
                  <label for="dateTo">إلى تاريخ</label>
                  <input id="dateTo" class="input" type="date">
                </div>
                <div class="field">
                  <label for="memberFilter">العضو</label>
                  <select id="memberFilter" class="select">
                    <option value="ALL">الكل</option>
                  </select>
                </div>
                <div class="field">
                  <label for="actionFilter">نوع الحركة</label>
                  <select id="actionFilter" class="select">
                    <option value="ALL">الكل</option>
                  </select>
                </div>

                <div class="field wide">
                  <label for="searchInput">بحث عام</label>
                  <input id="searchInput" class="input" placeholder="ابحث بالعضو، الحركة، السيارة، رقم الهيكل، ملاحظات…">
                </div>

                <div class="field">
                  <label>&nbsp;</label>
                  <button id="btnClearFilters" class="mzj-btn mzj-btn-ghost" type="button">
                    <i class="fa-solid fa-eraser"></i><span>مسح الفلاتر</span>
                  </button>
                </div>

                <div class="field">
                  <label>&nbsp;</label>
                  <button id="btnExport" class="mzj-btn" type="button">
                    <i class="fa-regular fa-file-excel"></i><span>تصدير Excel</span>
                  </button>
                </div>
              </div>
            </div>
          </section>

          <!-- Table -->
          <section class="mzj-card" style="grid-column: span 12;">
            <div class="card-head">
              <div class="card-title">سجل النشاط</div>
              <div class="card-sub">عرض تفاصيل الحركات — الأحدث أولاً</div>
            </div>
            <div class="card-body">
              <div class="mzj-table-wrap">
                <table id="logsTable" class="mzj-table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>التاريخ والوقت</th>
                      <th>العضو</th>
                      <th>الدور</th>
                      <th>نوع الحركة</th>
                      <th>الكيان</th>
                      <th>التفاصيل</th>
                      <th>المرجع</th>
                      <th>IP</th>
                      <th>المتصفح</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <p class="hint" id="logsCount" style="margin-top:10px">لا توجد بيانات بعد.</p>
            </div>
          </section>

        </div>
      </div>

      <div id="toast" style="position:fixed;bottom:18px;right:18px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.25);display:none;z-index:100;font-size:13px"></div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- ✅ سكربت السايدبار (ملفك) -->
  <script src="./mzj-ui.js"></script>

  <!-- ✅ منطق Activity (نفس من ملفك مع تعديلات بسيطة للتنسيق فقط) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { 
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, 
      createUserWithEmailAndPassword, signOut 
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy, limit, onSnapshot, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    /* ===== Firebase (كما هو) ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
      authDomain: "mzj-agenda.firebaseapp.com",
      projectId: "mzj-agenda",
      storageBucket: "mzj-agenda.firebasestorage.app",
      messagingSenderId: "834700407721",
      appId: "1:834700407721:web:75c17665d4f032fd65cab8"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ===== Roles & Permissions ===== */
    const ROLE_ADMIN   = 'الادارة';
    const ROLE_IDARI   = 'اداري';
    const ROLE_BRANCH  = 'مدراء فروع';
    const ROLE_PAGES = {
      [ROLE_ADMIN] : 'ALL',
      [ROLE_IDARI] : ['photoshoot.html','photoshoot-user.html','cars.html'],
      [ROLE_BRANCH]: ['dashboard.html']
    };
    const PAGE_ALLOWED_ROLES = [ROLE_ADMIN];

    async function fetchUserRole(user){
      try{
        const snap = await getDoc(doc(db, 'user', user.uid));
        if(snap.exists()){
          const data = snap.data() || {};
          return data.role || null;
        }
      }catch(e){
        console.error('Error fetching user role', e);
      }
      return null;
    }

    function applyTabsVisibility(role){
      // مفيش Tabs هنا — سايبها لو احتجتها لاحقًا
      return;
    }

    /* ===== Helpers ===== */
    const $ = s => document.querySelector(s);
    const toastEl = $('#toast');
    const pad = n => n<10?'0'+n:n;

    const setStatus = (mode,txt)=>{
      const dot = $('#connDot');
      if(dot) dot.className='dot '+(mode==='ok'?'ok':mode==='err'?'err':'warn');
      const t = $('#connText');
      if(t) t.textContent=txt;
    };

    const showToast = msg=>{
      if(!toastEl) return;
      toastEl.textContent=msg;
      toastEl.style.display='block';
      setTimeout(()=>toastEl.style.display='none',1400);
    };

    const startOfDayStr = d=>{
      const year=d.getFullYear(),m=d.getMonth(),day=d.getDate();
      return `${year}-${pad(m+1)}-${pad(day)}`;
    };

    /* ===== State ===== */
    let allLogs = [];
    let filteredLogs = [];
    let membersMap = new Map();
    let actionsSet = new Set();

    /* ===== Auth Gate ===== */
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        const role = await fetchUserRole(user);
        if(!role || !PAGE_ALLOWED_ROLES.includes(role)){
          window.location.href = 'unauthorized.html';
          return;
        }
        $('#authGate').style.display='none';
        $('#app').style.display='block';
        $('#btnSignOut').style.display='inline-flex';
        setStatus('ok', `متصل: ${user.email} — الدور: ${role}`);
        applyTabsVisibility(role);
        subscribeLogs();
      }else{
        $('#app').style.display='none';
        $('#authGate').style.display='grid';
        $('#btnSignOut').style.display='none';
        setStatus('warn','لم يتم تسجيل الدخول');
      }
    });

    $('#btnLogin').addEventListener('click', async ()=>{
      $('#authHint').textContent='';
      try{
        await signInWithEmailAndPassword(auth, $('#email').value.trim(), $('#password').value);
      }catch(e){
        $('#authHint').textContent='فشل تسجيل الدخول: '+(e?.message||e);
      }
    });

    $('#btnSignup').addEventListener('click', async ()=>{
      $('#authHint').textContent='';
      try{
        await createUserWithEmailAndPassword(auth, $('#email').value.trim(), $('#password').value);
      }catch(e){
        $('#authHint').textContent='تعذّر إنشاء الحساب: '+(e?.message||e);
      }
    });

    $('#btnSignOut').addEventListener('click', ()=> signOut(auth));

    /* ===== Subscribe Logs ===== */
    function subscribeLogs(){
      try{
        const col = collection(db,'mzj_activity_log');
        const qLogs = query(col, orderBy('createdAtTs','desc'), limit(1000));
        onSnapshot(qLogs,(snap)=>{
          allLogs = [];
          snap.forEach(docSnap=>{
            const d = docSnap.data() || {};
            const email = (d.userEmail || '').trim();
            const name  = (d.userName  || '').trim();
            const memberKey   = (email || name).toLowerCase();
            const memberLabel = name 
              ? (email ? `${name} (${email})` : name)
              : (email || '-');

            allLogs.push({
              _id: docSnap.id,
              userEmail: email,
              userName : name,
              role     : d.role      || '',
              action   : d.action    || '',
              entityType: d.entityType || '',
              entityId : d.entityId  || '',
              details  : d.details   || '',
              createdAt: d.createdAt || '',
              createdAtTs: d.createdAtTs || null,
              ip       : d.ip        || '',
              userAgent: d.userAgent || '',
              memberKey,
              memberLabel
            });
          });
          buildFiltersLists();
          applyFilters();
          setStatus('ok','مزامنة حيّة لسجل النشاط');
        },(err)=>{
          console.error(err);
          setStatus('warn','تعذّر تحميل سجل النشاط مؤقتًا');
        });
      }catch(e){
        console.error(e);
        setStatus('warn','خطأ في الاشتراك في سجل النشاط');
      }
    }

    /* ===== Filters ===== */
    const memberFilterEl = $('#memberFilter');
    const actionFilterEl = $('#actionFilter');
    const dateFromEl = $('#dateFrom');
    const dateToEl = $('#dateTo');
    const searchInputEl = $('#searchInput');

    function buildFiltersLists(){
      membersMap = new Map();
      actionsSet = new Set();

      allLogs.forEach(l=>{
        if(l.memberKey){
          membersMap.set(l.memberKey, l.memberLabel || l.userEmail || l.userName || l.memberKey);
        }
        if(l.action) actionsSet.add(l.action);
      });

      const prevMember = memberFilterEl.value || 'ALL';
      const prevAction = actionFilterEl.value || 'ALL';

      memberFilterEl.innerHTML = '<option value="ALL">الكل</option>';
      Array.from(membersMap.entries())
        .sort((a,b)=> a[1].localeCompare(b[1],'ar'))
        .forEach(([key,label])=>{
          const opt = document.createElement('option');
          opt.value = key;
          opt.textContent = label;
          memberFilterEl.appendChild(opt);
        });

      actionFilterEl.innerHTML = '<option value="ALL">الكل</option>';
      Array.from(actionsSet).sort((a,b)=>a.localeCompare(b,'ar')).forEach(a=>{
        const opt = document.createElement('option');
        opt.value = a;
        opt.textContent = a;
        actionFilterEl.appendChild(opt);
      });

      if([...memberFilterEl.options].some(o=>o.value===prevMember)) memberFilterEl.value = prevMember;
      if([...actionFilterEl.options].some(o=>o.value===prevAction)) actionFilterEl.value = prevAction;
    }

    function applyFilters(){
      const memberVal = memberFilterEl.value || 'ALL';
      const actionVal = actionFilterEl.value || 'ALL';
      const q = (searchInputEl.value||'').toLowerCase().trim();
      const fromVal = dateFromEl.value || '';
      const toVal = dateToEl.value || '';

      filteredLogs = allLogs.filter((l)=>{
        if(memberVal !== 'ALL' && l.memberKey !== memberVal) return false;
        if(actionVal !== 'ALL' && l.action !== actionVal) return false;

        if(fromVal){
          if(!l.createdAt || l.createdAt.slice(0,10) < fromVal) return false;
        }
        if(toVal){
          if(!l.createdAt || l.createdAt.slice(0,10) > toVal) return false;
        }

        if(q){
          const hay = [
            l.userEmail,l.userName,l.role,l.action,l.entityType,l.entityId,
            l.details,l.createdAt,l.ip,l.userAgent
          ].join(' ').toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });

      renderTable();
      updateSummary();
    }

    function clearFilters(){
      dateFromEl.value = '';
      dateToEl.value = '';
      memberFilterEl.value = 'ALL';
      actionFilterEl.value = 'ALL';
      searchInputEl.value = '';
      applyFilters();
      showToast('تم مسح الفلاتر');
    }

    $('#btnClearFilters').addEventListener('click', clearFilters);
    memberFilterEl.addEventListener('change', applyFilters);
    actionFilterEl.addEventListener('change', applyFilters);
    dateFromEl.addEventListener('change', applyFilters);
    dateToEl.addEventListener('change', applyFilters);
    searchInputEl.addEventListener('input', ()=>{ applyFilters(); });

    /* ===== Table Render ===== */
    const logsTableBody = document.querySelector('#logsTable tbody');
    const logsCountEl   = $('#logsCount');

    function actionClass(action){
      const a = (action||'').toLowerCase();
      if(!a) return 'badge-warn';
      if(a.includes('حذف') || a.includes('delete')) return 'badge-danger';
      if(a.includes('تعديل') || a.includes('update') || a.includes('edit')) return 'badge-warn';
      if(a.includes('إضافة') || a.includes('add') || a.includes('create') || a.includes('insert')) return 'badge-ok';
      return 'badge-warn';
    }

    function renderTable(){
      logsTableBody.innerHTML = '';
      filteredLogs.forEach((l,idx)=>{
        const tr = document.createElement('tr');
        const memberLabel = l.memberLabel || l.userEmail || l.userName || '-';
        const entityLabel = l.entityType ? `${l.entityType}${l.entityId ? ' #' + l.entityId : ''}` : (l.entityId || '-');
        const shortUA = l.userAgent ? (l.userAgent.length>45 ? l.userAgent.slice(0,45)+'…' : l.userAgent) : '';
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${l.createdAt || '-'}</td>
          <td>${memberLabel}</td>
          <td>${l.role || '-'}</td>
          <td><span class="badge ${actionClass(l.action)}">${l.action || '-'}</span></td>
          <td>${entityLabel}</td>
          <td>${l.details || ''}</td>
          <td>${l._id}</td>
          <td>${l.ip || ''}</td>
          <td class="ua" title="${l.userAgent||''}">${shortUA}</td>
        `;
        logsTableBody.appendChild(tr);
      });

      logsCountEl.textContent = `عدد الحركات الظاهرة: ${filteredLogs.length.toLocaleString('ar-SA')} من ${allLogs.length.toLocaleString('ar-SA')}`;
    }

    /* ===== Summary ===== */
    function updateSummary(){
      $('#sumTotal').textContent = allLogs.length.toLocaleString('ar-SA');

      const uniqMembers = new Set();
      allLogs.forEach(l=>{ if(l.memberKey) uniqMembers.add(l.memberKey); });
      $('#sumMembers').textContent = uniqMembers.size.toLocaleString('ar-SA');

      const todayStr = startOfDayStr(new Date());
      const todayCount = allLogs.filter(l => (l.createdAt||'').slice(0,10) === todayStr).length;
      $('#sumToday').textContent = todayCount.toLocaleString('ar-SA');
    }

    /* ===== Export Excel ===== */
    $('#btnExport').addEventListener('click', ()=>{
      if(!filteredLogs.length){ showToast('لا توجد بيانات لتصديرها'); return; }
      const header = [
        "رقم تسلسلي","التاريخ والوقت","العضو","البريد","الدور","نوع الحركة",
        "نوع الكيان","معرّف الكيان","التفاصيل","معرّف السجل","IP","المتصفح الكامل"
      ];
      const data = [header];
      filteredLogs.forEach((l,idx)=>{
        data.push([
          idx+1,
          l.createdAt || '',
          l.userName || '',
          l.userEmail || '',
          l.role || '',
          l.action || '',
          l.entityType || '',
          l.entityId || '',
          l.details || '',
          l._id || '',
          l.ip || '',
          l.userAgent || ''
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(data);
      ws['!cols'] = [
        {wch:6},{wch:18},{wch:18},{wch:22},{wch:12},{wch:18},
        {wch:14},{wch:14},{wch:40},{wch:24},{wch:14},{wch:40}
      ];
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,"Activity Log");
      XLSX.writeFile(wb, `mzj-activity-log-${Date.now()}.xlsx`);
    });

    setStatus('warn','جارِ الاتصال…');
  </script>
</body>
</html>
