





<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
  <link rel="icon" type="image/x-icon" href="assets/favicon.png">
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” MZJ Cars</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<style>
  :root{
    --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280;
    --line:#e5e7eb; --line-strong:#d1d5db; --table-head:#fafafa;
    --card:#fff; --radius:14px; --ok:#16a34a; --danger:#ef4444; --info:#0ea5e9;
    --shadow:0 10px 24px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,Arial}

  /* Topbar + tabs + auth badge */
  .topbar{position:sticky;top:0;z-index:1000;background:#fff;border-bottom:1px solid var(--line)}
  .topbar-inner{max-width:1240px;margin:auto;display:flex;align-items:center;justify-content:space-between;padding:10px 16px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brown),#2a1613);
    display:grid;place-items:center;color:#fff;font-weight:800}
  .brand h1{margin:0;font-size:18px;color:var(--brown)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;text-decoration:none;color:inherit;font-weight:800;font-size:13px}
  .tab.active{background:var(--brown);border-color:var(--brown);color:#fff}
  .status-badge{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#fff;border-radius:12px;padding:6px 10px;font-size:12px}
  .dot{width:10px;height:10px;border-radius:999px;background:#f59e0b}
  .dot.ok{background:var(--ok)} .dot.err{background:var(--danger)} .dot.warn{background:#f59e0b}

  /* Buttons */
  .btn{position:relative;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:700;display:inline-flex;gap:8px;align-items:center;transition:.15s;font-size:13px}
  .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
  .btn-primary{background:var(--brown);border-color:var(--brown);color:#fff}
  .btn-beige{background:var(--beige);border-color:var(--beige);color:#fff}
  .btn-ghost{background:#fff}
  .btn-danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .btn-outline{background:#fff;border:1px solid var(--brown);color:var(--brown)}

  /* Layout */
  .container{max-width:1240px;margin:18px auto;padding:0 16px 48px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
  .section-title{display:flex;align-items:center;gap:8px;margin:0}
  .section-title svg{width:20px;height:20px;color:var(--brown)}
  .hint{color:var(--muted);font-size:12px}

  /* Inputs */
  label{font-weight:800;margin-bottom:6px;display:block;color:var(--brown);font-size:13px}
  .input-wrap{position:relative}
  .input-wrap .i{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:#9ca3af}
  .input-wrap input{padding-right:36px}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;outline:none;transition:.15s;font-family:"Tajawal",system-ui,Arial;font-size:13px}
  input:focus,select:focus,textarea:focus{border-color:var(--beige);box-shadow:0 0 0 3px rgba(188,143,116,.15)}
  #vin{height:44px} #notes{height:44px;resize:none}
  textarea{min-height:44px;resize:vertical}

  /* Grid */
  .grid{display:grid;gap:12px}
  .grid-4{grid-template-columns:repeat(4,1fr)}
  .grid-3{grid-template-columns:repeat(3,1fr)}
  .grid-2{grid-template-columns:repeat(2,1fr)}
  @media (max-width:1080px){ .grid-4{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:860px){ .grid-4,.grid-3{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:620px){ .grid-4,.grid-3,.grid-2{grid-template-columns:1fr} }
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  /* Tables */
  .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:14px;background:#fff}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:var(--table-head);z-index:2;border-bottom:1px solid var(--line-strong);
    text-align:right;color:#111827;font-size:13.5px;padding:12px 10px}
  tbody td{border-top:1px solid var(--line);padding:10px;vertical-align:top;font-size:13px}
  tbody tr:nth-child(odd){background:#fff}
  tbody tr:nth-child(even){background:#fcfcfc}
  tbody tr:hover{background:#f8fafc}
  td,th{border-left:1px solid var(--line)}
  td:last-child,th:last-child{border-left:0}
  .cell-actions{display:flex;gap:6px;flex-wrap:wrap}
  .nowrap{white-space:nowrap}
  .w-120{min-width:120px}
  .w-160{min-width:160px}

  /* Import dropdown */
  .import-menu{position:relative;display:inline-block}
  .import-dropdown{position:absolute;top:110%;left:0;background:#fff;border:1px solid var(--line);border-radius:12px;
    box-shadow:0 14px 28px rgba(0,0,0,.12);min-width:260px;z-index:20;display:none;overflow:hidden}
  .import-dropdown button{display:flex;gap:8px;align-items:center;width:100%;text-align:right;background:#fff;border:0;padding:12px 14px;cursor:pointer;font-weight:700;font-size:13px}
  .import-dropdown button:hover{background:#f9fafb}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.38);display:none;align-items:center;justify-content:center;z-index:99999;padding:12px}
  .modal{background:#fff;border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.35);width:min(520px,92vw);padding:16px;border:1px solid var(--line)}
  .modal header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .modal h3{margin:0;font-size:18px;color:var(--brown)}
  .modal .actions{display:flex;gap:8px;justify-content:flex-start;margin-top:12px}

  /* Toast */
  .toast{position:fixed;bottom:16px;right:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.25);display:none;z-index:60;font-size:13px}
  .toast.ok{background:var(--ok)} .toast.info{background:var(--info)} .toast.err{background:var(--danger)}

  /* Auth */
  .auth-wrap{min-height:60vh;display:grid;place-items:center;padding:24px}
  .auth-card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:18px;max-width:420px;width:96%}
  .auth-card h2{margin:0 0 10px;color:var(--brown)}
  .auth-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

  /* Checklist box */
  .checklist{border:1px dashed var(--beige);border-radius:12px;padding:12px;background:#fff8ef}
  .checklist h4{margin:0 0 8px 0;color:var(--brown);font-size:14px}
  .check-row{display:grid;grid-template-columns:18px 1fr;gap:8px;align-items:start}
  .check-row label{margin:0;display:flex;align-items:center;gap:8px;font-weight:600;font-size:13px}

  /* Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„: ØµÙÙˆÙ Ù…ØªØ¹Ø¯Ø¯Ø© */
  .move-row{border:1px dashed #e5e7eb;border-radius:10px;padding:8px 10px;background:#fffbf7}
  .move-row-title{font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:600}

  /* Ø¥Ø´Ø¹Ø§Ø± Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„ */
  .move-alert{
    margin-top:10px;
    padding:10px 12px;
    border-radius:12px;
    display:none;
    align-items:flex-start;
    gap:10px;
    font-size:13px;
  }
  .move-alert .icon{
    margin-top:3px;
    font-size:16px;
  }
  .move-alert .title{
    font-weight:800;
    margin-bottom:4px;
    font-size:13.5px;
  }
  .move-alert ul{
    margin:0;
    padding-right:18px;
    list-style:disc;
  }
  .move-alert.success{
    background:#ecfdf3;
    border:1px solid #bbf7d0;
    color:#14532d;
  }
  .move-alert.error{
    background:#fef2f2;
    border:1px solid #fecaca;
    color:#991b1b;
  }
  .move-alert.info{
    background:#eff6ff;
    border:1px solid #bfdbfe;
    color:#1d4ed8;
  }

  .copyable{cursor:pointer;text-decoration:underline;text-decoration-style:dotted}

  .inner-tabs{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-bottom:16px;
  }
  .inner-tab{
    border:1px solid var(--line);
    background:#fff;
    padding:6px 14px;
    border-radius:999px;
    font-size:14px;
    cursor:pointer;
    color:var(--text);
  }
  .inner-tab.active{
    background:var(--brown);
    color:#fff;
    border-color:var(--brown);
  }
  .inner-tab-panel{display:none;}
  .inner-tab-panel.active{display:block;}

  .move-row-title{
    font-weight:600;
    margin-bottom:4px;
    color:var(--brown);
  }
  .move-notes{
    width:100%;
    min-height:48px;
    resize:vertical;
  }


  .notes-col{
    display:none;
  }

  /* ===== Track current place bar ===== */
  .place-bar{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:999px;
    background:#fff;
    box-shadow:0 8px 24px rgba(0,0,0,.04);
  }
  .place-bar .dot{width:10px;height:10px;border-radius:50%;background:var(--beige); flex:0 0 auto;}
  .place-bar .text{font-weight:800;color:var(--brown); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1;}
  .place-bar .hint{font-size:12px;color:var(--muted); white-space:nowrap;}
</style>
<style id="noFlash">
  html{background:#fff8ef;}
  body{opacity:0;}
</style>
  <link rel="stylesheet" href="./mzj-ui.css" />

<style>
  .legacy-admin .dashboard-topbar,
  .legacy-admin .topbar,
  .legacy-admin .tabs,
  .legacy-admin .nav-tabs,
  .legacy-admin .nav-pills,
  .legacy-admin header:not(.mzj-topbar){
    display:none !important;
  }
</style>

</head>
<body class="mzj">

<header class="mzj-topbar">
  <div class="topbar-left">
    <button class="icon-btn" id="mzjSidebarBtn" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"><i class="fa-solid fa-bars"></i></button>
    <div class="brand">
      <div class="brand-mark">MZJ</div>
      <div class="brand-text">
        <div class="brand-title">Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</div>
        <div class="brand-sub">Workspace</div>
      </div>
    </div>
  </div>
  <div class="topbar-center">
    <div class="mzj-breadcrumb">
      <span class="crumb">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
      <i class="fa-solid fa-chevron-left"></i>
      <span class="crumb current">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
    </div>
  </div>
  <div class="topbar-right">
    <div class="mzj-chip"><i class="fa-regular fa-clock"></i><span id="mzjNow">â€”</span></div>
    <button id="btnSignOut" class="btn btn-ghost" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</header>

<div class="mzj-shell" id="mzjShell">
  <aside class="mzj-sidebar" id="mzjSidebar">
    <div class="side-section">
      <div class="side-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
      <nav class="side-nav">
        <a class="side-link tab" href="./sales.html"><i class="fa-solid fa-handshake"></i><span>ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span></a>
          <a class="side-link tab" href="./dashboard.html"><i class="fa-solid fa-gauge"></i><span>Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</span></a>
          <a class="side-link tab" href="./inventory.html"><i class="fa-solid fa-boxes-stacked"></i><span>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span></a>
          <a class="side-link tab" href="./vt.html"><i class="fa-solid fa-right-left"></i><span>Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span></a>
          <a class="side-link tab" href="./photoshoot-user.html"><i class="fa-solid fa-camera"></i><span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span></a>
          <a class="side-link tab" href="./cars.html"><i class="fa-solid fa-car"></i><span>ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span></a>
          <a class="side-link tab active" href="./admin.html"><i class="fa-solid fa-shield-halved"></i><span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span></a>
          <a class="side-link tab" href="./Activity.html"><i class="fa-solid fa-clipboard-list"></i><span>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</span></a>

      </nav>
    </div>
  </aside>

  <div class="mzj-backdrop" id="mzjBackdrop"></div>

  <main class="mzj-content">
    <div class="legacy legacy-admin">

<!-- Topbar -->
<div class="topbar">
<div class="topbar-inner">
<div class="brand">
<div class="logo" title="MZJ">MZJ</div>
<div>
<h1>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h1>
<small class="hint">Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</small>
</div>
</div>
<div class="tabs">
<a class="tab active" href="admin.html">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
<a class="tab" href="inventory.html">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</a>
<a class="tab" href="dashboard.html">Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</a>
<a class="tab" href="vt.html">Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</a>
<a class="tab" href="photoshoot-user.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
<a class="tab" href="cars.html">ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</a>
<a class="tab" href="Activity.html">Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</a>
</div>
<div class="row">
<div class="status-badge"><span class="dot warn" id="connDot"></span><span id="connText">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦</span></div>
<button id="btnSignOut" class="btn btn-ghost" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button></div>
</div>
</div>
<!-- Auth Gate -->
<div class="auth-wrap" id="authGate">
<div class="auth-card">
<h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
<label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
<input id="email" placeholder="you@example.com" type="email"/>
<label for="password" style="margin-top:8px">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
<input id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" type="password"/>
<div class="auth-actions">
<button class="btn btn-primary" id="btnLogin">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
<button class="btn btn-outline" id="btnSignup">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
</div>
<p class="hint" id="authHint" style="margin-top:10px"></p>
</div>
</div>
<!-- App -->
<div id="app" style="display:none">
<div class="container">
<div class="inner-tabs">
<button class="inner-tab active" data-target="tab-add">Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø©</button>
<button class="inner-tab" data-target="tab-move">Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</button>
<button class="inner-tab" data-target="tab-edit">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</button>
<button class="inner-tab" data-target="tab-track">ØªØªØ¨Ø¹ Ø­Ø±ÙƒØ© Ø±Ù‚Ù… Ù‡ÙŠÙƒÙ„</button>
<button class="inner-tab" data-target="tab-log">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</button>
</div>
<div class="inner-tab-panel active" id="tab-add">
<div class="card">
<div class="card-header">
<div class="section-title">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><rect height="7" width="7" x="3" y="3"></rect><rect height="7" width="7" x="14" y="3"></rect><rect height="7" width="7" x="14" y="14"></rect><rect height="7" width="7" x="3" y="14"></rect></svg>
<h2 style="margin:0">Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø©</h2>
</div>
<div class="row">
<button class="btn btn-ghost" id="btnExport" title="ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel">
<i class="fa-regular fa-file-excel"></i> ØªØµØ¯ÙŠØ±
          </button>
<!-- Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø²Ø± ØªØµØ¯ÙŠØ± Ù‚Ø§Ù„Ø¨ ÙØ§Ø¶ÙŠ -->
<button class="btn btn-ghost" id="btnExportBlank" title="ØªØµØ¯ÙŠØ± Ù‚Ø§Ù„Ø¨ ÙØ§Ø¶ÙŠ">
<i class="fa-regular fa-file"></i> ØªØµØ¯ÙŠØ± Ù‚Ø§Ù„Ø¨ ÙØ§Ø¶ÙŠ
          </button>
<div class="import-menu">
<button class="btn btn-ghost" id="btnImportMenu" title="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel">
<i class="fa-solid fa-file-import"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ â–¾
            </button>
<div class="import-dropdown" id="importDropdown">
<button data-mode="replace"><i class="fa-solid fa-arrow-rotate-left"></i> Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒØ§Ù…Ù„ (Ù…Ø³Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ… + Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯)</button>
<button data-mode="append"><i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ÙÙˆÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø­)</button>
<button data-mode="update"><i class="fa-solid fa-wrench"></i> ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ø´ÙŠØª (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙ‚Ø·)</button>
</div>
</div>
<input accept=".xlsx,.xls,.csv" id="fileImport" style="display:none" type="file"/>
</div>
</div>
<div class="grid grid-4">
<div>
<label for="carSelect">Ø³ÙŠØ§Ø±Ø©</label>
<div class="row" style="gap:8px;align-items:stretch">
<select id="carSelect" title="Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø©"></select>
<button class="btn btn-outline" id="btnAddModel" title="Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¯ÙŠÙ„ Ø¬Ø¯ÙŠØ¯">
<i class="fa-solid fa-plus"></i> Ù…ÙˆØ¯ÙŠÙ„
            </button>
</div>
</div>
<div>
<label for="variantSelect">Ø§Ù„Ø¨ÙŠØ§Ù†</label>
<div class="row" style="gap:8px;align-items:stretch">
<select id="variantSelect" title="Ø§Ø®ØªØ± Ø§Ù„Ø¨ÙŠØ§Ù†"></select>
<button class="btn btn-outline" id="btnAddVariant" title="Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù† ÙˆØ±Ø¨Ø·Ù‡ Ø¨Ø³ÙŠØ§Ø±Ø©">
<i class="fa-solid fa-plus"></i> Ø¨ÙŠØ§Ù†
            </button>
</div>
<div class="hint">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù† Ø¬Ø¯ÙŠØ¯ ÙˆØ±Ø¨Ø·Ù‡ Ø¨Ø£ÙŠ Ø³ÙŠØ§Ø±Ø©</div>
</div>
<div><label for="dealer">Ø§Ù„ÙˆÙƒÙŠÙ„</label>
<div class="input-wrap">
<span class="i"><i class="fa-regular fa-building"></i></span>
<input id="dealer" placeholder="Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„"/>
</div>
</div>
<div><label for="extColor">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</label>
<div class="input-wrap">
<span class="i"><i class="fa-regular fa-circle"></i></span>
<input id="extColor" placeholder="Ø£Ø¨ÙŠØ¶ / Ø£Ø³ÙˆØ¯ ..."/>
</div>
</div>
<div><label for="intColor">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</label>
<div class="input-wrap">
<span class="i"><i class="fa-regular fa-square"></i></span>
<input id="intColor" placeholder="Ø¬Ù…Ù„ÙŠ / Ø£Ø³ÙˆØ¯ ..."/>
</div>
</div>
<div><label for="modelYear">Ù…ÙˆØ¯ÙŠÙ„</label>
<div class="input-wrap">
<span class="i"><i class="fa-regular fa-calendar"></i></span>
<input id="modelYear" max="2100" min="2000" placeholder="2026" type="number"/>
</div>
</div>
<div><label for="plate">Ø§Ù„Ù„ÙˆØ­Ø©</label>
<div class="input-wrap">
<span class="i"><i class="fa-regular fa-id-card"></i></span>
<input id="plate" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"/>
</div>
</div>
<!-- Ø§Ù„Ù…ÙƒØ§Ù†: Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø© Ø«Ø§Ø¨ØªØ© -->
<div>
<label for="location">Ø§Ù„Ù…ÙƒØ§Ù†</label>
<select id="location" title="Ø§Ø®ØªØ± Ø§Ù„Ù…ÙƒØ§Ù†">
<option value="Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­</option>
<option value="Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
<option value="Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
<option value="Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
<option value="Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­">Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­</option>
<option value="Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª">Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
<option value="Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…">Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
<option value="Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…">Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
<option value="ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­">ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­</option>
<option value="ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª">ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
<option value="ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…">ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
<option value="ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…">ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
<option value="ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­">ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­</option>
<option value="ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª">ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
<option value="ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…">ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
<option value="ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…">ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
<option value="ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­">ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­</option>
<option value="ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª">ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
<option value="ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…">ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
<option value="ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…">ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
</select>
</div>
<div><label for="batchName">Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø©</label>
<div class="input-wrap">
<span class="i"><i class="fa-solid fa-layer-group"></i></span>
<input id="batchName" placeholder="Ø¯ÙØ¹Ø© Ø±Ù…Ø¶Ø§Ù† / Ù†ÙˆÙÙ…Ø¨Ø± 2025â€¦"/>
</div>
</div>
<div><label for="vin">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</label>
<div class="input-wrap">
<span class="i"><i class="fa-solid fa-barcode"></i></span>
<input id="vin" placeholder="LVR.../KMH.../Ø±Ù‚Ù…"/>
</div>
</div>
<div class="grid" style="grid-template-columns:1fr">
<label for="notes">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
<textarea id="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© â€” Ù†ÙØ³ Ø§Ø±ØªÙØ§Ø¹ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„"></textarea>
</div>
</div>
<div class="row" style="margin-top:12px">
<button class="btn btn-primary" id="btnSave" title="Ø­ÙØ¸ (Ctrl+S)">
<i class="fa-regular fa-floppy-disk"></i> Ø­ÙØ¸
        </button>
<button class="btn btn-ghost" id="btnReset" title="ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ (Esc)">
<i class="fa-solid fa-rotate"></i> ØªÙØ±ÙŠØº
        </button>
<div class="hint"></div>
</div>
</div>
</div>
<div class="inner-tab-panel" id="tab-move">
<div class="card">
<div class="card-header">
<div class="section-title">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M7 10l5-5 5 5"></path><path d="M7 14l5 5 5-5"></path></svg>
<h2 style="margin:0">Ø­Ø±ÙƒØ© Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª (Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„)</h2>
</div>
<span class="hint"> <b></b> </span>
<div class="row" style="gap:8px;align-items:center;flex-wrap:wrap"><label>Ø¥Ù„Ù‰</label><select id="moveToGlobal" title="Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯"></select></div></div>
<!-- 8 ØµÙÙˆÙ Ù†Ù‚Ù„ -->
<div class="row" style="margin:8px 0 12px;gap:8px;align-items:center;flex-wrap:wrap"><button class="btn btn-ghost" id="btnAddMoveRow" type="button"><i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© Ø£Ø®Ø±Ù‰</button></div><div class="grid" id="moveRowsContainer" style="gap:10px"></div>
<!-- datalist Ù„Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª -->
<datalist id="vinHints"></datalist>
<!-- Checklist ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù…Ø¹ 'Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…' -->
<div class="checklist" id="underDeliveryBox" style="display:none; margin-top:10px">
<h4>Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ <b>Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</b></h4>
<div class="grid grid-2">
<div>
<div class="check-row">
<input id="chkAdminApproved" type="checkbox"/>
<label for="chkAdminApproved">Ù…ÙˆØ§ÙÙ‚Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©</label>
</div>
<label for="adminNotes" style="margin-top:6px">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</label>
<textarea id="adminNotes" placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©â€¦"></textarea>
</div>
<div>
<div class="check-row">
<input id="chkFinanceApproved" type="checkbox"/>
<label for="chkFinanceApproved">Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ø§Ù„ÙŠØ©</label>
</div>
<label for="financeNotes" style="margin-top:6px">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</label>
<textarea id="financeNotes" placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø§Ù„ÙŠØ©â€¦"></textarea>
</div>
</div>
</div>
<!-- Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
<div class="row" style="margin-top:12px">
<button class="btn btn-ghost" id="btnFindByVin" title="Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ø£ÙˆÙ„ Ø³Ø·Ø± ØºÙŠØ± ÙØ§Ø±Øº)">
<i class="fa-solid fa-magnifying-glass"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
<button class="btn btn-primary" id="btnMove" title="ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‚Ù„">
<i class="fa-solid fa-right-left"></i> Ù†Ù‚Ù„
        </button>
</div>
<p class="hint" id="moveStatus" style="margin-top:8px"></p>
<!-- Ø¥Ø´Ø¹Ø§Ø± Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„ÙƒØ¨ÙŠØ± -->
<div class="move-alert" id="moveAlert">
<div class="icon">
<i class="fa-solid fa-circle-check"></i>
</div>
<div>
<div class="title" id="moveAlertTitle">Ù†ØªÙŠØ¬Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„</div>
<ul id="moveAlertList"></ul>
</div>
</div>
<!-- Ø¨Ø·Ø§Ù‚Ø© Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
<div class="card" id="carDetailsBox" style="display:none;margin-top:12px">
<div class="section-title">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><rect height="16" rx="2" width="18" x="3" y="4"></rect><path d="M7 8h10"></path></svg>
<h2 style="margin:0">Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h2>
</div>
<div class="grid grid-2" id="carDetails" style="margin-top:8px"></div>
<p class="hint" id="carDetailsHint" style="margin-top:8px"></p>
</div>
</div>
</div>
<div class="inner-tab-panel" id="tab-edit">
<div class="card">
<div class="card-header">
<div class="section-title">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><rect height="16" rx="2" width="18" x="3" y="4"></rect><path d="M7 8h10"></path></svg>
<h2 style="margin:0">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h2>
</div>
<span class="hint"></span>
</div>
<div class="row" style="gap:8px;margin-bottom:8px">
<input id="search" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ (Ø³ÙŠØ§Ø±Ø© / Ø§Ù„Ø¨ÙŠØ§Ù† / Ø§Ù„ÙˆÙƒÙŠÙ„ / Ø§Ù„Ø£Ù„ÙˆØ§Ù† / Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ / Ø§Ù„Ù„ÙˆØ­Ø© / Ø§Ù„Ù…ÙƒØ§Ù† / Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø© / Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„)" style="flex:1; padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff" title="Ø§Ø¶ØºØ· / Ù„Ù„Ø¨Ø­Ø«"/>
<button class="btn btn-ghost" id="btnClearSearch" title="Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«">
<i class="fa-solid fa-minus"></i> Ù…Ø³Ø­
        </button>
</div>
<div class="table-wrap">
<table id="carsTable">
<thead>
<tr>
<th>Ø³ÙŠØ§Ø±Ø©</th>
<th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
<th>Ø§Ù„ÙˆÙƒÙŠÙ„</th>
<th>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</th>
<th>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</th>
<th>Ù…ÙˆØ¯ÙŠÙ„</th>
<th>Ø§Ù„Ù„ÙˆØ­Ø©</th>
<th>Ø§Ù„Ù…ÙƒØ§Ù†</th>
<th>Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø©</th>
<th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</th>
<th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
<th class="w-160">ØªØ­ÙƒÙ…</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<p class="hint">Ø§Ù„Ø­ÙØ¸ ÙŠØªÙ… Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ Firestore.</p>
</div>
</div>
<div class="inner-tab-panel" id="tab-track">
<div class="card">
<div class="card-header">
<div class="section-title">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M12 8v8M8 12h8"></path></svg>
<h2 style="margin:0">ØªØªØ¨Ù‘Ø¹ Ø­Ø±ÙƒØ© Ø±Ù‚Ù… Ù‡ÙŠÙƒÙ„</h2>
</div>
<div class="row" style="gap:8px">
<input id="trackVin" list="vinHints" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù„Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø­Ø±ÙƒØ§ØªÙ‡"/>
<button class="btn btn-ghost" id="btnClearTrack">Ù…Ø³Ø­</button>
</div>
<div id="trackPlaceBar" class="place-bar" style="display:none;margin-top:10px">
  <span class="dot"></span>
  <div class="text"></div>
  <div class="hint"></div>
</div>
</div>
<div class="table-wrap">
<table id="trackTable">
<thead>
<tr>
<th class="w-120">#</th>
<th class="w-120">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
<th>Ù…Ù†</th>
<th>Ø¥Ù„Ù‰</th>
<th>Ø³ÙŠØ§Ø±Ø©</th>
<th class="w-160">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù†Ù‚Ù„</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<p class="hint"></p>
</div>
</div>
<div class="inner-tab-panel" id="tab-log">
<div class="card">
<div class="card-header">
<div class="section-title" style="margin-bottom:0">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M3 5h18M3 12h18M3 19h18"></path></svg>
<h2 style="margin:0">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h2>
</div>
<div class="row">
<div class="row">
<label style="margin:0 6px 0 0">ØªØ§Ø±ÙŠØ® Ù…Ù†</label>
<input id="movesFromDate" type="date"/>
</div>
<div class="row">
<label style="margin:0 6px 0 0">Ø¥Ù„Ù‰</label>
<input id="movesToDate" type="date"/>
</div>
<button class="btn btn-ghost" id="btnClearDate">Ù…Ø³Ø­ Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
</div>
</div>
<div class="table-wrap">
<table id="movesTable">
<thead>
<tr>
<th class="w-120">#</th>
<th class="w-120">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
<th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</th>
<th>Ø³ÙŠØ§Ø±Ø©</th>
<th>Ù…Ù†</th>
<th>Ø¥Ù„Ù‰</th>
<th class="w-120">ID</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="row" style="margin-top:8px">
<button class="btn btn-ghost" id="btnClearMoves" title="ØªÙØ±ÙŠØº Ø§Ù„Ø³Ø¬Ù„">
<i class="fa-regular Ù-trash-can"></i> ØªÙØ±ÙŠØº
        </button>
</div>
</div>
</div>
</div>
<!-- Modals -->
<!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¯ÙŠÙ„ -->
<div class="modal-backdrop" id="modelModal">
<div aria-modal="true" class="modal" role="dialog">
<header>
<h3>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¯ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>
<button class="btn btn-ghost" data-close="modelModal"><i class="fa-solid fa-xmark"></i></button>
</header>
<label for="modelName">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
<input id="modelName" placeholder="Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ ØªÙˆØ³Ø§Ù† 2026 / Ø³Ù†ØªØ§ÙÙŠâ€¦"/>
<div class="actions">
<button class="btn btn-primary" id="confirmAddModel"><i class="fa-solid fa-check"></i> Ø¥Ø¶Ø§ÙØ©</button>
<button class="btn" data-close="modelModal">Ø¥Ù„ØºØ§Ø¡</button>
</div>
</div>
</div>
<!-- Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù† -->
<div class="modal-backdrop" id="variantModal">
<div aria-modal="true" class="modal" role="dialog">
<header>
<h3>Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù† ÙˆØ±Ø¨Ø·Ù‡ Ø¨Ù…ÙˆØ¯ÙŠÙ„</h3>
<button class="btn btn-ghost" data-close="variantModal"><i class="fa-solid fa-xmark"></i></button>
</header>
<label for="variantModelFor">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
<select id="variantModelFor"></select>
<label for="variantName" style="margin-top:8px">Ø§Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†</label>
<input id="variantName" placeholder="ÙƒÙˆÙ…ÙÙˆØ±Øª / Ø³Ù…Ø§Ø±Øª / Ø±ÙˆÙŠØ§Ù„â€¦"/>
<div class="actions">
<button class="btn btn-primary" id="confirmAddVariant"><i class="fa-solid fa-check"></i> Ø¥Ø¶Ø§ÙØ©</button>
<button class="btn" data-close="variantModal">Ø¥Ù„ØºØ§Ø¡</button>
</div>
</div>
</div>

<!-- ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ø´ÙŠØª (Ø§Ø®ØªÙŠØ§Ø± Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«) -->
<div class="modal-backdrop" id="updateModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <header>
      <h3>ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ø´ÙŠØª</h3>
      <button class="btn btn-ghost" data-close="updateModal"><i class="fa-solid fa-xmark"></i></button>
    </header>

    <div style="margin-bottom:10px;color:#555;font-size:13px;line-height:1.7">
      Ø§Ø®ØªØ± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù„ÙŠ ØªØ­Ø¨ ØªØ­Ø¯Ù‘Ø«Ù‡Ø§. (Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„ÙØ§Ø¶ÙŠØ© ÙÙŠ Ø§Ù„Ø´ÙŠØª Ù…Ø§ ØªÙ…Ø³Ø­Ø´ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
    </div>

    <div id="updateFieldsBox" class="grid grid-2" style="gap:10px;margin:10px 0 14px 0"></div>

    <div class="actions" style="justify-content:flex-end;flex-wrap:wrap">
      <button class="btn btn-ghost" id="btnUpdateSelectAll" type="button"><i class="fa-solid fa-check-double"></i> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
      <button class="btn btn-primary" id="confirmUpdateFields" type="button"><i class="fa-solid fa-check"></i> ØªÙ†ÙÙŠØ°</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js">
  function showUpdateReportButton(){
    let btn = document.getElementById('btnUpdateReport');
    if(!btn){
      btn = document.createElement('button');
      btn.id = 'btnUpdateReport';
      btn.className = 'btn btn-soft';
      btn.style.marginTop = '8px';
      btn.innerHTML = '<i class="fa-solid fa-file-lines"></i> Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ø¯ÙŠØ«';
      btn.onclick = openUpdateReport;
      document.querySelector('.toast-wrap')?.appendChild(btn);
    }
  }

  function openUpdateReport(){
    if(!__lastUpdateReport){ showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ± Ù…ØªØ§Ø­','info'); return; }
    const rows = [];
    __lastUpdateReport.updated.forEach(v=> rows.push({VIN:v, Status:'Updated'}));
    __lastUpdateReport.notFound.forEach(v=> rows.push({VIN:v, Status:'Not Found'}));
    __lastUpdateReport.skipped.forEach(v=> rows.push({VIN:v, Status:'Skipped'}));

    // build CSV
    let csv = 'VIN,Status\n';
    rows.forEach(r=>{ csv += `"${r.VIN}","${r.Status}"\n`; });

    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'update_report.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import {getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, updateDoc} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  /* ===== Firebase ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const STATE_REF = doc(db, "mzj_admin_state", "v1");
  
  // ===== Firestore helpers (fix missing wrappers) =====
  const mzjSetDoc = (...args) => setDoc(...args);
  const mzjUpdateDoc = (...args) => updateDoc(...args);
  const clean = (v)=> String(v ?? '')
    .replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069]/g,'')
    .replace(/\s+/g,' ')
    .trim();

/* ===== Roles & Permissions (Firestore) ===== */
  const ROLE_ADMIN   = 'Ø§Ù„Ø§Ø¯Ø§Ø±Ø©';
  const ROLE_IDARI   = 'Ø§Ø¯Ø§Ø±ÙŠ';
  const ROLE_BRANCH  = 'Ù…Ø¯Ø±Ø§Ø¡ ÙØ±ÙˆØ¹';

  // Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© admin.html Ù…Ø³Ù…ÙˆØ­Ø© ÙÙ‚Ø· Ù„ØªØµÙ†ÙŠÙ "Ø§Ù„Ø§Ø¯Ø§Ø±Ø©"
  const PAGE_ALLOWED_ROLES = [ROLE_ADMIN];

  async function fetchUserRole(user){
    try{
      // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ÙƒÙˆÙ„ÙƒØ´Ù† Ø§Ø³Ù…Ù‡ "user" (Ù…ÙØ±Ø¯) Ø­Ø³Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ùƒ ÙÙŠ Firestore
      const userDocRef = doc(db, 'user', user.uid);
      const snap = await getDoc(userDocRef);
      if(snap.exists()){
        const data = snap.data() || {};
        return data.role || null;
      }
      return null;
    }catch(err){
      console.error('Error fetching user role:', err);
      return null;
    }
  }


  /* ===== Helpers / State ===== */
  const $ = s => document.querySelector(s);
  const toast = $('#toast');
  function showToast(msg,type='ok'){toast.textContent=msg;toast.className='toast '+type;toast.style.display='block';setTimeout(()=>toast.style.display='none',1800)}
  function pad(n){return n<10?'0'+n:n}
  function now(){const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;}
  function onlyDate(str){
    return (str||'').toString().slice(0,10);
  }
  function toDateObj(val){
    if(!val) return null;
    try{
      if(val instanceof Date) return val;
      if(typeof val === 'number' && isFinite(val)) return new Date(val);
      if(typeof val === 'string'){
        const s = val.trim();
        if(!s) return null;
        const d = new Date(s);
        if(!isNaN(d)) return d;
        // try yyyy-mm-dd
        if(/^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s.slice(0,10));
        return null;
      }
      if(typeof val === 'object'){
        if(typeof val.toDate === 'function'){
          const d = val.toDate();
          if(d instanceof Date && !isNaN(d)) return d;
        }
        if(typeof val.seconds === 'number'){
          const ms = (val.seconds*1000) + Math.floor((val.nanoseconds||0)/1e6);
          const d = new Date(ms);
          if(!isNaN(d)) return d;
        }
        if(typeof val._seconds === 'number'){
          const d = new Date(val._seconds*1000);
          if(!isNaN(d)) return d;
        }
      }
    }catch(e){}
    return null;
  }
  function getMoveDateObj(m){
    if(!m) return null;
    return toDateObj(m.when || m.createdAt || m.timestamp || m.time || m.at || m.date);
  }
  function fmtDateOnlyFromMove(m){
    const d = getMoveDateObj(m);
    if(d) return d.toISOString().slice(0,10);
    return (m && (m.date || onlyDate(m.when||''))) || '';
  }
  function compareMovesNewestFirst(a,b){
    const da = getMoveDateObj(a);
    const db = getMoveDateObj(b);
    const ta = da?da.getTime():-1;
    const tb = db?db.getTime():-1;
    return tb - ta;
  }

  // ===== stock place helpers (same logic as ØµÙØ­Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†) =====
  function pickVinFromStockRow(s){
    if(!s) return '';
    const candidates = [
      s.vin, s.VIN, s.chassis, s.chassisNo, s.vinNumber,
      s['Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„'], s['Ø±Ù‚Ù…_Ø§Ù„Ù‡ÙŠÙƒÙ„'], s['chassis_no'],
      s.idVin, s.vin_no
    ];
    for(const c of candidates){
      const v = normalizeVin(String(c||''));
      if(v) return v;
    }
    return '';
  }
  function pickPlaceFromStockRow(s){
    if(!s) return '';
    const candidates = [
      s.place, s.location, s.branch, s.currentPlace, s.placeText,
      s['Ø§Ù„Ù…ÙƒØ§Ù†'], s['Ù…ÙƒØ§Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø©'], s['Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ']
    ];
    for(const c of candidates){
      const p = String(c||'').trim();
      if(p) return p;
    }
    return '';
  }
  function pickUpdatedAtFromStockRow(s){
    if(!s) return null;
    return toDateObj(s.updatedAt || s.updated_at || s.lastUpdate || s.lastUpdated || s.modifiedAt || s.modified_at || s.ts || s.time);
  }
  function buildStockIndex(){
    const byVin = new Map();
    (Array.isArray(stock)?stock:[]).forEach(s=>{
      const v = pickVinFromStockRow(s);
      if(!v) return;
      byVin.set(v, s);
    });
    return byVin;
  }

  function normalizeVin(v){if(!v)return'';const ar={'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};return v.toString().replace(/[Ù -Ù©]/g,d=>ar[d]).toUpperCase().replace(/[\s\-\._]/g,'').trim()}
  function nextId(){return stock.length?Math.max(...stock.map(r=>Number(r.id)||0))+1:1}
  function debounce(fn,wait=250){let t;return (...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),wait)};}

  let stock=[], moves=[], models=[], variantsMap={};

  function liftNoFlash(){
  const nf = document.getElementById('noFlash');
  if(nf) nf.remove();
  document.body.style.opacity = '1';
}
/* ===== DOM refs ===== */
  const connDot=$('#connDot'), connText=$('#connText');
  const authGate=$('#authGate'), appRoot=$('#app'), btnSignOut=$('#btnSignOut');
  const emailEl=$('#email'), passEl=$('#password'), btnLogin=$('#btnLogin'), btnSignup=$('#btnSignup'), authHint=$('#authHint');

  const carSelect=$('#carSelect'), variantSelect=$('#variantSelect');
  const dealerInput=$('#dealer'), extColorInput=$('#extColor'), intColorInput=$('#intColor');
  const modelYearInput=$('#modelYear'), plateInput=$('#plate'), locationSelect=$('#location'), batchNameInput=$('#batchName');
  const vinInput=$('#vin'), notesInput=$('#notes');
  const btnSave=$('#btnSave'), btnReset=$('#btnReset');

  const btnImportMenu=$('#btnImportMenu'), importDropdown=$('#importDropdown'), fileImport=$('#fileImport'), btnExport=$('#btnExport'), btnExportBlank=$('#btnExportBlank');

  const searchInput=$('#search'), btnClearSearch=$('#btnClearSearch'), tableBody=document.querySelector('#carsTable tbody');
  const movesTableBody=document.querySelector('#movesTable tbody'), btnClearMoves=$('#btnClearMoves');

  // Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª â€” ÙÙ„Ø§ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
  const movesFromDate=$('#movesFromDate'), movesToDate=$('#movesToDate'), btnClearDate=$('#btnClearDate');

  // ØªØªØ¨Ø¹ VIN
  const trackVin=$('#trackVin'), trackPlaceBar=$('#trackPlaceBar'), trackTableBody=document.querySelector('#trackTable tbody'), btnClearTrack=$('#btnClearTrack');

  // Modals
  const modelModal = $('#modelModal');
  const variantModal = $('#variantModal');
  const btnAddModel=$('#btnAddModel'), btnAddVariant=$('#btnAddVariant');
  const modelNameEl = $('#modelName');
  const confirmAddModel = $('#confirmAddModel');

  const variantModelForEl = $('#variantModelFor');
  const variantNameEl = $('#variantName');
  const confirmAddVariant = $('#confirmAddVariant');

  // Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„ (Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„ØµÙÙˆÙ)
  const moveRowsContainer = document.querySelector('#moveRowsContainer');
  const btnAddMoveRow = document.querySelector('#btnAddMoveRow');
  const moveToGlobal = document.querySelector('#moveToGlobal');
  const btnFindByVin=$('#btnFindByVin'), btnMove=$('#btnMove');
  const moveStatus=$('#moveStatus'), carDetailsBox=$('#carDetailsBox'), carDetails=$('#carDetails'), carDetailsHint=$('#carDetailsHint');

  const underDeliveryBox=$('#underDeliveryBox');
  const chkAdminApproved=$('#chkAdminApproved'), adminNotes=$('#adminNotes');
  const chkFinanceApproved=$('#chkFinanceApproved'), financeNotes=$('#financeNotes');

  // datalist Ù„Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
  const vinHints = $('#vinHints');

  // Ø¥Ø´Ø¹Ø§Ø± Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„ÙƒØ¨ÙŠØ±
  const moveAlert = $('#moveAlert');
  const moveAlertTitle = $('#moveAlertTitle');
  const moveAlertList  = $('#moveAlertList');

  /* ===== Connection status ===== */
  function setStatus(mode, txt){
    connDot.className='dot '+(mode==='ok'?'ok':mode==='err'?'err':'warn');
    connText.textContent = txt;
  }

  /* ===== Auth Gate ===== */
  
  onAuthStateChanged(auth, async (user)=>{
  if(user){
    try{
      const role = await fetchUserRole(user);
    window.__mzjUserRole = role || null;
      if(!role || !PAGE_ALLOWED_ROLES.includes(role)){
        window.location.href = 'unauthorized.html';
        return;
      }
      authGate.style.display = 'none';
      appRoot.style.display  = 'block';
      btnSignOut.style.display = 'inline-flex';
      setStatus('ok', `Ù…ØªØµÙ„: ${user.email} â€” Ø§Ù„Ø¯ÙˆØ±: ${role}`);
      liftNoFlash();
      await initData();
      subscribeLive();
    }catch(err){
      console.error(err);
      setStatus('err','Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      liftNoFlash();
    }
  }else{
    appRoot.style.display   = 'none';
    authGate.style.display  = 'grid';
    btnSignOut.style.display = 'none';
    setStatus('warn','Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    liftNoFlash();
  }
});
btnLogin.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{ await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
    catch(e){ authHint.textContent='ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: '+(e?.message||e); }
  });
  btnSignup.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{ await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
    catch(e){ authHint.textContent='ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: '+(e?.message||e); }
  });
  btnSignOut.addEventListener('click', ()=> signOut(auth));

  /* ===== Data init / subscribe ===== */
  async function initData(){
    try{
      const s=await getDoc(STATE_REF);
      if(s.exists()){
        const d=s.data()||{};
        stock = Array.isArray(d.stock)? d.stock: [];
        moves = Array.isArray(d.moves)? d.moves: [];
        models = Array.isArray(d.models)? d.models: [];
        variantsMap = d.variantsMap || {};
      }else{
        stock=[]; moves=[]; models=[]; variantsMap={};
      }
      loadModelsIntoSelects();
      if(carSelect.value) populateVariants(carSelect.value);
      renderTable(); renderMoves(); renderTrack();
      fillMoveLists();
      updateRequirementBoxes();
      setStatus('ok','ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }catch(e){ setStatus('warn','ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); }
  }
  function subscribeLive(){
    try{
      onSnapshot(STATE_REF,(snap)=>{
        if(!snap.exists()) return;
        const d=snap.data()||{};
        stock = Array.isArray(d.stock)? d.stock: stock;
        moves = Array.isArray(d.moves)? d.moves: moves;
        models= Array.isArray(d.models)? d.models: models;
        variantsMap = d.variantsMap || variantsMap;
        loadModelsIntoSelects();
        if(carSelect.value) populateVariants(carSelect.value);
        renderTable(); renderMoves(); renderTrack();
        fillMoveLists();
        updateRequirementBoxes();
        setStatus('ok','Ù…Ø²Ø§Ù…Ù†Ø© Ø­ÙŠÙ‘Ø©');
      },()=> setStatus('warn','Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§'));
    }catch(e){}
  }
  async function persistAll(){
    try{
      await mzjSetDoc(STATE_REF, { stock, moves, models, variantsMap, updatedAt: now() }, { merge:true });
      setStatus('ok','ØªÙ… Ø§Ù„Ø­ÙØ¸');
    }catch(e){
      setStatus('err','ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸'); showToast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©','err');
    }
  }

  /* ===== Models / Variants ===== */
  function loadModelsIntoSelects(){
    carSelect.innerHTML='';
    models.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; carSelect.appendChild(o); });
    variantModelForEl.innerHTML='';
    models.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; variantModelForEl.appendChild(o); });
  }
  function populateVariants(modelName){
    const arr=(variantsMap[modelName]||[]);
    variantSelect.innerHTML='';
    if(!arr.length){ const opt=document.createElement('option'); opt.value=''; opt.textContent='â€” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø¯Ø¯Ø© â€”'; variantSelect.appendChild(opt); }
    else arr.forEach(v=>{ const opt=document.createElement('option'); opt.value=v; opt.textContent=v; variantSelect.appendChild(opt); });
  }
  carSelect.addEventListener('change',e=>{ populateVariants(e.target.value); });

  // ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª
  btnAddModel.addEventListener('click',()=>{ modelNameEl.value=''; openModal(modelModal); });
  btnAddVariant.addEventListener('click',()=>{ if(models.length && carSelect.value){ variantModelForEl.value = carSelect.value; } variantNameEl.value=''; openModal(variantModal); });

  // ØªØ£ÙƒÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¯ÙŠÙ„
  confirmAddModel.addEventListener('click', async ()=>{
    const name=(modelNameEl.value||'').trim();
    window.__mzjUserName = name || null;
    if(!name) return showToast('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„','info');
    if(!models.includes(name)){ models.push(name); if(!variantsMap[name]) variantsMap[name]=[]; loadModelsIntoSelects(); carSelect.value=name; populateVariants(name); await persistAll(); showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„','ok');}
    else showToast('Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„','info');
    modelModal.style.display='none';
  });

  // ØªØ£ÙƒÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†
  confirmAddVariant.addEventListener('click', async ()=>{
    const modelFor=(variantModelForEl.value||'').trim();
    const vName=(variantNameEl.value||'').trim();
    if(!modelFor) return showToast('Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„','info');
    if(!vName) return showToast('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†','info');
    variantsMap[modelFor]=variantsMap[modelFor]||[];
    if(!variantsMap[modelFor].includes(vName)){ variantsMap[modelFor].push(vName); if(carSelect.value===modelFor){ populateVariants(modelFor); variantSelect.value=vName; } await persistAll(); showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†','ok');}
    else showToast('Ø§Ù„Ø¨ÙŠØ§Ù† Ù…Ø³Ø¬Ù‘Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§','info');
    variantModal.style.display='none';
  });

  /* ===== Table render / search ===== */
  function renderTable(){
    const q=(searchInput.value||'').trim().toLowerCase();
    tableBody.innerHTML='';
    let rows=stock.slice().sort((a,b)=>a.id-b.id);
    if(q){
      rows=rows.filter(r=>{
        const hay=[r.car,r.variant,r.dealer,r.extColor,r.intColor,r.modelYear,r.plate,r.location,r.batchName,r.notes,r.vin].join(' ').toLowerCase();
        return hay.includes(q);
      });
    }
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><strong>${r.car||''}</strong></td>
        <td>${r.variant||''}</td>
        <td>${r.dealer||''}</td>
        <td>${r.extColor||''}</td>
        <td>${r.intColor||''}</td>
        <td class="nowrap">${r.modelYear||''}</td>
        <td class="nowrap"><span class="copyable" data-copy="${r.plate||''}" title="Ø§Ù†Ø³Ø® Ø§Ù„Ù„ÙˆØ­Ø©">${r.plate||''}</span></td>
        <td>${r.location||''}</td>
        <td>${r.batchName||''}</td>
        <td class="nowrap"><span class="copyable" data-copy="${r.vin||''}" title="Ø§Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„">${r.vin||''}</span></td>
        <td>${r.notes||''}</td>
        <td>
          <div class="cell-actions">
            <button class="btn btn-ghost" data-edit="${r.id}" title="ØªØ¹Ø¯ÙŠÙ„">ØªØ¹Ø¯ÙŠÙ„ âœ</button>
            <button class="btn btn-danger" data-del="${r.id}" title="Ø­Ø°Ù">Ø­Ø°Ù ğŸ—‘</button>
          </div>
        </td>`;
      tableBody.appendChild(tr);
    });
  }

  const INLINE_EDIT_FIELDS = ['car','variant','dealer','extColor','intColor','modelYear','plate','location','batchName','vin','notes'];

  function makeRowEditable(tr, rec){
    if(!tr || !rec) return;
    tr.dataset.editing = '1';
    const tds = tr.querySelectorAll('td');
    const fields = INLINE_EDIT_FIELDS;
    fields.forEach((field, idx)=>{
      const td = tds[idx];
      if(!td) return;
      const current = rec[field] || '';
      if(field === 'location'){
        const sel = document.createElement('select');
        sel.className = 'edit-location';
        if(Array.isArray(FIXED_LOCATIONS)){
          FIXED_LOCATIONS.forEach(loc=>{
            const opt = document.createElement('option');
            opt.value = loc;
            opt.textContent = loc;
            if(loc === current) opt.selected = true;
            sel.appendChild(opt);
          });
        }
        td.innerHTML = '';
        td.appendChild(sel);
      }else if(field === 'notes'){
        const ta = document.createElement('textarea');
        ta.className = 'edit-notes';
        ta.value = current;
        ta.style.width = '100%';
        ta.style.minHeight = '40px';
        td.innerHTML = '';
        td.appendChild(ta);
      }else{
        const inp = document.createElement('input');
        inp.className = 'edit-'+field;
        inp.value = current;
        inp.style.width = '100%';
        td.innerHTML = '';
        td.appendChild(inp);
      }
    });
    const actionsTd = tds[11];
    if(actionsTd){
      actionsTd.innerHTML = '';
      const wrap = document.createElement('div');
      wrap.className = 'cell-actions';
      const btnSave = document.createElement('button');
      btnSave.className = 'btn btn-primary';
      btnSave.setAttribute('data-save-inline', rec.id);
      btnSave.textContent = 'Ø­ÙØ¸';
      const btnCancel = document.createElement('button');
      btnCancel.className = 'btn btn-ghost';
      btnCancel.setAttribute('data-cancel-inline', rec.id);
      btnCancel.textContent = 'Ø¥Ù„ØºØ§Ø¡';
      wrap.appendChild(btnSave);
      wrap.appendChild(btnCancel);
      actionsTd.appendChild(wrap);
    }
  }
  searchInput.addEventListener('input',renderTable);
  btnClearSearch.addEventListener('click',()=>{searchInput.value=''; renderTable();});

  /* Ù†Ø³Ø® Ø³Ø±ÙŠØ¹ + Ø£Ø²Ø±Ø§Ø± ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù */
  document.addEventListener('click',(e)=>{
    const pill=e.target.closest('.copyable');
    const btn=e.target.closest('button');
    if(pill){
      const txt=(pill.getAttribute('data-copy')||'').trim();
      if(txt){ navigator.clipboard.writeText(txt).then(()=>showToast('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…','ok')); }
    }
    if(btn){
      const del=btn.getAttribute('data-del');
      const edit=btn.getAttribute('data-edit');
      const saveInline=btn.getAttribute('data-save-inline');
      const cancelInline=btn.getAttribute('data-cancel-inline');

      if(edit){
        const id=Number(edit);
        const rec=stock.find(r=>r.id===id);
        if(!rec) return;
        const tr=btn.closest('tr');
        makeRowEditable(tr, rec);
      }

      if(saveInline){
        const id=Number(saveInline);
        const idx=stock.findIndex(r=>r.id===id);
        if(idx<0) return;
        const tr=btn.closest('tr');
        const tds=tr.querySelectorAll('td');
        const fields=['car','variant','dealer','extColor','intColor','modelYear','plate','location','batchName','vin','notes'];
        const rec=stock[idx];
        fields.forEach((field,idxField)=>{
          const td=tds[idxField];
          if(!td) return;
          let val=rec[field]||'';
          if(field==='location'){
            const sel=td.querySelector('select');
            if(sel) val=sel.value.trim();
          }else if(field==='notes'){
            const ta=td.querySelector('textarea');
            if(ta) val=ta.value.trim();
          }else{
            const inp=td.querySelector('input');
            if(inp) val=inp.value.trim();
          }
          rec[field]=val;
        });
        stock[idx]=rec;
        persistAll();
        renderTable();
        showToast('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­','ok');
      }

      if(cancelInline){
        renderTable();
      }

      if(del){
        const id=Number(del);
        if(confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')){
          stock=stock.filter(r=>r.id!==id);
          persistAll();
          renderTable();
          showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù','ok');
        }
      }
    }
  });


/* Ø­ÙØ¸ / ØªØ¹Ø¯ÙŠÙ„ */
  let editId=null;
  btnSave.addEventListener('click',async ()=>{
    const record={
      id:editId||nextId(),
      car:carSelect.value,
      variant:variantSelect.value||'',
      dealer:dealerInput.value.trim(),
      extColor:extColorInput.value.trim(),
      intColor:intColorInput.value.trim(),
      vin:normalizeVin(vinInput.value),
      modelYear:modelYearInput.value.trim(),
      plate:plateInput.value.trim(),
      location:locationSelect.value,
      batchName:batchNameInput.value.trim(),
      notes:notesInput.value.trim()
    };
    if(!record.car) return showToast('Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø£ÙˆÙ„Ù‹Ø§','err');

    if(editId){const idx=stock.findIndex(r=>r.id===editId); if(idx>-1) stock[idx]=record; editId=null; showToast('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„','ok');}
    else {stock.push(record); showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸','ok');}
    await persistAll(); renderTable(); clearForm();
  });
  function clearForm(){
    if(models.length){carSelect.value=models[0]; populateVariants(carSelect.value); variantSelect.value=variantSelect.options[0]?.value||'';}
    dealerInput.value=''; extColorInput.value=''; intColorInput.value='';
    modelYearInput.value=''; plateInput.value='';
    locationSelect.selectedIndex=0;
    batchNameInput.value=''; vinInput.value=''; notesInput.value=''; editId=null;
  }
  btnReset.addEventListener('click',clearForm);

  /* ØªØµØ¯ÙŠØ± Excel (ÙƒØ§Ù…Ù„) */
  btnExport.addEventListener('click',()=>{
    const rows=stock.slice().sort((a,b)=>a.id-b.id);
    const header=["Ù…","Ø³ÙŠØ§Ø±Ø©","Ø§Ù„Ø¨ÙŠØ§Ù†","Ø§Ù„ÙˆÙƒÙŠÙ„","Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ","Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ","Ù…ÙˆØ¯ÙŠÙ„","Ø§Ù„Ù„ÙˆØ­Ø©","Ø§Ù„Ù…ÙƒØ§Ù†","Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø©","Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„","Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª"];
    const data=[header];
    rows.forEach(r=>data.push([r.id,r.car,r.variant,r.dealer,r.extColor,r.intColor,r.modelYear,r.plate,r.location,r.batchName||'',r.vin,r.notes]));
    const ws=XLSX.utils.aoa_to_sheet(data);
    ws['!cols']=[{wch:6},{wch:22},{wch:16},{wch:16},{wch:14},{wch:14},{wch:8},{wch:12},{wch:22},{wch:18},{wch:22},{wch:26}];
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Cars");
    XLSX.writeFile(wb,"mzj-cars-inventory.xlsx"); showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù','ok');
  });

  /* Ø§Ù„Ø¬Ø¯ÙŠØ¯: ØªØµØ¯ÙŠØ± Ù‚Ø§Ù„Ø¨ ÙØ§Ø¶ÙŠ (Ø¹Ù†Ø§ÙˆÙŠÙ† ÙÙ‚Ø·) */
  btnExportBlank.addEventListener('click',()=>{
    const header=["Ù…","Ø³ÙŠØ§Ø±Ø©","Ø§Ù„Ø¨ÙŠØ§Ù†","Ø§Ù„ÙˆÙƒÙŠÙ„","Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ","Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ","Ù…ÙˆØ¯ÙŠÙ„","Ø§Ù„Ù„ÙˆØ­Ø©","Ø§Ù„Ù…ÙƒØ§Ù†","Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø©","Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„","Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª"];
    const ws=XLSX.utils.aoa_to_sheet([header]);
    ws['!cols']=[{wch:6},{wch:22},{wch:16},{wch:16},{wch:14},{wch:14},{wch:8},{wch:12},{wch:22},{wch:18},{wch:22},{wch:26}];
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Template");
    XLSX.writeFile(wb,"mzj-cars-template-blank.xlsx");
    showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„ÙØ§Ø¶ÙŠ','ok');
  });

  /* Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel */
  let importMode=null; const VIN_HEADERS=["Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„","VIN","Ø§Ù„Ø´Ø§Øµ","Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Øµ","Chassis","Chassis No","Chassis Number","Ø§Ù„Ù‡ÙŠÙƒÙ„","Ù†ÙˆØ¹ Ø§Ù„Ù‡ÙŠÙƒÙ„"];

  // ===== Update-from-sheet helpers =====

  // ===== Update report state =====
  let __lastUpdateReport = null;

  function openModal(el){
    if(!el) return;
    el.classList.add('show');
    el.setAttribute('aria-hidden','false');
    el.style.display='flex';
    // force center
    el.style.alignItems='center';
    el.style.justifyContent='center';
    setTimeout(()=>{ const first = el.querySelector('input,select,textarea,button'); first?.focus(); }, 50);
  }
  function closeModalById(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.remove('show');
    el.setAttribute('aria-hidden','true');
    el.style.display='none';
  }

  function normalizeHeader(h){ return clean(h).toLowerCase(); }

  async function chooseUpdateFieldsFromHeader(header){
    const modal = document.getElementById('updateModal');
    const box   = document.getElementById('updateFieldsBox');
    const btn   = document.getElementById('confirmUpdateFields');
    const btnAll= document.getElementById('btnUpdateSelectAll');

    // Map Arabic column labels to record keys (match your export)
    const FIELDS = [
      {key:'car',       label:'Ø³ÙŠØ§Ø±Ø©'},
      {key:'variant',   label:'Ø§Ù„Ø¨ÙŠØ§Ù†'},
      {key:'dealer',    label:'Ø§Ù„ÙˆÙƒÙŠÙ„'},
      {key:'extColor',  label:'Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ'},
      {key:'intColor',  label:'Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ'},
      {key:'modelYear', label:'Ù…ÙˆØ¯ÙŠÙ„'},
      {key:'plate',     label:'Ø§Ù„Ù„ÙˆØ­Ø©'},
      {key:'location',  label:'Ø§Ù„Ù…ÙƒØ§Ù†'},
      {key:'batchName', label:'Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø©'},
      {key:'notes',     label:'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª'}
    ];

    const present = FIELDS.filter(f => header.includes(f.label));
    box.innerHTML = present.map(f => `
      <label style="display:flex;gap:10px;align-items:center;border:1px solid var(--line);padding:10px 12px;border-radius:12px;background:#fff8ef">
        <input type="checkbox" checked data-key="${f.key}" style="width:18px;height:18px;accent-color: rgb(62,36,32);" />
        <span style="font-weight:800">${f.label}</span>
      </label>
    `).join('');

    btnAll.onclick = ()=> box.querySelectorAll('input[type="checkbox"]').forEach(c=> c.checked=true);

    return await new Promise((resolve, reject)=>{
      let done=false;

      const onClick=(e)=>{
        const isBackdrop = e.target === modal;
        const isCloseBtn = e.target.closest('[data-close="updateModal"]');
        if(isBackdrop || isCloseBtn){
          if(!done){ done=true; closeModalById('updateModal'); reject(new Error('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«')); }
        }
      };

      modal.addEventListener('click', onClick, true);

      btn.onclick = ()=>{
        const selected=[...box.querySelectorAll('input[type="checkbox"]:checked')].map(x=>x.dataset.key);
        if(!selected.length){ showToast('Ø§Ø®ØªØ± Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„ØªØ­Ø¯ÙŠØ«','info'); return; }
        done=true;
        modal.removeEventListener('click', onClick, true);
        closeModalById('updateModal');
        resolve(selected);
      };

      showToast('Ø§Ø®ØªØ± Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«','info');
      openModal(modal);
    });
  }

  
  function applyUpdateFromSheet(rows, idxMap, idxVin, selectedKeys){
    const updated = [];
    const notFound = [];
    const skipped = [];

    // Build quick vin -> index map
    const map = new Map();
    stock.forEach((r, i)=>{
      const v = normalizeVin(r.vin||'');
      if(v) map.set(v, i);
    });

    for(let i=1;i<rows.length;i++){
      const row = rows[i];
      if(!row || row.length===0) continue;

      const rawVin = (idxVin!==-1 ? row[idxVin] : '') || '';
      const vin = normalizeVin(rawVin);
      if(!vin){ skipped.push(`#${i+1} VIN ÙØ§Ø±Øº`); continue; }

      const recIdx = map.get(vin);
      if(recIdx === undefined){ notFound.push(vin); continue; }

      const rec = stock[recIdx];
      let changed = false;

      // update selected fields only if sheet cell not empty AND value is different
      selectedKeys.forEach(k=>{
        const col = idxMap[k];
        if(col === undefined || col === -1) return;
        const val = (row[col] ?? '').toString().trim();
        if(val === '') return; // don't overwrite with empty
        if(rec[k] !== val){
          rec[k] = val;
          changed = true;
        }
      });

      if(changed){
        stock[recIdx] = rec;
        updated.push(vin);
      }
    }

    return {updated, notFound, skipped};
  }

  btnImportMenu.addEventListener('click',()=>{importDropdown.style.display=importDropdown.style.display==='block'?'none':'block';});
  importDropdown.addEventListener('click',(e)=>{const btn=e.target.closest('button'); if(!btn) return; importMode=btn.getAttribute('data-mode'); importDropdown.style.display='none'; fileImport.click();});
  document.addEventListener('click',(e)=>{if(!e.target.closest('.import-menu')) importDropdown.style.display='none';});
  fileImport.addEventListener('change',(e)=>{
    const file=e.target.files[0]; if(!file) return; if(!importMode){showToast('Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£ÙˆÙ„Ù‹Ø§','info'); fileImport.value=''; return;}
    const reader=new FileReader();
    reader.onload=async (evt)=>{
      try{
        const data=new Uint8Array(evt.target.result);
        const workbook=XLSX.read(data,{type:'array'}); const first=workbook.SheetNames[0]; const sheet=workbook.Sheets[first];
        const json=XLSX.utils.sheet_to_json(sheet,{header:1,defval:''});
        const header=json[0]||[]; const colIndex=name=>header.indexOf(name);

        const idxMap={
          id:colIndex("Ù…"),car:colIndex("Ø³ÙŠØ§Ø±Ø©"),variant:colIndex("Ø§Ù„Ø¨ÙŠØ§Ù†"),dealer:colIndex("Ø§Ù„ÙˆÙƒÙŠÙ„"),
          extColor:colIndex("Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ"),intColor:colIndex("Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ"),
          modelYear:colIndex("Ù…ÙˆØ¯ÙŠÙ„"), plate:colIndex("Ø§Ù„Ù„ÙˆØ­Ø©"), location:colIndex("Ø§Ù„Ù…ÙƒØ§Ù†"),
          batchName:colIndex("Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø©"), notes:colIndex("Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª")
        };
        // Detect VIN column index
        let idxVin=-1;
        for(const h of VIN_HEADERS){
          const i=header.indexOf(h);
          if(i!==-1){ idxVin=i; break; }
        }


        
        // ===== Update mode: update existing cars only (by VIN) =====
        if(importMode==='update'){
          if(idxVin===-1) throw new Error('Ù…Ù„Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ø§Ø²Ù… ÙŠØ­ØªÙˆÙŠ Ø¹Ù…ÙˆØ¯ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (VIN).');
if(idxVin===-1) throw new Error('Ù…Ù„Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ø§Ø²Ù… ÙŠØ­ØªÙˆÙŠ Ø¹Ù…ÙˆØ¯ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (VIN).');
          const selectedKeys = await chooseUpdateFieldsFromHeader(header);
          // Map keys to column indexes in sheet
          const keyToCol = {
            car: idxMap.car,
            variant: idxMap.variant,
            dealer: idxMap.dealer,
            extColor: idxMap.extColor,
            intColor: idxMap.intColor,
            modelYear: idxMap.modelYear,
            plate: idxMap.plate,
            location: idxMap.location,
            batchName: idxMap.batchName,
            notes: idxMap.notes
          };
          const res = applyUpdateFromSheet(json, keyToCol, idxVin, selectedKeys);
          await persistAll();
          renderTable(); fillMoveLists(); updateRequirementBoxes();
          __lastUpdateReport = res;
          showToast(`âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­ â€” Ø¹Ø¯Ø¯ Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„ Ø§Ù„Ù…ÙØ­Ø¯Ù‘ÙØ«Ø©: ${res.updated.length}`,'ok');
          showUpdateReportButton();

          return;
        }

        const mustHave=["Ø³ÙŠØ§Ø±Ø©","Ø§Ù„Ø¨ÙŠØ§Ù†","Ø§Ù„ÙˆÙƒÙŠÙ„","Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ","Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ","Ù…ÙˆØ¯ÙŠÙ„","Ø§Ù„Ù„ÙˆØ­Ø©","Ø§Ù„Ù…ÙƒØ§Ù†","Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø©","Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª"];
        const missing = mustHave.filter(n=> colIndex(n)===-1);
        if(missing.length){ throw new Error('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ â€” Ø£Ø¹Ù…Ø¯Ø© Ù†Ø§Ù‚ØµØ©: '+missing.join(', ')); }

        const imported=[];
        for(let i=1;i<json.length;i++){
          const row=json[i]; if(!row || row.length===0) continue;
          const rawVin=(idxVin!==-1?row[idxVin]:'');
          imported.push({
            id:Number(row[idxMap.id])||null,
            car:row[idxMap.car]||'',
            variant:row[idxMap.variant]||'',
            dealer:row[idxMap.dealer]||'',
            extColor:row[idxMap.extColor]||'',
            intColor:row[idxMap.intColor]||'',
            modelYear:row[idxMap.modelYear]||'',
            plate:row[idxMap.plate]||'',
            location:row[idxMap.location]||'',
            batchName:row[idxMap.batchName]||'',
            notes:row[idxMap.notes]||'',
            vin:normalizeVin(rawVin)
          });
          const name=row[idxMap.car];
          if(name && !models.includes(name)){models.push(name); if(!variantsMap[name]) variantsMap[name]=[];}
        }
        if(importMode==='replace'){stock=[]; imported.forEach(r=>{r.id=nextId(); stock.push(r);});}
        else {imported.forEach(r=>{r.id=nextId(); stock.push(r);});}
        await persistAll(); loadModelsIntoSelects(); if(carSelect.value) populateVariants(carSelect.value);
        renderTable(); fillMoveLists(); updateRequirementBoxes();
        showToast(importMode==='replace'?'ØªÙ… Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©':'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©','ok');
      }catch(err){ showToast((err?.message)||'ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ â€” Ø±Ø§Ø¬Ø¹ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù','err'); }
      finally{ fileImport.value=''; importMode=null; }
    };
    reader.readAsArrayBuffer(file);
  });

  /* ===== Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„ â€” Ù‚ÙˆØ§Ø¦Ù… Ø«Ø§Ø¨ØªØ© ===== */
  const FIXED_LOCATIONS = [
    "Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"
  ];
  function fillMoveLists(){
    const opts = FIXED_LOCATIONS.map(l=> `<option value="${l}">${l}</option>`).join('');
    const fromSelects = moveRowsContainer ? moveRowsContainer.querySelectorAll('.move-from') : [];
    fromSelects.forEach(sel=> sel.innerHTML=opts);
    if(moveToGlobal) moveToGlobal.innerHTML = opts;
  }

  function fillMoveListsForRow(row){
    const opts = FIXED_LOCATIONS.map(l=> `<option value="${l}">${l}</option>`).join('');
    const fromSel = row.querySelector('.move-from');
    if(fromSel) fromSel.innerHTML = opts;
  }

  function renderCarDetails(rec){
    carDetails.innerHTML=`
      <div style="grid-column:1/-1"><b>Ø³ÙŠØ§Ø±Ø©:</b> ${rec.car??""}</div>
      <div><b>Ø§Ù„Ø¨ÙŠØ§Ù†:</b> ${rec.variant??""}</div>
      <div><b>Ø§Ù„ÙˆÙƒÙŠÙ„:</b> ${rec.dealer??""}</div>
      <div><b>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ:</b> ${rec.extColor??""}</div>
      <div><b>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ:</b> ${rec.intColor??""}</div>
      <div><b>Ù…ÙˆØ¯ÙŠÙ„:</b> ${rec.modelYear??""}</div>
      <div><b>Ø§Ù„Ù„ÙˆØ­Ø©:</b> ${rec.plate??""}</div>
      <div><b>Ø§Ù„Ù…ÙƒØ§Ù†:</b> ${rec.location??""}</div>
      <div><b>Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø©:</b> ${rec.batchName??""}</div>
      <div style="grid-column:1/-1"><b>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„:</b> ${rec.vin??""}</div>
      <div style="grid-column:1/-1"><b>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${rec.notes??""}</div>`;
    carDetailsHint.textContent=rec.vin?`Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„: ${rec.vin}`:'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡ÙŠÙƒÙ„ Ù…Ø­ÙÙˆØ¸ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø©.';
    carDetailsBox.style.display='block';
  }

  function hideMoveAlert(){
    if(moveAlert){
      moveAlert.style.display='none';
      moveAlertList.innerHTML='';
    }
  }

  function showMoveAlert(type, title, lines){
    if(!moveAlert) return;
    moveAlert.className = 'move-alert ' + (type || 'info');
    moveAlertTitle.textContent = title || 'Ù†ØªÙŠØ¬Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„';
    moveAlertList.innerHTML = '';
    (lines || []).forEach(txt=>{
      const li = document.createElement('li');
      li.textContent = txt;
      moveAlertList.appendChild(li);
    });
    moveAlert.style.display = 'flex';
  }

  /* Ø§Ù‚ØªØ±Ø§Ø­ VIN Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø§Ø¯Ø¦Ø©/Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ÙƒØªÙˆØ¨Ø© */
  function updateVinSuggestionsForPrefix(rawPrefix){
  if(!vinHints) return;
  const prefix = normalizeVin(rawPrefix||'');
  if(prefix.length < 1){
    vinHints.innerHTML = '';
    return;
  }
  const set = new Set();
  stock.forEach(r=>{
    const v = normalizeVin(r.vin||'');
    // ğŸ‘‡ Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡:
    // if(v && v.includes(prefix)) set.add(v); // ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ÙƒØªÙˆØ¨Ø©

    // âœ… Ø®Ù„ÙŠÙ‡ ÙŠØ¨Ø¯Ø£ Ø¨Ù†ÙØ³ Ø§Ù„Ù„ÙŠ Ø§Ù†Øª ÙƒØ§ØªØ¨Ù‡ (Prefix)
    if(v && v.startsWith(prefix)) set.add(v);
  });
  const list = Array.from(set).sort().slice(0,30);
  vinHints.innerHTML = list.map(v=>`<option value="${v}"></option>`).join('');
}



  /* Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ù…ÙƒØ§Ù† "Ù…Ù†" Ù„ÙƒÙ„ Ø³Ø·Ø± Ø¹Ù†Ø¯ ÙƒØªØ§Ø¨Ø© VIN */
  function autoFindByVinForRow(row, strictMessage=false){
    const inp = row.querySelector('.move-vin');
    const fromSel = row.querySelector('.move-from');
    const vinRaw = (inp.value||'').trim();
    if(!vinRaw){
      if(fromSel){
        fromSel.disabled=false;
        fromSel.value='';
      }
      const anyVin = moveRowsContainer.querySelectorAll('.move-vin');
      const hasAnyVin = Array.from(anyVin).some(i=> normalizeVin(i.value));
      if(!hasAnyVin){
        carDetailsBox.style.display='none';
        moveStatus.textContent='';
      }
      return;
    }
    const norm = normalizeVin(vinRaw);
    let match = stock.find(r => normalizeVin(r.vin) === norm);
    if(!match && norm.length >= 8){
      const candidates = stock.filter(r => normalizeVin(r.vin).startsWith(norm));
      if(candidates.length === 1) match = candidates[0];
    }
    if(match){
      renderCarDetails(match);
      const currentLoc = match.location || '';
      if(currentLoc && fromSel){
        fromSel.value = currentLoc;
        fromSel.disabled = true;
        moveStatus.textContent = `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±: ${match.car} â€” Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentLoc}`;
      }else if(fromSel){
        fromSel.disabled = false;
        moveStatus.textContent = `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±: ${match.car} â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙƒØ§Ù† Ù…Ø³Ø¬Ù„. Ø§Ø®ØªØ± Ø§Ù„Ù…ÙƒØ§Ù† ÙŠØ¯ÙˆÙŠÙ‹Ø§.`;
      }
    }else{
      if(strictMessage){
        const msg = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³ÙŠØ§Ø±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù….';
        moveStatus.textContent = msg;
        carDetailsBox.style.display='none';
        showMoveAlert('error','Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø©',[msg]);
      }else{
        moveStatus.textContent = 'â€” Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¨Ø¹Ø¯ (Ø£ÙƒÙ…Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„).';
      }
    }
  }

  function attachMoveRowEvents(row){
    const inp = row.querySelector('.move-vin');
    if(!inp) return;
    inp.addEventListener('input', debounce(()=>{
      updateVinSuggestionsForPrefix(inp.value);
      autoFindByVinForRow(row,false);
    },150));
  }

  function createMoveRow(index){
    const row = document.createElement('div');
    row.className = 'move-row';
    row.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
        <div class="move-row-title">Ø§Ù„Ø³ÙŠØ§Ø±Ø© ${index}</div>
        <button type="button" class="btn btn-ghost" data-remove-move-row="1" title="Ù…Ø³Ø­ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©">Ù…Ø³Ø­ Ø§Ù„Ø­Ø±ÙƒØ©</button>
      </div>
      <div class="grid grid-3">
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</label>
          <input class="move-vin" list="vinHints" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„"/>
        </div>
        <div>
          <label>Ù…Ù† (Ù…Ø­Ø¯Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)</label>
          <select class="move-from" title="Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ"></select>
        </div>
        <div class="notes-col">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
          <textarea class="move-notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù‡ÙŠÙƒÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
        </div>
      </div>`;
    fillMoveListsForRow(row);
    attachMoveRowEvents(row);
    return row;
  }

  function renumberMoveRows(){
    const rows = moveRowsContainer.querySelectorAll('.move-row');
    rows.forEach((row,idx)=>{
      const title = row.querySelector('.move-row-title');
      if(title) title.textContent = 'Ø§Ù„Ø³ÙŠØ§Ø±Ø© ' + (idx+1);
    });
  }

  function ensureAtLeastOneMoveRow(){
    if(!moveRowsContainer) return;
    const existing = moveRowsContainer.querySelectorAll('.move-row').length;
    if(existing === 0){
      const row = createMoveRow(1);
      moveRowsContainer.appendChild(row);
    }
    renumberMoveRows();
  }

  if(btnAddMoveRow){
    btnAddMoveRow.addEventListener('click', ()=>{
      const count = moveRowsContainer.querySelectorAll('.move-row').length;
      const row = createMoveRow(count+1);
      moveRowsContainer.appendChild(row);
      renumberMoveRows();
    });
  }

  
  // Ù…Ø³Ø­ ØµÙ Ø­Ø±ÙƒØ© Ù†Ù‚Ù„ ÙˆØ§Ø­Ø¯
  document.addEventListener('click',(e)=>{
    const btn = e.target.closest('[data-remove-move-row]');
    if(!btn) return;
    const row = btn.closest('.move-row');
    if(row){
      row.remove();
      renumberMoveRows();
    }
  });

// Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø£ÙˆÙ„ VIN ØºÙŠØ± ÙØ§Ø±Øº
  btnFindByVin.addEventListener('click',()=>{
    const rows = Array.from(moveRowsContainer.querySelectorAll('.move-row'));
    const firstRow = rows.find(r=> normalizeVin((r.querySelector('.move-vin')?.value||'').trim()));
    if(!firstRow){
      const msg = 'Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙÙŠ Ø£ÙŠ Ø³Ø·Ø± Ø£ÙˆÙ„Ù‹Ø§.';
      moveStatus.textContent = msg;
      showMoveAlert('info','Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡ÙŠÙƒÙ„',[msg]);
      return;
    }
    autoFindByVinForRow(firstRow,true);
  });

  function updateRequirementBoxes(){
    const val = (moveToGlobal?.value || '').trim();
    const anyIssues        = /Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª/.test(val);
    if(underDeliveryBox){
      underDeliveryBox.style.display = 'none';
    }
  }

  if(moveToGlobal){
    moveToGlobal.addEventListener('change', updateRequirementBoxes);
  }

  // ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
  btnMove.addEventListener('click', async ()=>{
    hideMoveAlert();

    const dest = (moveToGlobal?.value || '').trim();
    if(!dest){
      const msg = 'Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† "Ø¥Ù„Ù‰" Ø£ÙˆÙ„Ù‹Ø§ Ù‚Ø¨Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‚Ù„.';
      moveStatus.textContent = msg;
      showMoveAlert('info','Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨',[msg]);
      showToast(msg,'info');
      return;
    }

    const rows = Array.from(moveRowsContainer.querySelectorAll('.move-row')).map(row=>({
      row,
      vinRaw:(row.querySelector('.move-vin')?.value||'').trim(),
      fromSel:row.querySelector('.move-from'),
      notesInput:row.querySelector('.move-notes')
    }));
    const rowsWithVin = rows.filter(r=> normalizeVin(r.vinRaw));

    if(!rowsWithVin.length){
      const msg = 'Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙŠ Ø±Ù‚Ù… Ù‡ÙŠÙƒÙ„ Ù„Ù„Ù†Ù‚Ù„.';
      moveStatus.textContent = msg;
      showMoveAlert('info','Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù†Ù‚Ù„', [msg]);
      showToast(msg,'info');
      return;
    }

    const goingUnderDeliveryRow = /Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…/.test(dest);
    const goingIssuesRow        = /Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª/.test(dest);
    const goingDeliveredRow     = /Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…/.test(dest);

    let movedCount = 0;
    const errors = [];
    const successLines = [];

    
for (const rowData of rowsWithVin){
      const norm = normalizeVin(rowData.vinRaw);
      const recIdx = stock.findIndex(r => normalizeVin(r.vin) === norm);
      if(recIdx < 0){
        errors.push(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³ÙŠØ§Ø±Ø© Ø¨Ù‡Ø°Ø§ VIN: ${rowData.vinRaw}`);
        continue;
      }
      const rec = stock[recIdx];
      const toVal = dest;
      const fromSel = rowData.fromSel;
      const from = (fromSel?.value || rec.location || '').trim();
      if(!from){
        errors.push(`Ø§Ù„Ø³ÙŠØ§Ø±Ø© ${rec.car||''} (${rec.vin||rowData.vinRaw}) Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ù‡Ø§ Ù…ÙƒØ§Ù† Ø­Ø§Ù„ÙŠØ› Ø­Ø¯Ù‘Ø¯ Ø§Ù„Ù…ÙƒØ§Ù† ÙŠØ¯ÙˆÙŠÙ‹Ø§ ÙÙŠ "Ù…Ù†".`);
        continue;
      }
      if(from === toVal){
        errors.push(`Ø§Ù„Ø³ÙŠØ§Ø±Ø© ${rec.car||''} (${rec.vin||rowData.vinRaw}) Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…ÙƒØ§Ù†.`);
        continue;
      }

      const noteText = (rowData.notesInput?.value || '').trim();

      if(goingIssuesRow && !noteText){
        errors.push(`ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø³ÙŠØ§Ø±Ø© ${rec.car||''} (${rec.vin||rowData.vinRaw}) Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ù…ÙƒØ§Ù† "Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª".`);
        continue;
      }

            // Ù…ÙŠØªØ§Ø¯Ø§ØªØ§ Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø­Ø±ÙƒØ© / Ø§Ù„Ø·Ù„Ø¨
      const moveMeta = {
        adminApproved: null,
        adminNotes: '',
        financeApproved: null,
        financeNotes: '',
        issuesNotes: noteText
      };

      const oldLoc = rec.location || from;

      // ğŸšš Ù…Ù†Ø·Ù‚ Ø®Ø§Øµ Ø¨Ù€ "Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…"
      if (goingUnderDeliveryRow) {
        const stamp = now();

        // 1) Ù†Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙØ¹Ù„ÙŠÙ‹Ø§ Ø¥Ù„Ù‰ Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…
        rec.location = toVal;
        if ('place' in rec) {
          rec.place = toVal;
        }

        stock[recIdx] = rec;
        movedCount++;
        successLines.push(`ØªÙ… Ù†Ù‚Ù„ ${rec.car||''} (${rec.vin||rowData.vinRaw}) Ù…Ù† "${oldLoc}" Ø¥Ù„Ù‰ "${toVal}".`);

        // Ù†Ø³Ø¬Ù„ Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ "Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…"
        moves.push({
          when: stamp,
          date: onlyDate(stamp),
          vin: rec.vin || '',
          car: rec.car || '',
          from: oldLoc,
          to: toVal,
          id: rec.id,
          ...moveMeta,
          status: (moveMeta.status || 'under_delivery'),
          message: moveMeta.message || 'ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¥Ù„Ù‰ Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ù„Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…'
        });

        // 2) Ù†Ù†Ø´Ø¦ Ø·Ù„Ø¨ Ù†Ù‚Ù„ Ø¥Ù„Ù‰ "Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØ±Ø¹ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯
        const targetDelivered = toVal.replace('Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…', 'Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…');

        moves.push({
          when: stamp,
          date: onlyDate(stamp),
          vin: rec.vin || '',
          car: rec.car || '',
          from: toVal,
          to: targetDelivered,
          id: rec.id,
          adminApproved: false,
          adminApproval: false,
          financeApproved: false,
          financeApproval: false,
          requiresAdminApproval: true,
          needsAdminApproval: true,
          requiresFinanceApproval: true,
          needsFinanceApproval: true,
          status: 'pending',
          message: 'Ø·Ù„Ø¨ Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù…Ù† Ù†ÙØ³ Ø§Ù„ÙØ±Ø¹ (Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ©)'
        });

        // Ù†Ù†ØªÙ‚Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø¹Ù†ØµØ± Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø¯ÙˆÙ† ØªÙ†ÙÙŠØ° Ù…Ù†Ø·Ù‚ "Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" Ø£Ùˆ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        continue;
      }



      // ğŸš— Ù…Ù†Ø·Ù‚ Ø®Ø§Øµ Ø¨Ù€ "Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"
      if (goingDeliveredRow) {
        const stamp = now();

        // ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø£ÙˆÙ„Ù‹Ø§ ÙÙŠ "Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…" Ù„Ù†ÙØ³ Ø§Ù„ÙØ±Ø¹
        if (!/Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…/.test(oldLoc)) {
          const errMsg = `Ù„Ø§ÙŠÙ…ÙƒÙ† Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ${rec.car || ''} (${rec.vin || rowData.vinRaw}) Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ "Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…". ÙŠØ¬Ø¨ Ø£Ù† ØªÙ…Ø± Ø£ÙˆÙ„Ù‹Ø§ Ø¹Ù„Ù‰ "Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…" Ù„Ù†ÙØ³ Ø§Ù„ÙØ±Ø¹.`;
          errors.push(errMsg);
          continue;
        }

        // Ù†Ø¨Ø­Ø« Ø¹Ù† Ø¢Ø®Ø± Ø·Ù„Ø¨ Ù†Ù‚Ù„ Ø¥Ù„Ù‰ "Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" Ù„Ù†ÙØ³ Ø§Ù„Ù€ VIN
        const deliveredTarget = toVal;
        const relatedMoves = moves.filter(m =>
          normalizeVin(m.vin || '') === norm && (m.to || '') === deliveredTarget
        );
        const lastMove = relatedMoves.length ? relatedMoves[relatedMoves.length - 1] : null;

        if (!lastMove) {
          const errMsg = 'Ù„Ø§ÙŠÙ…ÙƒÙ† Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¥Ù„Ù‰ "Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ù† "Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…".';
          errors.push(errMsg);
          continue;
        }

        const adminOk = !!(lastMove.adminApproved === true || lastMove.adminApproval === true);
        const financeOk = !!(lastMove.financeApproved === true || lastMove.financeApproval === true);

        if (!adminOk || !financeOk) {
          const errMsg = 'Ù„Ø§ÙŠÙ…ÙƒÙ† Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ø§Ù„ÙŠØ© Ùˆ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ø¯Ø§Ø±ÙŠØ©';
          errors.push(errMsg);
          continue;
        }

        // âœ… Ù…ÙˆØ§ÙÙ‚Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©: Ù†ÙÙ‘Ø° Ø§Ù„Ù†Ù‚Ù„ ÙØ¹Ù„ÙŠÙ‹Ø§ Ù…Ù† Ù‡Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©
        rec.location = toVal;
        if ('place' in rec) {
          rec.place = toVal;
        }
        // Ù†Ø¹Ù„Ù‘Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¥Ù†Ù‡Ø§ ØªÙ… ØªØ³Ù„ÙŠÙ…Ù‡Ø§ ÙØ¹Ù„Ø§Ù‹
        rec.delivered   = true;
        rec.deliveredAt = stamp;

        moves.push({
          when: stamp,
          date: onlyDate(stamp),
          vin: rec.vin || '',
          car: rec.car || '',
          from: oldLoc,
          to: toVal,
          id: rec.id,
          adminApproved: true,
          adminApproval: true,
          financeApproved: true,
          financeApproval: true,
          requiresAdminApproval: false,
          requiresFinanceApproval: false,
          status: 'delivered',
          message: 'ØªÙ… ØªÙ†ÙÙŠØ° Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¥Ù„Ù‰ Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª'
        });

        stock[recIdx] = rec;
        movedCount++;
        successLines.push(
          `ØªÙ… Ù†Ù‚Ù„ ${rec.car || ''} (${rowData.vinRaw}) Ø¥Ù„Ù‰ "${toVal}" Ø¨Ø¹Ø¯ Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©.`
        );
        continue;
      }


      // Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ù†Ù‚Ù„ ÙØ¹Ù„ÙŠ)
      rec.location = toVal;
      if (goingIssuesRow && noteText) {
        const existingNotes = rec.notes || '';
        rec.notes = existingNotes ? (existingNotes + " | " + noteText) : noteText;
      }
const stamp = now();
      moves.push({
        when: stamp,
        date: onlyDate(stamp),
        vin: rec.vin || '',
        car: rec.car || '',
        from: oldLoc,
        to: toVal,
        id: rec.id,
        ...moveMeta
      });
      movedCount++;
      successLines.push(`ØªÙ… Ù†Ù‚Ù„ ${rec.car||''} (${rec.vin||rowData.vinRaw}) Ù…Ù† "${oldLoc}" Ø¥Ù„Ù‰ "${toVal}".`);
    }

if(!movedCount){
      const title = 'Ù„Ù… ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ø£ÙŠ Ø­Ø±ÙƒØ© Ù†Ù‚Ù„';
      const lines = errors.length ? errors : ['Ù„Ù… ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ø£ÙŠ Ø­Ø±ÙƒØ© Ù†Ù‚Ù„.'];
      moveStatus.textContent = title;
      showMoveAlert('error', title, lines);
      showToast(title,'info');
      return;
    }

    await persistAll();
    renderTable();
    renderMoves();
    renderTrack();

    const summary = `ØªÙ… Ù†Ù‚Ù„ ${movedCount} Ø³ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­.`;    
    moveStatus.textContent = summary;
    const allLines = [...successLines];
    if(errors.length){
      allLines.push('â€” Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„ØªÙŠ Ù„Ù… ØªÙÙ†ÙØ°:');
      errors.forEach(e=> allLines.push(e));
    }
    showMoveAlert(errors.length ? 'info' : 'success', 'Ù†ØªÙŠØ¬Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„', allLines);
    showToast(summary,'ok');

    carDetailsBox.style.display='none';

    // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
    const allRows = Array.from(moveRowsContainer.querySelectorAll('.move-row'));
    allRows.forEach(row=>{
      const vin = row.querySelector('.move-vin');
      const fromSel = row.querySelector('.move-from');
      const notes = row.querySelector('.move-notes');
      if(vin) vin.value='';
      if(fromSel){ fromSel.disabled=false; fromSel.value=''; }
      if(notes) notes.value='';
    });

    chkAdminApproved.checked=false; adminNotes.value='';
    chkFinanceApproved.checked=false; financeNotes.value='';
    if(vinHints) vinHints.innerHTML='';
  });

  /* ===== Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª (Ø¹Ø±Ø¶ + ÙÙ„Ø§ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®) ===== */
  /* ===== Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª (Ø¹Ø±Ø¶ + ÙÙ„Ø§ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®) ===== */
  function filterMovesByDate(list){
    const f = movesFromDate.value || null;
    const t = movesToDate.value || null;
    if(!f && !t) return list;
    return list.filter(m=>{
      const d = fmtDateOnlyFromMove(m);
      if(f && d < f) return false;
      if(t && d > t) return false;
      return true;
    });
  }

  function renderMoves(){
    movesTableBody.innerHTML='';
    let rows = moves.slice();
    rows = filterMovesByDate(rows);
    rows.sort(compareMovesNewestFirst);
    rows.forEach((m,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i+1}</td>
        <td class="nowrap">${fmtDateOnlyFromMove(m)}</td>
        <td class="nowrap"><span class="copyable" data-copy="${m.vin||''}" title="Ø§Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„">${m.vin||''}</span></td>
        <td>${m.car||''}</td>
        <td>${m.from||''}</td>
        <td>${m.to||''}</td>
        <td class="nowrap">${m.id||''}</td>`;
      movesTableBody.appendChild(tr);
    });
  }
  movesFromDate.addEventListener('change', renderMoves);
  movesToDate.addEventListener('change', renderMoves);
  btnClearDate.addEventListener('click', ()=>{movesFromDate.value=''; movesToDate.value=''; renderMoves();});

  /* ===== ØªØªØ¨Ù‘Ø¹ VIN ===== */
  function renderTrack(){
    trackTableBody.innerHTML='';
    const v = normalizeVin((trackVin.value||'').trim());
    if(!v){ if(window.trackPlaceBar){trackPlaceBar.style.display='none';} return; }

    const stockIndex = buildStockIndex();
    const stockRow = stockIndex.get(v) || null;
    const stockPlace = stockRow ? pickPlaceFromStockRow(stockRow) : '';
    const stockUpdatedAt = stockRow ? pickUpdatedAtFromStockRow(stockRow) : null;

    // UI: show current place from stock
    if(window.trackPlaceBar){
      const bar = trackPlaceBar;
      bar.style.display = 'flex';
      const textEl = bar.querySelector('.text');
      const hintEl = bar.querySelector('.hint');
      if(stockPlace){
        textEl.textContent = `Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†): ${stockPlace}`;
        hintEl.textContent = stockUpdatedAt ? `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${stockUpdatedAt.toISOString().slice(0,10)}` : '';
      }else{
        textEl.textContent = 'Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†): ØºÙŠØ± Ù…ØªÙˆÙØ±';
        hintEl.textContent = '';
      }
    }

    const list = moves
      .filter(m=> normalizeVin(m.vin||'').startsWith(v) )
      .sort(compareMovesNewestFirst);

    // If stock place differs from Ø¢Ø®Ø± Ø­Ø±ÙƒØ© Ù…Ø³Ø¬Ù„Ø©ØŒ Ø£Ø¸Ù‡Ø± Ø³Ø·Ø± "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†" ÙƒØ­Ø±ÙƒØ© Ù…ÙØ³ØªÙ†ØªØ¬Ø©
    let inferred = null;
    if(stockPlace){
      const last = list[0] || null; // Ù„Ø£Ù†Ù†Ø§ Ø¨Ù†Ø±ØªØ¨ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
      const lastTo = last ? String(last.to||'').trim() : '';
      if(!last || (lastTo && lastTo !== stockPlace)){
        inferred = {
          _inferred:true,
          vin: v,
          from: lastTo || (last ? String(last.from||'').trim() : ''),
          to: stockPlace,
          car: (stockRow && (stockRow.car||stockRow['Ø§Ù„Ø³ÙŠØ§Ø±Ø©']||'')) || (last ? last.car : ''),
          when: stockUpdatedAt || null,
          date: stockUpdatedAt ? stockUpdatedAt.toISOString().slice(0,10) : '',
          notes: 'Ù…Ø³ØªÙ†ØªØ¬ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„ÙØ¹Ù„ÙŠ)'
        };
      }
    }
    const finalList = inferred ? [inferred, ...list] : list;

    finalList.forEach((m,i)=>{
      const notesParts = [];
      if(m.adminApproved===true) notesParts.push('âœ” Ù…ÙˆØ§ÙÙ‚Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©');
      if(m.adminApproved===false) notesParts.push('âœ– Ù…ÙˆØ§ÙÙ‚Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©');
      if(m.adminNotes) notesParts.push('Ø¥Ø¯Ø§Ø±ÙŠ: '+m.adminNotes);
      if(m.financeApproved===true) notesParts.push('âœ” Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ø§Ù„ÙŠØ©');
      if(m.financeApproved===false) notesParts.push('âœ– Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ø§Ù„ÙŠØ©');
      if(m.financeNotes) notesParts.push('Ù…Ø§Ù„ÙŠ: '+m.financeNotes);
      if(m.issuesNotes) notesParts.push('Ù…Ù„Ø§Ø­Ø¸Ø§Øª: '+m.issuesNotes);

      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i+1}</td>
        <td class="nowrap">${fmtDateOnlyFromMove(m)}</td>
        <td>${m.from||''}</td>
        <td>${m.to||''}</td>
        <td>${m.car||''}</td>
        <td>${notesParts.join(' â€” ')||''}</td>`;
      trackTableBody.appendChild(tr);
    });
  }
  trackVin.addEventListener('input', debounce(()=>{ updateVinSuggestionsForPrefix(trackVin.value); renderTrack(); }, 200));
  btnClearTrack.addEventListener('click', ()=>{ trackVin.value=''; renderTrack(); });

  /* Modals helpers */
  function openModalLegacy(el){ el.style.display='flex'; setTimeout(()=>{ const first = el.querySelector('input,select,textarea,button'); first?.focus(); }, 50); }
  function closeModalByIdLegacy(id){ const el = document.getElementById(id); if(el) el.style.display='none'; }
  document.addEventListener('click',(e)=>{
    const closeBtn = e.target.closest('[data-close]');
    if(closeBtn){ closeModalById(closeBtn.getAttribute('data-close')); }
    if(e.target.classList.contains('modal-backdrop')){ e.target.style.display='none'; }
  });
  document.addEventListener('keydown',(e)=>{
    if(e.key==='/'){e.preventDefault(); searchInput.focus();}
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){e.preventDefault(); btnSave.click();}
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){e.preventDefault(); btnAddVariant.click();}
    if(e.key==='Escape'){modelModal.style.display='none'; variantModal.style.display='none'; btnReset.click();}
  });

  /* Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ */
  setStatus('warn','Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦');

  /* Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§ */
  document.addEventListener('click',(e)=>{
    if(!e.target.closest('.import-menu')) importDropdown.style.display='none';
  });

  // ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ù„ØµÙØ­Ø©
  const innerTabs = Array.from(document.querySelectorAll('.inner-tab'));
  const innerPanels = Array.from(document.querySelectorAll('.inner-tab-panel'));
  innerTabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      innerTabs.forEach(b=> b.classList.remove('active'));
      innerPanels.forEach(p=> p.classList.remove('active'));
      btn.classList.add('active');
      const targetId = btn.getAttribute('data-target');
      const panel = document.getElementById(targetId);
      if(panel) panel.classList.add('active');
    });
  });

  // ØªÙ‡ÙŠØ¦Ø© Ù†Ù…ÙˆØ°Ø¬ Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„
  fillMoveLists();
  ensureAtLeastOneMoveRow();
  updateRequirementBoxes();

  // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙƒÙ„ Ø³ÙŠØ§Ø±Ø© Ø­Ø³Ø¨ Ù…ÙƒØ§Ù† (Ø¥Ù„Ù‰)
  function toggleNotesVisibility(){
    const dest = (moveToGlobal?.value || '').trim();
    const show = /Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª/.test(dest);
    const notesCols = document.querySelectorAll('.notes-col');
    notesCols.forEach(col=>{
      col.style.display = show ? 'block' : 'none';
    });
  }
  if(moveToGlobal){
    moveToGlobal.addEventListener('change', toggleNotesVisibility);
    toggleNotesVisibility();
  }

  
  function showUpdateReportButton(){
    let btn = document.getElementById('btnUpdateReport');
    if(!btn){
      btn = document.createElement('button');
      btn.id = 'btnUpdateReport';
      btn.className = 'btn btn-soft';
      btn.style.marginTop = '8px';
      btn.innerHTML = '<i class="fa-solid fa-file-lines"></i> Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ø¯ÙŠØ«';
      btn.onclick = openUpdateReport;
      document.querySelector('.toast-wrap')?.appendChild(btn);
    }
  }

  function openUpdateReport(){
    if(!__lastUpdateReport){ showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ± Ù…ØªØ§Ø­','info'); return; }
    const rows = [];
    __lastUpdateReport.updated.forEach(v=> rows.push({VIN:v, Status:'Updated'}));
    __lastUpdateReport.notFound.forEach(v=> rows.push({VIN:v, Status:'Not Found'}));
    __lastUpdateReport.skipped.forEach(v=> rows.push({VIN:v, Status:'Skipped'}));

    // build CSV
    let csv = 'VIN,Status\n';
    rows.forEach(r=>{ csv += `"${r.VIN}","${r.Status}"\n`; });

    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'update_report.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

</script>
</div>  <script src="./mzj-ui.js">
  function showUpdateReportButton(){
    let btn = document.getElementById('btnUpdateReport');
    if(!btn){
      btn = document.createElement('button');
      btn.id = 'btnUpdateReport';
      btn.className = 'btn btn-soft';
      btn.style.marginTop = '8px';
      btn.innerHTML = '<i class="fa-solid fa-file-lines"></i> Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ø¯ÙŠØ«';
      btn.onclick = openUpdateReport;
      document.querySelector('.toast-wrap')?.appendChild(btn);
    }
  }

  function openUpdateReport(){
    if(!__lastUpdateReport){ showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ± Ù…ØªØ§Ø­','info'); return; }
    const rows = [];
    __lastUpdateReport.updated.forEach(v=> rows.push({VIN:v, Status:'Updated'}));
    __lastUpdateReport.notFound.forEach(v=> rows.push({VIN:v, Status:'Not Found'}));
    __lastUpdateReport.skipped.forEach(v=> rows.push({VIN:v, Status:'Skipped'}));

    // build CSV
    let csv = 'VIN,Status\n';
    rows.forEach(r=>{ csv += `"${r.VIN}","${r.Status}"\n`; });

    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'update_report.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

</script>

    </div>
  </main>
</div>

</body>
</html>
