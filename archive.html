
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>أرشيف MZJ</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --brown: rgb(62,36,32);
      --beige: rgb(188,143,116);
      --cream: #fff8ef;
      --border: #eadfd6;
      --text: #1d1d1d;
      --muted: #6f6f6f;
      --shadow: 0 10px 26px rgba(0,0,0,.08);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Tajawal", system-ui, -apple-system, Segoe UI, Arial;
      background: radial-gradient(1200px 700px at 85% 0%, rgba(188,143,116,.18), transparent 55%),
                  radial-gradient(900px 550px at 0% 15%, rgba(62,36,32,.10), transparent 55%),
                  linear-gradient(180deg, var(--cream), #fff);
      color:var(--text);
    }
    .topbar{
      position:sticky; top:0; z-index:50;
      background: rgba(255,248,239,.86);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .topbar .inner{
      max-width:1240px; margin:0 auto; padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .mark{
      width:42px; height:42px; border-radius:14px;
      background: var(--brown); color:#fff; font-weight:800;
      display:grid; place-items:center; box-shadow: var(--shadow);
    }
    .brand h1{margin:0; font-size:16px; font-weight:800; color:var(--brown); line-height:1.2}
    .brand .sub{margin-top:2px; font-size:12px; color:var(--muted)}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--border); background:#fff;
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }
    .chip b{color:var(--brown)}
    .wrap{max-width:1240px; margin:18px auto; padding:0 16px 70px;}
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      align-items:start;
    }
    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(188,143,116,.14), rgba(255,255,255,0));
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .title{margin:0; font-size:14px; font-weight:800; color:var(--brown)}
    .mini{font-size:12px; color:var(--muted); margin-top:4px; line-height:1.6}
    .card-b{padding:14px}

    .search{
      display:grid;
      grid-template-columns: 1fr 140px 160px;
      gap:10px;
      align-items:stretch;
    }
    @media (max-width: 760px){
      .search{grid-template-columns:1fr}
    }
    input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      outline:none;
      font-size:14px;
      background:#fff;
    }
    .btn{
      border:none;
      border-radius:14px;
      padding:12px 12px;
      cursor:pointer;
      font-family:inherit;
      font-weight:800;
      font-size:13px;
      transition:.15s;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn-primary{background:var(--brown); color:#fff}
    .btn-primary:hover{opacity:.92}
    .btn-ghost{
      background:#fff;
      color:var(--brown);
      border:1px solid var(--border);
    }
    .btn-ghost:disabled{opacity:.5; cursor:not-allowed}
    .row{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    label.switch{
      display:flex; align-items:center; gap:10px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:#fff;
      font-size:12px;
      color:var(--muted);
    }
    label.switch input{width:auto; accent-color: var(--brown);}
    .msg{margin-top:10px; font-size:13px; line-height:1.6}
    .ok{color:#0a7d2c}
    .err{color:#b00020}

    .kv{
      display:grid;
      grid-template-columns: 180px 1fr;
      gap:10px;
      padding:10px 0;
      border-bottom:1px dashed #f0e6dd;
    }
    .kv:last-child{border-bottom:none}
    .k{color:var(--muted); font-size:12.5px}
    .v{color:#222; font-size:13.5px; font-weight:500; word-break:break-word}

    .summary{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 980px){ .summary{grid-template-columns: repeat(2, minmax(0, 1fr));} }
    @media (max-width: 520px){ .summary{grid-template-columns: 1fr;} }
    .tile{
      border:1px solid #f0e6dd;
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .tile .t{font-size:12px; color:var(--muted)}
    .tile .v{margin-top:6px; font-weight:900; color:var(--brown); font-size:13.5px}

    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{border:1px solid #f0e6dd; padding:8px; text-align:right; vertical-align:top}
    th{background:rgba(188,143,116,.14); color:var(--brown); font-weight:900}

    .check-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 980px){ .check-grid{grid-template-columns: repeat(2, minmax(0, 1fr));} }
    @media (max-width: 520px){ .check-grid{grid-template-columns: 1fr;} }
    .check{
      border:1px solid #f0e6dd;
      border-radius:16px;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:#fff;
    }
    .check .name{font-weight:800; color:var(--brown); font-size:13px}
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .yes{color:#0a7d2c; background:rgba(10,125,44,.08)}
    .no{color:#b00020; background:rgba(176,0,32,.06)}
    details{margin-top:10px; border:1px solid #f0e6dd; border-radius:16px; padding:10px 12px; background:#fff;}
    details summary{cursor:pointer; font-weight:900; color:var(--brown)}
    pre{margin:10px 0 0; padding:10px; border-radius:14px; border:1px solid #f0e6dd; background:#fffdf9; font-size:12px; overflow:auto; direction:ltr;}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <div class="mark">MZJ</div>
        <div>
          <h1>الأرشيف</h1>
          <div class="sub">عرض احترافي بدون Timeline</div>
        </div>
      </div>
      <div class="chip">بحث بـ <b>VIN</b></div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">

      <div class="card">
        <div class="card-h">
          <div>
            <p class="title">البحث</p>
            <div class="mini">اكتب رقم الهيكل (3278) أو المفتاح (vin_003278)</div>
          </div>
          <div class="chip" id="vinBadge">VIN: —</div>
        </div>
        <div class="card-b">
          <div class="search">
            <input id="vinInput" placeholder="مثال: 3278 أو vin_003278" />
            <button class="btn btn-primary" id="btnSearch">بحث</button>
            <button class="btn btn-ghost" id="btnExport" disabled>تصدير Excel</button>
          </div>

          <div class="row">
            <label class="switch">
              <input id="ecoMode" type="checkbox" checked>
              وضع اقتصادي (تقليل القراءات)
            </label>
            <span class="mini">في الوضع الاقتصادي: الجلب تدريجي + تأخير بسيط بين الاستعلامات + الموافقات تُجلب فقط لو السيارة “تم التسليم”.</span>
          </div>

          <div class="msg" id="msg"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <div>
            <p class="title">ملخص السيارة</p>
            <div class="mini">ملخص سريع من (cars / cars_delivered_archives)</div>
          </div>
        </div>
        <div class="card-b">
          <div class="summary" id="summaryBox"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <div>
            <p class="title">بيانات السيارة (تم التسليم)</p>
            <div class="mini">cars_delivered_archives (DB1)</div>
          </div>
        </div>
        <div class="card-b" id="deliveredBox"></div>
      </div>

      <div class="card">
        <div class="card-h">
          <div>
            <p class="title">موافقات النقل المؤرشفة</p>
            <div class="mini">transfer_approvals_archives (DB1)</div>
          </div>
        </div>
        <div class="card-b" id="approvalsBox"></div>
      </div>

      <div class="card">
        <div class="card-h">
          <div>
            <p class="title">التشييك (من المخزون)</p>
            <div class="mini">cars (DB1) ثم fallback media_specs</div>
          </div>
        </div>
        <div class="card-b" id="checkBox"></div>
      </div>

      <div class="card">
        <div class="card-h">
          <div>
            <p class="title">التتبع</p>
            <div class="mini">orders/{orderNo}_{itemNo}/public/status (DB2) — جدول 10 مراحل</div>
          </div>
        </div>
        <div class="card-b" id="trackingBox"></div>
      </div>

    </div>
  </div>

  <!-- Firebase compat (أثبت على كل المتصفحات/الاستضافات) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // DB1
    const firebaseConfigMain = {
      apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
      authDomain: "mzj-agenda.firebaseapp.com",
      projectId: "mzj-agenda",
      storageBucket: "mzj-agenda.firebasestorage.app",
      messagingSenderId: "834700407721",
      appId: "1:834700407721:web:75c17665d4f032fd65cab8",
      measurementId: "G-770YFMGWQ4"
    };

    // DB2
    const firebaseConfigTrack = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.firebasestorage.app",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66",
      measurementId: "G-QT7KTRWS4J"
    };

    // Init apps
    const appMain  = firebase.initializeApp(firebaseConfigMain, "mainApp");
    const dbMain   = firebase.firestore(appMain);

    const appTrack = firebase.initializeApp(firebaseConfigTrack, "trackApp");
    const dbTrack  = firebase.firestore(appTrack);

    // Collections
    const COL_DELIVERED = "cars_delivered_archives";
    const COL_APPROVALS = "transfer_approvals_archives";
    const COL_CARS      = "cars";
    const COL_MEDIA_FALL= "media_specs";

    // Tracking sources
    const COL_ERP_VINS = "erp_vins"; // gives lastOrderNo/lastItemNo
    // orders/{orderNo}_{itemNo}/public/status

    // UI helpers
    const $ = (id)=>document.getElementById(id);
    const setMsg = (html)=>{$("msg").innerHTML = html || "";};
    const setBadge = (vinKey)=>{$("vinBadge").textContent = "VIN: " + (vinKey || "—");};

    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
    async function maybeDelay(){
      if ($("ecoMode").checked) await sleep(700);
    }

    function normalizeVinKey(input){
      const t = String(input||"").trim();
      if (!t) return null;
      if (t.toLowerCase().startsWith("vin_")) return t;
      const digits = t.replace(/\D+/g,"");
      if (!digits) return null;
      return "vin_" + digits.padStart(6,"0");
    }

    function safe(v){
      if (v === undefined || v === null) return "";
      // firestore Timestamp compat
      if (v && typeof v.toDate === "function") return v.toDate().toLocaleString("ar-SA");
      return String(v);
    }

    function renderKV(obj, keys){
      if (!obj) return `<div class="mini">لا توجد بيانات.</div>`;
      return keys.map(k=>`
        <div class="kv">
          <div class="k">${k}</div>
          <div class="v">${safe(obj[k])}</div>
        </div>
      `).join("");
    }

    async function getDocById(db, col, id){
      const snap = await db.collection(col).doc(id).get();
      return snap.exists ? ({ id: snap.id, ...snap.data() }) : null;
    }

    async function getDocsByIdPrefix(db, col, prefix){
      // Firestore compat supports ordering by __name__
      const qs = await db.collection(col)
        .orderBy(firebase.firestore.FieldPath.documentId())
        .startAt(prefix)
        .endAt(prefix + "\uf8ff")
        .get();

      const out = [];
      qs.forEach(d=>out.push({ id:d.id, ...d.data() }));
      return out;
    }

    // DB1 fetchers
    async function fetchDelivered(vinKey){
      return await getDocById(dbMain, COL_DELIVERED, vinKey);
    }
    async function fetchApprovals(vinKey){
      return await getDocsByIdPrefix(dbMain, COL_APPROVALS, vinKey + "_");
    }
    async function fetchChecklist(vinKey){
      const car = await getDocById(dbMain, COL_CARS, vinKey);
      if (car) return { _source:"cars", ...car };

      const m1 = await getDocById(dbMain, COL_MEDIA_FALL, vinKey);
      if (m1) return { _source:"media_specs", ...m1 };

      const mList = await getDocsByIdPrefix(dbMain, COL_MEDIA_FALL, vinKey);
      if (mList && mList.length) return { _source:"media_specs", ...mList[0] };

      return null;
    }

    // DB2 tracking: erp_vins -> order status
    async function fetchTrackingStatusByVinKey(vinKey){
      const raw = vinKey.replace("vin_","");
      // Try docId = vinKey then raw
      let vinDoc = await getDocById(dbTrack, COL_ERP_VINS, vinKey);
      if (!vinDoc) vinDoc = await getDocById(dbTrack, COL_ERP_VINS, raw);
      if (!vinDoc) return null;

      const orderNo = vinDoc.lastOrderNo || (vinDoc.lastData && vinDoc.lastData.orderNo) || "";
      const itemNo  = vinDoc.lastItemNo || (vinDoc.lastData && vinDoc.lastData.itemNo) || 1;
      if (!orderNo) return { vinDoc, orderNo:"", itemNo, status:null };

      const docId = orderNo + "_" + (itemNo || 1);
      const statusSnap = await dbTrack.collection("orders").doc(docId).collection("public").doc("status").get();
      const status = statusSnap.exists ? ({ id: statusSnap.id, ...statusSnap.data() }) : null;

      return { vinDoc, orderNo, itemNo, status };
    }

    // Render summary tiles
    function renderSummary({vinKey, delivered, checklist}){
      const carName = delivered?.car || checklist?.car || checklist?.carName || "";
      const modelYear = delivered?.modelYear || checklist?.modelYear || checklist?.year || "";
      const location = delivered?.location || checklist?.location || "";
      const deliveredAt = delivered?.deliveredAt || delivered?.archivedAt || "";

      const tiles = [
        { t:"VIN", v: vinKey },
        { t:"السيارة", v: carName || "—" },
        { t:"الموديل", v: modelYear || "—" },
        { t:"الموقع", v: location || "—" },
        { t:"تاريخ التسليم/الأرشفة", v: safe(deliveredAt) || "—" },
        { t:"مصدر التشييك", v: checklist?._source ? checklist._source : "—" },
      ];

      $("summaryBox").innerHTML = tiles.map(x=>`
        <div class="tile">
          <div class="t">${x.t}</div>
          <div class="v">${x.v}</div>
        </div>
      `).join("");
    }

    function renderDelivered(delivered){
      $("deliveredBox").innerHTML = delivered
        ? renderKV(delivered, ["car","modelYear","location","batchName","dealer","extColor","intColor","delivered","deliveredAt","financeApproved","adminApproved","adminNotes","archivedAt","archivedFrom","notes"])
        : `<div class="mini">لا يوجد أرشيف تسليم لهذا الـ VIN.</div>`;
    }

    function renderApprovals(list){
      if (!list || !list.length){
        $("approvalsBox").innerHTML = `<div class="mini">لا يوجد موافقات مؤرشفة لهذا الـ VIN.</div>`;
        return;
      }
      $("approvalsBox").innerHTML = `
        <table>
          <thead>
            <tr>
              <th>docId</th>
              <th>من</th>
              <th>التاريخ</th>
              <th>مالية</th>
              <th>تاريخ المالية</th>
              <th>إدارية</th>
              <th>تاريخ الإدارية</th>
              <th>archivedAt</th>
            </tr>
          </thead>
          <tbody>
            ${list.map(a=>`
              <tr>
                <td>${a.id}</td>
                <td>${safe(a.from)}</td>
                <td>${safe(a.date)}</td>
                <td>${a.financeApproved ? "✅" : "❌"}</td>
                <td>${safe(a.financeApprovedAt)}</td>
                <td>${a.adminApproved ? "✅" : "❌"}</td>
                <td>${safe(a.adminApprovedAt)}</td>
                <td>${safe(a.archivedAt)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function renderChecklist(check){
      if (!check){
        $("checkBox").innerHTML = `<div class="mini">لا يوجد تشييك لهذا الـ VIN.</div>`;
        return;
      }

      const core = check.checklist || check.inspection || check.featuresCheck || check.media_specs || check.mediaSpecs || null;

      // لو core object فيه values boolean: نعرضه Grid ✅/❌
      if (core && typeof core === "object" && !Array.isArray(core)){
        const entries = Object.entries(core);
        const booleanish = entries.filter(([k,v])=> typeof v === "boolean" || v === 0 || v === 1 || v === "0" || v === "1" );
        if (booleanish.length >= Math.min(6, entries.length)){ // أغلبه نعم/لا
          $("checkBox").innerHTML = `
            <div class="mini">المصدر: <b>${check._source}</b></div>
            <div class="check-grid" style="margin-top:10px">
              ${entries.map(([k,v])=>{
                const yes = (v === true || v === 1 || v === "1");
                return `
                  <div class="check">
                    <div class="name">${k}</div>
                    <div class="badge ${yes ? "yes" : "no"}">${yes ? "✅ موجود" : "❌ غير موجود"}</div>
                  </div>
                `;
              }).join("")}
            </div>
            <details>
              <summary>عرض الدوكيومنت كامل (للمراجعة)</summary>
              <pre>${escapeHtml(JSON.stringify(check, null, 2))}</pre>
            </details>
          `;
          return;
        }
      }

      $("checkBox").innerHTML = `
        <div class="mini">المصدر: <b>${check._source}</b></div>
        <details open>
          <summary>بيانات التشييك</summary>
          <pre>${escapeHtml(JSON.stringify(core || check, null, 2))}</pre>
        </details>
      `;
    }

    const STAGES = [
      "طلب الشراء (خاص بالعميل)",
      "إيصال الدفع (خاص بالعميل)",
      "التواصل وإرسال البطاقة الجركية (خاص بالمعرض)",
      "سداد رسوم التسجيل (خاص بالعميل)",
      "التأمين – شرط الربط (خاص بالعميل)",
      "استيفاء المبالغ المتبقية (خاص بالعميل)",
      "استيفاء الأوراق المتبقية (خاص بالعميل)",
      "إصدار اللوحات أو نقل الملكية (خاص بالمعرض)",
      "جاهزية السيارة للاستلام (خاص بالمعرض)",
      "إتمام عملية التسليم بنجاح"
    ];

    function formatTimestamp(ts){
      if (!ts) return "—";
      try{
        if (ts && typeof ts.toDate === "function") return ts.toDate().toLocaleString("ar-SA");
        if (ts.seconds) return new Date(ts.seconds * 1000).toLocaleString("ar-SA");
        const d = new Date(ts);
        if (!isNaN(d.getTime())) return d.toLocaleString("ar-SA");
      }catch(e){}
      return "—";
    }

    function renderTracking(bundle){
      if (!bundle){
        $("trackingBox").innerHTML = `<div class="mini">لا يوجد تتبع (erp_vins/status) لهذا الـ VIN.</div>`;
        return;
      }

      const status = bundle.status || null;
      const stages = status?.stages || null;

      const head = `
        <div class="mini">
          orderNo: <b>${bundle.orderNo || "—"}</b> • itemNo: <b>${bundle.itemNo || "—"}</b>
        </div>
      `;

      if (!stages){
        $("trackingBox").innerHTML = head + `
          <div class="mini" style="margin-top:10px">تم العثور على VIN في erp_vins لكن لم يتم العثور على public/status أو stages.</div>
          <details>
            <summary>عرض VIN Doc (للمراجعة)</summary>
            <pre>${escapeHtml(JSON.stringify(bundle.vinDoc, null, 2))}</pre>
          </details>
        `;
        return;
      }

      const rows = [];
      for (let i=1;i<=10;i++){
        const key = "s"+i;
        const done = stages[key];
        rows.push({
          idx:i,
          title: STAGES[i-1],
          date: formatTimestamp(done),
          state: done ? "✅ مكتملة" : "⏳ لم تكتمل"
        });
      }

      $("trackingBox").innerHTML = head + `
        <table style="margin-top:10px">
          <thead>
            <tr>
              <th>المرحلة</th>
              <th>الوصف</th>
              <th>الحالة</th>
              <th>التاريخ</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>`
              <tr>
                <td>${r.idx}</td>
                <td>${r.title}</td>
                <td>${r.state}</td>
                <td>${r.date}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function escapeHtml(str){
      return String(str||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // Export
    function downloadCSV(filename, rows){
      if (!rows || !rows.length) return;
      const keys = Object.keys(rows[0]);
      const esc = (s)=>('"'+String(s??"").replaceAll('"','""')+'"');
      const csv = [keys.join(","), ...rows.map(r=>keys.map(k=>esc(r[k])).join(","))].join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function buildExportRow(vinKey, delivered, approvals, checklist, trackingBundle){
      const firstA = approvals && approvals.length ? approvals[0] : null;
      return [{
        vinKey,
        car: delivered?.car || checklist?.car || checklist?.carName || "",
        modelYear: delivered?.modelYear || checklist?.modelYear || checklist?.year || "",
        location: delivered?.location || checklist?.location || "",
        deliveredAt: safe(delivered?.deliveredAt || delivered?.archivedAt || ""),
        financeApprovedAt: safe(firstA?.financeApprovedAt || ""),
        adminApprovedAt: safe(firstA?.adminApprovedAt || ""),
        checklist_source: checklist?._source || "",
        orderNo: trackingBundle?.orderNo || "",
        itemNo: trackingBundle?.itemNo || ""
      }];
    }

    let lastPayload = null;

    async function runSearch(){
      const vinKey = normalizeVinKey($("vinInput").value);
      setBadge(vinKey);
      $("btnExport").disabled = true;
      setMsg("");

      // clear
      $("summaryBox").innerHTML = "";
      $("deliveredBox").innerHTML = "";
      $("approvalsBox").innerHTML = "";
      $("checkBox").innerHTML = "";
      $("trackingBox").innerHTML = "";

      if (!vinKey){
        setMsg(`<div class="err">اكتب رقم هيكل صحيح.</div>`);
        return;
      }

      setMsg(`<div class="mini">جاري السحب…</div>`);

      const eco = $("ecoMode").checked;

      // 1) Checklist (cars) أولاً (مفيد للملخص) - قراءة واحدة غالباً
      const checklist = await fetchChecklist(vinKey);
      await maybeDelay();

      // 2) Delivered
      const delivered = await fetchDelivered(vinKey);
      await maybeDelay();

      // 3) Approvals (مكلف) — في الوضع الاقتصادي نخليه مشروط بوجود Delivered
      let approvals = [];
      if (!eco || delivered){
        approvals = await fetchApprovals(vinKey);
        await maybeDelay();
      }

      // 4) Tracking (DB2)
      const trackingBundle = await fetchTrackingStatusByVinKey(vinKey);
      await maybeDelay();

      // Render
      renderSummary({vinKey, delivered, checklist});
      renderDelivered(delivered);
      renderApprovals(approvals);
      renderChecklist(checklist);
      renderTracking(trackingBundle);

      lastPayload = { vinKey, delivered, approvals, checklist, trackingBundle };

      if (delivered || (approvals && approvals.length) || checklist || trackingBundle){
        $("btnExport").disabled = false;
        setMsg(`<div class="ok">تم جلب البيانات.</div>`);
      }else{
        setMsg(`<div class="err">لا توجد بيانات لهذا الـ VIN.</div>`);
      }
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      $("btnSearch").addEventListener("click", runSearch);
      $("vinInput").addEventListener("keydown", (e)=>{ if (e.key === "Enter") runSearch(); });
      $("btnExport").addEventListener("click", ()=>{
        if (!lastPayload) return;
        const rows = buildExportRow(lastPayload.vinKey, lastPayload.delivered, lastPayload.approvals, lastPayload.checklist, lastPayload.trackingBundle);
        downloadCSV(`archive_${lastPayload.vinKey}.csv`, rows);
      });

      // initial text
      $("summaryBox").innerHTML = `<div class="mini">ابدأ بالبحث…</div>`;
      $("deliveredBox").innerHTML = `<div class="mini">ابدأ بالبحث…</div>`;
      $("approvalsBox").innerHTML = `<div class="mini">ابدأ بالبحث…</div>`;
      $("checkBox").innerHTML = `<div class="mini">ابدأ بالبحث…</div>`;
      $("trackingBox").innerHTML = `<div class="mini">ابدأ بالبحث…</div>`;
    });
  </script>
</body>
</html>
