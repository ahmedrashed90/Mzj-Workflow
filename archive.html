<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>أرشيف MZJ</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --brown: rgb(62,36,32);
      --beige: rgb(188,143,116);
      --cream: #fff8ef;
      --border: #eadfd6;
      --text: #1d1d1d;
      --muted: #6f6f6f;
      --shadow: 0 10px 26px rgba(0,0,0,.08);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Tajawal", system-ui, -apple-system, Segoe UI, Arial;
      background: radial-gradient(1200px 700px at 85% 0%, rgba(188,143,116,.18), transparent 55%),
                  radial-gradient(900px 550px at 0% 15%, rgba(62,36,32,.12), transparent 55%),
                  linear-gradient(180deg, var(--cream), #fff);
      color:var(--text);
    }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background: rgba(255,248,239,.86);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .topbar .inner{
      max-width:1240px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .mark{
      width:42px; height:42px; border-radius:14px;
      background: var(--brown);
      color:#fff;
      font-weight:800;
      display:grid; place-items:center;
      box-shadow: var(--shadow);
    }
    .brand h1{margin:0; font-size:16px; font-weight:800; color:var(--brown); line-height:1.2}
    .brand .sub{margin-top:2px; font-size:12px; color:var(--muted)}
    .chips{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:12px;
      color:var(--muted);
    }
    .chip b{color:var(--brown)}

    /* Layout */
    .wrap{max-width:1240px; margin:18px auto; padding:0 16px 70px;}
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(188,143,116,.14), rgba(255,255,255,0));
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .title{margin:0; font-size:14px; font-weight:800; color:var(--brown)}
    .mini{font-size:12px; color:var(--muted); margin-top:4px}
    .card-b{padding:14px}

    /* Search */
    .search{
      display:grid;
      grid-template-columns: 1fr 140px 150px;
      gap:10px;
    }
    @media (max-width: 700px){
      .search{grid-template-columns:1fr}
    }
    input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      outline:none;
      font-size:14px;
      background:#fff;
    }
    .btn{
      border:none;
      border-radius:14px;
      padding:12px 12px;
      cursor:pointer;
      font-family:inherit;
      font-weight:800;
      font-size:13px;
      transition:.15s;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn-primary{background:var(--brown); color:#fff}
    .btn-primary:hover{opacity:.92}
    .btn-ghost{
      background:#fff;
      color:var(--brown);
      border:1px solid var(--border);
    }
    .btn-ghost:disabled{opacity:.5; cursor:not-allowed}

    .msg{margin-top:10px; font-size:13px; line-height:1.6}
    .ok{color:#0a7d2c}
    .err{color:#b00020}

    /* Key-Value */
    .kv{display:grid; grid-template-columns: 180px 1fr; gap:10px; padding:10px 0; border-bottom:1px dashed #f0e6dd;}
    .kv:last-child{border-bottom:none}
    .k{color:var(--muted); font-size:12.5px}
    .v{color:#222; font-size:13.5px; font-weight:500; word-break:break-word}

    /* Table */
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{border:1px solid #f0e6dd; padding:8px; text-align:right; vertical-align:top}
    th{background:rgba(188,143,116,.14); color:var(--brown); font-weight:900}

    /* Timeline */
    .timeline{display:flex; flex-direction:column; gap:10px;}
    .t-item{
      display:flex; gap:12px; align-items:flex-start;
      padding:12px;
      border-radius:16px;
      border:1px solid #f0e6dd;
      background:#fff;
    }
    .dot{
      width:12px; height:12px; border-radius:50%;
      background: var(--beige);
      margin-top:6px;
      box-shadow: 0 0 0 4px rgba(188,143,116,.18);
      flex:0 0 auto;
    }
    .t-main{flex:1}
    .t-title{margin:0; font-weight:900; color:var(--brown); font-size:13.5px}
    .t-meta{margin-top:4px; color:var(--muted); font-size:12.5px; line-height:1.5}
    .t-date{display:inline-flex; padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--brown); font-weight:800; font-size:12px}

    details{border:1px solid #f0e6dd; border-radius:16px; padding:10px 12px; background:#fff;}
    details summary{cursor:pointer; font-weight:900; color:var(--brown)}
    pre{
      margin:10px 0 0;
      padding:10px;
      border-radius:14px;
      border:1px solid #f0e6dd;
      background:#fffdf9;
      font-size:12px;
      overflow:auto;
      direction:ltr;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <div class="mark">MZJ</div>
        <div>
          <h1>الأرشيف</h1>
          <div class="sub">سيارات تم التسليم • موافقات النقل • تشييك المخزون • تتبع</div>
        </div>
      </div>
      <div class="chips">
        <div class="chip">بحث بـ <b>VIN</b></div>
        <div class="chip">عرض فقط</div>
        <div class="chip">Export Excel</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">

      <!-- Search / Results -->
      <div class="card">
        <div class="card-h">
          <div>
            <p class="title">البحث</p>
            <div class="mini">اكتب رقم الهيكل (3278) أو المفتاح (vin_003278)</div>
          </div>
          <div class="t-date" id="vinBadge">VIN: —</div>
        </div>
        <div class="card-b">
          <div class="search">
            <input id="vinInput" placeholder="مثال: 3278 أو vin_003278" />
            <button class="btn btn-primary" id="btnSearch">بحث</button>
            <button class="btn btn-ghost" id="btnExport" disabled>تصدير Excel</button>
          </div>
          <div class="msg" id="msg"></div>
        </div>
      </div>

      <!-- Timeline -->
      <div class="card">
        <div class="card-h">
          <div>
            <p class="title">Timeline</p>
            <div class="mini">كل الأحداث بالتواريخ (تسليم/موافقات/تتبع)</div>
          </div>
          <div class="t-date" id="tlCount">0</div>
        </div>
        <div class="card-b">
          <div class="timeline" id="timeline"></div>
        </div>
      </div>

      <!-- Delivered -->
      <div class="card">
        <div class="card-h">
          <div>
            <p class="title">بيانات السيارة (تم التسليم)</p>
            <div class="mini">cars_delivered_archives (DB1)</div>
          </div>
        </div>
        <div class="card-b" id="deliveredBox"></div>
      </div>

      <!-- Approvals -->
      <div class="card">
        <div class="card-h">
          <div>
            <p class="title">موافقات النقل المؤرشفة</p>
            <div class="mini">transfer_approvals_archives (DB1)</div>
          </div>
        </div>
        <div class="card-b" id="approvalsBox"></div>
      </div>

      <!-- Checklist -->
      <div class="card">
        <div class="card-h">
          <div>
            <p class="title">التشييك (من المخزون)</p>
            <div class="mini">cars (DB1) ثم fallback media_specs</div>
          </div>
        </div>
        <div class="card-b" id="checkBox"></div>
      </div>

      <!-- Tracking -->
      <div class="card">
        <div class="card-h">
          <div>
            <p class="title">التتبع</p>
            <div class="mini">erp_vins (DB2) – Timeline تلقائي</div>
          </div>
        </div>
        <div class="card-b" id="trackingBox"></div>
      </div>

    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, getDoc, collection, getDocs,
      query, orderBy, startAt, endAt
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // DB1
    const firebaseConfigMain = {
      apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
      authDomain: "mzj-agenda.firebaseapp.com",
      projectId: "mzj-agenda",
      storageBucket: "mzj-agenda.firebasestorage.app",
      messagingSenderId: "834700407721",
      appId: "1:834700407721:web:75c17665d4f032fd65cab8",
      measurementId: "G-770YFMGWQ4"
    };

    // DB2
    const firebaseConfigTrack = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.firebasestorage.app",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66",
      measurementId: "G-QT7KTRWS4J"
    };

    const appMain  = initializeApp(firebaseConfigMain, "mainApp");
    const dbMain   = getFirestore(appMain);

    const appTrack = initializeApp(firebaseConfigTrack, "trackApp");
    const dbTrack  = getFirestore(appTrack);

    // DB1 collections
    const COL_DELIVERED = "cars_delivered_archives";
    const COL_APPROVALS = "transfer_approvals_archives";
    const COL_CARS      = "cars";
    const COL_MEDIA_FALL= "media_specs";

    // DB2
    const COL_TRACKING  = "erp_vins";

    const $ = (id)=>document.getElementById(id);
    const setMsg = (html)=>$("msg").innerHTML = html || "";
    const setBadge = (vinKey)=>$("vinBadge").textContent = "VIN: " + (vinKey || "—");

    function normalizeVinKey(input){
      const t = String(input||"").trim();
      if (!t) return null;
      if (t.toLowerCase().startsWith("vin_")) return t;
      const digits = t.replace(/\D+/g,"");
      if (!digits) return null;
      return "vin_" + digits.padStart(6,"0");
    }

    function safe(v){
      if (v === undefined || v === null) return "";
      if (typeof v === "object" && typeof v.toDate === "function") return v.toDate().toLocaleString("ar-SA");
      return String(v);
    }

    function kvList(obj, keys){
      if (!obj) return `<div class="mini">لا توجد بيانات.</div>`;
      return keys.map(k=>`
        <div class="kv">
          <div class="k">${k}</div>
          <div class="v">${safe(obj[k])}</div>
        </div>
      `).join("");
    }

    async function getDocById(db, col, id){
      const ref = doc(db, col, id);
      const snap = await getDoc(ref);
      return snap.exists() ? { id:snap.id, ...snap.data() } : null;
    }

    async function getDocsByIdPrefix(db, colName, prefix){
      const c = collection(db, colName);
      const qy = query(c, orderBy("__name__"), startAt(prefix), endAt(prefix + "\uf8ff"));
      const qs = await getDocs(qy);
      const out = [];
      qs.forEach(d=>out.push({ id:d.id, ...d.data() }));
      return out;
    }

    async function getDelivered(vinKey){ return await getDocById(dbMain, COL_DELIVERED, vinKey); }
    async function getApprovals(vinKey){ return await getDocsByIdPrefix(dbMain, COL_APPROVALS, vinKey + "_"); }

    async function getChecklist(vinKey){
      const c = await getDocById(dbMain, COL_CARS, vinKey);
      if (c) return { _source:"cars", ...c };

      const m1 = await getDocById(dbMain, COL_MEDIA_FALL, vinKey);
      if (m1) return { _source:"media_specs", ...m1 };

      const mList = await getDocsByIdPrefix(dbMain, COL_MEDIA_FALL, vinKey);
      if (mList?.length) return { _source:"media_specs", ...mList[0] };

      return null;
    }

    async function getTracking(vinKey){
      const raw = vinKey.replace("vin_","");
      const a = await getDocById(dbTrack, COL_TRACKING, vinKey);
      if (a) return { _docIdTried: vinKey, ...a };

      const b = await getDocById(dbTrack, COL_TRACKING, raw);
      if (b) return { _docIdTried: raw, ...b };

      return null;
    }

    // ---------- Tracking Parser (turn to timeline) ----------
    function isDateLikeKey(k){
      const kk = k.toLowerCase();
      return kk.endsWith("at") || kk.endsWith("date") || kk.includes("date") || kk.includes("time");
    }

    function valueToDateString(v){
      const s = safe(v);
      if (!s) return "";
      return s;
    }

    function buildTrackingTimeline(tracking){
      if (!tracking) return [];

      // 1) stages object/array
      const stages = tracking.stages || tracking.stage || tracking.timeline || tracking.steps || null;
      if (stages){
        const out = [];
        if (Array.isArray(stages)){
          stages.forEach((st, i)=>{
            const name = st?.label || st?.name || st?.title || `مرحلة ${i+1}`;
            const at = st?.at || st?.date || st?.time || st?.createdAt || st?.updatedAt || "";
            const meta = st?.note || st?.message || st?.status || "";
            out.push({ title: name, date: valueToDateString(at) || "—", meta: meta ? String(meta) : "" });
          });
          return out.filter(x=>x.title);
        }
        // object keyed by stage number/name
        for (const key of Object.keys(stages)){
          const st = stages[key];
          const name = st?.label || st?.name || st?.title || `مرحلة ${key}`;
          const at = st?.at || st?.date || st?.time || st?.createdAt || st?.updatedAt || "";
          const meta = st?.note || st?.message || st?.status || "";
          out.push({ title: name, date: valueToDateString(at) || "—", meta: meta ? String(meta) : "" });
        }
        return out;
      }

      // 2) scan fields ending with At/Date
      const pairs = [];
      for (const [k,v] of Object.entries(tracking)){
        if (!isDateLikeKey(k)) continue;
        const d = valueToDateString(v);
        if (!d) continue;
        pairs.push({ key:k, date:d });
      }
      pairs.sort((a,b)=>String(a.key).localeCompare(String(b.key)));
      return pairs.map(p=>({
        title: p.key,
        date: p.date,
        meta: ""
      }));
    }

    // ---------- UI Render ----------
    function renderTimeline(events){
      const box = $("timeline");
      $("tlCount").textContent = String(events?.length || 0);

      if (!events?.length){
        box.innerHTML = `
          <div class="t-item">
            <div class="dot"></div>
            <div class="t-main">
              <p class="t-title">لا توجد بيانات بعد</p>
              <div class="t-meta">اكتب VIN وابحث.</div>
            </div>
          </div>`;
        return;
      }

      box.innerHTML = events.map(e=>`
        <div class="t-item">
          <div class="dot"></div>
          <div class="t-main">
            <p class="t-title">${e.title}</p>
            <div class="t-meta">${e.date}${e.meta ? " • " + e.meta : ""}</div>
          </div>
        </div>
      `).join("");
    }

    function renderDelivered(delivered){
      $("deliveredBox").innerHTML = delivered
        ? kvList(delivered, ["car","modelYear","location","batchName","dealer","extColor","intColor","delivered","deliveredAt","financeApproved","adminApproved","adminNotes","archivedAt","archivedFrom","notes"])
        : `<div class="mini">لا يوجد أرشيف تسليم لهذا الـ VIN.</div>`;
    }

    function renderApprovals(list){
      if (!list?.length){
        $("approvalsBox").innerHTML = `<div class="mini">لا يوجد موافقات مؤرشفة لهذا الـ VIN.</div>`;
        return;
      }
      $("approvalsBox").innerHTML = `
        <table>
          <thead>
            <tr>
              <th>docId</th>
              <th>من</th>
              <th>التاريخ</th>
              <th>مالية</th>
              <th>تاريخ المالية</th>
              <th>إدارية</th>
              <th>تاريخ الإدارية</th>
              <th>archivedAt</th>
            </tr>
          </thead>
          <tbody>
            ${list.map(a=>`
              <tr>
                <td>${a.id}</td>
                <td>${safe(a.from)}</td>
                <td>${safe(a.date)}</td>
                <td>${a.financeApproved ? "✅" : "❌"}</td>
                <td>${safe(a.financeApprovedAt)}</td>
                <td>${a.adminApproved ? "✅" : "❌"}</td>
                <td>${safe(a.adminApprovedAt)}</td>
                <td>${safe(a.archivedAt)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function renderChecklist(check){
      if (!check){
        $("checkBox").innerHTML = `<div class="mini">لا يوجد تشييك لهذا الـ VIN.</div>`;
        return;
      }
      // لو عندك كائن تشييك واضح، هنحاول نعرضه بشكل مرتب
      const core = check.checklist || check.inspection || check.featuresCheck || check.media_specs || null;

      if (core && typeof core === "object"){
        // عرض كـ Key/Value سريع
        const lines = Object.entries(core).slice(0, 60).map(([k,v])=>`
          <div class="kv"><div class="k">${k}</div><div class="v">${safe(v)}</div></div>
        `).join("");
        $("checkBox").innerHTML = `
          <div class="mini">المصدر: <b>${check._source}</b></div>
          ${lines || `<div class="mini">التشييك موجود لكن فاضي.</div>`}
          <details style="margin-top:10px">
            <summary>عرض الدوكيومنت كامل</summary>
            <pre>${JSON.stringify(check, null, 2)}</pre>
          </details>
        `;
        return;
      }

      // fallback
      $("checkBox").innerHTML = `
        <div class="mini">المصدر: <b>${check._source}</b></div>
        <details open>
          <summary>Document كامل</summary>
          <pre>${JSON.stringify(check, null, 2)}</pre>
        </details>
      `;
    }

    function renderTracking(tracking){
      if (!tracking){
        $("trackingBox").innerHTML = `<div class="mini">لا يوجد تتبع لهذا الـ VIN داخل erp_vins (DB2).</div>`;
        return;
      }

      const tEvents = buildTrackingTimeline(tracking);
      if (tEvents.length){
        $("trackingBox").innerHTML = `
          <div class="mini">تم تحويل بيانات التتبع إلى مراحل تلقائيًا. (docId: <b>${tracking._docIdTried || tracking.id}</b>)</div>
          <div class="timeline" style="margin-top:10px">
            ${tEvents.map(e=>`
              <div class="t-item">
                <div class="dot"></div>
                <div class="t-main">
                  <p class="t-title">${e.title}</p>
                  <div class="t-meta">${e.date}${e.meta ? " • " + e.meta : ""}</div>
                </div>
              </div>
            `).join("")}
          </div>
          <details style="margin-top:10px">
            <summary>عرض JSON (للمراجعة فقط)</summary>
            <pre>${JSON.stringify(tracking, null, 2)}</pre>
          </details>
        `;
      } else {
        $("trackingBox").innerHTML = `
          <div class="mini">لم يتم العثور على حقول مراحل واضحة داخل التتبع. (docId: <b>${tracking._docIdTried || tracking.id}</b>)</div>
          <details open style="margin-top:10px">
            <summary>JSON</summary>
            <pre>${JSON.stringify(tracking, null, 2)}</pre>
          </details>
        `;
      }
    }

    // ---------- Export ----------
    function downloadCSV(filename, rows){
      if (!rows?.length) return;
      const keys = Object.keys(rows[0]);
      const esc = (s)=>('"'+String(s??"").replace(/"/g,'""')+'"');
      const csv = [keys.join(","), ...rows.map(r=>keys.map(k=>esc(r[k])).join(","))].join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function buildExportRow(vinKey, delivered, approvals, checklist, tracking){
      const firstA = approvals?.[0] || null;
      const tEvents = buildTrackingTimeline(tracking);

      return [{
        vinKey,
        car: delivered?.car || checklist?.car || "",
        modelYear: delivered?.modelYear || checklist?.modelYear || "",
        location: delivered?.location || checklist?.location || "",
        deliveredAt: delivered?.deliveredAt || "",
        financeApprovedAt: firstA?.financeApprovedAt || "",
        adminApprovedAt: firstA?.adminApprovedAt || "",
        checklist_source: checklist?._source || "",
        tracking_events_count: tEvents.length,
        tracking_first: tEvents[0] ? `${tEvents[0].title} | ${tEvents[0].date}` : "",
        tracking_last: tEvents.length ? `${tEvents[tEvents.length-1].title} | ${tEvents[tEvents.length-1].date}` : ""
      }];
    }

    let lastPayload = null;

    // ---------- Search ----------
    async function runSearch(){
      $("btnExport").disabled = true;
      setMsg("");
      const vinKey = normalizeVinKey($("vinInput").value);
      setBadge(vinKey);

      if (!vinKey){
        setMsg(`<div class="err">اكتب رقم هيكل صحيح.</div>`);
        renderTimeline([]);
        $("deliveredBox").innerHTML = "";
        $("approvalsBox").innerHTML = "";
        $("checkBox").innerHTML = "";
        $("trackingBox").innerHTML = "";
        return;
      }

      setMsg(`<div class="mini">جاري البحث…</div>`);

      const [delivered, approvals, checklist, tracking] = await Promise.all([
        getDelivered(vinKey),
        getApprovals(vinKey),
        getChecklist(vinKey),
        getTracking(vinKey)
      ]);

      renderDelivered(delivered);
      renderApprovals(approvals);
      renderChecklist(checklist);
      renderTracking(tracking);

      // Unified timeline
      const events = [];

      // delivered
      if (delivered){
        events.push({ title:"تم التسليم", date: safe(delivered.deliveredAt || delivered.archivedAt) || "—", meta: delivered.location ? `الموقع: ${safe(delivered.location)}` : "" });
        events.push({ title:"أرشفة التسليم", date: safe(delivered.archivedAt) || "—", meta: delivered.archivedFrom ? `من: ${safe(delivered.archivedFrom)}` : "" });
      }

      // approvals
      if (approvals?.length){
        approvals.forEach((a, idx)=>{
          events.push({ title:`طلب موافقات نقل #${idx+1}`, date: safe(a.date) || "—", meta: a.from ? `من: ${safe(a.from)}` : "" });
          if (a.financeApprovedAt) events.push({ title:"موافقة مالية", date: safe(a.financeApprovedAt) || "—", meta:"" });
          if (a.adminApprovedAt) events.push({ title:"موافقة إدارية", date: safe(a.adminApprovedAt) || "—", meta:"" });
          if (a.archivedAt) events.push({ title:"أرشفة الموافقات", date: safe(a.archivedAt) || "—", meta:"" });
        });
      }

      // tracking timeline
      const tEvents = buildTrackingTimeline(tracking);
      tEvents.forEach(t=>{
        events.push({ title:`تتبع: ${t.title}`, date: t.date || "—", meta: t.meta || "" });
      });

      renderTimeline(events);

      lastPayload = { vinKey, delivered, approvals, checklist, tracking };
      if (delivered || approvals?.length || checklist || tracking){
        $("btnExport").disabled = false;
        setMsg(`<div class="ok">تم جلب بيانات الأرشيف.</div>`);
      } else {
        setMsg(`<div class="err">لا توجد بيانات أرشيف لهذا الـ VIN.</div>`);
      }
    }

    $("btnSearch").addEventListener("click", runSearch);
    $("vinInput").addEventListener("keydown", (e)=>{ if (e.key==="Enter") runSearch(); });

    $("btnExport").addEventListener("click", ()=>{
      if (!lastPayload) return;
      const rows = buildExportRow(lastPayload.vinKey, lastPayload.delivered, lastPayload.approvals, lastPayload.checklist, lastPayload.tracking);
      downloadCSV(`archive_${lastPayload.vinKey}.csv`, rows);
    });

    // initial
    renderTimeline([]);
    $("deliveredBox").innerHTML = `<div class="mini">ابدأ بالبحث…</div>`;
    $("approvalsBox").innerHTML = `<div class="mini">ابدأ بالبحث…</div>`;
    $("checkBox").innerHTML = `<div class="mini">ابدأ بالبحث…</div>`;
    $("trackingBox").innerHTML = `<div class="mini">ابدأ بالبحث…</div>`;
  </script>
</body>
</html>
