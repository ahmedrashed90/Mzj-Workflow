<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>أرشيف الطلبات والسيارات</title>

  <style>
    body{font-family: Tahoma, Arial; background:#fff; margin:0; color:#111;}
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px;}
    .card{border:1px solid #e6e6e6; border-radius:12px; padding:14px; margin:12px 0; background:#fff;}
    .row{display:flex; gap:10px; flex-wrap:wrap;}
    .row > *{flex:1;}
    input,button{padding:12px 12px; border-radius:10px; border:1px solid #ddd; font-size:14px;}
    button{cursor:pointer}
    .muted{color:#666; font-size:13px}
    .k{display:grid; grid-template-columns: 180px 1fr; gap:8px; padding:6px 0; border-bottom:1px dashed #eee;}
    .k:last-child{border-bottom:none}
    .h{font-weight:700; margin-bottom:10px}
    .badge{display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid #ddd; font-size:12px}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{border:1px solid #eee; padding:8px; text-align:right; vertical-align:top}
    th{background:#fafafa}
    .err{color:#b00020}
    .ok{color:#0a7d2c}
    pre{background:#fafafa; border:1px solid #eee; padding:10px; border-radius:10px; overflow:auto}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="h">صفحة الأرشيف (VIN Hub)</div>
      <div class="row">
        <input id="qInput" placeholder="اكتب VIN (مثال: 3278 أو vin_003278) أو رقم طلب مبيعات (SAL-ORD-...)" />
        <button id="btnSearch">بحث</button>
        <button id="btnExport" disabled>تصدير Excel (CSV)</button>
      </div>
      <div class="muted" style="margin-top:8px">
        VIN: cars_delivered_archives + transfer_approvals_archives + media_specs (DB1) + Tracking (DB2) <br>
        Sales Order: sales_archives (DB2)
      </div>
      <div id="msg" style="margin-top:10px"></div>
    </div>

    <div id="results"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, getDoc, collection,
      query, getDocs, orderBy, startAt, endAt
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /***********************
     * 1) Firebase Configs
     ***********************/
    // DB1 (mzj-agenda) ✅
    const firebaseConfigMain = {
      apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
      authDomain: "mzj-agenda.firebaseapp.com",
      projectId: "mzj-agenda",
      storageBucket: "mzj-agenda.firebasestorage.app",
      messagingSenderId: "834700407721",
      appId: "1:834700407721:web:75c17665d4f032fd65cab8",
      measurementId: "G-770YFMGWQ4"
    };

    // DB2 (mzj-tracking) ✅
    const firebaseConfigTrack = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.firebasestorage.app",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66",
      measurementId: "G-QT7KTRWS4J"
    };

    const appMain  = initializeApp(firebaseConfigMain, "mainApp");
    const dbMain   = getFirestore(appMain);

    const appTrack = initializeApp(firebaseConfigTrack, "trackApp");
    const dbTrack  = getFirestore(appTrack);

    /***********************
     * 2) Collections
     ***********************/
    // DB1 Archives
    const COL_DELIVERED = "cars_delivered_archives";
    const COL_APPROVALS = "transfer_approvals_archives";
    const COL_MEDIA     = "media_specs";

    // DB2 Sales Archives (حسب الصورة)
    const COL_SALES_ARCH = "sales_archives";

    // DB2 Tracking (مش متأكد من الاسم النهائي عندك، فهنجرب كذا اسم)
    const TRACKING_COLLECTION_CANDIDATES = [
      "tracking",
      "trackings",
      "vin_tracking",
      "vinTracking",
      "orders",       // (لو التتبع مخزن هنا عندك)
      "erp_orders"    // (أحياناً التتبع يبقى جزء من order doc)
    ];

    /***********************
     * Helpers
     ***********************/
    const $ = (id)=>document.getElementById(id);
    const msg = (html)=>{$("msg").innerHTML = html || "";};

    function normalizeVinKey(input){
      const t = String(input||"").trim();
      if (!t) return null;
      if (t.toLowerCase().startsWith("vin_")) return t;

      const digits = t.replace(/\D+/g,"");
      if (!digits) return null;

      const padded = digits.padStart(6,"0");
      return "vin_" + padded;
    }

    function isSalesOrderNo(input){
      const t = String(input||"").trim().toUpperCase();
      return t.startsWith("SAL-ORD-");
    }

    function safe(v){
      if (v === undefined || v === null) return "";
      if (typeof v === "object" && typeof v.toDate === "function") {
        return v.toDate().toLocaleString("ar-SA");
      }
      return String(v);
    }

    function renderKV(title, obj, keys){
      const rows = keys.map(k=>{
        const val = obj?.[k];
        return `<div class="k"><div class="muted">${k}</div><div>${safe(val)}</div></div>`;
      }).join("");
      return `<div class="card"><div class="h">${title}</div>${rows || "<div class='muted'>لا توجد بيانات</div>"}</div>`;
    }

    async function getDocById(db, col, id){
      const ref = doc(db, col, id);
      const snap = await getDoc(ref);
      return snap.exists() ? { id:snap.id, ...snap.data() } : null;
    }

    // Query: docId يبدأ بـ prefix (مثلاً vin_003278_)
    async function getDocsByIdPrefix(db, colName, prefix){
      const c = collection(db, colName);
      const qy = query(c, orderBy("__name__"), startAt(prefix), endAt(prefix + "\uf8ff"));
      const qs = await getDocs(qy);
      const out = [];
      qs.forEach(d=>out.push({id:d.id, ...d.data()}));
      return out;
    }

    // DB1: delivered by exact docId = vinKey
    async function getDeliveredByVinKey(vinKey){
      return await getDocById(dbMain, COL_DELIVERED, vinKey);
    }

    // DB1: approvals by docId prefix = vinKey + "_"
    async function getApprovalsByVinKey(vinKey){
      return await getDocsByIdPrefix(dbMain, COL_APPROVALS, vinKey + "_");
    }

    // DB1: media_specs (نجرب docId = vinKey، ولو لا نجرب prefix query)
    async function getMediaSpecsByVinKey(vinKey){
      const exact = await getDocById(dbMain, COL_MEDIA, vinKey);
      if (exact) return exact;

      const list = await getDocsByIdPrefix(dbMain, COL_MEDIA, vinKey);
      if (list?.length) return list[0];
      return null;
    }

    // DB2: Tracking tries multiple collections + tries docId forms
    async function getTrackingFromDB2(vinKey){
      const candidatesDocIds = [
        vinKey,                 // vin_003278
        vinKey.replace("vin_",""), // 003278
      ];

      for (const colName of TRACKING_COLLECTION_CANDIDATES){
        for (const docId of candidatesDocIds){
          try{
            const snap = await getDocById(dbTrack, colName, docId);
            if (snap) return { _collection: colName, ...snap };
          } catch(e){
            // ignore
          }
        }
      }
      return null;
    }

    // DB2: Sales archive by orderNo (docId = SAL-ORD-....)
    async function getSalesArchive(orderNo){
      const id = String(orderNo).trim();
      return await getDocById(dbTrack, COL_SALES_ARCH, id);
    }

    function buildExportRow(payload){
      const { kind } = payload;

      if (kind === "sales"){
        const s = payload.sales || {};
        return [{
          kind: "sales_archives",
          orderNo: s.orderNo || s.id || "",
          archivedAt: safe(s.archivedAt || ""),
          archivedBy: s.archivedBy || ""
        }];
      }

      const vinKey = payload.vinKey;
      const delivered = payload.delivered;
      const approvals = payload.approvals || [];
      const media = payload.media || null;
      const tracking = payload.tracking || null;

      const firstA = approvals.length ? approvals[0] : null;

      return [{
        kind: "vin_archive",
        vinKey,
        car: delivered?.car || "",
        modelYear: delivered?.modelYear || "",
        location: delivered?.location || "",
        batchName: delivered?.batchName || "",
        dealer: delivered?.dealer || "",
        extColor: delivered?.extColor || "",
        intColor: delivered?.intColor || "",
        deliveredAt: delivered?.deliveredAt || "",
        financeApprovedAt: firstA?.financeApprovedAt || "",
        adminApprovedAt: firstA?.adminApprovedAt || "",
        archivedAtDelivered: safe(delivered?.archivedAt || ""),
        archivedAtApprovals: firstA ? safe(firstA.archivedAt || "") : "",
        media_specs_json: media ? JSON.stringify(media) : "",
        tracking_collection: tracking?._collection || "",
        tracking_json: tracking ? JSON.stringify(tracking) : ""
      }];
    }

    function downloadCSV(filename, rows){
      if (!rows?.length) return;
      const keys = Object.keys(rows[0]);

      const esc = (s)=>('"'+String(s??"").replace(/"/g,'""')+'"');
      const csv = [
        keys.join(","),
        ...rows.map(r=>keys.map(k=>esc(r[k])).join(","))
      ].join("\n");

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    let lastPayload = null;

    async function runSearch(){
      $("btnExport").disabled = true;
      $("results").innerHTML = "";
      msg("");

      const input = String($("qInput").value||"").trim();
      if (!input){
        msg("<div class='err'>اكتب VIN أو رقم طلب.</div>");
        return;
      }

      msg("<div class='muted'>جاري البحث…</div>");

      // Case 1: Sales Order
      if (isSalesOrderNo(input)){
        const sales = await getSalesArchive(input);

        lastPayload = { kind:"sales", sales };
        const parts = [];
        parts.push(renderKV("أرشيف أوامر المبيعات – sales_archives (DB2)", sales, [
          "orderNo","archivedBy","archivedAt"
        ]));

        $("results").innerHTML = parts.join("");

        if (sales){
          $("btnExport").disabled = false;
          msg(`<div class='ok'>تم. OrderNo: <span class='badge'>${sales.orderNo || sales.id}</span></div>`);
        } else {
          msg(`<div class='err'>لم يتم العثور على هذا الطلب في sales_archives.</div>`);
        }
        return;
      }

      // Case 2: VIN
      const vinKey = normalizeVinKey(input);
      if (!vinKey){
        msg("<div class='err'>VIN غير صحيح.</div>");
        return;
      }

      const [delivered, approvals, media, tracking] = await Promise.all([
        getDeliveredByVinKey(vinKey),
        getApprovalsByVinKey(vinKey),
        getMediaSpecsByVinKey(vinKey),
        getTrackingFromDB2(vinKey)
      ]);

      lastPayload = { kind:"vin", vinKey, delivered, approvals, media, tracking };

      const parts = [];

      parts.push(renderKV("بيانات السيارة (تم التسليم) – cars_delivered_archives (DB1)", delivered, [
        "car","modelYear","location","batchName","dealer","extColor","intColor",
        "delivered","deliveredAt","financeApproved","adminApproved","adminNotes","archivedAt","archivedFrom","notes"
      ]));

      parts.push(`<div class="card">
        <div class="h">التشييك / Media Specs – media_specs (DB1)</div>
        ${media ? `<pre>${JSON.stringify(media, null, 2)}</pre>` : `<div class="muted">لا يوجد media_specs لهذا الـ VIN (أو docId مختلف).</div>`}
      </div>`);

      if (approvals?.length){
        parts.push(`
          <div class="card">
            <div class="h">موافقات النقل – transfer_approvals_archives (DB1) (${approvals.length})</div>
            <table>
              <thead>
                <tr>
                  <th>docId</th>
                  <th>من</th>
                  <th>التاريخ</th>
                  <th>مالية</th>
                  <th>تاريخ المالية</th>
                  <th>إدارية</th>
                  <th>تاريخ الإدارية</th>
                  <th>archivedAt</th>
                </tr>
              </thead>
              <tbody>
                ${approvals.map(a=>`
                  <tr>
                    <td>${a.id}</td>
                    <td>${safe(a.from)}</td>
                    <td>${safe(a.date)}</td>
                    <td>${a.financeApproved ? "✅" : "❌"}</td>
                    <td>${safe(a.financeApprovedAt)}</td>
                    <td>${a.adminApproved ? "✅" : "❌"}</td>
                    <td>${safe(a.adminApprovedAt)}</td>
                    <td>${safe(a.archivedAt)}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        `);
      } else {
        parts.push(`<div class="card"><div class="h">موافقات النقل</div><div class="muted">لا يوجد أرشيف موافقات لهذا الـ VIN.</div></div>`);
      }

      parts.push(`
        <div class="card">
          <div class="h">التتبع (DB2)</div>
          ${tracking
            ? `<div class="muted">Collection: <span class="badge">${tracking._collection}</span></div><pre>${JSON.stringify(tracking, null, 2)}</pre>`
            : `<div class="muted">لم يتم العثور على تتبع لهذا الـ VIN (قد يكون اسم collection مختلف أو docId مختلف).</div>`}
        </div>
      `);

      $("results").innerHTML = parts.join("");

      if (delivered || approvals?.length || media || tracking){
        $("btnExport").disabled = false;
        msg(`<div class='ok'>تم. VIN Key: <span class='badge'>${vinKey}</span></div>`);
      } else {
        msg(`<div class='err'>لا توجد بيانات أرشيف لهذا الـ VIN: <span class='badge'>${vinKey}</span></div>`);
      }
    }

    $("btnSearch").addEventListener("click", runSearch);
    $("qInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") runSearch(); });

    $("btnExport").addEventListener("click", ()=>{
      if (!lastPayload) return;
      const rows = buildExportRow(lastPayload);
      const name = lastPayload.kind === "sales"
        ? `sales_archive_${(lastPayload.sales?.orderNo || "unknown")}.csv`
        : `archive_${lastPayload.vinKey}.csv`;
      downloadCSV(name, rows);
    });
  </script>
</body>
</html>
