
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <link rel="icon" type="image/x-icon" href="assets/favicon.png">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>MZJ | Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>

  <!-- Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ -->
  <link rel="stylesheet" href="mzj-mobile.css">

  <style>
    html.auth-pending body{opacity:0; pointer-events:none;}

    /* ===== Page layout (mobile full-bleed like Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØµÙØ­Ø§Øª) ===== */
    body{font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    .mzj-page{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 150px; /* bottom space for downbar */
    }
    .mzj-hero{
      text-align:center;
      margin-top: 6px;
      margin-bottom: 14px;
    }
    .mzj-hero h1{
      margin: 0;
      font-size: 28px;
      font-weight: 900;
      letter-spacing: .2px;
      color: #2d1f1b;
    }
    .mzj-hero p{
      margin: 6px 0 0;
      color: rgba(45,31,27,.65);
      font-weight: 600;
    }

    /* ===== Card ===== */
    .mzj-card{
      background:#fff;
      border-radius: 22px;
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 8px 30px rgba(0,0,0,.06);
      overflow:hidden;
    }
    .mzj-card-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .mzj-card-title{
      font-weight: 900;
      color:#2d1f1b;
      font-size: 18px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .mzj-chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.04);
      border: 1px solid rgba(0,0,0,.06);
      font-weight: 800;
      color:#2d1f1b;
      font-size: 12px;
      white-space: nowrap;
    }
    .mzj-subtle{font-size:12px;color:rgba(45,31,27,.65);font-weight:700}
    .mzj-card-body{padding: 12px 12px 14px;}

    /* ===== List / Cards ===== */
    .activity-list{display:flex;flex-direction:column;gap:10px;}
    .act-card{
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 18px;
      background: #fff;
      padding: 12px;
    }
    .act-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .act-idx{
      min-width: 38px;
      height: 30px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      background: rgba(0,0,0,.05);
      border: 1px solid rgba(0,0,0,.07);
      color:#2d1f1b;
    }
    .act-date{
      font-weight: 900;
      color:#2d1f1b;
      font-size: 13px;
      text-align:right;
      line-height: 1.35;
    }

    .act-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .act-field{
      border-radius: 14px;
      background: rgba(0,0,0,.03);
      border: 1px solid rgba(0,0,0,.06);
      padding: 8px 10px;
      min-height: 46px;
    }
    .act-label{
      font-size: 11px;
      font-weight: 900;
      color: rgba(45,31,27,.6);
      margin-bottom: 2px;
    }
    .act-value{
      font-size: 13px;
      font-weight: 800;
      color:#2d1f1b;
      line-height: 1.35;
      word-break: break-word;
    }
    .act-details{
      margin-top: 8px;
      border-radius: 16px;
      background: rgba(0,0,0,.02);
      border: 1px dashed rgba(0,0,0,.12);
      padding: 10px 10px;
    }
    .act-details .act-value{font-weight:700}

    .empty{
      text-align:center;
      padding: 22px 10px;
      color: rgba(45,31,27,.6);
      font-weight: 800;
    }

    /* file:// warning */
    .file-warn{max-width:520px;margin:40px auto;padding:18px;border-radius:16px;border:1px solid rgba(239,68,68,.25);background:rgba(239,68,68,.06);font-family:Tajawal;text-align:center}
    .file-warn code{direction:ltr;unicode-bidi:bidi-override;background:rgba(0,0,0,.06);padding:2px 6px;border-radius:8px}
    .file-warn .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;margin-top:12px;padding:10px 14px;border-radius:12px;border:1px solid rgba(0,0,0,.12);background:#fff;cursor:pointer;font-weight:800}

    /* Downbar hardening in case mzj-mobile.css changed */
    .mzj-downbar{position:fixed;left:0;right:0;bottom:0;z-index:9999;}
  </style>
</head>

<body class="auth-pending">

  <div class="mzj-page">
    <div class="mzj-hero">
      <h1>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</h1>
      <p>Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø· Ù…Ù† <b>mzj_activity_log</b></p>
    </div>

    <section class="mzj-card">
      <div class="mzj-card-head">
        <div class="mzj-card-title">
          <span>Ø¢Ø®Ø± Ø§Ù„Ø­Ø±ÙƒØ§Øª</span>
        </div>
        <div class="mzj-chip" id="mzjNow"><span>â€”</span></div>
      </div>

      <div class="mzj-card-body">
        <div class="mzj-subtle" style="margin-bottom:10px">Ø§Ù„ØªØ³Ù„Ø³Ù„ 1, 2, 3 â€¦ Ø­Ø³Ø¨ Ø§Ù„Ø£Ø­Ø¯Ø«</div>
        <div id="activityList" class="activity-list">
          <div class="empty">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div>
        </div>

        <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-top:12px">
          <span class="mzj-chip"><span id="rowsCount">0</span><span style="opacity:.75">Ø³Ø¬Ù„</span></span>
          <span class="mzj-chip" style="opacity:.9"><span>Ø§Ù„Ù…ØµØ¯Ø±:</span><span style="direction:ltr">mzj_activity_log</span></span>
        </div>
      </div>
    </section>
  </div>

  <!-- ===== Downbar (ØµÙÙ‘ÙŠÙ†) ===== -->
  <nav class="mzj-downbar" aria-label="Ø§Ù„ØªÙ†Ù‚Ù„">
    <div class="inner">
      <!-- Row 1 -->
      <a href="m.sales.html">ğŸ’¼<span>ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span></a>
      <a href="m.dashboard.html">ğŸ“Š<span>Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</span></a>
      <a href="m.inventory.html">ğŸ“¦<span>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span></a>
      <a href="m.vt.html">ğŸ§­<span>Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span></a>
      <a href="m.photoshoot-user.html">ğŸ“·<span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span></a>

      <!-- Row 2 -->
      <a href="m.cars.html">ğŸš—<span>ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span></a>
      <a href="m.admin.html">ğŸ <span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span></a>
      <a class="active" href="m.Activity.html">ğŸ•˜<span>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</span></a>
      <a href="m.act.html">ğŸ§¾<span>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</span></a>
    </div>
  </nav>

  <script type="module">
    // ØªÙ†Ø¨ÙŠÙ‡: Auth Ù„Ø§ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…ÙˆØ«ÙˆÙ‚ Ù…Ù† file://
    if (location.protocol === "file:") {
      document.documentElement.classList.remove("auth-pending");
      document.body.innerHTML = `
        <div class="file-warn">
          <div style="font-size:18px;font-weight:900;margin-bottom:6px">Ø§ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± HTTP Ù…Ø´ Downloads</div>
          <div class="mzj-subtle">
            Ø´ØºÙ‘Ù„ Ø³ÙŠØ±ÙØ± Ù…Ø­Ù„ÙŠ Ø«Ù… Ø§ÙØªØ­: <code>http://localhost:5500/m.Activity.html</code>
          </div>
          <div class="mzj-subtle" style="margin-top:10px;line-height:1.9">
            <div><code>python -m http.server 5500</code></div>
            <div style="margin-top:8px">ÙˆÙ„Ø§ ØªÙ†Ø³Ù‰ ØªØ¶ÙŠÙ <b>localhost</b> ÙÙŠ Authorized domains Ø¯Ø§Ø®Ù„ Firebase Auth.</div>
          </div>
          <button class="btn" onclick="navigator.clipboard.writeText('python -m http.server 5500')">Ù†Ø³Ø® Ø£Ù…Ø± Ø§Ù„Ø³ÙŠØ±ÙØ±</button>
        </div>
      `;
      throw new Error("Opened via file://");
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, limit, onSnapshot, doc, getDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
      "apiKey": "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
      "authDomain": "mzj-agenda.firebaseapp.com",
      "projectId": "mzj-agenda",
      "storageBucket": "mzj-agenda.firebasestorage.app",
      "messagingSenderId": "834700407721",
      "appId": "1:834700407721:web:75c17665d4f032fd65cab8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=> document.getElementById(id);
    const safe = (v)=> (v===null || v===undefined) ? "" : String(v);

    // clock chip
    function tick(){
      try{
        const fmt = new Intl.DateTimeFormat('ar-SA', { weekday:'long', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:true, timeZone:'Asia/Riyadh' });
        $("mzjNow").innerHTML = `<span>${fmt.format(new Date())}</span>`;
      }catch(_){
        $("mzjNow").textContent = new Date().toLocaleString('ar-SA');
      }
    }
    tick(); setInterval(tick, 60*1000);

    const roleCache = new Map(); // emailLower -> roleLabel

    function fmtDate(dt){
      try{
        const fmt = new Intl.DateTimeFormat('ar-SA', {
          year:'numeric', month:'2-digit', day:'2-digit',
          hour:'2-digit', minute:'2-digit', hour12:true,
          timeZone:'Asia/Riyadh'
        });
        return fmt.format(dt);
      }catch(_){
        return dt.toLocaleString('ar-SA');
      }
    }

    function tsToDate(v){
      if(!v) return null;
      if (typeof v.toDate === 'function') return v.toDate();
      if (typeof v.seconds === 'number') return new Date(v.seconds*1000);
      if (typeof v === 'string'){
        const d = new Date(v);
        return isNaN(d.getTime()) ? null : d;
      }
      if (typeof v === 'number') return new Date(v);
      return null;
    }

    function getCreatedAtDisplay(d){
      if (d.createdAt && typeof d.createdAt === 'string' && d.createdAt.trim()) return d.createdAt.trim();
      const dt = tsToDate(d.createdAtTs) || tsToDate(d.ts) || tsToDate(d.createdAt);
      if (dt) return fmtDate(dt);
      if (d.date) return String(d.date);
      return "";
    }

    function normalizeRole(r){
      r = (r||"").toString().trim().toLowerCase();
      if (["admin","administrator","Ù…Ø¯ÙŠØ±","Ø§Ù„Ù…Ø¯ÙŠØ±","Ø£Ø¯Ù…Ù†","Ø§Ø¯Ù…Ù†","Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©","Ø§Ù„Ø§Ø¯Ø§Ø±Ø©","Ø¥Ø¯Ø§Ø±Ø©","Ø§Ø¯Ø§Ø±Ù‡","management","manager"].includes(r)) return "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©";
      if (["sales","Ù…Ø¨ÙŠØ¹Ø§Øª","Ù…Ù†Ø¯ÙˆØ¨"].includes(r)) return "Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª";
      return r || "";
    }

    async function resolveRoleByEmail(email){
      const em = (email||"").toLowerCase().trim();
      if(!em) return "";
      if(roleCache.has(em)) return roleCache.get(em) || "";

      try{
        const s1 = await getDoc(doc(db,"user", em));
        if(s1.exists()){
          const r = normalizeRole(s1.data()?.role);
          roleCache.set(em, r||"");
          return r||"";
        }
      }catch(_){}

      try{
        const q1 = query(collection(db,"user"), where("email","==", em));
        const res = await getDocs(q1);
        if(!res.empty){
          const r = normalizeRole(res.docs[0].data()?.role);
          roleCache.set(em, r||"");
          return r||"";
        }
      }catch(_){}

      roleCache.set(em, "");
      return "";
    }

    async function fetchUserRole(user){
      try{
        const snap = await getDoc(doc(db,"user", user.uid));
        if (snap.exists()) return normalizeRole(snap.data()?.role);
      }catch(_){}

      try{
        const q1 = query(collection(db,"user"), where("email","==",(user.email||"").toLowerCase()));
        const res = await getDocs(q1);
        if (!res.empty) return normalizeRole(res.docs[0].data()?.role);
      }catch(_){}

      try{
        const snap2 = await getDoc(doc(db,"members", user.uid));
        if (snap2.exists()) return normalizeRole(snap2.data()?.role);
      }catch(_){}

      try{
        const q2 = query(collection(db,"members"), where("email","==",(user.email||"").toLowerCase()));
        const res2 = await getDocs(q2);
        if (!res2.empty) return normalizeRole(res2.docs[0].data()?.role);
      }catch(_){}

      return "";
    }

    function deny(msg){
      document.documentElement.classList.remove("auth-pending");
      document.body.innerHTML = `<div style="padding:24px;font-family:Tajawal;text-align:center;font-weight:900">${msg||"Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©"}</div>`;
    }

    onAuthStateChanged(auth, async (user)=>{
      try{
        if (!user) return deny("ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„.");
        const role = await fetchUserRole(user);
        const email = (user.email||"").toLowerCase();
        const ok = (role === "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©") || email.includes("admin");
        if (!ok) return deny("Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©");

        document.documentElement.classList.remove("auth-pending");
        startActivityStream();
      }catch(e){
        console.error(e);
        deny("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.");
      }
    });

    function field(label, value){
      return `
        <div class="act-field">
          <div class="act-label">${label}</div>
          <div class="act-value">${value || "â€”"}</div>
        </div>
      `;
    }

    function startActivityStream(){
      const listEl = $("activityList");
      const countEl = $("rowsCount");

      const q = query(collection(db,"mzj_activity_log"), orderBy("ts","desc"), limit(300));
      onSnapshot(q, async (snap)=>{
        listEl.innerHTML = "";
        let i = 0;

        const pendingRoleCells = [];

        snap.forEach((docSnap)=>{
          const d = docSnap.data() || {};
          const dt = safe(getCreatedAtDisplay(d)) || "â€”";
          const memberName = safe(d.userName) || safe(d.userEmail) || "â€”";
          const memberEmail = safe(d.userEmail);
          const role = safe(d.role) || "â€”";
          const action = safe(d.action) || "â€”";
          const details = safe(d.details) || "â€”";

          const roleId = `role_${docSnap.id}`;
          listEl.insertAdjacentHTML("beforeend", `
            <div class="act-card">
              <div class="act-top">
                <div class="act-idx">${++i}</div>
                <div class="act-date">${dt}</div>
              </div>

              <div class="act-grid">
                ${field("Ø§Ù„Ø¹Ø¶Ùˆ", memberEmail ? `${memberName}<div class="mzj-subtle" style="direction:ltr">${memberEmail}</div>` : memberName)}
                ${field("Ø§Ù„Ø¯ÙˆØ±", `<span id="${roleId}">${role}</span>`)}
                ${field("Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©", action)}
                ${field("Ø§Ù„Ù…Ø¹Ø±Ù", docSnap.id)}
              </div>

              <div class="act-details">
                <div class="act-label">Ø§Ù„ØªÙØ§ØµÙŠÙ„</div>
                <div class="act-value">${details}</div>
              </div>
            </div>
          `);

          pendingRoleCells.push({ roleId, email: memberEmail, current: role });
        });

        if (!i) listEl.innerHTML = `<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯.</div>`;
        countEl.textContent = String(i);

        // fill missing roles lazily
        for (const it of pendingRoleCells){
          try{
            const el = document.getElementById(it.roleId);
            if(!el) continue;
            const current = (el.textContent||"").trim();
            if(current && current !== "â€”") continue;
            const r = await resolveRoleByEmail(it.email);
            if(r) el.textContent = r;
          }catch(_){}
        }
      }, (err)=>{
        console.error(err);
        listEl.innerHTML = `<div class="empty">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·.</div>`;
      });
    }
  </script>
</body>
</html>
