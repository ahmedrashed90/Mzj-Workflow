
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</title>
  <link rel="stylesheet" href="mzj-mobile.css">
  <style>
    body{margin:0;background:#fff8ef;font-family:Tajawal,sans-serif;padding-bottom:110px}
    .mzj-content{padding:12px}
    .table-wrap{overflow:auto}
  </style>
</head>
<body>

<main class="mzj-content">


    <!-- Auth Gate -->
    <div class="auth-wrap" id="authGate" style="display:none">
      <div class="auth-card">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input id="email" placeholder="you@example.com" type="email"/>
        <label for="password" style="margin-top:8px">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" type="password"/>
        <div class="auth-actions">
          <button class="btn btn-primary" id="btnLogin">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
          <button class="btn btn-ghost" id="btnSignup">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        </div>
        <p class="hint" id="authHint" style="margin-top:10px"></p>
      </div>
    </div>

    <!-- App -->
    <div id="app" style="display:none">
      <div class="container">
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="title"><i class="fa-solid fa-clipboard-list"></i> Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h2>
              <div class="hint">Ù†ÙØ³ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¨ÙˆÙŠØ¨ "Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª" Ø¯Ø§Ø®Ù„ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.</div>
            </div>
            <div class="row" style="justify-content:flex-start">
              <div class="status-badge"><span class="dot warn" id="connDot"></span><span id="connText">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦</span></div>
            </div>
          </div>

          <div class="row" style="margin-bottom:10px">
            <div class="row" style="gap:8px">
              <label style="margin:0 6px 0 0">ØªØ§Ø±ÙŠØ® Ù…Ù†</label>
              <input id="movesFromDate" type="date" style="width:auto;min-width:170px"/>
            </div>
            <div class="row" style="gap:8px">
              <label style="margin:0 6px 0 0">Ø¥Ù„Ù‰</label>
              <input id="movesToDate" type="date" style="width:auto;min-width:170px"/>
            </div>
            <button class="btn btn-ghost" id="btnClearDate"><i class="fa-solid fa-eraser"></i> Ù…Ø³Ø­ Ø§Ù„ØªØ§Ø±ÙŠØ®</button>

            <div style="flex:1"></div>

            <div class="row" style="gap:8px">
              <input id="quickSearch" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ (VIN / Ø³ÙŠØ§Ø±Ø© / Ù…Ù† / Ø¥Ù„Ù‰)" style="min-width:320px"/>
              <button class="btn btn-ghost" id="btnClearSearch"><i class="fa-solid fa-minus"></i> Ù…Ø³Ø­</button>
            </div>
          </div>

          <div class="table-wrap">
            <table id="movesTable">
              <thead>
                <tr>
                  <th class="w-120">#</th>
                  <th class="w-120">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</th>
                  <th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                  <th>Ù…Ù†</th>
                  <th>Ø¥Ù„Ù‰</th>
                  <th class="w-120">ID</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="hint" id="rowsHint" style="margin-top:10px">â€”</div>
        </div>
      </div>
    </div>

  
</main>

<nav class="mzj-downbar">
  <div class="inner">
    <a href="m.sales.html">ğŸ’¼<span>ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span></a>
    <a href="m.dashboard.html">ğŸ“Š<span>Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</span></a>
    <a href="m.inventory.html">ğŸš—<span>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span></a>
    <a href="m.vt.html">ğŸ§­<span>Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span></a>
    <a href="m.photoshoot-user.html">ğŸ“·<span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span></a>

    <a href="m.cars.html">ğŸš™<span>ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span></a>
    <a href="m.admin.html">ğŸ <span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span></a>
    <a href="m.Activity.html">ğŸ•˜<span>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</span></a>
    <a class="active" href="m.act.html">ğŸ§¾<span>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</span></a>
  </div>
</nav>

<script src="./mzj-ui.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  /* ===== Firebase ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const STATE_REF = doc(db, "mzj_admin_state", "v1");

  /* ===== Roles ===== */
  const ROLE_ADMIN   = 'Ø§Ù„Ø§Ø¯Ø§Ø±Ø©';
  const ROLE_IDARI   = 'Ø§Ø¯Ø§Ø±ÙŠ';
  const ROLE_BRANCH  = 'Ù…Ø¯Ø±Ø§Ø¡ ÙØ±ÙˆØ¹';
  const PAGE_ALLOWED_ROLES = [ROLE_ADMIN, ROLE_IDARI, ROLE_BRANCH];

  async function fetchUserRole(user){
    try{
      const userDocRef = doc(db, 'user', user.uid);
      const snap = await getDoc(userDocRef);
      if(snap.exists()){
        const data = snap.data() || {};
        return data.role || null;
      }
      return null;
    }catch(err){
      console.error('Error fetching user role:', err);
      return null;
    }
  }

  /* ===== Helpers ===== */
  const $ = s => document.querySelector(s);
  const toast = $('#toast');
  function showToast(msg,type='ok'){toast.textContent=msg;toast.className='toast '+type;toast.style.display='block';setTimeout(()=>toast.style.display='none',1800)}
  function pad(n){return n<10?'0'+n:n}
  function onlyDate(str){return (str||'').toString().slice(0,10)}
  function normalizeVin(v){
    if(!v) return '';
    const ar={'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
    return v.toString().replace(/[Ù -Ù©]/g,d=>ar[d]).toUpperCase().replace(/[\s\-\._]/g,'').trim();
  }
  function liftNoFlash(){
    const nf = document.getElementById('noFlash');
    if(nf) nf.remove();
  }

  /* ===== DOM ===== */
  const authGate=$('#authGate'), appRoot=$('#app');
  const btnSignOut=$('#btnSignOut');
  const emailEl=$('#email'), passEl=$('#password'), btnLogin=$('#btnLogin'), btnSignup=$('#btnSignup'), authHint=$('#authHint');
  const connDot=$('#connDot'), connText=$('#connText');

  const movesFromDate=$('#movesFromDate'), movesToDate=$('#movesToDate'), btnClearDate=$('#btnClearDate');
  const quickSearch=$('#quickSearch'), btnClearSearch=$('#btnClearSearch');
  const movesTableBody = document.querySelector('#movesTable tbody');
  const rowsHint = $('#rowsHint');

  let moves = [];
  let unsub = null;

  function setStatus(mode, txt){
    connDot.className='dot '+(mode==='ok'?'ok':mode==='err'?'err':'warn');
    connText.textContent = txt;
  }

  /* ===== Filtering + render ===== */
  function filterMovesByDate(list){
    const f = movesFromDate.value || null;
    const t = movesToDate.value || null;
    if(!f && !t) return list;
    return list.filter(m=>{
      const d = m.date || onlyDate(m.when||'');
      if(f && d < f) return false;
      if(t && d > t) return false;
      return true;
    });
  }

  function filterBySearch(list){
    const q = (quickSearch.value||'').trim().toLowerCase();
    if(!q) return list;
    return list.filter(m=>{
      const hay = [
        m.vin||'', m.car||'', m.from||'', m.to||'', m.id||'',
        (m.date||onlyDate(m.when||''))||''
      ].join(' ').toLowerCase();
      return hay.includes(q);
    });
  }

  function renderMoves(){
    movesTableBody.innerHTML='';
    let rows = moves.slice();

    rows = filterMovesByDate(rows);
    rows = filterBySearch(rows);

    // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€” Ù†ÙØ³ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙƒØ§Ù† Ø­Ø³Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ù„ÙƒÙ† Ø¯Ù‡ Ø£Ù†Ø³Ø¨ Ù„Ø³Ø¬Ù„
    rows.sort((a,b)=> (b.when||'').localeCompare(a.when||''));

    rows.forEach((m,i)=>{
      const vin = m.vin || '';
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i+1}</td>
        <td class="nowrap">${m.date || onlyDate(m.when||'')}</td>
        <td class="nowrap"><span class="copyable" data-copy="${vin}" title="Ø§Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„">${vin}</span></td>
        <td>${m.car||''}</td>
        <td>${m.from||''}</td>
        <td>${m.to||''}</td>
        <td class="nowrap">${m.id||''}</td>`;
      movesTableBody.appendChild(tr);
    });

    rowsHint.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: ${rows.length}`;
  }

  movesFromDate.addEventListener('change', renderMoves);
  movesToDate.addEventListener('change', renderMoves);
  btnClearDate.addEventListener('click', ()=>{movesFromDate.value=''; movesToDate.value=''; renderMoves();});
  quickSearch.addEventListener('input', ()=> renderMoves());
  btnClearSearch.addEventListener('click', ()=>{ quickSearch.value=''; renderMoves(); });

  document.addEventListener('click',(e)=>{
    const pill = e.target.closest('.copyable');
    if(pill){
      const txt=(pill.getAttribute('data-copy')||'').trim();
      if(txt){ navigator.clipboard.writeText(txt).then(()=>showToast('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…','ok')); }
    }
  });

  /* ===== Auth ===== */
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      try{
        const role = await fetchUserRole(user);
        window.__mzjUserRole = role || null;

        if(!role || !PAGE_ALLOWED_ROLES.includes(role)){
          window.location.href = 'unauthorized.html';
          return;
        }

        authGate.style.display = 'none';
        appRoot.style.display  = 'block';
        btnSignOut.style.display = 'inline-flex';
        setStatus('ok', `Ù…ØªØµÙ„: ${user.email} â€” Ø§Ù„Ø¯ÙˆØ±: ${role}`);

        liftNoFlash();
        subscribeLive();
      }catch(err){
        console.error(err);
        setStatus('err','Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        liftNoFlash();
      }
    }else{
      // not logged in
      if(unsub){ try{unsub();}catch(e){} unsub=null; }
      appRoot.style.display = 'none';
      authGate.style.display = 'grid';
      authGate.style.display = 'grid';
      btnSignOut.style.display = 'none';
      setStatus('warn','Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
      liftNoFlash();
    }
  });

  btnLogin?.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{ await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
    catch(e){ authHint.textContent='ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: '+(e?.message||e); }
  });
  btnSignup?.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{ await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
    catch(e){ authHint.textContent='ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: '+(e?.message||e); }
  });
  btnSignOut?.addEventListener('click', ()=> signOut(auth));

  function subscribeLive(){
    try{
      if(unsub){ try{unsub();}catch(e){} unsub=null; }
      unsub = onSnapshot(STATE_REF,(snap)=>{
        if(!snap.exists()) return;
        const d = snap.data() || {};
        moves = Array.isArray(d.moves) ? d.moves : [];
        renderMoves();
        setStatus('ok','Ù…Ø²Ø§Ù…Ù†Ø© Ø­ÙŠÙ‘Ø©');
      }, ()=>{
        setStatus('warn','Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§');
      });
    }catch(e){
      console.error(e);
      setStatus('err','ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
    }
  }
</script>


<!-- MZJ MENU POPUP -->
<style>
.mzj-menu-btn{
 position:fixed;top:12px;right:12px;z-index:9999;
 background:#3e2420;color:#fff;border:0;
 padding:10px 14px;border-radius:14px;
 font-family:Tajawal,Arial;font-weight:700
}
.mzj-menu-overlay{
 display:none;position:fixed;inset:0;
 background:rgba(0,0,0,.25);z-index:9998
}
.mzj-menu-popup{
 display:none;position:fixed;top:60px;right:12px;
 background:#fff8ef;border-radius:16px;
 padding:12px;width:280px;z-index:9999;
 box-shadow:0 16px 30px rgba(0,0,0,.18)
}
.mzj-menu-popup a{
 display:block;padding:10px;border-radius:12px;
 color:#3e2420;text-decoration:none;font-weight:700
}
.mzj-menu-popup a:hover{background:#f2e6da}
</style>

<button id="mzjMenuBtn" class="mzj-menu-btn">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â˜°</button>
<div id="mzjMenuOverlay" class="mzj-menu-overlay"></div>
<div id="mzjMenuPopup" class="mzj-menu-popup">
 <a href="m.dashboard.html">ğŸ“Š Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</a>
 <a href="m.admin.html">ğŸ  Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
 <a href="m.sales.html">ğŸ’¼ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</a>
 <a href="m.vt.html">â†”ï¸ Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</a>
 <a href="m.photoshoot-user.html">ğŸ“· Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙˆÙŠØ±</a>
 <a href="m.cars.html">ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</a>
 <a href="m.Activity.html">ğŸ•˜ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</a>
 <a href="m.act.html">ğŸ§¾ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</a>
</div>

<script>
(function(){
 const b=document.getElementById('mzjMenuBtn'),
 o=document.getElementById('mzjMenuOverlay'),
 p=document.getElementById('mzjMenuPopup');
 if(!b) return;
 b.onclick=()=>{o.style.display='block';p.style.display='block';};
 o.onclick=()=>{o.style.display='none';p.style.display='none';};
})();
</script>

</body>
</html>
