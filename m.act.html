
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>سجل الحركات</title>
  <link rel="stylesheet" href="mzj-mobile.css">
  <style>
    body{margin:0;background:#fff8ef;font-family:Tajawal,sans-serif;padding-bottom:110px}
    .mzj-content{padding:12px}
    .table-wrap{overflow:auto}
  </style>
</head>
<body>

<main class="mzj-content">


    <!-- Auth Gate -->
    <div class="auth-wrap" id="authGate" style="display:none">
      <div class="auth-card">
        <h2>تسجيل الدخول</h2>
        <label for="email">البريد الإلكتروني</label>
        <input id="email" placeholder="you@example.com" type="email"/>
        <label for="password" style="margin-top:8px">كلمة المرور</label>
        <input id="password" placeholder="••••••••" type="password"/>
        <div class="auth-actions">
          <button class="btn btn-primary" id="btnLogin">تسجيل الدخول</button>
          <button class="btn btn-ghost" id="btnSignup">إنشاء حساب</button>
        </div>
        <p class="hint" id="authHint" style="margin-top:10px"></p>
      </div>
    </div>

    <!-- App -->
    <div id="app" style="display:none">
      <div class="container">
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="title"><i class="fa-solid fa-clipboard-list"></i> سجل الحركات</h2>
              <div class="hint">نفس بيانات تبويب "سجل الحركات" داخل صفحة الإدارة.</div>
            </div>
            <div class="row" style="justify-content:flex-start">
              <div class="status-badge"><span class="dot warn" id="connDot"></span><span id="connText">جارِ الاتصال…</span></div>
            </div>
          </div>

          <div class="row" style="margin-bottom:10px">
            <div class="row" style="gap:8px">
              <label style="margin:0 6px 0 0">تاريخ من</label>
              <input id="movesFromDate" type="date" style="width:auto;min-width:170px"/>
            </div>
            <div class="row" style="gap:8px">
              <label style="margin:0 6px 0 0">إلى</label>
              <input id="movesToDate" type="date" style="width:auto;min-width:170px"/>
            </div>
            <button class="btn btn-ghost" id="btnClearDate"><i class="fa-solid fa-eraser"></i> مسح التاريخ</button>

            <div style="flex:1"></div>

            <div class="row" style="gap:8px">
              <input id="quickSearch" placeholder="بحث سريع (VIN / سيارة / من / إلى)" style="min-width:320px"/>
              <button class="btn btn-ghost" id="btnClearSearch"><i class="fa-solid fa-minus"></i> مسح</button>
            </div>
          </div>

          <div class="table-wrap">
            <table id="movesTable">
              <thead>
                <tr>
                  <th class="w-120">#</th>
                  <th class="w-120">التاريخ</th>
                  <th>رقم الهيكل</th>
                  <th>السيارة</th>
                  <th>من</th>
                  <th>إلى</th>
                  <th class="w-120">ID</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="hint" id="rowsHint" style="margin-top:10px">—</div>
        </div>
      </div>
    </div>

  
</main>

<!-- REMOVED BAR -->

<script src="./mzj-ui.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  /* ===== Firebase ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const STATE_REF = doc(db, "mzj_admin_state", "v1");

  /* ===== Roles ===== */
  const ROLE_ADMIN   = 'الادارة';
  const ROLE_IDARI   = 'اداري';
  const ROLE_BRANCH  = 'مدراء فروع';
  const PAGE_ALLOWED_ROLES = [ROLE_ADMIN, ROLE_IDARI, ROLE_BRANCH];

  async function fetchUserRole(user){
    try{
      const userDocRef = doc(db, 'user', user.uid);
      const snap = await getDoc(userDocRef);
      if(snap.exists()){
        const data = snap.data() || {};
        return data.role || null;
      }
      return null;
    }catch(err){
      console.error('Error fetching user role:', err);
      return null;
    }
  }

  /* ===== Helpers ===== */
  const $ = s => document.querySelector(s);
  const toast = $('#toast');
  function showToast(msg,type='ok'){toast.textContent=msg;toast.className='toast '+type;toast.style.display='block';setTimeout(()=>toast.style.display='none',1800)}
  function pad(n){return n<10?'0'+n:n}
  function onlyDate(str){return (str||'').toString().slice(0,10)}
  function normalizeVin(v){
    if(!v) return '';
    const ar={'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
    return v.toString().replace(/[٠-٩]/g,d=>ar[d]).toUpperCase().replace(/[\s\-\._]/g,'').trim();
  }
  function liftNoFlash(){
    const nf = document.getElementById('noFlash');
    if(nf) nf.remove();
  }

  /* ===== DOM ===== */
  const authGate=$('#authGate'), appRoot=$('#app');
  const btnSignOut=$('#btnSignOut');
  const emailEl=$('#email'), passEl=$('#password'), btnLogin=$('#btnLogin'), btnSignup=$('#btnSignup'), authHint=$('#authHint');
  const connDot=$('#connDot'), connText=$('#connText');

  const movesFromDate=$('#movesFromDate'), movesToDate=$('#movesToDate'), btnClearDate=$('#btnClearDate');
  const quickSearch=$('#quickSearch'), btnClearSearch=$('#btnClearSearch');
  const movesTableBody = document.querySelector('#movesTable tbody');
  const rowsHint = $('#rowsHint');

  let moves = [];
  let unsub = null;

  function setStatus(mode, txt){
    connDot.className='dot '+(mode==='ok'?'ok':mode==='err'?'err':'warn');
    connText.textContent = txt;
  }

  /* ===== Filtering + render ===== */
  function filterMovesByDate(list){
    const f = movesFromDate.value || null;
    const t = movesToDate.value || null;
    if(!f && !t) return list;
    return list.filter(m=>{
      const d = m.date || onlyDate(m.when||'');
      if(f && d < f) return false;
      if(t && d > t) return false;
      return true;
    });
  }

  function filterBySearch(list){
    const q = (quickSearch.value||'').trim().toLowerCase();
    if(!q) return list;
    return list.filter(m=>{
      const hay = [
        m.vin||'', m.car||'', m.from||'', m.to||'', m.id||'',
        (m.date||onlyDate(m.when||''))||''
      ].join(' ').toLowerCase();
      return hay.includes(q);
    });
  }

  function renderMoves(){
    movesTableBody.innerHTML='';
    let rows = moves.slice();

    rows = filterMovesByDate(rows);
    rows = filterBySearch(rows);

    // الأحدث أولاً (اختياري) — نفس تبويب الإدارة كان حسب الترتيب الحالي، لكن ده أنسب لسجل
    rows.sort((a,b)=> (b.when||'').localeCompare(a.when||''));

    rows.forEach((m,i)=>{
      const vin = m.vin || '';
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i+1}</td>
        <td class="nowrap">${m.date || onlyDate(m.when||'')}</td>
        <td class="nowrap"><span class="copyable" data-copy="${vin}" title="انسخ رقم الهيكل">${vin}</span></td>
        <td>${m.car||''}</td>
        <td>${m.from||''}</td>
        <td>${m.to||''}</td>
        <td class="nowrap">${m.id||''}</td>`;
      movesTableBody.appendChild(tr);
    });

    rowsHint.textContent = `عدد السجلات المعروضة: ${rows.length}`;
  }

  movesFromDate.addEventListener('change', renderMoves);
  movesToDate.addEventListener('change', renderMoves);
  btnClearDate.addEventListener('click', ()=>{movesFromDate.value=''; movesToDate.value=''; renderMoves();});
  quickSearch.addEventListener('input', ()=> renderMoves());
  btnClearSearch.addEventListener('click', ()=>{ quickSearch.value=''; renderMoves(); });

  document.addEventListener('click',(e)=>{
    const pill = e.target.closest('.copyable');
    if(pill){
      const txt=(pill.getAttribute('data-copy')||'').trim();
      if(txt){ navigator.clipboard.writeText(txt).then(()=>showToast('تم النسخ ✅','ok')); }
    }
  });

  /* ===== Auth ===== */
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      try{
        const role = await fetchUserRole(user);
        window.__mzjUserRole = role || null;

        if(!role || !PAGE_ALLOWED_ROLES.includes(role)){
          window.location.href = 'unauthorized.html';
          return;
        }

        authGate.style.display = 'none';
        appRoot.style.display  = 'block';
        btnSignOut.style.display = 'inline-flex';
        setStatus('ok', `متصل: ${user.email} — الدور: ${role}`);

        liftNoFlash();
        subscribeLive();
      }catch(err){
        console.error(err);
        setStatus('err','خطأ في تحميل البيانات');
        liftNoFlash();
      }
    }else{
      // not logged in
      if(unsub){ try{unsub();}catch(e){} unsub=null; }
      appRoot.style.display = 'none';
      authGate.style.display = 'grid';
      authGate.style.display = 'grid';
      btnSignOut.style.display = 'none';
      setStatus('warn','لم يتم تسجيل الدخول');
      liftNoFlash();
    }
  });

  btnLogin?.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{ await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
    catch(e){ authHint.textContent='فشل تسجيل الدخول: '+(e?.message||e); }
  });
  btnSignup?.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{ await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
    catch(e){ authHint.textContent='تعذّر إنشاء الحساب: '+(e?.message||e); }
  });
  btnSignOut?.addEventListener('click', ()=> signOut(auth));

  function subscribeLive(){
    try{
      if(unsub){ try{unsub();}catch(e){} unsub=null; }
      unsub = onSnapshot(STATE_REF,(snap)=>{
        if(!snap.exists()) return;
        const d = snap.data() || {};
        moves = Array.isArray(d.moves) ? d.moves : [];
        renderMoves();
        setStatus('ok','مزامنة حيّة');
      }, ()=>{
        setStatus('warn','انقطاع المزامنة مؤقتًا');
      });
    }catch(e){
      console.error(e);
      setStatus('err','تعذّر الاشتراك في المزامنة');
    }
  }
</script>

</body>
</html>
