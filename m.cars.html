<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <link rel="icon" type="image/x-icon" href="assets/favicon.png">
<link rel="prefetch" href="admin.html">
<link rel="prefetch" href="inventory.html">
<link rel="prefetch" href="dashboard.html">
<link rel="prefetch" href="photoshoot.html">

<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style id="noFlash">
#authGate{display:none!important}
html{background:#faf7f3}body{opacity:0;transition:opacity .12s ease}
</style>
<meta name="color-scheme" content="light">
<title>MZJØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

<style>
  :root{
    --brown:#3e2420; --beige:#bc8f74; --bg:#faf7f3; --card:#fff; --line:#e7e5e4;
    --text:#1f2937; --muted:#6b7280; --ok:#16a34a; --danger:#ef4444; --info:#0ea5e9; --warn:#f59e0b;
    --radius:12px; --shadow:0 10px 24px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:"Tajawal",system-ui,Arial;
  }

  /* Topbar */
  .topbar{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid var(--line)}
  .topbar-inner{
    max-width:1240px;
    margin:auto;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 14px;
  }
  .brand{display:flex;align-items:center;gap:10px}
  .logo{
    width:34px;height:34px;border-radius:10px;
    background:linear-gradient(135deg,var(--brown),#271713);
    display:grid;place-items:center;color:#fff;
    font-weight:900;
  }
  .brand h1{margin:0;font-size:17px;color:var(--brown)}
  .brand small{color:var(--muted);font-size:12px;display:block}
  .tabs{display:flex;gap:6px;flex-wrap:wrap}
  .tab{
    font-size:12px;
    padding:6px 10px;
    border:1px solid var(--line);
    border-radius:999px;
    background:#fff;
    color:inherit;
    text-decoration:none;
    font-weight:800;
  }
  .tab.active{background:var(--brown);border-color:var(--brown);color:#fff}
  .status-badge{
    display:inline-flex;gap:8px;align-items:center;
    border:1px solid var(--line);border-radius:10px;
    padding:5px 8px;font-size:12px;background:#fff;
  }
  .dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
  .dot.ok{background:var(--ok)} .dot.err{background:var(--danger)}

  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  /* Layout & cards */
  .container{
    max-width:1240px;
    margin:14px auto;
    padding:0 12px;
    display:grid;
    gap:12px;
  }
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:12px;
  }
  .card header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:8px;
  }
  .title{
    margin:0;
    font-size:15px;
    color:var(--brown);
    display:flex;
    align-items:center;
    gap:8px;
  }
  .hint{color:var(--muted);font-size:12px}

  /* Buttons */
  .btn{
    border:1px solid var(--line);
    background:#fff;
    border-radius:9px;
    padding:7px 10px;
    cursor:pointer;
    font-weight:800;
    font-size:13px;
    display:inline-flex;
    gap:6px;
    align-items:center;
    transition:.12s;
  }
  .btn:hover{transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  .btn-primary{background:var(--brown);border-color:var(--brown);color:#fff}
  .btn-success{background:var(--ok);border-color:var(--ok);color:#fff}
  .btn-info{background:var(--info);border-color:var(--info);color:#fff}

  input,select,textarea{
    width:100%;
    padding:8px 9px;
    border:1px solid var(--line);
    border-radius:8px;
    background:#fff;
    font-size:14px;
    font-family:inherit;
  }

  /* Summary badges */
  .summary-row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
    justify-content:space-between;
    margin-bottom:6px;
  }
  .summary-left{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .badge-total{
    display:inline-flex;align-items:center;gap:8px;
    border-radius:999px;
    padding:5px 10px;
    background:#fff8ef;
    border:1px solid #f1d0bd;
    font-size:13px;
    color:var(--brown);
  }
  .badge-total span.num{
    background:var(--brown);color:#fff;
    border-radius:999px;padding:2px 9px;
    min-width:28px;text-align:center;
    font-size:12px;
  }

  /* Filters grid */
  .filter-grid{
    display:grid;
    grid-template-columns:1.4fr 1.4fr 1fr auto;
    gap:8px;
    align-items:flex-end;
  }
  @media(max-width:900px){.filter-grid{grid-template-columns:1fr 1fr}}
  @media(max-width:620px){.filter-grid{grid-template-columns:1fr}}
  .form-group{display:flex;flex-direction:column;gap:4px;font-size:13px}
  .label{font-weight:700;color:var(--brown);display:flex;gap:6px;align-items:center}
  .label span.icon{
    width:18px;height:18px;border-radius:999px;
    background:rgba(188,143,116,.18);
    display:flex;align-items:center;justify-content:center;
    font-size:11px;
  }

  /* Table */
  .table-wrap{
    border:1px solid var(--line);
    border-radius:10px;
    overflow:auto;
    background:#fff;
  }
  table{
    border-collapse:separate;
    border-spacing:0;
    width:100%;
    min-width:520px;
  }
  th,td{
    border-bottom:1px solid var(--line);
    padding:8px 10px;
    font-size:13px;
    text-align:right;
    white-space:nowrap;
  }
  thead th{
    background:#f9fafb;
    font-weight:700;
    color:var(--brown);
    position:sticky;
    top:0;
    z-index:1;
  }
  tbody tr:nth-child(odd){background:#fff}
  tbody tr:nth-child(even){background:#fffdfb}
  tbody tr:last-child td{border-bottom:none}
  .empty-row{text-align:center;color:var(--muted);padding:14px 8px;font-size:13px}
  .chip{
    display:inline-block;
    background:#f9fafb;
    border-radius:999px;
    border:1px solid #e5e7eb;
    padding:2px 8px;
    font-size:12px;
  }

  /* Toast (Ù„Ùˆ Ø­Ø¨ÙŠØª ØªØ³ØªØ®Ø¯Ù…Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†) */
  .toast{
    position:fixed;
    bottom:16px;
    right:16px;
    background:#111827;
    color:#fff;
    padding:8px 12px;
    border-radius:10px;
    display:none;
    font-size:13px;
    z-index:60;
  }
</style>
  <link rel="stylesheet" href="./mzj-ui.css" />

<style>
  .legacy-cars .topbar,
  .legacy-cars .header,
  .legacy-cars header:not(.mzj-topbar){display:none !important;}
</style>

  <link rel="stylesheet" href="mzj-mobile.css">
</head>
<body class="mzj">
<header class="mzj-topbar">
  <div class="topbar-left">
    <button class="icon-btn" id="mzjSidebarBtn" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"><i class="fa-solid fa-bars"></i></button>
    <div class="brand">
      <div class="brand-mark">MZJ</div>
      <div class="brand-text">
        <div class="brand-title">Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</div>
        <div class="brand-sub">Workspace</div>
      </div>
    </div>
  </div>
  <div class="topbar-center">
    <div class="mzj-breadcrumb">
      <span class="crumb">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
      <i class="fa-solid fa-chevron-left"></i>
      <span class="crumb current">ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span>
    </div>
  </div>
  <div class="topbar-right">
    <div class="mzj-chip"><i class="fa-regular fa-clock"></i><span id="mzjNow">â€”</span></div>
    <button id="btnSignOut" class="btn btn-ghost" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</header>

<div class="mzj-shell" id="mzjShell">
  <aside class="mzj-sidebar" id="mzjSidebar">
    <div class="side-section">
      <div class="side-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
      <nav class="side-nav">
        <a class="side-link tab" href="./sales.html"><i class="fa-solid fa-handshake"></i><span>ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span></a>
        <a class="side-link tab" href="./dashboard.html"><i class="fa-solid fa-gauge"></i><span>Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</span></a>
        <a class="side-link tab" href="./inventory.html"><i class="fa-solid fa-boxes-stacked"></i><span>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span></a>
        <a class="side-link tab" href="./vt.html"><i class="fa-solid fa-right-left"></i><span>Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span></a>
        <a class="side-link tab" href="./photoshoot-user.html"><i class="fa-solid fa-camera"></i><span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span></a>
        <a class="side-link tab active" href="./cars.html"><i class="fa-solid fa-car"></i><span>ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span></a>
        <a class="side-link tab" href="./admin.html"><i class="fa-solid fa-shield-halved"></i><span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span></a>
        <a class="side-link tab" href="./Activity.html"><i class="fa-solid fa-clipboard-list"></i><span>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</span></a>
        <a class="side-link tab" href="./act.html"><i class="fa-solid fa-clipboard-list"></i><span>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</span></a>

      </nav>
    </div>
  </aside>

  <div class="mzj-backdrop" id="mzjBackdrop"></div>

  <main class="mzj-content">
    <section class="mzj-pagehead">
      <div class="pagehead-left">
        <h1 class="page-title">ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h1>
        <p class="page-desc">Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª.</p>
      </div>
    </section>

    <div class="legacy legacy-cars">


<!-- Topbar -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo">MZJ</div>
      <div>
        <h1>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h1>
        <small>Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</small>
      </div>
    </div>
    <div class="tabs">
      <a class="tab" href="admin.html">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
      <a class="tab" href="inventory.html">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</a>
      <a class="tab" href="dashboard.html">Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</a>
      <a class="tab" href="vt.html">Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</a>
      <a class="tab" href="photoshoot-user.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
      <a class="tab active" href="cars.html">ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</a>
      <a class="tab" href="Activity.html">Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</a>
    </div>
    <div class="row">
      <div class="status-badge">
        <span id="connDot" class="dot"></span>
        <span id="connText">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦</span>
      </div>
      <button id="btnSignOut" class="btn" style="display:none">
        <i class="fa-solid fa-right-from-bracket"></i> Ø®Ø±ÙˆØ¬
      </button>
    </div>
  </div>
</div>

<!-- Auth Gate -->
<div id="authGate" style="min-height:60vh;display:grid;place-items:center;padding:20px;display:none">
  <div class="card" style="max-width:420px;width:96%">
    <h2 class="title" style="margin-bottom:8px">
      <i class="fa-solid fa-user-lock"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    </h2>
    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
    <input id="email" type="email" placeholder="you@example.com"/>
    <label style="margin-top:8px">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
    <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
    <div class="row" style="margin-top:8px">
      <button class="btn btn-primary" id="btnLogin">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button class="btn" id="btnSignup">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    </div>
    <p class="hint" id="authHint" style="margin-top:8px"></p>
  </div>
</div>

<!-- App -->
<div id="app" style="display:none">
  <div class="container">

    <!-- ÙÙ„Ø§ØªØ± -->
    <div class="card">
      <header>
        <h3 class="title">
          <i class="fa-solid fa-filter"></i> ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ø³ÙŠØ§Ø±Ø© / Ø§Ù„Ø¨ÙŠØ§Ù† / Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„
        </h3>
      </header>
      <div class="filter-grid" style="margin-top:6px">
        <div class="form-group">
          <label class="label">
            <span class="icon"><i class="fa-solid fa-car-side"></i></span> Ø§Ù„Ø³ÙŠØ§Ø±Ø©
          </label>
          <select id="carFilter">
            <option value="">ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</option>
          </select>
        </div>
        <div class="form-group">
          <label class="label">
            <span class="icon"><i class="fa-solid fa-file-lines"></i></span> Ø§Ù„Ø¨ÙŠØ§Ù†
          </label>
          <select id="variantFilter">
            <option value="">ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>
          </select>
        </div>
        <div class="form-group">
          <label class="label">
            <span class="icon"><i class="fa-solid fa-calendar"></i></span> Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„
          </label>
          <select id="modelFilter">
            <option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª</option>
          </select>
        </div>
        <div class="form-group">
          <button class="btn btn-primary" id="btnApply" style="width:100%;justify-content:center">
            <i class="fa-solid fa-magnifying-glass"></i> ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
          </button>
        </div>
      </div>
      <p class="hint" style="margin-top:6px">
        Ø§Ø®ØªØ± Ø³ÙŠØ§Ø±Ø© + Ø¨ÙŠØ§Ù† + Ù…ÙˆØ¯ÙŠÙ„ (Ø£Ùˆ Ø£ÙŠ Ø¬Ø²Ø¡ Ù…Ù†Ù‡Ù…)ØŒ ÙˆØ³ÙŠØªÙ… ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ÙÙŠ Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø­Ø¯ Ù…Ø¹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø¯Ø¯.
      </p>
    </div>

    <!-- Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹ -->
    <div class="card">
      <header>
        <h3 class="title">
          <i class="fa-solid fa-table-list"></i> Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„ÙÙ„ØªØ±
        </h3>
        <button class="btn btn-info" id="btnExport">
          <i class="fa-regular fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel (Ø­Ø³Ø¨ Ø§Ù„ÙÙ„ØªØ±)
        </button>
      </header>

      <div class="summary-row">
        <div class="summary-left">
          <div class="badge-total">
            <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø¯Ø¯ ÙÙŠ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø«</span>
            <span class="num" id="grandTotal">0</span>
          </div>
          <div class="badge-total">
            <span>Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¬Ù…ÙŠØ¹</span>
            <span class="num" id="groupsCount">0</span>
          </div>
        </div>
      </div>

      <div class="table-wrap">
<div id="mzjMobileCards" class="mzj-mobile-cards" aria-label="Ù†ØªØ§Ø¦Ø¬ ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª"></div>
<table>
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
              <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
              <th>Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th>
              <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø¯Ø¯</th>
            </tr>
          </thead>
          <tbody id="resultsBody">
            <tr>
              <td colspan="5" class="empty-row">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Firebaseâ€¦</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<div id="toast" class="toast">ØªÙ…</div>

<!-- XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  /* ===== Firebase ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const STATE_REF = doc(db, "mzj_admin_state", "v1");

  // ===== Roles & Permissions =====
  const ROLE_ADMIN   = 'Ø§Ù„Ø§Ø¯Ø§Ø±Ø©';
  const ROLE_IDARI   = 'Ø§Ø¯Ø§Ø±ÙŠ';
  const ROLE_BRANCH  = 'Ù…Ø¯Ø±Ø§Ø¡ ÙØ±ÙˆØ¹';

  // Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ Ù„ÙƒÙ„ ØªØµÙ†ÙŠÙ
  const ROLE_PAGES = {
    [ROLE_ADMIN] : 'ALL', // Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ØªØ´ÙˆÙ ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª
    // Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ: ÙŠØ´ÙˆÙ ÙÙ‚Ø· Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ + Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª + Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª + ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
    [ROLE_IDARI] : [
  'dashboard.html',
  'vt.html',
  'photoshoot-user.html',
  'cars.html',
  'sales.html',
  'inventory.html',
  'act.html'
],
    [ROLE_BRANCH]: ['dashboard.html']
  };

  // ØµÙØ­Ø© ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© + Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ
  const PAGE_ALLOWED_ROLES = [ROLE_ADMIN, ROLE_IDARI];

  async function fetchUserRole(user){
    try{
      const userDocRef = doc(db, 'user', user.uid); // collection name: "user"
      const snap = await getDoc(userDocRef);
      if(snap.exists()){
        const data = snap.data() || {};
        return data.role || null;
      }
    }catch(e){
      console.error('Error fetching user role', e);
    }
    return null;
  }

  function applyTabsVisibility(role){
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab=>{
      const href = tab.getAttribute('href') || '';
      const page = (href.split('/').pop() || '').split('?')[0];
      if(!page) return;
      const perm = ROLE_PAGES[role];
      if(!perm){
        tab.style.display = 'none';
        return;
      }
      if(perm === 'ALL') return; // ÙŠØ´ÙˆÙ ÙƒÙ„ Ø­Ø§Ø¬Ø©
      if(!perm.includes(page)){
        tab.style.display = 'none';
      }
    });
  }

  const $ = s => document.querySelector(s);

  const connDot   = $('#connDot');
  const connText  = $('#connText');
  const authGate  = $('#authGate');
  const appRoot   = $('#app');
  const btnLogin  = $('#btnLogin');
  const btnSignup = $('#btnSignup');
  const btnSignOut= $('#btnSignOut');
  const emailEl   = $('#email');
  const passEl    = $('#password');
  const authHint  = $('#authHint');

  const carFilterEl     = $('#carFilter');
  const variantFilterEl = $('#variantFilter');
  const modelFilterEl   = $('#modelFilter');
  const btnApply        = $('#btnApply');
  const btnExport       = $('#btnExport');
  const resultsBody     = $('#resultsBody');
  const grandTotalEl    = $('#grandTotal');
  const groupsCountEl   = $('#groupsCount');
  const toast           = $('#toast');

  let stock = [];
  let lastGroups = [];
  const filters = { car:'', variant:'', model:'' };

  function setStatus(mode, txt){
    connDot.className = 'dot ' + (mode==='ok'?'ok':mode==='err'?'err':'');
    connText.textContent = txt;
  }
  function showToast(msg){
    toast.textContent = msg;
    toast.style.display = 'block';
    setTimeout(()=> toast.style.display='none', 1300);
  }
  function uniq(arr){ return [...new Set(arr.filter(Boolean))]; }

  /* ===== Auth ===== */
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      // Ø¬Ù„Ø¨ Ø§Ù„Ø¯ÙˆØ± Ù…Ù† Firestore ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
      const role = await fetchUserRole(user);

      if(!role || !PAGE_ALLOWED_ROLES.includes(role)){
        // Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø±Ø¤ÙŠØ© ØµÙØ­Ø© ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
        window.location.href = 'unauthorized.html';
        return;
      }

      authGate.style.display='none';
      appRoot.style.display='block';
      btnSignOut.style.display='inline-flex';
      setStatus('ok', `Ù…ØªØµÙ„: ${user.email} â€” Ø§Ù„Ø¯ÙˆØ±: ${role}`);
      applyTabsVisibility(role);
      await initData();
      subscribeLive();
      document.body.style.opacity='1';
    }else{
      appRoot.style.display='none';
      authGate.style.display='grid';
      btnSignOut.style.display='none';
      setStatus('', 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
      document.body.style.opacity='1';
    }
  });

  btnLogin.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{
      await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
    }catch(e){
      authHint.textContent='ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: '+(e?.message||e);
    }
  });

  btnSignup.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{
      await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
    }catch(e){
      authHint.textContent='ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: '+(e?.message||e);
    }
  });

  btnSignOut.addEventListener('click', ()=> signOut(auth));

  /* ===== Data ===== */
  async function initData(){
    try{
      const snap = await getDoc(STATE_REF);
      if(snap.exists()){
        const d = snap.data() || {};
        stock = Array.isArray(d.stock) ? d.stock : [];
      }else{
        stock = [];
      }
      initFilters();
      updateVariantOptionsForSelectedCar();
      applyFilterAndRender();
    }catch(e){
      console.error('initData error', e);
      resultsBody.innerHTML = `
        <tr>
          <td colspan="5" class="empty-row">
            ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase â€” ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø³ØªÙ†Ø¯ mzj_admin_state/v1 Ù…ÙˆØ¬ÙˆØ¯.
          </td>
        </tr>`;
      grandTotalEl.textContent  = '0';
      groupsCountEl.textContent = '0';
      setStatus('', 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ â€” Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­Ø©');
    }
  }

  function subscribeLive(){
    try{
      onSnapshot(STATE_REF,(snap)=>{
        if(!snap.exists()) return;
        const d = snap.data() || {};
        if(Array.isArray(d.stock)){
          stock = d.stock;
          initFilters();
          updateVariantOptionsForSelectedCar();
          applyFilterAndRender();
        }
        setStatus('ok','Ù…ØªØµÙ„ â€” Ù…Ø²Ø§Ù…Ù†Ø© Ø­ÙŠÙ‘Ø©');
      },(err)=>{
        console.warn('snapshot error', err);
        setStatus('', 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ â€” Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­ÙŠ Ù…ØªÙˆÙ‚Ù Ù…Ø¤Ù‚ØªÙ‹Ø§');
      });
    }catch(e){
      console.error('subscribe error', e);
    }
  }

  /* ===== Filters ===== */
  function initFilters(){
    const cars   = uniq(stock.map(r=> r.car));
    const models = uniq(stock.map(r=> r.modelYear));

    carFilterEl.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</option>' +
      cars.sort((a,b)=> String(a).localeCompare(String(b),'ar'))
          .map(v=> `<option value="${v}">${v}</option>`).join('');

    modelFilterEl.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª</option>' +
      models.sort((a,b)=> String(a).localeCompare(String(b),'ar'))
            .map(v=> `<option value="${v}">${v}</option>`).join('');
  }

  function updateVariantOptionsForSelectedCar(){
    const baseRows = filters.car
      ? stock.filter(r=> r.car === filters.car)
      : stock;

    const variants = uniq(baseRows.map(r=> r.variant));
    const currentVariant = filters.variant;

    variantFilterEl.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>' +
      variants.sort((a,b)=> String(a).localeCompare(String(b),'ar'))
              .map(v=> `<option value="${v}">${v}</option>`).join('');

    if(currentVariant && variants.includes(currentVariant)){
      variantFilterEl.value = currentVariant;
    }else{
      filters.variant = '';
      variantFilterEl.value = '';
    }
  }

  function applyFilterAndRender(){
    if(!Array.isArray(stock) || stock.length===0){
      resultsBody.innerHTML = `
        <tr>
          <td colspan="5" class="empty-row">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙŠØ§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.</td>
        </tr>`;
      grandTotalEl.textContent  = '0';
      groupsCountEl.textContent = '0';
      lastGroups = [];
      return;
    }

    const filtered = stock.filter(r=>{
      const car   = r.car || '';
      const varnt = r.variant || '';
      const model = r.modelYear!=null ? String(r.modelYear) : '';

      if(filters.car && car !== filters.car) return false;
      if(filters.variant && varnt !== filters.variant) return false;
      if(filters.model && model !== filters.model) return false;
      return true;
    });

    const map = new Map();
    filtered.forEach(r=>{
      const car   = r.car || '-';
      const varnt = r.variant || '-';
      const model = r.modelYear!=null ? String(r.modelYear) : '-';
      const key = `${car}||${varnt}||${model}`;
      const current = map.get(key) || { car, variant:varnt, model, total:0 };
      current.total += 1;
      map.set(key,current);
    });

    const groups = Array.from(map.values());
    lastGroups = groups;

    if(groups.length===0){
      resultsBody.innerHTML = `
        <tr>
          <td colspan="5" class="empty-row">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</td>
        </tr>`;
      grandTotalEl.textContent  = '0';
      groupsCountEl.textContent = '0';
      return;
    }

    let grand = 0;
    const rowsHtml = groups
      .sort((a,b)=> String(a.car).localeCompare(String(b.car),'ar'))
      .map((g,idx)=>{
        grand += g.total;
        return `
          <tr>
            <td>${idx+1}</td>
            <td><span class="chip">${g.car}</span></td>
            <td><span class="chip">${g.variant}</span></td>
            <td><span class="chip">${g.model}</span></td>
            <td>${g.total}</td>
          </tr>`;
      }).join('');

    resultsBody.innerHTML     = rowsHtml;
    grandTotalEl.textContent  = grand;
    groupsCountEl.textContent = groups.length;
  }

  carFilterEl.addEventListener('change',e=>{
    filters.car = e.target.value;
    updateVariantOptionsForSelectedCar();
  });
  variantFilterEl.addEventListener('change',e=>{
    filters.variant = e.target.value;
  });
  modelFilterEl .addEventListener('change',e=>{
    filters.model = e.target.value;
  });
  btnApply.addEventListener('click', applyFilterAndRender);

  /* ===== Excel Export ===== */
  function exportExcelFromGroups(groups){
    if(!groups || groups.length===0){
      alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ© Ù„Ù„ØªØµØ¯ÙŠØ±. Ø¬Ø±Ù‘Ø¨ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„Ø§ØªØ± Ø£Ùˆ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø£ÙˆÙ„Ø§Ù‹.');
      return;
    }
    const header = ["Ø§Ù„Ø³ÙŠØ§Ø±Ø©","Ø§Ù„Ø¨ÙŠØ§Ù†","Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø¯Ø¯"];
    const data   = [header];
    groups.forEach(g=>{
      data.push([g.car, g.variant, g.model, g.total]);
    });
    const ws = XLSX.utils.aoa_to_sheet(data);
    ws['!cols'] = [
      {wch:30},
      {wch:30},
      {wch:10},
      {wch:14}
    ];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Summary");
    XLSX.writeFile(wb, "mzj-inventory-summary.xlsx");
  }
  btnExport.addEventListener('click', ()=> exportExcelFromGroups(lastGroups));

  /* Start */
  setStatus('', 'Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦');
  document.body.style.opacity='1';
</script>
  <script src="./mzj-ui.js"></script>

    </div>
  </main>
</div>

<nav class="mzj-downbar" aria-label="Ø§Ù„ØªÙ†Ù‚Ù„">
  <div class="inner">
    <a href="m.sales.html">ğŸ’¼<span>ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span></a>
    <a href="m.dashboard.html">ğŸ“Š<span>Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</span></a>
    <a href="m.inventory.html">ğŸ“¦<span>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span></a>
    <a href="m.vt.html">â†”ï¸<span>Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span></a>
    <a href="m.photoshoot-user.html">ğŸ“·<span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span></a>

    <a class="active" href="m.cars.html">ğŸš—<span>ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span></a>
    <a href="m.admin.html">ğŸ <span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span></a>
    <a href="m.Activity.html">ğŸ•˜<span>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</span></a>
    <a href="m.act.html">ğŸ§¾<span>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</span></a>
  </div>
</nav>

<style id="mzjMobileOverridesCars">
:root{
  --mzj-brown: rgb(62,36,32);
  --mzj-cream: #fff8ef;
  --mzj-downbar-h: 138px;
  --mzj-downbar-lift: 14px;
}
@media (max-width: 1023px){
  html,body{ margin:0 !important; padding:0 !important; overflow-x:hidden !important; background: var(--mzj-cream) !important; }

  /* Hide desktop chrome */
  .mzj-sidebar, .mzj-topbar, header, .topbar, .sidebar, .side-nav{ display:none !important; }

  /* FULL BLEED 0px */
  body{ padding-left:0 !important; padding-right:0 !important; }
  main, .mzj-content, .content, .main, .main-content, .page,
  .container, .wrap, .content-wrap, .inner, .wrapper, [class*="container"], [class*="wrapper"]{
    width:100% !important;
    max-width:100% !important;
    margin-left:0 !important;
    margin-right:0 !important;
    padding-left:0 !important;
    padding-right:0 !important;
  }

  /* tighten legacy container padding */
  .legacy .container{ padding:0 0 !important; margin:10px 0 !important; }
  .card{ margin:10px 10px !important; } /* small gutter like other pages */
  .table-wrap{ margin:0 10px !important; }

  /* Let filter grid stack nicely */
  .filter-grid{ grid-template-columns: 1fr !important; }
}

/* ===== DOWNBAR (2 rows) ===== */
body{
  padding-bottom: calc(var(--mzj-downbar-h) + env(safe-area-inset-bottom, 0px) + var(--mzj-downbar-lift) + 18px) !important;
}
.mzj-downbar{
  position: fixed !important;
  left: 0 !important;
  right: 0 !important;
  bottom: calc(env(safe-area-inset-bottom, 0px) + var(--mzj-downbar-lift)) !important;
  height: var(--mzj-downbar-h) !important;
  z-index: 9999 !important;
  background: rgba(255,255,255,.96) !important;
  backdrop-filter: blur(8px);
  border-top: 1px solid rgba(0,0,0,.06);
}
.mzj-downbar .inner{
  height: var(--mzj-downbar-h) !important;
  display: grid !important;
  grid-template-columns: repeat(5, minmax(0, 1fr)) !important;
  grid-auto-flow: row !important;
  grid-auto-rows: 1fr !important;
  gap: 6px !important;
  padding: 10px 10px 12px !important;
}
.mzj-downbar a{
  display:flex !important;
  flex-direction:column !important;
  align-items:center !important;
  justify-content:center !important;
  gap: 4px !important;
  padding: 8px 4px !important;
  border-radius: 14px !important;
  text-decoration:none !important;
  font-size: 17px !important;
  color: var(--mzj-brown) !important;
}
.mzj-downbar a.active{
  background: rgba(188,143,116,.22) !important;
  border:1px solid rgba(188,143,116,.35) !important;
}
.mzj-downbar a span{
  font-size: 9px !important;
  font-weight: 900 !important;
  line-height: 1.15 !important;
  text-align:center !important;
  white-space: normal !important;
  overflow: hidden !important;
  display: -webkit-box !important;
  -webkit-line-clamp: 2 !important;
  -webkit-box-orient: vertical !important;
  max-width: 100% !important;
}
</style>
<style id="mzjCarsCardsCSS">
@media (max-width: 1023px){
  /* hide table on mobile */
  .table-wrap table{ display:none !important; }
  #mzjMobileCards{ display:block !important; }

  .mzj-mobile-cards{ padding:0 !important; margin:0 !important; width:100% !important; }
  .mzj-card-item{
    background: rgba(255,255,255,.95);
    border: 1px solid rgba(0,0,0,.08);
    border-radius: 16px;
    box-shadow: 0 6px 18px rgba(0,0,0,.06);
    padding: 12px 12px;
    margin: 10px 0; /* inside table-wrap margin already */
  }
  .mzj-card-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 8px; }
  .mzj-card-title{ font-weight: 900; color: rgb(62,36,32); font-size: 16px; line-height: 1.2; }
  .mzj-card-badge{
    font-size: 12px; font-weight: 900; color: rgb(62,36,32);
    background: rgba(188,143,116,.22); border:1px solid rgba(188,143,116,.35);
    padding: 6px 10px; border-radius: 999px; white-space:nowrap;
  }
  .mzj-card-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 8px 10px; margin-top: 8px; }
  .mzj-field{
    background: rgba(255,248,239,.9);
    border: 1px solid rgba(0,0,0,.06);
    border-radius: 12px;
    padding: 8px 10px;
    min-width: 0;
  }
  .mzj-field .k{ display:block; font-size: 11px; color: rgba(62,36,32,.75); font-weight: 900; margin-bottom: 3px; }
  .mzj-field .v{ display:block; font-size: 13px; color: rgba(0,0,0,.8); font-weight: 800; line-height: 1.25; word-break: break-word; }
}
@media (min-width: 1024px){
  #mzjMobileCards{ display:none !important; }
}
</style>
<script id="mzjCarsCardsJS">
(function(){
  function qs(sel, root){ return (root||document).querySelector(sel); }
  function qsa(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }

  function findResultsTable(){
    // the table that contains #resultsBody is the one we convert
    var tbody = qs('#resultsBody');
    if (tbody && tbody.closest('table')) return tbody.closest('table');
    // fallback: first table inside .table-wrap
    var wrap = qs('.table-wrap');
    return wrap ? qs('table', wrap) : qs('table');
  }

  function getHeaders(table){
    var ths = qsa('thead th', table);
    return ths.map(function(th){ return (th.textContent||'').trim(); });
  }

  function buildCards(){
    var cardsRoot = qs('#mzjMobileCards');
    if (!cardsRoot) return;

    var table = findResultsTable();
    if (!table) return;

    var headers = getHeaders(table);
    var tbody = qs('tbody', table) || table;
    var rows = qsa('tr', tbody).filter(function(tr){ return qsa('td', tr).length; });

    // if loading/empty row, show it as a single card
    if (rows.length === 1 && rows[0].querySelector('td[colspan]')){
      var msg = (rows[0].textContent||'').trim();
      cardsRoot.innerHTML = '<div class="mzj-card-item"><div class="mzj-card-head"><div class="mzj-card-title">Ø§Ù„Ù†ØªÙŠØ¬Ø©</div></div><div class="mzj-field" style="margin-top:8px"><span class="v">'+msg+'</span></div></div>';
      return;
    }

    cardsRoot.innerHTML = '';

    rows.forEach(function(tr, idx){
      var tds = qsa('td', tr);
      if (!tds.length) return;

      // expected columns: #, car, variant, model, total
      var carVal = tds[1] ? (tds[1].textContent||'').trim() : '';
      var variantVal = tds[2] ? (tds[2].textContent||'').trim() : '';
      var modelVal = tds[3] ? (tds[3].textContent||'').trim() : '';
      var totalVal = tds[4] ? (tds[4].textContent||'').trim() : '';

      var card = document.createElement('div');
      card.className = 'mzj-card-item';

      var head = document.createElement('div');
      head.className = 'mzj-card-head';

      var title = document.createElement('div');
      title.className = 'mzj-card-title';
      title.textContent = carVal || ('ØµÙ #' + (idx+1));

      var badge = document.createElement('div');
      badge.className = 'mzj-card-badge';
      badge.textContent = (headers[4] || 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø¯Ø¯') + ': ' + (totalVal || '-');

      head.appendChild(title);
      head.appendChild(badge);
      card.appendChild(head);

      var grid = document.createElement('div');
      grid.className = 'mzj-card-grid';

      function addField(k, v, full){
        if (!v) return;
        var f = document.createElement('div');
        f.className = 'mzj-field';
        if (full) f.style.gridColumn = '1 / -1';
        f.innerHTML = '<span class="k"></span><span class="v"></span>';
        f.querySelector('.k').textContent = k;
        f.querySelector('.v').textContent = v;
        grid.appendChild(f);
      }

      addField(headers[2] || 'Ø§Ù„Ø¨ÙŠØ§Ù†', variantVal, true);
      addField(headers[3] || 'Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„', modelVal, false);

      card.appendChild(grid);
      cardsRoot.appendChild(card);
    });
  }

  function init(){
    var table = findResultsTable();
    if (!table) return;
    buildCards();

    var tbody = table.querySelector('tbody') || table;
    var obs = new MutationObserver(function(){
      clearTimeout(window.__mzjCarsCardsT);
      window.__mzjCarsCardsT = setTimeout(buildCards, 120);
    });
    obs.observe(tbody, {childList:true, subtree:true, characterData:true});
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
</body>
</html>






