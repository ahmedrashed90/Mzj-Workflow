
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>MZJ Workspace — التتبع</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --card:#ffffff; --line:#e7e5e4;
      --text:#111827; --muted:#6b7280; --ok:#16a34a; --danger:#ef4444;
      --radius:16px; --shadow:0 18px 45px rgba(62,36,32,.12);
      --safe-b: env(safe-area-inset-bottom);
      --safe-t: env(safe-area-inset-top);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text);
      background: linear-gradient(180deg, #fffaf3 0%, #fff4ea 55%, #fff0e3 100%);
      padding-bottom: calc(92px + var(--safe-b));
    }
    .wrap{max-width:540px; margin:0 auto; padding:14px 14px 0;}
    .header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: rgba(255,248,239,.85);
      border-bottom:1px solid rgba(231,229,228,.8);
      padding: calc(10px + var(--safe-t)) 14px 10px;
    }
    .header-row{display:flex; align-items:center; justify-content:space-between; gap:10px; max-width:540px; margin:0 auto;}
    .h-title{font-weight:900; font-size:18px; color:var(--brown);}
    .h-sub{font-size:12px; color:var(--muted); margin-top:2px;}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px; border:1px solid var(--line); background:#fff;
      font-size:12px; color:#374151; box-shadow:0 8px 20px rgba(0,0,0,.06);
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:50%; background:var(--danger);}
    .dot.ok{background:var(--ok);}
    .btn{
      border:1px solid var(--line); background:#fff; color:var(--brown);
      padding:10px 12px; border-radius:12px; font-weight:800; cursor:pointer;
    }
    .btn.primary{background:var(--brown); color:#fff; border-color:transparent;}
    .btn:active{transform: translateY(1px);}
    .card{
      background:var(--card);
      border:1px solid rgba(231,229,228,.85);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .tabs{display:flex; gap:10px; margin-top:14px;}
    .tab{
      flex:1; padding:12px 10px; border-radius:14px;
      border:1px solid rgba(231,229,228,.95);
      background:rgba(255,255,255,.85);
      font-weight:900; color:var(--brown); cursor:pointer;
    }
    .tab.active{background:var(--brown); color:#fff; border-color:transparent;}
    .section{margin-top:14px;}
    label{display:block; font-size:12px; color:var(--muted); margin:0 2px 6px;}
    input{width:100%; padding:12px 12px; border-radius:14px; border:1px solid var(--line); font-size:15px; outline:none;}
    input:focus{border-color: rgba(188,143,116,.9); box-shadow:0 0 0 4px rgba(188,143,116,.18);}
    .row{display:flex; gap:10px;}
    .row > *{flex:1;}
    .hint{font-size:12px; color:var(--muted); margin-top:8px;}
    .msg{margin-top:10px; font-weight:800;}
    .msg.err{color:var(--danger);}
    .msg.ok{color:var(--ok);}
    .orders{margin-top:12px; display:grid; gap:10px;}
    .order-card{
      border:1px solid rgba(231,229,228,.9);
      background:rgba(255,255,255,.92);
      border-radius:18px;
      padding:12px;
      display:flex; flex-direction:column; gap:8px;
    }
    .order-top{display:flex; align-items:flex-start; justify-content:space-between; gap:10px;}
    .order-no{font-weight:900; color:var(--brown); font-size:14px;}
    .order-status{font-size:12px; color:#374151; background:#fff; border:1px solid var(--line); padding:6px 10px; border-radius:999px;}
    .order-meta{display:grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:12px; color:#374151;}
    .kv{background:rgba(255,248,239,.75); border:1px dashed rgba(188,143,116,.45); border-radius:14px; padding:8px;}
    .kv b{display:block; font-size:11px; color:var(--muted); margin-bottom:2px; font-weight:900;}
    .order-actions{display:flex; gap:8px;}
    .order-actions .btn{flex:1;}
    .details{margin-top:12px; display:none;}
    .details.show{display:block;}
    .details-grid{display:grid; gap:10px; margin-top:10px;}
    .downbar{
      position:fixed; left:0; right:0; bottom:0; z-index:50;
      background:rgba(255,255,255,.92);
      border-top:1px solid rgba(231,229,228,.9);
      padding:10px 10px calc(10px + var(--safe-b));
      backdrop-filter: blur(10px);
    }
    .downbar .nav{max-width:540px; margin:0 auto; display:grid; grid-template-columns:repeat(4,1fr); gap:8px;}
    .nav a{
      text-decoration:none; color:var(--brown);
      border:1px solid rgba(231,229,228,.95);
      background:rgba(255,255,255,.75);
      border-radius:16px;
      padding:10px 8px;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:6px;
      font-weight:900;
      font-size:12px;
      min-height:56px;
    }
    .nav a.active{background:rgba(255,248,239,.9); border-color:rgba(188,143,116,.55); box-shadow:0 10px 24px rgba(62,36,32,.10);}
    .ico{width:22px; height:22px;}
    .ico path{fill: none; stroke: var(--beige); stroke-width:2.2; stroke-linecap:round; stroke-linejoin:round;}
    .nav a.active .ico path{stroke: var(--brown);}
  </style>
</head>
<body>
  <header class="header">
    <div class="header-row">
      <div>
        <div class="h-title">التتبع</div>
        <div class="h-sub">التتبع وإدارة الطلبات — نسخة موبايل</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <div class="badge" id="connBadge"><span class="dot" id="connDot"></span><span id="connText">جارِ الاتصال…</span></div>
        <button class="btn" id="btnLogout" style="display:none;">تسجيل الخروج</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="tabs">
        <button class="tab active" id="tabAll">كل الطلبات</button>
        <button class="tab" id="tabSearch">بحث عن طلب</button>
      </div>

      <div class="section" id="allSection">
        <div class="row" style="margin-top:12px;">
          <div>
            <label>بحث سريع داخل القائمة</label>
            <input id="listFilter" placeholder="اكتب رقم الطلب / اسم العميل / رقم الهيكل"/>
          </div>
        </div>
        <div class="hint" id="listHint">سيتم تحميل آخر 100 طلب من النظام.</div>
        <div class="orders" id="ordersCards"></div>
        <div class="msg" id="listMsg"></div>
      </div>

      <div class="section" id="searchSection" style="display:none;">
        <div class="row" style="margin-top:12px;">
          <div>
            <label>رقم الطلب</label>
            <input id="orderIdInput" placeholder="SAL-ORD-2025-01109"/>
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="btnOpenOrder">فتح الطلب</button>
          <button class="btn" id="btnClear">تفريغ</button>
        </div>
        <div class="hint">اكتب رقم الطلب ثم اضغط فتح الطلب.</div>
        <div class="msg" id="orderMsg"></div>

        <div class="details card details" id="detailsCard" style="margin-top:12px;">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div style="font-weight:900;color:var(--brown);" id="detailsTitle">تفاصيل الطلب</div>
            <button class="btn primary" id="btnOpenTracking" style="display:none;">فتح صفحة التتبع</button>
          </div>
          <div class="details-grid" id="detailsGrid"></div>
        </div>
      </div>
    </div>
  </main>

  <footer class="downbar" aria-label="Bottom navigation">
    <nav class="nav">
      <a href="admin-mobile.html">
        <svg class="ico" viewBox="0 0 24 24"><path d="M12 3l9 4v6c0 5-3.5 9.5-9 11C6.5 22.5 3 18 3 13V7l9-4z"/></svg>
        الإدارة
      </a>
      <a href="inventory-mobile.html">
        <svg class="ico" viewBox="0 0 24 24"><path d="M3 7l9-4 9 4-9 4-9-4zM3 7v10l9 4 9-4V7"/></svg>
        المخزون
      </a>
      <a href="dashboard-mobile.html">
        <svg class="ico" viewBox="0 0 24 24"><path d="M4 13V4h7v9H4zM13 20V4h7v16h-7zM4 20v-5h7v5H4z"/></svg>
        الداش
      </a>
      <a href="vt-mobile.html">
        <svg class="ico" viewBox="0 0 24 24"><path d="M7 7h10M7 17h10M7 7l-3 3 3 3M17 17l3-3-3-3"/></svg>
        نقل
      </a>

      <a href="photoshoot-user-mobile.html">
        <svg class="ico" viewBox="0 0 24 24"><path d="M4 7h4l2-2h4l2 2h4v13H4V7zM12 11a4 4 0 100 8 4 4 0 000-8z"/></svg>
        الطلبات
      </a>
      <a href="cars-mobile.html">
        <svg class="ico" viewBox="0 0 24 24"><path d="M3 16l1-4 3-5h10l3 5 1 4M7 16v3M17 16v3M6 16h12M7 19h2M15 19h2"/></svg>
        السيارات
      </a>
      <a class="active" href="sales-mobile.html">
        <svg class="ico" viewBox="0 0 24 24"><path d="M12 3l7 5v6c0 5-3 8-7 10-4-2-7-5-7-10V8l7-5zM9 13l2 2 4-5"/></svg>
        التتبع
      </a>
      <a href="activity-mobile.html">
        <svg class="ico" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4M2 12a10 10 0 1010-10"/></svg>
        النشاط
      </a>
    </nav>
  </footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, collection, doc, getDoc, getDocs, query, where, limit } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.firebasestorage.app",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66"
    };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const ERP_COLLECTION = "erp_orders";
  const TRACK_COLLECTION = "orders";
  const STAGES = [
      "1) طلب الشراء (خاص بالعميل)",
      "2) إيصال الدفع (خاص بالعميل)",
      "3) التواصل من قِبل ممثلي خدمة العملاء بإرسال البطاقة الجركية (خاص بالمعرض)",
      "4) سداد رسوم التسجيل (خاص بالعميل)",
      "5) التأمين – شرط الربط على السيستم (خاص بالعميل)",
      "6) استيفاء المبالغ المتبقية (خاص بالعميل)",
      "7) استيفاء الأوراق المتبقية (خاص بالعميل)",
      "8) إصدار اللوحات أو نقل الملكية (خاص بالمعرض)",
      "9) جاهزية السيارة للاستلام (خاص بالمعرض)",
      "10) إتمام عملية التسليم بنجاح"
    ];

  // UI refs
  const connDot = document.getElementById("connDot");
  const connText = document.getElementById("connText");
  const btnLogout = document.getElementById("btnLogout");

  const tabAll = document.getElementById("tabAll");
  const tabSearch = document.getElementById("tabSearch");
  const allSection = document.getElementById("allSection");
  const searchSection = document.getElementById("searchSection");

  const ordersCards = document.getElementById("ordersCards");
  const listFilter = document.getElementById("listFilter");
  const listMsg = document.getElementById("listMsg");
  const listHint = document.getElementById("listHint");

  const orderIdInput = document.getElementById("orderIdInput");
  const btnOpenOrder = document.getElementById("btnOpenOrder");
  const btnClear = document.getElementById("btnClear");
  const orderMsg = document.getElementById("orderMsg");

  const detailsCard = document.getElementById("detailsCard");
  const detailsGrid = document.getElementById("detailsGrid");
  const detailsTitle = document.getElementById("detailsTitle");
  const btnOpenTracking = document.getElementById("btnOpenTracking");

  let allRows = [];

  function setConn(ok, label){
    connDot.classList.toggle("ok", !!ok);
    connText.textContent = label;
  }

  function activateTab(name){
    const isAll = name === "all";
    tabAll.classList.toggle("active", isAll);
    tabSearch.classList.toggle("active", !isAll);
    allSection.style.display = isAll ? "" : "none";
    searchSection.style.display = isAll ? "none" : "";
    if(isAll) {
      detailsCard.classList.remove("show");
      detailsCard.style.display = "none";
      orderMsg.textContent = "";
    }
  }

  function esc(s) {
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function getFieldFlex(key, obj){
    if(!obj) return "";
    const keys = [
      key, key.toLowerCase(), key.toUpperCase(),
      "CustomerName","customerName","اسم العميل",
      "CustomerPhone","customerPhone","رقم جوال العميل",
      "Branch","branch","الفرع",
      "DeliveryDate","deliveryDate","تاريخ التسليم",
      "VIN","vin","رقم الهيكل"
    ];
    for(const k of keys){
      if(Object.prototype.hasOwnProperty.call(obj, k) && obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k];
    }
    return "";
  }

  async function computeStatus(orderNo){
    try {
      const tSnap = await getDoc(doc(db, TRACK_COLLECTION, orderNo + "_1"));
      if(!tSnap.exists()) return "لم يبدأ";
      const t = tSnap.data() || {};
      const stagesObj = t.stages || {};
      const doneCount = Object.keys(stagesObj).filter(k => stagesObj[k]).length;
      if(doneCount === 0) return "لم يبدأ";
      if(doneCount >= STAGES.length) return "تم إتمام جميع المراحل";
      return `تم تنفيذ ${doneCount} من ${STAGES.length} مراحل`;
    } catch(e) {
      console.warn("status err", e);
      return "—";
    }
  }

  function renderCards(rows){
    ordersCards.innerHTML = "";
    if(!rows.length){
      ordersCards.innerHTML = "<div class='hint' style='text-align:center;'>لا توجد طلبات مطابقة.</div>";
      return;
    }
    const frag = document.createDocumentFragment();
    rows.forEach(r => {
      const el = document.createElement("div");
      el.className = "order-card";
      el.innerHTML = `
        <div class="order-top">
          <div class="order-no">${esc(r.orderNo)}</div>
          <div class="order-status">${esc(r.statusLabel || "—")}</div>
        </div>
        <div class="order-meta">
          <div class="kv"><b>اسم العميل</b>${esc(r.customerName || "—")}</div>
          <div class="kv"><b>الجوال</b>${esc(r.customerPhone || "—")}</div>
          <div class="kv"><b>الفرع</b>${esc(r.branch || "—")}</div>
          <div class="kv"><b>VIN</b>${esc(r.vinVal || "—")}</div>
        </div>
        <div class="order-actions">
          <button class="btn primary" data-open="${esc(r.orderNo)}">فتح</button>
          <button class="btn" data-copy="${esc(r.orderNo)}">نسخ</button>
        </div>
      `;
      frag.appendChild(el);
    });
    ordersCards.appendChild(frag);
  }

  function applyFilter(){
    const q = (listFilter.value || "").trim().toLowerCase();
    if(!q) return renderCards(allRows);
    const filtered = allRows.filter(r => {
      const blob = `${r.orderNo} ${r.customerName} ${r.customerPhone} ${r.branch} ${r.vinVal}`.toLowerCase();
      return blob.includes(q);
    });
    renderCards(filtered);
  }

  async function loadOrders(){
    listMsg.textContent = "";
    ordersCards.innerHTML = "<div class='hint' style='text-align:center;'>جاري تحميل الطلبات…</div>";
    try {
      const q = query(collection(db, ERP_COLLECTION), limit(100));
      const snap = await getDocs(q);
      if(snap.empty){
        allRows = [];
        renderCards([]);
        listHint.textContent = "لا توجد طلبات مسجلة حالياً.";
        return;
      }
      const rows = [];
      for (const docSnap of snap.docs) {
        const d = docSnap.data() || {};
        const orderNo = d.orderNo || d.OrderNo || docSnap.id;
        const vinVal  = getFieldFlex("VIN", d) || "";
        const customerName = getFieldFlex("CustomerName", d) || "";
        const customerPhone = getFieldFlex("CustomerPhone", d) || "";
        const branch = getFieldFlex("Branch", d) || "";
        const deliveryDate = getFieldFlex("DeliveryDate", d) || "";
        rows.push({ orderNo, vinVal, customerName, customerPhone, branch, deliveryDate, statusLabel:"…" });
      }
      // Compute statuses sequentially (safe)
      for (const r of rows) {
        r.statusLabel = await computeStatus(r.orderNo);
      }
      allRows = rows;
      listHint.textContent = `تم التحميل: ${rows.length}`;
      renderCards(rows);
    } catch(err) {
      console.error(err);
      listMsg.textContent = "خطأ في تحميل البيانات.";
      listMsg.className = "msg err";
      ordersCards.innerHTML = "";
    }
  }

  async function loadOrderById(orderId){
    orderMsg.className = "msg";
    orderMsg.textContent = "";
    detailsCard.classList.remove("show");
    detailsCard.style.display = "none";
    detailsGrid.innerHTML = "";
    btnOpenTracking.style.display = "none";

    const idRaw = (orderId || orderIdInput.value || "").trim();
    if(!idRaw){
      orderMsg.className = "msg err";
      orderMsg.textContent = "اكتب رقم الطلب.";
      return;
    }
    orderMsg.textContent = "جاري تحميل الطلب…";

    try {
      let erpData = null;

      const tryIds = [idRaw];
      if(idRaw.includes("_")) tryIds.push(idRaw.split("_")[0]);

      for(const tid of tryIds){
        const snap = await getDoc(doc(db, ERP_COLLECTION, tid));
        if(snap.exists()) { erpData = snap.data(); break; }
      }

      if(!erpData){
        const base = idRaw.includes("_") ? idRaw.split("_")[0] : idRaw;
        const qsnap = await getDocs(query(collection(db, ERP_COLLECTION), where("orderNo","==",base), limit(1)));
        if(!qsnap.empty) erpData = qsnap.docs[0].data();
      }

      if(!erpData){
        orderMsg.className = "msg err";
        orderMsg.textContent = "لم يتم العثور على الطلب.";
        return;
      }

      const orderNo = erpData.orderNo || erpData.OrderNo || idRaw;
      const customerName = getFieldFlex("CustomerName", erpData) || "—";
      const customerPhone = getFieldFlex("CustomerPhone", erpData) || "—";
      const branch = getFieldFlex("Branch", erpData) || "—";
      const deliveryDate = getFieldFlex("DeliveryDate", erpData) || "—";
      const vinVal = getFieldFlex("VIN", erpData) || "—";

      const statusLabel = await computeStatus(orderNo);

      detailsTitle.textContent = `تفاصيل الطلب: ${orderNo}`;
      detailsGrid.innerHTML = `
        <div class="kv"><b>الحالة</b>${esc(statusLabel)}</div>
        <div class="kv"><b>اسم العميل</b>${esc(customerName)}</div>
        <div class="kv"><b>جوال العميل</b>${esc(customerPhone)}</div>
        <div class="kv"><b>الفرع</b>${esc(branch)}</div>
        <div class="kv"><b>تاريخ التسليم</b>${esc(deliveryDate)}</div>
        <div class="kv"><b>VIN</b>${esc(vinVal)}</div>
      `;

      orderMsg.className = "msg ok";
      orderMsg.textContent = "تم فتح الطلب.";
      detailsCard.classList.add("show");
      detailsCard.style.display = "block";

      if(vinVal && vinVal !== "—"){
        btnOpenTracking.style.display = "";
        btnOpenTracking.onclick = () => {
          const url = `https://mzj-tracking.vercel.app/Test-Track.html?vin=${encodeURIComponent(vinVal)}`;
          window.open(url, "_blank");
        };
      }
    } catch(err) {
      console.error(err);
      orderMsg.className = "msg err";
      orderMsg.textContent = "خطأ أثناء فتح الطلب.";
    }
  }

  // Events
  tabAll.addEventListener("click", () => activateTab("all"));
  tabSearch.addEventListener("click", () => activateTab("search"));
  listFilter.addEventListener("input", applyFilter);

  ordersCards.addEventListener("click", (e) => {
    const openBtn = e.target.closest("button[data-open]");
    const copyBtn = e.target.closest("button[data-copy]");
    if(openBtn){
      const ord = openBtn.getAttribute("data-open");
      try { navigator.clipboard.writeText(ord); } catch(_e) {}
      orderIdInput.value = ord;
      activateTab("search");
      loadOrderById(ord);
    }
    if(copyBtn){
      const ord = copyBtn.getAttribute("data-copy");
      try { navigator.clipboard.writeText(ord); } catch(_e) {}
      listMsg.className = "msg ok";
      listMsg.textContent = "تم النسخ: " + ord;
      setTimeout(()=>{ listMsg.textContent=""; listMsg.className="msg"; }, 1200);
    }
  });

  btnOpenOrder.addEventListener("click", () => loadOrderById());
  btnClear.addEventListener("click", () => {
    orderIdInput.value = "";
    orderMsg.textContent = "";
    detailsCard.classList.remove("show");
    detailsCard.style.display = "none";
    detailsGrid.innerHTML = "";
  });

  btnLogout.addEventListener("click", async () => {
    await signOut(auth);
    location.href = "admin-mobile.html";
  });

  // Auth
  onAuthStateChanged(auth, async (user) => {
    if(!user){
      setConn(false, "غير مسجل");
      // لو بتحب نرميه للادمن
      // location.href = "admin-mobile.html";
      return;
    }
    setConn(true, "متصل");
    btnLogout.style.display = "";
    await loadOrders();
  });
</script>
</body>
</html>
