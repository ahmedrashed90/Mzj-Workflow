















<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <link rel="icon" type="image/x-icon" href="assets/favicon.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MZJ â€“ ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --text:#111827;
      --muted:#6b7280;
      --radius:16px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#fffdf8 0,#fff3e6 40%,#fbe9da 70%,#f5e3d3 100%);
      color:var(--text);
    }
    .topbar{
      background:var(--brown);
      color:#fff;
      padding:10px 20px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:0 6px 14px rgba(0,0,0,.2);
    }
    .topbar-title{
      font-weight:800;
      letter-spacing:.6px;
      font-size:17px;
    }
    .topbar-right{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
    }
    .logout{
      border:0;
      padding:6px 12px;
      border-radius:999px;
      background:#fff;
      color:var(--brown);
      cursor:pointer;
      font-family:inherit;
      font-size:12px;
    }
    .wrap{
      max-width:1150px;
      margin:22px auto 36px;
      padding:0 14px;
    }
    .card{
      background:#fff;
      border-radius:var(--radius);
      box-shadow:0 16px 40px rgba(62,36,32,.13);
      padding:18px 18px 20px;
      margin-bottom:18px;
    }
    .title{
      margin:0 0 12px 0;
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--brown);
      font-size:18px;
    }
    .title .icon{
      width:26px;
      height:26px;
      border-radius:999px;
      background:rgba(188,143,116,.16);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
    }
    .row{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:10px;
    }
    .col-3{grid-column:span 3;}
    .col-4{grid-column:span 4;}
    .col-6{grid-column:span 6;}
    .col-12{grid-column:span 12;}
    label{
      display:block;
      font-size:13px;
      margin-bottom:4px;
      color:var(--muted);
    }
    input{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-family:inherit;
      font-size:14px;
      outline:none;
    }
    input:focus{
      background:#fff;
      border-color:var(--beige);
      box-shadow:0 0 0 1px rgba(188,143,116,.45);
    }
    select{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-family:inherit;
      font-size:14px;
      outline:none;
      appearance:none;
    }
    select:focus{
      background:#fff;
      border-color:var(--beige);
      box-shadow:0 0 0 1px rgba(188,143,116,.45);
    }
    .btn{
      border:0;
      border-radius:999px;
      padding:8px 16px;
      font-family:inherit;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:14px;
      background:var(--brown);
      color:#fff;
    }
    .btn-outline{
      border-radius:999px;
      border:1px solid var(--brown);
      padding:8px 14px;
      font-family:inherit;
      cursor:pointer;
      background:transparent;
      color:var(--brown);
      font-size:13px;
    }
    .btn:disabled,.btn-outline:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .muted{color:var(--muted);font-size:13px;}
    .hint{color:var(--muted);font-size:12px;margin-top:4px;}
    .ok{color:#047857;font-weight:700;}
    .err{color:#b91c1c;font-weight:700;}
    .badge{
      display:inline-block;
      padding:3px 9px;
      border-radius:999px;
      background:rgba(188,143,116,.16);
      color:var(--brown);
      font-size:11px;
      margin-left:4px;
    }
    .erp-table-wrap{
      margin-top:8px;
      overflow-x:auto;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead{
      background:#f3f4f6;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid #e5e7eb;
      white-space:nowrap;
    }
    th{font-weight:600;color:#374151;text-align:right;}
    td{color:#111827;}
    .grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .stage{
      background:#fffaf3;
      border-radius:12px;
      padding:10px 12px;
      border:1px dashed rgba(188,143,116,.55);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .stage.done{
      background:#ecfdf5;
      border-style:solid;
      border-color:#22c55e;
    }
    .stage-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .stage strong{color:var(--brown);font-size:13px;}
    .stage small{font-size:11px;color:var(--muted);}

    .tabs{
      display:none;
      margin:-8px 0 10px;
      gap:8px;
    }
    .tab-btn{
      padding:6px 14px;
      border-radius:999px;
      border:1px solid transparent;
      background:#f3f4f6;
      color:#374151;
      font-size:13px;
      cursor:pointer;
      font-family:inherit;
    }
    .tab-btn.tab-active{
      background:var(--brown);
      color:#fff;
      border-color:var(--brown);
    }
    .link-btn{
      border:0;
      background:none;
      color:#1d4ed8;
      text-decoration:underline;
      cursor:pointer;
      font-size:13px;
      font-family:inherit;
      padding:0;
    }

    /* Orders list: unread (not opened yet) rows */
    .unread-row td{font-weight:800;}
    .unread-row td .link-btn{font-weight:900;}

    .totals-box{
      margin:6px 0 10px;
      padding:8px 10px;
      border-radius:10px;
      background:#fffaf3;
      border:1px solid rgba(188,143,116,.4);
      font-size:13px;
      color:var(--brown);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .totals-box span{
      white-space:nowrap;
    }

    /* VIN picker box Ø§Ø­ØªØ±Ø§ÙÙŠ */
    .vin-box{
      display:none;
      margin:10px 0 14px;
      padding:10px 12px;
      border-radius:12px;
      background:#fffaf3;
      border:1px solid rgba(188,143,116,.6);
    }
    .vin-box-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .vin-box-title{
      font-size:13px;
      font-weight:600;
      color:var(--brown);
    }
    .vin-chip{
      padding:3px 10px;
      border-radius:999px;
      background:rgba(62,36,32,.06);
      font-size:11px;
      color:var(--muted);
    }

    @media(max-width:900px){
      .row{grid-template-columns:1fr;}
      .col-3,.col-4,.col-6,.col-12{grid-column:span 1;}
      .grid-2{grid-template-columns:1fr;}
      .topbar{flex-direction:column;align-items:flex-start;gap:6px;}
      .tabs{flex-wrap:wrap;}
    }
  
/* ===== Admin-like Topbar overrides for Sales ===== */
.topbar{
  position:sticky;
  top:0;
  z-index:1000;
  background:#fff;
  border-bottom:1px solid var(--line, #e5e7eb);
  color:var(--text);
  padding:0; /* override sales padding */
  box-shadow:none; /* override sales shadow */
}
.topbar-inner{
  max-width:1240px;
  margin:auto;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 16px;
  gap:12px;
}
.brand{display:flex;align-items:center;gap:10px}
.brand .logo{
  width:36px;height:36px;border-radius:10px;
  background:linear-gradient(135deg,var(--brown),#2a1613);
  display:grid;place-items:center;color:#fff;font-weight:800;
}
.brand-text h1{margin:0;font-size:18px;color:var(--brown);font-weight:800;line-height:1.1}
.brand-text .hint{color:var(--muted);font-size:12px}

/* Tabs (keep original sales .tabs for page content untouched, target only in topbar) */
.topbar .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start}
.topbar .tab{
  padding:8px 12px;
  border:1px solid var(--line, #e5e7eb);
  border-radius:999px;
  background:#fff;
  text-decoration:none;
  color:var(--text);
  font-weight:800;
  font-size:13px;
}
.topbar .tab.active{background:var(--brown);border-color:var(--brown);color:#fff}

/* Right side actions (avoid .row conflict in sales page) */
.topbar-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
.status-badge{
  display:inline-flex;gap:8px;align-items:center;
  border:1px solid var(--line, #e5e7eb);
  background:#fff;border-radius:12px;padding:6px 10px;font-size:12px
}
.dot{width:10px;height:10px;border-radius:999px;background:#f59e0b}
.dot.ok{background:var(--ok, #16a34a)} .dot.err{background:var(--danger, #ef4444)} .dot.warn{background:#f59e0b}
.whoami{color:var(--muted);font-size:12px;font-weight:700}

/* Button style like admin */
.tb-btn{
  border:1px solid var(--line, #e5e7eb);
  background:#fff;
  border-radius:12px;
  padding:8px 12px;
  cursor:pointer;
  font-weight:800;
  font-size:13px;
}
.tb-btn:hover{transform:translateY(-1px)}
.tb-btn:active{transform:translateY(0)}

@media (max-width:900px){
  .topbar-inner{align-items:flex-start;flex-direction:column}
  .topbar-actions{justify-content:flex-start}
}

</style>
  <link rel="stylesheet" href="./mzj-ui.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

<style>
  /* ===== Sales Safe Refactor: hide legacy topbar ONLY (keep #tabsBar visible) ===== */
  .legacy-sales .topbar,
  .legacy-sales .topbar .tabs,
  .legacy-sales .nav-tabs,
  .legacy-sales .header,
  .legacy-sales header:not(.mzj-topbar){display:none !important;}

  /* Keep content spacing nice */
  .legacy-sales{padding-top: 6px;}
</style>


<style>
  /* Ensure the functional tabs bar (Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨ / ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª) is visible when JS enables it */
  .legacy-sales #tabsBar{ display:flex !important; }
  .legacy-sales #tabsBar[style*="display: none"]{ display:none !important; } /* respect JS when it hides */
</style>

</head>
<body class="mzj">

  <!-- MZJ Unified Topbar -->
  <header class="mzj-topbar">
    <div class="topbar-left">
      <button class="icon-btn" id="mzjSidebarBtn" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"><i class="fa-solid fa-bars"></i></button>
      <div class="brand">
        <div class="brand-mark">MZJ</div>
        <div class="brand-text">
          <div class="brand-title">Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</div>
          <div class="brand-sub">Workspace</div>
        </div>
      </div>
    </div>
    <div class="topbar-center">
      <div class="mzj-breadcrumb">
        <span class="crumb">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        <i class="fa-solid fa-chevron-left"></i>
        <span class="crumb current">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
      </div>
    </div>
    <div class="topbar-right">
      <div class="mzj-chip"><i class="fa-regular fa-clock"></i><span id="mzjNow">â€”</span></div>
      <button id="btnSignOut" class="btn btn-ghost" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>
    </div>
  </header>

  <div class="mzj-shell" id="mzjShell">
    <aside class="mzj-sidebar" id="mzjSidebar">
      <div class="side-section">
        <div class="side-title">ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
        <nav class="side-nav">
          <a class="side-link tab active" href="./sales.html"><i class="fa-solid fa-handshake"></i><span>ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span></a>
          <a class="side-link tab" href="./dashboard.html"><i class="fa-solid fa-gauge"></i><span>Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</span></a>
          <a class="side-link tab" href="./inventory.html"><i class="fa-solid fa-boxes-stacked"></i><span>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span></a>
          <a class="side-link tab" href="./vt.html"><i class="fa-solid fa-right-left"></i><span>Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span></a>
          <a class="side-link tab" href="./photoshoot-user.html"><i class="fa-solid fa-camera"></i><span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span></a>
          <a class="side-link tab" href="./cars.html"><i class="fa-solid fa-car"></i><span>ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span></a>
          <a class="side-link tab" href="./admin.html"><i class="fa-solid fa-shield-halved"></i><span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span></a>
          <a class="side-link tab" href="./Activity.html"><i class="fa-solid fa-clipboard-list"></i><span>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</span></a>

      </div>
    </aside>

    <div class="mzj-backdrop" id="mzjBackdrop"></div>

    <main class="mzj-content">
      <section class="mzj-pagehead">
        <div class="pagehead-left">
          <h1 class="page-title">Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h1>
          <p class="page-desc">Ù†ÙØ³ Ø§Ù„Ø¯Ø§ØªØ§ ÙˆØ§Ù„Ù…Ù†Ø·Ù‚ â€” ÙˆØ§Ø¬Ù‡Ø© Ù…ÙˆØ­Ù‘Ø¯Ø©.</p>
        </div>
      </section>

      <div class="legacy legacy-sales">

  
  <!-- Topbar (Matched with Admin) -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" title="MZJ">MZJ</div>
        <div class="brand-text">
          <h1>Ù„ÙˆØ­Ø© ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h1>
          <small class="hint">Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</small>
        </div>
      </div>

      <div class="tabs">
        <a class="tab" href="admin.html">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
        <a class="tab active" href="sales.html">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</a>
        <a class="tab" href="inventory.html">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</a>
        <a class="tab" href="dashboard.html">Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</a>
        <a class="tab" href="vt.html">Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</a>
        <a class="tab" href="photoshoot-user.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
        <a class="tab" href="cars.html">ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</a>
        <a class="tab" href="Activity.html">Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</a>
      </div>

      <div class="topbar-actions">
        <div class="status-badge">
          <span class="dot warn" id="connDot"></span>
          <span id="connText">â€”</span>
        </div>
        <span id="whoami" class="whoami"></span>
        <button id="logoutBtn" class="tb-btn" style="display:none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>
<div class="wrap">

    <!-- Auth -->
    <div class="card" id="authCard">
      <h3 class="title"><span class="icon">ğŸ”</span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
      <div class="row">
        <div class="col-4">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="email" type="email" placeholder="user@mzjcars.com" />
        </div>
        <div class="col-4">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <div class="col-4" style="display:flex;align-items:flex-end;gap:8px;">
          <button class="btn" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
        </div>
      </div>
      <div id="authMsg" class="muted" style="margin-top:6px;"></div>
      <div class="hint">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ù…Ø±Ø§Ø­Ù„Ù‡Ø§.</div>
    </div>

    <!-- Search -->
    <div class="card" id="orderCard" style="display:none;">
      <h3 class="title"><span class="icon">ğŸ“„</span>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨</h3>
      <div class="row">
        <div class="col-4">
          <label>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</label>
          <input id="orderId" placeholder="SAL-ORD-2025-01109 Ø£Ùˆ SAL-ORD-2025-01109_1" />
        </div>
        <div class="col-4" style="display:none;">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (VIN)</label>
          <input id="vinInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (VIN)" />
        </div>
        <div class="col-4" style="display:flex;align-items:flex-end;gap:8px;">
          <button class="btn" id="loadBtn">ÙØªØ­ Ø§Ù„Ø·Ù„Ø¨</button>
          <button class="btn-outline" id="clearBtn">ØªÙØ±ÙŠØº</button>
        </div>
      </div>
      <div id="orderMsg" class="muted" style="margin-top:6px;"></div>
      <div class="hint">Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø«Ù… Ø§Ø¶ØºØ· ÙØªØ­ Ø§Ù„Ø·Ù„Ø¨.</div>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="tabsBar">
      <button class="tab-btn tab-active" id="tabSearchBtn">Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨</button>
      <button class="tab-btn" id="tabListBtn">ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
    </div>

    <!-- ERP details -->
    <div class="card" id="erpCard" style="display:none;">
      <h3 class="title">
        <span class="icon">ğŸ“Š</span>
        ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (ERP)
      </h3>
      <div id="erpMeta" class="muted" style="margin-bottom:6px;"></div>

      <!-- Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù„Ùˆ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠÙ‡ Ø£ÙƒØ«Ø± Ù…Ù† VIN -->
      <div id="vinPickerBox" class="vin-box">
        <div class="vin-box-header">
          <div class="vin-box-title">Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù„Ù„Ø¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡</div>
          <div class="vin-chip" id="vinCountChip"></div>
        </div>
        <select id="vinPicker"></select>
        <div class="hint">Ø£ÙŠ ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù…Ø±Ø§Ø­Ù„ ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ø³ÙŠÙƒÙˆÙ† Ù„Ù‡Ø°Ø§ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙÙ‚Ø·.</div>
        <button id="trackLinkBtn" class="btn" type="button" style="margin-top:8px;width:100%;">Ø±Ø§Ø¨Ø· Ø§Ù„ØªØªØ¨Ø¹</button>
        <button id="trackQrBtn" class="btn-outline" type="button" style="margin-top:8px;width:100%;">QR Ø§Ù„ØªØªØ¨Ø¹ (Ø§Ø¶ØºØ· Ù„ÙØªØ­)</button>
      </div>

      <div id="erpTotals" class="totals-box" style="display:none;"></div>
      <div class="erp-table-wrap">
        <table>
          <thead>
          <tr>
            <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
            <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„</th>
            <th>Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
            <th>Ø§Ù„ÙØ±Ø¹</th>
            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</th>
            <th>Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
            <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th>
            <th>Ù†ÙˆØ¹ Ø§Ù„ØµÙ†Ù</th>
            <th>ÙØ¦Ø© Ø§Ù„ØµÙ†Ù</th>
            <th>Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ VIN</th>
            <th>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</th>
            <th>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</th>
            <th>Ø§Ù„ÙˆÙƒÙŠÙ„</th>
            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th>Ù‚ÙŠÙ…Ø© Ø§Ù„ØµÙ†Ù</th>
            <th>ÙƒÙˆØ¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
            <th>Ù†ÙˆØ¹ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
            <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
            <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
          </tr>
          </thead>
          <tbody id="erpBody">
          </tbody>
        </table>
      </div>
    </div>

    <!-- Orders list tab -->
    <div class="card" id="ordersListCard" style="display:none;">
      <h3 class="title"><span class="icon">ğŸ“‹</span>ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
      <div class="hint">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ù„ÙØªØ­Ù‡ØŒ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ùˆ ÙƒØ§Ù† Ø£ÙƒØ«Ø± Ù…Ù† Ø³ÙŠØ§Ø±Ø©.</div>
      <div class="row" style="margin-top:10px;">
        <div class="col-6">
          <label>Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</label>
          <input id="ordersSearch" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ / Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ / Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (VIN) / Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨" />
          <div class="hint">ØªÙ‚Ø¯Ø± ØªØ¨Ø­Ø« Ø¨Ø£ÙŠ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>
        </div>
      </div>
      <div class="erp-table-wrap">
        <table>
          <thead>
          <tr>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
            <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</th>
            <th>Ø§Ù„ÙØ±Ø¹</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ VIN</th>
          </tr>
          </thead>
          <tbody id="ordersListBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Stages -->
    <div class="card" id="stagesCard" style="display:none;">
      <h3 class="title"><span class="icon">ğŸš¦</span>Ù…Ø±Ø§Ø­Ù„ ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨</h3>
      <div class="grid-2" id="stagesList"></div>
      <div class="hint" style="margin-top:8px;">
        Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ <strong>ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</strong> Ø£Ù…Ø§Ù… Ø£ÙŠ Ù…Ø±Ø­Ù„Ø© Ù„ÙŠØªÙ… Ø®ØªÙ…Ù‡Ø§ ÙˆØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© ØªØªØ¨Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.  
        Ø¨Ø¹Ø¯ Ø®ØªÙ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.
      </div>
      <div class="muted" id="stageMsg" style="margin-top:6px;"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      deleteField,
      serverTimestamp,
      collection,
      query,
      where,
      getDocs,
      limit,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
      authDomain: "mzj-tracking.firebaseapp.com",
      projectId: "mzj-tracking",
      storageBucket: "mzj-tracking.firebasestorage.app",
      messagingSenderId: "655452217491",
      appId: "1:655452217491:web:9348d172c47bdd411fad66"
    };

    const ERP_COLLECTION      = "erp_orders";
    const ERP_VINS_COLLECTION = "erp_vins";
    const TRACK_COLLECTION    = "orders";

    // âœ… API base (separate project) for WhatsApp/Mersal serverless routes
    const MZJ_TRACKING_API_BASE = window.location.origin; // Ù†ÙØ³ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† (mzj-workflow)

    const ERP_FIELDS = [
      "CustomerName","CustomerVAT","CustomerPhone","Branch","OrderDate","DeliveryDate","SalesPerson",
      "ItemNo","ItemType","ItemCategory","ItemModel","VIN","InteriorColor","ExteriorColor","Dealer",
      "Qty","UnitPrice","ItemValue","TaxCode","TaxName","TaxRate","TaxValue","SubtotalExclVAT","TotalInclVAT"
    ];

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const authCard   = document.getElementById("authCard");
    const orderCard  = document.getElementById("orderCard");
    const erpCard    = document.getElementById("erpCard");
    const stagesCard = document.getElementById("stagesCard");
    const whoami     = document.getElementById("whoami");
    const logoutBtn  = document.getElementById("logoutBtn");

    const tabsBar      = document.getElementById("tabsBar");
    const tabSearchBtn = document.getElementById("tabSearchBtn");
    const tabListBtn   = document.getElementById("tabListBtn");
    const ordersListCard  = document.getElementById("ordersListCard");
    const ordersListBody  = document.getElementById("ordersListBody");

    const ordersSearchInput = document.getElementById("ordersSearch");
    let ordersListCache = [];
    let ordersReadSet = new Set();


    const email      = document.getElementById("email");
    const password   = document.getElementById("password");
    const loginBtn   = document.getElementById("loginBtn");
    const signupBtn  = document.getElementById("signupBtn");
    const authMsg    = document.getElementById("authMsg");

    const orderIdInput = document.getElementById("orderId");
    const vinInput     = document.getElementById("vinInput");
    const loadBtn      = document.getElementById("loadBtn");
    const clearBtn     = document.getElementById("clearBtn");
    const orderMsg     = document.getElementById("orderMsg");

    const erpMetaEl    = document.getElementById("erpMeta");
    const erpBody      = document.getElementById("erpBody");
    const erpTotals    = document.getElementById("erpTotals");

    const vinPickerBox = document.getElementById("vinPickerBox");
    const vinPicker    = document.getElementById("vinPicker");
    const vinCountChip = document.getElementById("vinCountChip");
    const trackLinkBtn = document.getElementById("trackLinkBtn");

    const stagesList   = document.getElementById("stagesList");
    const stageMsg     = document.getElementById("stageMsg");

    let currentOrderId      = null;
    let currentVin          = null;
    let currentItemNo       = null;
    let currentOrderRecords = [];
    let currentCustomerPhone = ""; // Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„
    // Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø­ØªØ§Ø¬Ù‡Ø§ Ù„Ù‚Ø§Ù„Ø¨ ÙˆØ§ØªØ³Ø§Ø¨ (tracking_message)
    let currentCustomerName = "";
    let currentOrderCarsCount = 0;
    let currentCarsSubtotal = "";
    let currentCarsTax = "";
    let currentRegFee = "";
    let currentGrandTotalIncl = "";
    let currentTrackingLink = "";

    let currentTrackData = null;
    let currentStagesObjCache = {};

    const STAGES = [
      "1) Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "2) Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¯ÙØ¹ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "3) Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ù† Ù‚ÙØ¨Ù„ Ù…Ù…Ø«Ù„ÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø±ÙƒÙŠØ© (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
      "4) Ø³Ø¯Ø§Ø¯ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "5) Ø§Ù„ØªØ£Ù…ÙŠÙ† â€“ Ø´Ø±Ø· Ø§Ù„Ø±Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ³ØªÙ… (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "6) Ø§Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "7) Ø§Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© (Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„)",
      "8) Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø£Ùˆ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ© (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
      "9) Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù… (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶)",
      "10) Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­"
    ];

    const FIELD_SYNONYMS = {
      CustomerName: ["CustomerName","customerName"],
      CustomerVAT:  ["CustomerVAT","customerVat","customerVAT"],
      CustomerPhone:["CustomerPhone","customerPhone","customer_phone","contact_mobile"],
      Branch:       ["Branch","branch"],
      OrderDate:    ["OrderDate","orderDate"],
      DeliveryDate: ["DeliveryDate","deliveryDate"],
      SalesPerson:  ["SalesPerson","salesPerson"],

      ItemNo:       ["ItemNo","itemNo","no"],
      ItemType:     ["ItemType","itemType","type"],
      ItemCategory: ["ItemCategory","itemCategory","category"],
      ItemModel:    ["ItemModel","itemModel","model"],

      VIN:          ["VIN","vin"],

      InteriorColor:["InteriorColor","interiorColor"],
      ExteriorColor:["ExteriorColor","exteriorColor"],
      Dealer:       ["Dealer","dealer"],

      Qty:          ["Qty","qty"],
      UnitPrice:    ["UnitPrice","unitPrice"],
      ItemValue:    ["ItemValue","itemValue","value"],

      TaxCode:         ["taxCode","TaxCode"],
      TaxName:         ["taxName","TaxName"],
      TaxRate:         ["taxRate","TaxRate","vatRate","VATRate","tax_rate","vat_rate","rate","VAT"],
      TaxValue:        ["taxValue", "TaxValue", "vatAmount", "VATAmount", "vat_amount", "vatAmount", "vatValue", "VATValue", "tax_amount", "taxAmount", "taxValueAmount", "vat", "carTaxValue", "car_tax_value"],
      SubtotalExclVAT: ["subtotalExclVAT", "SubtotalExclVAT", "subtotalExclVat", "subtotal_excl_vat", "subtotalBeforeVat", "SubtotalBeforeVat", "netTotal", "net_total", "amountBeforeTax", "amount_before_tax", "subtotal", "net", "carSubtotalExclVAT", "car_subtotal_excl_vat"],
      TotalInclVAT:    ["totalInclVAT", "TotalInclVAT", "totalInclVat", "total_incl_vat", "grandTotal", "GrandTotal", "grand_total", "total", "Total", "amountAfterTax", "amount_after_tax", "carTotalInclVAT", "car_total_incl_vat"],

      // âœ… Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø·Ù„Ø¨ (Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„/Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨)
      RegistrationFee: ["registrationFee","RegistrationFee"],
      SubtotalBeforeTax:["subtotalBeforeTax","SubtotalBeforeTax"],
      GrandTotal:      ["grandTotal","GrandTotal"]
    };

    function buildCandidates(name) {
      const syns = FIELD_SYNONYMS[name] || [name];
      const arr = [];
      syns.forEach(s => {
        if (!s) return;
        arr.push(s);
        arr.push(s.toLowerCase());
        arr.push(s.toUpperCase());
      });
      return Array.from(new Set(arr));
    }

    function lookupIn(obj, candidates) {
      if (!obj) return undefined;
      for (const key of candidates) {
        if (Object.prototype.hasOwnProperty.call(obj, key) && obj[key] !== undefined) {
          return obj[key];
        }
      }
      return undefined;
    }

    function getFieldFlex(fieldName, data) {
      if (!data) return "-";
      const candidates = buildCandidates(fieldName);

      let v = lookupIn(data, candidates);
      if (v !== undefined) return v;

      v = lookupIn(data.item, candidates);
      if (v !== undefined) return v;

      v = lookupIn(data.totals, candidates);
      if (v !== undefined) return v;

      // âœ… Ø¯Ø¹Ù… Ù…Ø®Ø·Ø·Ø§Øª Ø£Ù‚Ø¯Ù…: Ø¨Ø¹Ø¶ Ø§Ù„Ø¯Ø§ØªØ§ Ø¨ØªÙƒÙˆÙ† ØªØ­Øª taxes Ø£Ùˆ summary
      v = lookupIn(data.taxes, candidates);
      if (v !== undefined) return v;

      v = lookupIn(data.summary, candidates);
      if (v !== undefined) return v;

      return "-";
    }

    function parseAmountFront(value) {
      if (value === null || value === undefined || value === "-") return null;
      if (typeof value === "number") return value;
      const s = String(value)
        .replace(/[^\d.,\-]/g, "")
        .replace(/,/g, "");
      const n = parseFloat(s);
      return isNaN(n) ? null : n;
    }

    
    // ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„ØµÙŠØºØ© Ø³Ø¹ÙˆØ¯ÙŠØ© 966
        function normalizeSaudiPhone(raw) {
      if (!raw) return "";

      let digits = String(raw).trim();

      // Ø´ÙŠÙ„ Ø£ÙŠ Ø­Ø§Ø¬Ø© ØºÙŠØ± Ø£Ø±Ù‚Ø§Ù…
      digits = digits.replace(/[^\d]/g, "");

      // 009665xxxxxxxx â†’ 9665xxxxxxxx
      if (digits.startsWith("00")) {
        digits = digits.slice(2);
      }

      // 05xxxxxxxx â†’ 9665xxxxxxxx
      if (digits.startsWith("05")) {
        digits = "966" + digits.slice(1);
      }

      // 5xxxxxxxx â†’ 9665xxxxxxxx
      if (digits.length === 9 && digits.startsWith("5")) {
        digits = "966" + digits;
      }

      // ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ
      if (!digits.startsWith("9665") || digits.length !== 12) {
        return "";
      }

      return digits;
    }

    
    // ===== Message Templates (shared for SMS + WhatsApp) =====
    function getDefaultStageMessage(stageNum, stageLabel){
      const orderNo = currentOrderId || "";
      const vin = currentVin || "";
      const trackingLink = vin ? `https://mzj-tracking.vercel.app/Test-Track.html?vin=${vin}` : "";

      switch(stageNum){
        case 1: {
          // âœ… Ø±Ø³Ø§Ù„Ø© Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨ (Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨) â€” Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙŠØ§Ø±Ø© ÙØ±Ø¯ÙŠØ©
          const rec0 = (currentOrderRecords && currentOrderRecords.length) ? currentOrderRecords[0] : {};
          const customerName = getFieldFlex("CustomerName", rec0) || "";

          // VIN Ø§Ù„Ù…Ø®ØªØ§Ø± ÙÙ‚Ø· Ù„Ù„Ø±Ø§Ø¨Ø· (Ù†Ù‚Ø·Ø© Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªØªØ¨Ø¹)
          const vinForLink = vin || "";
          const trackingLink2 = vinForLink ? `https://mzj-tracking.vercel.app/Test-Track.html?vin=${vinForLink}` : "";

          // Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨)
          const regFeeNum = (() => {
            const v = getFieldFlex("RegistrationFee", rec0);
            const n = parseAmountFront(v);
            return (n !== null && n > 0) ? n : 0;
          })();

          const rows = (currentOrderRecords && currentOrderRecords.length) ? currentOrderRecords : [];
          const totalCars = rows.length || 0;

          let carsSubtotal = 0;
          let carsTax = 0;

          rows.forEach(r => {
            const subVal = parseAmountFront(getFieldFlex("SubtotalExclVAT", r));
            const taxVal = parseAmountFront(getFieldFlex("TaxValue", r));
            if (subVal !== null) carsSubtotal += subVal;
            if (taxVal !== null) carsTax += taxVal;
          });

          // fallback Ù„Ùˆ Ø§Ù„Ø³Ø·ÙˆØ± Ù…Ø´ ÙƒØ§Ù…Ù„Ø©
          if (carsSubtotal === 0 && carsTax === 0) {
            const headerSubBT = parseAmountFront(getFieldFlex("SubtotalBeforeTax", rec0));
            const headerTax   = parseAmountFront(getFieldFlex("TaxValue", rec0));
            if (headerSubBT !== null) carsSubtotal = Math.max(0, (headerSubBT || 0) - (regFeeNum || 0));
            if (headerTax !== null)   carsTax = headerTax || 0;
          }

          const grandTotalIncl = (carsSubtotal + carsTax) + (regFeeNum || 0);

          const fmt = (n) => (n || 0).toLocaleString("ar-SA", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

          // âœ… ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚ÙŠÙ… Ù„Ù„Ù‚Ø§Ù„Ø¨ (tracking_message)
          currentCustomerName = customerName || "";
          currentOrderCarsCount = totalCars || 0;
          currentCarsSubtotal = fmt(carsSubtotal);
          currentCarsTax = fmt(carsTax);
          currentRegFee = fmt(regFeeNum || 0);
          currentGrandTotalIncl = fmt(grandTotalIncl);
          currentTrackingLink = trackingLink2 || "";

          return (
`Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ² / ${customerName}\n` +
`Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª\n\n` +
`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¦ÙƒÙ… Ø¨Ù†Ø¬Ø§Ø­ âœ…\n\n` +
`Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª: ${totalCars}\n` +
`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${fmt(carsSubtotal)} Ø±.Ø³\n` +
`Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${fmt(carsTax)} Ø±.Ø³\n` +
(regFeeNum > 0 ? (`Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ${fmt(regFeeNum)} Ø±.Ø³\n`) : ``) +
`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${fmt(grandTotalIncl)} Ø±.Ø³\n\n` +
`ÙŠÙ…ÙƒÙ†ÙƒÙ… Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ:\n` +
`${trackingLink2}\n\n` +
`Ù…Ø¹ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª\n` +
`Ø£Ù†Øª Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚ â­\n` +
`ğŸ“ 920014635`

          );
        }
        case 9:
          return (
`Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ² ÙŠØ³Ø¹Ø¯Ù†Ø§ Ø¥Ø¨Ù„Ø§ØºÙƒ Ø¨Ø¬Ø§Ù‡Ø²ÙŠØ© Ø³ÙŠØ§Ø±ØªÙƒØŒ
Ø§Ù„Ø¢Ù† ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ¬Ù‡ Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø£Ùˆ Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø© Ø§Ù„Ø´Ø­Ù†.

Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„:
*Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØµØ¨Ø§Ø­ÙŠØ©*
Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 9 ØµØ¨Ø§Ø­Ø§Ù‹ Ø¥Ù„Ù‰ 11 ØµØ¨Ø§Ø­Ø§Ù‹
Ø¹Ø¯Ø§ ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø©

*Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø³Ø§Ø¦ÙŠØ©*
Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 4 Ù…Ø³Ø§Ø¡Ù‹ Ø¥Ù„Ù‰ 9 Ù…Ø³Ø§Ø¡Ù‹
Ø¬Ù…ÙŠØ¹ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹

Ù…Ø¹ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª
Ø£Ù†Øª Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚ â­

ğŸ“ 920014635`

          );
        case 10:
          return (`Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ²
` +
`Ù†Ø¨Ø§Ø±Ùƒ Ù„ÙƒÙ… Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­

` +
`*Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ… ÙˆÙ†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ù‚ÙŠØ§Ø¯Ø© Ø¢Ù…Ù†Ø© ÙˆØªØ¬Ø±Ø¨Ø© Ù…Ù…ØªØ¹Ø©*

` +
`Ù…Ø¹ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª
` +
`Ø£Ù†Øª Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚ â­

` +
`ğŸ“ 920014635`

          );

        default:
          return `Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ²ØŒ Ø¨Ø®ØµÙˆØµ Ø·Ù„Ø¨ÙƒÙ… Ø±Ù‚Ù… ${orderNo}.\nÙ…Ø¹Ø±Ø¶ Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª.`;
      }
    }

    // ===== Modal: Edit before send =====
    const msgModal        = document.getElementById("msgModal");
    const msgModalBackdrop= document.getElementById("msgModalBackdrop");
    const msgModalClose   = document.getElementById("msgModalClose");
    const msgModalTitle   = document.getElementById("msgModalTitle");
    const msgModalSub     = document.getElementById("msgModalSub");
    const msgModalText    = document.getElementById("msgModalText");
    const msgModalSend    = document.getElementById("msgModalSend");
    const msgModalReset   = document.getElementById("msgModalReset");
    const msgModalCopy    = document.getElementById("msgModalCopy");
    const msgModalMsg     = document.getElementById("msgModalMsg");
    const msgModalChannel = document.getElementById("msgModalChannel");
    const msgModalPhone   = document.getElementById("msgModalPhone");
    const msgModalVin     = document.getElementById("msgModalVin");

    let modalCtx = { channel:"sms", stageNum:0, stageLabel:"", defaultText:"" };

    function closeMessageModal(){
      if(!msgModal) return;
      msgModal.style.display = "none";
      msgModalMsg.textContent = "";
      msgModalSend.disabled = false;
    }
    function openMessageModal(channel, stageNum, stageLabel){
      stageMsg.textContent = "";
      if (!currentCustomerPhone) {
        stageMsg.innerHTML = "<span class='err'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ù…Ø­ÙÙˆØ¸ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.</span>";
        return;
      }
      const phone = normalizeSaudiPhone(currentCustomerPhone);
      if (!phone) {
        stageMsg.innerHTML = "<span class='err'>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ØºÙŠØ± ØµØ§Ù„Ø­.</span>";
        return;
      }

      const defText = getDefaultStageMessage(stageNum, stageLabel);

      modalCtx = { channel, stageNum, stageLabel, defaultText: defText };

      msgModalTitle.textContent = (channel === "whatsapp") ? "Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„" : "Ø¥Ø±Ø³Ø§Ù„ SMS Ù„Ù„Ø¹Ù…ÙŠÙ„";
      msgModalSub.textContent = `Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${stageNum}: ${stageLabel || ""}`;
      msgModalText.value = defText;

      msgModalChannel.textContent = (channel === "whatsapp") ? "WhatsApp" : "SMS";
      msgModalPhone.textContent = phone ? ("966â€¦" + phone.slice(-3)) : "â€”";
      msgModalVin.textContent = (currentVin ? ("VIN: " + currentVin) : "VIN: â€”");

      msgModal.style.display = "block";
      setTimeout(() => msgModalText.focus(), 50);
    }

    if (msgModalBackdrop) msgModalBackdrop.addEventListener("click", closeMessageModal);
    if (msgModalClose) msgModalClose.addEventListener("click", closeMessageModal);

    if (msgModalReset) msgModalReset.addEventListener("click", () => {
      msgModalText.value = modalCtx.defaultText || "";
      msgModalMsg.innerHTML = "<span class='muted'>ØªÙ… Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ.</span>";
      setTimeout(()=> msgModalMsg.textContent="", 1200);
    });

    if (msgModalCopy) msgModalCopy.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(msgModalText.value || "");
        msgModalMsg.innerHTML = "<span class='ok'>ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ.</span>";
      }catch(e){
        msgModalMsg.innerHTML = "<span class='err'>ØªØ¹Ø°Ø± Ù†Ø³Ø® Ø§Ù„Ù†Øµ.</span>";
      }
      setTimeout(()=> msgModalMsg.textContent="", 1200);
    });

    async function sendWhatsAppFreeText(phone, text, stageNum){
      // âœ… Send via Mersal WhatsApp API (server-side in mzj-tracking project)
      return fetch(`${MZJ_TRACKING_API_BASE}/api/mersal-wa`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          phone: String(phone || "").trim(),     // must be like 9665xxxxxxxx
          message: String(text || ""),
          stageNum: stageNum ?? null,
          orderId: window.__mzj_current_order_id || ""
        })
      }).then(async (res)=>{
        const bodyText = await res.text();
        if(!res.ok) throw new Error(bodyText || ("HTTP " + res.status));
        try { return JSON.parse(bodyText); } catch { return { ok:true, raw: bodyText }; }
      });
    }

    async function sendWhatsAppTemplate(phone, templateName, templateLanguage, bodyParams, stageNum){
      // âœ… Template-based WhatsApp message via mzj-tracking project
      // Expects a serverless route: /api/mersal-wa-template
      return fetch(`${MZJ_TRACKING_API_BASE}/api/mersal-wa-template`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          phone: String(phone || "").trim(),
          template_name: String(templateName || "").trim(),
          template_language: String(templateLanguage || "ar").trim(),
          body_params: Array.isArray(bodyParams) ? bodyParams : [],
          stageNum: stageNum ?? null,
          orderId: window.__mzj_current_order_id || ""
        })
      }).then(async (res)=>{
        const bodyText = await res.text();
        if(!res.ok) throw new Error(bodyText || ("HTTP " + res.status));
        try { return JSON.parse(bodyText); } catch { return { ok:true, raw: bodyText }; }
      });
    }

    

    // Direct send for Step 1 ONLY (same logic as send temp bay ajax.html)
    // NOTE: Token is embedded client-side by request.
    const MERSAL_DIRECT_TOKEN_STEP1 = "N47Nm9eP20Ppctd3RmM6EBiM5b7dAaoljMHVJyns16b42721";

    async function sendWhatsAppTemplateDirectStep1(phone, bodyParams){
      return fetch("https://w-mersal.com/api/wpbox/sendtemplatemessage", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          token: MERSAL_DIRECT_TOKEN_STEP1,
          phone: String(phone || "").trim(),
          template_name: "tracking_message",
          template_language: "ar",
          components: [
            {
              type: "body",
              parameters: (Array.isArray(bodyParams) ? bodyParams : []).map(v => ({
                type: "text",
                text: String(v ?? "")
              }))
            }
          ]
        })
      }).then(async (res)=>{
        const bodyText = await res.text();
        if(!res.ok) throw new Error(bodyText || ("HTTP " + res.status));
        try { return JSON.parse(bodyText); } catch { return ({ ok:true, raw: bodyText }); }
      });
    }
function toEnglishDigits(str) {
      return String(str)
        .replace(/[Ù -Ù©]/g, d => "0123456789"["Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d)])
        .replace(/[Ù¬]/g, ",")
        .replace(/[Ù«]/g, ".")
        .replace(/\u00A0/g, " ");
    }
    function safeParam(v, fallback = "0"){
      const s = (v === null || v === undefined) ? "" : String(v);
      const cleaned = toEnglishDigits(s).trim();
      return cleaned ? cleaned : fallback;
    }

    function buildTrackingTemplateParams(){
      // mapping for template tracking_message: {{1}}..{{7}}
      const customerName = safeParam((currentCustomerName || "").trim(), "Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ²");
      const totalCars    = safeParam(currentOrderCarsCount, "0");
      const subtotal     = safeParam(currentCarsSubtotal, "0");
      const tax          = safeParam(currentCarsTax, "0");
      const regFee       = safeParam(currentRegFee, "0"); // âœ… Ù…Ù…Ù†ÙˆØ¹ ÙŠØ¨Ù‚Ù‰ ÙØ§Ø¶ÙŠ
      const totalIncl    = safeParam(currentGrandTotalIncl, "0");
      const trackingLink = safeParam(currentTrackingLink, "https://mzj-tracking.vercel.app/");

      return [customerName, totalCars, subtotal, tax, regFee, totalIncl, trackingLink];
    }

    async function sendWhatsAppMessage(phone, text, stageNum){
      // âœ… Stage 1/9/10 = Ù‚ÙˆØ§Ù„Ø¨ ÙˆØ§ØªØ³Ø§Ø¨ (Templates) â€” Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ù†Øµ Ø­Ø±
      const st = Number(stageNum);

      if (st === 1){
        const params = buildTrackingTemplateParams();
        // Step 1 uses direct Mersal send (to fix delivery)
        return sendWhatsAppTemplateDirectStep1(phone, params);
      }

      if (st === 9){
        // Ù‚Ø§Ù„Ø¨: Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØ³Ù„ÙŠÙ…
        return sendWhatsAppTemplate(phone, "mzj_car_ready_delivery", "ar", [], st);
      }

      if (st === 10){
        // Ù‚Ø§Ù„Ø¨: ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…
        return sendWhatsAppTemplate(phone, "mzj_delivery_completed", "ar", [], st);
      }

      return sendWhatsAppFreeText(phone, text, st);
    }


    if (msgModalSend) msgModalSend.addEventListener("click", async () => {
      msgModalMsg.textContent = "";
      msgModalSend.disabled = true;

      const phone = normalizeSaudiPhone(currentCustomerPhone);
      const msg = (msgModalText.value || "").trim();

      try{
        if (modalCtx.channel === "whatsapp") {
          await sendWhatsAppMessage(phone, msg, modalCtx.stageNum);
          msgModalMsg.innerHTML = "<span class='ok'>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ­Ø¯ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ API.</span>";
        } else {
          await sendStcSmsForStage(modalCtx.stageNum, modalCtx.stageLabel, msg);
          // sendStcSmsForStage writes to stageMsg; mirror here too:
          msgModalMsg.innerHTML = "<span class='ok'>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ SMS (Ø£Ùˆ ØªÙ… ØªÙ†ÙÙŠØ° Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„).</span>";
        }
      }catch(e){
        console.error(e);
        msgModalMsg.innerHTML = "<span class='err'>Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + String(e && (e.message||e)).slice(0,180) + "</span>";
      }finally{
        msgModalSend.disabled = false;
      }
    });

    // ===== Dynamic QR (click to open tracking) =====
    const trackQrBtn = document.getElementById("trackQrBtn");
    const trackQrModal = document.getElementById("trackQrModal");
    const trackQrBackdrop = document.getElementById("trackQrBackdrop");
    const trackQrClose = document.getElementById("trackQrClose");
    const trackQrImg = document.getElementById("trackQrImg");
    const trackQrLink = document.getElementById("trackQrLink");
    const trackQrCopy = document.getElementById("trackQrCopy");

    function getTrackingUrl(){
      return currentVin ? `https://mzj-tracking.vercel.app/Test-Track.html?vin=${encodeURIComponent(currentVin)}` : "";
    }

    function refreshTrackingQr(){
      const url = getTrackingUrl();
      if(!trackQrImg || !trackQrLink) return;

      if(!url){
        trackQrImg.src = "";
        trackQrLink.href = "#";
        trackQrImg.style.opacity = .4;
        return;
      }

      // Use a reliable QR image endpoint (no library needed)
      const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=" + encodeURIComponent(url);
      trackQrImg.src = qrUrl;
      trackQrLink.href = url;
      trackQrImg.style.opacity = 1;
    }

    function openTrackQr(){
      if(!currentVin){
        alert("Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      refreshTrackingQr();
      if(trackQrModal) trackQrModal.style.display = "block";
    }
    function closeTrackQr(){
      if(trackQrModal) trackQrModal.style.display = "none";
    }

    if (trackQrBtn) trackQrBtn.addEventListener("click", openTrackQr);
    if (trackQrBackdrop) trackQrBackdrop.addEventListener("click", closeTrackQr);
    if (trackQrClose) trackQrClose.addEventListener("click", closeTrackQr);

    if (trackQrCopy) trackQrCopy.addEventListener("click", async () => {
      const url = getTrackingUrl();
      if(!url) return;
      try{
        await navigator.clipboard.writeText(url);
        alert("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØªØªØ¨Ø¹");
      }catch(e){
        alert("ØªØ¹Ø°Ø± Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·");
      }
    });


    // Ø¥Ø±Ø³Ø§Ù„ SMS Ø¹Ø¨Ø± endpoint /api/stc-sms
   async function sendStcSmsForStage(stageNum, stageLabel, messageOverride=null) {
  stageMsg.textContent = "";

  if (!currentCustomerPhone) {
    stageMsg.innerHTML = "<span class='err'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ù…Ø­ÙÙˆØ¸ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.</span>";
    return;
  }

  const phone = normalizeSaudiPhone(currentCustomerPhone);
  if (!phone) {
    stageMsg.innerHTML = "<span class='err'>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ØºÙŠØ± ØµØ§Ù„Ø­.</span>";
    return;
  }

  const orderNo = currentOrderId || "";
  const vin = currentVin || "";
  const trackingLink = vin ? `https://mzj-tracking.vercel.app/Test-Track.html?vin=${vin}` : "";

  let text = "";

  switch (stageNum) {

    // -------------------------
    // 1ï¸âƒ£ Ø§Ù„Ø®Ø·ÙˆØ© Ø±Ù‚Ù… 1 â€” ØªÙ‡Ù†Ø¦Ø© + Ø±Ø§Ø¨Ø· Ø§Ù„ØªØªØ¨Ø¹
    // -------------------------
    case 1: {
      // âœ… Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© = Ù„Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø± ÙÙ‚Ø· (Ù…Ø´ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨)
      const rec = (currentOrderRecords && currentOrderRecords.length)
        ? (currentOrderRecords.find(r => String(getFieldFlex("VIN", r) || "").trim() === String(vin || "").trim()) || currentOrderRecords[0])
        : {};

      const customerName = getFieldFlex("CustomerName", rec) || "";
      const carName = getFieldFlex("ItemType", rec) || "";
      const carType = getFieldFlex("ItemCategory", rec) || "";

      const sub = parseAmountFront(getFieldFlex("SubtotalExclVAT", rec));
      const itemVal = parseAmountFront(getFieldFlex("ItemValue", rec));
      const tax = parseAmountFront(getFieldFlex("TaxValue", rec));

      const base = (sub !== null ? sub : (itemVal !== null ? itemVal : null));
      const lineTotalNum = (base !== null ? (base + (tax || 0)) : null);

      const amountStr = (lineTotalNum !== null)
        ? lineTotalNum.toLocaleString("ar-SA", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " Ø±.Ø³"
        : "";

      text =
        `Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ² / ${customerName}\n` +
        `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù…Ø¹Ø±Ø¶ Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª\n\n` +
        `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¦Ùƒ Ø¨Ù†Ø¬Ø§Ø­ \n\n` +
        `*Ù„Ù„Ø³ÙŠØ§Ø±Ø©* ${carName}\n` +
        `Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© : ${carType}\n` +
        `Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ : ${vin}\n` +
        `Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© : ${amountStr}\n\n` +
        `ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ: \n${trackingLink}\n\n` +
        `#Ù…Ø¹_#Ù…Ø¹Ø±Ø¶ #Ù…Ø­Ù…Ø¯ #Ø¨Ù† #Ø°Ø¹Ø§Ø± #Ø§Ù„Ø¹Ø¬Ù…ÙŠ #Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª â€¦ #Ø£Ù†Øª #Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚`;
      break;
    }
    case 9:
      text =
        `Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ² ÙŠØ³Ø¹Ø¯Ù†Ø§ Ø§Ø¨Ù„Ø§ØºÙƒ Ø¨Ø¬Ø§Ù‡Ø²ÙŠØ© Ø³ÙŠØ§Ø±ØªÙƒ Ø§Ù„Ø£Ù† ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ùˆ Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø© Ø§Ù„Ø´Ø­Ù†. 

` +
        `Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„: 
` +
        `*Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØµØ¨Ø§Ø­ÙŠØ©*
` +
        `Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 9 ØµØ¨Ø§Ø­Ø§Ù‹ Ø§Ù„Ù‰ 11 Ù…Ø³Ø§Ø¡ 
` +
        `Ø¹Ø¯Ø§ ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø©

` +
        `*Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø³Ø§Ø¦ÙŠØ©* 
` +
        `Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 4 Ù…Ø³Ø§Ø¡ Ø§Ù„Ù‰ 9 Ù…Ø³Ø§Ø¡ 
` +
        `Ø¬Ù…ÙŠØ¹ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 

` +
        `#Ù…Ø¹_#Ù…Ø¹Ø±Ø¶ #Ù…Ø­Ù…Ø¯ #Ø¨Ù† #Ø°Ø¹Ø§Ø± #Ø§Ù„Ø¹Ø¬Ù…ÙŠ #Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª â€¦ #Ø£Ù†Øª #Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚`;
      break;
// -------------------------
    // ğŸ”Ÿ Ø§Ù„Ø®Ø·ÙˆØ© Ø±Ù‚Ù… 10 â€” Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ³Ù„ÙŠÙ…
    // -------------------------
    case 10:
      text =
        `Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ² 
` +
        `Ù†Ø¨Ø§Ø±Ùƒ Ù„ÙƒÙ… Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­ 

` +
        `*Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ… Ùˆ Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ù‚ÙŠØ§Ø¯Ø© Ø¢Ù…Ù†Ø© ÙˆØªØ¬Ø±Ø¨Ø© Ù…Ù…ØªØ¹Ø©*

` +
        `#Ù…Ø¹_#Ù…Ø¹Ø±Ø¶ #Ù…Ø­Ù…Ø¯ #Ø¨Ù† #Ø°Ø¹Ø§Ø± #Ø§Ù„Ø¹Ø¬Ù…ÙŠ #Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª â€¦ #Ø£Ù†Øª #Ù†Ø¬Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚`;
      break;


    // -------------------------
    // ÙÙŠ Ø­Ø§Ù„ ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø®Ø·ÙˆØ© ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„Ø©
    // -------------------------
    default:
      text =
        `Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ²ØŒ Ø¨Ø®ØµÙˆØµ Ø·Ù„Ø¨ÙƒÙ… Ø±Ù‚Ù… ${orderNo}.\n` +
        `Ù…Ø¹Ø±Ø¶ Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª.`;
  }

  if (messageOverride && String(messageOverride).trim()) {
    text = String(messageOverride);
  }

  try {
    const res = await fetch("/api/stc-sms", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ phone, message: text, orderNo, stageNum })
    });

    if (!res.ok) {
      const errText = await res.text();
      console.error("SMS API error:", errText);
      throw new Error(errText || "SMS API failed");
    }

    stageMsg.innerHTML = "<span class='ok'>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© SMS Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.</span>";
  } catch (err) {
    console.error(err);
    stageMsg.innerHTML =
      "<span class='err'>ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© SMSØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª STC Ø£Ùˆ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„ØªÙ‚Ù†ÙŠ.</span>";
  }
}


function clearErpTable() {
      erpMetaEl.textContent = "";
      erpBody.innerHTML = "";
      erpTotals.style.display = "none";
      erpTotals.innerHTML = "";
      vinPickerBox.style.display = "none";
      vinPicker.innerHTML = "";
      vinCountChip.textContent = "";
    }

    function resolveItemNoForVin(vin, records){
      if (!records || !records.length) return 1;
      let itemNo = null;

      if (vin) {
        const matched = records.find(r => {
          const v = (getFieldFlex("VIN", r) || "").toString().trim();
          return v && v === vin.toString().trim();
        });
        if (matched) {
          itemNo = getFieldFlex("ItemNo", matched);
        }
      }

      if (itemNo === null || itemNo === "-" || itemNo === "") {
        const first = records[0] || null;
        if (first) itemNo = getFieldFlex("ItemNo", first);
      }

      const parsed = parseInt(itemNo, 10);
      return (!isNaN(parsed) && parsed > 0) ? parsed : 1;
    }

    function fillErpTable(records, preferredVin = ""){
      if (!records || !records.length) {
        erpCard.style.display = "none";
        clearErpTable();
        return;
      }
      erpCard.style.display = "";
      clearErpTable();

      // Ù†Ø­ØªÙØ¸ Ø¨Ù†Ø³Ø®Ø© Ù…Ù† Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙÙ‚Ø·
      currentOrderRecords = records.slice();

      const first = records[0] || {};
      const orderNo = first.orderNo || first.OrderNo || currentOrderId || "";
      currentCustomerPhone = getFieldFlex("CustomerPhone", first) || "";
      let vinBadgeLabel = "";

      // âœ… VINs (Ù†Ù‡Ù…Ù„ '-' Ùˆ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ§Ø±ØºØ©)
      const vins = Array.from(new Set(
        records
          .map(r => (getFieldFlex("VIN", r) || "").toString().trim())
          .filter(v => v && v !== "-" && v !== "â€”")
      ));

      if (vins.length === 1) {
        vinBadgeLabel = "VIN: " + vins[0];
      } else if (vins.length > 1) {
        vinBadgeLabel = "Ø£ÙƒØ«Ø± Ù…Ù† Ù‡ÙŠÙƒÙ„ (" + vins.length + ")";
      } else {
        vinBadgeLabel = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ VIN ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
      }

      erpMetaEl.innerHTML =
        '<span class="badge">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ' + (orderNo || "ØºÙŠØ± Ù…ØªÙˆÙØ±") + '</span>' +
        '<span class="badge">' + vinBadgeLabel + '</span>';

      // ===== Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ù‚Ø¯ ØªÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ø·Ù„Ø¨ Ø­ØªÙ‰ Ù„Ùˆ ÙÙŠÙ‡ Ù‡ÙŠÙƒÙ„ ÙˆØ§Ø­Ø¯) =====
      const regFeeNum = (() => {
        const v = getFieldFlex("RegistrationFee", first);
        const n = parseAmountFront(v);
        return (n !== null && n > 0) ? n : 0;
      })();

      // âœ… Ù†Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø³ÙŠØ§Ø±Ø§Øª ÙÙ‚Ø· (Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ØªØ¸Ù‡Ø± Ø£Ø¹Ù„Ù‰ ÙÙŠ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª)
      const totalCars = records.length;
      const displayRecords = records.slice();

      // ØªØ¹Ø¨Ø¦Ø© Ø¬Ø¯ÙˆÙ„ ERP
      displayRecords.forEach(rec => {
        const tr = document.createElement("tr");
        ERP_FIELDS.forEach(field => {
          const td = document.createElement("td");
          let val = getFieldFlex(field, rec);

          // âœ… Ùallback + ØªØµØ­ÙŠØ­: Ø¨Ø¹Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØªØ±Ø¬Ø¹ TotalInclVAT Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø·Ù„Ø¨ ÙˆØªÙƒØ±Ø±Ù‡ Ø¨ÙƒÙ„ Ø³Ø·Ø±
          // Ù‡Ù†Ø§ Ù†ÙØ¬Ø¨Ø±Ù‡ ÙŠÙƒÙˆÙ† "Ù„ÙƒÙ„ Ù‡ÙŠÙƒÙ„" = (Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© + Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©) + (Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ã· Ø¹Ø¯Ø¯ Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„)
          if (field === "TotalInclVAT") {
            const _sub = parseAmountFront(getFieldFlex("SubtotalExclVAT", rec));
            const _tax = parseAmountFront(getFieldFlex("TaxValue", rec));
            const computed = (_sub || 0) + (_tax || 0);

            const perReg = (regFeeNum > 0 && totalCars > 0) ? (regFeeNum / totalCars) : 0;
            const computedPerLine = computed + perReg;

            // Ù„Ùˆ Ø¹Ù†Ø¯Ù†Ø§ subtotal/tax â€” Ø§Ø¹ØªÙ…Ø¯ Ø§Ù„Ø­Ø³Ø¨Ø© Ø¯ÙŠ Ø¯Ø§Ø¦Ù…Ù‹Ø§ (Ø®ØµÙˆØµÙ‹Ø§ Ù„Ùˆ Ø§Ù„Ø·Ù„Ø¨ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„)
            if (computed > 0) {
              val = computedPerLine;
            } else {
              // fallback Ù„Ùˆ Ù…ÙÙŠØ´ subtotal/tax
              const numRaw = parseAmountFront(val);
              if (numRaw === null || numRaw === 0) {
                val = null;
              }
            }
          }

          if (field === "TaxRate") {
            const num = parseAmountFront(val);
            let pc = num !== null ? (num <= 1 ? num * 100 : num) : 15;
            const pcStr = pc.toString().replace(/\.0+$/, "");
            val = pcStr + " %";
          } else if (field === "TotalInclVAT" || field === "TaxValue" || field === "SubtotalExclVAT") {
            const num = parseAmountFront(val);
            if (num !== null) {
              val = num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " Ø±.Ø³";
            }
          }

          td.textContent = val;
          tr.appendChild(td);
        });
        erpBody.appendChild(tr);
      });

      // Ø¥Ø¯Ø§Ø±Ø© VIN Ù„Ù„Ø¯Ø±ÙˆØ¨ Ø¯Ø§ÙˆÙ†
      let selectedVin = preferredVin && vins.includes(preferredVin) ? preferredVin : null;
      if (!selectedVin && vins.length === 1) {
        selectedVin = vins[0];
      }

      if (vins.length > 1) {
        vinPickerBox.style.display = "block";
        vinPicker.innerHTML = vins.map(v => `<option value="${v}">${v}</option>`).join("");
        vinCountChip.textContent = vins.length + " Ø£Ø±Ù‚Ø§Ù… Ù‡ÙŠØ§ÙƒÙ„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨";
        if (selectedVin && vins.includes(selectedVin)) {
          vinPicker.value = selectedVin;
        } else {
          vinPicker.value = vins[0];
          selectedVin = vins[0];
        }
      } else if (vins.length === 1) {
        vinPickerBox.style.display = "block";
        vinPicker.innerHTML = `<option value="${vins[0]}">${vins[0]}</option>`;
        vinPicker.disabled = false;
        vinCountChip.textContent = "Ù‡ÙŠÙƒÙ„ ÙˆØ§Ø­Ø¯ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨";
        selectedVin = vins[0];
      } else {
        vinPickerBox.style.display = "none";
      }

      currentVin    = selectedVin || (vins[0] || preferredVin || "");
      try{ refreshTrackingQr(); }catch(e){}
      currentItemNo = resolveItemNoForVin(currentVin, records);

      // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙÙ‚Ø·) + Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©)
      // const totalCars = records.length; // Ù…ÙØ¹Ø±Ù‘Ù Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰


      // âœ… Ù†Ø­Ø³Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø·ÙˆØ± (Ø£ÙØ¶Ù„ Ù…ØµØ¯Ø± Ø«Ø§Ø¨Øª)
      let carsSubtotal = 0; // Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
      let carsTax      = 0; // Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
      let carsTotal    = 0; // Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (Ø³ÙŠØ§Ø±Ø§Øª ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„)

      // Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©:
      // Ø¨Ø¹Ø¶ Ù…Ù„ÙØ§Øª Ø§Ù„Ù€ ERP ØªÙƒØ±Ø± TotalInclVAT (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨) Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ø³Ø·Ø± Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø£ÙƒØ«Ø± Ù…Ù† Ù‡ÙŠÙƒÙ„.
      // Ù„Ø°Ù„Ùƒ Ù„Ø§ Ù†Ø¬Ù…Ø¹ TotalInclVAT Ø¨Ø´ÙƒÙ„ Ø£Ø¹Ù…Ù‰. Ù†Ø³ØªØ®Ø¯Ù… Subtotal+Tax ÙƒÙ…ØµØ¯Ø± Ø£Ø³Ø§Ø³ÙŠØŒ
      // ÙˆÙ†ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ TotalInclVAT Ø¨Ø­Ø°Ø± (ØªØ¬Ù…ÙŠØ¹ÙŠ ÙÙ‚Ø· Ù„Ùˆ ÙƒØ§Ù† Ù…Ø®ØªÙ„ÙÙ‹Ø§ Ù„ÙƒÙ„ Ø³Ø·Ø±).
      const totVals = [];

      records.forEach(rec => {
        const subVal = parseAmountFront(getFieldFlex("SubtotalExclVAT", rec));
        const taxVal = parseAmountFront(getFieldFlex("TaxValue", rec));
        const totVal = parseAmountFront(getFieldFlex("TotalInclVAT", rec));

        if (subVal !== null) carsSubtotal += subVal;
        if (taxVal !== null) carsTax      += taxVal;

        if (totVal !== null && totVal > 0) totVals.push(totVal);
      });

      // Ù„Ùˆ TotalInclVAT Ù…ÙˆØ¬ÙˆØ¯:
      // - Ù„Ùˆ Ù‚ÙŠÙ…Ø© ÙˆØ§Ø­Ø¯Ø© Ù…ÙƒØ±Ø±Ø© Ù…Ø¹ ØªØ¹Ø¯Ø¯ Ø§Ù„Ø³Ø·ÙˆØ± => Ø§Ø¹ØªØ¨Ø±Ù‡Ø§ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨ (Ù„Ø§ ØªØ¬Ù…Ø¹Ù‡Ø§)
      // - Ù„Ùˆ Ù‚ÙŠÙ… Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ø®ØªÙ„ÙØ© => Ø§Ø¬Ù…Ø¹Ù‡Ø§ (ÙŠØ¹Ù†ÙŠ TotalInclVAT Ù„ÙƒÙ„ Ø³Ø·Ø± ÙØ¹Ù„Ø§Ù‹)
      if (totVals.length) {
        const uniq = Array.from(new Set(totVals.map(v => Number(v).toFixed(2))));
        if (uniq.length === 1 && totVals.length > 1) {
          carsTotal = parseFloat(uniq[0]); // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨ (Ø³ÙŠØ§Ø±Ø§Øª ÙÙ‚Ø·) Ù…ÙƒØ±Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ø·ÙˆØ±
        } else {
          carsTotal = totVals.reduce((a, b) => a + b, 0); // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„ÙƒÙ„ Ø³Ø·Ø±
        }
      }

      // âœ… Ù„Ùˆ Ø§Ù„Ø³Ø·ÙˆØ± Ù…Ø§ ÙÙŠÙ‡Ø§ Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª (Ø·Ù„Ø¨Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©/Ø¨Ø¯ÙˆÙ† Ø£Ø¹Ù…Ø¯Ø© Y/Z) Ø®ÙØ¯Ù‡Ø§ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø±
      if (carsSubtotal === 0 && carsTax === 0 && carsTotal === 0) {
        const headerGrand = parseAmountFront(getFieldFlex("GrandTotal", first));
        const headerSubBT = parseAmountFront(getFieldFlex("SubtotalBeforeTax", first));
        const headerSub   = parseAmountFront(getFieldFlex("SubtotalExclVAT", first));
        const headerTax   = parseAmountFront(getFieldFlex("TaxValue", first));

        // Ø§Ù„Ø£ÙØ¶Ù„: (SubtotalBeforeTax + Tax) Ø£Ùˆ GrandTotal Ù…Ø¨Ø§Ø´Ø±Ø©
        if (headerSubBT !== null) {
          carsSubtotal = Math.max(0, (headerSubBT || 0) - (regFeeNum || 0));
        } else if (headerSub !== null) {
          carsSubtotal = headerSub || 0;
        }

        if (headerGrand !== null) {
          carsTotal = Math.max(0, (headerGrand || 0) - (regFeeNum || 0));
        } else if (headerSubBT !== null && headerTax !== null) {
          carsTotal = Math.max(0, ((headerSubBT || 0) + (headerTax || 0)) - (regFeeNum || 0));
        }

        if (headerTax !== null) {
          carsTax = headerTax || 0;
        } else if (carsTotal > 0 || carsSubtotal > 0) {
          const inferred = (carsTotal || 0) - (carsSubtotal || 0);
          carsTax = inferred > 0 ? inferred : 0;
        }
      }

      // âœ… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª = (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© + Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)
// Ù†ØªØ¬Ø§Ù‡Ù„ TotalInclVAT Ù„ØªÙØ§Ø¯ÙŠ ØªÙƒØ±Ø§Ø± Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨ Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ø³Ø·Ø± Ø¹Ù†Ø¯ ØªØ¹Ø¯Ø¯ Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„
      carsTotal = (carsSubtotal || 0) + (carsTax || 0);

      // âœ… Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©) â€” ØªÙØ¶Ø§Ù ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
      const grandTotalIncl = (carsTotal || 0) + (regFeeNum || 0);

      // Ø¹Ø±Ø¶ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª (Ø¨Ø§Ù„Ù…Ø³Ù…ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©)
      const hasTotals = (carsSubtotal > 0 || carsTax > 0 || carsTotal > 0 || regFeeNum > 0);
      if (hasTotals) {
        const parts = [];
        parts.push(`<span>Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø·Ù„Ø¨: <strong>${totalCars}</strong></span>`);
        parts.push(`<span>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: <strong>${(carsTax||0).toLocaleString('ar-SA',{minimumFractionDigits:2, maximumFractionDigits:2})} Ø±.Ø³</strong></span>`);
        parts.push(`<span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: <strong>${(carsSubtotal||0).toLocaleString('ar-SA',{minimumFractionDigits:2, maximumFractionDigits:2})} Ø±.Ø³</strong></span>`);
        if (regFeeNum > 0) {
          parts.push(`<span>Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„: <strong>${regFeeNum.toLocaleString('ar-SA',{minimumFractionDigits:2, maximumFractionDigits:2})} Ø±.Ø³</strong></span>`);
        }
        parts.push(`<span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: <strong>${(grandTotalIncl||0).toLocaleString('ar-SA',{minimumFractionDigits:2, maximumFractionDigits:2})} Ø±.Ø³</strong></span>`);

        erpTotals.innerHTML = parts.join("");
        erpTotals.style.display = "flex";
      } else {
        erpTotals.style.display = "none";
        erpTotals.innerHTML = "";
      }

// ØªØ­Ù…ÙŠÙ„ Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      loadTrackingForCurrentSelection();
      try{ refreshTrackingQr(); }catch(e){}
    }

    // STAGES UI

    function buildStagesUI(orderData = {}) {
      stagesList.innerHTML = "";

      const currentUserEmail = (auth.currentUser?.email || "").toLowerCase();
      function isStageVisible(stageNum){
        const email = (currentUserEmail || "").trim().toLowerCase();

        // âœ… CFO / COO: all stages (1-10)
        if (email === "cfo@mzjcars.com" || email === "coo@mzjcars.com"){
          return true;
        }

        // âœ… Ù…Ø­Ø¯Ø¯ÙŠÙ†: ÙÙ‚Ø· 1 Ùˆ 2 Ùˆ 9 Ùˆ 10
        if (
          email === "aldynmtwlys@gmail.com" ||
          email === "alaasamak100@gmail.com" ||
          email === "kamelashraf948@gmail.com"
        ){
          return (stageNum === 1 || stageNum === 2 || stageNum === 9 || stageNum === 10);
        }

        // âœ… Samir: Ø§Ø®ÙØ§Ø¡ 1 Ùˆ 2 Ùˆ 6 Ùˆ 7 Ùˆ 9 Ùˆ 10
        if (email === "samirali19918@gmail.com"){
          return !(stageNum === 1 || stageNum === 2 || stageNum === 6 || stageNum === 7 || stageNum === 9 || stageNum === 10);
        }

        // default
        return true;
      }
      const stagesObj = orderData.stages || {};

      const doneKeys = Object.keys(stagesObj).filter(k => stagesObj[k]);
      const doneCount = doneKeys.length;
      const allDone = STAGES.every((_, idx) => {
        const key = "s" + (idx + 1);
        return !!stagesObj[key];
      });

      STAGES.forEach((label, idx) => {
        const num = idx + 1;

        if (!isStageVisible(num)) return;
        const key = "s" + num;
        const ts  = stagesObj[key];

        const tsStr = ts
          ? new Date(ts.toDate ? ts.toDate() : ts).toLocaleString("ar-SA")
          : null;

        const wrap = document.createElement("div");
        wrap.className = "stage";
        if (tsStr) wrap.classList.add("done");

        const header = document.createElement("div");
        header.className = "stage-header";

        const tEl = document.createElement("div");
        tEl.innerHTML = "<strong>" + label + "</strong>";

        const meta = document.createElement("div");
        meta.innerHTML = tsStr
          ? "<small>ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: " + tsStr + "</small>"
          : "<small>Ù„Ù… ØªÙÙ†ÙÙ‘Ø° Ø¨Ø¹Ø¯</small>";

        header.appendChild(tEl);
        header.appendChild(meta);

        const actions = document.createElement("div");

        // Ø²Ø± ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
        const btnDone = document.createElement("button");
        btnDone.className = "btn-outline";
        btnDone.style.fontSize = "12px";
        btnDone.textContent = "ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡";
        btnDone.disabled = !!tsStr || allDone;
        btnDone.onclick = () => completeStage(num);
        actions.appendChild(btnDone);

        
        // Ø²Ø± Ø±Ø³Ø§Ù„Ø© SMS Ù„Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ§Øª 1 Ùˆ 9 Ùˆ 10 ÙÙ‚Ø·
        if (num === 1 || num === 9 || num === 10) {
          const btnSms = document.createElement("button");
          btnSms.className = "btn-outline";
          btnSms.style.fontSize = "12px";
          btnSms.style.marginRight = "6px";
          btnSms.textContent = "Ø±Ø³Ø§Ù„Ø© SMS Ù„Ù„Ø¹Ù…ÙŠÙ„";
          btnSms.disabled = !currentCustomerPhone;
          btnSms.onclick = () => openMessageModal("sms", num, label);
          actions.appendChild(btnSms);

          const btnWa = document.createElement("button");
          btnWa.className = "btn-outline";
          btnWa.style.fontSize = "12px";
          btnWa.style.marginRight = "6px";
          btnWa.innerHTML = '<i class="fa-brands fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„';
          btnWa.disabled = !currentCustomerPhone;
          btnWa.onclick = () => openMessageModal("whatsapp", num, label);
          actions.appendChild(btnWa);
        }
    

        // Ø²Ø± Ø§Ù„ØªØ±Ø§Ø¬Ø¹
        const btnUndo = document.createElement("button");
        btnUndo.className = "btn-outline";
        btnUndo.style.fontSize = "12px";
        btnUndo.style.marginRight = "6px";
        btnUndo.textContent = "ØªØ±Ø§Ø¬Ø¹";
        btnUndo.disabled = !tsStr;
        btnUndo.onclick = () => revertStage(num);
        actions.appendChild(btnUndo);

        wrap.appendChild(header);
        wrap.appendChild(actions);

        stagesList.appendChild(wrap);
      });

      if (allDone) {
        const info = document.createElement("div");
        info.className = "hint";
        info.style.marginTop = "8px";
        info.textContent = "ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ù„Ù‡Ø°Ø§ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ØŒ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§Ø­Ù„ Ø¬Ø¯ÙŠØ¯Ø©.";
        stagesList.appendChild(info);
      }
    }


    async function completeStage(num) {
      stageMsg.textContent = "";
      if (!currentOrderId || !currentItemNo) {
        stageMsg.innerHTML = "<span class='err'>Ø§Ø®ØªØ± Ø·Ù„Ø¨ ÙˆØ±Ù‚Ù… Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø§Ø­Ù„.</span>";
        return;
      }

      const baseId = currentOrderId;
      const docId = baseId + "_" + currentItemNo;
      const key = "s" + num;

      // âœ… Ø§Ø³ØªØ®Ø¯Ù… ÙƒØ§Ø´ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ (Ø¨Ø¯ÙˆÙ† Ù‚Ø±Ø§Ø¡Ø© getDoc ÙƒÙ„ Ù…Ø±Ø©)
      const stagesObj = Object.assign({}, currentStagesObjCache || {});
      if (stagesObj[key]) {
        stageMsg.innerHTML = "<span class='muted'>Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ØªÙ… Ø®ØªÙ…Ù‡Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹.</span>";
        return;
      }

      // âœ… ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø´ÙƒÙ„ ÙÙˆØ±ÙŠ (Optimistic UI) Ù„ØªØ­Ø³Ù‘Ù† Ø§Ù„Ø³Ø±Ø¹Ø©
      const optimisticStages = Object.assign({}, stagesObj, { [key]: new Date() });
      currentStagesObjCache = optimisticStages;
      currentTrackData = currentTrackData || {
        orderId: baseId,
        vin: currentVin || "",
        itemNo: currentItemNo || 1,
        currentStage: 0,
        stages: {}
      };
      currentTrackData.orderId = baseId;
      currentTrackData.vin = currentVin || "";
      currentTrackData.itemNo = currentItemNo || 1;
      currentTrackData.stages = optimisticStages;

      const doneCount = Object.keys(optimisticStages).filter(k => optimisticStages[k]).length;
      currentTrackData.currentStage = doneCount;

      buildStagesUI(currentTrackData);
      stageMsg.innerHTML = "<span class='muted'>Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø­Ù„Ø©...</span>";

      try {
        const orderRef  = doc(db, TRACK_COLLECTION, docId);
        const publicRef = doc(db, TRACK_COLLECTION, docId, "public", "status");

        // âœ… ÙƒØªØ§Ø¨Ø© ÙˆØ§Ø­Ø¯Ø© (Batch) Ø¨Ø¯Ù„ 2 setDoc Ù…ØªØªØ§Ø¨Ø¹ÙŠÙ†
        const batch = writeBatch(db);

        batch.set(orderRef, {
          orderId: baseId,
          vin: currentVin || "",
          itemNo: currentItemNo || 1,
          currentStage: doneCount,
          stages: { [key]: serverTimestamp() }
        }, { merge: true });

        batch.set(publicRef, {
          orderId: baseId,
          vin: currentVin || "",
          itemNo: currentItemNo || 1,
          currentStage: doneCount,
          stages: { [key]: serverTimestamp() },
          updatedAt: serverTimestamp()
        }, { merge: true });

        await batch.commit();

        stageMsg.innerHTML = "<span class='ok'>ØªÙ… Ø®ØªÙ… Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø±Ù‚Ù… " + num + " ÙˆØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Ø§Ù„ØªØªØ¨Ø¹.</span>";
      } catch (e) {
        console.error(e);
        stageMsg.innerHTML = "<span class='err'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø­Ù„Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</span>";
        // Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ø¯Ø§ØªØ§ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚ (Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„)
        try { await loadTrackingForCurrentSelection(); } catch(e2) {}
      }
    }



    async function revertStage(num) {
      stageMsg.textContent = "";
      if (!currentOrderId || !currentItemNo) {
        stageMsg.innerHTML = "<span class='err'>Ø§Ø®ØªØ± Ø·Ù„Ø¨ ÙˆØ±Ù‚Ù… Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø©.</span>";
        return;
      }

      const baseId = currentOrderId;
      const docId = baseId + "_" + currentItemNo;
      const key = "s" + num;

      const stagesObj = Object.assign({}, currentStagesObjCache || {});
      if (!stagesObj[key]) {
        stageMsg.innerHTML = "<span class='muted'>Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø© Ø£ØµÙ„Ø§Ù‹.</span>";
        return;
      }

      // âœ… Optimistic UI
      delete stagesObj[key];
      currentStagesObjCache = stagesObj;

      currentTrackData = currentTrackData || {
        orderId: baseId,
        vin: currentVin || "",
        itemNo: currentItemNo || 1,
        currentStage: 0,
        stages: {}
      };
      currentTrackData.orderId = baseId;
      currentTrackData.vin = currentVin || "";
      currentTrackData.itemNo = currentItemNo || 1;
      currentTrackData.stages = stagesObj;

      const doneCount = Object.keys(stagesObj).filter(k => stagesObj[k]).length;
      currentTrackData.currentStage = doneCount;

      buildStagesUI(currentTrackData);
      stageMsg.innerHTML = "<span class='muted'>Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ±Ø§Ø¬Ø¹...</span>";

      try {
        const orderRef  = doc(db, TRACK_COLLECTION, docId);
        const publicRef = doc(db, TRACK_COLLECTION, docId, "public", "status");

        const batch = writeBatch(db);

        batch.update(orderRef, {
          [`stages.${key}`]: deleteField(),
          currentStage: doneCount
        });

        batch.update(publicRef, {
          [`stages.${key}`]: deleteField(),
          currentStage: doneCount,
          updatedAt: serverTimestamp()
        });

        await batch.commit();

        stageMsg.innerHTML = "<span class='ok'>ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø±Ù‚Ù… " + num + " Ù„Ù‡Ø°Ø§ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„.</span>";
      } catch (e) {
        console.error(e);
        stageMsg.innerHTML = "<span class='err'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØ±Ø§Ø¬Ø¹. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</span>";
        try { await loadTrackingForCurrentSelection(); } catch(e2) {}
      }
    }

    async function loadTrackingForCurrentSelection(){
      if (!currentOrderId || !currentItemNo) {
        buildStagesUI({ });
        return;
      }
      try{
        const baseId = currentOrderId;
        const docId  = baseId + "_" + currentItemNo;

        const orderRef = doc(db, TRACK_COLLECTION, docId);
        const trackSnap = await getDoc(orderRef);
        let trackData;
        if (trackSnap.exists()) {
          trackData = trackSnap.data();
        } else {
          trackData = {
            orderId: baseId,
            vin: currentVin || "",
            itemNo: currentItemNo || 1,
            currentStage: 0,
            stages:{}
          };
          await setDoc(orderRef, trackData, {merge:true});
          const publicRef = doc(db, TRACK_COLLECTION, docId, "public", "status");
          await setDoc(publicRef, {
            orderId: baseId,
            vin: currentVin || "",
            itemNo: currentItemNo || 1,
            currentStage: 0,
            stages:{},
            updatedAt: serverTimestamp()
          }, {merge:true});
        }

        const stagesObj = trackData.stages || {};
        const doneKeys = Object.keys(stagesObj).filter(k => stagesObj[k]);
        const doneCount = doneKeys.length;
        trackData.currentStage = doneCount;

        currentTrackData = trackData;
        currentStagesObjCache = trackData.stages || {};

        buildStagesUI(trackData);
      }catch(e){
        console.error(e);
        buildStagesUI({ });
      }
    }

    async function findByVin(vinRaw) {
      const val = vinRaw.trim();
      if (!val) return null;

      const colRef = collection(db, ERP_COLLECTION);

      let q1 = query(colRef, where("vin","==",val));
      let snap = await getDocs(q1);
      if (!snap.empty) return snap.docs[0];

      const asNum = Number(val);
      if (!Number.isNaN(asNum)) {
        q1 = query(colRef, where("vin","==",asNum));
        snap = await getDocs(q1);
        if (!snap.empty) return snap.docs[0];
      }

      try {
        const vinRef = doc(db, ERP_VINS_COLLECTION, val);
        const vinSnap = await getDoc(vinRef);
        if (vinSnap.exists()) {
          const vData = vinSnap.data();
          const ordNo = vData.lastOrderNo || vData.orderNo || vData.OrderNo || null;
          if (ordNo) {
            const ordRef = doc(db, ERP_COLLECTION, ordNo);
            const ordSnap = await getDoc(ordRef);
            if (ordSnap.exists()) return ordSnap;

            const q2 = query(colRef, where("orderNo","==",ordNo));
            const s2 = await getDocs(q2);
            if (!s2.empty) return s2.docs[0];
          }
        }
      } catch (e) {
        console.error("VIN lookup via erp_vins failed", e);
      }

      return null;
    }

    async function loadOrder(){
      orderMsg.textContent = "";
      stageMsg.textContent = "";
      clearErpTable();
      currentOrderId      = null;
      currentVin          = null;
      currentItemNo       = null;
      currentOrderRecords = [];

      const idRaw  = orderIdInput.value.trim();
      const vinRaw = vinInput.value.trim();

      if(!idRaw && !vinRaw){
        orderMsg.innerHTML = "<span class='err'>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„.</span>";
        erpCard.style.display = "none";
        buildStagesUI({ });
        return;
      }

      try{
        let erpRecords = [];
        let erpDocId = null;

        if(idRaw){
          const ref = doc(db, ERP_COLLECTION, idRaw);
          const snap = await getDoc(ref);
          if(snap.exists()){
            erpRecords.push(snap.data());
            erpDocId = snap.id;
          }
        }

        let baseOrder = idRaw;
        if(!erpRecords.length && baseOrder){
          if(baseOrder.includes("_")) baseOrder = baseOrder.split("_")[0];
          const q = query(collection(db, ERP_COLLECTION), where("orderNo","==",baseOrder));
          const qsnap = await getDocs(q);
          if(!qsnap.empty){
            erpRecords = qsnap.docs.map(d => d.data());
            erpDocId = qsnap.docs[0].id;
          }
        }

        if(!erpRecords.length && vinRaw){
          const d = await findByVin(vinRaw);
          if(d){
            const data = d.data();
            erpDocId = d.id;
            const ordNo = data.orderNo || data.OrderNo || null;
            if (ordNo) {
              const q2 = query(collection(db, ERP_COLLECTION), where("orderNo","==",ordNo));
              const s2 = await getDocs(q2);
              if (!s2.empty) {
                erpRecords = s2.docs.map(docSnap => docSnap.data());
              } else {
                erpRecords = [data];
              }
            } else {
              erpRecords = [data];
            }
          }
        }

        if(!erpRecords.length){
          orderMsg.innerHTML = "<span class='err'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù…Ø·Ø§Ø¨Ù‚ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª ERP.</span>";
          erpCard.style.display = "none";
          buildStagesUI({ });
          return;
        }

        const firstRec = erpRecords[0] || {};
        const detectedOrderNo = firstRec.orderNo || firstRec.OrderNo || (erpDocId || idRaw);

        currentOrderId = detectedOrderNo;

        orderIdInput.value = detectedOrderNo || "";
        const preferredVin =
          vinRaw ||
          (erpRecords.length === 1 ? (getFieldFlex("VIN", firstRec) || "") : "");

        fillErpTable(erpRecords, preferredVin);

        stagesCard.style.display = "";
        ordersListCard.style.display = ordersListCard.style.display;

        orderMsg.innerHTML = "<span class='ok'>ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ±Ø¨Ø·Ù‡ Ø¨Ø§Ù„ØªØªØ¨Ø¹.</span>";
      }catch(e){
        console.error(e);
        orderMsg.innerHTML = "<span class='err'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨.</span>";
        erpCard.style.display = "none";
        buildStagesUI({ });
      }
    }

    loadBtn.onclick = loadOrder;

    clearBtn.onclick = () => {
      orderIdInput.value = "";
      vinInput.value = "";
      orderMsg.textContent = "";
      stageMsg.textContent = "";
      currentOrderId      = null;
      currentVin          = null;
      currentItemNo       = null;
      currentOrderRecords = [];
      clearErpTable();
      erpCard.style.display = "none";
      buildStagesUI({ });
    };

    vinPicker.addEventListener("change", () => {
      if (!currentOrderId || !currentOrderRecords.length) return;
      const selected = vinPicker.value;
      currentVin    = selected;
      currentItemNo = resolveItemNoForVin(selected, currentOrderRecords);
      loadTrackingForCurrentSelection();
    });

    // ---- ØªØ¨ÙˆÙŠØ¨ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ----

    
    function loadReadOrders(){
      try{
        const arr = JSON.parse(localStorage.getItem("mzj_read_orders") || "[]");
        if (Array.isArray(arr)) ordersReadSet = new Set(arr.map(String));
      }catch(e){ ordersReadSet = new Set(); }
    }
    function saveReadOrders(){
      try{
        localStorage.setItem("mzj_read_orders", JSON.stringify(Array.from(ordersReadSet)));
      }catch(e){}
    }
    function renderOrdersList(filterText=""){
      const q = String(filterText||"").trim().toLowerCase();
      const rows = Array.isArray(ordersListCache) ? ordersListCache : [];
      const filtered = !q ? rows : rows.filter(r => {
        const hay = [
          r.orderNo, r.customerName, r.customerPhone, r.branch, r.vinVal, r.vinRaw
        ].filter(Boolean).join(" ").toLowerCase();
        return hay.includes(q);
      });

      ordersListBody.innerHTML = "";
      if (!filtered.length){
        ordersListBody.innerHTML = "<tr><td class='muted' colspan='5'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</td></tr>";
        return;
      }

      filtered.forEach(r => {
        const tr = document.createElement("tr");
        const isUnread = !ordersReadSet.has(String(r.orderNo||""));
        if (isUnread) tr.classList.add("unread-row");

        tr.innerHTML = `
          <td><button class="link-btn" data-order="${r.orderNo}">${r.orderNo}</button></td>
          <td>${r.customerName || "â€”"}</td>
          <td>${r.customerPhone || "â€”"}</td>
          <td>${r.branch || "â€”"}</td>
          <td>${r.vinVal || "â€”"}</td>
        `;
        ordersListBody.appendChild(tr);
      });
    }


    async function loadOrdersList() {
      ordersListBody.innerHTML = "<tr><td class='muted' colspan='5'>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</td></tr>";
      try {
        // âœ… Ù†Ù‚Ø±Ø£ Ø¢Ø®Ø± 200 Ø³Ø¬Ù„ Ù…Ù† erp_orders (Ù‚Ø¯ ÙŠÙƒÙˆÙ† ÙÙŠ ØªÙƒØ±Ø§Ø± Ù„Ø£Ù† ÙƒÙ„ Ø³ÙŠØ§Ø±Ø© Ø³Ø¬Ù„)
        const q = query(collection(db, ERP_COLLECTION), limit(200));
        const snap = await getDocs(q);
        if (snap.empty) {
          ordersListBody.innerHTML = "<tr><td class='muted' colspan='5'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>";
          return;
        }
        // âœ… Ù†Ø¬Ù…Ø¹ Ø­Ø³Ø¨ orderNo Ù„ØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        const byOrder = new Map();
        for (const docSnap of snap.docs) {
          const d = docSnap.data();
          const orderNo = d.orderNo || d.OrderNo || docSnap.id;
          if (!orderNo) continue;

          if (!byOrder.has(orderNo)) {
            byOrder.set(orderNo, { orderNo, docs: [] });
          }
          byOrder.get(orderNo).docs.push(d);
        }

        const rows = [];
        for (const group of byOrder.values()) {
          const docsArr = group.docs || [];
          const first = docsArr[0] || {};

          const vins = Array.from(new Set(
            docsArr
              .map(x => (getFieldFlex("VIN", x) || "").toString().trim())
              .filter(v => v && v !== "-" && v !== "â€”")
          ));

          const vinVal = (vins.length <= 1)
            ? (vins[0] || "â€”")
            : ("(" + vins.length + ") Ù‡ÙŠØ§ÙƒÙ„");

          const customerName = getFieldFlex("CustomerName", first) || "";
          const customerPhone = getFieldFlex("CustomerPhone", first) || "";
          const branch = getFieldFlex("Branch", first) || "";
          const orderDateRaw = getFieldFlex("OrderDate", first) || "";

          // Ø­Ø§Ù„Ø© Ø§Ù„ØªØªØ¨Ø¹
          // ğŸš€ ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¡: Ù„Ø§ Ù†Ù‚Ø±Ø£ Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„ÙƒÙ„ Ø·Ù„Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (ÙŠØ³Ø¨Ø¨ Ø¨Ø·Ø¡ Ø´Ø¯ÙŠØ¯).
          // Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯ ÙØªØ­ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ "Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨".
          

          rows.push({ orderNo: group.orderNo, vinVal, vinRaw: vins.join(" "), customerName, customerPhone, branch, orderDateRaw });
        }
        
        // ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙÙˆÙ Ø¨Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹ (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ orderBy Ù„ØªÙØ§Ø¯ÙŠ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ÙÙ‡Ø§Ø±Ø³/Ø§Ø®ØªÙ„Ø§Ù Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„)
        function toMillis(v){
          if (!v) return 0;
          // Firestore Timestamp
          if (v.toDate) return v.toDate().getTime();
          // JS Date
          if (v instanceof Date) return v.getTime();
          // number
          if (typeof v === "number") return v;
          // string
          const s = String(v).trim();
          // try parse ISO / normal date
          const t = Date.parse(s);
          if (!Number.isNaN(t)) return t;
          // fallback: if looks like dd/mm/yyyy or dd-mm-yyyy
          const m = s.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
          if (m){
            const dd = parseInt(m[1],10), mm = parseInt(m[2],10)-1, yy = parseInt(m[3],10);
            const yyyy = yy < 100 ? (2000 + yy) : yy;
            const d = new Date(yyyy, mm, dd);
            return d.getTime() || 0;
          }
          return 0;
        }

        rows.sort((a,b) => {
          const aMs = toMillis(a.orderDateRaw || a.deliveryDate || "");
          const bMs = toMillis(b.orderDateRaw || b.deliveryDate || "");
          // desc
          return bMs - aMs;
        });

ordersListCache = rows;
        loadReadOrders();
        renderOrdersList(ordersSearchInput ? ordersSearchInput.value : "");
} catch (err) {
        console.error(err);
        ordersListBody.innerHTML = "<tr><td class='err' colspan='5'>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª.</td></tr>";
      }
    }

    function activateTab(which) {
      if (which === "list") {
        orderCard.style.display = "none";
        erpCard.style.display   = "none";
        stagesCard.style.display= "none";
        ordersListCard.style.display = "";
        tabSearchBtn.classList.remove("tab-active");
        tabListBtn.classList.add("tab-active");
        loadOrdersList();
      } else {
        orderCard.style.display = "";
        erpCard.style.display   = currentOrderId ? "" : "none";
        stagesCard.style.display= "";
        ordersListCard.style.display = "none";
        tabSearchBtn.classList.add("tab-active");
        tabListBtn.classList.remove("tab-active");
      }
    }

    tabSearchBtn.addEventListener("click", () => activateTab("search"));
    tabListBtn.addEventListener("click", () => activateTab("list"));

    if (ordersSearchInput) {
      ordersSearchInput.addEventListener("input", () => {
        renderOrdersList(ordersSearchInput.value);
      });
    }

    ordersListBody.addEventListener("click", async (e) => {
      const btn = e.target.closest("button.link-btn");
      if (!btn) return;
      const ord = btn.dataset.order;
      // mark as read (opened once) like mail behavior
      ordersReadSet.add(String(ord || ""));
      saveReadOrders();

      try { await navigator.clipboard.writeText(ord); } catch(e) { console.warn(e); }
      orderIdInput.value = ord;
      vinInput.value = "";
      activateTab("search");
      loadOrder();
    });

    // Ø²Ø± ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØªØ¨Ø¹
    if (trackLinkBtn) {
      trackLinkBtn.addEventListener("click", async () => {
        if (!currentVin) {
          alert("Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„.");
          return;
        }

        const url = `https://mzj-tracking.vercel.app/Test-Track.html?vin=${encodeURIComponent(currentVin)}`;

        // ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯
        window.open(url, "_blank");

        // Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©
        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(url);
            alert("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØªØªØ¨Ø¹:\n" + url);
          } catch (err) {
            console.warn("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©", err);
          }
        }
      });
    }


    // Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
        whoami.textContent = user.email || "";
        logoutBtn.style.display = "inline-flex";

        authCard.style.display = "none";
        tabsBar.style.display  = "flex";

        orderCard.style.display  = "";
        if (currentOrderId) {
          erpCard.style.display    = "";
          stagesCard.style.display = "";
        } else {
          erpCard.style.display    = "none";
          stagesCard.style.display = "none";
        }
        ordersListCard.style.display = "none";
      } else {
        // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…
        whoami.textContent = "";
        logoutBtn.style.display = "none";

        authCard.style.display     = "";
        tabsBar.style.display      = "none";
        orderCard.style.display    = "none";
        erpCard.style.display      = "none";
        stagesCard.style.display   = "none";
        ordersListCard.style.display = "none";
      }
    });

    // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    loginBtn.addEventListener("click", async () => {
      authMsg.textContent = "";
      const emailVal = (email.value || "").trim();
      const passVal  = (password.value || "").trim();

      if (!emailVal || !passVal) {
        authMsg.innerHTML = "<span class='err'>Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.</span>";
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, emailVal, passVal);
        authMsg.innerHTML = "<span class='ok'>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.</span>";
      } catch (e) {
        console.error(e);
        authMsg.innerHTML = "<span class='err'>ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.</span>";
      }
    });

    // Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ (Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·)
    if (signupBtn) signupBtn.addEventListener("click", async () => {
      authMsg.textContent = "";
      const emailVal = (email.value || "").trim();
      const passVal  = (password.value || "").trim();

      if (!emailVal || !passVal) {
        authMsg.innerHTML = "<span class='err'>Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.</span>";
        return;
      }

      try {
        await createUserWithEmailAndPassword(auth, emailVal, passVal);
        authMsg.innerHTML = "<span class='ok'>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.</span>";
      } catch (e) {
        console.error(e);
        authMsg.innerHTML = "<span class='err'>ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. Ø±Ø¨Ù…Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„.</span>";
      }
    });

    // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (e) {
        console.error(e);
      }
    });

    // ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ© Ù„Ù„ØµÙØ­Ø©
    tabsBar.style.display      = "none";
    orderCard.style.display    = "none";
    erpCard.style.display      = "none";
    stagesCard.style.display   = "none";
    ordersListCard.style.display = "none";

    clearErpTable();
    buildStagesUI({ });

  </script>

<script>
  // Topbar connection badge helper (non-invasive)
  (function(){
    const who = document.getElementById('whoami');
    const dot = document.getElementById('connDot');
    const txt = document.getElementById('connText');
    function tick(){
      const hasUser = who && (who.textContent||'').trim().length>0;
      if(dot) dot.className = 'dot ' + (hasUser ? 'ok' : 'warn');
      if(txt) txt.textContent = hasUser ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
    }
    setInterval(tick, 700);
    setTimeout(tick, 50);
  })();
</script>

  <script src="./mzj-ui.js"></script>

      </div>
    </main>
  </div>


  <!-- Message Modal (Edit before send) -->
  <div id="msgModal" style="display:none;position:fixed;inset:0;z-index:9999;">
    <div id="msgModalBackdrop" style="position:absolute;inset:0;background:rgba(0,0,0,.45);"></div>
    <div style="position:relative;max-width:680px;margin:7vh auto;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid #e5e7eb;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:rgba(188,143,116,.16);color:var(--brown);font-weight:900;">
            <i class="fa-solid fa-paper-plane"></i>
          </div>
          <div>
            <div id="msgModalTitle" style="font-weight:900;color:var(--brown);">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©</div>
            <div id="msgModalSub" style="font-size:12px;color:var(--muted);margin-top:2px;">â€”</div>
          </div>
        </div>
        <button id="msgModalClose" class="btn-outline" type="button" style="font-size:12px;">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>

      <div style="padding:12px 14px;">
        <label style="margin:0 0 6px 0;">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù‘Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„)</label>
        <textarea id="msgModalText" rows="9" style="width:100%;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#f9fafb;font-family:inherit;font-size:14px;outline:none;resize:vertical;"></textarea>
        <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-top:10px;">
          <div class="muted" style="font-size:12px;">
            <span class="badge" id="msgModalChannel">â€”</span>
            <span class="badge" id="msgModalPhone">â€”</span>
            <span class="badge" id="msgModalVin">â€”</span>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="msgModalCopy" class="btn-outline" type="button" style="font-size:12px;"><i class="fa-regular fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ù†Øµ</button>
            <button id="msgModalReset" class="btn-outline" type="button" style="font-size:12px;"><i class="fa-solid fa-rotate-left"></i> Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ</button>
            <button id="msgModalSend" class="btn" type="button" style="font-size:12px;"><i class="fa-solid fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„</button>
          </div>
        </div>
        <div id="msgModalMsg" class="muted" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <!-- Dynamic QR (Clickable) -->
  <div id="trackQrModal" style="display:none;position:fixed;inset:0;z-index:9998;">
    <div id="trackQrBackdrop" style="position:absolute;inset:0;background:rgba(0,0,0,.45);"></div>
    <div style="position:relative;max-width:420px;margin:10vh auto;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid #e5e7eb;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:rgba(188,143,116,.16);color:var(--brown);font-weight:900;">
            <i class="fa-solid fa-qrcode"></i>
          </div>
          <div>
            <div style="font-weight:900;color:var(--brown);">QR ØªØªØ¨Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
            <div id="trackQrSub" style="font-size:12px;color:var(--muted);margin-top:2px;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù€ QR Ù„ÙØªØ­ Ø§Ù„ØªØªØ¨Ø¹ Ù…Ø¨Ø§Ø´Ø±Ø©</div>
          </div>
        </div>
        <button id="trackQrClose" class="btn-outline" type="button" style="font-size:12px;">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div style="padding:14px;text-align:center;">
        <a id="trackQrLink" href="#" target="_blank" style="display:inline-block;text-decoration:none;">
          <img id="trackQrImg" alt="QR Tracking" style="width:240px;height:240px;border-radius:14px;border:1px solid #e5e7eb;background:#fff;"/>
        </a>
        <div class="hint" style="margin-top:10px;">Ø±Ø§Ø¨Ø· Ø§Ù„ØªØªØ¨Ø¹: <button id="trackQrCopy" class="link-btn" type="button">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button></div>
      </div>
    </div>
  </div>

</body>
</html>
