
<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª â€” MZJ Cars</title>
  <link rel="icon" type="image/x-icon" href="assets/favicon.png">

  <!-- No-flash auth gate -->
  <style id="noFlash">
    html{background:#fff8ef}
    body{opacity:0;transition:.14s ease}
  </style>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="./mzj-ui.css"/>

  <style>
    :root{
      --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef;
      --text:#1f2937; --muted:#6b7280;
      --line:#e5e7eb; --line-strong:#d1d5db;
      --card:#ffffff; --bg:#fff8ef; --radius:14px;
      --shadow:0 10px 24px rgba(0,0,0,.06);
      --ok:#16a34a; --danger:#ef4444; --info:#0ea5e9; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:"Tajawal",system-ui,Arial}

    /* Small helpers */
    .container{max-width:1280px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1fr;gap:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .card h3{margin:0 0 10px;color:var(--brown);font-size:16px;font-weight:900;display:flex;align-items:center;gap:8px}
    .hint{font-size:12px;color:var(--muted)}

    .dot{width:9px;height:9px;border-radius:999px;background:var(--warn);display:inline-block}
    .dot.ok{background:var(--ok)}
    .dot.err{background:var(--danger)}
    .dot.warn{background:var(--warn)}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(max-width:920px){.grid-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:640px){.grid-2,.grid-3{grid-template-columns:1fr}}

    label{display:block;font-size:12px;font-weight:800;color:var(--brown);margin-bottom:5px}
    .input,.select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-family:inherit;font-size:13px;transition:.15s}
    .input:focus,.select:focus,textarea:focus{outline:none;border-color:var(--beige);box-shadow:0 0 0 1px rgba(188,143,116,.35)}
    textarea{min-height:90px;resize:vertical}

    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:9px 12px;cursor:pointer;font-weight:900;display:inline-flex;gap:8px;align-items:center;transition:.15s;font-size:13px}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--brown);border-color:var(--brown);color:#fff;border-radius:999px;padding-inline:18px}
    .btn-ghost{background:#fff}
    .btn-outline{background:#fff;border-color:var(--brown);color:var(--brown)}
    .btn-danger{background:var(--danger);border-color:var(--danger);color:#fff}

    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font-size:11px}

    .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border:1px solid var(--line);border-left-color:var(--line-strong);padding:8px 10px;text-align:right;vertical-align:top;font-size:13px;background:#fff}
    thead th{position:sticky;top:0;background:#f9fafb;border-bottom:2px solid var(--line-strong);z-index:1}
    tbody tr:nth-child(even) td{background:#fffdf8}
    tbody tr:hover td{background:#f3f4f6}

    .tag{display:inline-block;background:#f6f6f6;border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-size:12px;color:#444}
    .ok{color:var(--ok);font-weight:900}
    .bad{color:var(--danger);font-weight:900}

    /* Auth */
    .auth-wrap{min-height:60vh;display:grid;place-items:center;padding:24px}
    .auth-card{background:#fff;border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);padding:18px;max-width:420px;width:96%}
    .auth-card h2{margin:0 0 10px;color:var(--brown);font-weight:900}
    .auth-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;z-index:400}
    .modal{background:#fff;border-radius:18px;box-shadow:0 20px 45px rgba(0,0,0,.18);max-width:980px;width:95%;padding:14px;border:1px solid var(--line);position:relative}
    .modal h3{margin:0 0 10px;color:var(--brown);font-size:16px;font-weight:900;display:flex;align-items:center;gap:8px}
    .modal .close{position:absolute;left:10px;top:10px;border:none;background:transparent;cursor:pointer;color:var(--muted)}
    .modal-footer{display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap;margin-top:10px}

    /* Toast */
    .toast{position:fixed;bottom:20px;right:20px;background:#1f2937;color:#fff;padding:9px 13px;border-radius:999px;display:none;font-size:12px;z-index:450}
    .toast.show{display:block;animation:fade .18s ease-out}
    @keyframes fade{from{opacity:0;transform:translate(0,6px)}to{opacity:1;transform:translate(0,0)}}
  </style>
</head>
<body class="mzj">

<header class="mzj-topbar">
  <div class="topbar-left">
    <button class="icon-btn" id="mzjSidebarBtn" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"><i class="fa-solid fa-bars"></i></button>
    <div class="brand">
      <div class="brand-mark">MZJ</div>
      <div class="brand-text">
        <div class="brand-title">Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</div>
        <div class="brand-sub">Workspace</div>
      </div>
    </div>
  </div>
  <div class="topbar-center">
    <div class="mzj-breadcrumb">
      <span class="crumb">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
      <i class="fa-solid fa-chevron-left"></i>
      <span class="crumb current">Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span>
    </div>
  </div>
  <div class="topbar-right">
    <div class="mzj-chip">
      <span class="dot warn" id="connDot" style="margin-inline-start:2px"></span>
      <span id="connText">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦</span>
    </div>
    <button class="mzj-btn mzj-btn-ghost" id="btnSignOut" style="display:none" type="button">
      <i class="fa-solid fa-right-from-bracket"></i>
      <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
    </button>
  </div>
</header>

<div class="mzj-shell" id="mzjShell">
  <aside class="mzj-sidebar" id="mzjSidebar">
    <div class="side-section">
      <div class="side-title">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
      <nav class="side-nav">
        <a class="side-link tab" href="./sales.html"><i class="fa-solid fa-handshake"></i><span>ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span></a>
        <a class="side-link tab" href="./dashboard.html"><i class="fa-solid fa-gauge"></i><span>Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</span></a>
        <a class="side-link tab" href="./inventory.html"><i class="fa-solid fa-boxes-stacked"></i><span>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span></a>
        <a class="side-link tab active" href="./move-new.html"><i class="fa-solid fa-right-left"></i><span>Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span></a>
        <a class="side-link tab" href="./photoshoot-user.html"><i class="fa-solid fa-camera"></i><span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span></a>
        <a class="side-link tab" href="./cars.html"><i class="fa-solid fa-car"></i><span>ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span></a>
        <a class="side-link tab" href="./admin.html"><i class="fa-solid fa-shield-halved"></i><span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span></a>
        <a class="side-link tab" href="./Activity.html"><i class="fa-solid fa-clipboard-list"></i><span>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</span></a>
        <a class="side-link tab" href="./act.html"><i class="fa-solid fa-clipboard-list"></i><span>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</span></a>
      </nav>
    </div>
  </aside>

  <div class="mzj-backdrop" id="mzjBackdrop"></div>
  <main class="mzj-content">

    <!-- Auth Gate -->
    <div id="authGate" class="auth-wrap">
      <div class="auth-card">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input id="email" type="email" class="input" placeholder="you@example.com"/>
        <label for="password" style="margin-top:8px">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input id="password" type="password" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
        <div class="auth-actions">
          <button class="btn btn-primary" id="btnLogin">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
          <button class="btn btn-outline" id="btnSignup">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        </div>
        <p class="hint" id="authHint" style="margin-top:10px"></p>
      </div>
    </div>

    <!-- App -->
    <div id="app" style="display:none">
      <div class="container">

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div class="row">
              <span class="pill"><i class="fa-solid fa-database" style="color:var(--beige)"></i> Ø§Ù„Ù…ØµØ¯Ø±: <b>mzj_admin_state/v1</b></span>
              <span class="pill"><i class="fa-solid fa-car" style="color:var(--beige)"></i> Ø³ÙŠØ§Ø±Ø§Øª Ù…ÙØ¶Ø§ÙØ©: <b id="vinCount">0</b></span>
            </div>
            <div class="row">
              <button class="btn btn-ghost" id="btnClear"><i class="fa-solid fa-eraser"></i> Ù…Ø³Ø­</button>
              <button class="btn btn-outline" id="btnOpenPreview"><i class="fa-solid fa-table"></i> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ù„Ø¨</button>
              <button class="btn btn-primary" id="btnExecute"><i class="fa-solid fa-right-left"></i> ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‚Ù„</button>
            </div>
          </div>
          <p class="hint" style="margin:8px 0 0">Ø§ÙƒØªØ¨ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„ (VIN) â€” ÙƒÙ„ Ø±Ù‚Ù… ÙÙŠ Ø³Ø·Ø±. Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª" ØªØ¸Ù‡Ø± Ø®Ø§Ù†Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©. Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ "Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" Ù…Ù…Ù†ÙˆØ¹ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ø§Ù„ÙŠØ© ÙˆØ¥Ø¯Ø§Ø±ÙŠØ©.</p>
        </div>

        <div class="card">
          <h3><i class="fa-solid fa-pen" style="color:var(--beige)"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù‚Ù„</h3>
          <div class="grid grid-2">
            <div>
              <div class="row" style="justify-content:space-between;align-items:end;gap:10px">
                <div>
                  <label style="margin:0">Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„</label>
                  <div class="hint" style="margin-top:6px">Ø§ÙƒØªØ¨ VIN ÙÙŠ Ø§Ù„Ø®Ø§Ù†Ø© â€” ÙƒÙ„ ØµÙ = Ø³ÙŠØ§Ø±Ø©. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± (Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ù‡ÙŠÙƒÙ„) Ù„Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯.</div>
                </div>
                <button class="btn btn-outline" id="btnAddVinRow" type="button"><i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ù‡ÙŠÙƒÙ„</button>
              </div>

              <div class="table-wrap" style="margin-top:10px">
                <table>
                  <thead>
                    <tr>
                      <th style="width:44px">Ù…</th>
                      <th style="min-width:170px">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</th>
                      <th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                      <th>Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                      <th style="min-width:160px">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                      <th style="width:54px"></th>
                    </tr>
                  </thead>
                  <tbody id="vinTbody"></tbody>
                </table>
              </div>
            </div>
            <div>
              <label>Ø¥Ù„Ù‰ (Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯ Ù„ÙƒÙ„ Ø§Ù„Ù†Ù‚Ù„)</label>
              <select id="toLocation" class="select"></select>

              <div id="issuesBox" style="display:none;margin-top:10px">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª)</label>
                <textarea id="issuesNotes" placeholder="Ù…Ø«Ø§Ù„: Ø®Ø¯ÙˆØ´ Ø¨Ø³ÙŠØ·Ø© / Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹ / â€¦"></textarea>
              </div>

              <div class="hint" id="liveHint" style="margin-top:10px"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3><i class="fa-solid fa-clock-rotate-left" style="color:var(--beige)"></i> Ø³Ø¬Ù„ Ø¢Ø®Ø± Ø§Ù„Ø­Ø±ÙƒØ§Øª</h3>
          <div class="row" style="justify-content:space-between;margin-bottom:8px">
            <span class="hint">Ø¢Ø®Ø± 30 Ø­Ø±ÙƒØ© (Ù…Ù† Ù†ÙØ³ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©) â€” ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</span>
            <button class="btn btn-ghost" id="btnRefresh"><i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„ÙˆÙ‚Øª</th>
                  <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</th>
                  <th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                  <th>Ù…Ù†</th>
                  <th>Ø¥Ù„Ù‰</th>
                  <th>Ù†ÙÙ‘Ø°Ù‡Ø§</th>
                  <th>Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª</th>
                </tr>
              </thead>
              <tbody id="movesTbody"></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal-backdrop">
      <div class="modal">
        <button class="close" id="previewClose" title="Ø¥ØºÙ„Ø§Ù‚"><i class="fa-solid fa-xmark"></i></button>
        <h3><i class="fa-solid fa-table" style="color:var(--beige)"></i> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø·Ù„Ø¨ Ø§Ù„Ù†Ù‚Ù„</h3>
        <p class="hint" style="margin:0 0 10px">Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª + Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ + ØªØ­Ù‚Ù‚ Ø§Ù„Ù‚ÙŠÙˆØ¯.</p>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Ù…</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</th>
                <th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                <th>Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                <th>Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              </tr>
            </thead>
            <tbody id="previewTbody"></tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost" id="previewCancel">Ø¥ØºÙ„Ø§Ù‚</button>
          <button class="btn btn-primary" id="previewExecute"><i class="fa-solid fa-right-left"></i> ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‚Ù„</button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast">ØªÙ…</div>

  </main>
</div>

<script src="./mzj-ui.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, onSnapshot, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const STATE_REF = doc(db, "mzj_admin_state", "v1");

  const ROLE_ADMIN = 'Ø§Ù„Ø§Ø¯Ø§Ø±Ø©';
  const ROLE_IDARI = 'Ø§Ø¯Ø§Ø±ÙŠ';
  const PAGE_ALLOWED_ROLES = [ROLE_ADMIN, ROLE_IDARI];

  const FIXED_LOCATIONS = [
    "Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"
  ];

  const $ = (s)=> document.querySelector(s);

  const connDot  = $('#connDot');
  const connText = $('#connText');

  const authGate = $('#authGate');
  const appRoot  = $('#app');
  const btnSignOut = $('#btnSignOut');

  const emailEl = $('#email');
  const passEl  = $('#password');
  const btnLogin = $('#btnLogin');
  const btnSignup= $('#btnSignup');
  const authHint = $('#authHint');

  const vinTbody = $('#vinTbody');
  const btnAddVinRow = $('#btnAddVinRow');
  const toLocation  = $('#toLocation');
  const issuesBox   = $('#issuesBox');
  const issuesNotes = $('#issuesNotes');
  const liveHint    = $('#liveHint');
  const vinCount    = $('#vinCount');

  const btnClear = $('#btnClear');
  const btnOpenPreview = $('#btnOpenPreview');
  const btnExecute = $('#btnExecute');
  const btnRefresh = $('#btnRefresh');

  const previewModal = $('#previewModal');
  const previewTbody = $('#previewTbody');
  const previewClose = $('#previewClose');
  const previewCancel= $('#previewCancel');
  const previewExecute = $('#previewExecute');

  const movesTbody = $('#movesTbody');
  const toast = $('#toast');

  // Helpers
  const clean = (v)=> String(v ?? '')
    .replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069]/g,'')
    .replace(/\s+/g,' ')
    .trim();

  function normalizeVin(v){
    if(!v) return '';
    const ar = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
    return v.toString().trim().split('').map(ch=> ar[ch] ?? ch).join('').toUpperCase();
  }

  const pad = n => n<10 ? '0'+n : String(n);
  const nowStamp = ()=>{
    const d = new Date();
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  };
  const onlyDate = (s)=> (s||'').toString().slice(0,10);

  function liftNoFlash(){
    const nf = document.getElementById('noFlash');
    if(nf) nf.remove();
    document.body.style.opacity = '1';
  }

  function setStatus(mode, txt){
    connDot.className = 'dot ' + (mode==='ok'?'ok':mode==='err'?'err':'warn');
    connText.textContent = txt;
  }

  function toastMsg(text){
    toast.textContent = text;
    toast.classList.add('show');
    setTimeout(()=> toast.classList.remove('show'), 1800);
  }

  function parseVins(){
    const inputs = Array.from(vinTbody.querySelectorAll('input.vin-input'));
    const lines = inputs
      .map(inp => normalizeVin(inp.value))
      .map(s => clean(s))
      .filter(Boolean);
    const uniq = [];
    const seen = new Set();
    for(const v of lines){
      if(!seen.has(v)) { seen.add(v); uniq.push(v); }
    }
    return uniq;
  }

  function updateUICounts(){
    const list = parseVins();
    vinCount.textContent = String(list.length);
  }

  function updateIssuesBox(){
    const toVal = clean(toLocation.value);
    const isIssues = /Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª/.test(toVal);
    issuesBox.style.display = isIssues ? 'block' : 'none';
    if(!isIssues) issuesNotes.value = '';
  }


  // VIN Table (one VIN per row)
  function renumberVinRows(){
    const trs = Array.from(vinTbody.querySelectorAll('tr'));
    trs.forEach((tr,i)=>{
      const n = tr.querySelector('[data-col="n"]');
      if(n) n.textContent = String(i+1);
    });
  }

  function fillVinRow(tr, vin){
    const cellCar = tr.querySelector('[data-col="car"]');
    const cellFrom = tr.querySelector('[data-col="from"]');
    const cellNotes = tr.querySelector('[data-col="notes"]');

    if(!vin){
      cellCar.textContent = '';
      cellFrom.textContent = '';
      cellNotes.textContent = '';
      tr.classList.remove('row-bad');
      return;
    }

    const rec = (stateCache.stock || []).find(r => normalizeVin(r?.vin) === vin);
    if(!rec){
      cellCar.textContent = 'â€”';
      cellFrom.textContent = 'â€”';
      cellNotes.textContent = '';
      tr.classList.add('row-bad');
      return;
    }
    tr.classList.remove('row-bad');
    cellCar.textContent = rec.car || '';
    cellFrom.textContent = rec.location || '';
    cellNotes.textContent = rec.notes || '';
  }

  function refreshAllVinRows(){
    const trs = Array.from(vinTbody.querySelectorAll('tr'));
    trs.forEach(tr=>{
      const inp = tr.querySelector('input.vin-input');
      const v = normalizeVin(inp?.value || '');
      fillVinRow(tr, clean(v));
    });
  }

  function addVinRow(initialVin=''){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td data-col="n" class="nowrap"></td>
      <td><input class="input vin-input" placeholder="VIN" value="${initialVin || ''}" /></td>
      <td data-col="car"></td>
      <td data-col="from"></td>
      <td data-col="notes"></td>
      <td class="nowrap"><button class="btn btn-ghost btn-del" type="button" title="Ø­Ø°Ù"><i class="fa-solid fa-trash"></i></button></td>
    `;
    vinTbody.appendChild(tr);
    renumberVinRows();

    const inp = tr.querySelector('input.vin-input');
    const del = tr.querySelector('.btn-del');

    const refresh = ()=>{
      const v = normalizeVin(inp.value);
      // keep displayed value normalized (but don't annoy while typing)
      fillVinRow(tr, clean(v));
      updateUICounts();
    };

    inp.addEventListener('input', refresh);
    inp.addEventListener('blur', ()=>{ inp.value = normalizeVin(inp.value); refresh(); });

    del.addEventListener('click', ()=>{
      tr.remove();
      if(!vinTbody.querySelector('tr')) addVinRow('');
      renumberVinRows();
      updateUICounts();
    });

    // initial fill
    refresh();
    return tr;
  }

  function resetVinTable(){
    vinTbody.innerHTML = '';
    addVinRow('');
    updateUICounts();
  }

  // Roles
  async function fetchUserRole(user){
    try{
      const snap = await getDoc(doc(db, 'user', user.uid));
      if(snap.exists()){
        const d = snap.data() || {};
        return d.role || null;
      }
    }catch(e){
      console.error('Error fetching role', e);
    }
    return null;
  }

  // Render moves (last 30)
  function renderMovesTable(moves){
    const rows = (Array.isArray(moves)? moves: [])
      .slice()
      .sort((a,b)=> clean(b.when||'').localeCompare(clean(a.when||'')))
      .slice(0,30);

    movesTbody.innerHTML = '';
    if(!rows.length){
      movesTbody.innerHTML = '<tr><td colspan="7" class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ø¨Ø¹Ø¯.</td></tr>';
      return;
    }

    for(const m of rows){
      const okA = m.adminApproved === true;
      const okF = m.financeApproved === true;
      const stateTxt = (okA && okF) ? 'âœ… Ù…ÙƒØªÙ…Ù„Ø©' : (okA || okF) ? 'ğŸŸ¡ Ø¬Ø²Ø¦ÙŠØ©' : 'â€”';
      const tr = document.createElement('tr');
      const who = (m.performedBy || m.by || m.user || m.userEmail || '').toString();
      tr.innerHTML = `
        <td class="nowrap">${m.when || ''}</td>
        <td class="nowrap">${m.vin || ''}</td>
        <td>${m.car || ''}</td>
        <td>${m.from || ''}</td>
        <td>${m.to || ''}</td>
        <td class="nowrap">${who || 'â€”'}</td>
        <td>${stateTxt}</td>
      `;
      movesTbody.appendChild(tr);
    }
  }

  // Load / Subscribe state
  let stateCache = { stock: [], moves: [] };
  let unsub = null;
  let isExecuting = false;

  async function loadOnce(){
    const snap = await getDoc(STATE_REF);
    const d = snap.exists() ? (snap.data()||{}) : {};
    stateCache.stock = Array.isArray(d.stock) ? d.stock : [];
    stateCache.moves = Array.isArray(d.moves) ? d.moves : [];
    renderMovesTable(stateCache.moves);
    refreshAllVinRows();
  }

  function subscribe(){
    if(unsub) { try{unsub();}catch(e){} }
    unsub = onSnapshot(STATE_REF, (snap)=>{
      if(!snap.exists()) return;
      // Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ†ÙÙŠØ°: Ù„Ø§ Ù†Ø¹Ù…Ù„ overwrite Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠØ­ØµÙ„Ø´ Ø±Ø¬ÙˆØ¹ ÙÙŠ UI)
      if(isExecuting) return;
      const d = snap.data() || {};
      stateCache.stock = Array.isArray(d.stock) ? d.stock : stateCache.stock;
      stateCache.moves = Array.isArray(d.moves) ? d.moves : stateCache.moves;
      renderMovesTable(stateCache.moves);
      refreshAllVinRows();
      setStatus('ok','Ù…ØªØµÙ„ â€” Ù…Ø²Ø§Ù…Ù†Ø© Ø­ÙŠÙ‘Ø©');
    }, (err)=>{
      console.warn('snapshot error', err);
      setStatus('warn','ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ â€” Ù…Ø²Ø§Ù…Ù†Ø© Ù…ØªÙˆÙ‚ÙØ© Ù…Ø¤Ù‚ØªÙ‹Ø§');
    });
  }

  function fillLocations(){
    toLocation.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯</option>' + FIXED_LOCATIONS.map(l=>`<option value="${l}">${l}</option>`).join('');
  }

  // Preview builder
  function buildPreviewRows(toVal, vins, stock, moves){
    const goingIssues = /Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª/.test(toVal);
    const goingUnderDelivery = /Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…/.test(toVal);
    const goingDelivered = /Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…/.test(toVal);

    const issuesTxt = goingIssues ? clean(issuesNotes.value) : '';

    const out = [];
    for(const vin of vins){
      const rec = stock.find(r => normalizeVin(r?.vin) === vin);
      if(!rec){
        out.push({ vin, car:'â€”', from:'â€”', to:toVal, ok:false, msg:'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†' });
        continue;
      }

      const from = clean(rec.location || '');
      if(!from){
        out.push({ vin, car: rec.car || '', from:'â€”', to:toVal, ok:false, msg:'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙƒØ§Ù† Ø­Ø§Ù„ÙŠ Ù…Ø­ÙÙˆØ¸' });
        continue;
      }
      if(from === toVal){
        out.push({ vin, car: rec.car || '', from, to:toVal, ok:false, msg:'Ù†ÙØ³ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ' });
        continue;
      }

      if(goingIssues && !issuesTxt){
        out.push({ vin, car: rec.car || '', from, to:toVal, ok:false, msg:'Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ø·Ù„ÙˆØ¨Ø© (Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª)' });
        continue;
      }

      if(goingDelivered){
        const adminOk   = (rec.adminApproved===true || rec.adminApproval===true || rec.adminApproved==='true' || rec.adminApproval==='true');
        const financeOk = (rec.financeApproved===true || rec.financeApproval===true || rec.financeApproved==='true' || rec.financeApproval==='true');
        if(!(adminOk && financeOk)){
          out.push({ vin, car: rec.car || '', from, to:toVal, ok:false, msg:'Ù…Ù…Ù†ÙˆØ¹: Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ø§Ù„ÙŠØ© ÙˆØ¥Ø¯Ø§Ø±ÙŠØ© Ù…ÙƒØªÙ…Ù„Ø© (Ù…Ù† Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯)' });
          continue;
        }
      }

      out.push({ vin, car: rec.car || '', from, to:toVal, ok:true, msg:'Ø¬Ø§Ù‡Ø² Ù„Ù„Ù†Ù‚Ù„' });
    }
    return out;
  }

  function openPreview(){
    const toVal = clean(toLocation.value);
    const vins = parseVins();

    if(!vins.length){ toastMsg('Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ù‡ÙŠÙƒÙ„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }
    if(!toVal){ toastMsg('Ø§Ø®ØªØ± Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£ÙˆÙ„Ø§Ù‹'); return; }

    const rows = buildPreviewRows(toVal, vins, stateCache.stock, stateCache.moves);

    previewTbody.innerHTML = '';
    rows.forEach((r, idx)=>{
      const tr = document.createElement('tr');
      const st = r.ok ? `<span class="ok">âœ… ${r.msg}</span>` : `<span class="bad">âš ï¸ ${r.msg}</span>`;
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td class="nowrap">${r.vin}</td>
        <td>${r.car || ''}</td>
        <td>${r.from || ''}</td>
        <td>${r.to || ''}</td>
        <td>${st}</td>
      `;
      previewTbody.appendChild(tr);
    });

    const okCount = rows.filter(r=>r.ok).length;
    const badCount = rows.length - okCount;
    liveHint.innerHTML = `Ø¬Ø§Ù‡Ø² Ù„Ù„Ù†Ù‚Ù„: <b class="ok">${okCount}</b> â€” ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ†ÙÙŠØ°: <b class="bad">${badCount}</b>`;

    previewModal.style.display = 'flex';
  }

  function closePreview(){
    previewModal.style.display = 'none';
  }

  // Execute (Transaction-based)
  async function executeMove(){
    const toVal = clean(toLocation.value);
    const vins = parseVins();
    const goingIssues = /Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª/.test(toVal);
    const goingUnderDelivery = /Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…/.test(toVal);
    const goingDelivered = /Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…/.test(toVal);

    const issuesTxt = goingIssues ? clean(issuesNotes.value) : '';

    if(!vins.length){ toastMsg('Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ù‡ÙŠÙƒÙ„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }
    if(!toVal){ toastMsg('Ø§Ø®ØªØ± Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£ÙˆÙ„Ø§Ù‹'); return; }
    if(goingIssues && !issuesTxt){ toastMsg('Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ø·Ù„ÙˆØ¨Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª'); return; }

    isExecuting = true;
    setStatus('warn','Ø¬Ø§Ø±Ù ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‚Ù„â€¦');

    try{
      const result = await runTransaction(db, async (tx)=>{
        const snap = await tx.get(STATE_REF);
        const d = snap.exists() ? (snap.data()||{}) : {};

        const stock = Array.isArray(d.stock) ? d.stock.slice() : [];
        const moves = Array.isArray(d.moves) ? d.moves.slice() : [];

        const rows = buildPreviewRows(toVal, vins, stock, moves);
        const executable = rows.filter(r=>r.ok);

        if(!executable.length){
          return { moved:0, errors: rows.filter(r=>!r.ok).map(r=>`${r.vin}: ${r.msg}`), okLines:[] };
        }

        const stamp = nowStamp();
        const date  = onlyDate(stamp);

        let moved = 0;
        const okLines = [];
        const errors = rows.filter(r=>!r.ok).map(r=>`${r.vin}: ${r.msg}`);

        for(const r of executable){
          const idx = stock.findIndex(x => normalizeVin(x?.vin) === r.vin);
          if(idx === -1){
            errors.push(`${r.vin}: ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†`);
            continue;
          }

          const rec = { ...(stock[idx]||{}) };
          const oldLoc = clean(rec.location || r.from || '');

          // Ù‚ÙŠØ¯ Ø¥Ø¶Ø§ÙÙŠ: Ù„Ùˆ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ ÙØ§Ø¶ÙŠ (Ø­Ù…Ø§ÙŠØ©)
          if(!oldLoc){
            errors.push(`${r.vin}: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙƒØ§Ù† Ø­Ø§Ù„ÙŠ Ù…Ø­ÙÙˆØ¸`);
            continue;
          }

          // Ù…Ù†Ø·Ù‚ Ø¬Ø¯ÙŠØ¯: Ù„Ùˆ Ø§Ø®ØªØ±Øª (Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…)
          // Ù†Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙØ¹Ù„ÙŠÙ‹Ø§ Ø¥Ù„Ù‰ (ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…)ØŒ ÙˆÙ†ÙÙ†Ø´Ø¦ Ø·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø¯Ø§Ø®Ù„ moves Ø¥Ù„Ù‰ (Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…)
          const isUnderDelivery = /Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…/.test(toVal);
          const deliveredLocForApproval = isUnderDelivery ? toVal.replace('Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…','Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…') : '';

          // ØªØ­Ø¯ÙŠØ« Ù…ÙƒØ§Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ø§Ù„ÙØ¹Ù„ÙŠØ©)
          rec.location = toVal;

          // Ù„Ùˆ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…: ØµÙÙ‘Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø© (ØªØ¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯)
          if(isUnderDelivery){
            rec.adminApproved = false; rec.adminApproval = false;
            rec.financeApproved = false; rec.financeApproval = false;
            try{ delete rec.adminApprovedAt; }catch(_e){}
            try{ delete rec.financeApprovedAt; }catch(_e){}
            // Ù„Ø§ Ù†Ù…Ø³Ø­ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© notesØŒ Ù„ÙƒÙ† Ù†Ù…Ø³Ø­ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©
            rec.adminNotes = '';
            rec.financeNotes = '';
          }

          // Ù…Ù„Ø§Ø­Ø¸Ø© Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª: Ù†Ø¶ÙŠÙÙ‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø©
          if(goingIssues && issuesTxt){
            const existing = clean(rec.notes || '');
            rec.notes = existing ? `${existing} â€” ${issuesTxt}` : issuesTxt;
          }

          stock[idx] = rec;

          // Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ© / Ø£Ùˆ Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª (Ø­Ø³Ø¨ Ø§Ù„Ù…ÙƒØ§Ù†)
          const cu = auth.currentUser;
          const performedBy = cu?.email || '';
          const performedByUid = cu?.uid || '';

          const isUnderDelivery2 = /Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…/.test(toVal);
          if(isUnderDelivery2){
            // 1) Ø³Ø¬Ù„ Ø­Ø±ÙƒØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ (Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…)
            moves.push({
              when: stamp,
              date,
              vin: rec.vin || r.vin,
              car: rec.car || r.car || '',
              from: oldLoc,
              to: toVal,
              id: rec.id ?? null,
              action: 'move_to_under_delivery',
              performedBy,
              performedByUid
            });

            // 2) Ø·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚Ø§Øª ÙŠØ¸Ù‡Ø± ÙÙŠ ÙƒØ§Ø±Øª (Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©) Ø¨Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯
            moves.push({
              when: stamp,
              date,
              requestedAt: stamp,
              createdAt: stamp,
              vin: rec.vin || r.vin,
              car: rec.car || r.car || '',
              from: toVal, // Ù…Ù† ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…
              to: deliveredLocForApproval,
              id: rec.id ?? null,
              status: 'awaiting_approvals',
              requiresAdminApproval: true,
              requiresFinanceApproval: true,
              adminApproved: null,
              financeApproved: null,
              adminNote: '',
              financeNote: '',
              message: 'Ø·Ù„Ø¨ Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… â€” Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©',
              performedBy,
              performedByUid
            });
          }else{
            // Ø­Ø±ÙƒØ© Ù†Ù‚Ù„ Ø¹Ø§Ø¯ÙŠØ©
            moves.push({
              when: stamp,
              date,
              vin: rec.vin || r.vin,
              car: rec.car || r.car || '',
              from: oldLoc,
              to: toVal,
              id: rec.id ?? null,
              adminApproved: null,
              financeApproved: null,
              issuesNotes: goingIssues ? issuesTxt : '',
              performedBy,
              performedByUid
            });
          }

          moved++;
          okLines.push(`ØªÙ… Ù†Ù‚Ù„ ${rec.car||''} (${rec.vin||r.vin}) Ù…Ù† "${oldLoc}" Ø¥Ù„Ù‰ "${toVal}"`);
        }

        tx.update(STATE_REF, { stock, moves });
        return { moved, errors, okLines };
      });

      // reload snapshot after tx
      await loadOnce();

      if(!result.moved){
        const msg = result.errors?.[0] || 'Ù„Ù… ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ø£ÙŠ Ø­Ø±ÙƒØ© Ù†Ù‚Ù„';
        toastMsg(msg);
        liveHint.innerHTML = `<span class="bad">âš ï¸ ${msg}</span>`;
      }else{
        const msg = `ØªÙ… Ù†Ù‚Ù„ ${result.moved} Ø³ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­`;
        toastMsg(msg);
        const extra = (result.errors && result.errors.length) ? `<br><span class="hint">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${result.errors.length} Ø­Ø±ÙƒØ§Øª Ù„Ù… ØªÙÙ†ÙØ°</span>` : '';
        liveHint.innerHTML = `<span class="ok">âœ… ${msg}</span>${extra}`;
      }

      // reset inputs (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      resetVinTable();
      issuesNotes.value = '';
      updateUICounts();
      closePreview();

      setStatus('ok','ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‚Ù„');
    }catch(e){
      console.error(e);
      toastMsg('ØªØ¹Ø°Ù‘Ø± ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‚Ù„ (Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸)');
      setStatus('err','Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ù‚Ù„');
    }finally{
      isExecuting = false;
      // Ø§Ø´ØªØºÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ØªØ§Ù†ÙŠ
      setTimeout(()=> setStatus('ok','Ù…ØªØµÙ„ â€” Ù…Ø²Ø§Ù…Ù†Ø© Ø­ÙŠÙ‘Ø©'), 400);
    }
  }

  // Events
  btnAddVinRow.addEventListener('click', ()=>{ addVinRow(''); });

    toLocation.addEventListener('change', ()=>{ updateIssuesBox(); });

  btnClear.addEventListener('click', ()=>{
    resetVinTable();
    toLocation.value = '';
    issuesNotes.value = '';
    issuesBox.style.display = 'none';
    liveHint.textContent = '';
    updateUICounts();
    toastMsg('ØªÙ… Ø§Ù„Ù…Ø³Ø­');
  });

  btnOpenPreview.addEventListener('click', openPreview);
  btnExecute.addEventListener('click', executeMove);
  previewExecute.addEventListener('click', executeMove);

  previewClose.addEventListener('click', closePreview);
  previewCancel.addEventListener('click', closePreview);
  previewModal.addEventListener('click', (e)=>{ if(e.target === previewModal) closePreview(); });

  btnRefresh.addEventListener('click', async ()=>{
    await loadOnce();
    toastMsg('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
  });

  // Auth
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      const role = await fetchUserRole(user);
      if(!role || !PAGE_ALLOWED_ROLES.includes(role)){
        window.location.href = 'unauthorized.html';
        return;
      }

      authGate.style.display='none';
      appRoot.style.display='block';
      btnSignOut.style.display='inline-flex';
      setStatus('ok', `Ù…ØªØµÙ„ ÙƒÙ…Ø³ØªØ®Ø¯Ù…: ${user.email} â€” Ø§Ù„Ø¯ÙˆØ±: ${role}`);
      liftNoFlash();

      fillLocations();
      resetVinTable();
      updateIssuesBox();

      await loadOnce();
      subscribe();
    }else{
      appRoot.style.display='none';
      authGate.style.display='grid';
      btnSignOut.style.display='none';
      setStatus('warn','Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
      liftNoFlash();
    }
  });

  btnLogin.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{
      await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
    }catch(e){
      authHint.textContent='ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: '+(e?.message||e);
    }
  });
  btnSignup.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{
      await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
    }catch(e){
      authHint.textContent='ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: '+(e?.message||e);
    }
  });
  btnSignOut.addEventListener('click', ()=> signOut(auth));

  setStatus('warn','Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦');
</script>
</body>
</html>
