




<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<link rel="icon" type="image/x-icon" href="assets/favicon.png">
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª â€” MZJ Cars</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<style>
  :root{
    --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280;
    --line:#e5e7eb; --line-strong:#d1d5db; --table-head:#fafafa;
    --card:#fff; --radius:14px; --ok:#16a34a; --danger:#ef4444; --info:#0ea5e9;
    --shadow:0 10px 24px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,Arial}

  /* Topbar + tabs + auth badge */
  .topbar{position:sticky;top:0;z-index:1000;background:#fff;border-bottom:1px solid var(--line)}
  .topbar-inner{max-width:1240px;margin:auto;display:flex;align-items:center;justify-content:space-between;padding:10px 16px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brown),#2a1613);
    display:grid;place-items:center;color:#fff;font-weight:800}
  .brand h1{margin:0;font-size:18px;color:var(--brown)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;text-decoration:none;color:inherit;font-weight:800;font-size:13px}
  .tab.active{background:var(--brown);border-color:var(--brown);color:#fff}
  .status-badge{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#fff;border-radius:12px;padding:6px 10px;font-size:12px}
  .dot{width:10px;height:10px;border-radius:999px;background:#f59e0b}
  .dot.ok{background:var(--ok)} .dot.err{background:var(--danger)} .dot.warn{background:#f59e0b}

  /* Buttons */
  .btn{position:relative;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:700;display:inline-flex;gap:8px;align-items:center;transition:.15s;font-size:13px}
  .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
  .btn-primary{background:var(--brown);border-color:var(--brown);color:#fff}
  .btn-beige{background:var(--beige);border-color:var(--beige);color:#fff}
  .btn-ghost{background:#fff}
  .btn-danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .btn-outline{background:#fff;border:1px solid var(--brown);color:var(--brown)}

  /* Layout */
  .container{max-width:1240px;margin:18px auto;padding:0 16px 48px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
  .section-title{display:flex;align-items:center;gap:8px;margin:0}
  .section-title svg{width:20px;height:20px;color:var(--brown)}
  .hint{color:var(--muted);font-size:12px}

  /* Grid */
  .grid{display:grid;gap:12px}
  .grid-4{grid-template-columns:repeat(4,1fr)}
  .grid-3{grid-template-columns:repeat(3,1fr)}
  .grid-2{grid-template-columns:repeat(2,1fr)}
  @media (max-width:1080px){ .grid-4{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:860px){ .grid-4,.grid-3{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:620px){ .grid-4,.grid-3,.grid-2{grid-template-columns:1fr} }
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  /* Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„: ØµÙÙˆÙ Ù…ØªØ¹Ø¯Ø¯Ø© */
  .move-row{border:1px dashed #e5e7eb;border-radius:10px;padding:8px 10px;background:#fffbf7}
  .move-row-title{font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:600}

  /* Ø¥Ø´Ø¹Ø§Ø± Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„ */
  .move-alert{
    margin-top:10px;
    padding:10px 12px;
    border-radius:12px;
    display:none;
    align-items:flex-start;
    gap:10px;
    font-size:13px;
  }
  .move-alert .icon{
    margin-top:3px;
    font-size:16px;
  }
  .move-alert .title{
    font-weight:800;
    margin-bottom:4px;
    font-size:13.5px;
  }
  .move-alert ul{
    margin:0;
    padding-right:18px;
    list-style:disc;
  }
  .move-alert.success{
    background:#ecfdf3;
    border:1px solid #bbf7d0;
    color:#14532d;
  }
  .move-alert.error{
    background:#fef2f2;
    border:1px solid #fecaca;
    color:#991b1b;
  }
  .move-alert.info{
    background:#eff6ff;
    border:1px solid #bfdbfe;
    color:#1d4ed8;
  }

  .copyable{cursor:pointer;text-decoration:underline;text-decoration-style:dotted}

  .move-row-title{
    font-weight:600;
    margin-bottom:4px;
    color:var(--brown);
  }
  .move-notes{
    width:100%;
    min-height:48px;
    resize:vertical;
  }

  .notes-col{
    display:none;
  }

  /* Ø¨Ø·Ø§Ù‚Ø© Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© */
  .table-like{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px 12px;font-size:13px}
  .table-like b{color:var(--brown);}

  /* Auth */
  .auth-wrap{min-height:60vh;display:grid;place-items:center;padding:24px}
  .auth-card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:18px;max-width:420px;width:96%}
  .auth-card h2{margin:0 0 10px;color:var(--brown)}
  .auth-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  label{font-weight:800;margin-bottom:6px;display:block;color:var(--brown);font-size:13px}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;outline:none;transition:.15s;font-family:"Tajawal",system-ui,Arial;font-size:13px}
  input:focus,select:focus,textarea:focus{border-color:var(--beige);box-shadow:0 0 0 3px rgba(188,143,116,.15)}

  /* Toast */
  .toast{position:fixed;bottom:16px;right:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.25);display:none;z-index:60;font-size:13px}
  .toast.ok{background:var(--ok)} .toast.info{background:var(--info)} .toast.err{background:var(--danger)}

  /* Checklist box (Ù„Ùˆ Ø§Ø­ØªØ¬ØªÙ‡Ø§ Ù…Ø³ØªÙ‚Ø¨Ù„Ù‹Ø§) */
  .checklist{border:1px dashed var(--beige);border-radius:12px;padding:12px;background:#fff8ef}
  .checklist h4{margin:0 0 8px 0;color:var(--brown);font-size:14px}
  .check-row{display:grid;grid-template-columns:18px 1fr;gap:8px;align-items:start}
  .check-row label{margin:0;display:flex;align-items:center;gap:8px;font-weight:600;font-size:13px}
</style>
<style id="noFlash">
  html{background:#fff8ef;}
  body{opacity:0;}
</style>
  <link rel="stylesheet" href="./mzj-ui.css" />

<style>
  /* ===== VT Safe Refactor: hide legacy topbar/tabs (keep DOM for JS) ===== */
  .legacy-vt .topbar,
  .legacy-vt .tabs,
  .legacy-vt .nav-tabs,
  .legacy-vt .header,
  .legacy-vt header:not(.mzj-topbar){display:none !important;}
  .legacy-vt{padding-top: 6px;}
</style>

</head>
<body class="mzj">

  <!-- MZJ Unified Topbar -->
  <header class="mzj-topbar">
    <div class="topbar-left">
      <button class="icon-btn" id="mzjSidebarBtn" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"><i class="fa-solid fa-bars"></i></button>
      <div class="brand">
        <div class="brand-mark">MZJ</div>
        <div class="brand-text">
          <div class="brand-title">Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</div>
          <div class="brand-sub">Workspace</div>
        </div>
      </div>
    </div>
    <div class="topbar-center">
      <div class="mzj-breadcrumb">
        <span class="crumb">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        <i class="fa-solid fa-chevron-left"></i>
        <span class="crumb current">Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span>
      </div>
    </div>
    <div class="topbar-right">
      <div class="mzj-chip"><i class="fa-regular fa-clock"></i><span id="mzjNow">â€”</span></div>
      <button class="mzj-btn mzj-btn-ghost" id="mzjThemeBtn" type="button"><i class="fa-solid fa-moon"></i><span>ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ</span></button>
      <div class="mzj-user">
        <div class="avatar">VT</div>
        <div class="user-text">
          <div class="user-name">Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</div>
          <div class="user-role">Operations</div>
        </div>
      </div>
    </div>
  </header>

  <div class="mzj-shell" id="mzjShell">
    <aside class="mzj-sidebar" id="mzjSidebar">
      <div class="side-section">
        <div class="side-title">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
        <nav class="side-nav">
          <a class="side-link tab" href="./sales.html"><i class="fa-solid fa-handshake"></i><span>ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span></a>
        <a class="side-link tab" href="./dashboard.html"><i class="fa-solid fa-gauge"></i><span>Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</span></a>
        <a class="side-link tab" href="./inventory.html"><i class="fa-solid fa-boxes-stacked"></i><span>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span></a>
        <a class="side-link tab active" href="./vt.html"><i class="fa-solid fa-right-left"></i><span>Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span></a>
        <a class="side-link tab" href="./photoshoot-user.html"><i class="fa-solid fa-camera"></i><span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span></a>
        <a class="side-link tab" href="./cars.html"><i class="fa-solid fa-car"></i><span>ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</span></a>
        <a class="side-link tab" href="./admin.html"><i class="fa-solid fa-shield-halved"></i><span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span></a>
        <a class="side-link tab" href="./Activity.html"><i class="fa-solid fa-clipboard-list"></i><span>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</span></a>
        <a class="side-link tab" href="./act.html"><i class="fa-solid fa-clipboard-list"></i><span>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</span></a>

        </nav>
      </div>
    </aside>

    <div class="mzj-backdrop" id="mzjBackdrop"></div>

    <main class="mzj-content">
      <section class="mzj-pagehead">
        <div class="pagehead-left">
          <h1 class="page-title">Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h1>
          <p class="page-desc">Ù†ÙØ³ Ø§Ù„Ø¯Ø§ØªØ§ ÙˆØ§Ù„Ù…Ù†Ø·Ù‚ â€” ÙˆØ§Ø¬Ù‡Ø© Ù…ÙˆØ­Ù‘Ø¯Ø©.</p>
        </div>
      </section>

      <div class="legacy legacy-vt">

<!-- Topbar -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo" title="MZJ">MZJ</div>
      <div>
        <h1>Ù„ÙˆØ­Ø© Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h1>
        <small class="hint">Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</small>
      </div>
    </div>
    <div class="tabs">
      <a class="tab" href="admin.html">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
      <a class="tab" href="inventory.html">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</a>
      <a class="tab" href="dashboard.html">Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</a>
      <a class="tab active" href="vt.html">Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</a>
      <a class="tab" href="photoshoot-user.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
      <a class="tab" href="cars.html">ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</a>
      <a class="tab" href="Activity.html">Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</a>
    </div>
    <div class="row">
      <div class="status-badge"><span class="dot warn" id="connDot"></span><span id="connText">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦</span></div>
      <button class="btn btn-ghost" id="btnSignOut" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
</div>

<!-- Auth Gate -->
<div class="auth-wrap" id="authGate">
  <div class="auth-card">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
    <input id="email" placeholder="you@example.com" type="email"/>
    <label for="password" style="margin-top:8px">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
    <input id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" type="password"/>
    <div class="auth-actions">
      <button class="btn btn-primary" id="btnLogin">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button class="btn btn-outline" id="btnSignup">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    </div>
    <p class="hint" id="authHint" style="margin-top:10px"></p>
  </div>
</div>

<!-- App -->
<div id="app" style="display:none">
  <div class="container">
    <div class="card">
      <div class="card-header">
        <div class="section-title">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 10l5-5 5 5"></path><path d="M7 14l5 5 5-5"></path></svg>
          <h2 style="margin:0">Ø­Ø±ÙƒØ© Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª (Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„)</h2>
        </div>
        <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap">
          <label style="margin:0">Ø¥Ù„Ù‰</label>
          <select id="moveToGlobal" title="Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯"></select>
        </div>
      </div>

      <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© ØµÙÙˆÙ Ù†Ù‚Ù„ -->
      <div class="row" style="margin:8px 0 12px;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn btn-ghost" id="btnAddMoveRow" type="button">
          <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© Ø£Ø®Ø±Ù‰
        </button>
      </div>

      <!-- ØµÙÙˆÙ Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© -->
      <div class="grid" id="moveRowsContainer" style="gap:10px"></div>

      <!-- datalist Ù„Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª -->
      <datalist id="vinHints"></datalist>

      <!-- Checklist Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ… (Ù…Ø®ÙÙŠØ© Ø­Ø§Ù„ÙŠÙ‹Ø§ - Ù…Ù…ÙƒÙ† ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§ Ù…Ø³ØªÙ‚Ø¨Ù„Ù‹Ø§) -->
      <div class="checklist" id="underDeliveryBox" style="display:none; margin-top:10px">
        <h4>Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ <b>Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</b></h4>
        <div class="grid grid-2">
          <div>
            <div class="check-row">
              <input id="chkAdminApproved" type="checkbox"/>
              <label for="chkAdminApproved">Ù…ÙˆØ§ÙÙ‚Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©</label>
            </div>
            <label for="adminNotes" style="margin-top:6px">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</label>
            <textarea id="adminNotes" placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©â€¦"></textarea>
          </div>
          <div>
            <div class="check-row">
              <input id="chkFinanceApproved" type="checkbox"/>
              <label for="chkFinanceApproved">Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ø§Ù„ÙŠØ©</label>
            </div>
            <label for="financeNotes" style="margin-top:6px">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</label>
            <textarea id="financeNotes" placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø§Ù„ÙŠØ©â€¦"></textarea>
          </div>
        </div>
      </div>

      <!-- Ø£Ø²Ø±Ø§Ø± ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø±ÙƒØ© -->
      <div class="row" style="margin-top:12px">
        <button class="btn btn-ghost" id="btnFindByVin" title="Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ø£ÙˆÙ„ Ø³Ø·Ø± ØºÙŠØ± ÙØ§Ø±Øº)">
          <i class="fa-solid fa-magnifying-glass"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
        <button class="btn btn-primary" id="btnMove" title="ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‚Ù„">
          <i class="fa-solid fa-right-left"></i> Ù†Ù‚Ù„
        </button>
      </div>
      <p class="hint" id="moveStatus" style="margin-top:8px"></p>

      <!-- Ø¥Ø´Ø¹Ø§Ø± Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„ÙƒØ¨ÙŠØ± -->
      <div class="move-alert" id="moveAlert">
        <div class="icon">
          <i class="fa-solid fa-circle-check"></i>
        </div>
        <div>
          <div class="title" id="moveAlertTitle">Ù†ØªÙŠØ¬Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„</div>
          <ul id="moveAlertList"></ul>
        </div>
      </div>

      <!-- Ø¨Ø·Ø§Ù‚Ø© Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
      <div class="card" id="carDetailsBox" style="display:none;margin-top:12px">
        <div class="section-title">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect height="16" rx="2" width="18" x="3" y="4"></rect><path d="M7 8h10"></path></svg>
          <h2 style="margin:0">Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h2>
        </div>
        <div class="table-like" id="carDetails" style="margin-top:8px"></div>
        <p class="hint" id="carDetailsHint" style="margin-top:8px"></p>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import {getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, updateDoc} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  // ===== Firestore helpers (ensure persistence works) =====
  const mzjSetDoc = (...args) => setDoc(...args);
  const mzjUpdateDoc = (...args) => updateDoc(...args);


  /* ===== Firebase ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const STATE_REF = doc(db, "mzj_admin_state", "v1");

  /* ===== Roles & Permissions (Firestore) ===== */
  const ROLE_ADMIN   = 'Ø§Ù„Ø§Ø¯Ø§Ø±Ø©';
  const ROLE_IDARI   = 'Ø§Ø¯Ø§Ø±ÙŠ';
  const ROLE_BRANCH  = 'Ù…Ø¯Ø±Ø§Ø¡ ÙØ±ÙˆØ¹';

  // Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø³Ù…ÙˆØ­Ø© Ù„Ù†ÙØ³ ØµÙ„Ø§Ø­ÙŠØ§Øª admin.html (Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø· Ø­Ø§Ù„ÙŠØ§Ù‹)
  const PAGE_ALLOWED_ROLES = [ROLE_ADMIN, ROLE_IDARI];

  // Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ Ù„ÙƒÙ„ Ø¯ÙˆØ± (Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ§Ø¨Ø§Øª)
  const ROLE_PAGES = {
    [ROLE_ADMIN] : 'ALL', // Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ØªØ´ÙˆÙ ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª
    // Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ: ÙŠØ´ÙˆÙ ÙÙ‚Ø· Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ + Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª + Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª + ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
    [ROLE_IDARI] : ['dashboard.html','vt.html','photoshoot-user.html','cars.html','inventory.html','act.html'],
    [ROLE_BRANCH]: ['dashboard.html']
  };

  function applyTabsVisibility(role){
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab=>{
      const href = tab.getAttribute('href') || '';
      const page = (href.split('/').pop() || '').split('?')[0];
      if(!page) return;
      const perm = ROLE_PAGES[role];
      if(!perm){
        tab.style.display = 'none';
        return;
      }
      if(perm === 'ALL') return; // Ø§Ù„Ø¯ÙˆØ± ÙŠØ´ÙˆÙ ÙƒÙ„ Ø­Ø§Ø¬Ø©
      if(!perm.includes(page)){
        tab.style.display = 'none';
      }
    });
  }

  async function fetchUserRole(user){
    try{
      const userDocRef = doc(db, 'user', user.uid);
      const snap = await getDoc(userDocRef);
      if(snap.exists()){
        const data = snap.data() || {};
        return data.role || null;
      }
      return null;
    }catch(err){
      console.error('Error fetching user role:', err);
      return null;
    }
  }

  /* ===== Helpers / State ===== */
  const $ = s => document.querySelector(s);
  const toast = $('#toast');
  function showToast(msg,type='ok'){toast.textContent=msg;toast.className='toast '+type;toast.style.display='block';setTimeout(()=>toast.style.display='none',1800)}
  function pad(n){return n<10?'0'+n:n}
  function now(){const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;}
  function onlyDate(str){return (str||'').toString().slice(0,10)}
  function normalizeVin(v){
    if(!v) return '';
    const ar={'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
    return v.toString().replace(/[Ù -Ù©]/g,d=>ar[d]).toUpperCase().replace(/[\s\-\._]/g,'').trim();
  }
  function debounce(fn,wait=250){let t;return (...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),wait)};}

  let stock=[], moves=[], models=[], variantsMap={};

  function liftNoFlash(){
    const nf = document.getElementById('noFlash');
    if(nf) nf.remove();
    document.body.style.opacity = '1';
  }

  /* ===== DOM refs ===== */
  const connDot=$('#connDot'), connText=$('#connText');
  const authGate=$('#authGate'), appRoot=$('#app'), btnSignOut=$('#btnSignOut');
  const emailEl=$('#email'), passEl=$('#password'), btnLogin=$('#btnLogin'), btnSignup=$('#btnSignup'), authHint=$('#authHint');

  // Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„
  const moveRowsContainer = document.querySelector('#moveRowsContainer');
  const btnAddMoveRow = document.querySelector('#btnAddMoveRow');
  const moveToGlobal = document.querySelector('#moveToGlobal');
  const btnFindByVin=$('#btnFindByVin'), btnMove=$('#btnMove');
  const moveStatus=$('#moveStatus'), carDetailsBox=$('#carDetailsBox'), carDetails=$('#carDetails'), carDetailsHint=$('#carDetailsHint');

  const underDeliveryBox=$('#underDeliveryBox');
  const chkAdminApproved=$('#chkAdminApproved'), adminNotes=$('#adminNotes');
  const chkFinanceApproved=$('#chkFinanceApproved'), financeNotes=$('#financeNotes');

  const vinHints = $('#vinHints');

  const moveAlert = $('#moveAlert');
  const moveAlertTitle = $('#moveAlertTitle');
  const moveAlertList  = $('#moveAlertList');

  /* ===== Connection status ===== */
  function setStatus(mode, txt){
    connDot.className='dot '+(mode==='ok'?'ok':mode==='err'?'err':'warn');
    connText.textContent = txt;
  }

  /* ===== Auth Gate ===== */
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      try{
        const role = await fetchUserRole(user);
    window.__mzjUserRole = role || null;
        if(!role || !PAGE_ALLOWED_ROLES.includes(role)){
          window.location.href = 'unauthorized.html';
          return;
        }
        authGate.style.display = 'none';
        appRoot.style.display  = 'block';
        btnSignOut.style.display = 'inline-flex';
        setStatus('ok', `Ù…ØªØµÙ„: ${user.email} â€” Ø§Ù„Ø¯ÙˆØ±: ${role}`);

        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ§Ø¨Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
        applyTabsVisibility(role);

        liftNoFlash();
        await initData();
        subscribeLive();
      }catch(err){
        console.error(err);
        setStatus('err','Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        liftNoFlash();
      }
    }else{
      appRoot.style.display   = 'none';
      authGate.style.display  = 'grid';
      btnSignOut.style.display = 'none';
      setStatus('warn','Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
      liftNoFlash();
    }
  });

  btnLogin.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{ await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
    catch(e){ authHint.textContent='ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: '+(e?.message||e); }
  });
  btnSignup.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{ await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
    catch(e){ authHint.textContent='ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: '+(e?.message||e); }
  });
  btnSignOut.addEventListener('click', ()=> signOut(auth));

  /* ===== Data init / subscribe ===== */
  async function initData(){
    try{
      const s=await getDoc(STATE_REF);
      if(s.exists()){
        const d=s.data()||{};
        stock = Array.isArray(d.stock)? d.stock: [];
        moves = Array.isArray(d.moves)? d.moves: [];
        models = Array.isArray(d.models)? d.models: [];
        variantsMap = d.variantsMap || {};
      }else{
        stock=[]; moves=[]; models=[]; variantsMap={};
      }
      fillMoveLists();
      ensureAtLeastOneMoveRow();
      updateRequirementBoxes();
      toggleNotesVisibility();
      setStatus('ok','ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }catch(e){
      console.error(e);
      setStatus('warn','ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
  }

  function subscribeLive(){
    try{
      onSnapshot(STATE_REF,(snap)=>{
        if(!snap.exists()) return;
        const d=snap.data()||{};
        stock = Array.isArray(d.stock)? d.stock: stock;
        moves = Array.isArray(d.moves)? d.moves: moves;
        models= Array.isArray(d.models)? d.models: models;
        variantsMap = d.variantsMap || variantsMap;
        fillMoveLists();
        updateRequirementBoxes();
        toggleNotesVisibility();
        setStatus('ok','Ù…Ø²Ø§Ù…Ù†Ø© Ø­ÙŠÙ‘Ø©');
      },()=> setStatus('warn','Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§'));
    }catch(e){}
  }

  async function persistAll(){
    try{
      await mzjSetDoc(STATE_REF, { stock, moves, models, variantsMap, updatedAt: now() }, { merge:true });
      setStatus('ok','ØªÙ… Ø§Ù„Ø­ÙØ¸');
    }catch(e){
      console.error(e);
      setStatus('err','ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸');
      showToast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©','err');
    }
  }

  /* ===== Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„ â€” Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£Ù…Ø§ÙƒÙ† ===== */
  const FIXED_LOCATIONS = [
    "Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"
  ];

  function fillMoveLists(){
    const opts = FIXED_LOCATIONS.map(l=> `<option value="${l}">${l}</option>`).join('');
    if(moveToGlobal) moveToGlobal.innerHTML = opts;
    const fromSelects = moveRowsContainer ? moveRowsContainer.querySelectorAll('.move-from') : [];
    fromSelects.forEach(sel=> sel.innerHTML=opts);
  }

  function fillMoveListsForRow(row){
    const opts = FIXED_LOCATIONS.map(l=> `<option value="${l}">${l}</option>`).join('');
    const fromSel = row.querySelector('.move-from');
    if(fromSel) fromSel.innerHTML = opts;
  }

  function renderCarDetails(rec){
    carDetails.innerHTML=`
      <div style="grid-column:1/-1"><b>Ø³ÙŠØ§Ø±Ø©:</b> ${rec.car??""}</div>
      <div><b>Ø§Ù„Ø¨ÙŠØ§Ù†:</b> ${rec.variant??""}</div>
      <div><b>Ø§Ù„ÙˆÙƒÙŠÙ„:</b> ${rec.dealer??""}</div>
      <div><b>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ:</b> ${rec.extColor??""}</div>
      <div><b>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ:</b> ${rec.intColor??""}</div>
      <div><b>Ù…ÙˆØ¯ÙŠÙ„:</b> ${rec.modelYear??""}</div>
      <div><b>Ø§Ù„Ù„ÙˆØ­Ø©:</b> ${rec.plate??""}</div>
      <div><b>Ø§Ù„Ù…ÙƒØ§Ù†:</b> ${rec.location??""}</div>
      <div><b>Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø©:</b> ${rec.batchName??""}</div>
      <div style="grid-column:1/-1"><b>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„:</b> ${rec.vin??""}</div>
      <div style="grid-column:1/-1"><b>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${rec.notes??""}</div>`;
    carDetailsHint.textContent=rec.vin?`Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„: ${rec.vin}`:'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡ÙŠÙƒÙ„ Ù…Ø­ÙÙˆØ¸ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø©.';
    carDetailsBox.style.display='block';
  }

  function hideMoveAlert(){
    if(moveAlert){
      moveAlert.style.display='none';
      moveAlertList.innerHTML='';
    }
  }

  function showMoveAlert(type, title, lines){
    if(!moveAlert) return;
    moveAlert.className = 'move-alert ' + (type || 'info');
    moveAlertTitle.textContent = title || 'Ù†ØªÙŠØ¬Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„';
    moveAlertList.innerHTML = '';
    (lines || []).forEach(txt=>{
      const li = document.createElement('li');
      li.textContent = txt;
      moveAlertList.appendChild(li);
    });
    moveAlert.style.display = 'flex';
  }

  /* Ø§Ù‚ØªØ±Ø§Ø­ VIN Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø§Ø¯Ø¦Ø©/Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ÙƒØªÙˆØ¨Ø© */
  function updateVinSuggestionsForPrefix(rawPrefix){
    if(!vinHints) return;
    const prefix = normalizeVin(rawPrefix||'');
    if(prefix.length < 1){
      vinHints.innerHTML = '';
      return;
    }
    const set = new Set();
    stock.forEach(r=>{
      const v = normalizeVin(r.vin||'');
      if(v && v.startsWith(prefix)) set.add(v);
    });
    const list = Array.from(set).sort().slice(0,30);
    vinHints.innerHTML = list.map(v=>`<option value="${v}"></option>`).join('');
  }

  /* Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ù…ÙƒØ§Ù† "Ù…Ù†" Ù„ÙƒÙ„ Ø³Ø·Ø± Ø¹Ù†Ø¯ ÙƒØªØ§Ø¨Ø© VIN */
  function autoFindByVinForRow(row, strictMessage=false){
    const inp = row.querySelector('.move-vin');
    const fromSel = row.querySelector('.move-from');
    const vinRaw = (inp?.value||'').trim();
    if(!vinRaw){
      if(fromSel){
        fromSel.disabled=false;
        fromSel.value='';
      }
      const anyVin = moveRowsContainer.querySelectorAll('.move-vin');
      const hasAnyVin = Array.from(anyVin).some(i=> normalizeVin(i.value));
      if(!hasAnyVin){
        carDetailsBox.style.display='none';
        moveStatus.textContent='';
      }
      return;
    }
    const norm = normalizeVin(vinRaw);
    let match = stock.find(r => normalizeVin(r.vin) === norm);
    if(!match && norm.length >= 8){
      const candidates = stock.filter(r => normalizeVin(r.vin).startsWith(norm));
      if(candidates.length === 1) match = candidates[0];
    }
    if(match){
      renderCarDetails(match);
      const currentLoc = match.location || '';
      if(currentLoc && fromSel){
        fromSel.value = currentLoc;
        fromSel.disabled = true;
        moveStatus.textContent = `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±: ${match.car} â€” Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentLoc}`;
      }else if(fromSel){
        fromSel.disabled = false;
        moveStatus.textContent = `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±: ${match.car} â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙƒØ§Ù† Ù…Ø³Ø¬Ù„. Ø§Ø®ØªØ± Ø§Ù„Ù…ÙƒØ§Ù† ÙŠØ¯ÙˆÙŠÙ‹Ø§.`;
      }
    }else{
      if(strictMessage){
        const msg = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³ÙŠØ§Ø±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù….';
        moveStatus.textContent = msg;
        carDetailsBox.style.display='none';
        showMoveAlert('error','Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø©',[msg]);
      }else{
        moveStatus.textContent = 'â€” Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¨Ø¹Ø¯ (Ø£ÙƒÙ…Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„).';
      }
    }
  }

  function attachMoveRowEvents(row){
    const inp = row.querySelector('.move-vin');
    if(!inp) return;
    inp.addEventListener('input', debounce(()=>{
      updateVinSuggestionsForPrefix(inp.value);
      autoFindByVinForRow(row,false);
    },150));
  }

  function createMoveRow(index){
    const row = document.createElement('div');
    row.className = 'move-row';
    row.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
        <div class="move-row-title">Ø§Ù„Ø³ÙŠØ§Ø±Ø© ${index}</div>
        <button type="button" class="btn btn-ghost" data-remove-move-row="1" title="Ù…Ø³Ø­ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©">Ù…Ø³Ø­ Ø§Ù„Ø­Ø±ÙƒØ©</button>
      </div>
      <div class="grid grid-3">
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</label>
          <input class="move-vin" list="vinHints" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„"/>
        </div>
        <div>
          <label>Ù…Ù† (Ù…Ø­Ø¯Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)</label>
          <select class="move-from" title="Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ"></select>
        </div>
        <div class="notes-col">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
          <textarea class="move-notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù‡ÙŠÙƒÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
        </div>
      </div>`;
    fillMoveListsForRow(row);
    attachMoveRowEvents(row);
    return row;
  }

  function renumberMoveRows(){
    const rows = moveRowsContainer.querySelectorAll('.move-row');
    rows.forEach((row,idx)=>{
      const title = row.querySelector('.move-row-title');
      if(title) title.textContent = 'Ø§Ù„Ø³ÙŠØ§Ø±Ø© ' + (idx+1);
    });
  }

  function ensureAtLeastOneMoveRow(){
    if(!moveRowsContainer) return;
    const existing = moveRowsContainer.querySelectorAll('.move-row').length;
    if(existing === 0){
      const row = createMoveRow(1);
      moveRowsContainer.appendChild(row);
    }
    renumberMoveRows();
  }

  if(btnAddMoveRow){
    btnAddMoveRow.addEventListener('click', ()=>{
      const count = moveRowsContainer.querySelectorAll('.move-row').length;
      const row = createMoveRow(count+1);
      moveRowsContainer.appendChild(row);
      renumberMoveRows();
    });
  }

  // Ù…Ø³Ø­ ØµÙ Ø­Ø±ÙƒØ© Ù†Ù‚Ù„ ÙˆØ§Ø­Ø¯
  document.addEventListener('click',(e)=>{
    const btn = e.target.closest('[data-remove-move-row]');
    if(!btn) return;
    const row = btn.closest('.move-row');
    if(row){
      row.remove();
      renumberMoveRows();
    }
  });

  // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø£ÙˆÙ„ VIN ØºÙŠØ± ÙØ§Ø±Øº
  btnFindByVin.addEventListener('click',()=>{
    const rows = Array.from(moveRowsContainer.querySelectorAll('.move-row'));
    const firstRow = rows.find(r=> normalizeVin((r.querySelector('.move-vin')?.value||'').trim()));
    if(!firstRow){
      const msg = 'Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙÙŠ Ø£ÙŠ Ø³Ø·Ø± Ø£ÙˆÙ„Ù‹Ø§.';
      moveStatus.textContent = msg;
      showMoveAlert('info','Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡ÙŠÙƒÙ„',[msg]);
      return;
    }
    autoFindByVinForRow(firstRow,true);
  });

  function updateRequirementBoxes(){
    const val = (moveToGlobal?.value || '').trim();
    const anyIssues        = /Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª/.test(val);
    if(underDeliveryBox){
      underDeliveryBox.style.display = 'none';
    }
  }

  if(moveToGlobal){
    moveToGlobal.addEventListener('change', updateRequirementBoxes);
  }

  // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙƒÙ„ Ø³ÙŠØ§Ø±Ø© Ø­Ø³Ø¨ Ù…ÙƒØ§Ù† (Ø¥Ù„Ù‰)
  function toggleNotesVisibility(){
    const dest = (moveToGlobal?.value || '').trim();
    const show = /Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª/.test(dest);
    const notesCols = document.querySelectorAll('.notes-col');
    notesCols.forEach(col=>{
      col.style.display = show ? 'block' : 'none';
    });
  }
  if(moveToGlobal){
    moveToGlobal.addEventListener('change', toggleNotesVisibility);
  }

  // ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ admin.html)
  btnMove.addEventListener('click', async ()=>{
    hideMoveAlert();

    const dest = (moveToGlobal?.value || '').trim();
    if(!dest){
      const msg = 'Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† "Ø¥Ù„Ù‰" Ø£ÙˆÙ„Ù‹Ø§ Ù‚Ø¨Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‚Ù„.';
      moveStatus.textContent = msg;
      showMoveAlert('info','Ù…ÙƒØ§Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨',[msg]);
      showToast(msg,'info');
      return;
    }

    const rows = Array.from(moveRowsContainer.querySelectorAll('.move-row')).map(row=>({
      row,
      vinRaw:(row.querySelector('.move-vin')?.value||'').trim(),
      fromSel:row.querySelector('.move-from'),
      notesInput:row.querySelector('.move-notes')
    }));
    const rowsWithVin = rows.filter(r=> normalizeVin(r.vinRaw));

    if(!rowsWithVin.length){
      const msg = 'Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙŠ Ø±Ù‚Ù… Ù‡ÙŠÙƒÙ„ Ù„Ù„Ù†Ù‚Ù„.';
      moveStatus.textContent = msg;
      showMoveAlert('info','Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù†Ù‚Ù„', [msg]);
      showToast(msg,'info');
      return;
    }

    const goingUnderDeliveryRow = /Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…/.test(dest);
    const goingIssuesRow        = /Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª/.test(dest);
    const goingDeliveredRow     = /Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…/.test(dest);

    let movedCount = 0;
    const errors = [];
    const successLines = [];

    for (const rowData of rowsWithVin){
      const norm = normalizeVin(rowData.vinRaw);
      const recIdx = stock.findIndex(r => normalizeVin(r.vin) === norm);
      if(recIdx < 0){
        errors.push(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³ÙŠØ§Ø±Ø© Ø¨Ù‡Ø°Ø§ VIN: ${rowData.vinRaw}`);
        continue;
      }
      const rec = stock[recIdx];
      const toVal = dest;
      const fromSel = rowData.fromSel;
      const from = (fromSel?.value || rec.location || '').trim();
      if(!from){
        errors.push(`Ø§Ù„Ø³ÙŠØ§Ø±Ø© ${rec.car||''} (${rec.vin||rowData.vinRaw}) Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ù‡Ø§ Ù…ÙƒØ§Ù† Ø­Ø§Ù„ÙŠØ› Ø­Ø¯Ù‘Ø¯ Ø§Ù„Ù…ÙƒØ§Ù† ÙŠØ¯ÙˆÙŠÙ‹Ø§ ÙÙŠ "Ù…Ù†".`);
        continue;
      }
      if(from === toVal){
        errors.push(`Ø§Ù„Ø³ÙŠØ§Ø±Ø© ${rec.car||''} (${rec.vin||rowData.vinRaw}) Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…ÙƒØ§Ù†.`);
        continue;
      }

      const noteText = (rowData.notesInput?.value || '').trim();

      if(goingIssuesRow && !noteText){
        errors.push(`ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø³ÙŠØ§Ø±Ø© ${rec.car||''} (${rec.vin||rowData.vinRaw}) Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ù…ÙƒØ§Ù† "Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª".`);
        continue;
      }

      // Ù…ÙŠØªØ§Ø¯Ø§ØªØ§ Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø­Ø±ÙƒØ© / Ø§Ù„Ø·Ù„Ø¨
      const moveMeta = {
        adminApproved: null,
        adminNotes: '',
        financeApproved: null,
        financeNotes: '',
        issuesNotes: noteText
      };

      const oldLoc = rec.location || from;

      // ğŸšš Ù…Ù†Ø·Ù‚ Ø®Ø§Øµ Ø¨Ù€ "Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…"
      if (goingUnderDeliveryRow) {
        const stamp = now();

        // âœ… Ù„Ùˆ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙˆØ§Ø®Ø¯Ø© Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ø§Ù„ÙŠØ© + Ø¥Ø¯Ø§Ø±ÙŠØ© Ù‚Ø¨Ù„ ÙƒØ¯Ø©
        // Ø³Ø§Ø¹ØªÙ‡Ø§ Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„Ù†Ù‚Ù„ Ù„Ø£ÙŠ Ù…ÙƒØ§Ù† (Ø­ØªÙ‰ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…) Ø¨Ø¯ÙˆÙ† Ø¥Ù†Ø´Ø§Ø¡ "Ø·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚Ø§Øª" Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯
        const adminOk   = rec.adminApproved === true;
        const financeOk = rec.financeApproved === true;
        const approvalsDone = adminOk && financeOk;

        // 1) Ù†Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙØ¹Ù„ÙŠÙ‹Ø§ Ø¥Ù„Ù‰ Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…
        rec.location = toVal;
        if ('place' in rec) {
          rec.place = toVal;
        }

        stock[recIdx] = rec;
        movedCount++;
        successLines.push(`ØªÙ… Ù†Ù‚Ù„ ${rec.car||''} (${rec.vin||rowData.vinRaw}) Ù…Ù† "${oldLoc}" Ø¥Ù„Ù‰ "${toVal}".`);

        // Ù†Ø³Ø¬Ù„ Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ "Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…"
        moves.push({
          when: stamp,
          date: onlyDate(stamp),
          vin: rec.vin || '',
          car: rec.car || '',
          from: oldLoc,
          to: toVal,
          id: rec.id,
          ...moveMeta,
          status: approvalsDone ? 'under_delivery_approved' : 'under_delivery',
          message: approvalsDone
            ? 'ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¥Ù„Ù‰ Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ… (Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª ÙƒØ§Ù†Øª Ù…ÙƒØªÙ…Ù„Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§ â€” Ø¨Ø¯ÙˆÙ† Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯)'
            : 'ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¥Ù„Ù‰ Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ù„Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…'
        });

        // 2) Ù†Ù†Ø´Ø¦ Ø·Ù„Ø¨ Ù†Ù‚Ù„ Ø¥Ù„Ù‰ "Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØ±Ø¹ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)
        //   - Ù„Ùˆ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ù…ÙƒØªÙ…Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„ => Ù„Ø§ Ù†ÙÙ†Ø´Ø¦ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
        //   - Ù„Ùˆ ÙÙŠ Ø·Ù„Ø¨ Pending Ù‚Ø¯ÙŠÙ… Ù„Ù†ÙØ³ VIN => Ù„Ø§ Ù†ÙÙƒØ±Ù‘Ø± Ø§Ù„Ø·Ù„Ø¨
        if (!approvalsDone) {
          const targetDelivered = toVal.replace('Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…', 'Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…');

          const hasPending = moves.some(m =>
            normalizeVin(m.vin || '') === norm &&
            (m.status === 'pending' || m.needsAdminApproval || m.needsFinanceApproval || m.requiresAdminApproval || m.requiresFinanceApproval) &&
            (m.to || '') === targetDelivered
          );

          if (!hasPending) {
            moves.push({
              when: stamp,
              date: onlyDate(stamp),
              vin: rec.vin || '',
              car: rec.car || '',
              from: toVal,
              to: targetDelivered,
              id: rec.id,
              adminApproved: false,
              adminApproval: false,
              financeApproved: false,
              financeApproval: false,
              requiresAdminApproval: true,
              needsAdminApproval: true,
              requiresFinanceApproval: true,
              needsFinanceApproval: true,
              status: 'pending',
              message: 'Ø·Ù„Ø¨ Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù…Ù† Ù†ÙØ³ Ø§Ù„ÙØ±Ø¹ (Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ©)'
            });
          }
        }

        continue;
      }

// ğŸš— Ù…Ù†Ø·Ù‚ Ø®Ø§Øµ Ø¨Ù€ "Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" (Ù…Ø³Ù…ÙˆØ­ Ù…Ù† Ø£ÙŠ Ù…ÙƒØ§Ù† Ø·Ø§Ù„Ù…Ø§ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ù…ÙƒØªÙ…Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø©)
if (goingDeliveredRow) {
  const stamp = now();

  // âœ… Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯: Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù†ÙØ³Ù‡Ø§ (ØªØ¸Ù„ ØµØ§Ù„Ø­Ø© Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù†ØªÙ‚Ù„Øª Ù„Ø£ÙŠ Ù…ÙƒØ§Ù†)
  const adminOkFromCar   = rec.adminApproved === true;
  const financeOkFromCar = rec.financeApproved === true;

  // ğŸ” ØªÙˆØ§ÙÙ‚ Ù„Ù„Ø®Ù„Ù: Ù„Ùˆ Ù…Ø§ ÙÙŠÙ‡ Ø­Ù‚ÙˆÙ„ Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø©ØŒ Ø¬Ø±Ù‘Ø¨ Ø¢Ø®Ø± Ø·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚Ø§Øª Ù…ÙØ³Ø¬Ù„ ÙÙŠ Ø§Ù„Ø­Ø±ÙƒØ§Øª
  let adminOk = adminOkFromCar;
  let financeOk = financeOkFromCar;

  if (!adminOkFromCar || !financeOkFromCar) {
    const deliveredTarget = toVal;
    const relatedMoves = moves.filter(m =>
      normalizeVin(m.vin || '') === norm && (m.to || '') === deliveredTarget
    );
    const lastMove = relatedMoves.length ? relatedMoves[relatedMoves.length - 1] : null;

    if (lastMove) {
      const adminOkFromMove = !!(lastMove.adminApproved === true || lastMove.adminApproval === true);
      const financeOkFromMove = !!(lastMove.financeApproved === true || lastMove.financeApproval === true);

      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø¢Ø®Ø± Ø·Ù„Ø¨
      if (!adminOkFromCar) adminOk = adminOkFromMove;
      if (!financeOkFromCar) financeOk = financeOkFromMove;

      // Ù„Ùˆ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø§ÙƒØªÙ…Ù„Øª Ù…Ù† Ø§Ù„Ø·Ù„Ø¨ØŒ Ø®Ø²Ù‘Ù†Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø­ØªÙ‰ ØªØ¸Ù„ ØµØ§Ù„Ø­Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§
      if (adminOkFromMove) rec.adminApproved = true;
      if (financeOkFromMove) rec.financeApproved = true;
      if (adminOkFromMove && financeOkFromMove && !rec.approvedAt) rec.approvedAt = stamp;
    }
  }

  if (!adminOk || !financeOk) {
    const errMsg = `Ù„Ø§ÙŠÙ…ÙƒÙ† Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ${rec.car || ''} (${rec.vin || rowData.vinRaw}) Ø¥Ù„Ù‰ "Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ø§Ù„ÙŠØ© ÙˆÙ…ÙˆØ§ÙÙ‚Ø© Ø§Ø¯Ø§Ø±ÙŠØ©.`;
    errors.push(errMsg);
    continue;
  }

  // âœ… Ù…ÙˆØ§ÙÙ‚Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©: Ù†ÙÙ‘Ø° Ø§Ù„Ù†Ù‚Ù„ ÙØ¹Ù„ÙŠÙ‹Ø§ (Ù…Ù† Ø£ÙŠ Ù…ÙƒØ§Ù†)
  rec.location = toVal;
  if ('place' in rec) {
    rec.place = toVal;
  }
  // Ù†Ø¹Ù„Ù‘Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¥Ù†Ù‡Ø§ ØªÙ… ØªØ³Ù„ÙŠÙ…Ù‡Ø§ ÙØ¹Ù„Ø§Ù‹
  rec.delivered   = true;
  rec.deliveredAt = stamp;

  moves.push({
    when: stamp,
    date: onlyDate(stamp),
    vin: rec.vin || '',
    car: rec.car || '',
    from: oldLoc,
    to: toVal,
    id: rec.id,
    adminApproved: true,
    adminApproval: true,
    financeApproved: true,
    financeApproval: true,
    requiresAdminApproval: false,
    requiresFinanceApproval: false,
    status: 'delivered',
    message: 'ØªÙ… ØªÙ†ÙÙŠØ° Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¥Ù„Ù‰ Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… (Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ù…ÙƒØªÙ…Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø©)'
  });

  stock[recIdx] = rec;
  movedCount++;
  successLines.push(
    `ØªÙ… Ù†Ù‚Ù„ ${rec.car || ''} (${rowData.vinRaw}) Ø¥Ù„Ù‰ "${toVal}" Ù„Ø£Ù† Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©.`
  );
  continue;
}

// Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ù†Ù‚Ù„ ÙØ¹Ù„ÙŠ) (Ù†Ù‚Ù„ ÙØ¹Ù„ÙŠ)
      rec.location = toVal;
      if (goingIssuesRow && noteText) {
        const existingNotes = rec.notes || '';
        rec.notes = existingNotes ? (existingNotes + " | " + noteText) : noteText;
      }
      const stamp = now();
      moves.push({
        when: stamp,
        date: onlyDate(stamp),
        vin: rec.vin || '',
        car: rec.car || '',
        from: oldLoc,
        to: toVal,
        id: rec.id,
        ...moveMeta
      });
      movedCount++;
      successLines.push(`ØªÙ… Ù†Ù‚Ù„ ${rec.car||''} (${rec.vin||rowData.vinRaw}) Ù…Ù† "${oldLoc}" Ø¥Ù„Ù‰ "${toVal}".`);
    }

    if(!movedCount){
      const title = 'Ù„Ù… ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ø£ÙŠ Ø­Ø±ÙƒØ© Ù†Ù‚Ù„';
      const lines = errors.length ? errors : ['Ù„Ù… ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ø£ÙŠ Ø­Ø±ÙƒØ© Ù†Ù‚Ù„.'];
      moveStatus.textContent = title;
      showMoveAlert('error', title, lines);
      showToast(title,'info');
      return;
    }

    await persistAll();

    const summary = `ØªÙ… Ù†Ù‚Ù„ ${movedCount} Ø³ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­.`;    
    moveStatus.textContent = summary;
    const allLines = [...successLines];
    if(errors.length){
      allLines.push('â€” Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„ØªÙŠ Ù„Ù… ØªÙÙ†ÙØ°:');
      errors.forEach(e=> allLines.push(e));
    }
    showMoveAlert(errors.length ? 'info' : 'success', 'Ù†ØªÙŠØ¬Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„', allLines);
    showToast(summary,'ok');

    carDetailsBox.style.display='none';

    // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
    const allRows = Array.from(moveRowsContainer.querySelectorAll('.move-row'));
    allRows.forEach(row=>{
      const vin = row.querySelector('.move-vin');
      const fromSel = row.querySelector('.move-from');
      const notes = row.querySelector('.move-notes');
      if(vin) vin.value='';
      if(fromSel){ fromSel.disabled=false; fromSel.value=''; }
      if(notes) notes.value='';
    });

    chkAdminApproved.checked=false; adminNotes.value='';
    chkFinanceApproved.checked=false; financeNotes.value='';
    if(vinHints) vinHints.innerHTML='';
  });

  // Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„
  setStatus('warn','Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦');
  fillMoveLists();
  ensureAtLeastOneMoveRow();
  updateRequirementBoxes();
  toggleNotesVisibility();
</script>
  <script src="./mzj-ui.js"></script>

      </div>
    </main>
  </div>

</body>
</html>

